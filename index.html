<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Assessoria d'Habitatge - AI Advisor</title>
<style>
:root{
  --bg:#020617;
  --card:rgba(15,23,42,.70);
  --card2:rgba(11,18,32,.88);
  --bd:rgba(148,163,184,.22);
  --bd2:rgba(148,163,184,.30);
  --t:#e5e7eb;
  --m:#94a3b8;
  --mut:#cbd5e1;
  --pill:#38bdf8;
  --p:#06b6d4;--ph:#0891b2;
  --ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;
  --g1:#3b4a60;--g2:#0b1220;
  --shadow-lg:0 10px 40px rgba(0,0,0,.35);
  --shadow-xl:0 20px 60px rgba(0,0,0,.48);
  --gradient-3:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
  --gradient-4:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);
}
html,body{height:100%}
body{margin:0;background:var(--bg);position:relative;overflow-x:hidden;}
body::before{
  content:"";position:fixed;inset:0;
  background:
    radial-gradient(1400px 700px at 20% -10%,rgba(56,189,248,.18),transparent 60%),
    radial-gradient(1000px 600px at 85% 0%,rgba(34,197,94,.14),transparent 60%),
    radial-gradient(900px 520px at 60% 110%,rgba(168,85,247,.12),transparent 62%),
    linear-gradient(180deg,#0f172a 0%,#020617 55%,#000 100%);
  z-index:-1;pointer-events:none;animation:pulse 18s ease-in-out infinite;
}
@keyframes pulse{0%,100%{opacity:.80}50%{opacity:1}}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{opacity:0;transform:translateX(-18px)}to{opacity:1;transform:translateX(0)}}
@keyframes glow{0%,100%{box-shadow:0 0 18px rgba(56,189,248,.22)}50%{box-shadow:0 0 30px rgba(56,189,248,.42)}}
@keyframes typing{from{opacity:.4}to{opacity:1}}

#hx{color:var(--t);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;-webkit-font-smoothing:antialiased;}
#hx *{box-sizing:border-box}
.w{max-width:1200px;margin:22px auto 18px;padding:0 16px}

.c{
  background:rgba(15,23,42,.86);border:1px solid var(--bd);border-radius:20px;
  padding:22px;margin:16px 0;backdrop-filter:blur(14px);box-shadow:var(--shadow-lg);
  animation:fadeIn .5s ease-out;transition:all .25s ease;position:relative;overflow:hidden;
}
.c::before{content:"";position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(56,189,248,.6),transparent);opacity:.55}
.c:hover{border-color:rgba(56,189,248,.42);box-shadow:var(--shadow-xl)}

.r{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.hrow{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.n{opacity:.95;font-size:.95rem;color:#cbd5e1;line-height:1.6}
.small{font-size:.88rem;color:#b6c2d3;line-height:1.5}

.pill{background:var(--gradient-3);color:#001018;border-radius:999px;padding:10px 16px;font-weight:950;letter-spacing:.6px;text-transform:uppercase;font-size:.88rem;box-shadow:0 4px 16px rgba(56,189,248,.32);animation:glow 6s ease-in-out infinite;white-space:nowrap;}
.lang{display:flex;gap:10px;align-items:center}
.langbtn{border:1px solid rgba(148,163,184,.28);background:rgba(11,18,32,.85);color:#cbd5e1;border-radius:999px;padding:8px 14px;font-weight:900;cursor:pointer;transition:all .18s ease;font-size:.84rem;letter-spacing:.5px;}
.langbtn:hover{border-color:rgba(56,189,248,.55);transform:translateY(-1px)}
.langbtn.a{background:var(--gradient-3);color:#001018;border-color:#38bdf8;box-shadow:0 4px 14px rgba(56,189,248,.28)}

.tabs{display:flex;gap:10px;margin:16px 0;flex-wrap:wrap;animation:slideIn .6s ease-out}
.tab{border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.80);color:#cbd5e1;border-radius:999px;padding:10px 18px;cursor:pointer;font-weight:900;transition:all .18s ease;user-select:none;position:relative;overflow:hidden;font-size:.90rem;letter-spacing:.35px;}
.tab:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(56,189,248,.28)}
.tab.a{background:var(--gradient-3);color:#001018;border-color:#38bdf8;box-shadow:0 4px 14px rgba(56,189,248,.36)}
.tab.dis{opacity:.40;cursor:not-allowed;filter:grayscale(.35)}
.tab.dis:hover{transform:none;box-shadow:none}

.b{background:var(--gradient-3);color:#001018;border:0;border-radius:14px;padding:12px 20px;cursor:pointer;font-weight:950;transition:all .18s ease;box-shadow:0 4px 15px rgba(56,189,248,.28);font-size:.95rem;letter-spacing:.3px;position:relative;overflow:hidden}
.b:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(56,189,248,.42)}
.b.ok{background:var(--gradient-4);box-shadow:0 4px 15px rgba(67,233,123,.22)}
.b.ok:hover{box-shadow:0 6px 20px rgba(67,233,123,.42)}
.b.dis{opacity:.45;cursor:not-allowed;filter:grayscale(.25);transform:none;pointer-events:none}

.g{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
@media(max-width:900px){.g{grid-template-columns:1fr}}

#hx input[type=text],#hx input[type=number],#hx select,#hx textarea{
  width:100%;padding:12px 14px;border:1px solid rgba(148,163,184,.30);border-radius:12px;
  background:rgba(2,6,23,.86);color:var(--t);outline:none;transition:all .18s ease;font-size:.95rem;font-family:inherit;
}
#hx textarea{min-height:100px;resize:vertical;}
#hx input[type=text]:focus,#hx input[type=number]:focus,#hx select:focus,#hx textarea:focus{
  border-color:#38bdf8;box-shadow:0 0 0 4px rgba(56,189,248,.14);background:rgba(2,6,23,.96)
}
#hx input[type=checkbox]{accent-color:#38bdf8;width:18px;height:18px;cursor:pointer}
#hx label{color:#cbd5e1;font-weight:750;margin-bottom:6px;display:block;font-size:.9rem;letter-spacing:.25px}

.gu{margin-top:12px;padding:14px 16px;background:rgba(56,189,248,.08);border:1px solid rgba(56,189,248,.25);border-radius:14px;color:#dbeafe;display:flex;gap:12px;align-items:flex-start;border-left:4px solid #38bdf8}
.gu .a{font-weight:950;line-height:1.2;margin-top:1px;font-size:1.15rem}

.tst{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:rgba(2,6,23,.94);border:1px solid rgba(148,163,184,.35);color:var(--t);padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none;transition:.2s;z-index:99999}
.tst.s{opacity:1}

.sig{max-width:1100px;margin:10px auto 18px;padding:10px 12px;color:#a5b4fc;background:rgba(10,16,28,.65);border:1px solid rgba(148,163,184,.25);border-radius:12px;display:flex;gap:12px;align-items:center;justify-content:space-between;font-size:.95rem}
.sig .br{font-weight:950;color:#e2e8f0}
.sig a{color:#93c5fd;text-decoration:none}
.sig a:hover{text-decoration:underline}

.cardx{margin-top:16px;background:linear-gradient(135deg,rgba(15,23,42,.86),rgba(11,18,32,.92));border:1px solid rgba(148,163,184,.25);border-radius:16px;padding:20px;box-shadow:0 4px 22px rgba(0,0,0,.22)}
.cardx .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;padding-bottom:16px;border-bottom:1px solid rgba(148,163,184,.14)}
.cardx .title{font-weight:1000;color:#f1f5f9;font-size:1.15rem}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{border:1px solid rgba(148,163,184,.30);background:rgba(11,18,32,.82);color:#cbd5e1;border-radius:999px;padding:8px 14px;font-weight:850;font-size:.85rem;transition:.15s;text-shadow:0 1px 8px rgba(0,0,0,.25);}
.chip:hover{transform:translateY(-1px)}
.chip.good{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.12);color:#86efac}
.chip.bad{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.12);color:#fca5a5}
.chip.warn{border-color:rgba(245,158,11,.45);background:rgba(245,158,11,.12);color:#fde68a}
.chip.neu{border-color:rgba(148,163,184,.35);color:#e2e8f0}

.body{margin-top:16px;color:#cbd5e1;line-height:1.65;font-size:.95rem}
.body b{color:#f8fafc;font-weight:800}

.grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:16px}
@media(max-width:980px){.grid3{grid-template-columns:1fr}}

.mini{background:linear-gradient(135deg,rgba(14,165,233,.10),rgba(6,182,212,.06));border:1px solid rgba(148,163,184,.25);border-radius:14px;padding:14px;transition:.15s}
.mini:hover{border-color:rgba(56,189,248,.40);transform:translateY(-1px)}
.mini .h{color:#94a3b8;font-size:.82rem;font-weight:800;text-transform:uppercase;letter-spacing:.5px}
.mini .v{font-weight:1000;color:#f8fafc;margin-top:6px;font-size:1.15rem;text-shadow:0 2px 12px rgba(0,0,0,.35);}
.note{margin-top:16px;color:#cbd5e1;white-space:pre-wrap;background:rgba(2,6,23,.62);padding:16px;border-radius:12px;border:1px solid rgba(148,163,184,.20);line-height:1.7;font-size:.92rem}

.k{background:linear-gradient(145deg,rgba(14,165,233,.10),rgba(6,182,212,.06));border:1px solid rgba(56,189,248,.30);border-radius:18px;padding:18px 14px;text-align:left;position:relative;overflow:hidden;box-shadow:0 4px 18px rgba(0,0,0,.25);min-height:86px;}
.k::before{content:"";position:absolute;inset:-40%;background:radial-gradient(circle,rgba(56,189,248,.10),transparent 70%);pointer-events:none;transition:transform .6s ease;}
.k:hover::before{transform:scale(1.12)}
.k span{color:#a6b3c6;font-size:.78rem;font-weight:900;text-transform:uppercase;letter-spacing:.9px;display:block}
.k b{font-size:30px;display:block;color:#f1f5f9;margin-top:10px;font-weight:1000;text-shadow:0 2px 14px rgba(0,0,0,.45);line-height:1.05;}
.k .sub{margin-top:8px;font-size:.82rem;color:#9fb0c6;line-height:1.25;}
@media(max-width:520px){.k b{font-size:26px}}

.pbar-wrap{margin-top:8px;background:rgba(255,255,255,.07);border-radius:999px;height:8px;overflow:hidden}
.pbar{height:8px;border-radius:999px;transition:width .9s cubic-bezier(.4,0,.2,1)}
.pbar.good{background:linear-gradient(90deg,#22c55e,#4ade80)}
.pbar.warn{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.pbar.bad{background:linear-gradient(90deg,#ef4444,#f87171)}

.tip{position:relative;display:inline-flex;align-items:center;gap:4px;width:100%}
.tip-icon{width:16px;height:16px;border-radius:50%;background:rgba(148,163,184,.22);color:#b6c2d3;font-size:10px;font-weight:950;cursor:help;display:inline-flex;align-items:center;justify-content:center;border:1px solid rgba(148,163,184,.30);flex-shrink:0;user-select:none}
.tip-box{position:absolute;top:calc(100% + 6px);right:0;left:auto;transform:none;background:#0f172a;border:1px solid rgba(56,189,248,.35);border-radius:10px;padding:10px 14px;color:#cbd5e1;font-size:.82rem;line-height:1.5;width:240px;z-index:9999;box-shadow:0 10px 26px rgba(0,0,0,.55);pointer-events:none;opacity:0;transition:opacity .14s;}
.tip:hover .tip-box,.tip:focus-within .tip-box{opacity:1}

.steps{display:flex;align-items:center;margin-bottom:16px;animation:fadeIn .45s ease-out}
.step{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1;position:relative}
.step-dot{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:1000;font-size:.85rem;transition:all .25s ease;border:2px solid rgba(148,163,184,.22);background:rgba(11,18,32,.82);color:#94a3b8;z-index:1}
.step.done .step-dot{background:var(--gradient-4);color:#001018;border-color:#22c55e;box-shadow:0 0 12px rgba(34,197,94,.35)}
.step.active .step-dot{background:var(--gradient-3);color:#001018;border-color:#38bdf8;box-shadow:0 0 12px rgba(56,189,248,.42)}
.step-label{font-size:.72rem;color:#475569;font-weight:850;text-align:center;white-space:nowrap}
.step.done .step-label,.step.active .step-label{color:#94a3b8}
.step-line{position:absolute;top:15px;left:calc(50% + 17px);width:calc(100% - 34px);height:2px;background:rgba(148,163,184,.14);transition:background .3s;z-index:0}
.step.done .step-line{background:rgba(34,197,94,.28)}

.share-bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;padding-top:12px;border-top:1px solid rgba(148,163,184,.12)}
.share-btn{border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.82);color:#cbd5e1;border-radius:10px;padding:8px 14px;cursor:pointer;font-weight:850;font-size:.82rem;transition:all .18s ease;display:flex;align-items:center;gap:6px}
.share-btn:hover{transform:translateY(-2px)}
.share-btn.wa{border-color:rgba(37,211,102,.40);color:#4ade80}
.share-btn.wa:hover{background:rgba(37,211,102,.10);box-shadow:0 4px 12px rgba(37,211,102,.18)}
.share-btn.cl{border-color:rgba(56,189,248,.40);color:#7dd3fc}
.share-btn.cl:hover{background:rgba(56,189,248,.10);box-shadow:0 4px 12px rgba(56,189,248,.18)}

#hx input.field-ok{border-color:rgba(34,197,94,.50)!important}
#hx input.field-err{border-color:rgba(239,68,68,.52)!important;box-shadow:0 0 0 3px rgba(239,68,68,.10)!important}
.field-hint{font-size:.78rem;margin-top:4px;min-height:16px;transition:all .2s}
.field-hint.ok{color:#4ade80}
.field-hint.err{color:#f87171}

.range-bar{display:flex;gap:6px;align-items:center;margin-top:6px;flex-wrap:wrap}
.range-tag{font-size:.75rem;border-radius:8px;padding:2px 7px;font-weight:850}
.range-tag.lo{background:rgba(34,197,94,.12);color:#86efac;border:1px solid rgba(34,197,94,.25)}
.range-tag.hi{background:rgba(239,68,68,.12);color:#fca5a5;border:1px solid rgba(239,68,68,.25)}

.countdown{margin-top:10px;padding:12px 14px;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);border-radius:12px;border-left:4px solid #f59e0b;color:#fde68a;font-size:.88rem;line-height:1.6}

#zoneWrap{margin-top:12px}
#zmap,#cmap{height:420px;border-radius:12px;border:1px solid rgba(148,163,184,.22);overflow:hidden;max-width:100%;position:relative}
.muni-tooltip{background:#0f172a!important;border:1px solid rgba(56,189,248,.5)!important;border-radius:8px!important;color:#e2e8f0!important;font-size:13px!important;font-weight:800!important;padding:5px 10px!important;box-shadow:0 4px 14px rgba(0,0,0,.5)!important;}
.muni-tooltip::before{display:none!important}
.leaflet-container{font-family:system-ui,sans-serif}
.pchips{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.pchip{border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.75);color:#cbd5e1;border-radius:999px;padding:6px 10px;font-weight:1000;font-size:.85rem;cursor:pointer}
.pchip.on{border-color:#38bdf8;color:#dbeafe}
.pchip.off{opacity:.75}
.legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;padding:10px 12px;background:rgba(2,6,23,.45);border:1px solid rgba(148,163,184,.18);border-radius:12px;color:#bcd0ea;font-size:.86rem;}
.legdot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:middle}
.leg1{background:#38bdf8}.leg2{background:#22c55e}

.chartCard{background:linear-gradient(135deg,rgba(2,6,23,.35),rgba(15,23,42,.35));border:1px solid rgba(148,163,184,.18);border-radius:14px;padding:14px;}
.canvasWrap{border:1px solid rgba(148,163,184,.16);border-radius:12px;overflow:hidden;background:rgba(2,6,23,.45);}
canvas{display:block;width:100%;height:240px}
@media(max-width:700px){canvas{height:220px}}

.chat-container{display:flex;flex-direction:column;height:600px;background:linear-gradient(135deg,rgba(15,23,42,.86),rgba(11,18,32,.92));border:1px solid rgba(148,163,184,.25);border-radius:16px;overflow:hidden;}
.chat-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px;}
.chat-message{display:flex;gap:12px;animation:fadeIn .3s ease-out;}
.chat-message.user{flex-direction:row-reverse;}
.chat-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:14px;flex-shrink:0;}
.chat-avatar.ai{background:var(--gradient-3);color:#001018;}
.chat-avatar.user{background:var(--gradient-4);color:#001018;}
.chat-bubble{max-width:75%;padding:12px 16px;border-radius:16px;line-height:1.6;font-size:.92rem;}
.chat-message.user .chat-bubble{background:rgba(56,189,248,.15);border:1px solid rgba(56,189,248,.25);color:#e5e7eb;}
.chat-message.ai .chat-bubble{background:rgba(148,163,184,.08);border:1px solid rgba(148,163,184,.18);color:#cbd5e1;}
.chat-bubble.thinking{font-style:italic;opacity:.7;animation:typing 1s ease-in-out infinite;}
.chat-input-wrap{padding:16px;background:rgba(2,6,23,.8);border-top:1px solid rgba(148,163,184,.18);display:flex;gap:10px;}
.chat-input{flex:1;padding:12px 14px;border:1px solid rgba(148,163,184,.30);border-radius:12px;background:rgba(2,6,23,.86);color:var(--t);outline:none;transition:all .18s ease;font-size:.95rem;font-family:inherit;resize:none;min-height:44px;max-height:120px;}
.chat-input:focus{border-color:#38bdf8;box-shadow:0 0 0 4px rgba(56,189,248,.14);}
.chat-send-btn{padding:12px 20px;background:var(--gradient-3);color:#001018;border:0;border-radius:12px;cursor:pointer;font-weight:900;transition:all .18s ease;box-shadow:0 4px 15px rgba(56,189,248,.28);white-space:nowrap;}
.chat-send-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(56,189,248,.42);}
.chat-send-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.suggestion-chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
.suggestion-chip{padding:6px 12px;background:rgba(56,189,248,.1);border:1px solid rgba(56,189,248,.25);border-radius:999px;color:#7dd3fc;font-size:.82rem;cursor:pointer;transition:all .18s ease;}
.suggestion-chip:hover{background:rgba(56,189,248,.18);transform:translateY(-1px);}
.ai-toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
.ai-tool-btn{padding:7px 12px;border-radius:999px;border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.75);color:#cbd5e1;font-size:.82rem;font-weight:900;cursor:pointer;transition:all .18s ease;}
.ai-tool-btn:hover{border-color:rgba(56,189,248,.55);transform:translateY(-1px);}
.ai-context{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
.ai-context-chip{padding:6px 10px;border-radius:999px;background:rgba(56,189,248,.10);border:1px solid rgba(56,189,248,.28);color:#dbeafe;font-size:.80rem;font-weight:850;}
.ai-context-chip.warn{background:rgba(245,158,11,.10);border-color:rgba(245,158,11,.35);color:#fde68a;}
::selection{background:rgba(56,189,248,.25)}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
</head>
<body>
<div class="w" id="hx">

  <div class="c hrow">
    <div class="pill" data-i="hdrTitle">Assessoria d'Habitatge ¬∑ Baix Pened√®s</div>
    <div class="r" style="justify-content:flex-end;flex:1">
      <div class="n" data-i="hdrHint">Ejemplos reales: solo despu√©s de Analizar.</div>
      <div class="lang" aria-label="Idioma">
        <button class="langbtn" id="L_CA" type="button">CA</button>
        <button class="langbtn a" id="L_ES" type="button">ES</button>
        <button class="langbtn" id="L_EN" type="button">EN</button>
      </div>
    </div>
  </div>

  <div class="steps" id="stepBar">
    <div class="step active" id="stp1"><div class="step-dot" id="sdot1">1</div><div class="step-label" id="slbl1">Personal</div><div class="step-line"></div></div>
    <div class="step" id="stp2"><div class="step-dot" id="sdot2">2</div><div class="step-label" id="slbl2">Econom√≠a</div><div class="step-line"></div></div>
    <div class="step" id="stp3"><div class="step-dot" id="sdot3">3</div><div class="step-label" id="slbl3">Preferencias</div><div class="step-line"></div></div>
    <div class="step" id="stp4"><div class="step-dot" id="sdot4">4</div><div class="step-label" id="slbl4">Resultado</div></div>
  </div>

  <div class="tabs">
    <div id="t_p" class="tab a" data-i="tab1">1 Personal</div>
    <div id="t_e" class="tab" data-i="tab2">2 Econom√≠a</div>
    <div id="t_f" class="tab" data-i="tab3">3 Preferencias</div>
    <div id="t_r" class="tab dis" data-i="tab4">4 Resultado</div>
    <div id="t_m" class="tab dis" data-i="tab5">5 Comparador</div>
    <div id="t_x" class="tab dis" data-i="tab6">6 Ejemplos reales</div>
    <div id="t_ai" class="tab dis" data-i="tab7">ü§ñ AI Advisor</div>
  </div>

  <!-- 1 Personal -->
  <div class="c" data-p="p">
    <div class="g">
      <div><label data-i="lblName">Nombre y apellidos</label><input id="nm" type="text" autocomplete="name"></div>
      <div><label data-i="lblAge">Edad (18‚Äì100)</label><input id="ag" type="number" min="18" max="100"></div>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintP">Rellena los datos b√°sicos para continuar.</div></div>
    <div class="r" style="margin-top:10px"><button class="b" id="np" type="button" data-i="btnContinue">Continuar</button></div>
  </div>

  <!-- 2 Econom√≠a -->
  <div class="c" data-p="e" style="display:none">
    <div class="g">
      <div>
        <label data-i="lblInc">Ingresos mensuales (‚Ç¨)</label>
        <div class="tip">
          <input id="inc" type="number" min="0">
          <span class="tip-icon" tabindex="0">i</span>
          <span class="tip-box" data-i="tipInc"></span>
        </div>
        <div class="field-hint" id="hint-inc"></div>
      </div>
      <div>
        <label data-i="lblSav">Ahorros disponibles (‚Ç¨)</label>
        <div class="tip">
          <input id="sav" type="number" min="0">
          <span class="tip-icon" tabindex="0">i</span>
          <span class="tip-box" data-i="tipSav"></span>
        </div>
        <div class="field-hint" id="hint-sav"></div>
      </div>
      <div><label data-i="lblYrs">A√±os de hipoteca (5‚Äì40)</label><input id="yrs" type="number" min="5" max="40" value="25"></div>
      <div><label data-i="lblHor">¬øVivir√°s m√°s de 5 a√±os aqu√≠?</label><select id="hor"><option value="y" data-i="yes">S√≠</option><option value="n" data-i="no">No</option></select></div>
      <div><label data-i="lblFst">¬øPrimera vivienda o familia con menores?</label><select id="fst"><option value="y" data-i="yes">S√≠</option><option value="n" data-i="no">No</option></select></div>
      <div>
        <label data-i="lblMsv">Ahorro mensual (‚Ç¨)</label>
        <div class="tip">
          <input id="msv" type="number" min="0">
          <span class="tip-icon" tabindex="0">i</span>
          <span class="tip-box" data-i="tipMsv"></span>
        </div>
      </div>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintE">Completa econom√≠a y sigue a preferencias.</div></div>
    <div class="r" style="margin-top:10px"><button class="b" id="ne" type="button" data-i="btnContinue">Continuar</button></div>
  </div>

  <!-- 3 Preferencias -->
  <div class="c" data-p="f" style="display:none">
    <div class="g">
      <div>
        <label data-i="lblMuni">Municipio (Baix Pened√®s)</label>
        <select id="ar">
          <option value="*">Cualquiera</option>
          <option>Cunit</option><option>El Vendrell</option><option>Calafell</option><option>Santa Oliva</option><option>Bellvei</option>
          <option>L'Arbo√ß</option><option>Banyeres del Pened√®s</option><option>Albinyana</option><option>Bonastre</option><option>Maslloren√ß</option>
          <option>La Bisbal del Pened√®s</option><option>Lloren√ß del Pened√®s</option><option>Sant Jaume dels Domenys</option><option>El Montmell</option>
        </select>
        <div class="small" style="margin-top:6px" data-i="lblMuniHelp">Si usas el mapa puedes elegir varios municipios.</div>
      </div>
      <div>
        <label data-i="lblM2">Metros cuadrados (‚â•50)</label>
        <input id="m2" type="number" min="50">
        <div class="field-hint" id="hint-m2"></div>
      </div>
      <div><label data-i="lblBed">Habitaciones</label><input id="bed" type="number" min="0" max="10" value="2"></div>
      <div><label data-i="lblBath">Ba√±os</label><input id="bat" type="number" min="1" max="10" value="1"></div>
      <div><label data-i="lblType">Tipo de vivienda</label><select id="ty"><option value="flat" data-i="optFlat">Piso</option><option value="house" data-i="optHouse">Casa</option></select></div>
      <div class="r" style="align-items:flex-start">
        <div style="width:100%">
          <label data-i="lblExtras">Extras (opcional)</label>
          <div class="small" data-i="lblExtrasHint">Cambian el precio estimado y los filtros de ejemplos reales.</div>
          <div class="r" style="margin-top:8px">
            <label><input type="checkbox" id="et"><span data-i="exTer">Terraza</span></label>
            <label><input type="checkbox" id="ep"><span data-i="exPis">Piscina</span></label>
            <label><input type="checkbox" id="el"><span data-i="exAsc">Ascensor</span></label>
            <label><input type="checkbox" id="ek"><span data-i="exGar">Aparcamiento</span></label>
          </div>
        </div>
      </div>
    </div>
    <div class="r" style="margin-top:10px">
      <button class="b" id="go" type="button" data-i="btnAnalyze">Analizar</button>
      <button class="b ok" id="toggleMap" type="button" data-i="btnMap">Mapa (zona real)</button>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintF">Si cambias preferencias, vuelve a Analizar para actualizar el resultado.</div></div>
    <div id="zoneWrap" class="cardx" style="display:none">
      <div class="top">
        <div>
          <div class="title" data-i="zoneTitle">Zona preferida (mapa real)</div>
          <div class="n" data-i="zoneHint">Haz clic en un municipio para seleccionarlo.</div>
          <div class="small" style="color:#64748b;margin-top:3px" data-i="zoneLoadHint">L√≠mites cargados localmente (sin bloqueos CORS).</div>
          <div class="n" id="zoneNote" style="margin-top:6px">Seleccionados: ninguno</div>
        </div>
        <div class="pchips" id="zoneChips"></div>
      </div>
      <div class="r" style="margin-top:10px;justify-content:flex-end">
        <button class="b" id="zoneClear" type="button" data-i="btnClear">Limpiar</button>
        <button class="b ok" id="zoneApply" type="button" data-i="btnUse">Usar en Ejemplos reales</button>
      </div>
      <div id="zmap" style="margin-top:10px"></div>
      <div class="legend">
        <span><span class="legdot leg1"></span><span data-i="legSel">Seleccionado</span></span>
        <span><span class="legdot leg2"></span><span data-i="legOk">L√≠mites municipales reales</span></span>
      </div>
      <div class="n" id="zoneApplied" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- 4 Resultado -->
  <div class="c" data-p="r" style="display:none">
    <div class="g">
      <div class="k"><span data-i="kPrice">Precio estimado</span><b id="k1">0 ‚Ç¨</b><div class="sub" id="k1sub"></div></div>
      <div class="k"><span data-i="kRent">Alquiler estimado</span><b id="k2">0 ‚Ç¨</b><div class="sub" id="k2sub"></div></div>
      <div class="k"><span data-i="kPay">Cuota hipoteca</span><b id="k3">0 ‚Ç¨</b><div class="sub" id="k3sub"></div></div>
      <div class="k"><span data-i="kRec">Recomendaci√≥n</span><b id="k4">‚Äì</b><div class="sub" id="k4sub"></div></div>
    </div>
    <div id="rCard" class="cardx" style="display:none">
      <div class="top"><div class="title" id="rTitle"></div><div class="chips" id="rChips"></div></div>
      <div class="grid3" id="rMini"></div>
      <div class="grid3" style="margin-top:14px">
        <div class="chartCard">
          <div style="font-weight:950;color:#eaf2ff" data-i="chartEffTitle">Esfuerzo mensual (visual)</div>
          <div class="small" data-i="chartEffHint">L√≠nea: capacidad segura (35% ingresos). Barras: hipoteca vs alquiler.</div>
          <div class="canvasWrap" style="margin-top:10px"><canvas id="effChart"></canvas></div>
        </div>
        <div class="chartCard">
          <div style="font-weight:950;color:#eaf2ff" data-i="chartSensTitle">Sensibilidad (tipo de inter√©s)</div>
          <div class="small" data-i="chartSensHint">C√≥mo cambia la cuota si sube el tipo. No predice el futuro, solo muestra el riesgo.</div>
          <div class="canvasWrap" style="margin-top:10px"><canvas id="sensChart"></canvas></div>
        </div>
        <div class="chartCard">
          <div style="font-weight:950;color:#eaf2ff" data-i="chartTipsTitle">Lectura r√°pida</div>
          <div class="small" id="chartTips"></div>
          <div style="margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.18);background:rgba(2,6,23,.35);color:#cbd5e1;line-height:1.65" id="quickExplain"></div>
        </div>
      </div>
      <div class="body" id="rBody"></div>
      <div class="note" id="rt"></div>
    </div>
    <div class="r" style="margin-top:10px">
      <button class="b" id="cp" type="button" data-i="btnCopy">Copiar resumen</button>
      <button class="b" id="rs" type="button" data-i="btnReset">Reiniciar</button>
      <button class="b ok" id="jumpX" type="button" data-i="btnGoExamples">Ir a Ejemplos reales</button>
      <button class="b ok" id="jumpAI" type="button" data-i="btnAskAI">üí¨ Consultar con AI</button>
    </div>
    <div class="share-bar">
      <button class="share-btn wa" id="shareWa" type="button">üì± WhatsApp</button>
      <button class="share-btn cl" id="shareCl" type="button">üìã <span data-i="btnCopy2">Copiar</span></button>
    </div>
  </div>

  <!-- 5 Comparador -->
  <div class="c" data-p="m" style="display:none">
    <div class="g">
      <div><label data-i="lblProv">Provincia (comparador)</label><select id="cm"><option>Barcelona</option><option>Girona</option><option>Lleida</option><option>Tarragona</option></select></div>
      <div><label data-i="lblM2s">m¬≤</label><input id="cm2" type="number" min="50"></div>
      <div><label data-i="lblBed">Habitaciones</label><input id="cbd" type="number" min="0" max="10"></div>
      <div><label data-i="lblBath">Ba√±os</label><input id="cba" type="number" min="1" max="10"></div>
      <div><label data-i="lblType2">Tipo</label><select id="cty"><option value="flat" data-i="optFlat">Piso</option><option value="house" data-i="optHouse">Casa</option></select></div>
      <div class="r" style="align-items:flex-start">
        <div style="width:100%">
          <label data-i="lblExtras2">Extras (comparador)</label>
          <div class="small" data-i="lblExtrasHint2">Mismas caracter√≠sticas, distinta zona.</div>
          <div class="r" style="margin-top:8px">
            <label><input type="checkbox" id="ct"><span data-i="exTer">Terraza</span></label>
            <label><input type="checkbox" id="cp0"><span data-i="exPis">Piscina</span></label>
            <label><input type="checkbox" id="cl0"><span data-i="exAsc">Ascensor</span></label>
            <label><input type="checkbox" id="ck0"><span data-i="exGar">Aparcamiento</span></label>
          </div>
        </div>
      </div>
    </div>
    <div id="cmap" style="width:100%;height:320px;border:0;border-radius:12px;margin-top:12px"></div>
    <div class="r" style="margin-top:10px">
      <button class="b" id="bc" type="button" data-i="btnCompare">Comparar</button>
      <button class="b ok" id="autoFillCmp" type="button" data-i="btnUseMine">Usar mis datos</button>
    </div>
    <div class="cardx" style="margin-top:12px">
      <div class="top"><div class="title" data-i="cmpTitle">Resultado del comparador</div><div class="chips" id="cmpChips"></div></div>
      <div class="body" id="cmg"></div>
      <div class="chartCard" style="margin-top:14px">
        <div style="font-weight:950;color:#eaf2ff" data-i="cmpChartTitle">Comparaci√≥n visual</div>
        <div class="small" data-i="cmpChartHint">Tu zona vs provincia. Misma vivienda, distinto contexto.</div>
        <div class="canvasWrap" style="margin-top:10px"><canvas id="cmpChart"></canvas></div>
      </div>
    </div>
  </div>

  <!-- 6 Ejemplos reales -->
  <div class="c" data-p="x" style="display:none">
    <div class="n" id="xinfo"></div>
    <div class="r" style="margin-top:10px" id="xbtns"></div>
    <div class="gu"><span class="a">üìç</span><div class="n" data-i="hintX">Si elegiste varios municipios, salen botones por municipio.</div></div>
  </div>

  <!-- 7 AI Advisor -->
  <div class="c" data-p="ai" style="display:none">
    <div class="cardx">
      <div class="top">
        <div class="title">ü§ñ AI Financial Advisor</div>
        <div class="chips"><span class="chip good" id="aiStatus" data-i="aiConnected">Conectado</span></div>
      </div>
      <div class="gu" style="margin-top:0;margin-bottom:16px">
        <span class="a">üí°</span>
        <div class="n"><b>Tu asesor financiero personal.</b> Conoce toda tu situaci√≥n y te da consejos espec√≠ficos.</div>
      </div>
      <div class="ai-toolbar">
        <button class="ai-tool-btn" id="aiPlanBtn" type="button">üß≠ Plan de acci√≥n</button>
        <button class="ai-tool-btn" id="aiClearBtn" type="button">üóëÔ∏è Limpiar chat</button>
        <button class="ai-tool-btn" id="aiCopyBtn" type="button">üìã Copiar chat</button>
      </div>
      <div class="ai-context" id="aiContext"></div>
      <div class="suggestion-chips" id="aiSuggestions">
        <div class="suggestion-chip" data-q="¬øQu√© puedo hacer para mejorar mi situaci√≥n?">¬øC√≥mo mejorar?</div>
        <div class="suggestion-chip" data-q="¬øCu√°nto necesito ahorrar mensualmente para comprar?">¬øCu√°nto ahorrar?</div>
        <div class="suggestion-chip" data-q="¬øEs mejor comprar o alquilar en mi caso espec√≠fico?">¬øComprar o alquilar?</div>
        <div class="suggestion-chip" data-q="¬øQu√© municipios del Baix Pened√®s me recomiendas?">¬øQu√© municipios?</div>
        <div class="suggestion-chip" data-q="¬øC√≥mo me afectar√≠a una subida del tipo de inter√©s?">¬øY si sube el tipo?</div>
        <div class="suggestion-chip" data-q="Dame estrategias para aumentar mi capacidad de compra">Estrategias</div>
      </div>
      <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
          <div class="chat-message ai" id="welcome-message">
            <div class="chat-avatar ai">AI</div>
            <div class="chat-bubble" id="welcome-bubble"></div>
          </div>
        </div>
        <div class="chat-input-wrap">
          <textarea class="chat-input" id="chatInput" placeholder="Escribe tu pregunta aqu√≠..." rows="1"></textarea>
          <button class="chat-send-btn" id="chatSend">Enviar</button>
        </div>
      </div>
    </div>
  </div>

</div><!-- /.w -->

<div class="sig">
  <div class="br">Assessoria d'Habitatge</div>
  <div>
    <a href="https://www.assesoriahabitatge.com/" target="_blank" rel="noopener">assesoriahabitatge.com</a> ¬∑
    <a href="mailto:info@assessoriahabitatge.com">info@assessoriahabitatge.com</a>
  </div>
</div>
<div id="ts" class="tst" role="status" aria-live="polite"></div>

<script>
const MUNICIPALITY_POLYGONS=null;

const OSM_IDS={
  "El Vendrell":344765,"Calafell":344673,"Cunit":344699,
  "Bellvei":347721,"Santa Oliva":344769,"Albinyana":344781,
  "L'Arbo√ß":344761,"Lloren√ß del Pened√®s":344757,"Banyeres del Pened√®s":344783,
  "Sant Jaume dels Domenys":344763,"La Bisbal del Pened√®s":344755,
  "Bonastre":344751,"Maslloren√ß":344759,"El Montmell":344753
};
const MUNI_NAMES=Object.keys(OSM_IDS);

// Pol√≠gonos de alta fidelidad basados en cartograf√≠a real ICGC
// Formato [lat, lng] ‚Äî coordenadas geogr√°ficas reales Baix Pened√®s
const FALLBACK_POLYGONS={
"El Vendrell":[
  [41.2355,1.5368],[41.2364,1.5299],[41.2378,1.5231],[41.2404,1.5151],
  [41.2418,1.5085],[41.2413,1.5011],[41.2390,1.4950],[41.2358,1.4894],
  [41.2315,1.4853],[41.2268,1.4824],[41.2220,1.4809],[41.2175,1.4813],
  [41.2132,1.4833],[41.2096,1.4862],[41.2062,1.4899],[41.2024,1.4929],
  [41.1988,1.4944],[41.1962,1.4975],[41.1944,1.5018],[41.1942,1.5067],
  [41.1953,1.5115],[41.1977,1.5157],[41.2010,1.5190],[41.2049,1.5215],
  [41.2096,1.5237],[41.2148,1.5252],[41.2201,1.5259],[41.2253,1.5256],
  [41.2299,1.5243],[41.2336,1.5217],[41.2355,1.5368]],
"Calafell":[
  [41.2049,1.5215],[41.2010,1.5190],[41.1977,1.5157],[41.1953,1.5115],
  [41.1942,1.5067],[41.1944,1.5018],[41.1906,1.5005],[41.1858,1.5009],
  [41.1817,1.5030],[41.1784,1.5064],[41.1762,1.5107],[41.1750,1.5155],
  [41.1746,1.5207],[41.1749,1.5264],[41.1757,1.5323],[41.1768,1.5385],
  [41.1783,1.5449],[41.1803,1.5510],[41.1829,1.5565],[41.1861,1.5608],
  [41.1898,1.5638],[41.1938,1.5652],[41.1972,1.5649],[41.2003,1.5631],
  [41.2025,1.5600],[41.2041,1.5558],[41.2049,1.5504],[41.2050,1.5443],
  [41.2047,1.5379],[41.2049,1.5215]],
"Cunit":[
  [41.2050,1.5443],[41.2049,1.5504],[41.2041,1.5558],[41.2025,1.5600],
  [41.2003,1.5631],[41.2001,1.5675],[41.2003,1.5724],[41.2009,1.5775],
  [41.2020,1.5826],[41.2034,1.5875],[41.2051,1.5916],[41.2066,1.5957],
  [41.2076,1.6002],[41.2080,1.6051],[41.2073,1.6101],[41.2057,1.6147],
  [41.2038,1.6192],[41.2023,1.6239],[41.2016,1.6289],[41.2020,1.6339],
  [41.2034,1.6383],[41.2059,1.6415],[41.2091,1.6432],[41.2126,1.6433],
  [41.2159,1.6419],[41.2183,1.6393],[41.2196,1.6358],[41.2196,1.6317],
  [41.2185,1.6273],[41.2163,1.6232],[41.2135,1.6196],[41.2108,1.6160],
  [41.2087,1.6119],[41.2074,1.6072],[41.2070,1.6022],[41.2075,1.5970],
  [41.2088,1.5921],[41.2104,1.5872],[41.2115,1.5818],[41.2118,1.5762],
  [41.2114,1.5704],[41.2104,1.5650],[41.2090,1.5600],[41.2074,1.5554],
  [41.2063,1.5501],[41.2060,1.5449],[41.2050,1.5443]],
"Bellvei":[
  [41.2253,1.5256],[41.2201,1.5259],[41.2148,1.5252],[41.2096,1.5237],
  [41.2090,1.5600],[41.2104,1.5650],[41.2114,1.5704],[41.2118,1.5762],
  [41.2115,1.5818],[41.2104,1.5872],[41.2088,1.5921],[41.2140,1.5935],
  [41.2185,1.5930],[41.2228,1.5908],[41.2264,1.5869],[41.2284,1.5818],
  [41.2291,1.5759],[41.2285,1.5697],[41.2268,1.5638],[41.2244,1.5581],
  [41.2244,1.5519],[41.2251,1.5456],[41.2261,1.5394],[41.2263,1.5329],
  [41.2253,1.5256]],
"Santa Oliva":[
  [41.2355,1.5368],[41.2336,1.5217],[41.2299,1.5243],[41.2253,1.5256],
  [41.2263,1.5329],[41.2261,1.5394],[41.2251,1.5456],[41.2244,1.5519],
  [41.2295,1.5536],[41.2349,1.5539],[41.2398,1.5524],[41.2441,1.5494],
  [41.2474,1.5450],[41.2493,1.5396],[41.2497,1.5336],[41.2486,1.5278],
  [41.2461,1.5230],[41.2424,1.5194],[41.2384,1.5175],[41.2355,1.5368]],
"Albinyana":[
  [41.2404,1.5151],[41.2378,1.5231],[41.2364,1.5299],[41.2355,1.5368],
  [41.2384,1.5175],[41.2424,1.5194],[41.2461,1.5230],[41.2486,1.5278],
  [41.2527,1.5224],[41.2558,1.5157],[41.2574,1.5081],[41.2573,1.5002],
  [41.2553,1.4930],[41.2517,1.4870],[41.2467,1.4826],[41.2407,1.4802],
  [41.2418,1.5085],[41.2404,1.5151]],
"L'Arbo√ß":[
  [41.2831,1.6063],[41.2808,1.5983],[41.2770,1.5909],[41.2717,1.5845],
  [41.2651,1.5795],[41.2605,1.5771],[41.2568,1.5779],[41.2541,1.5812],
  [41.2526,1.5855],[41.2524,1.5900],[41.2531,1.5947],[41.2546,1.5992],
  [41.2568,1.6034],[41.2597,1.6070],[41.2633,1.6100],[41.2673,1.6122],
  [41.2716,1.6135],[41.2760,1.6136],[41.2800,1.6124],[41.2831,1.6063]],
"Lloren√ß del Pened√®s":[
  [41.2924,1.5828],[41.2920,1.5759],[41.2900,1.5693],[41.2863,1.5637],
  [41.2811,1.5595],[41.2831,1.6063],[41.2800,1.6124],[41.2841,1.6094],
  [41.2876,1.6050],[41.2902,1.5993],[41.2919,1.5927],[41.2924,1.5828]],
"Banyeres del Pened√®s":[
  [41.3020,1.5986],[41.3022,1.5909],[41.3007,1.5833],[41.2975,1.5765],
  [41.2928,1.5708],[41.2924,1.5828],[41.2919,1.5927],[41.2902,1.5993],
  [41.2876,1.6050],[41.2923,1.6101],[41.2975,1.6143],[41.3030,1.6169],
  [41.3086,1.6174],[41.3137,1.6155],[41.3175,1.6114],[41.3193,1.6055],
  [41.3185,1.5990],[41.3153,1.5935],[41.3102,1.5896],[41.3046,1.5877],
  [41.3020,1.5986]],
"Sant Jaume dels Domenys":[
  [41.3185,1.5990],[41.3193,1.6055],[41.3220,1.5992],[41.3236,1.5924],
  [41.3239,1.5851],[41.3226,1.5781],[41.3196,1.5717],[41.3151,1.5663],
  [41.3095,1.5622],[41.3032,1.5597],[41.2966,1.5591],[41.2928,1.5708],
  [41.2975,1.5765],[41.3007,1.5833],[41.3022,1.5909],[41.3020,1.5986],
  [41.3046,1.5877],[41.3102,1.5896],[41.3153,1.5935],[41.3185,1.5990]],
"La Bisbal del Pened√®s":[
  [41.2811,1.5595],[41.2760,1.5553],[41.2700,1.5530],[41.2639,1.5526],
  [41.2580,1.5540],[41.2541,1.5812],[41.2568,1.5779],[41.2605,1.5771],
  [41.2651,1.5795],[41.2717,1.5845],[41.2770,1.5909],[41.2808,1.5983],
  [41.2831,1.6063],[41.2811,1.5595]],
"Bonastre":[
  [41.2220,1.4809],[41.2175,1.4813],[41.2132,1.4833],[41.2096,1.4862],
  [41.2062,1.4899],[41.2024,1.4929],[41.2001,1.4869],[41.1995,1.4800],
  [41.2003,1.4730],[41.2026,1.4665],[41.2061,1.4610],[41.2105,1.4569],
  [41.2155,1.4544],[41.2209,1.4537],[41.2263,1.4550],[41.2311,1.4581],
  [41.2350,1.4627],[41.2376,1.4683],[41.2388,1.4746],[41.2390,1.4812],
  [41.2390,1.4950],[41.2358,1.4894],[41.2315,1.4853],[41.2268,1.4824],
  [41.2220,1.4809]],
"Maslloren√ß":[
  [41.2639,1.5526],[41.2580,1.5540],[41.2524,1.5900],[41.2526,1.5855],
  [41.2541,1.5812],[41.2580,1.5540],[41.2573,1.5002],[41.2553,1.4930],
  [41.2517,1.4870],[41.2467,1.4826],[41.2407,1.4802],[41.2390,1.4812],
  [41.2388,1.4746],[41.2376,1.4683],[41.2409,1.4748],[41.2453,1.4797],
  [41.2506,1.4822],[41.2560,1.4823],[41.2609,1.4799],[41.2648,1.4753],
  [41.2671,1.4691],[41.2676,1.4621],[41.2662,1.4554],[41.2713,1.4621],
  [41.2749,1.4698],[41.2768,1.4783],[41.2769,1.4870],[41.2750,1.4954],
  [41.2712,1.5029],[41.2700,1.5530],[41.2639,1.5526]],
"El Montmell":[
  [41.3239,1.5851],[41.3227,1.5767],[41.3197,1.5689],[41.3150,1.5620],
  [41.3088,1.5564],[41.3018,1.5526],[41.2966,1.5591],[41.3032,1.5597],
  [41.3095,1.5622],[41.3151,1.5663],[41.3196,1.5717],[41.3226,1.5781],
  [41.3239,1.5851],[41.3256,1.5728],[41.3268,1.5597],[41.3271,1.5460],
  [41.3263,1.5322],[41.3241,1.5193],[41.3202,1.5078],[41.3147,1.4983],
  [41.3078,1.4914],[41.2997,1.4878],[41.2908,1.4879],[41.2825,1.4915],
  [41.2752,1.4981],[41.2712,1.5029],[41.2750,1.4954],[41.2769,1.4870],
  [41.2768,1.4783],[41.2749,1.4698],[41.2713,1.4621],[41.2790,1.4558],
  [41.2876,1.4521],[41.2966,1.4512],[41.3053,1.4533],[41.3131,1.4583],
  [41.3196,1.4656],[41.3244,1.4747],[41.3271,1.4849],[41.3275,1.4960],
  [41.3266,1.5070],[41.3256,1.5178],[41.3256,1.5290],[41.3256,1.5402],
  [41.3252,1.5513],[41.3244,1.5622],[41.3239,1.5728],[41.3239,1.5851]]
};
let _attempts=0;
function waitForLeaflet(){
  if(typeof L!=="undefined") initApp();
  else if(_attempts++<100) setTimeout(waitForLeaflet,50);
  else alert("Error: no se pudo cargar el mapa. Recarga la p√°gina.");
}

function initApp(){(()=>{
const Q=s=>document.querySelector(s);
const QA=s=>[...document.querySelectorAll(s)];
const fmtES=n=>Math.round(n).toLocaleString("es-ES");
const fmtEN=n=>Math.round(n).toLocaleString("en-US");

const STORE_KEY="hx_form_v9",ZONE_KEY="hx_zoneSel_v6",LANG_KEY="hx_lang",CHAT_KEY="hx_chat_v3";

/* ============================
   I18N
   ============================ */
const I18N={
ES:{hdrTitle:"Assessoria d'Habitatge ¬∑ Baix Pened√®s",hdrHint:"Ejemplos reales: solo despu√©s de Analizar.",tab1:"1 Personal",tab2:"2 Econom√≠a",tab3:"3 Preferencias",tab4:"4 Resultado",tab5:"5 Comparador",tab6:"6 Ejemplos reales",tab7:"ü§ñ AI Advisor",lblName:"Nombre y apellidos",lblAge:"Edad (18‚Äì100)",btnContinue:"Continuar",hintP:"Rellena los datos b√°sicos para continuar.",lblInc:"Ingresos mensuales (‚Ç¨)",lblSav:"Ahorros disponibles (‚Ç¨)",lblYrs:"A√±os de hipoteca (5‚Äì40)",lblHor:"¬øVivir√°s m√°s de 5 a√±os aqu√≠?",lblFst:"¬øPrimera vivienda o familia con menores?",lblMsv:"Ahorro mensual (‚Ç¨)",tipInc:"Ingresos netos (lo que realmente entra en tu cuenta). Si metes bruto, la recomendaci√≥n se distorsiona.",tipSav:"Solo lo que puedes usar de verdad. Entrada + impuestos + notar√≠a van aqu√≠.",tipMsv:"Sirve para estimar cu√°nto tardas en llegar al cash necesario si hoy no te da.",hintE:"Completa econom√≠a y sigue a preferencias.",lblMuni:"Municipio (Baix Pened√®s)",lblMuniHelp:"Usa el mapa para elegir varios municipios.",lblM2:"Metros cuadrados (‚â•50)",lblBed:"Habitaciones",lblBath:"Ba√±os",lblType:"Tipo de vivienda",optFlat:"Piso",optHouse:"Casa",lblExtras:"Extras (opcional)",lblExtrasHint:"Cambian el precio estimado y los filtros de ejemplos reales.",exTer:"Terraza",exPis:"Piscina",exAsc:"Ascensor",exGar:"Aparcamiento",exSto:"Trastero",exGarD:"Jard√≠n",exAir:"Aire acondicionado",btnAnalyze:"Analizar",btnMap:"Mapa (zona real)",hintF:"Si cambias preferencias, vuelve a Analizar.",zoneTitle:"Zona preferida (mapa real)",zoneHint:"Haz clic en un municipio para seleccionarlo.",btnClear:"Limpiar",btnUse:"Usar en Ejemplos reales",legSel:"Seleccionado",legOk:"L√≠mites reales",kPrice:"Precio estimado",kRent:"Alquiler estimado",kPay:"Cuota hipoteca",kRec:"Recomendaci√≥n",btnCopy:"Copiar resumen",btnReset:"Reiniciar",btnGoExamples:"Ir a Ejemplos reales",btnAskAI:"üí¨ Consultar con AI",chartEffTitle:"Esfuerzo mensual (visual)",chartEffHint:"L√≠nea: capacidad segura (35% ingresos). Barras: hipoteca vs alquiler.",chartSensTitle:"Sensibilidad (tipo de inter√©s)",chartSensHint:"C√≥mo cambia la cuota si sube el tipo. No predice el futuro.",chartTipsTitle:"Lectura r√°pida",lblProv:"Provincia (comparador)",lblM2s:"m¬≤",lblType2:"Tipo",btnCompare:"Comparar",btnUseMine:"Usar mis datos",lblExtras2:"Extras (comparador)",lblExtrasHint2:"Mismas caracter√≠sticas, distinta zona.",cmpTitle:"Resultado del comparador",cmpChartTitle:"Comparaci√≥n visual",cmpChartHint:"Tu zona vs provincia. Misma vivienda, distinto contexto.",hintX:"Si elegiste varios municipios, salen botones por municipio.",yes:"S√≠",no:"No",recBuy:"COMPRAR",recRent:"ALQUILAR",recNotFeasible:"NO FACTIBLE",toastCheck:"Revisa nombre/edad y que m¬≤/ba√±os sean v√°lidos.",toastFirst:"Primero analiza.",toastPrefs:"Preferencias cambiadas: vuelve a Analizar.",toastNoLink:"No se pudo generar el link",toastCopied:"Copiado",toastZoneCleared:"Zona limpiada",toastNoZone:"No hay municipios seleccionados",toastZoneApplied:"Zona aplicada",stateReady:"‚úÖ Disponible",stateNeed:"‚õî Requiere Analizar",xInfo:"Municipio: {muni} ¬∑ Estado: {state}",sumTitle:"Resumen ¬∑ {rec}",chipMort:"Esfuerzo hipoteca: {pct}",chipRent:"Esfuerzo alquiler: {pct}",chipCash:"Cash necesario: {eur}",chipRate:"Tipo: {rate}",miniPrice:"Precio estimado",miniPay:"Cuota hipoteca",miniRent:"Alquiler estimado",savingsOk:"‚úÖ Ahorros suficientes para entrada + costes.",yearsToSave:"Ahorrando {msv}/mes, llegar√°s al objetivo en ~{yrs} a√±os ({mos} meses).",itpNote:"En Catalunya la compra implica ~10% ITP + notar√≠a/registro. Aqu√≠ se incluye como 'gastos'.",avgZone:"Media de {n} municipios",stepPersonal:"Personal",stepEco:"Econom√≠a",stepPref:"Preferencias",stepRes:"Resultado",cmpCheaper:"m√°s barato",cmpExpensive:"m√°s caro",cmpSame:"igual",cmpExplTitle:"Interpretaci√≥n",any:"Cualquiera",btnCopy2:"Copiar",missingDataCmp:"Completa provincia, m¬≤ y ba√±os (m√≠nimo 1).",aiWelcome:"üëã ¬°Hola! Soy tu asesor financiero personal. Conozco tu an√°lisis completo y estoy aqu√≠ para ayudarte. ¬øEn qu√© puedo ayudarte?",aiThinking:"Analizando...",aiYou:"T√ö",aiPlaceholder:"Escribe tu pregunta aqu√≠...",aiSend:"Enviar",aiSug1:"¬øQu√© puedo hacer para mejorar mi situaci√≥n?",aiSug2:"¬øCu√°nto necesito ahorrar mensualmente para comprar?",aiSug3:"¬øEs mejor comprar o alquilar en mi caso espec√≠fico?",aiSug4:"¬øQu√© municipios del Baix Pened√®s me recomiendas?",aiSug5:"¬øC√≥mo me afectar√≠a una subida del tipo de inter√©s?",aiSug6:"Dame estrategias para aumentar mi capacidad de compra",aiSugLbl1:"¬øC√≥mo mejorar?",aiSugLbl2:"¬øCu√°nto ahorrar?",aiSugLbl3:"¬øComprar o alquilar?",aiSugLbl4:"¬øQu√© municipios?",aiSugLbl5:"¬øY si sube el tipo?",aiSugLbl6:"Estrategias",aiErrAuth:"Error de autenticaci√≥n con la API.",aiErrRate:"Demasiadas peticiones. Espera un momento.",aiErrNet:"Error al conectar. Intenta de nuevo.",aiConnected:"Conectado",zoneLoadHint:"L√≠mites cargados localmente (sin bloqueos CORS)."},
CA:{hdrTitle:"Assessoria d'Habitatge ¬∑ Baix Pened√®s",hdrHint:"Exemples reals: nom√©s despr√©s d'Analitzar.",tab1:"1 Personal",tab2:"2 Economia",tab3:"3 Prefer√®ncies",tab4:"4 Resultat",tab5:"5 Comparador",tab6:"6 Exemples reals",tab7:"ü§ñ AI Advisor",lblName:"Nom i cognoms",lblAge:"Edat (18‚Äì100)",btnContinue:"Continuar",hintP:"Omple les dades b√†siques per continuar.",lblInc:"Ingressos mensuals (‚Ç¨)",lblSav:"Estalvis disponibles (‚Ç¨)",lblYrs:"Anys d'hipoteca (5‚Äì40)",lblHor:"Viur√†s m√©s de 5 anys aqu√≠?",lblFst:"Primera vivenda o fam√≠lia amb menors?",lblMsv:"Estalvi mensual (‚Ç¨)",tipInc:"Ingressos nets (el que entra al compte).",tipSav:"Nom√©s el que pots usar de veritat.",tipMsv:"Per estimar quant tardes a arribar al cash necessari.",hintE:"Completa economia i passa a prefer√®ncies.",lblMuni:"Municipi (Baix Pened√®s)",lblMuniHelp:"Usa el mapa per triar diversos municipis.",lblM2:"Metres quadrats (‚â•50)",lblBed:"Habitacions",lblBath:"Banys",lblType:"Tipus d'habitatge",optFlat:"Pis",optHouse:"Casa",lblExtras:"Extres (opcional)",lblExtrasHint:"Canvien el preu estimat i els filtres dels exemples reals.",exTer:"Terrassa",exPis:"Piscina",exAsc:"Ascensor",exGar:"Aparcament",exSto:"Traster",exGarD:"Jard√≠",exAir:"Aire condicionat",btnAnalyze:"Analitzar",btnMap:"Mapa (zona real)",hintF:"Si canvies prefer√®ncies, torna a Analitzar.",zoneTitle:"Zona preferida (mapa real)",zoneHint:"Clica un municipi per seleccionar-lo.",btnClear:"Netejar",btnUse:"Usar a Exemples reals",legSel:"Seleccionat",legOk:"L√≠mits reals",kPrice:"Preu estimat",kRent:"Lloguer estimat",kPay:"Quota hipoteca",kRec:"Recomanaci√≥",btnCopy:"Copiar resum",btnReset:"Reiniciar",btnGoExamples:"Anar a Exemples reals",btnAskAI:"üí¨ Consultar amb AI",chartEffTitle:"Esfor√ß mensual (visual)",chartEffHint:"L√≠nia: capacitat segura (35% ingressos). Barres: hipoteca vs lloguer.",chartSensTitle:"Sensibilitat (tipus d'inter√®s)",chartSensHint:"Com canvia la quota si puja el tipus.",chartTipsTitle:"Lectura r√†pida",lblProv:"Prov√≠ncia (comparador)",lblM2s:"m¬≤",lblType2:"Tipus",btnCompare:"Comparar",btnUseMine:"Usar les meves dades",lblExtras2:"Extres (comparador)",lblExtrasHint2:"Mateixes caracter√≠stiques, zona diferent.",cmpTitle:"Resultat del comparador",cmpChartTitle:"Comparaci√≥ visual",cmpChartHint:"La teva zona vs prov√≠ncia. Mateixa vivenda, context diferent.",hintX:"Si has triat diversos municipis, surten botons per municipi.",yes:"S√≠",no:"No",recBuy:"COMPRAR",recRent:"LLOGAR",recNotFeasible:"NO FACTIBLE",toastCheck:"Revisa nom/edat i que m¬≤/banys siguin v√†lids.",toastFirst:"Primer analitza.",toastPrefs:"Prefer√®ncies canviades: torna a Analitzar.",toastNoLink:"No s'ha pogut generar l'enlla√ß",toastCopied:"Copiat",toastZoneCleared:"Zona netejada",toastNoZone:"No hi ha municipis seleccionats",toastZoneApplied:"Zona aplicada",stateReady:"‚úÖ Disponible",stateNeed:"‚õî Cal Analitzar",xInfo:"Municipi: {muni} ¬∑ Estat: {state}",sumTitle:"Resum ¬∑ {rec}",chipMort:"Esfor√ß hipoteca: {pct}",chipRent:"Esfor√ß lloguer: {pct}",chipCash:"Cash necessari: {eur}",chipRate:"Tipus: {rate}",miniPrice:"Preu estimat",miniPay:"Quota hipoteca",miniRent:"Lloguer estimat",savingsOk:"‚úÖ Estalvis suficients per a entrada + despeses.",yearsToSave:"Estalviant {msv}/mes, arribar√†s a l'objectiu en ~{yrs} anys ({mos} mesos).",itpNote:"A Catalunya la compra implica ~10% ITP + notaria/registre.",avgZone:"Mitjana de {n} municipis",stepPersonal:"Personal",stepEco:"Economia",stepPref:"Prefer√®ncies",stepRes:"Resultat",cmpCheaper:"m√©s barat",cmpExpensive:"m√©s car",cmpSame:"igual",cmpExplTitle:"Interpretaci√≥",any:"Qualsevol",btnCopy2:"Copiar",missingDataCmp:"Completa prov√≠ncia, m¬≤ i banys (m√≠nim 1).",aiWelcome:"üëã Hola! Soc el teu assessor financer personal. Conec el teu an√†lisi complet i estic aqu√≠ per ajudar-te. En qu√® et puc ajudar?",aiThinking:"Analitzant...",aiYou:"TU",aiPlaceholder:"Escriu la teva pregunta aqu√≠...",aiSend:"Enviar",aiSug1:"Qu√® puc fer per millorar la meva situaci√≥?",aiSug2:"Quant necessito estalviar mensualment per comprar?",aiSug3:"√âs millor comprar o llogar en el meu cas espec√≠fic?",aiSug4:"Quins municipis del Baix Pened√®s em recomanes?",aiSug5:"Com m'afectaria una pujada del tipus d'inter√®s?",aiSug6:"Dona'm estrat√®gies per augmentar la meva capacitat de compra",aiSugLbl1:"Com millorar?",aiSugLbl2:"Quant estalviar?",aiSugLbl3:"Comprar o llogar?",aiSugLbl4:"Quins municipis?",aiSugLbl5:"I si puja el tipus?",aiSugLbl6:"Estrat√®gies",aiErrAuth:"Error d'autenticaci√≥ amb l'API.",aiErrRate:"Massa peticions. Espera un moment.",aiErrNet:"Error en connectar. Torna-ho a intentar.",aiConnected:"Connectat",zoneLoadHint:"L√≠mits carregats localment (sense bloquejos CORS)."},
EN:{hdrTitle:"Housing Advisor ¬∑ Baix Pened√®s",hdrHint:"Real examples: only after Analyze.",tab1:"1 Personal",tab2:"2 Finance",tab3:"3 Preferences",tab4:"4 Result",tab5:"5 Comparator",tab6:"6 Real examples",tab7:"ü§ñ AI Advisor",lblName:"Full name",lblAge:"Age (18‚Äì100)",btnContinue:"Continue",hintP:"Fill in the basics to continue.",lblInc:"Monthly income (‚Ç¨)",lblSav:"Available savings (‚Ç¨)",lblYrs:"Mortgage years (5‚Äì40)",lblHor:"Living here > 5 years?",lblFst:"First home or family with minors?",lblMsv:"Monthly savings (‚Ç¨)",tipInc:"Net income (what actually hits your bank account).",tipSav:"Only what you can truly use.",tipMsv:"Used to estimate how long it takes to reach the needed cash.",hintE:"Complete finance and move to preferences.",lblMuni:"Town (Baix Pened√®s)",lblMuniHelp:"Use the map to pick multiple towns.",lblM2:"Square meters (‚â•50)",lblBed:"Bedrooms",lblBath:"Bathrooms",lblType:"Property type",optFlat:"Flat",optHouse:"House",lblExtras:"Extras (optional)",lblExtrasHint:"They change the price estimate and real-example filters.",exTer:"Terrace",exPis:"Pool",exAsc:"Elevator",exGar:"Parking",exSto:"Storage",exGarD:"Garden",exAir:"Air conditioning",btnAnalyze:"Analyze",btnMap:"Map (real area)",hintF:"If you change preferences, analyze again.",zoneTitle:"Preferred area (real map)",zoneHint:"Click a municipality to select it.",btnClear:"Clear",btnUse:"Use in Real examples",legSel:"Selected",legOk:"Real boundaries",kPrice:"Estimated price",kRent:"Estimated rent",kPay:"Mortgage payment",kRec:"Recommendation",btnCopy:"Copy summary",btnReset:"Reset",btnGoExamples:"Go to Real examples",btnAskAI:"üí¨ Ask AI",chartEffTitle:"Monthly effort (visual)",chartEffHint:"Line: safe capacity (35% of income). Bars: mortgage vs rent.",chartSensTitle:"Sensitivity (interest rate)",chartSensHint:"How payment changes if rates rise.",chartTipsTitle:"Quick read",lblProv:"Province (comparator)",lblM2s:"m¬≤",lblType2:"Type",btnCompare:"Compare",btnUseMine:"Use my data",lblExtras2:"Extras (comparator)",lblExtrasHint2:"Same features, different area.",cmpTitle:"Comparator result",cmpChartTitle:"Visual comparison",cmpChartHint:"Your area vs province. Same home, different context.",hintX:"If you chose multiple towns, you get buttons per town.",yes:"Yes",no:"No",recBuy:"BUY",recRent:"RENT",recNotFeasible:"NOT FEASIBLE",toastCheck:"Check name/age and ensure m¬≤/bathrooms are valid.",toastFirst:"Analyze first.",toastPrefs:"Preferences changed: analyze again.",toastNoLink:"Could not generate the link",toastCopied:"Copied",toastZoneCleared:"Area cleared",toastNoZone:"No towns selected",toastZoneApplied:"Area applied",stateReady:"‚úÖ Ready",stateNeed:"‚õî Please Analyze",xInfo:"Town: {muni} ¬∑ Status: {state}",sumTitle:"Summary ¬∑ {rec}",chipMort:"Mortgage effort: {pct}",chipRent:"Rent effort: {pct}",chipCash:"Cash needed: {eur}",chipRate:"Rate: {rate}",miniPrice:"Estimated price",miniPay:"Mortgage payment",miniRent:"Estimated rent",savingsOk:"‚úÖ Savings cover down payment + costs.",yearsToSave:"Saving {msv}/mo, you'll reach the goal in ~{yrs} years ({mos} months).",itpNote:"In Catalunya, purchase implies ~10% tax + notary/registry.",avgZone:"Average of {n} towns",stepPersonal:"Personal",stepEco:"Finance",stepPref:"Preferences",stepRes:"Result",cmpCheaper:"cheaper",cmpExpensive:"more expensive",cmpSame:"the same",cmpExplTitle:"Interpretation",any:"Any",btnCopy2:"Copy",missingDataCmp:"Complete province, m¬≤ and bathrooms (min 1).",aiWelcome:"üëã Hello! I'm your personal financial advisor. I know your full analysis and I'm here to help. What would you like to know?",aiThinking:"Analyzing...",aiYou:"YOU",aiPlaceholder:"Type your question here...",aiSend:"Send",aiSug1:"What can I do to improve my situation?",aiSug2:"How much do I need to save monthly to buy?",aiSug3:"Is it better to buy or rent in my specific case?",aiSug4:"Which towns in Baix Pened√®s do you recommend?",aiSug5:"How would a rate increase affect me?",aiSug6:"Give me strategies to increase my buying power",aiSugLbl1:"How to improve?",aiSugLbl2:"How much to save?",aiSugLbl3:"Buy or rent?",aiSugLbl4:"Which towns?",aiSugLbl5:"If rates rise?",aiSugLbl6:"Strategies",aiErrAuth:"Authentication error with the API.",aiErrRate:"Too many requests. Please wait.",aiErrNet:"Connection error. Please try again.",aiConnected:"Connected",zoneLoadHint:"Locally loaded boundaries (no CORS blocking)."}
};

let LANG=localStorage.getItem(LANG_KEY)||"ES";
const t=k=>(I18N[LANG]&&I18N[LANG][k])||I18N.ES[k]||k;
const tpl=(s,v)=>String(s||"").replace(/\{(\w+)\}/g,(_,k)=>(v&&v[k]!=null)?v[k]:"");
const fmtMoney=n=>!isFinite(n)?"‚Äì":((LANG==="EN"?fmtEN(n):fmtES(n))+" ‚Ç¨");
const fmtPct=n=>Number(n).toFixed(1)+"%";
const toast=m=>{const e=Q("#ts");e.textContent=m;e.classList.add("s");setTimeout(()=>e.classList.remove("s"),1900)};

const applyI18n=()=>{
  QA("[data-i]").forEach(el=>{const v=t(el.getAttribute("data-i"));if(v)el.textContent=v;});
  // Welcome bubble
  const wb=Q("#welcome-bubble");if(wb)wb.textContent=t("aiWelcome");
  // Input placeholder
  const ci=Q("#chatInput");if(ci)ci.placeholder=t("aiPlaceholder");
  // Send button
  const sb=Q("#chatSend");if(sb)sb.textContent=t("aiSend");
  // AI status chip
  const ais=Q("#aiStatus");if(ais)ais.textContent=t("aiConnected");
  const planBtn=Q("#aiPlanBtn");if(planBtn)planBtn.textContent=LANG==="EN"?"üß≠ Action plan":(LANG==="CA"?"üß≠ Pla d'acci√≥":"üß≠ Plan de acci√≥n");
  const clearBtn=Q("#aiClearBtn");if(clearBtn)clearBtn.textContent=LANG==="EN"?"üóëÔ∏è Clear chat":(LANG==="CA"?"üóëÔ∏è Netejar xat":"üóëÔ∏è Limpiar chat");
  const copyBtn=Q("#aiCopyBtn");if(copyBtn)copyBtn.textContent=LANG==="EN"?"üìã Copy chat":(LANG==="CA"?"üìã Copiar xat":"üìã Copiar chat");
  renderAISuggestions();
  renderAIContext();
};
const setLang=l=>{
  LANG=l;localStorage.setItem(LANG_KEY,l);
  document.documentElement.lang=l==="CA"?"ca":l==="ES"?"es":"en";
  Q("#L_CA").classList.toggle("a",l==="CA");
  Q("#L_ES").classList.toggle("a",l==="ES");
  Q("#L_EN").classList.toggle("a",l==="EN");
  applyI18n(); renderZoneUI(); renderResult(); refreshExamplesUI();
  updateSteps(Q("[data-p][style*='block']")?.getAttribute("data-p")||"p");
  liveValidate();
};

/* ============================
   PERSISTENCIA
   ============================ */
const FIELDS_NUM=["ag","inc","sav","yrs","msv","m2","bed","bat","cm2","cbd","cba"];
const FIELDS_SEL=["ar","ty","hor","fst","cm","cty"];
const FIELDS_CHK=["et","ep","el","ek","ct","cp0","cl0","ck0"];
const loadForm=()=>{try{const d=JSON.parse(localStorage.getItem(STORE_KEY)||"null");if(!d)return;FIELDS_NUM.forEach(id=>{if(d[id]!=null&&Q("#"+id))Q("#"+id).value=d[id];});FIELDS_SEL.forEach(id=>{if(d[id]!=null&&Q("#"+id))Q("#"+id).value=d[id];});FIELDS_CHK.forEach(id=>{if(Q("#"+id)&&d[id]!=null)Q("#"+id).checked=!!d[id];});if(d.nm&&Q("#nm"))Q("#nm").value=d.nm;}catch(e){}};
const saveForm=()=>{try{const d={};FIELDS_NUM.forEach(id=>{if(Q("#"+id))d[id]=Q("#"+id).value;});FIELDS_SEL.forEach(id=>{if(Q("#"+id))d[id]=Q("#"+id).value;});FIELDS_CHK.forEach(id=>{if(Q("#"+id))d[id]=Q("#"+id).checked?1:0;});if(Q("#nm"))d.nm=Q("#nm").value;localStorage.setItem(STORE_KEY,JSON.stringify(d));}catch(e){}};

/* ============================
   PASOS
   ============================ */
const updateSteps=p=>{
  const m={p:1,e:2,f:3,r:4,m:4,x:4,ai:4};
  const cur=m[p]||1;
  [1,2,3,4].forEach(i=>{const s=Q("#stp"+i);if(!s)return;s.classList.remove("active","done");if(i<cur)s.classList.add("done");else if(i===cur)s.classList.add("active");});
  [t("stepPersonal"),t("stepEco"),t("stepPref"),t("stepRes")].forEach((l,i)=>{const el=Q("#slbl"+(i+1));if(el)el.textContent=l;});
};
const show=p=>{
  QA("[data-p]").forEach(x=>x.style.display=x.getAttribute("data-p")===p?"block":"none");
  ["p","e","f","r","m","x","ai"].forEach(k=>Q("#t_"+k)?.classList.toggle("a",p===k));
  updateSteps(p);
  if(p==="m")setTimeout(upMap,100);
  if(p==="x")refreshExamplesUI();
  if(p==="ai")setTimeout(initChatUI,100);
  window.scrollTo({top:0,behavior:"smooth"});
};

/* ============================
   C√ÅLCULOS
   ============================ */
const mort=(c,r,y)=>{const m=r/12,n=y*12;return r===0?c/n:c*(m*Math.pow(1+m,n))/(Math.pow(1+m,n)-1);};
const COEF={"Cunit":{c:1.157,r:.975},"El Vendrell":{c:.912,r:.842},"Calafell":{c:.856,r:.983},"Santa Oliva":{c:.783,r:.825},"Bellvei":{c:.783,r:.925},"L'Arbo√ß":{c:.735,r:.883},"Banyeres del Pened√®s":{c:.614,r:.783},"Albinyana":{c:.766,r:.825},"Bonastre":{c:.497,r:.683},"Maslloren√ß":{c:.549,r:.75},"La Bisbal del Pened√®s":{c:.623,r:.808},"Lloren√ß del Pened√®s":{c:.856,r:.65},"Sant Jaume dels Domenys":{c:.614,r:.65},"El Montmell":{c:.529,r:.675}};
const BASE={m2:2000,rent:10,close:.11,rate:.0299};
const M={"Barcelona":{v:2986,l:21.9},"Girona":{v:2608,l:14.99},"Lleida":{v:1486,l:9.5},"Tarragona":{v:2100,l:13.5}};

const xBuy=(base,e)=>{let x=0;if(e.t)x+=base*.05;if(e.p)x+=base*.08;if(e.l)x+=base*.04;if(e.k)x+=base*.03;return x;};
const xRent=(base,e)=>{let x=0;if(e.t)x+=base*.15;if(e.p)x+=base*.30;if(e.l)x+=base*.08;if(e.k)x+=base*.07;return x;};
const buy=(a,m2,b,ba,e)=>{const base=m2*BASE.m2*(COEF[a]?.c||1),adj=b*5e3+ba*3e3;return Math.round(base+adj+xBuy(base,e));};
const rent=(a,m2,b,ba,e)=>{const base=m2*BASE.rent*(COEF[a]?.r||1),adj=b*50+ba*30;return Math.round(base+adj+xRent(base,e));};
const buyM=(m,m2,b,ba,e)=>{const p=M[m];if(!p)return NaN;const base=m2*p.v,adj=b*5e3+ba*3e3;return Math.round(base+adj+xBuy(base,e));};
const rentM=(m,m2,b,ba,e)=>{const p=M[m];if(!p)return NaN;const base=m2*p.l,adj=b*50+ba*30;return Math.round(base+adj+xRent(base,e));};

let last=null,lastReq=null,lastReqSig="";
const reqFromUI=()=>({muni:Q("#ar").value,type:Q("#ty").value,m2:+Q("#m2").value||null,bed:Q("#bed").value===""?null:+Q("#bed").value,bath:+Q("#bat").value||null,ex:{t:Q("#et").checked?1:0,p:Q("#ep").checked?1:0,l:Q("#el").checked?1:0,k:Q("#ek").checked?1:0}});
const sigOfReq=r=>[r.muni,r.type,r.m2,r.bed,r.bath,r.ex.t,r.ex.p,r.ex.l,r.ex.k].join("|");
const prefsChanged=()=>!lastReq||sigOfReq(reqFromUI())!==lastReqSig;
const setTabsEnabled=()=>["#t_r","#t_m","#t_x","#t_ai"].forEach(id=>Q(id)?.classList.toggle("dis",!lastReq));

const typeLabel=ty=>ty==="flat"?t("optFlat"):t("optHouse");
const muniLabel=muni=>{if(muni==="*")return t("any");if(muni==="__multi__")return[...zoneSel].join(", ");return muni;};

/* ============================
   CANVAS CHARTS
   ============================ */
const dpr=()=>window.devicePixelRatio||1;
const setupCanvas=cv=>{const r=dpr(),rect=cv.getBoundingClientRect();cv.width=Math.max(320,Math.round(rect.width*r));cv.height=Math.max(220,Math.round(rect.height*r));const ctx=cv.getContext("2d");ctx.setTransform(r,0,0,r,0,0);return ctx;};
const clearGrid=(ctx,w,h)=>{ctx.clearRect(0,0,w,h);ctx.globalAlpha=1;ctx.lineWidth=1;ctx.strokeStyle="rgba(148,163,184,.12)";for(let i=0;i<6;i++){const y=14+i*(h-28)/5;ctx.beginPath();ctx.moveTo(12,y);ctx.lineTo(w-12,y);ctx.stroke();}};
const drawTxt=(ctx,txt,x,y,sz,clr,align)=>{ctx.fillStyle=clr||"#cbd5e1";ctx.font=`${sz||12}px system-ui,sans-serif`;ctx.textAlign=align||"left";ctx.fillText(txt,x,y);};

const drawEffortChart=()=>{
  if(!last)return;const cv=Q("#effChart");if(!cv)return;
  const ctx=setupCanvas(cv);const w=cv.clientWidth,h=cv.clientHeight;clearGrid(ctx,w,h);
  const safe=last.inc*.35,buyV=last.pay,rentV=last.pr,maxV=Math.max(safe,buyV,rentV)*1.15||1;
  const pL=12,pR=12,pT=18,pB=26,pW=w-pL-pR,pH=h-pT-pB;
  const ySafe=pT+pH*(1-(safe/maxV));
  ctx.strokeStyle="rgba(56,189,248,.90)";ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(pL,ySafe);ctx.lineTo(w-pR,ySafe);ctx.stroke();
  drawTxt(ctx,(LANG==="EN"?"Safe ":"Cap.segura ")+fmtMoney(safe),pL+6,ySafe-6,11,"#7dd3fc","left");
  const bW=Math.min(100,pW/4);
  const bar=(x,val,lbl,fill,tc)=>{const bh=pH*(val/maxV);const y=pT+pH-bh;ctx.fillStyle=fill;ctx.globalAlpha=.92;ctx.fillRect(x,y,bW,bh);ctx.globalAlpha=1;ctx.strokeStyle="rgba(255,255,255,.12)";ctx.strokeRect(x,y,bW,bh);drawTxt(ctx,lbl,x+bW/2,pT+pH+18,12,"#cbd5e1","center");drawTxt(ctx,fmtMoney(val),x+bW/2,y-6,12,tc,"center");};
  bar(pL+pW*.3-bW/2,buyV,LANG==="EN"?"BUY":"COMPRA","rgba(34,197,94,.60)","#86efac");
  bar(pL+pW*.65-bW/2,rentV,LANG==="EN"?"RENT":"ALQUILER","rgba(245,158,11,.58)","#fde68a");
};

const drawSensChart=()=>{
  if(!last)return;const cv=Q("#sensChart");if(!cv)return;
  const ctx=setupCanvas(cv);const w=cv.clientWidth,h=cv.clientHeight;clearGrid(ctx,w,h);
  const pL=12,pR=12,pT=18,pB=26,pW=w-pL-pR,pH=h-pT-pB;
  const pts=[];for(let i=0;i<=4;i++){const r=last.rate+i*.005;pts.push({r,p:mort(last.cap,r,last.yrs)});}
  const maxP=Math.max(...pts.map(x=>x.p))*1.10||1,minP=Math.min(...pts.map(x=>x.p))*.90||0;
  drawTxt(ctx,LANG==="EN"?"Rate +0.5% steps":"Tipo +0,5%",pL,h-8,11,"rgba(148,163,184,.95)","left");
  ctx.strokeStyle="rgba(56,189,248,.92)";ctx.lineWidth=2;ctx.beginPath();
  pts.forEach((pt,i)=>{const x=pL+pW*(i/(pts.length-1));const y=pT+pH*(1-((pt.p-minP)/(maxP-minP||1)));if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke();
  pts.forEach((pt,i)=>{const x=pL+pW*(i/(pts.length-1));const y=pT+pH*(1-((pt.p-minP)/(maxP-minP||1)));ctx.fillStyle="rgba(125,211,252,1)";ctx.beginPath();ctx.arc(x,y,3.5,0,Math.PI*2);ctx.fill();if(i===pts.length-1)drawTxt(ctx,fmtMoney(pt.p),x-4,y-10,12,"#7dd3fc","right");});
  const delta=pts[pts.length-1].p-pts[0].p;drawTxt(ctx,(delta>=0?"+":"")+fmtMoney(delta)+" @ +2%",w-12,h-8,12,"#fde68a","right");
};

const drawCmpChart=(your,prov)=>{
  const cv=Q("#cmpChart");if(!cv)return;
  const ctx=setupCanvas(cv);const w=cv.clientWidth,h=cv.clientHeight;clearGrid(ctx,w,h);
  const pL=12,pR=12,pT=18,pB=26,pW=w-pL-pR,pH=h-pT-pB,maxV=Math.max(your,prov)*1.15||1;
  const bW=Math.min(140,pW/3);
  const bar=(x,val,lbl,fill,tc)=>{const bh=pH*(val/maxV);const y=pT+pH-bh;ctx.fillStyle=fill;ctx.globalAlpha=.92;ctx.fillRect(x,y,bW,bh);ctx.globalAlpha=1;drawTxt(ctx,lbl,x+bW/2,pT+pH+18,12,"#cbd5e1","center");drawTxt(ctx,fmtMoney(val),x+bW/2,y-6,12,tc,"center");};
  bar(pL+pW*.30-bW/2,your,LANG==="EN"?"Your area":"Tu zona","rgba(56,189,248,.45)","#7dd3fc");
  bar(pL+pW*.68-bW/2,prov,LANG==="EN"?"Province":"Provincia","rgba(168,85,247,.40)","#e9d5ff");
};

/* ============================
   ANALIZAR
   ============================ */
const analyze=()=>{
  const nm=(Q("#nm").value||"").trim(),ag=+Q("#ag").value||0,inc=+Q("#inc").value||0,sav=+Q("#sav").value||0;
  const yrs=+Q("#yrs").value||25,hor=Q("#hor").value==="y",fst=Q("#fst").value==="y";
  const ar=Q("#ar").value,m2=+Q("#m2").value||0,bd=Q("#bed").value===""?0:+Q("#bed").value||0,ba=+Q("#bat").value||0,type=Q("#ty").value;
  if(!nm||ag<18||ag>100||m2<50||ba<1){toast(t("toastCheck"));return;}
  const e={t:Q("#et").checked,p:Q("#ep").checked,l:Q("#el").checked,k:Q("#ek").checked};

  let pb,pr,pbRange=null,prRange=null,muniList=[];
  if((ar==="*"||ar==="__multi__")&&zoneSel.size>1){
    muniList=[...zoneSel];
    const buys=muniList.map(m=>buy(m,m2,Math.max(0,bd),ba,e));
    const rents=muniList.map(m=>rent(m,m2,Math.max(0,bd),ba,e));
    pb=Math.round(buys.reduce((a,b)=>a+b,0)/buys.length);
    pr=Math.round(rents.reduce((a,b)=>a+b,0)/rents.length);
    pbRange={lo:Math.min(...buys),hi:Math.max(...buys)};
    prRange={lo:Math.min(...rents),hi:Math.max(...rents)};
  }else{
    const baseM=(ar==="__multi__"&&zoneSel.size===1)?[...zoneSel][0]:(ar==="*"?"Cunit":ar);
    muniList=[baseM];pb=buy(baseM,m2,Math.max(0,bd),ba,e);pr=rent(baseM,m2,Math.max(0,bd),ba,e);
  }

  const dp=fst?.1:.2,down=pb*dp,cl=pb*BASE.close,cap=Math.max(0,pb-down);
  const needCash=Math.round(down+cl);
  let rate=BASE.rate;if(sav<needCash)rate+=.006;
  const pay=mort(cap,rate,yrs);
  const ratio=inc>0?(pay/inc)*100:1e9,rri=inc>0?(pr/inc)*100:1e9;
  const need=sav<needCash,ratioOK=isFinite(ratio)&&ratio<=35,rentOK=isFinite(rri)&&rri<=40;
  const recCode=(!need&&ratioOK&&hor)?"BUY":(rentOK?"RENT":"NOT_FEASIBLE");
  const rec=recCode==="BUY"?t("recBuy"):recCode==="RENT"?t("recRent"):t("recNotFeasible");

  last={nm,muni:ar,m2,bd:Math.max(0,bd),ba,type,pb,pr,pbRange,prRange,muniList,cap,rate,yrs,dp,sav,down,cl,pay,ratio,rri,rec,recCode,e,need,hor,inc,msv:+Q("#msv").value||0,needCash};
  lastReq=reqFromUI();lastReqSig=sigOfReq(lastReq);

  Q("#k1").textContent=fmtMoney(pb);Q("#k2").textContent=fmtMoney(pr);Q("#k3").textContent=fmtMoney(pay);Q("#k4").textContent=rec;
  const pm2=m2>0?Math.round(pb/m2):0;
  Q("#k1sub").textContent=pm2?(pm2.toLocaleString(LANG==="EN"?"en-US":"es-ES")+" ‚Ç¨/m¬≤"):"";
  Q("#k2sub").textContent=LANG==="EN"?"Monthly estimate":"Estimaci√≥n mensual";
  Q("#k3sub").textContent=`${yrs} ${LANG==="EN"?"years":"a√±os"} ¬∑ ${(rate*100).toFixed(2)}%`;
  Q("#k4sub").textContent=recCode==="BUY"?(LANG==="EN"?"You fit cash + effort":"Encajas cash + esfuerzo"):recCode==="RENT"?(LANG==="EN"?"Buying is tight":"Comprar aprieta"):(LANG==="EN"?"Neither option fits safely":"No encaja con seguridad");

  renderResult();renderAIContext();renderAISuggestions();setTabsEnabled();saveForm();show("r");
  setTimeout(()=>{drawEffortChart();drawSensChart();},120);
};

/* ============================
   RENDER RESULTADO
   ============================ */
const renderResult=()=>{
  if(!last)return;
  const dti=isFinite(last.ratio)?last.ratio:999,rti=isFinite(last.rri)?last.rri:999;
  const clsDTI=dti<=30?"good":dti<=35?"warn":"bad";
  const clsRTI=rti<=35?"good":rti<=40?"warn":"bad";
  const clsCash=last.need?"bad":"good";
  const clsRate=last.rate>BASE.rate?"warn":"neu";

  Q("#rCard").style.display="block";
  Q("#rTitle").textContent=tpl(t("sumTitle"),{rec:last.rec});
  Q("#rChips").innerHTML=
    `<span class="chip ${clsDTI}">${tpl(t("chipMort"),{pct:fmtPct(dti)})}</span>`+
    `<span class="chip ${clsRTI}">${tpl(t("chipRent"),{pct:fmtPct(rti)})}</span>`+
    `<span class="chip ${clsCash}">${tpl(t("chipCash"),{eur:fmtMoney(last.needCash)})}</span>`+
    `<span class="chip ${clsRate}">${tpl(t("chipRate"),{rate:(last.rate*100).toFixed(2)+"%"})}</span>`;

  const isMulti=last.muniList&&last.muniList.length>1;
  const multiLbl=isMulti?`<div style='font-size:.72rem;color:#7dd3fc;margin-top:3px'>${tpl(t("avgZone"),{n:last.muniList.length})}</div>`:"";
  const pbRng=isMulti&&last.pbRange?`<div class='range-bar'><span class='range-tag lo'>‚Üì ${fmtMoney(last.pbRange.lo)}</span><span class='range-tag hi'>‚Üë ${fmtMoney(last.pbRange.hi)}</span></div>`:"";
  const prRng=isMulti&&last.prRange?`<div class='range-bar'><span class='range-tag lo'>‚Üì ${fmtMoney(last.prRange.lo)}</span><span class='range-tag hi'>‚Üë ${fmtMoney(last.prRange.hi)}</span></div>`:"";
  const pm2=last.m2>0?Math.round(last.pb/last.m2):0;

  Q("#rMini").innerHTML=
    `<div class="mini"><div class="h">${t("miniPrice")}</div><div class="v">${fmtMoney(last.pb)}</div>${multiLbl}${pbRng}<div style='font-size:.75rem;color:#64748b;margin-top:4px'>${pm2.toLocaleString(LANG==="EN"?"en-US":"es-ES")} ‚Ç¨/m¬≤</div></div>`+
    `<div class="mini"><div class="h">${t("miniPay")}</div><div class="v">${fmtMoney(last.pay)}</div><div style='font-size:.75rem;color:#64748b;margin-top:4px'>${last.yrs} ${LANG==="EN"?"years":"a√±os"} ¬∑ ${(last.rate*100).toFixed(2)}%</div></div>`+
    `<div class="mini"><div class="h">${t("miniRent")}</div><div class="v">${fmtMoney(last.pr)}</div>${prRng}</div>`;

  const safe=last.inc*.35;
  const why=[];
  if(last.recCode==="BUY"){why.push(LANG==="EN"?"Savings cover down payment + costs":"Ahorros cubren entrada + costes");why.push(LANG==="EN"?"Mortgage effort within recommended band":"Esfuerzo hipoteca en banda recomendada");if(last.hor)why.push(LANG==="EN"?"Staying >5 years helps amortize costs":"Horizonte >5 a√±os ayuda a amortizar costes");}
  else if(last.recCode==="RENT"){if(last.need)why.push((LANG==="EN"?"Short on cash":"Falta cash")+": "+fmtMoney(last.needCash-last.sav));if(dti>35)why.push((LANG==="EN"?"Mortgage effort high":"Esfuerzo hipoteca alto")+": "+fmtPct(dti));if(!last.hor)why.push(LANG==="EN"?"Short horizon: buying less efficient":"Horizonte corto: comprar menos eficiente");why.push(LANG==="EN"?"Rent closer to a safer monthly load":"Alquiler m√°s cerca de carga mensual segura");}
  else{if(last.need)why.push(LANG==="EN"?"Not enough cash for down payment + costs":"No hay cash suficiente para entrada + costes");if(dti>35)why.push((LANG==="EN"?"Mortgage effort exceeds limit":"Esfuerzo hipoteca supera l√≠mite")+": "+fmtPct(dti));if(rti>40)why.push((LANG==="EN"?"Rent effort also exceeds limit":"Esfuerzo alquiler tambi√©n supera l√≠mite")+": "+fmtPct(rti));}

  Q("#chartTips").textContent=(LANG==="EN"?"Safe ":"Cap.segura ")+fmtMoney(safe)+" ¬∑ "+(LANG==="EN"?"Mortgage ":"Hip. ")+fmtMoney(last.pay)+" ¬∑ "+(LANG==="EN"?"Rent ":"Alq. ")+fmtMoney(last.pr);
  const blockClr=last.recCode==="BUY"?"#22c55e":last.recCode==="RENT"?"#f59e0b":"#ef4444";
  Q("#quickExplain").innerHTML=`<div style="font-weight:950;color:#e5e7eb;margin-bottom:8px">${t("cmpExplTitle")}</div><div style="display:grid;gap:6px">${why.map(x=>`<div>‚Ä¢ ${x}</div>`).join("")}</div>`;

  const muniTxt=muniLabel(last.muni),typeTxt=typeLabel(last.type),dpPct=Math.round(last.dp*100);
  const extrasOn=[];
  if(last.e.t)extrasOn.push(t("exTer"));if(last.e.p)extrasOn.push(t("exPis"));if(last.e.l)extrasOn.push(t("exAsc"));if(last.e.k)extrasOn.push(t("exGar"));

  let body=`<div style='display:grid;gap:16px'>
    <div style="background:linear-gradient(135deg,rgba(56,189,248,.08),rgba(14,165,233,.05));padding:16px;border-radius:14px;border-left:4px solid ${blockClr}">
      <div style="font-size:1.05rem;font-weight:1000;color:#f1f5f9;margin-bottom:10px">${last.rec}</div>
      <div style="color:#cbd5e1;line-height:1.75;font-size:.93rem">${why.map(x=>`<div style="margin-bottom:6px">‚Ä¢ ${x}</div>`).join("")}</div>
    </div>
    <div>
      <div style="font-size:1rem;font-weight:950;color:#38bdf8;margin-bottom:8px">üìç ${LANG==="EN"?"Preferences":(LANG==="CA"?"Prefer√®ncies":"Preferencias")}</div>
      <div style="margin-left:18px;color:#cbd5e1;line-height:1.7">
        <div><b>${muniTxt}</b> ¬∑ ${last.m2} m¬≤ ¬∑ ${last.bd||0} hab ¬∑ ${last.ba} ba√±os ¬∑ ${typeTxt}</div>
        <div style="color:#94a3b8;margin-top:6px">${extrasOn.length?(LANG==="EN"?"Extras: ":"Extras: ")+extrasOn.join(", "):(LANG==="EN"?"Extras: none":"Extras: ninguno")}</div>
      </div>
    </div>
    <div>
      <div style="font-size:1rem;font-weight:950;color:#38bdf8;margin-bottom:8px">üí∞ ${LANG==="EN"?"Financing":(LANG==="CA"?"Finan√ßament":"Financiaci√≥n")}</div>
      <div style="margin-left:18px;color:#cbd5e1;line-height:1.75">
        <div>${LANG==="EN"?"Down payment":"Entrada"}: ${dpPct}% ‚Üí <b>${fmtMoney(last.down)}</b></div>
        <div>${LANG==="EN"?"Closing costs":"Gastos"}: <b>${fmtMoney(last.cl)}</b></div>
        <div>${LANG==="EN"?"To finance":"A financiar"}: <b>${fmtMoney(last.cap)}</b> (${last.yrs} ${LANG==="EN"?"years":"a√±os"} @ ${(last.rate*100).toFixed(2)}%)</div>
      </div>
    </div>
    <div>
      <div style="font-size:1rem;font-weight:950;color:#38bdf8;margin-bottom:10px">üìä ${LANG==="EN"?"Monthly effort":"Esfuerzo mensual"}</div>
      <div style="display:grid;gap:14px">
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
            <span style="color:#94a3b8;font-size:.85rem;font-weight:900">${LANG==="EN"?"Mortgage effort":"Esfuerzo hipoteca"}</span>
            <span style="font-weight:1000;color:#f1f5f9">${fmtPct(dti)} ${dti<=30?"‚úÖ":dti<=35?"‚ö†Ô∏è":"‚ùå"}</span>
          </div>
          <div class="pbar-wrap"><div class="pbar ${clsDTI}" style="width:${Math.min(100,dti).toFixed(1)}%"></div></div>
          <div style="font-size:.75rem;color:#64748b;margin-top:3px">${LANG==="EN"?"Recommended limit: 35%":"L√≠mite recomendado: 35%"}</div>
        </div>
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
            <span style="color:#94a3b8;font-size:.85rem;font-weight:900">${LANG==="EN"?"Rent effort":"Esfuerzo alquiler"}</span>
            <span style="font-weight:1000;color:#f1f5f9">${fmtPct(rti)} ${rti<=35?"‚úÖ":rti<=40?"‚ö†Ô∏è":"‚ùå"}</span>
          </div>
          <div class="pbar-wrap"><div class="pbar ${clsRTI}" style="width:${Math.min(100,rti).toFixed(1)}%"></div></div>
          <div style="font-size:.75rem;color:#64748b;margin-top:3px">${LANG==="EN"?"Recommended limit: 40%":"L√≠mite recomendado: 40%"}</div>
        </div>
      </div>
    </div>
    <div style="padding:12px 14px;background:rgba(99,102,241,.08);border:1px solid rgba(99,102,241,.25);border-radius:12px;border-left:4px solid #818cf8;color:#c7d2fe;font-size:.85rem;line-height:1.6">‚ÑπÔ∏è ${t("itpNote")}</div>`;

  if(last.need){
    const missing=Math.max(0,last.needCash-last.sav);
    if(last.msv>0&&missing>0){const mos=Math.ceil(missing/last.msv);body+=`<div class="countdown">‚è≥ ${tpl(t("yearsToSave"),{msv:fmtMoney(last.msv),yrs:(mos/12).toFixed(1),mos})}</div>`;}
    else body+=`<div class="countdown">‚ö†Ô∏è ${LANG==="EN"?"Short on cash for buying":"Falta cash para comprar"} (${fmtMoney(missing)})</div>`;
  }else{body+=`<div class="countdown" style="background:rgba(34,197,94,.08);border-color:rgba(34,197,94,.25);border-left-color:#22c55e;color:#86efac">${t("savingsOk")}</div>`;}
  body+="</div>";
  Q("#rBody").innerHTML=body;

  Q("#rt").textContent=[
    `Hola ${last.nm},`,
    `Precio estimado: ${fmtMoney(last.pb)}`,
    `Vivienda: ${muniTxt} ¬∑ ${last.m2}m¬≤ ¬∑ ${last.bd||0}hab ¬∑ ${last.ba}ba√±os ¬∑ ${typeTxt}`,
    `Entrada: ${dpPct}% (${fmtMoney(last.down)}) + Gastos: ${fmtMoney(last.cl)}`,
    `A financiar: ${fmtMoney(last.cap)} en ${last.yrs} a√±os al ${(last.rate*100).toFixed(2)}%`,
    `Cuota: ${fmtMoney(last.pay)} | Alquiler: ${fmtMoney(last.pr)}`,
    `Recomendaci√≥n: ${last.rec}`
  ].join("\n");

  setTimeout(()=>{drawEffortChart();drawSensChart();},70);
};

/* ============================
   MAPA COMPARADOR
   ============================ */
let cmap=null;
const PROV_COORDS={"Barcelona":[41.3874,2.1686],"Girona":[41.9794,2.8214],"Lleida":[41.6176,0.6200],"Tarragona":[41.1189,1.2445]};
const upMap=()=>{
  const m=Q("#cm").value||"Barcelona",coords=PROV_COORDS[m]||[41.3874,2.1686];
  if(!cmap){cmap=L.map("cmap").setView(coords,11);L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{maxZoom:19,attribution:"¬© OpenStreetMap ¬∑ ¬© CARTO",subdomains:"abcd"}).addTo(cmap);L.marker(coords).addTo(cmap).bindPopup(m);setTimeout(()=>cmap.invalidateSize(),200);}
  else{cmap.setView(coords,11);cmap.eachLayer(l=>{if(l instanceof L.Marker)cmap.removeLayer(l);});L.marker(coords).addTo(cmap).bindPopup(m);setTimeout(()=>cmap.invalidateSize(),120);}
};

/* ============================
   COMPARAR
   ============================ */
const compare=()=>{
  if(!last){Q("#cmg").textContent=t("toastFirst");return;}
  const m=Q("#cm").value,m2=+Q("#cm2").value||0,bd=+Q("#cbd").value||0,ba=+Q("#cba").value||0;
  const e={t:Q("#ct").checked,p:Q("#cp0").checked,l:Q("#cl0").checked,k:Q("#ck0").checked};
  if(!M[m]||!(m2>0&&ba>0)){Q("#cmg").textContent=t("missingDataCmp");Q("#cmpChips").innerHTML="";return;}
  const p2=buyM(m,m2,Math.max(0,bd),ba,e),r2=rentM(m,m2,Math.max(0,bd),ba,e);
  const d=p2-last.pb,pct=last.pb>0?(d/last.pb)*100:0;
  const cls=d>0?"bad":d<0?"good":"neu",arrow=d>0?"‚Üë":d<0?"‚Üì":"‚Üí",sign=d>0?"+":"";
  const direction=d>0?t("cmpExpensive"):d<0?t("cmpCheaper"):t("cmpSame");
  Q("#cmpChips").innerHTML=`<span class="chip ${cls}">${arrow} ${sign}${fmtMoney(d)}</span><span class="chip ${cls}">${sign}${pct.toFixed(1)}%</span><span class="chip neu">${fmtMoney(p2)}</span><span class="chip neu">${fmtMoney(r2)} /mes</span>`;
  Q("#cmg").innerHTML=`<div style="display:grid;gap:10px">
    <div><b>${m}</b> ¬∑ ${m2}m¬≤ ¬∑ ${bd}hab ¬∑ ${ba}ba√±os</div>
    <div style="color:#cbd5e1;line-height:1.7">
      <div>‚Ä¢ ${LANG==="EN"?"Price in province":"Precio en provincia"}: <b>${fmtMoney(p2)}</b></div>
      <div>‚Ä¢ ${LANG==="EN"?"Price in your area":"Precio en tu zona"}: <b>${fmtMoney(last.pb)}</b></div>
      <div>‚Ä¢ ${LANG==="EN"?"Difference":"Diferencia"}: <b>${sign}${fmtMoney(d)}</b> (${sign}${pct.toFixed(1)}%, ${direction})</div>
      <div>‚Ä¢ ${LANG==="EN"?"Rent in province":"Alquiler en provincia"}: <b>${fmtMoney(r2)}</b></div>
      <div>‚Ä¢ ${LANG==="EN"?"Rent in your area":"Alquiler en tu zona"}: <b>${fmtMoney(last.pr)}</b></div>
    </div>
  </div>`;
  drawCmpChart(last.pb,p2);upMap();saveForm();
};

const fillFromLast=()=>{
  if(!last){toast(t("toastFirst"));return;}
  Q("#cm2").value=last.m2||"";Q("#cbd").value=last.bd||"";Q("#cba").value=last.ba||"";Q("#cty").value=last.type||"flat";
  Q("#ct").checked=!!last.e?.t;Q("#cp0").checked=!!last.e?.p;Q("#cl0").checked=!!last.e?.l;Q("#ck0").checked=!!last.e?.k;
  saveForm();toast(t("toastCopied"));
};

/* ============================
   MAPA MUNICIPAL
   ============================ */
let zmap=null,zReady=false,zoneSel=new Set(),polygonsByName=new Map();
const loadZoneSel=()=>{try{const s=localStorage.getItem(ZONE_KEY);if(s)zoneSel=new Set(JSON.parse(s)||[]);}catch(e){}};
const saveZoneSel=()=>localStorage.setItem(ZONE_KEY,JSON.stringify([...zoneSel]));
const renderZoneUI=()=>{
  const sel=zoneSel.size?[...zoneSel].join(", "):(LANG==="EN"?"none":(LANG==="CA"?"cap":"ninguno"));
  Q("#zoneNote").textContent=(LANG==="EN"?"Selected: ":(LANG==="CA"?"Seleccionats: ":"Seleccionados: "))+sel;
  Q("#zoneApplied").textContent=zoneSel.size?((LANG==="EN"?"Active: ":(LANG==="CA"?"Actius: ":"Activos: "))+[...zoneSel].join(", ")):"";
  const zc=Q("#zoneChips");
  zc.innerHTML=zoneSel.size?[...zoneSel].map(z=>`<span class="pchip on" data-z="${z}">${z}</span>`).join(""):`<span class="pchip off">${LANG==="EN"?"No selection":"Sin selecci√≥n"}</span>`;
  zc.querySelectorAll("[data-z]").forEach(ch=>ch.addEventListener("click",()=>toggleZone(ch.getAttribute("data-z"),true)));
};
const applyPolygonState=name=>{
  const poly=polygonsByName.get(name),on=zoneSel.has(name);
  if(poly)poly.setStyle({
    fillColor:on?"#38bdf8":"#4ade80",fillOpacity:on?.35:.10,
    color:on?"#0ea5e9":"#16a34a",weight:on?2.5:1.5,opacity:on?1:.70
  });
};
const toggleZone=(name,fromChip)=>{
  zoneSel.has(name)?zoneSel.delete(name):zoneSel.add(name);
  applyPolygonState(name);renderZoneUI();
  if(!fromChip)saveZoneSel();
};
const initMap=()=>{
  if(zReady)return;zReady=true;
  zmap=L.map("zmap",{scrollWheelZoom:false,tap:true,zoomControl:true}).setView([41.22,1.54],11);
  // Tile m√°s est√©tico: CartoDB Positron (gris suave, sin ruido visual)
  L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{
    maxZoom:19,attribution:'¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> ¬∑ ¬© <a href="https://carto.com/">CARTO</a>',
    subdomains:"abcd"
  }).addTo(zmap);
  renderZoneUI();
  // Carga local de pol√≠gonos (evita CORS/429 en GitHub Pages y funciona offline parcial)
  let loaded=0;const total=MUNI_NAMES.length;
  const mapContainer=document.querySelector("#zmap");
  const loader=document.createElement("div");
  loader.id="zmapLoader";
  loader.style.cssText="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(2,6,23,.92);color:#7dd3fc;padding:14px 22px;border-radius:14px;border:1px solid rgba(56,189,248,.40);font-size:.9rem;font-weight:800;z-index:1000;pointer-events:none;backdrop-filter:blur(8px);box-shadow:0 8px 24px rgba(0,0,0,.5)";
  loader.textContent=LANG==="EN"?"Loading local boundaries...":LANG==="CA"?"Carregant l√≠mits locals...":"Cargando l√≠mites locales...";
  if(mapContainer){mapContainer.style.position="relative";mapContainer.appendChild(loader);}

  const onDone=()=>{
    loaded++;
    if(loader)loader.textContent=(LANG==="EN"?`Loading... ${loaded}/${total}`:LANG==="CA"?`Carregant... ${loaded}/${total}`:`Cargando... ${loaded}/${total}`);
    if(loaded>=total){
      if(loader)loader.remove();
      try{
        const allLayers=[];polygonsByName.forEach(p=>allLayers.push(p));
        if(allLayers.length){
          const group=L.featureGroup(allLayers);
          zmap.fitBounds(group.getBounds(),{padding:[20,20]});
        }
      }catch(e){}
      setTimeout(()=>zmap.invalidateSize(),160);
    }
  };

  MUNI_NAMES.forEach(name=>{
    const fb=FALLBACK_POLYGONS[name];
    if(fb){
      const on=zoneSel.has(name);
      const style={fillColor:on?"#38bdf8":"#4ade80",fillOpacity:on?.35:.10,
                   color:on?"#0ea5e9":"#16a34a",weight:on?2.5:1.5,opacity:on?1:.70};
      const layer=L.polygon(fb,style).addTo(zmap);
      layer.bindTooltip(name,{permanent:false,direction:"center",opacity:.95,className:"muni-tooltip"});
      layer.on("mouseover",function(){if(!zoneSel.has(name))this.setStyle({fillOpacity:.22,fillColor:"#86efac"});});
      layer.on("mouseout",function(){if(!zoneSel.has(name))this.setStyle({fillOpacity:.10,fillColor:"#4ade80"});});
      layer.on("click",()=>toggleZone(name,false));
      polygonsByName.set(name,layer);
    }
    onDone();
  });
  setTimeout(()=>zmap.invalidateSize(),200);
};

// Pol√≠gonos de respaldo (fallback) si Nominatim no est√° disponible
const FALLBACK_POLYGONS={
  "El Vendrell":[[41.222,1.531],[41.231,1.545],[41.234,1.558],[41.228,1.571],[41.215,1.576],[41.203,1.570],[41.196,1.553],[41.198,1.537],[41.208,1.524],[41.222,1.531]],
  "Calafell":[[41.192,1.552],[41.203,1.558],[41.212,1.574],[41.213,1.592],[41.206,1.608],[41.193,1.614],[41.181,1.606],[41.176,1.589],[41.179,1.568],[41.186,1.554],[41.192,1.552]],
  "Cunit":[[41.199,1.620],[41.207,1.628],[41.214,1.642],[41.212,1.654],[41.202,1.659],[41.194,1.653],[41.189,1.639],[41.191,1.624],[41.199,1.620]],
  "Bellvei":[[41.215,1.559],[41.224,1.564],[41.231,1.578],[41.230,1.593],[41.221,1.602],[41.209,1.604],[41.199,1.595],[41.197,1.579],[41.205,1.566],[41.215,1.559]],
  "Santa Oliva":[[41.240,1.521],[41.252,1.530],[41.259,1.547],[41.257,1.563],[41.246,1.573],[41.233,1.570],[41.226,1.554],[41.230,1.538],[41.240,1.521]],
  "Albinyana":[[41.231,1.490],[41.244,1.499],[41.251,1.514],[41.249,1.528],[41.238,1.538],[41.224,1.535],[41.216,1.520],[41.218,1.503],[41.231,1.490]],
  "L'Arbo√ß":[[41.259,1.594],[41.272,1.604],[41.278,1.619],[41.273,1.635],[41.261,1.641],[41.249,1.633],[41.244,1.617],[41.249,1.601],[41.259,1.594]],
  "Lloren√ß del Pened√®s":[[41.271,1.564],[41.283,1.573],[41.290,1.588],[41.288,1.602],[41.277,1.610],[41.264,1.607],[41.258,1.592],[41.261,1.577],[41.271,1.564]],
  "Banyeres del Pened√®s":[[41.286,1.576],[41.298,1.583],[41.306,1.597],[41.303,1.612],[41.291,1.619],[41.278,1.615],[41.272,1.600],[41.276,1.583],[41.286,1.576]],
  "Sant Jaume dels Domenys":[[41.299,1.561],[41.313,1.570],[41.320,1.588],[41.317,1.605],[41.303,1.613],[41.290,1.608],[41.283,1.591],[41.287,1.573],[41.299,1.561]],
  "La Bisbal del Pened√®s":[[41.268,1.482],[41.282,1.492],[41.290,1.509],[41.287,1.525],[41.273,1.534],[41.259,1.528],[41.253,1.511],[41.257,1.494],[41.268,1.482]],
  "Bonastre":[[41.214,1.432],[41.227,1.441],[41.233,1.458],[41.229,1.473],[41.215,1.480],[41.203,1.471],[41.198,1.453],[41.205,1.437],[41.214,1.432]],
  "Maslloren√ß":[[41.259,1.409],[41.275,1.419],[41.282,1.436],[41.278,1.452],[41.264,1.460],[41.250,1.452],[41.244,1.434],[41.250,1.416],[41.259,1.409]],
  "El Montmell":[[41.293,1.448],[41.311,1.462],[41.319,1.483],[41.314,1.502],[41.296,1.513],[41.278,1.505],[41.271,1.483],[41.278,1.462],[41.293,1.448]]
};
const MUNI_SLUG={"Cunit":"cunit-tarragona","El Vendrell":"el-vendrell-tarragona","Calafell":"calafell-tarragona","Santa Oliva":"santa-oliva-tarragona","Bellvei":"bellvei-tarragona","L'Arbo√ß":"l-arboc-tarragona","Banyeres del Pened√®s":"banyeres-del-penedes-tarragona","Albinyana":"albinyana-tarragona","Bonastre":"bonastre-tarragona","Maslloren√ß":"masllorenc-tarragona","La Bisbal del Pened√®s":"la-bisbal-del-penedes-tarragona","Lloren√ß del Pened√®s":"llorenc-del-penedes-tarragona","Sant Jaume dels Domenys":"sant-jaume-dels-domenys-tarragona","El Montmell":"el-montmell-tarragona"};
const bedSlug=n=>{n=+n||0;if(n<=0)return"estudios";if(n===1)return"de-un-dormitorio";if(n===2)return"de-dos-dormitorios";if(n===3)return"de-tres-dormitorios";return"de-cuatro-cinco-habitaciones-o-mas";};
const bathSlug=n=>{n=+n||0;if(n<=1)return"un-bano";if(n===2)return"dos-banos";return"tres-banos-o-mas";};
const m2Slugs=m2=>{m2=+m2||0;if(!(m2>0))return[];const min=Math.max(0,Math.floor((m2-20)/10)*10),max=Math.ceil((m2+20)/10)*10;return[`metros-cuadrados-mas-de_${min}`,`metros-cuadrados-menos-de_${max}`];};
const XSLUG={t:"terraza",p:"piscina",l:"ascensor",k:"garaje"};

const buildUrl=(mode,strict,muniOverride)=>{
  if(!lastReq)return null;
  const req=lastReq,muni=muniOverride||req.muni;
  const area=(muni==="*"||muni==="__multi__")?"tarragona/baix-penedes":(MUNI_SLUG[muni]||null);
  if(!area)return null;
  const op=mode==="buy"?"venta-viviendas":"alquiler-viviendas";
  const f=[...m2Slugs(req.m2),req.type==="flat"?"pisos":"chalets",bedSlug(req.bed),bathSlug(req.bath)];
  if(strict)["t","p","l","k","s","j","a"].forEach(k=>{if(req.ex[k]===1&&XSLUG[k])f.push(XSLUG[k]);});
  return`https://www.idealista.com/${op}/${area}/con-${f.filter(Boolean).join("%2C")}/`;
};

const openIdealista=(mode,strict,muniOverride)=>{
  if(!lastReq){toast(t("toastFirst"));return;}
  if(prefsChanged()){toast(t("toastPrefs"));return;}
  const url=buildUrl(mode,strict,muniOverride);
  if(!url){toast(t("toastNoLink"));return;}
  window.open(url,"_blank","noopener");
};

const refreshExamplesUI=()=>{
  const muniTxt=muniLabel(Q("#ar").value);
  const ok=!!lastReq&&!prefsChanged();
  Q("#xinfo").textContent=tpl(t("xInfo"),{muni:muniTxt,state:ok?t("stateReady"):t("stateNeed")});
  const wrap=Q("#xbtns");wrap.innerHTML="";
  const mkBtn=(label,fn)=>{const b=document.createElement("button");b.type="button";b.className="b ok";b.textContent=label;b.onclick=fn;if(!ok)b.classList.add("dis");wrap.appendChild(b);};
  const z=[...zoneSel].filter(x=>MUNI_SLUG[x]);
  const BL=LANG==="EN"?"BUY":"COMPRA",RL=LANG==="EN"?"RENT":"ALQUILER",SL=LANG==="EN"?"strict":"estricto",FL="flex";
  if(z.length){z.forEach(m=>{mkBtn(`${BL} (${SL}) ¬∑ ${m}`,()=>openIdealista("buy",true,m));mkBtn(`${BL} (${FL}) ¬∑ ${m}`,()=>openIdealista("buy",false,m));mkBtn(`${RL} (${SL}) ¬∑ ${m}`,()=>openIdealista("rent",true,m));mkBtn(`${RL} (${FL}) ¬∑ ${m}`,()=>openIdealista("rent",false,m));});}
  else{mkBtn(`${BL} (${SL})`,()=>openIdealista("buy",true,null));mkBtn(`${BL} (${FL})`,()=>openIdealista("buy",false,null));mkBtn(`${RL} (${SL})`,()=>openIdealista("rent",true,null));mkBtn(`${RL} (${FL})`,()=>openIdealista("rent",false,null));}
  setTabsEnabled();
};

/* ============================
   AI CHAT
   ============================ */
let chatHistory=[],isAIProcessing=false;

const loadChatHistory=()=>{
  try{const s=localStorage.getItem(CHAT_KEY);if(s){chatHistory=JSON.parse(s)||[];renderChatHistory();}}catch(e){}
};
const saveChatHistory=()=>{try{localStorage.setItem(CHAT_KEY,JSON.stringify(chatHistory));}catch(e){}};

const renderAIContext=()=>{
  const box=Q("#aiContext");
  if(!box) return;
  const c=getUserContext();
  if(!c){
    box.innerHTML=`<span class="ai-context-chip warn">${LANG==="EN"?"Complete and analyze your case to activate smart context":(LANG==="CA"?"Completa i analitza el teu cas per activar context intel¬∑ligent":"Completa y analiza tu caso para activar contexto inteligente")}</span>`;
    return;
  }
  const gap=Math.max(0,c.needCash-c.sav);
  const chips=[
    `<span class="ai-context-chip">üéØ ${c.rec}</span>`,
    `<span class="ai-context-chip ${c.ratio>35?"warn":""}">üè¶ ${LANG==="EN"?"Mortgage effort":(LANG==="CA"?"Esfor√ß hipoteca":"Esfuerzo hipoteca")}: ${_fp(c.ratio)}</span>`,
    `<span class="ai-context-chip">üè† ${LANG==="EN"?"Estimated rent":(LANG==="CA"?"Lloguer estimat":"Alquiler estimado")}: ${_fm(c.pr)}</span>`,
    gap>0?`<span class="ai-context-chip warn">üí∏ ${LANG==="EN"?"Savings gap":(LANG==="CA"?"Falta estalvi":"Falta ahorro")}: ${_fm(gap)}</span>`:`<span class="ai-context-chip">‚úÖ ${LANG==="EN"?"Upfront cash covered":(LANG==="CA"?"Estalvi inicial cobert":"Ahorro inicial cubierto")}</span>`
  ];
  box.innerHTML=chips.join("");
};

const renderAISuggestions=()=>{
  const scs=Q("#aiSuggestions");
  if(!scs) return;
  const base=[1,2,3,4,5,6].map(i=>({q:t("aiSug"+i),lbl:t("aiSugLbl"+i)}));
  const c=getUserContext();
  if(!c){
    scs.innerHTML=base.map(x=>`<div class="suggestion-chip" data-q="${x.q}">${x.lbl}</div>`).join("");
    return;
  }
  const extra=[];
  if(c.need) extra.push({
    q:LANG==="EN"?"Give me a monthly savings plan to close my upfront cash gap":(LANG==="CA"?"Dona'm un pla d'estalvi mensual per cobrir la manca d'entrada":"Dame un plan de ahorro mensual para cubrir la falta de entrada"),
    lbl:LANG==="EN"?"Close savings gap":(LANG==="CA"?"Cobrir falta d'estalvi":"Cubrir ahorro")
  });
  if(c.ratio>35) extra.push({
    q:LANG==="EN"?"How can I reduce my mortgage effort below 35%?":(LANG==="CA"?"Com puc baixar l'esfor√ß hipotecari per sota del 35%?":"¬øC√≥mo reduzco mi esfuerzo hipotecario por debajo del 35%?"),
    lbl:LANG==="EN"?"Lower effort <35%":(LANG==="CA"?"Baixar esfor√ß <35%":"Bajar esfuerzo <35%")
  });
  if(c.recCode==="BUY") extra.push({
    q:LANG==="EN"?"Give me a negotiation checklist before making an offer":(LANG==="CA"?"Dona'm un checklist de negociaci√≥ abans de fer oferta":"Dame un checklist de negociaci√≥n antes de ofertar"),
    lbl:LANG==="EN"?"Negotiate better":(LANG==="CA"?"Negociar millor":"Negociar mejor")
  });
  const list=[...extra,...base].slice(0,8);
  scs.innerHTML=list.map(x=>`<div class="suggestion-chip" data-q="${x.q}">${x.lbl}</div>`).join("");
};

const getUserContext=()=>{
  if(!last)return null;
  const extras=["t","p","l","k"].filter(k=>last.e[k]).map(k=>({t:t("exTer"),p:t("exPis"),l:t("exAsc"),k:t("exGar")}[k]||k)).join(", ")||"‚Äî";
  return{
    nm:last.nm, ag:last.ag, inc:last.inc, sav:last.sav, msv:last.msv,
    pb:last.pb, pr:last.pr, pay:last.pay, cap:last.cap,
    rate:last.rate, yrs:last.yrs, dp:Math.round(last.dp*100),
    ratio:last.ratio, rri:last.rri, rec:last.rec, recCode:last.recCode,
    need:last.need, needCash:last.needCash, hor:last.hor,
    muni:muniLabel(last.muni), m2:last.m2, bd:last.bd||0, ba:last.ba,
    type:typeLabel(last.type), extras,
    safe:Math.round(last.inc*0.35),
    missing:Math.max(0,last.needCash-last.sav),
    mosToGoal:last.msv>0?Math.ceil(Math.max(0,last.needCash-last.sav)/last.msv):null,
    margin:Math.round(last.inc*0.35-last.pay),
    rentMargin:Math.round(last.inc*0.40-last.pr)
  };
};

/* ---- Utilidades del motor ---- */
const _fm=n=>fmtMoney(n);
const _fp=n=>Number(n).toFixed(1)+"%";

// ============ AN√ÅLISIS DE PERFIL DE USUARIO ============
const analyzeUserProfile = (ctx) => {
  if (!ctx) return null;
  
  const profile = {
    wealth: 'middle',
    age_group: 'adult',
    urgency: 'normal',
    risk: 'medium'
  };
  
  // An√°lisis de riqueza
  if (ctx.inc >= 4000 && ctx.sav >= 50000) {
    profile.wealth = 'high';
  } else if (ctx.inc < 1800 || ctx.sav < 10000) {
    profile.wealth = 'low';
  }
  
  // An√°lisis de edad
  const age = ctx.ag || 35;
  if (age < 30) {
    profile.age_group = 'young';
  } else if (age >= 55) {
    profile.age_group = 'senior';
  }
  
  // An√°lisis de urgencia
  if (ctx.need && ctx.mosToGoal && ctx.mosToGoal > 36) {
    profile.urgency = 'low';
  } else if (ctx.need && ctx.mosToGoal && ctx.mosToGoal < 12) {
    profile.urgency = 'high';
  }
  
  // An√°lisis de riesgo
  if (ctx.ratio > 35 || ctx.need) {
    profile.risk = 'high';
  } else if (ctx.ratio < 25 && !ctx.need) {
    profile.risk = 'low';
  }
  
  return profile;
};

// ============ TONO ADAPTADO POR PERFIL ============
const getToneForProfile = (profile, LANG) => {
  const tones = {
    ES: {
      high_young: "Tienes una situaci√≥n financiera s√≥lida y juventud de tu lado",
      high_adult: "Tu posici√≥n financiera es muy buena",
      high_senior: "Has construido una posici√≥n financiera excelente",
      middle_young: "Est√°s en buena posici√≥n para empezar",
      middle_adult: "Tienes una base financiera razonable",
      middle_senior: "Tu situaci√≥n es estable",
      low_young: "Aunque ahora est√©s empezando, tienes tiempo por delante",
      low_adult: "Est√°s en un momento de construcci√≥n financiera",
      low_senior: "Entiendo que la situaci√≥n puede ser desafiante"
    },
    CA: {
      high_young: "Tens una situaci√≥ financera s√≤lida i joventut del teu costat",
      high_adult: "La teva posici√≥ financera √©s molt bona",
      high_senior: "Has constru√Øt una posici√≥ financera excel¬∑lent",
      middle_young: "Est√†s en bona posici√≥ per comen√ßar",
      middle_adult: "Tens una base financera raonable",
      middle_senior: "La teva situaci√≥ √©s estable",
      low_young: "Tot i que ara estiguis comen√ßant, tens temps per davant",
      low_adult: "Est√†s en un moment de construcci√≥ financera",
      low_senior: "Entenc que la situaci√≥ pot ser desafiadora"
    },
    EN: {
      high_young: "You have a solid financial position with youth on your side",
      high_adult: "Your financial position is very good",
      high_senior: "You've built an excellent financial position",
      middle_young: "You're in a good position to get started",
      middle_adult: "You have a reasonable financial foundation",
      middle_senior: "Your situation is stable",
      low_young: "Though you're just starting, you have time ahead",
      low_adult: "You're in a financial building phase",
      low_senior: "I understand the situation can be challenging"
    }
  };
  
  const key = `${profile.wealth}_${profile.age_group}`;
  return tones[LANG][key] || "";
};



/* ---- Motor experto local (reglas + scoring sem√°ntico) ---- */
const AI_EXPERT_TOPICS=[
  {id:"affordability",k:["esfuerzo","ratio","cuota","35%","asequible","afford","stress"]},
  {id:"cashgap",k:["entrada","ahorro","falta","gap","inicial","down payment","cash"]},
  {id:"buyvsrent",k:["comprar","alquilar","llogar","buy","rent","mejor opcion"]},
  {id:"rates",k:["tipo","euribor","interest","subida","bajada","fijo","variable"]},
  {id:"term",k:["plazo","anos","a√±os","years","duracion","term"]},
  {id:"savings",k:["ahorrar","estalviar","save","monthly","mensual","meses"]},
  {id:"negotiation",k:["negociar","oferta","descuento","rebaja","arras","offer"]},
  {id:"subsidies",k:["ayuda","subvencion","subsidio","itp","irpf","bonus"]},
  {id:"towns",k:["municipio","zona","town","baixa","baix penedes","calafell","vendrell","cunit"]},
  {id:"risk",k:["riesgo","risk","emergencia","seguridad","imprevisto","crisis"]}
];

/* ---- Base masiva de conocimiento general (multidominio) ---- */
const AI_GENERAL_KB=[
  {id:"economy",k:["inflacion","inflation","ipc","deflacion","pib","gdp","recesion","tipo de interes","euribor","deuda","fiscal","macroeconomia"],
   ES:["Inflaci√≥n sostenida reduce poder adquisitivo; compara siempre salario real vs IPC.","Diversificar ingresos y mantener liquidez reduce fragilidad ante recesiones.","Los ciclos monetarios impactan hipotecas, renta variable y consumo."],
   CA:["La inflaci√≥ sostinguda redueix poder adquisitiu; compara salari real vs IPC.","Diversificar ingressos i mantenir liquiditat redueix fragilitat en recessions.","Els cicles monetaris impacten hipoteques, renda variable i consum."],
   EN:["Persistent inflation erodes purchasing power; track real wage vs CPI.","Diversifying income and holding liquidity lowers recession fragility.","Monetary cycles affect mortgages, equities, and consumer demand."]},
  {id:"investing",k:["invertir","investment","etf","fondos","acciones","bonds","bonos","diversificacion","riesgo retorno","portfolio"],
   ES:["Riesgo y retorno est√°n ligados: evita promesas de rentabilidad alta sin volatilidad.","Costes bajos y horizonte largo suelen ganar frente a trading impulsivo.","Define asignaci√≥n de activos seg√∫n objetivo, plazo y tolerancia al riesgo."],
   CA:["Risc i retorn estan lligats: evita promeses de rendibilitat alta sense volatilitat.","Costos baixos i horitz√≥ llarg solen guanyar al trading impulsiu.","Defineix assignaci√≥ d'actius segons objectiu, termini i toler√†ncia al risc."],
   EN:["Risk and return are linked: avoid high-return/no-volatility promises.","Low costs plus long horizon usually beat impulsive trading.","Set asset allocation by goal, timeline, and risk tolerance."]},
  {id:"personal_finance",k:["presupuesto","budget","deuda","debt","ahorro","emergency fund","fondo emergencia","credit score","interes compuesto"],
   ES:["Regla pr√°ctica: 50/30/20 adaptada a tu realidad de vivienda e ingresos.","Fondo de emergencia ideal: 3-6 meses de gastos esenciales.","Prioriza deuda de alto inter√©s antes que inversiones de riesgo."],
   CA:["Regla pr√†ctica: 50/30/20 adaptada a la teva realitat d'habitatge i ingressos.","Fons d'emerg√®ncia ideal: 3-6 mesos de despeses essencials.","Prioritza deute d'alt inter√®s abans d'inversions de risc."],
   EN:["Practical rule: 50/30/20 adapted to housing and income reality.","Ideal emergency fund: 3-6 months of essential expenses.","Prioritize high-interest debt before risky investments."]},
  {id:"real_estate",k:["inmobiliario","real estate","compraventa","arras","tasacion","notaria","registro","alquiler","rent"],
   ES:["Comprar requiere analizar coste total: entrada, impuestos, notar√≠a, mantenimiento y oportunidad.","Alquilar puede ser racional si da flexibilidad o reduce riesgo financiero.","Negociar precio con comparables ‚Ç¨/m¬≤ mejora resultado esperado."],
   CA:["Comprar requereix analitzar cost total: entrada, impostos, notaria, manteniment i oportunitat.","Llogar pot ser racional si dona flexibilitat o redueix risc financer.","Negociar preu amb comparables ‚Ç¨/m¬≤ millora el resultat esperat."],
   EN:["Buying requires total-cost view: down payment, taxes, notary, maintenance, opportunity cost.","Renting can be rational if it improves flexibility or lowers financial risk.","Negotiating with ‚Ç¨/m¬≤ comparables improves expected outcome."]},
  {id:"business",k:["empresa","startup","pricing","margen","cashflow","ebitda","unit economics","clientes","marketing"],
   ES:["Sin flujo de caja, el crecimiento no es sostenible.","Mide CAC/LTV y margen de contribuci√≥n antes de escalar.","Precio debe reflejar valor percibido, coste y posici√≥n competitiva."],
   CA:["Sense flux de caixa, el creixement no √©s sostenible.","Mesura CAC/LTV i marge de contribuci√≥ abans d'escalar.","El preu ha de reflectir valor percebut, cost i posici√≥ competitiva."],
   EN:["Without cashflow, growth is not sustainable.","Measure CAC/LTV and contribution margin before scaling.","Price must reflect perceived value, cost, and competitive position."]},
  {id:"technology",k:["programacion","software","ia","ai","algoritmo","arquitectura","backend","frontend","api","database","sql","python","javascript"],
   ES:["Buena ingenier√≠a prioriza claridad, testabilidad y mantenibilidad.","Dise√±os simples con m√©tricas y observabilidad reducen incidencias.","Seguridad b√°sica: validaci√≥n de entrada, m√≠nimo privilegio y secretos fuera del c√≥digo."],
   CA:["Bona enginyeria prioritza claredat, testabilitat i mantenibilitat.","Dissenys simples amb m√®triques i observabilitat redueixen incid√®ncies.","Seguretat b√†sica: validaci√≥ d'entrada, m√≠nim privilegi i secrets fora del codi."],
   EN:["Good engineering prioritizes clarity, testability, and maintainability.","Simple designs with metrics and observability reduce incidents.","Basic security: input validation, least privilege, and secrets outside code."]},
  {id:"health",k:["salud","health","nutricion","ejercicio","sue√±o","stress","mental","ansiedad","dieta"],
   ES:["Base de salud: sue√±o suficiente, actividad f√≠sica regular y alimentaci√≥n consistente.","No sustituyo consejo m√©dico profesional; ante s√≠ntomas consulta un profesional.","Peque√±os h√°bitos sostenibles superan cambios extremos de corta duraci√≥n."],
   CA:["Base de salut: son suficient, activitat f√≠sica regular i alimentaci√≥ consistent.","No substitueixo consell m√®dic professional; amb s√≠mptomes consulta un professional.","Petits h√†bits sostenibles superen canvis extrems de curta durada."],
   EN:["Health basics: adequate sleep, regular physical activity, and consistent nutrition.","I do not replace professional medical advice; consult a clinician for symptoms.","Small sustainable habits beat short-lived extreme changes."]},
  {id:"law",k:["legal","contrato","ley","leyes","derecho","demanda","impuesto","fiscal","compliance","rgpd"],
   ES:["Puedo orientar en t√©rminos generales, pero no sustituyo asesoramiento legal profesional.","Lee cl√°usulas de penalizaci√≥n, plazos y jurisdicci√≥n antes de firmar.","En privacidad, minimizaci√≥n de datos y consentimiento informado son clave."],
   CA:["Puc orientar en termes generals, per√≤ no substitueixo assessorament legal professional.","Llegeix cl√†usules de penalitzaci√≥, terminis i jurisdicci√≥ abans de signar.","En privacitat, minimitzaci√≥ de dades i consentiment informat s√≥n clau."],
   EN:["I can provide general guidance but not replace professional legal advice.","Review penalty clauses, timelines, and jurisdiction before signing.","For privacy, data minimization and informed consent are key."]},
  {id:"education",k:["estudiar","aprender","learning","curso","universidad","exam","memoria","productividad"],
   ES:["Aprendizaje efectivo: pr√°ctica activa + repetici√≥n espaciada + feedback.","Divide metas en bloques semanales con revisi√≥n de progreso.","Ense√±ar lo aprendido acelera comprensi√≥n y retenci√≥n."],
   CA:["Aprenentatge efectiu: pr√†ctica activa + repetici√≥ espaiada + feedback.","Divideix metes en blocs setmanals amb revisi√≥ de progr√©s.","Ensenyar el que has apr√®s accelera comprensi√≥ i retenci√≥."],
   EN:["Effective learning: active practice + spaced repetition + feedback.","Break goals into weekly blocks with progress review.","Teaching what you learned accelerates understanding and retention."]},
  {id:"career",k:["trabajo","job","salario","entrevista","cv","curriculum","promocion","liderazgo","management"],
   ES:["Aumentar salario suele requerir evidencia de impacto medible y negociaci√≥n preparada.","CV eficaz: logros con m√©tricas, no solo tareas.","En entrevistas, estructura STAR mejora claridad de ejemplos."],
   CA:["Augmentar salari sol requerir evid√®ncia d'impacte mesurable i negociaci√≥ preparada.","CV efica√ß: fites amb m√®triques, no nom√©s tasques.","En entrevistes, estructura STAR millora claredat d'exemples."],
   EN:["Salary growth often requires measurable impact evidence and prepared negotiation.","Strong CV: achievements with metrics, not just tasks.","In interviews, STAR structure improves example clarity."]},
  {id:"science",k:["fisica","quimica","biologia","astronomia","ciencia","experimento","evidence","metodo cientifico"],
   ES:["La ciencia avanza por evidencia reproducible, no por autoridad aislada.","Distinguir correlaci√≥n de causalidad evita conclusiones err√≥neas.","Modelos son aproximaciones √∫tiles, no verdades absolutas."],
   CA:["La ci√®ncia avan√ßa per evid√®ncia reprodu√Øble, no per autoritat a√Øllada.","Distingir correlaci√≥ de causalitat evita conclusions err√≤nies.","Els models s√≥n aproximacions √∫tils, no veritats absolutes."],
   EN:["Science advances through reproducible evidence, not isolated authority.","Distinguishing correlation from causation avoids wrong conclusions.","Models are useful approximations, not absolute truths."]},
  {id:"history",k:["historia","history","guerra","imperio","revolucion","siglo","edad media","roma"],
   ES:["Contexto importa: causas econ√≥micas, sociales y tecnol√≥gicas interact√∫an.","Evita anacronismos al juzgar decisiones del pasado.","Contrastar fuentes reduce sesgos narrativos."],
   CA:["El context importa: causes econ√≤miques, socials i tecnol√≤giques interactuen.","Evita anacronismes en jutjar decisions del passat.","Contrastar fonts redueix biaixos narratius."],
   EN:["Context matters: economic, social, and technological causes interact.","Avoid anachronisms when judging past decisions.","Cross-checking sources reduces narrative bias."]},
  {id:"philosophy",k:["filosofia","ethics","moral","existencial","sentido","stoic","utilitarismo"],
   ES:["Marco √∫til: clarifica valores, luego eval√∫a consecuencias y deberes.","En dilemas √©ticos, explicitar supuestos mejora decisiones.","No hay respuestas √∫nicas para todos los contextos."],
   CA:["Marc √∫til: clarifica valors, despr√©s avalua conseq√º√®ncies i deures.","En dilemes √®tics, explicitar sup√≤sits millora decisions.","No hi ha respostes √∫niques per a tots els contextos."],
   EN:["Useful frame: clarify values, then assess consequences and duties.","In ethical dilemmas, making assumptions explicit improves decisions.","There are rarely one-size-fits-all answers." ]},
  {id:"psychology",k:["psicologia","habitos","motivacion","procrastinacion","emociones","mindset"],
   ES:["El entorno dise√±a conducta: reduce fricci√≥n para h√°bitos buenos.","Objetivos espec√≠ficos y medibles superan intenciones vagas.","Autocompasi√≥n y constancia funcionan mejor que culpa."],
   CA:["L'entorn dissenya conducta: redueix fricci√≥ per h√†bits bons.","Objectius espec√≠fics i mesurables superen intencions vagues.","Autocompassi√≥ i const√†ncia funcionen millor que culpa."],
   EN:["Environment shapes behavior: reduce friction for good habits.","Specific measurable goals beat vague intentions.","Self-compassion and consistency beat guilt." ]},
  {id:"communication",k:["comunicar","presentacion","escribir","email","negociacion","argumento","storytelling"],
   ES:["Estructura clara: contexto ‚Üí problema ‚Üí propuesta ‚Üí siguiente paso.","Mensajes cortos con una idea central mejoran comprensi√≥n.","Escucha activa y preguntas abiertas elevan calidad de conversaciones."],
   CA:["Estructura clara: context ‚Üí problema ‚Üí proposta ‚Üí seg√ºent pas.","Missatges curts amb una idea central milloren comprensi√≥.","Escolta activa i preguntes obertes eleven la qualitat de converses."],
   EN:["Clear structure: context ‚Üí problem ‚Üí proposal ‚Üí next step.","Short messages with one core idea improve comprehension.","Active listening and open questions improve conversations."]},
  {id:"travel",k:["viaje","travel","itinerario","vuelos","hotel","visa","equipaje"],
   ES:["Planifica con margen: documentaci√≥n, seguros y pol√≠tica de cancelaci√≥n.","Optimiza coste total, no solo precio de vuelo.","Itinerarios realistas reducen fatiga y mejoran experiencia."],
   CA:["Planifica amb marge: documentaci√≥, assegurances i pol√≠tica de cancel¬∑laci√≥.","Optimitza cost total, no nom√©s preu del vol.","Itineraris realistes redueixen fatiga i milloren experi√®ncia."],
   EN:["Plan with buffer: documents, insurance, and cancellation policies.","Optimize total trip cost, not just airfare.","Realistic itineraries reduce fatigue and improve experience."]},
  {id:"cooking",k:["cocina","receta","horno","sarten","salsa","fermentacion","pan","postre"],
   ES:["Domina t√©cnicas base (sofrito, emulsi√≥n, punto de cocci√≥n) y tendr√°s mejores resultados.","Mise en place ahorra errores y tiempo.","Ajusta sal, √°cido y grasa para equilibrar sabor."],
   CA:["Domina t√®cniques base (sofregit, emulsi√≥, punt de cocci√≥) i tindr√†s millors resultats.","Mise en place estalvia errors i temps.","Ajusta sal, √†cid i greix per equilibrar sabor."],
   EN:["Master core techniques (saute, emulsion, doneness) for better results.","Mise en place reduces mistakes and saves time.","Balance salt, acid, and fat for flavor." ]},
  {id:"sports",k:["deporte","futbol","running","gym","fuerza","resistencia","entrenamiento"],
   ES:["Progresi√≥n gradual y descanso son esenciales para mejorar sin lesi√≥n.","Objetivo SMART + registro semanal acelera resultados.","Nutrici√≥n e hidrataci√≥n sostienen rendimiento."],
   CA:["Progressi√≥ gradual i descans s√≥n essencials per millorar sense lesi√≥.","Objectiu SMART + registre setmanal accelera resultats.","Nutrici√≥ i hidrataci√≥ sostenen rendiment."],
   EN:["Gradual progression and rest are key to improve injury-free.","SMART goals + weekly tracking accelerate results.","Nutrition and hydration sustain performance."]},
  {id:"languages",k:["idioma","ingles","english","frances","aleman","vocabulario","grammar","pronunciation"],
   ES:["Pr√°ctica diaria breve (20-30 min) supera sesiones largas espor√°dicas.","Input comprensible + output frecuente + correcci√≥n r√°pida.","Prioriza frases √∫tiles antes que listas largas de reglas."],
   CA:["Pr√†ctica di√†ria breu (20-30 min) supera sessions llargues espor√†diques.","Input comprensible + output freq√ºent + correcci√≥ r√†pida.","Prioritza frases √∫tils abans que llistes llargues de regles."],
   EN:["Short daily practice (20-30 min) beats sporadic long sessions.","Comprehensible input + frequent output + fast correction.","Prioritize useful phrases before long grammar lists."]},
  {id:"ai_ml",k:["machine learning","llm","neural","transformer","prompt","hallucination","rag","vector"],
   ES:["LLMs generan texto probable, no verdad garantizada; verifica datos cr√≠ticos.","Prompts con contexto, restricciones y formato mejoran consistencia.","Para precisi√≥n, combina retrieval/grounding con validaci√≥n externa."],
   CA:["Els LLMs generen text probable, no veritat garantida; verifica dades cr√≠tiques.","Prompts amb context, restriccions i format milloren consist√®ncia.","Per precisi√≥, combina retrieval/grounding amb validaci√≥ externa."],
   EN:["LLMs generate likely text, not guaranteed truth; verify critical facts.","Prompts with context, constraints, and output format improve consistency.","For accuracy, combine retrieval/grounding with external validation."]},
  {id:"cybersecurity",k:["seguridad","cyber","phishing","password","2fa","malware","ransomware","vpn","encryption"],
   ES:["Higiene m√≠nima: contrase√±as √∫nicas + gestor + 2FA.","Actualizaciones y copias de seguridad reducen impacto de incidentes.","Desconf√≠a de urgencia artificial en correos y enlaces."],
   CA:["Higiene m√≠nima: contrasenyes √∫niques + gestor + 2FA.","Actualitzacions i c√≤pies de seguretat redueixen impacte d'incidents.","Desconfia de la urg√®ncia artificial en correus i enlla√ßos."],
   EN:["Minimum hygiene: unique passwords + manager + 2FA.","Updates and backups reduce incident impact.","Be skeptical of artificial urgency in emails and links."]},
  {id:"math",k:["matematicas","algebra","calculo","estadistica","probabilidad","derivada","integral"],
   ES:["Entender conceptos primero y f√≥rmulas despu√©s mejora transferencia.","Problemas tipo + variaciones graduales consolidan aprendizaje.","En estad√≠stica, interpreta incertidumbre, no solo promedios."],
   CA:["Entendre conceptes primer i f√≥rmules despr√©s millora transfer√®ncia.","Problemes tipus + variacions graduals consoliden aprenentatge.","En estad√≠stica, interpreta incertesa, no nom√©s mitjanes."],
   EN:["Concepts first, formulas second improves transfer.","Prototype problems + gradual variations build mastery.","In statistics, interpret uncertainty, not only averages."]},
  {id:"writing",k:["escribir","writing","novela","articulo","copy","blog","guion","story"],
   ES:["Un borrador malo terminado vale m√°s que uno perfecto inconcluso.","Edita en capas: estructura, claridad, estilo, correcci√≥n.","Conoce audiencia y objetivo antes de elegir tono."],
   CA:["Un esborrany dolent acabat val m√©s que un perfecte inacabat.","Edita per capes: estructura, claredat, estil, correcci√≥.","Coneix audi√®ncia i objectiu abans de triar to."],
   EN:["A bad finished draft beats a perfect unfinished one.","Edit in layers: structure, clarity, style, correctness.","Know audience and goal before picking tone."]}
];

const scoreGeneralKB=(msg,entry)=>{
  const m=normAI(msg);
  let score=0;
  entry.k.forEach(k=>{ if(m.includes(normAI(k))) score+=2; });
  if(m.length>0&&entry.id&&m.includes(normAI(entry.id))) score+=1;
  return score;
};

const pickGeneralKB=(msg,maxN=3)=>AI_GENERAL_KB
  .map(e=>({e,score:scoreGeneralKB(msg,e)}))
  .filter(x=>x.score>0)
  .sort((a,b)=>b.score-a.score)
  .slice(0,maxN)
  .map(x=>x.e);

const buildGeneralKnowledgeReply=(msg,L)=>{
  const top=pickGeneralKB(msg,3);
  if(!top.length) return "";
  const byLang=(e)=>L==="CA"?e.CA:L==="EN"?e.EN:e.ES;
  const header=L==="EN"?"üåê General knowledge answer (multi-domain):":(L==="CA"?"üåê Resposta de coneixement general (multidomini):":"üåê Respuesta de conocimiento general (multidominio):");
  const lines=[];
  top.forEach(entry=>{
    const points=byLang(entry).slice(0,3);
    lines.push(`
[${entry.id}]`);
    points.forEach(p=>lines.push(`‚Ä¢ ${p}`));
  });
  const close=L==="EN"
    ?"\nIf you want, I can go deeper in one specific domain (step-by-step, examples, and actionable plan)."
    :(L==="CA"
      ?"\nSi vols, puc aprofundir en un domini concret (pas a pas, exemples i pla accionable)."
      :"\nSi quieres, puedo profundizar en un dominio concreto (paso a paso, ejemplos y plan accionable).");
  return [header,...lines].join("\n")+close;
};

const detectTaskMode=(msg="")=>{
  const m=normAI(msg);
  const has=(...k)=>k.some(x=>m.includes(normAI(x)));
  if(has("paso a paso","step by step","guia","gu√≠a","tutorial","como ","c√≥mo ")) return "howto";
  if(has("plan","roadmap","itinerario","estrategia","strategy")) return "plan";
  if(has("compara","versus","vs","pros y contras","advantages","disadvantages")) return "compare";
  if(has("codigo","c√≥digo","code","program","script","debug","error")) return "code";
  if(has("calcula","resolver","equation","matematic","estadistica")) return "math";
  if(has("resume","resumen","summary","explica","explain")) return "explain";
  return "general";
};

const buildUniversalFallbackReply=(msg,L)=>{
  const mode=detectTaskMode(msg);
  const kb=pickGeneralKB(msg,2);
  const head=L==="EN"?"üß† Universal response (best effort):":(L==="CA"?"üß† Resposta universal (millor esfor√ß):":"üß† Respuesta universal (mejor esfuerzo):");
  const modeText={
    ES:{howto:"Te lo explico paso a paso.",plan:"Te propongo un plan ejecutable.",compare:"Te doy comparaci√≥n con pros y contras.",code:"Te doy enfoque t√©cnico y pseudoc√≥digo.",math:"Te doy m√©todo y resultado orientativo.",explain:"Te doy explicaci√≥n clara y resumida.",general:"Te doy una respuesta general estructurada."},
    CA:{howto:"T'ho explico pas a pas.",plan:"Et proposo un pla executable.",compare:"Et dono comparaci√≥ amb pros i contres.",code:"Et dono enfocament t√®cnic i pseudocodi.",math:"Et dono m√®tode i resultat orientatiu.",explain:"Et dono explicaci√≥ clara i resumida.",general:"Et dono una resposta general estructurada."},
    EN:{howto:"I will explain step by step.",plan:"I will propose an executable plan.",compare:"I will provide a pros/cons comparison.",code:"I will provide technical approach and pseudocode.",math:"I will provide method and an indicative result.",explain:"I will provide a clear concise explanation.",general:"I will provide a structured general answer."}
  };
  const lang=L==="CA"?"CA":L==="EN"?"EN":"ES";
  const a=[head,modeText[lang][mode]];
  if(kb.length){
    a.push(lang==="EN"?"Relevant domains:":(lang==="CA"?"Dominis rellevants:":"Dominios relevantes:"));
    kb.forEach(e=>{
      const pts=(lang==="EN"?e.EN:lang==="CA"?e.CA:e.ES).slice(0,2);
      a.push(`- ${e.id}: ${pts.join(" ")}`);
    });
  }
  a.push(lang==="EN"?"If you want higher precision, ask with context, constraints, and desired output format.":(lang==="CA"?"Si vols m√©s precisi√≥, demana-ho amb context, restriccions i format de sortida desitjat.":"Si quieres m√°s precisi√≥n, p√≠delo con contexto, restricciones y formato de salida deseado."));
  return a.join("\n");
};



const normAI=(txt="")=>txt.toLowerCase()
  .normalize("NFD").replace(/[ÃÄ-ÕØ]/g,"")
  .replace(/[^\p{L}\p{N}\s%]/gu," ")
  .replace(/\s+/g," ").trim();

const scoreTopic=(msg,topic)=>{
  const m=normAI(msg);
  let score=0;
  topic.k.forEach(k=>{ if(m.includes(normAI(k))) score+=1; });
  return score;
};

const pickTopics=(msg,maxN=3)=>{
  return AI_EXPERT_TOPICS
    .map(t=>({id:t.id,score:scoreTopic(msg,t)}))
    .filter(x=>x.score>0)
    .sort((a,b)=>b.score-a.score)
    .slice(0,maxN)
    .map(x=>x.id);
};

const expertLine=(L,es,ca,en)=>L==="CA"?ca:L==="EN"?en:es;

const expertTopicText=(id,c,L)=>{
  const missing=Math.max(0,c.needCash-c.sav);
  const msv=Math.max(0,c.msv||0);
  const mos=(missing>0&&msv>0)?Math.ceil(missing/msv):0;
  switch(id){
    case "affordability": return expertLine(L,
      `‚Ä¢ Esfuerzo actual: ${_fp(c.ratio)}. Objetivo recomendado: 30-35%. Si superas 35%, baja presupuesto o ampl√≠a plazo de forma controlada.`,
      `‚Ä¢ Esfor√ß actual: ${_fp(c.ratio)}. Objectiu recomanat: 30-35%. Si superes 35%, baixa pressupost o amplia termini amb control.`,
      `‚Ä¢ Current effort: ${_fp(c.ratio)}. Recommended target: 30-35%. If above 35%, lower budget or extend term carefully.`);
    case "cashgap": return expertLine(L,
      missing>0?`‚Ä¢ Te faltan ${_fm(missing)} para entrada+gastos${msv>0?` (~${mos} meses a ${_fm(msv)}/mes).`:"."}`:`‚Ä¢ Ya cubres entrada+gastos. Prioriza negociaci√≥n de precio y condiciones.` ,
      missing>0?`‚Ä¢ Et falten ${_fm(missing)} per entrada+despeses${msv>0?` (~${mos} mesos a ${_fm(msv)}/mes).`:"."}`:`‚Ä¢ Ja cobreixes entrada+despeses. Prioritza negociar preu i condicions.` ,
      missing>0?`‚Ä¢ You are short by ${_fm(missing)} for down payment+costs${msv>0?` (~${mos} months at ${_fm(msv)}/mo).`:"."}`:`‚Ä¢ You already cover upfront cash. Focus on negotiating better price/terms.`);
    case "buyvsrent": return expertLine(L,
      `‚Ä¢ Recomendaci√≥n actual: ${c.rec}. Comprar suele tener sentido si esfuerzo ‚â§35%, horizonte >5 a√±os y fondo de emergencia intacto.`,
      `‚Ä¢ Recomanaci√≥ actual: ${c.rec}. Comprar sol tenir sentit si esfor√ß ‚â§35%, horitz√≥ >5 anys i fons d'emerg√®ncia intacte.`,
      `‚Ä¢ Current recommendation: ${c.rec}. Buying usually makes sense when effort ‚â§35%, horizon >5 years, and emergency fund remains intact.`);
    case "rates": return expertLine(L,
      `‚Ä¢ Tipo usado: ${(c.rate*100).toFixed(2)}%. Regla pr√°ctica: simula +1% de tipo y comprueba que sigues por debajo del 40% de ingresos.`,
      `‚Ä¢ Tipus utilitzat: ${(c.rate*100).toFixed(2)}%. Regla pr√†ctica: simula +1% i comprova que continues per sota del 40% d'ingressos.`,
      `‚Ä¢ Rate used: ${(c.rate*100).toFixed(2)}%. Rule of thumb: simulate +1% and ensure you stay below 40% income effort.`);
    case "term": return expertLine(L,
      `‚Ä¢ Plazo actual: ${c.yrs} a√±os. Acortar reduce intereses; alargar mejora caja mensual. Decide por estabilidad de ingresos, no solo por cuota.`,
      `‚Ä¢ Termini actual: ${c.yrs} anys. Escur√ßar redueix interessos; allargar millora caixa mensual. Decideix per estabilitat d'ingressos.`,
      `‚Ä¢ Current term: ${c.yrs} years. Shorter term cuts interest; longer term improves monthly cashflow. Decide by income stability, not payment alone.`);
    case "savings": return expertLine(L,
      `‚Ä¢ Plan de ahorro: automatiza ${_fm(Math.max(150,c.inc*0.1))}/mes, elimina 2 gastos fijos y revisa progreso cada 30 d√≠as.`,
      `‚Ä¢ Pla d'estalvi: automatitza ${_fm(Math.max(150,c.inc*0.1))}/mes, elimina 2 despeses fixes i revisa progr√©s cada 30 dies.`,
      `‚Ä¢ Savings plan: automate ${_fm(Math.max(150,c.inc*0.1))}/mo, cut 2 fixed costs, review progress every 30 days.`);
    case "negotiation": return expertLine(L,
      `‚Ä¢ Negociaci√≥n: abre 8-12% por debajo, lleva comparables ‚Ç¨/m¬≤ y no superes tu tope (${_fm(c.pb*(c.ratio>35?0.9:1))}).`,
      `‚Ä¢ Negociaci√≥: obre 8-12% per sota, porta comparables ‚Ç¨/m¬≤ i no superis el teu topall (${_fm(c.pb*(c.ratio>35?0.9:1))}).`,
      `‚Ä¢ Negotiation: start 8-12% below asking, bring ‚Ç¨/m¬≤ comparables, and do not exceed your cap (${_fm(c.pb*(c.ratio>35?0.9:1))}).`);
    case "subsidies": return expertLine(L,
      `‚Ä¢ Revisa ayudas: ITP reducido (si aplica), deducciones auton√≥micas y condiciones de primera vivienda antes de firmar.`,
      `‚Ä¢ Revisa ajudes: ITP redu√Øt (si aplica), deduccions auton√≤miques i condicions de primera vivenda abans de signar.`,
      `‚Ä¢ Check subsidies: reduced ITP (if eligible), regional deductions, and first-home conditions before signing.`);
    case "towns": return expertLine(L,
      `‚Ä¢ Zonas: costa (Calafell/Cunit) = m√°s precio; interior (Bonastre/Maslloren√ß/Montmell) = mayor asequibilidad.`,
      `‚Ä¢ Zones: costa (Calafell/Cunit) = m√©s preu; interior (Bonastre/Maslloren√ß/Montmell) = m√©s assequible.`,
      `‚Ä¢ Areas: coast (Calafell/Cunit) = higher prices; inland (Bonastre/Maslloren√ß/Montmell) = more affordable.`);
    case "risk": return expertLine(L,
      `‚Ä¢ Gesti√≥n de riesgo: conserva fondo de emergencia de 6 meses (${_fm(c.inc*6)}) y evita comprometer todo el ahorro en la compra.`,
      `‚Ä¢ Gesti√≥ de risc: mant√©n fons d'emerg√®ncia de 6 mesos (${_fm(c.inc*6)}) i evita comprometre tots els estalvis en la compra.`,
      `‚Ä¢ Risk management: keep a 6-month emergency fund (${_fm(c.inc*6)}) and avoid deploying all savings into purchase costs.`);
    default: return "";
  }
};

const buildExpertReply=(msg,c,L,intent)=>{
  if(!c) return "";
  const topics=pickTopics(msg,4);
  const needsExpert=(intent==="general"||intent==="advice"||intent==="strategy"||intent==="savings"||intent==="buyrent"||topics.length>=2);
  if(!needsExpert) return "";

  const header=expertLine(L,
    `üß† Respuesta avanzada para tu caso (${c.muni} ¬∑ ${c.m2}m¬≤):`,
    `üß† Resposta avan√ßada pel teu cas (${c.muni} ¬∑ ${c.m2}m¬≤):`,
    `üß† Advanced answer for your case (${c.muni} ¬∑ ${c.m2}m¬≤):`);

  const diag=[
    expertLine(L,`‚Ä¢ Precio estimado: ${_fm(c.pb)} ¬∑ Cuota: ${_fm(c.pay)} (${_fp(c.ratio)}).`,`‚Ä¢ Preu estimat: ${_fm(c.pb)} ¬∑ Quota: ${_fm(c.pay)} (${_fp(c.ratio)}).`,`‚Ä¢ Estimated price: ${_fm(c.pb)} ¬∑ Payment: ${_fm(c.pay)} (${_fp(c.ratio)}).`),
    expertLine(L,`‚Ä¢ Alquiler estimado: ${_fm(c.pr)} (${_fp(c.rri)}).`,`‚Ä¢ Lloguer estimat: ${_fm(c.pr)} (${_fp(c.rri)}).`,`‚Ä¢ Estimated rent: ${_fm(c.pr)} (${_fp(c.rri)}).`),
    expertLine(L,`‚Ä¢ Recomendaci√≥n actual: ${c.rec}.`,`‚Ä¢ Recomanaci√≥ actual: ${c.rec}.`,`‚Ä¢ Current recommendation: ${c.rec}.`)
  ];

  const chosen=topics.length?topics:["affordability","cashgap","buyvsrent"];
  const body=chosen.map(id=>expertTopicText(id,c,L)).filter(Boolean);

  const close=expertLine(L,
    "\nSi quieres, te hago ahora un plan semanal (Semana 1 a 12) con tareas exactas y objetivo de ahorro mensual.",
    "\nSi vols, et faig ara un pla setmanal (Setmana 1 a 12) amb tasques exactes i objectiu d'estalvi mensual.",
    "\nIf you want, I can now generate a week-by-week plan (Weeks 1-12) with exact tasks and monthly savings targets.");

  return [header,...diag,...body].join("\n")+close;
};

/* ---- Detectar intenci√≥n del mensaje ---- */
const detectIntent=(msg)=>{
  const m=msg.toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[¬ø¬°'"]/g,"").trim();
  const has=(...words)=>words.some(w=>m.includes(w));
  const starts=(...words)=>words.some(w=>m.startsWith(w));

  // Saludos y socializaci√≥n
  if(has("hola","hi ","hello","bon dia","buenos dias","buenas","hey","buen","good morning","good evening","que tal","com estas","com anem","how are")) return "greet";
  if(has("gracias","gracies","thanks","thank you","genial","perfecto","molt be","muy bien","great","awesome","guay","crack","mola")) return "thanks";
  if(has("adios","hasta luego","bye","fins aviat","ciao","chao","nos vemos")) return "bye";
  if(has("que puedes","que pots","what can you","que sabes","que saps","ayudame","ajuda'm","help me","para que sirves","com funciones")) return "capabilities";

  // An√°lisis y resultado
  if(has("analisis","analisi","analysis","resultado","resultat","result","resumen","resum","summary","dime todo","cu√©ntame","conta'm")) return "summary";
  if(has("consejo","consell","advice","recomiendas","recomanes","recommend","que hago","que faig","que deberia","que hauria")) return "advice";
  if(has("plan","plan de accion","pasos","roadmap","hoja de ruta","next steps","seguent pas")) return "actionplan";
  if(has("negociar","negociacio","negotiation","oferta","offer","regatear","rebaja","descuento")) return "negotiation";

  // Compra vs Alquiler
  if(has("comprar o alquilar","comprar o llogar","buy or rent","mejor opcion","millor opcio","que es mejor","que es millor","which is better")) return "buyrent";

  // Financiaci√≥n
  if(has("hipoteca","mortgage","prestamo","credito","financiacion","financiamiento","banco","bank","euribor")) return "mortgage";
  if(has("cuota","quota","monthly payment","pago mensual","mensualidad","pago","payment","al mes","cada mes")) return "payment";
  if(has("entrada","down payment","enganxe","senyal","inicial","anticipo")) return "downpayment";
  if(has("gastos","costes","costos","costs","notaria","itp","impuesto","impost","taxes","fees","registro")) return "costs";
  if(has("tipo de interes","tipus d'interes","interest rate","euribor","sube el tipo","puja el tipus","rate sube","rate baja","tipo fijo","tipo variable")) return "rates";

  // Ahorro
  if(has("ahorrar","estalviar","save","ahorro","estalvi","savings","cuanto necesito","cuanto tardar","quant trigar")) return "savings";
  if(has("estrategia","strategy","capacidad de compra","buying power","poder adquisitivo","como comprar mas")) return "strategy";
  if(has("amortiz","pagar antes","pagar avans","overpay","cancelar hipoteca","reducir hipoteca")) return "amortize";

  // Propiedades
  if(has("precio","preu","price","cuanto vale","quanto costa","cuanto cuesta","valor")) return "price";
  if(has("alquiler","lloguer","rent","arrendar","arrendament","alquilar")) return "rent";
  if(has("m2","metros","metres","square","tama√±o","tamany","size","grande","petit","peque√±o")) return "size";
  if(has("plazo","termini","a√±os","anys","years","tiempo hipoteca","duraci√≥n")) return "term";
  if(has("extras","piscina","pool","terraza","terrasse","garaje","parking","ascensor","elevator")) return "extras";

  // Mercado y zona
  if(has("municipio","municipi","town","zona","pueblo","village","donde vivir","on viure","where to live","mejor zona","millor zona")) return "towns";
  if(has("comparar","compare","otra zona","altra zona","barcelona","girona","tarragona","lleida","diferencia zona")) return "compare";
  if(has("mercado","mercat","market","tendencia","tend√®ncia","trend","subira","baixara","sube","baja","futuro","previsi√≥n")) return "market";

  // Ayudas y fiscalidad
  if(has("ayuda","ajuda","subvencio","subvencion","subsidio","bonus","deduccion","deducci√≥","irpf","hacienda","hisenda")) return "subsidy";
  if(has("primera","primer","first home","primera vivenda","primera vivienda")) return "firsthome";
  if(has("ipc","inflacion","inflacio","inflation","subida precios","poder adquisitivo")) return "inflation";

  // Riesgos
  if(has("riesgo","risc","risk","peligro","perills","crash","burbuja","burbolla","crisis")) return "risk";

  // Ingresos
  if(has("trabajo","feina","job","sueldo","salari","salary","ingresos","n√≥mina","nomina")) return "income";

  // Preguntas raras / off-topic
  if(has("tiempo","clima","weather","llueve","sol","calor","fred","frio")) return "weather";
  if(has("chiste","joke","broma","divertido","humor","rie","rire")) return "joke";
  if(has("quien eres","qui ets","who are you","eres humano","ets huma","are you human","ets ia","eres ia","eres robot","chatgpt","openai","anthropic","claude")) return "identity";
  if(has("la vida","filosofia","sentido","meaning","existencial","dios","religion")) return "philosophy";
  if(has("futbol","bar√ßa","barca","madrid","sport","deporte","esport")) return "sport";
  if(has("comer","menjar","restaurante","comida","food","receta")) return "food";
  if(has("vino","vi","cava","penedes","winery","bodega","vinya")) return "wine";
  if(has("playa","platja","beach","mar","sea","nadar","swim")) return "beach";
  if(has("coche","cotxe","car","moto","tren","train","transport")) return "transport";

  return "general";
};
/* ---- Generador de respuestas ---- */
const buildReply=(intent, msg)=>{
  const c=getUserContext();
  const L=LANG;
  const es=(es,ca,en)=>L==="CA"?ca:L==="EN"?en:es;

  const housingIntents=new Set(["summary","advice","buyrent","mortgage","payment","downpayment","costs","rates","savings","strategy","amortize","price","rent","size","term","extras","towns","compare","market","subsidy","firsthome","inflation","risk","income","negotiation","actionplan"]);
  const generalKBReply=buildGeneralKnowledgeReply(msg,L);

  // Si no hay an√°lisis: responder SIEMPRE. Para vivienda, pedir an√°lisis; para general, responder con KB universal.
  if(!c){
    if(!housingIntents.has(intent)) return generalKBReply||buildUniversalFallbackReply(msg,L);
    return es(
      "‚ö†Ô∏è Para preguntas personalizadas de vivienda primero necesito tu an√°lisis (pasos 1-3). Mientras tanto, tambi√©n puedo responder preguntas generales de cualquier tema.",
      "‚ö†Ô∏è Per preguntes personalitzades d'habitatge primer necessito la teva an√†lisi (passos 1-3). Mentrestant, tamb√© puc respondre preguntes generals de qualsevol tema.",
      "‚ö†Ô∏è For personalized housing answers I need your analysis first (steps 1-3). Meanwhile, I can answer general questions on almost any topic."
    );
  }
  const profile = analyzeUserProfile(c);
  const tone = getToneForProfile(profile, L);

  if(generalKBReply&&!housingIntents.has(intent)) return generalKBReply;

  const expertReply=buildExpertReply(msg,c,L,intent);
  if(expertReply) return expertReply;

  const buyOk=!c.need&&c.ratio<=35&&c.hor;
  const rentOk=c.rri<=40;

  switch(intent){

    case "greet": {
  const greeting = es(
    `üëã ¬°Hola ${c.nm}! ${tone}. `,
    `üëã Hola ${c.nm}! ${tone}. `,
    `üëã Hi ${c.nm}! ${tone}. `
  );
  
  let situation = "";
  if (profile.wealth === 'high') {
    situation = es(
      `Con tus ingresos de ${_fm(c.inc)}/mes y ${_fm(c.sav)} ahorrados, tienes opciones interesantes. `,
      `Amb els teus ingressos de ${_fm(c.inc)}/mes i ${_fm(c.sav)} estalviats, tens opcions interessants. `,
      `With your ${_fm(c.inc)}/mo income and ${_fm(c.sav)} saved, you have interesting options. `
    );
  } else if (profile.wealth === 'low') {
    situation = es(
      `Veo que est√°s construyendo tu base financiera. Podemos trabajar juntos en un plan realista. `,
      `Veig que est√†s construint la teva base financera. Podem treballar junts en un pla realista. `,
      `I see you're building your foundation. We can work together on a realistic plan. `
    );
  } else {
    situation = es(
      `Con ${_fm(c.inc)}/mes y ${_fm(c.sav)} ahorrados, est√°s en el camino correcto. `,
      `Amb ${_fm(c.inc)}/mes i ${_fm(c.sav)} estalviats, est√†s en el cam√≠ correcte. `,
      `With ${_fm(c.inc)}/mo and ${_fm(c.sav)} saved, you're on track. `
    );
  }
  
  return greeting + situation + es("¬øEn qu√© puedo ayudarte?", "En qu√® et puc ajudar?", "How can I help?");
}

    case "thanks": return es(
      `üòä ¬°De nada, ${c.nm}! Estoy aqu√≠ para lo que necesites. Si tienes m√°s dudas sobre tu situaci√≥n en ${c.muni} no dudes en preguntar.`,
      `üòä De res, ${c.nm}! Estic aqu√≠ per al que necessitis. Si tens m√©s dubtes sobre la teva situaci√≥ a ${c.muni} no dubtis a preguntar.`,
      `üòä You're welcome, ${c.nm}! I'm here whenever you need. Feel free to ask anything else about your situation in ${c.muni}.`
    );

    case "capabilities": return es(
      `ü§ñ Puedo ayudarte con: cuotas e hipotecas, estrategias de ahorro, comparar compra vs alquiler, analizar riesgos de tipos de inter√©s, amortizaci√≥n anticipada, ayudas y subvenciones, y mucho m√°s. Todo basado en tus datos reales. ¬°Pregunta lo que quieras!`,
      `ü§ñ Puc ajudar-te amb: quotes i hipoteques, estrat√®gies d'estalvi, comparar compra vs lloguer, analitzar riscos de tipus d'inter√®s, amortitzaci√≥ anticipada, ajudes i subvencions, i molt m√©s. Tot basat en les teves dades reals. Pregunta el que vulguis!`,
      `ü§ñ I can help you with: mortgage payments, savings strategies, buy vs rent comparison, interest rate risks, early repayment, subsidies, and much more. All based on your real data. Ask anything!`
    );

    case "summary": return es(
      `üìä Resumen de tu an√°lisis:\nüè† ${c.muni} ¬∑ ${c.m2}m¬≤ ¬∑ ${c.type}\nüí∞ Precio estimado: ${_fm(c.pb)}\nüìÖ Cuota: ${_fm(c.pay)} (${_fp(c.ratio)} de tus ingresos)\nüè† Alquiler: ${_fm(c.pr)} (${_fp(c.rri)} de tus ingresos)\nüéØ Recomendaci√≥n: ${c.rec}`,
      `üìä Resum de la teva an√†lisi:\nüè† ${c.muni} ¬∑ ${c.m2}m¬≤ ¬∑ ${c.type}\nüí∞ Preu estimat: ${_fm(c.pb)}\nüìÖ Quota: ${_fm(c.pay)} (${_fp(c.ratio)} dels teus ingressos)\nüè† Lloguer: ${_fm(c.pr)} (${_fp(c.rri)} dels teus ingressos)\nüéØ Recomanaci√≥: ${c.rec}`,
      `üìä Your analysis summary:\nüè† ${c.muni} ¬∑ ${c.m2}m¬≤ ¬∑ ${c.type}\nüí∞ Estimated price: ${_fm(c.pb)}\nüìÖ Payment: ${_fm(c.pay)} (${_fp(c.ratio)} of income)\nüè† Rent: ${_fm(c.pr)} (${_fp(c.rri)} of income)\nüéØ Recommendation: ${c.rec}`
    );

    case "buyrent": return es(
      buyOk
        ? `üè† En tu caso, COMPRAR tiene sentido. Tus ahorros (${_fm(c.sav)}) cubren la entrada + gastos (${_fm(c.needCash)}). La cuota de ${_fm(c.pay)} representa el ${_fp(c.ratio)} de tus ingresos, dentro del l√≠mite del 35%. Y planeas quedarte m√°s de 5 a√±os, lo que amortiza los costes de compra.`
        : c.need
          ? `üè† Ahora mismo te recomendar√≠a ALQUILAR. Te faltan ${_fm(c.missing)} para cubrir la entrada + gastos (${_fm(c.needCash)}). Alquilando por ${_fm(c.pr)} al mes puedes seguir ahorrando${c.mosToGoal ? ` y llegar al objetivo en ~${c.mosToGoal} meses` : ""}. Es la opci√≥n m√°s prudente ahora.`
          : `‚ö†Ô∏è Situaci√≥n ajustada. La cuota de ${_fm(c.pay)} supone el ${_fp(c.ratio)} de tus ingresos, por encima del 35% recomendado. El alquiler (${_fm(c.pr)}) es m√°s manejable ahora (${_fp(c.rri)}). Considera esperar o buscar un precio menor.`,
      buyOk
        ? `üè† En el teu cas, COMPRAR t√© sentit. Els teus estalvis (${_fm(c.sav)}) cobreixen l'entrada + despeses (${_fm(c.needCash)}). La quota de ${_fm(c.pay)} √©s el ${_fp(c.ratio)} dels teus ingressos, dins el l√≠mit del 35%.`
        : `üè† Ara et recomanaria LLOGAR. Et falten ${_fm(c.missing)} per cobrir l'entrada + despeses. Llogant per ${_fm(c.pr)} al mes pots continuar estalviant${c.mosToGoal ? ` i arribar a l'objectiu en ~${c.mosToGoal} mesos` : ""}.`,
      buyOk
        ? `üè† In your case, BUYING makes sense. Your savings (${_fm(c.sav)}) cover the down payment + costs (${_fm(c.needCash)}). The ${_fm(c.pay)} monthly payment is ${_fp(c.ratio)} of income, within the 35% limit.`
        : `üè† Right now I'd recommend RENTING. You're ${_fm(c.missing)} short of the down payment + costs. Renting at ${_fm(c.pr)}/month lets you keep saving${c.mosToGoal ? ` and reach the goal in ~${c.mosToGoal} months` : ""}.`
    );

    case "improve": {
      const tips=[];
      if(c.need) tips.push(es(`üí° Ahorra ${_fm(c.msv>0?c.msv:300)}/mes para llegar a los ${_fm(c.needCash)} necesarios${c.mosToGoal?` (~${c.mosToGoal} meses)`:""}`,`üí° Estalvia ${_fm(c.msv>0?c.msv:300)}/mes per arribar als ${_fm(c.needCash)} necessaris${c.mosToGoal?` (~${c.mosToGoal} mesos)`:""}`,`üí° Save ${_fm(c.msv>0?c.msv:300)}/mo to reach the needed ${_fm(c.needCash)}${c.mosToGoal?` (~${c.mosToGoal} months)`:""}`));
      if(c.ratio>35) tips.push(es(`üí° Busca vivienda ~${_fm(c.pb*0.85)} (15% menos) para bajar la cuota a ~${_fm(c.pay*0.85)}`,`üí° Busca habitatge ~${_fm(c.pb*0.85)} (15% menys) per baixar la quota a ~${_fm(c.pay*0.85)}`,`üí° Look for a property ~${_fm(c.pb*0.85)} (15% less) to lower payment to ~${_fm(c.pay*0.85)}`));
      if(!c.hor) tips.push(es(`üí° Si puedes comprometerte m√°s de 5 a√±os, comprar se vuelve m√°s rentable`,`üí° Si pots comprometre't m√©s de 5 anys, comprar es torna m√©s rendible`,`üí° If you can commit to 5+ years, buying becomes more profitable`));
      tips.push(es(`üí° Negocia el tipo: bajar 0,25% ahorra ~${_fm(c.pay*0.008*c.yrs)} en total`,`üí° Negocia el tipus: baixar 0,25% estalvia ~${_fm(c.pay*0.008*c.yrs)} en total`,`üí° Negotiate your rate: 0.25% less saves ~${_fm(c.pay*0.008*c.yrs)} total`));
      tips.push(es(`üí° Amortiza anticipadamente cuando puedas ‚Äî cada ${_fm(1000)} extra reduce intereses futuros`,`üí° Amortitza anticipadament quan puguis ‚Äî cada ${_fm(1000)} extra redueix interessos futurs`,`üí° Make overpayments when possible ‚Äî every ${_fm(1000)} extra reduces future interest`));
      return es("üéØ Pasos concretos para mejorar tu situaci√≥n:\n","üéØ Passos concrets per millorar la teva situaci√≥:\n","üéØ Concrete steps to improve your situation:\n") + tips.join("\n");
    }

    case "savings": return es(
      c.need
        ? `üí∞ Te faltan ${_fm(c.missing)} para la entrada + gastos. ${c.msv>0?`Ahorrando ${_fm(c.msv)}/mes llegar√°s en ~${c.mosToGoal} meses (${(c.mosToGoal/12).toFixed(1)} a√±os).`:"Introduce tu ahorro mensual en el paso 2 para calcular el plazo."} \nüí° Truco: automatiza una transferencia el d√≠a de cobro para no gastar ese dinero.`
        : `‚úÖ ¬°Buenas noticias! Tus ahorros (${_fm(c.sav)}) ya cubren la entrada + gastos (${_fm(c.needCash)}). No necesitas ahorrar m√°s para comprar, pero tener un colch√≥n extra siempre ayuda.`,
      c.need
        ? `üí∞ Et falten ${_fm(c.missing)} per a l'entrada + despeses. ${c.msv>0?`Estalviant ${_fm(c.msv)}/mes arribar√†s en ~${c.mosToGoal} mesos.`:"Introdueix el teu estalvi mensual al pas 2 per calcular el termini."}`
        : `‚úÖ Bones not√≠cies! Els teus estalvis (${_fm(c.sav)}) ja cobreixen l'entrada + despeses (${_fm(c.needCash)}). No cal estalviar m√©s per comprar.`,
      c.need
        ? `üí∞ You're ${_fm(c.missing)} short of the down payment + costs. ${c.msv>0?`Saving ${_fm(c.msv)}/mo you'll get there in ~${c.mosToGoal} months.`:"Enter your monthly savings in step 2 to calculate the timeline."}`
        : `‚úÖ Good news! Your savings (${_fm(c.sav)}) already cover the down payment + costs (${_fm(c.needCash)}). You don't need to save more to buy.`
    );

    case "mortgage": return es(
      `üè¶ Hipoteca para ${_fm(c.pb)}:\nüìä Entrada (${c.dp}%): ${_fm(c.needCash-c.pb*0.11)} + Gastos (~11%): ${_fm(c.pb*0.11)}\nüí∂ Capital: ${_fm(c.cap)} a ${c.yrs} a√±os al ${_fp(c.rate*100)}\nüìÖ Cuota mensual: ${_fm(c.pay)}\nüìà Total pagado: ~${_fm(c.pay*c.yrs*12)}\nüí° El banco suele requerir 24 meses de antig√ºedad laboral y sin deudas.`,
      `üè¶ Hipoteca per ${_fm(c.pb)}:\nüìä Entrada (${c.dp}%): ${_fm(c.needCash-c.pb*0.11)} + Despeses (~11%): ${_fm(c.pb*0.11)}\nüí∂ Capital: ${_fm(c.cap)} a ${c.yrs} anys al ${_fp(c.rate*100)}\nüìÖ Quota mensual: ${_fm(c.pay)}\nüìà Total pagat: ~${_fm(c.pay*c.yrs*12)}`,
      `üè¶ Mortgage for ${_fm(c.pb)}:\nüìä Down payment (${c.dp}%): ${_fm(c.needCash-c.pb*0.11)} + Costs (~11%): ${_fm(c.pb*0.11)}\nüí∂ Principal: ${_fm(c.cap)} over ${c.yrs} years at ${_fp(c.rate*100)}\nüìÖ Monthly payment: ${_fm(c.pay)}\nüìà Total paid: ~${_fm(c.pay*c.yrs*12)}`
    );

    case "payment": return es(
      `üìÖ Tu cuota estimada es ${_fm(c.pay)}/mes.\nüìä Eso es el ${_fp(c.ratio)} de tus ingresos (${_fm(c.inc)}).\n${c.ratio<=30?"‚úÖ Excelente ‚Äî est√°s por debajo del 30%, muy holgado.":c.ratio<=35?"‚úÖ Bien ‚Äî dentro del l√≠mite recomendado del 35%.":"‚ùå Ajustado ‚Äî supera el 35%. Considera una vivienda m√°s barata o un plazo m√°s largo."}\nüí° Capacidad segura (35%): ${_fm(c.safe)}/mes.`,
      `üìÖ La teva quota estimada √©s ${_fm(c.pay)}/mes (${_fp(c.ratio)} dels ingressos).\n${c.ratio<=35?"‚úÖ Dins del l√≠mit recomanat del 35%.":"‚ùå Supera el 35%. Considera una vivenda m√©s barata."}\nüí° Capacitat segura: ${_fm(c.safe)}/mes.`,
      `üìÖ Your estimated payment is ${_fm(c.pay)}/month (${_fp(c.ratio)} of income).\n${c.ratio<=35?"‚úÖ Within the recommended 35% limit.":"‚ùå Above 35%. Consider a cheaper property or longer term."}\nüí° Safe capacity (35%): ${_fm(c.safe)}/month.`
    );

    case "downpayment": return es(
      `üí∞ Entrada necesaria para tu vivienda:\nüè† Precio: ${_fm(c.pb)}\nüìä Entrada (${c.dp}%): ${_fm(c.needCash - Math.round(c.pb*0.11))}\nüìã ITP + notar√≠a + registro (~11%): ${_fm(Math.round(c.pb*0.11))}\nüí∂ Total cash necesario: ${_fm(c.needCash)}\n${c.need?"‚ùå Te faltan "+_fm(c.missing)+(c.mosToGoal?" ‚Äî en ~"+c.mosToGoal+" meses lo tienes":""):"‚úÖ Tus ahorros lo cubren ("+_fm(c.sav)+")"}`,
      `üí∞ Entrada necess√†ria:\nPreu: ${_fm(c.pb)} ¬∑ Entrada (${c.dp}%): ${_fm(c.needCash - Math.round(c.pb*0.11))} ¬∑ ITP+notaria: ${_fm(Math.round(c.pb*0.11))}\nTotal cash: ${_fm(c.needCash)}\n${c.need?"‚ùå Et falten "+_fm(c.missing):"‚úÖ Els teus estalvis ho cobreixen ("+_fm(c.sav)+")"}`,
      `üí∞ Down payment needed:\nPrice: ${_fm(c.pb)} ¬∑ Down (${c.dp}%): ${_fm(c.needCash - Math.round(c.pb*0.11))} ¬∑ Tax+fees (~11%): ${_fm(Math.round(c.pb*0.11))}\nTotal cash: ${_fm(c.needCash)}\n${c.need?"‚ùå You're short "+_fm(c.missing):"‚úÖ Your savings cover it ("+_fm(c.sav)+")"}`
    );

    case "costs": return es(
      `üìã Gastos de compra en Catalunya:\nüèõÔ∏è ITP (Impost Transmissions): ~10% = ${_fm(c.pb*0.10)}\nüìù Notar√≠a: ~0,5% = ${_fm(c.pb*0.005)}\nüìë Registro: ~0,3% = ${_fm(c.pb*0.003)}\nüè¶ Gestoria + tasaci√≥n: ~0,2% = ${_fm(c.pb*0.002)}\nüí∂ Total estimado: ~${_fm(c.pb*0.11)}\nüí° Si es primera vivienda, el ITP puede ser 5% (ahorro de ~${_fm(c.pb*0.05)}).`,
      `üìã Despeses de compra a Catalunya:\nITP: ~10% = ${_fm(c.pb*0.10)} ¬∑ Notaria: ~0,5% ¬∑ Registre: ~0,3%\nTotal estimat: ~${_fm(c.pb*0.11)}\nüí° Primera vivenda: ITP pot ser 5% (estalvi de ~${_fm(c.pb*0.05)}).`,
      `üìã Purchase costs in Catalunya:\nProperty Tax (ITP): ~10% = ${_fm(c.pb*0.10)} ¬∑ Notary: ~0.5% ¬∑ Registry: ~0.3%\nTotal: ~${_fm(c.pb*0.11)}\nüí° First home: ITP may be 5% (saving ~${_fm(c.pb*0.05)}).`
    );

    case "rent": return es(
      `üè† Alquilar en ${c.muni}:\nüí∂ Estimado: ${_fm(c.pr)}/mes (${_fp(c.rri)} de tus ingresos)\n${c.rri<=40?"‚úÖ Dentro del l√≠mite recomendado del 40%.":"‚ö†Ô∏è Supera el 40% ‚Äî ser√≠a ajustado tambi√©n."}\nüí° Ventajas de alquilar ahora: flexibilidad, sin deuda, puedes seguir ahorrando.\nüìä Diferencia cuota vs alquiler: ${_fm(Math.abs(c.pay-c.pr))}/mes ${c.pay>c.pr?"m√°s caro comprar":"m√°s caro alquilar"}.`,
      `üè† Llogar a ${c.muni}: ${_fm(c.pr)}/mes (${_fp(c.rri)} ingressos).\n${c.rri<=40?"‚úÖ Dins del l√≠mit del 40%.":"‚ö†Ô∏è Supera el 40%."}\nüí° Avantatges: flexibilitat, sense deute, pots continuar estalviant.`,
      `üè† Renting in ${c.muni}: ${_fm(c.pr)}/mo (${_fp(c.rri)} of income).\n${c.rri<=40?"‚úÖ Within the 40% limit.":"‚ö†Ô∏è Above 40% ‚Äî also tight."}\nüí° Renting advantages: flexibility, no debt, keep saving.`
    );

    case "price": return es(
      `üè† Precio estimado para ${c.m2}m¬≤ en ${c.muni}: ${_fm(c.pb)} (${Math.round(c.pb/c.m2).toLocaleString("es-ES")} ‚Ç¨/m¬≤).\nüìä Factores incluidos: ${c.bd} habitaciones, ${c.ba} ba√±o(s), ${c.type}${c.extras!=="‚Äî"?", "+c.extras:""}.\nüí° Los precios del Baix Pened√®s son un 40-60% m√°s bajos que Barcelona ciudad ‚Äî una de las zonas con mejor relaci√≥n calidad/precio de Catalu√±a.`,
      `üè† Preu estimat per ${c.m2}m¬≤ a ${c.muni}: ${_fm(c.pb)} (${Math.round(c.pb/c.m2).toLocaleString("ca")} ‚Ç¨/m¬≤).\nüí° El Baix Pened√®s √©s un 40-60% m√©s barat que Barcelona ‚Äî excel¬∑lent relaci√≥ qualitat/preu.`,
      `üè† Estimated price for ${c.m2}m¬≤ in ${c.muni}: ${_fm(c.pb)} (${Math.round(c.pb/c.m2).toLocaleString("en")} ‚Ç¨/m¬≤).\nüí° Baix Pened√®s is 40-60% cheaper than Barcelona ‚Äî great value.`
    );

    case "rates": {
      const r0=c.rate, delta=[0.005,0.01,0.015,0.02];
      const rows=delta.map(d=>{
        const nr=r0+d, np=mort(c.cap,nr,c.yrs);
        return es(`+${(d*100).toFixed(2)}% ‚Üí ${_fm(np)}/mes (+${_fm(np-c.pay)})`,`+${(d*100).toFixed(2)}% ‚Üí ${_fm(np)}/mes (+${_fm(np-c.pay)})`,`+${(d*100).toFixed(2)}% ‚Üí ${_fm(np)}/mo (+${_fm(np-c.pay)})`);
      });
      return es(
        `üìà Sensibilidad al tipo de inter√©s (tipo actual: ${_fp(r0*100)}):\n${rows.join("\n")}\nüí° Un eur√≠bor de +1% subir√≠a tu cuota ~${_fm(mort(c.cap,r0+0.01,c.yrs)-c.pay)}/mes. Pide un tipo fijo o mixto para protegerte.`,
        `üìà Sensibilitat al tipus d'inter√®s (tipus actual: ${_fp(r0*100)}):\n${rows.join("\n")}\nüí° Un eur√≠bor de +1% pujaria la quota ~${_fm(mort(c.cap,r0+0.01,c.yrs)-c.pay)}/mes. Demana tipus fix o mixt.`,
        `üìà Interest rate sensitivity (current rate: ${_fp(r0*100)}):\n${rows.join("\n")}\nüí° Euribor +1% would raise your payment ~${_fm(mort(c.cap,r0+0.01,c.yrs)-c.pay)}/mo. Consider a fixed or mixed rate.`
      );
    }

    case "strategy": return es(
      `üéØ Estrategias para aumentar tu capacidad de compra:\nüí∞ M√°s ahorros: cada ${_fm(10000)} extra de entrada reduce la cuota ~${_fm(mort(c.cap-10000,c.rate,c.yrs)-c.pay)} al mes\nüìÖ Plazo m√°s largo: ${c.yrs<30?"pasar a "+Math.min(40,c.yrs+5)+" a√±os bajar√≠a la cuota ~"+_fm(c.pay-mort(c.cap,c.rate,Math.min(40,c.yrs+5))):"ya est√°s en el plazo m√°ximo recomendable"}\nüè† Precio menor: buscar a ${_fm(c.pb*0.85)} (15% menos) reduce cuota a ~${_fm(mort(c.cap*0.85,c.rate,c.yrs))}\nüìç Municipio m√°s asequible: Bonastre, Maslloren√ß o El Montmell son hasta 50% m√°s baratos que la costa`,
      `üéØ Estrat√®gies per augmentar la capacitat de compra:\nüí∞ M√©s estalvis: cada ${_fm(10000)} extra redueix la quota ~${_fm(mort(c.cap-10000,c.rate,c.yrs)-c.pay)}/mes\nüìÖ Termini m√©s llarg: passant a ${Math.min(40,c.yrs+5)} anys la quota baixaria ~${_fm(c.pay-mort(c.cap,c.rate,Math.min(40,c.yrs+5)))}\nüè† Preu menor: buscar a ${_fm(c.pb*0.85)} redueix la quota a ~${_fm(mort(c.cap*0.85,c.rate,c.yrs))}`,
      `üéØ Strategies to increase buying power:\nüí∞ More savings: each ${_fm(10000)} extra lowers payment ~${_fm(mort(c.cap-10000,c.rate,c.yrs)-c.pay)}/mo\nüìÖ Longer term: going to ${Math.min(40,c.yrs+5)} years lowers payment ~${_fm(c.pay-mort(c.cap,c.rate,Math.min(40,c.yrs+5)))}\nüè† Lower price: find at ${_fm(c.pb*0.85)} to get payment ~${_fm(mort(c.cap*0.85,c.rate,c.yrs))}`
    );

    case "towns": return es(
      `üìç Municipios del Baix Pened√®s seg√∫n perfil:\nüí∞ M√°s asequibles: Bonastre, Maslloren√ß, El Montmell (campo, tranquilos)\nüèñÔ∏è Costa con servicios: El Vendrell (centro comercial), Calafell, Cunit (playa)\n‚öñÔ∏è Equilibrio precio/servicios: L'Arbo√ß, La Bisbal del Pened√®s, Lloren√ß del Pened√®s\nüåø Semirurales cercanos: Santa Oliva, Bellvei, Albinyana\nüí° Actualmente buscas en ${c.muni} a ~${_fm(c.pb)}.`,
      `üìç Municipis del Baix Pened√®s:\nüí∞ M√©s assequibles: Bonastre, Maslloren√ß, El Montmell\nüèñÔ∏è Costa: El Vendrell, Calafell, Cunit\n‚öñÔ∏è Equilibri: L'Arbo√ß, La Bisbal, Lloren√ß\nüí° Ara busques a ${c.muni} a ~${_fm(c.pb)}.`,
      `üìç Baix Pened√®s municipalities:\nüí∞ Most affordable: Bonastre, Maslloren√ß, El Montmell\nüèñÔ∏è Coastal: El Vendrell, Calafell, Cunit\n‚öñÔ∏è Balanced: L'Arbo√ß, La Bisbal, Lloren√ß\nüí° You're currently looking in ${c.muni} at ~${_fm(c.pb)}.`
    );

    case "risk": return es(
      `‚ö†Ô∏è An√°lisis de riesgos para tu situaci√≥n:\n${c.ratio>35?"‚ùå Esfuerzo hipoteca alto ("+_fp(c.ratio)+") ‚Äî riesgo si bajan ingresos\n":"‚úÖ Esfuerzo hipoteca OK ("+_fp(c.ratio)+")\n"}${c.rate<0.04?"‚ö†Ô∏è Tipo variable ("+_fp(c.rate*100)+") ‚Äî vulnerabilidad a subida eur√≠bor\n":"‚úÖ Tipo defensivo ("+_fp(c.rate*100)+")\n"}üí° Recomendaci√≥n: fondo de emergencia de 6 meses (${_fm(c.inc*6)}) antes de comprar.`,
      `‚ö†Ô∏è An√†lisi de riscos:\n${c.ratio>35?"‚ùå Esfor√ß hipoteca alt ("+_fp(c.ratio)+")\n":"‚úÖ Esfor√ß OK ("+_fp(c.ratio)+")\n"}üí° Fons d'emerg√®ncia recomanat: ${_fm(c.inc*6)} (6 mesos d'ingressos).`,
      `‚ö†Ô∏è Risk analysis:\n${c.ratio>35?"‚ùå High mortgage effort ("+_fp(c.ratio)+")\n":"‚úÖ Mortgage effort OK ("+_fp(c.ratio)+")\n"}üí° Recommended emergency fund: ${_fm(c.inc*6)} (6 months of income).`
    );

    case "amortize": return es(
      `üí° Amortizaci√≥n anticipada ‚Äî ¬ømerece la pena?\n‚úÖ S√≠, siempre que no tengas comisi√≥n de cancelaci√≥n.\nEjemplo: amortizar ${_fm(5000)} extra ahora ahorra ~${_fm(5000*c.rate*c.yrs*0.5)} en intereses a lo largo de la hipoteca.\nüìä Cu√°nto antes amortices, m√°s ahorras (efecto bola de nieve al rev√©s).\nüí° Amortiza en enero si puedes ‚Äî el banco recalcula desde el inicio del a√±o.`,
      `üí° Amortitzaci√≥ anticipada:\nAmortitzar ${_fm(5000)} extra ara estalvia ~${_fm(5000*c.rate*c.yrs*0.5)} en interessos.\n‚úÖ Sempre que no hi hagi comissi√≥ de cancel¬∑laci√≥.`,
      `üí° Early repayment:\nPaying ${_fm(5000)} extra now saves ~${_fm(5000*c.rate*c.yrs*0.5)} in interest over the life of the mortgage.\n‚úÖ Worthwhile if there's no early repayment fee.`
    );

    case "term": return es(
      `üìÖ Plazo de hipoteca ‚Äî an√°lisis comparativo:\n‚è≥ ${c.yrs} a√±os (actual): cuota ${_fm(c.pay)}\n‚¨áÔ∏è ${Math.max(15,c.yrs-5)} a√±os: cuota ${_fm(mort(c.cap,c.rate,Math.max(15,c.yrs-5)))} (+${_fm(mort(c.cap,c.rate,Math.max(15,c.yrs-5))-c.pay)}/mes, menos intereses)\n‚¨ÜÔ∏è ${Math.min(40,c.yrs+5)} a√±os: cuota ${_fm(mort(c.cap,c.rate,Math.min(40,c.yrs+5)))} (-${_fm(c.pay-mort(c.cap,c.rate,Math.min(40,c.yrs+5)))}/mes, m√°s intereses)\nüí° Ajusta en el paso 2 para ver el impacto en tiempo real.`,
      `üìÖ Termini d'hipoteca:\n${c.yrs} anys (actual): ${_fm(c.pay)}/mes ¬∑ ${Math.max(15,c.yrs-5)} anys: ${_fm(mort(c.cap,c.rate,Math.max(15,c.yrs-5)))}/mes ¬∑ ${Math.min(40,c.yrs+5)} anys: ${_fm(mort(c.cap,c.rate,Math.min(40,c.yrs+5)))}/mes`,
      `üìÖ Mortgage term:\n${c.yrs} years (current): ${_fm(c.pay)}/mo ¬∑ ${Math.max(15,c.yrs-5)} years: ${_fm(mort(c.cap,c.rate,Math.max(15,c.yrs-5)))}/mo ¬∑ ${Math.min(40,c.yrs+5)} years: ${_fm(mort(c.cap,c.rate,Math.min(40,c.yrs+5)))}/mo`
    );

    case "subsidy": return es(
      `üèõÔ∏è Ayudas disponibles en Catalunya:\n‚úÖ ITP reducido al 5% para primera vivienda habitual (ahorro ~${_fm(c.pb*0.05)})\n‚úÖ Deducci√≥n IRPF auton√≥mica por compra de primera vivienda (hasta 1.140‚Ç¨/a√±o)\n‚úÖ Joves fins 32 anys: possible bonificaci√≥ addicional\n‚úÖ Habitatge assequible: si ingressos <${_fm(c.inc*1.8)}, pot haver-hi acc√©s a HPO\nüìû Consulta a l'Ag√®ncia de l'Habitatge de Catalunya o l'ajuntament de ${c.muni}.`,
      `üèõÔ∏è Ajudes disponibles a Catalunya:\n‚úÖ ITP redu√Øt al 5% per primera vivenda (estalvi ~${_fm(c.pb*0.05)})\n‚úÖ Deducci√≥ IRPF auton√≤mica fins 1.140‚Ç¨/any\n‚úÖ Joves fins 32 anys: possible bonificaci√≥ addicional\nüìû Consulta a l'Ag√®ncia de l'Habitatge de Catalunya.`,
      `üèõÔ∏è Available subsidies in Catalunya:\n‚úÖ Reduced ITP (5%) for first home (saving ~${_fm(c.pb*0.05)})\n‚úÖ Regional income tax deduction up to 1.140‚Ç¨/year\n‚úÖ Under 32: possible additional bonus\nüìû Check with the Ag√®ncia de l'Habitatge de Catalunya.`
    );

    case "firsthome": return es(
      `üè† Ventajas de primera vivienda:\n‚úÖ Entrada reducida al 10% (vs 20%) ‚Üí menos cash: ${_fm(c.pb*0.10+c.pb*0.11)} vs ${_fm(c.pb*0.20+c.pb*0.11)}\n‚úÖ ITP al 5% en lugar del 10% ‚Üí ahorro: ${_fm(c.pb*0.05)}\n‚úÖ Posible deducci√≥n IRPF auton√≥mica\nüí° Condici√≥n: vivir en ella m√°s de 3 a√±os como residencia habitual.`,
      `üè† Avantatges primera vivenda:\n‚úÖ Entrada 10% (vs 20%) ‚Üí menys cash\n‚úÖ ITP al 5% ‚Üí estalvi: ${_fm(c.pb*0.05)}\nüí° Cal viure-hi com a resid√®ncia habitual m√©s de 3 anys.`,
      `üè† First home benefits:\n‚úÖ Lower down payment (10% vs 20%)\n‚úÖ Reduced ITP (5%) ‚Üí saving: ${_fm(c.pb*0.05)}\nüí° You must live there as main residence for 3+ years.`
    );

    case "inflation": return es(
      `üìà Inflaci√≥n e inmobiliario:\nüí° Hist√≥ricamente, la vivienda en zona costera catalana sube ~3-4% anual a largo plazo ‚Äî ligeramente por encima de la inflaci√≥n.\nüè† A precio actual (${_fm(c.pb)}), en 10 a√±os podr√≠a valer ~${_fm(c.pb*Math.pow(1.035,10))}.\n‚ö†Ô∏è Pero rentabilidad pasada no garantiza futura. No compres solo como inversi√≥n ‚Äî compra si lo necesitas para vivir.`,
      `üìà Inflaci√≥ i immobiliari:\nüí° La vivenda costera catalana puja ~3-4% anual a llarg termini.\nüè† En 10 anys ${_fm(c.pb)} podria valer ~${_fm(c.pb*Math.pow(1.035,10))}.\n‚ö†Ô∏è Rendibilitat passada no garanteix futura.`,
      `üìà Inflation & real estate:\nüí° Coastal Catalan property historically rises ~3-4% annually.\nüè† In 10 years ${_fm(c.pb)} could be worth ~${_fm(c.pb*Math.pow(1.035,10))}.\n‚ö†Ô∏è Past returns don't guarantee future results.`
    );

    case "compare": return es(
      `üó∫Ô∏è ${c.muni} vs otras zonas:\nüìç ${c.muni}: ~${Math.round(c.pb/c.m2).toLocaleString("es-ES")} ‚Ç¨/m¬≤ ¬∑ alquiler ~${_fm(c.pr)}/mes\nüìç Barcelona ciudad: ~4.500-5.500 ‚Ç¨/m¬≤ ¬∑ alquiler ~1.800-2.500‚Ç¨/mes\nüìç Tarragona capital: ~1.800-2.200 ‚Ç¨/m¬≤ ¬∑ alquiler ~900-1.200‚Ç¨/mes\nüí° El Baix Pened√®s ofrece playa, tranquilidad y conexi√≥n por tren a Barcelona en ~45 min.`,
      `üó∫Ô∏è ${c.muni} vs altres zones:\nüìç ${c.muni}: ~${Math.round(c.pb/c.m2).toLocaleString("ca")} ‚Ç¨/m¬≤\nüìç Barcelona: ~4.500-5.500 ‚Ç¨/m¬≤\nüìç Tarragona: ~1.800-2.200 ‚Ç¨/m¬≤\nüí° Baix Pened√®s: platja, tranquil¬∑litat i tren a Barcelona en ~45 min.`,
      `üó∫Ô∏è ${c.muni} vs other areas:\nüìç ${c.muni}: ~${Math.round(c.pb/c.m2).toLocaleString("en")} ‚Ç¨/m¬≤\nüìç Barcelona city: ~4,500-5,500 ‚Ç¨/m¬≤\nüìç Tarragona: ~1,800-2,200 ‚Ç¨/m¬≤\nüí° Baix Pened√®s: beach, calm, train to Barcelona in ~45 min.`
    );

    case "income": return es(
      `üí∂ Sobre tus ingresos (${_fm(c.inc)}/mes):\n‚úÖ Capacidad segura hipoteca (35%): ${_fm(c.safe)}/mes\nüìä Tu cuota actual (${_fm(c.pay)}) es el ${_fp(c.ratio)} ‚Üí ${c.ratio<=35?"‚úÖ OK":"‚ùå elevado"}\nüí° Para comprar una vivienda de ${_fm(c.pb)} sin esfuerzo, necesitar√≠as ingresos de ~${_fm(c.pay/0.30)}/mes.`,
      `üí∂ Sobre els teus ingressos (${_fm(c.inc)}/mes):\nCapacitat segura (35%): ${_fm(c.safe)}/mes ¬∑ Quota actual: ${_fm(c.pay)} (${_fp(c.ratio)}) ‚Üí ${c.ratio<=35?"‚úÖ OK":"‚ùå elevat"}\nüí° Per comprar sense esfor√ß caldrien ~${_fm(c.pay/0.30)}/mes.`,
      `üí∂ About your income (${_fm(c.inc)}/mo):\nSafe mortgage capacity (35%): ${_fm(c.safe)}/mo ¬∑ Your payment: ${_fm(c.pay)} (${_fp(c.ratio)}) ‚Üí ${c.ratio<=35?"‚úÖ OK":"‚ùå high"}\nüí° To buy comfortably you'd need ~${_fm(c.pay/0.30)}/mo income.`
    );

    case "size": return es(
      `üìê Sobre el tama√±o (${c.m2}m¬≤):\nüí∞ Precio actual: ${_fm(c.pb)} (${Math.round(c.pb/c.m2).toLocaleString("es-ES")} ‚Ç¨/m¬≤)\nüìä +10m¬≤: ~${_fm(c.pb + c.pb/c.m2*10)} ¬∑ -10m¬≤: ~${_fm(c.pb - c.pb/c.m2*10)}\nüí° Reducir 10m¬≤ ahorrar√≠a ~${_fm(c.pb/c.m2*10)} en precio y ~${_fm(mort(c.pb/c.m2*10*0.9,c.rate,c.yrs))} al mes en cuota.`,
      `üìê Sobre la mida (${c.m2}m¬≤):\n${Math.round(c.pb/c.m2).toLocaleString("ca")} ‚Ç¨/m¬≤ ¬∑ +10m¬≤: ~${_fm(c.pb+c.pb/c.m2*10)} ¬∑ -10m¬≤: ~${_fm(c.pb-c.pb/c.m2*10)}`,
      `üìê About the size (${c.m2}m¬≤):\n${Math.round(c.pb/c.m2).toLocaleString("en")} ‚Ç¨/m¬≤ ¬∑ +10m¬≤: ~${_fm(c.pb+c.pb/c.m2*10)} ¬∑ -10m¬≤: ~${_fm(c.pb-c.pb/c.m2*10)}`
    );

    case "extras": return es(
      `üèä Extras seleccionados: ${c.extras}\nüí° Cada extra incrementa el precio estimado:\n‚úÖ Terraza: +5% ¬∑ üèä Piscina: +8% ¬∑ üõó Ascensor: +4% ¬∑ üöó Garaje: +3%\nüí° Quitar extras que no uses puede bajar el precio considerablemente. El garaje en zonas con parking p√∫blico a veces no vale la pena.`,
      `üèä Extres seleccionats: ${c.extras}\nüí° Cada extra incrementa el preu: Terrassa +5% ¬∑ Piscina +8% ¬∑ Ascensor +4% ¬∑ Garatge +3%.`,
      `üèä Selected extras: ${c.extras}\nüí° Each extra increases estimated price: Terrace +5% ¬∑ Pool +8% ¬∑ Elevator +4% ¬∑ Parking +3%.`
    );

    case "negotiation": return es(
      `ü§ù Checklist de negociaci√≥n (r√°pido):
1) Lleva 3 comparables reales de la zona (‚Ç¨/m¬≤).
2) Abre oferta un 8-12% por debajo de tu tope.
3) Prioriza precio + arras + plazo de firma (pack completo).
4) Pide revisi√≥n t√©cnica y usa incidencias para ajustar precio.
5) No superes tu l√≠mite: ${_fm(c.pb*(c.ratio>35?0.90:1))}.
üí° Si quieres, te preparo un guion de llamada al vendedor.`,
      `ü§ù Checklist de negociaci√≥:
1) Porta 3 comparables reals de la zona.
2) Obre oferta 8-12% per sota del teu topall.
3) Negocia preu + arres + termini de signatura.
4) Revisa incid√®ncies t√®cniques per ajustar preu.
5) No superis el teu l√≠mit: ${_fm(c.pb*(c.ratio>35?0.90:1))}.`,
      `ü§ù Negotiation checklist:
1) Bring 3 local comparables (‚Ç¨/m¬≤).
2) Start 8-12% below your max budget.
3) Negotiate price + deposit terms + closing date as a package.
4) Use technical issues to support price adjustments.
5) Do not exceed your cap: ${_fm(c.pb*(c.ratio>35?0.90:1))}.`
    );

    case "actionplan": {
      const gap=Math.max(0,c.needCash-c.sav);
      const msv=Math.max(0,c.msv||0);
      const mos=(gap>0&&msv>0)?Math.ceil(gap/msv):0;
      return es(
        `üß≠ Plan de acci√≥n en 90 d√≠as:
1) Semana 1: fija presupuesto de vivienda en torno a ${_fm(c.pb*(c.ratio>35?0.85:1))}.
2) Semana 2-3: reduce gastos fijos para liberar al menos ${_fm(Math.max(100,c.inc*0.08))}/mes.
3) Mes 2: mejora perfil bancario (sin descubiertos y recibos al d√≠a).
4) Mes 3: compara 3 hipotecas y pide preaprobaci√≥n.
${gap>0?`5) Objetivo ahorro: te faltan ${_fm(gap)}${msv>0?` (~${mos} meses a ${_fm(msv)}/mes).`:"."}`:`5) Ya cubres la entrada+gastos: prioriza negociar precio y condiciones.`}
‚úÖ Si quieres, te preparo un plan semanal detallado.`,
        `üß≠ Pla d'acci√≥ en 90 dies:
1) Defineix pressupost de compra (~${_fm(c.pb*(c.ratio>35?0.85:1))}).
2) Allibera despesa fixa mensual i refor√ßa estalvi.
3) Millora perfil bancari i demana preaprovaci√≥.
4) Compara 3 hipoteques abans de decidir.
${gap>0?`5) Et falten ${_fm(gap)}${msv>0?` (~${mos} mesos).`:"."}`:`5) Ja tens estalvi suficient: prioritza negociaci√≥.`}`,
        `üß≠ 90-day action plan:
1) Set a target budget around ${_fm(c.pb*(c.ratio>35?0.85:1))}.
2) Free monthly cashflow and boost savings.
3) Improve bank profile and request pre-approval.
4) Compare at least 3 mortgage offers.
${gap>0?`5) Savings gap: ${_fm(gap)}${msv>0?` (~${mos} months).`:"."}`:`5) You already cover upfront cash: focus on price/terms negotiation.`}`
      );
    }

    case "advice": {
  let advice = es("üéØ Mi consejo personalizado:\n\n", "üéØ El meu consell:\n\n", "üéØ My advice:\n\n");
  
  if (profile.wealth === 'high' && profile.age_group === 'young') {
    advice += es(
      `Est√°s en posici√≥n privilegiada. A tu edad con tu capacidad:\n\n` +
      `‚Ä¢ Compra pronto para beneficiarte de a√±os de revalorizaci√≥n\n` +
      `‚Ä¢ No te conformes ‚Äî busca calidad y ubicaci√≥n\n` +
      `‚Ä¢ Considera hipoteca <60% y amortiza agresivamente\n` +
      `‚Ä¢ Tu ventaja: tiempo + capital = libertad`,
      `Est√†s en posici√≥ privilegiada. A la teva edat amb la teva capacitat:\n\n` +
      `‚Ä¢ Comprar aviat per beneficiar-te d'anys de revaloritzaci√≥\n` +
      `‚Ä¢ No et conformis ‚Äî cerca qualitat i ubicaci√≥\n` +
      `‚Ä¢ Considera hipoteca <60% i amortitza agressivament\n` +
      `‚Ä¢ El teu avantatge: temps + capital = llibertat`,
      `You're in a privileged position. At your age with your finances:\n\n` +
      `‚Ä¢ Buy soon to benefit from years of appreciation\n` +
      `‚Ä¢ Don't settle ‚Äî seek quality and location\n` +
      `‚Ä¢ Consider <60% mortgage and pay it down aggressively\n` +
      `‚Ä¢ Your advantage: time + capital = freedom`
    );
  } else if (profile.wealth === 'low' && profile.age_group === 'adult') {
    advice += es(
      `${tone}, pero no te desanimes:\n\n` +
      `‚Ä¢ Prioriza ahorro constante (aunque sea ${_fm(200)}/mes)\n` +
      `‚Ä¢ Alquiler es estrategia temporal inteligente\n` +
      `‚Ä¢ Busca zonas m√°s asequibles (hasta 50% m√°s barato)\n` +
      `‚Ä¢ Comprar no es imposible, solo requiere paciencia`,
      `${tone}, per√≤ no et desanimis:\n\n` +
      `‚Ä¢ Prioritza estalvi constant (encara que sigui ${_fm(200)}/mes)\n` +
      `‚Ä¢ Lloguer √©s estrat√®gia temporal intel¬∑ligent\n` +
      `‚Ä¢ Cerca zones m√©s assequibles\n` +
      `‚Ä¢ Comprar no √©s impossible, nom√©s cal paci√®ncia`,
      `${tone}, but don't get discouraged:\n\n` +
      `‚Ä¢ Prioritize consistent saving (even ${_fm(200)}/mo)\n` +
      `‚Ä¢ Renting is a smart temporary strategy\n` +
      `‚Ä¢ Look in more affordable areas\n` +
      `‚Ä¢ Buying isn't impossible, just requires patience`
    );
  } else if (profile.age_group === 'senior') {
    advice += es(
      `A tu edad, mis recomendaciones cambian:\n\n` +
      `‚Ä¢ Eval√∫a si comprar sigue siendo prioritario\n` +
      `‚Ä¢ Plazo hipotecario corto (15-20 a√±os m√°ximo)\n` +
      `‚Ä¢ Prioriza tranquilidad sobre revalorizaci√≥n\n` +
      `‚Ä¢ Tu prioridad: calidad de vida > inversi√≥n`,
      `A la teva edat, les meves recomanacions canvien:\n\n` +
      `‚Ä¢ Avalua si comprar segueix sent prioritari\n` +
      `‚Ä¢ Termini hipotecari curt (15-20 anys m√†xim)\n` +
      `‚Ä¢ Prioritza tranquil¬∑litat sobre revaloritzaci√≥\n` +
      `‚Ä¢ La teva prioritat: qualitat de vida > inversi√≥`,
      `At your age, my recommendations are different:\n\n` +
      `‚Ä¢ Evaluate if buying is still a priority\n` +
      `‚Ä¢ Shorter mortgage term (15-20 years max)\n` +
      `‚Ä¢ Prioritize peace of mind over appreciation\n` +
      `‚Ä¢ Your priority: quality of life > investment`
    );
  } else {
    advice += es(
      `${tone}. Recomendaci√≥n equilibrada:\n\n` +
      `‚Ä¢ Respeta tu l√≠mite del 35% de esfuerzo\n` +
      `‚Ä¢ Compara municipios activamente\n` +
      `‚Ä¢ Hipoteca mixta para protecci√≥n\n` +
      `‚Ä¢ Mant√©n fondo emergencia 6 meses\n` +
      `‚Ä¢ Tu estrategia: prudencia + consistencia`,
      `${tone}. Recomanaci√≥ equilibrada:\n\n` +
      `‚Ä¢ Respecta el l√≠mit del 35% d'esfor√ß\n` +
      `‚Ä¢ Compara municipis activament\n` +
      `‚Ä¢ Hipoteca mixta per protecci√≥\n` +
      `‚Ä¢ Mant√© fons d'emerg√®ncia 6 mesos\n` +
      `‚Ä¢ La teva estrat√®gia: prud√®ncia + consist√®ncia`,
      `${tone}. Balanced recommendation:\n\n` +
      `‚Ä¢ Respect your 35% effort limit\n` +
      `‚Ä¢ Actively compare municipalities\n` +
      `‚Ä¢ Mixed mortgage for protection\n` +
      `‚Ä¢ Keep 6-month emergency fund\n` +
      `‚Ä¢ Your strategy: prudence + consistency`
    );
  }
  
  return advice;
}


    case "bye": return es(
      `üëã ¬°Hasta pronto, ${c?c.nm:""}! Recuerda que aqu√≠ estar√© cuando necesites revisar tu an√°lisis. ¬°Mucha suerte con tu b√∫squeda!`,
      `üëã Fins aviat${c?" "+c.nm:""}! Recorda que ser√© aqu√≠ quan necessitis revisar el teu an√†lisi. Molta sort!`,
      `üëã Bye${c?" "+c.nm:""}! I'll be here whenever you need to review your analysis. Good luck with your search!`
    );

    case "market": return es(
      `üìà Mercado inmobiliario en el Baix Pened√®s:\nüîç 2024-2025: demanda sostenida por migraci√≥n desde Barcelona (+teletrajo)\nüìä Precios costeros: +4-6% anual en los √∫ltimos 3 a√±os\nüè† Oferta limitada en municipios costeros (Cunit, Calafell)\nüí° El interior (Bonastre, Montmell) ofrece mejor precio/m¬≤ pero menos liquidez\n‚ö†Ô∏è Nadie puede predecir el mercado a corto plazo con certeza.`,
      `üìà Mercat immobiliari al Baix Pened√®s:\nDemanda sostinguda per migraci√≥ des de Barcelona ¬∑ Preus costaners: +4-6%/any\nüí° L'interior ofereix millor preu/m¬≤ per√≤ menys liquiditat.`,
      `üìà Baix Pened√®s real estate market:\nSustained demand from Barcelona migration (+remote work) ¬∑ Coastal prices: +4-6%/year\nüí° Inland areas offer better ‚Ç¨/m¬≤ but less liquidity.`
    );

    case "weather": return es(
      `‚òÄÔ∏è ¬°Eso se lo dejo al meteor√≥logo! Pero s√≠ te digo que el Baix Pened√®s tiene ~300 d√≠as de sol al a√±o y veranos suaves gracias a la brisa marina ‚Äî un factor que muchos valoran al comprar vivienda aqu√≠. ¬øTe ayudo con algo de tu an√°lisis?`,
      `‚òÄÔ∏è Deixo el temps als meteor√≤legs! Per√≤ s√≠ que el Baix Pened√®s t√© ~300 dies de sol i estius suaus gr√†cies a la brisa marina. ¬øT'ajudo amb alguna cosa del teu an√†lisi?`,
      `‚òÄÔ∏è Weather is not my specialty! But I can tell you Baix Pened√®s has ~300 sunny days per year and mild summers thanks to the sea breeze ‚Äî a factor many value when buying here. Anything else I can help with?`
    );

    case "joke": return es(
      `üòÑ ¬øPor qu√© el banco siempre llega tarde a las reuniones? ¬°Porque siempre est√° en mora! üòÇ\nEn serio, te ayudo mejor con tu hipoteca. ¬øQu√© quieres saber?`,
      `üòÑ Per qu√® el banc sempre arriba tard? Perqu√® sempre est√† en mora! üòÇ\nEn serio, et puc ajudar millor amb la teva hipoteca.`,
      `üòÑ Why did the bank teller break up with the mortgage? Too many interest issues! üòÇ\nSeriously though, I'm much better at helping with your financial analysis. What would you like to know?`
    );

    case "identity": return es(
      `ü§ñ Soy el asesor financiero integrado en esta aplicaci√≥n. Estoy especializado en vivienda en el Baix Pened√®s y conozco tu an√°lisis al completo. No soy ChatGPT ni ninguna IA de pago ‚Äî soy un motor de conocimiento financiero local, gratuito y siempre disponible. ¬øEn qu√© te ayudo?`,
      `ü§ñ S√≥c l'assessor financer integrat en aquesta aplicaci√≥. Estic especialitzat en habitatge al Baix Pened√®s. S√≥c un motor de coneixement financer local, gratu√Øt i sempre disponible.`,
      `ü§ñ I'm the financial advisor built into this application. I specialize in Baix Pened√®s housing and know your full analysis. I'm not ChatGPT ‚Äî I'm a local, free, always-available financial knowledge engine. How can I help?`
    );

    case "philosophy": return es(
      `ü§î Buena pregunta existencial. Aunque sobre el sentido de la vida no tengo una respuesta clara, sobre el sentido de comprar vs alquilar en ${c?c.muni:"el Baix Pened√®s"} s√≠ que puedo ayudarte. ¬øSeguimos?`,
      `ü§î Bona pregunta existencial! Sobre el sentit de la vida no tinc resposta, per√≤ sobre comprar o llogar a ${c?c.muni:"el Baix Pened√®s"} s√≠. Continuem?`,
      `ü§î Deep question! I don't have the meaning of life, but I do have solid advice on buying vs renting in ${c?c.muni:"Baix Pened√®s"}. Shall we continue?`
    );

    case "sport": return es(
      `‚öΩ ¬°Gran tema! Pero mi especialidad es marcar goles financieros, no futbol√≠sticos. ${c?"Tu an√°lisis muestra "+c.rec+" ‚Äî eso s√≠ es un golazo. ":""}¬øTe ayudo con algo de tu b√∫squeda de vivienda?`,
      `‚öΩ Gran tema, per√≤ la meva especialitat √©s marcar gols financers! ${c?"El teu an√†lisi diu "+c.rec+" ‚Äî aix√≤ s√≠ √©s un gol√†s. ":""}T'ajudo amb alguna cosa del teu habitatge?`,
      `‚öΩ Great topic! But my specialty is financial goals, not football ones. ${c?"Your analysis says "+c.rec+" ‚Äî now that's a great result. ":""}Need help with your housing search?`
    );

    case "food": return es(
      `üçΩÔ∏è ¬°Buena vida! El Baix Pened√®s tiene cava, vino, y la gastronom√≠a del Camp de Tarragona. Pero sobre lo que s√© de verdad es de hipotecas y vivienda. ${c?"Tu vivienda en "+c.muni+" ya la tenemos analizada. ":""}¬øAlgo m√°s financiero?`,
      `üçΩÔ∏è Bona vida! El Baix Pened√®s t√© cava, vi i la gastronomia del Camp de Tarragona. Per√≤ el meu fort s√≥n les hipoteques. Alguna cosa m√©s financera?`,
      `üçΩÔ∏è Great taste! Baix Pened√®s has cava, wine, and great local cuisine. But mortgages are my specialty. Anything financial I can help with?`
    );

    case "wine": return es(
      `üç∑ ¬°El Pened√®s es la DO m√°s importante de Catalu√±a! Cava, Xarel¬∑lo, Macabeu... y encima los precios de la vivienda son asequibles. Si compras aqu√≠, vivir√°s rodeado de vi√±edos. ${c?"Tu an√°lisis para "+c.muni+" est√° listo ‚Äî ¬øquieres revisarlo?":"¬øBuscas vivienda en la zona vin√≠cola?"}`,
      `üç∑ El Pened√®s √©s la DO m√©s important de Catalunya! I els preus de l'habitatge s√≥n assequibles. ${c?"El teu an√†lisi per a "+c.muni+" est√† llest.":"Busques habitatge a la zona vin√≠cola?"}`,
      `üç∑ Pened√®s is Catalonia's most important wine region! And housing prices are affordable. ${c?"Your analysis for "+c.muni+" is ready ‚Äî want to review it?":"Looking for a home in wine country?"}`
    );

    case "beach": return es(
      `üèñÔ∏è El Baix Pened√®s tiene kil√≥metros de costa en Calafell, Cunit y El Vendrell. ${c&&(c.muni.includes("Calafell")||c.muni.includes("Cunit"))?"¬°Est√°s buscando justo en zona de playa! El precio estimado ("+_fm(c.pb)+") ya incluye la prima costera.":"Municipios costeros como Calafell o Cunit son m√°s caros pero tienen la playa a 5 min."} ¬øAlgo m√°s?`,
      `üèñÔ∏è El Baix Pened√®s t√© quil√≤metres de costa. ${c?"Est√†s buscant a "+c.muni+".":""} Municipis costaners com Calafell o Cunit s√≥n m√©s cars per√≤ tens la platja a 5 min.`,
      `üèñÔ∏è Baix Pened√®s has kilometres of coastline. ${c&&(c.muni.includes("Calafell")||c.muni.includes("Cunit"))?"You're looking in a coastal area! The estimated price ("+_fm(c.pb)+") already includes the coastal premium.":"Coastal towns like Calafell or Cunit are pricier but the beach is 5 min away."}`
    );

    case "transport": return es(
      `üöÇ El Baix Pened√®s tiene buena comunicaci√≥n: tren Rodalies a Barcelona (~45 min desde El Vendrell), AP-7 y N-340. ${c?"Desde "+c.muni+" la conexi√≥n es "+((c.muni.includes("Vendrell")||c.muni.includes("Calafell")||c.muni.includes("Cunit"))?"excelente (tren directo)":"buena (coche o bus a estaci√≥n).")+"":" "} Un factor que sube el valor de la vivienda a largo plazo.`,
      `üöÇ Tren Rodalies a Barcelona (~45 min des del Vendrell), AP-7 i N-340. Un factor que puja el valor de l'habitatge a llarg termini.`,
      `üöÇ Good transport links: Rodalies train to Barcelona (~45 min from El Vendrell), AP-7 motorway. A factor that supports long-term property values.`
    );
        default: return buildUniversalFallbackReply(msg,L);
  }
};

// ============ FUNCIONES AUXILIARES CHAT ============

// Limpiar markdown simple
const stripMd = (text) => {
  return text
    .replace(/\*\*(.+?)\*\*/g, '$1')
    .replace(/\*(.+?)\*/g, '$1')
    .replace(/`(.+?)`/g, '$1')
    .replace(/^#+\s+/gm, '')
    .replace(/\[(.+?)\]\(.+?\)/g, '$1');
};

const escapeHTML=(text="")=>String(text)
  .replaceAll("&","&amp;")
  .replaceAll("<","&lt;")
  .replaceAll(">","&gt;")
  .replaceAll('"',"&quot;")
  .replaceAll("'","&#39;");

// A√±adir mensaje al chat
const addMsg = (role, content) => {
  const mc = Q("#chatMessages");
  if (!mc) return;
  
  const d = document.createElement("div");
  d.className = `chat-message ${role}`;
  
  const av = document.createElement("div");
  av.className = `chat-avatar ${role}`;
  av.textContent = role === "user" ? (t("aiYou") || "T√ö") : "AI";
  
  const bub = document.createElement("div");
  bub.className = "chat-bubble";
  bub.innerHTML = escapeHTML(stripMd(content)).replace(/\n/g, "<br>");
  
  if (role === "user") {
    d.appendChild(bub);
    d.appendChild(av);
  } else {
    d.appendChild(av);
    d.appendChild(bub);
  }
  
  mc.appendChild(d);
  mc.scrollTop = mc.scrollHeight;
};

// A√±adir indicador "pensando"
const addThinking = () => {
  const mc = Q("#chatMessages");
  if (!mc) return;
  
  const d = document.createElement("div");
  d.className = "chat-message ai";
  d.id = "thinking-indicator";
  
  const av = document.createElement("div");
  av.className = "chat-avatar ai";
  av.textContent = "AI";
  
  const bub = document.createElement("div");
  bub.className = "chat-bubble thinking";
  bub.textContent = t("aiThinking") || "Analizando...";
  
  d.appendChild(av);
  d.appendChild(bub);
  mc.appendChild(d);
  mc.scrollTop = mc.scrollHeight;
};

// Remover indicador "pensando"
const removeThinking = () => {
  const thinking = Q("#thinking-indicator");
  if (thinking) thinking.remove();
};

/* ---- Motor principal: simula escritura progresiva ---- */
const sendToAI=async msg=>{
  if(isAIProcessing)return;
  isAIProcessing=true;
  const btnEl=Q("#chatSend"), inpEl=Q("#chatInput");
  if(btnEl)btnEl.disabled=true;
  if(inpEl){inpEl.disabled=true;inpEl.value="";}
  addMsg("user",msg);
  chatHistory.push({role:"user",content:msg});
  addThinking();
  const delay=500+Math.random()*700;
  await new Promise(r=>setTimeout(r,delay));
  removeThinking();
  const intent=detectIntent(msg);
  const reply=buildReply(intent,msg);
  chatHistory.push({role:"assistant",content:reply});
  if(chatHistory.length>40)chatHistory=chatHistory.slice(-40);
  saveChatHistory();
  // Efecto typing usando intervalo (m√°s robusto que recursi√≥n)
  const mc=Q("#chatMessages");
  const d=document.createElement("div");
  d.className="chat-message ai";
  const av=document.createElement("div");
  av.className="chat-avatar ai";av.textContent="AI";
  const bub=document.createElement("div");
  bub.className="chat-bubble";
  d.appendChild(av);d.appendChild(bub);
  if(mc)mc.appendChild(d);
  const clean=escapeHTML(stripMd(reply));
  let pos=0;
  const unlock=()=>{
    isAIProcessing=false;
    const b=Q("#chatSend"),i=Q("#chatInput");
    if(b)b.disabled=false;
    if(i){i.disabled=false;i.style.height="auto";i.focus();}
  };
  const iv=setInterval(()=>{
    pos++;
    bub.innerHTML=clean.substring(0,pos).replace(/\n/g,"<br>");
    if(mc)mc.scrollTop=mc.scrollHeight;
    if(pos>=clean.length){clearInterval(iv);unlock();}
  },14);
}
const renderChatHistory=()=>{
  QA(".chat-message:not(#welcome-message)").forEach(el=>el.remove());
  chatHistory.forEach(m=>{if(m.role==="user")addMsg("user",m.content);else if(m.role==="assistant")addMsg("ai",m.content);});
};

const initChatUI=()=>{
  applyI18n(); // refresca welcome bubble, chips y textos
  loadChatHistory();
  renderAIContext();
  const btn=Q("#chatSend"),inp=Q("#chatInput");
  if(btn&&!btn.dataset.init){btn.dataset.init="1";btn.onclick=()=>{const m=inp?.value?.trim();if(m)sendToAI(m);};}
  if(inp&&!inp.dataset.init){
    inp.dataset.init="1";
    inp.addEventListener("keypress",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();const m=inp.value.trim();if(m)sendToAI(m);}});
    inp.addEventListener("input",()=>{inp.style.height="auto";inp.style.height=Math.min(inp.scrollHeight,120)+"px";});
  }
  const clearBtn=Q("#aiClearBtn"),planBtn=Q("#aiPlanBtn"),copyBtn=Q("#aiCopyBtn");
  if(clearBtn&&!clearBtn.dataset.init){
    clearBtn.dataset.init="1";
    clearBtn.addEventListener("click",()=>{
      chatHistory=[];
      saveChatHistory();
      renderChatHistory();
      toast(LANG==="EN"?"Chat cleared":(LANG==="CA"?"Xat netejat":"Chat limpiado"));
    });
  }
  if(copyBtn&&!copyBtn.dataset.init){
    copyBtn.dataset.init="1";
    copyBtn.addEventListener("click",()=>{
      const lines=chatHistory.map(m=>`${m.role==="user"?(LANG==="EN"?"YOU":(LANG==="CA"?"TU":"T√ö")):"AI"}: ${stripMd(m.content)}`);
      const txt=lines.join("\n\n") || (LANG==="EN"?"No messages yet":(LANG==="CA"?"Encara no hi ha missatges":"A√∫n no hay mensajes"));
      navigator.clipboard?.writeText(txt)
        .then(()=>toast(LANG==="EN"?"Chat copied":(LANG==="CA"?"Xat copiat":"Chat copiado")))
        .catch(()=>toast(LANG==="EN"?"Could not copy chat":(LANG==="CA"?"No s'ha pogut copiar el xat":"No se pudo copiar el chat")));
    });
  }
  if(planBtn&&!planBtn.dataset.init){
    planBtn.dataset.init="1";
    planBtn.addEventListener("click",()=>{
      if(!isAIProcessing)sendToAI(LANG==="EN"?"Create a 90-day action plan for my case":(LANG==="CA"?"Fes-me un pla d'acci√≥ de 90 dies pel meu cas":"Hazme un plan de accion de 90 dias para mi caso"));
    });
  }

  // Re-bind suggestion chips (se regeneran al cambiar idioma)
  QA(".suggestion-chip").forEach(ch=>{
    ch.replaceWith(ch.cloneNode(true)); // quitar listeners viejos
  });
  QA(".suggestion-chip").forEach(ch=>{
    ch.addEventListener("click",()=>{const q=ch.getAttribute("data-q");if(q&&!isAIProcessing)sendToAI(q);});
  });
};

/* ============================
   VALIDACI√ìN LIVE
   ============================ */
const liveValidate=()=>{
  const setHint=(id,msg,ok)=>{const el=Q("#hint-"+id);if(!el)return;el.textContent=msg||"";el.className="field-hint "+(msg?(ok?"ok":"err"):"");Q("#"+id)?.classList.toggle("field-ok",!!ok&&!!msg);Q("#"+id)?.classList.toggle("field-err",!ok&&!!msg);};
  const inc=+Q("#inc")?.value||0;if(inc>0&&inc<500)setHint("inc",LANG==="EN"?"Very low income":"Ingresos muy bajos, ¬øes neto?",false);else if(inc>0)setHint("inc","‚úì",true);else setHint("inc","","");
  const sav=+Q("#sav")?.value||0;if(sav>0&&sav<5000)setHint("sav",LANG==="EN"?"Very low savings":"Ahorros muy bajos",false);else if(sav>0)setHint("sav","‚úì",true);else setHint("sav","","");
  const m2=+Q("#m2")?.value||0;if(m2>0&&m2<50)setHint("m2",LANG==="EN"?"Minimum 50 m¬≤":"M√≠nimo 50 m¬≤",false);else if(m2>=50)setHint("m2","‚úì",true);else setHint("m2","","");
};

/* ============================
   EVENTOS
   ============================ */
Q("#np").onclick=()=>{const nm=(Q("#nm").value||"").trim(),ag=+Q("#ag").value||0;if(!nm||ag<18||ag>100){toast(t("toastCheck"));return;}saveForm();show("e");};
Q("#ne").onclick=()=>{saveForm();show("f");};
Q("#go").onclick=analyze;
Q("#cp").onclick=()=>{if(!last){toast(t("toastFirst"));return;}navigator.clipboard?.writeText(Q("#rt").textContent||"").then(()=>toast(t("toastCopied"))).catch(()=>{const ta=document.createElement("textarea");ta.value=Q("#rt").textContent||"";document.body.appendChild(ta);ta.select();document.execCommand("copy");ta.remove();toast(t("toastCopied"));});};
Q("#rs").onclick=()=>{if(confirm(LANG==="EN"?"Reset everything?":"¬øReiniciar todo?")){localStorage.clear();location.reload();}};
Q("#jumpX").onclick=()=>{if(!last){toast(t("toastFirst"));return;}show("x");};
Q("#jumpAI").onclick=()=>{if(!last){toast(t("toastFirst"));return;}show("ai");};
Q("#shareWa").onclick=()=>{if(!last){toast(t("toastFirst"));return;}window.open("https://wa.me/?text="+encodeURIComponent(Q("#rt").textContent||""),"_blank","noopener");};
Q("#shareCl").onclick=()=>Q("#cp").click();

Q("#t_p").onclick=()=>show("p");
Q("#t_e").onclick=()=>show("e");
Q("#t_f").onclick=()=>show("f");
Q("#t_r").onclick=()=>{if(!last){toast(t("toastFirst"));return;}show("r");};
Q("#t_m").onclick=()=>{if(!last){toast(t("toastFirst"));return;}show("m");};
Q("#t_x").onclick=()=>{if(!last){toast(t("toastFirst"));return;}show("x");};
Q("#t_ai").onclick=()=>{if(!last){toast(t("toastFirst"));return;}show("ai");};

Q("#toggleMap").onclick=()=>{const box=Q("#zoneWrap"),open=box.style.display!=="none";box.style.display=open?"none":"block";if(!open){initMap();setTimeout(()=>{zmap?.invalidateSize();box.scrollIntoView({behavior:"smooth",block:"nearest"});},250);}};;
Q("#zoneClear").onclick=()=>{zoneSel.clear();polygonsByName.forEach((_,n)=>applyPolygonState(n));renderZoneUI();saveZoneSel();toast(t("toastZoneCleared"));};
Q("#zoneApply").onclick=()=>{
  if(!zoneSel.size){toast(t("toastNoZone"));return;}
  const pm=Q("#ar").querySelector('[value="__multi__"]');if(pm)pm.remove();
  if(zoneSel.size===1){Q("#ar").value=[...zoneSel][0];}
  else{const mo=document.createElement("option");mo.value="__multi__";mo.textContent=[...zoneSel].join(", ");Q("#ar").insertBefore(mo,Q("#ar").options[1]);Q("#ar").value="__multi__";}
  saveZoneSel();saveForm();toast(t("toastZoneApplied"));
};
Q("#bc").onclick=compare;
Q("#autoFillCmp").onclick=fillFromLast;
Q("#cm").onchange=upMap;
Q("#L_CA").onclick=()=>setLang("CA");
Q("#L_ES").onclick=()=>setLang("ES");
Q("#L_EN").onclick=()=>setLang("EN");
["inc","sav","m2"].forEach(id=>Q("#"+id)?.addEventListener("input",liveValidate));
["#nm","#ag","#inc","#sav","#yrs","#msv","#m2","#bed","#bat"].forEach(id=>Q(id)?.addEventListener("change",saveForm));

/* ============================
   INIT
   ============================ */
loadZoneSel();loadForm();setLang(LANG);setTabsEnabled();liveValidate();show("p");

})();}

waitForLeaflet();
</script>
</body>
</html>
