<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Assessoria d'Habitatge - AI Advisor</title>

<style>
:root{
  --bg:#020617;
  --card:rgba(15,23,42,.70);
  --card2:rgba(11,18,32,.88);
  --bd:rgba(148,163,184,.22);
  --bd2:rgba(148,163,184,.30);
  --t:#e5e7eb;
  --m:#94a3b8;
  --mut:#cbd5e1;
  --pill:#38bdf8;
  --p:#06b6d4;--ph:#0891b2;
  --ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;
  --g1:#3b4a60;--g2:#0b1220;
  --shadow-lg:0 10px 40px rgba(0,0,0,.35);
  --shadow-xl:0 20px 60px rgba(0,0,0,.48);
  --gradient-3:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
  --gradient-4:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);
}

html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  position:relative;
  overflow-x:hidden;
}
body::before{
  content:"";
  position:fixed;inset:0;
  background:
    radial-gradient(1400px 700px at 20% -10%,rgba(56,189,248,.18),transparent 60%),
    radial-gradient(1000px 600px at 85% 0%,rgba(34,197,94,.14),transparent 60%),
    radial-gradient(900px 520px at 60% 110%,rgba(168,85,247,.12),transparent 62%),
    linear-gradient(180deg,#0f172a 0%,#020617 55%,#000 100%);
  z-index:-1;pointer-events:none;
  animation:pulse 18s ease-in-out infinite;
}
@keyframes pulse{0%,100%{opacity:.80}50%{opacity:1}}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{opacity:0;transform:translateX(-18px)}to{opacity:1;transform:translateX(0)}}
@keyframes glow{0%,100%{box-shadow:0 0 18px rgba(56,189,248,.22)}50%{box-shadow:0 0 30px rgba(56,189,248,.42)}}
@keyframes typing{from{opacity:.4}to{opacity:1}}

#hx{
  color:var(--t);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
  -webkit-font-smoothing:antialiased;
}
#hx *{box-sizing:border-box}
.w{max-width:1200px;margin:22px auto 18px;padding:0 16px}

.c{
  background:rgba(15,23,42,.86);
  border:1px solid var(--bd);
  border-radius:20px;
  padding:22px;
  margin:16px 0;
  backdrop-filter:blur(14px);
  box-shadow:var(--shadow-lg);
  animation:fadeIn .5s ease-out;
  transition:all .25s ease;
  position:relative;
  overflow:hidden;
}
.c::before{
  content:"";
  position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(56,189,248,.6),transparent);
  opacity:.55
}
.c:hover{border-color:rgba(56,189,248,.42);box-shadow:var(--shadow-xl)}

.r{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.hrow{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.n{opacity:.95;font-size:.95rem;color:#cbd5e1;line-height:1.6}
.small{font-size:.88rem;color:#b6c2d3;line-height:1.5}

.pill{
  background:var(--gradient-3);
  color:#001018;
  border-radius:999px;
  padding:10px 16px;
  font-weight:950;
  letter-spacing:.6px;
  text-transform:uppercase;
  font-size:.88rem;
  box-shadow:0 4px 16px rgba(56,189,248,.32);
  animation:glow 6s ease-in-out infinite;
  white-space:nowrap;
}
.lang{display:flex;gap:10px;align-items:center}
.langbtn{
  border:1px solid rgba(148,163,184,.28);
  background:rgba(11,18,32,.85);
  color:#cbd5e1;
  border-radius:999px;
  padding:8px 14px;
  font-weight:900;
  cursor:pointer;
  transition:all .18s ease;
  font-size:.84rem;
  letter-spacing:.5px;
}
.langbtn:hover{border-color:rgba(56,189,248,.55);transform:translateY(-1px)}
.langbtn.a{
  background:var(--gradient-3);
  color:#001018;
  border-color:#38bdf8;
  box-shadow:0 4px 14px rgba(56,189,248,.28)
}

.tabs{display:flex;gap:10px;margin:16px 0;flex-wrap:wrap;animation:slideIn .6s ease-out}
.tab{
  border:1px solid rgba(148,163,184,.25);
  background:rgba(11,18,32,.80);
  color:#cbd5e1;
  border-radius:999px;
  padding:10px 18px;
  cursor:pointer;
  font-weight:900;
  transition:all .18s ease;
  user-select:none;
  position:relative;
  overflow:hidden;
  font-size:.90rem;
  letter-spacing:.35px;
}
.tab:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(56,189,248,.28)}
.tab.a{background:var(--gradient-3);color:#001018;border-color:#38bdf8;box-shadow:0 4px 14px rgba(56,189,248,.36)}
.tab.dis{opacity:.40;cursor:not-allowed;filter:grayscale(.35)}
.tab.dis:hover{transform:none;box-shadow:none}

.b{
  background:var(--gradient-3);
  color:#001018;border:0;border-radius:14px;padding:12px 20px;
  cursor:pointer;font-weight:950;transition:all .18s ease;
  box-shadow:0 4px 15px rgba(56,189,248,.28);
  font-size:.95rem;letter-spacing:.3px;position:relative;overflow:hidden
}
.b:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(56,189,248,.42)}
.b.ok{background:var(--gradient-4);box-shadow:0 4px 15px rgba(67,233,123,.22)}
.b.ok:hover{box-shadow:0 6px 20px rgba(67,233,123,.42)}
.b.dis{opacity:.45;cursor:not-allowed;filter:grayscale(.25);transform:none;pointer-events:none}

.g{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
@media(max-width:900px){.g{grid-template-columns:1fr}}

#hx input[type=text],#hx input[type=number],#hx select,#hx textarea{
  width:100%;
  padding:12px 14px;
  border:1px solid rgba(148,163,184,.30);
  border-radius:12px;
  background:rgba(2,6,23,.86);
  color:var(--t);
  outline:none;
  transition:all .18s ease;
  font-size:.95rem;
  font-family:inherit;
}
#hx textarea{
  min-height:100px;
  resize:vertical;
}
#hx input[type=text]:focus,#hx input[type=number]:focus,#hx select:focus,#hx textarea:focus{
  border-color:#38bdf8;
  box-shadow:0 0 0 4px rgba(56,189,248,.14);
  background:rgba(2,6,23,.96)
}
#hx input[type=checkbox]{accent-color:#38bdf8;width:18px;height:18px;cursor:pointer}
#hx label{color:#cbd5e1;font-weight:750;margin-bottom:6px;display:block;font-size:.9rem;letter-spacing:.25px}

.gu{
  margin-top:12px;padding:14px 16px;
  background:rgba(56,189,248,.08);
  border:1px solid rgba(56,189,248,.25);
  border-radius:14px;color:#dbeafe;
  display:flex;gap:12px;align-items:flex-start;
  border-left:4px solid #38bdf8
}
.gu .a{font-weight:950;line-height:1.2;margin-top:1px;font-size:1.15rem}

.tst{
  position:fixed;left:50%;bottom:22px;transform:translateX(-50%);
  background:rgba(2,6,23,.94);
  border:1px solid rgba(148,163,184,.35);
  color:var(--t);padding:10px 14px;border-radius:12px;
  opacity:0;pointer-events:none;transition:.2s;z-index:99999
}
.tst.s{opacity:1}

.sig{
  max-width:1100px;margin:10px auto 18px;padding:10px 12px;
  color:#a5b4fc;background:rgba(10,16,28,.65);
  border:1px solid rgba(148,163,184,.25);border-radius:12px;
  display:flex;gap:12px;align-items:center;justify-content:space-between;font-size:.95rem
}
.sig .br{font-weight:950;color:#e2e8f0}
.sig a{color:#93c5fd;text-decoration:none}
.sig a:hover{text-decoration:underline}

.cardx{
  margin-top:16px;
  background:linear-gradient(135deg,rgba(15,23,42,.86),rgba(11,18,32,.92));
  border:1px solid rgba(148,163,184,.25);
  border-radius:16px;padding:20px;
  box-shadow:0 4px 22px rgba(0,0,0,.22)
}
.cardx .top{
  display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;
  padding-bottom:16px;border-bottom:1px solid rgba(148,163,184,.14)
}
.cardx .title{font-weight:1000;color:#f1f5f9;font-size:1.15rem}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{
  border:1px solid rgba(148,163,184,.30);
  background:rgba(11,18,32,.82);
  color:#cbd5e1;border-radius:999px;
  padding:8px 14px;font-weight:850;font-size:.85rem;transition:.15s;
  text-shadow:0 1px 8px rgba(0,0,0,.25);
}
.chip:hover{transform:translateY(-1px)}
.chip.good{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.12);color:#86efac}
.chip.bad{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.12);color:#fca5a5}
.chip.warn{border-color:rgba(245,158,11,.45);background:rgba(245,158,11,.12);color:#fde68a}
.chip.neu{border-color:rgba(148,163,184,.35);color:#e2e8f0}

.body{margin-top:16px;color:#cbd5e1;line-height:1.65;font-size:.95rem}
.body b{color:#f8fafc;font-weight:800}

.grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:16px}
@media(max-width:980px){.grid3{grid-template-columns:1fr}}

.mini{
  background:linear-gradient(135deg,rgba(14,165,233,.10),rgba(6,182,212,.06));
  border:1px solid rgba(148,163,184,.25);
  border-radius:14px;padding:14px;transition:.15s
}
.mini:hover{border-color:rgba(56,189,248,.40);transform:translateY(-1px)}
.mini .h{color:#94a3b8;font-size:.82rem;font-weight:800;text-transform:uppercase;letter-spacing:.5px}
.mini .v{
  font-weight:1000;color:#f8fafc;margin-top:6px;font-size:1.15rem;
  text-shadow:0 2px 12px rgba(0,0,0,.35);
}
.note{
  margin-top:16px;color:#cbd5e1;white-space:pre-wrap;
  background:rgba(2,6,23,.62);
  padding:16px;border-radius:12px;border:1px solid rgba(148,163,184,.20);
  line-height:1.7;font-size:.92rem
}

.k{
  background:
    linear-gradient(145deg,rgba(14,165,233,.10),rgba(6,182,212,.06));
  border:1px solid rgba(56,189,248,.30);
  border-radius:18px;padding:18px 14px;text-align:left;
  position:relative;overflow:hidden;
  box-shadow:0 4px 18px rgba(0,0,0,.25);
  min-height:86px;
}
.k::before{
  content:"";
  position:absolute;inset:-40%;
  background:radial-gradient(circle,rgba(56,189,248,.10),transparent 70%);
  pointer-events:none;transition:transform .6s ease;
}
.k:hover::before{transform:scale(1.12)}
.k span{
  color:#a6b3c6;font-size:.78rem;font-weight:900;
  text-transform:uppercase;letter-spacing:.9px;display:block
}
.k b{
  font-size:30px;display:block;color:#f1f5f9;margin-top:10px;font-weight:1000;
  text-shadow:0 2px 14px rgba(0,0,0,.45);
  line-height:1.05;
}
.k .sub{
  margin-top:8px;
  font-size:.82rem;
  color:#9fb0c6;
  line-height:1.25;
}
@media(max-width:520px){
  .k b{font-size:26px}
}

.pbar-wrap{margin-top:8px;background:rgba(255,255,255,.07);border-radius:999px;height:8px;overflow:hidden}
.pbar{height:8px;border-radius:999px;transition:width .9s cubic-bezier(.4,0,.2,1)}
.pbar.good{background:linear-gradient(90deg,#22c55e,#4ade80)}
.pbar.warn{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.pbar.bad{background:linear-gradient(90deg,#ef4444,#f87171)}

.tip{position:relative;display:inline-flex;align-items:center;gap:4px}
.tip-icon{
  width:16px;height:16px;border-radius:50%;
  background:rgba(148,163,184,.22);color:#b6c2d3;
  font-size:10px;font-weight:950;
  cursor:help;display:inline-flex;align-items:center;justify-content:center;
  border:1px solid rgba(148,163,184,.30);flex-shrink:0;user-select:none
}
.tip-box{
  position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);
  background:#0f172a;border:1px solid rgba(56,189,248,.35);
  border-radius:10px;padding:10px 14px;color:#cbd5e1;
  font-size:.82rem;line-height:1.5;width:240px;z-index:9999;
  box-shadow:0 10px 26px rgba(0,0,0,.55);
  pointer-events:none;opacity:0;transition:opacity .14s;
}
.tip:hover .tip-box,.tip:focus-within .tip-box{opacity:1}

.steps{display:flex;align-items:center;margin-bottom:16px;animation:fadeIn .45s ease-out}
.step{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1;position:relative}
.step-dot{
  width:32px;height:32px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-weight:1000;font-size:.85rem;
  transition:all .25s ease;
  border:2px solid rgba(148,163,184,.22);
  background:rgba(11,18,32,.82);
  color:#94a3b8;z-index:1
}
.step.done .step-dot{background:var(--gradient-4);color:#001018;border-color:#22c55e;box-shadow:0 0 12px rgba(34,197,94,.35)}
.step.active .step-dot{background:var(--gradient-3);color:#001018;border-color:#38bdf8;box-shadow:0 0 12px rgba(56,189,248,.42)}
.step-label{font-size:.72rem;color:#475569;font-weight:850;text-align:center;white-space:nowrap}
.step.done .step-label,.step.active .step-label{color:#94a3b8}
.step-line{
  position:absolute;top:15px;left:calc(50% + 17px);
  width:calc(100% - 34px);height:2px;background:rgba(148,163,184,.14);
  transition:background .3s;z-index:0
}
.step.done .step-line{background:rgba(34,197,94,.28)}

.share-bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;padding-top:12px;border-top:1px solid rgba(148,163,184,.12)}
.share-btn{
  border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.82);color:#cbd5e1;
  border-radius:10px;padding:8px 14px;cursor:pointer;font-weight:850;font-size:.82rem;
  transition:all .18s ease;display:flex;align-items:center;gap:6px
}
.share-btn:hover{transform:translateY(-2px)}
.share-btn.wa{border-color:rgba(37,211,102,.40);color:#4ade80}
.share-btn.wa:hover{background:rgba(37,211,102,.10);box-shadow:0 4px 12px rgba(37,211,102,.18)}
.share-btn.cl{border-color:rgba(56,189,248,.40);color:#7dd3fc}
.share-btn.cl:hover{background:rgba(56,189,248,.10);box-shadow:0 4px 12px rgba(56,189,248,.18)}

#hx input.field-ok{border-color:rgba(34,197,94,.50)!important}
#hx input.field-err{border-color:rgba(239,68,68,.52)!important;box-shadow:0 0 0 3px rgba(239,68,68,.10)!important}
.field-hint{font-size:.78rem;margin-top:4px;min-height:16px;transition:all .2s}
.field-hint.ok{color:#4ade80}
.field-hint.err{color:#f87171}

.range-bar{display:flex;gap:6px;align-items:center;margin-top:6px;flex-wrap:wrap}
.range-tag{font-size:.75rem;border-radius:8px;padding:2px 7px;font-weight:850}
.range-tag.lo{background:rgba(34,197,94,.12);color:#86efac;border:1px solid rgba(34,197,94,.25)}
.range-tag.hi{background:rgba(239,68,68,.12);color:#fca5a5;border:1px solid rgba(239,68,68,.25)}

.countdown{
  margin-top:10px;padding:12px 14px;background:rgba(245,158,11,.08);
  border:1px solid rgba(245,158,11,.25);border-radius:12px;border-left:4px solid #f59e0b;
  color:#fde68a;font-size:.88rem;line-height:1.6
}

#zoneWrap{margin-top:12px}
#zmap,#cmap{height:420px;border-radius:12px;border:1px solid rgba(148,163,184,.22);overflow:hidden;max-width:100%}
.pchips{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.pchip{
  border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.75);color:#cbd5e1;border-radius:999px;
  padding:6px 10px;font-weight:1000;font-size:.85rem;cursor:pointer
}
.pchip.on{border-color:#38bdf8;color:#dbeafe}
.pchip.off{opacity:.75}
.legend{
  display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;
  padding:10px 12px;background:rgba(2,6,23,.45);
  border:1px solid rgba(148,163,184,.18);border-radius:12px;
  color:#bcd0ea;font-size:.86rem;
}
.legdot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:middle}
.leg1{background:#38bdf8}
.leg2{background:#22c55e}
.leg3{background:#ef4444}

.chartCard{
  background:linear-gradient(135deg,rgba(2,6,23,.35),rgba(15,23,42,.35));
  border:1px solid rgba(148,163,184,.18);
  border-radius:14px;
  padding:14px;
}
.canvasWrap{
  border:1px solid rgba(148,163,184,.16);
  border-radius:12px;
  overflow:hidden;
  background:rgba(2,6,23,.45);
}
canvas{display:block;width:100%;height:240px}
@media(max-width:700px){canvas{height:220px}}

.chat-container{
  display:flex;
  flex-direction:column;
  height:600px;
  background:linear-gradient(135deg,rgba(15,23,42,.86),rgba(11,18,32,.92));
  border:1px solid rgba(148,163,184,.25);
  border-radius:16px;
  overflow:hidden;
}
.chat-messages{
  flex:1;
  overflow-y:auto;
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:16px;
}
.chat-message{
  display:flex;
  gap:12px;
  animation:fadeIn .3s ease-out;
}
.chat-message.user{
  flex-direction:row-reverse;
}
.chat-avatar{
  width:36px;
  height:36px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  font-size:14px;
  flex-shrink:0;
}
.chat-avatar.ai{
  background:var(--gradient-3);
  color:#001018;
}
.chat-avatar.user{
  background:var(--gradient-4);
  color:#001018;
}
.chat-bubble{
  max-width:75%;
  padding:12px 16px;
  border-radius:16px;
  line-height:1.6;
  font-size:.92rem;
}
.chat-message.user .chat-bubble{
  background:rgba(56,189,248,.15);
  border:1px solid rgba(56,189,248,.25);
  color:#e5e7eb;
}
.chat-message.ai .chat-bubble{
  background:rgba(148,163,184,.08);
  border:1px solid rgba(148,163,184,.18);
  color:#cbd5e1;
}
.chat-bubble.thinking{
  font-style:italic;
  opacity:.7;
  animation:typing 1s ease-in-out infinite;
}
.chat-input-wrap{
  padding:16px;
  background:rgba(2,6,23,.8);
  border-top:1px solid rgba(148,163,184,.18);
  display:flex;
  gap:10px;
}
.chat-input{
  flex:1;
  padding:12px 14px;
  border:1px solid rgba(148,163,184,.30);
  border-radius:12px;
  background:rgba(2,6,23,.86);
  color:var(--t);
  outline:none;
  transition:all .18s ease;
  font-size:.95rem;
  font-family:inherit;
  resize:none;
  min-height:44px;
  max-height:120px;
}
.chat-input:focus{
  border-color:#38bdf8;
  box-shadow:0 0 0 4px rgba(56,189,248,.14);
}
.chat-send-btn{
  padding:12px 20px;
  background:var(--gradient-3);
  color:#001018;
  border:0;
  border-radius:12px;
  cursor:pointer;
  font-weight:900;
  transition:all .18s ease;
  box-shadow:0 4px 15px rgba(56,189,248,.28);
  white-space:nowrap;
}
.chat-send-btn:hover:not(:disabled){
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(56,189,248,.42);
}
.chat-send-btn:disabled{
  opacity:.4;
  cursor:not-allowed;
  transform:none;
}
.suggestion-chips{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:12px;
}
.suggestion-chip{
  padding:6px 12px;
  background:rgba(56,189,248,.1);
  border:1px solid rgba(56,189,248,.25);
  border-radius:999px;
  color:#7dd3fc;
  font-size:.82rem;
  cursor:pointer;
  transition:all .18s ease;
}
.suggestion-chip:hover{
  background:rgba(56,189,248,.18);
  transform:translateY(-1px);
}

::selection{background:rgba(56,189,248,.25)}
</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
<div class="w" id="hx">

  <div class="c hrow">
    <div class="pill">Assessoria d'Habitatge ¬∑ Baix Pened√®s</div>
    <div class="r" style="justify-content:flex-end;flex:1">
      <div class="n">Ejemplos reales: solo despu√©s de Analizar.</div>
      <div class="lang">
        <button class="langbtn" id="L_CA" type="button">CA</button>
        <button class="langbtn a" id="L_ES" type="button">ES</button>
        <button class="langbtn" id="L_EN" type="button">EN</button>
      </div>
    </div>
  </div>

  <div class="steps" id="stepBar">
    <div class="step active" id="stp1"><div class="step-dot">1</div><div class="step-label">Personal</div><div class="step-line"></div></div>
    <div class="step" id="stp2"><div class="step-dot">2</div><div class="step-label">Econom√≠a</div><div class="step-line"></div></div>
    <div class="step" id="stp3"><div class="step-dot">3</div><div class="step-label">Preferencias</div><div class="step-line"></div></div>
    <div class="step" id="stp4"><div class="step-dot">4</div><div class="step-label">Resultado</div></div>
  </div>

  <div class="tabs">
    <div id="t_p" class="tab a">1 Personal</div>
    <div id="t_e" class="tab">2 Econom√≠a</div>
    <div id="t_f" class="tab">3 Preferencias</div>
    <div id="t_r" class="tab">4 Resultado</div>
    <div id="t_m" class="tab">5 Comparador</div>
    <div id="t_x" class="tab">6 Ejemplos reales</div>
    <div id="t_ai" class="tab">ü§ñ AI Advisor</div>
  </div>

  <div class="c" data-p="p">
    <div class="g">
      <div><label>Nombre y apellidos</label><input id="nm" type="text" autocomplete="name"></div>
      <div><label>Edad (18‚Äì100)</label><input id="ag" type="number" min="18" max="100"></div>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n">Rellena los datos b√°sicos para continuar.</div></div>
    <div class="r" style="margin-top:10px"><button class="b" id="np" type="button">Continuar</button></div>
  </div>

  <div class="c" data-p="e" style="display:none">
    <div class="g">
      <div>
        <label>Ingresos mensuales (‚Ç¨)</label>
        <input id="inc" type="number" min="0">
        <div class="field-hint" id="hint-inc"></div>
      </div>
      <div>
        <label>Ahorros disponibles (‚Ç¨)</label>
        <input id="sav" type="number" min="0">
        <div class="field-hint" id="hint-sav"></div>
      </div>
      <div><label>A√±os de hipoteca (5‚Äì40)</label><input id="yrs" type="number" min="5" max="40" value="25"></div>
      <div><label>¬øVivir√°s m√°s de 5 a√±os aqu√≠?</label><select id="hor"><option value="y">S√≠</option><option value="n">No</option></select></div>
      <div><label>¬øPrimera vivienda o familia con menores?</label><select id="fst"><option value="y">S√≠</option><option value="n">No</option></select></div>
      <div><label>Ahorro mensual (‚Ç¨)</label><input id="msv" type="number" min="0"></div>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n">Completa econom√≠a y sigue a preferencias.</div></div>
    <div class="r" style="margin-top:10px"><button class="b" id="ne" type="button">Continuar</button></div>
  </div>

  <div class="c" data-p="f" style="display:none">
    <div class="g">
      <div>
        <label>Municipio (Baix Pened√®s)</label>
        <select id="ar">
          <option value="*">Cualquiera</option>
          <option>Cunit</option><option>El Vendrell</option><option>Calafell</option><option>Santa Oliva</option><option>Bellvei</option>
          <option>L'Arbo√ß</option><option>Banyeres del Pened√®s</option><option>Albinyana</option><option>Bonastre</option><option>Maslloren√ß</option>
          <option>La Bisbal del Pened√®s</option><option>Lloren√ß del Pened√®s</option><option>Sant Jaume dels Domenys</option><option>El Montmell</option>
        </select>
        <div class="small" style="margin-top:6px">Si usas el mapa puedes elegir varios municipios.</div>
      </div>
      <div>
        <label>Metros cuadrados (‚â•50)</label>
        <input id="m2" type="number" min="50">
        <div class="field-hint" id="hint-m2"></div>
      </div>
      <div><label>Habitaciones</label><input id="bed" type="number" min="0" max="10" value="2"></div>
      <div><label>Ba√±os</label><input id="bat" type="number" min="1" max="10" value="1"></div>
      <div><label>Tipo de vivienda</label><select id="ty"><option value="flat">Piso</option><option value="house">Casa</option></select></div>
      <div class="r" style="align-items:flex-start">
        <div style="width:100%">
          <label>Extras (opcional)</label>
          <div class="r" style="margin-top:8px">
            <label><input type="checkbox" id="et"><span>Terraza</span></label>
            <label><input type="checkbox" id="ep"><span>Piscina</span></label>
            <label><input type="checkbox" id="el"><span>Ascensor</span></label>
            <label><input type="checkbox" id="ek"><span>Aparcamiento</span></label>
            <label><input type="checkbox" id="es"><span>Trastero</span></label>
            <label><input type="checkbox" id="ej"><span>Jard√≠n</span></label>
            <label><input type="checkbox" id="ea"><span>Aire acondicionado</span></label>
          </div>
        </div>
      </div>
    </div>
    <div class="r" style="margin-top:10px">
      <button class="b" id="go" type="button">Analizar</button>
      <button class="b ok" id="toggleMap" type="button">Mapa (zona real)</button>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n">Si cambias preferencias, vuelve a Analizar.</div></div>
    <div id="zoneWrap" class="cardx" style="display:none">
      <div class="top">
        <div>
          <div class="title">Zona preferida (mapa real)</div>
          <div class="n">Haz clic en un pol√≠gono para seleccionarlo.</div>
          <div class="n" id="zoneNote" style="margin-top:6px">Seleccionados: ninguno</div>
        </div>
        <div class="pchips" id="zoneChips"></div>
      </div>
      <div class="r" style="margin-top:10px;justify-content:flex-end">
        <button class="b" id="zoneClear" type="button">Limpiar</button>
        <button class="b ok" id="zoneApply" type="button">Usar en Ejemplos</button>
      </div>
      <div id="zmap" style="margin-top:10px"></div>
      <div class="legend">
        <span><span class="legdot leg1"></span>Seleccionado</span>
        <span><span class="legdot leg2"></span>Disponible</span>
      </div>
      <div class="n" id="zoneApplied" style="margin-top:10px;color:#7dd3fc"></div>
    </div>
  </div>

  <div class="c" data-p="r" style="display:none">
    <div class="g">
      <div class="k"><span>Precio estimado</span><b id="k1">0 ‚Ç¨</b><div class="sub" id="k1sub"></div></div>
      <div class="k"><span>Alquiler estimado</span><b id="k2">0 ‚Ç¨</b><div class="sub" id="k2sub"></div></div>
      <div class="k"><span>Cuota hipoteca</span><b id="k3">0 ‚Ç¨</b><div class="sub" id="k3sub"></div></div>
      <div class="k"><span>Recomendaci√≥n</span><b id="k4">‚Äì</b><div class="sub" id="k4sub"></div></div>
    </div>
    <div id="rCard" class="cardx" style="display:none">
      <div class="top"><div class="title" id="rTitle"></div><div class="chips" id="rChips"></div></div>
      <div class="grid3" id="rMini"></div>
      <div class="grid3" style="margin-top:14px">
        <div class="chartCard">
          <div style="font-weight:950;color:#eaf2ff">Esfuerzo mensual</div>
          <div class="canvasWrap" style="margin-top:10px"><canvas id="effChart"></canvas></div>
        </div>
        <div class="chartCard">
          <div style="font-weight:950;color:#eaf2ff">Sensibilidad (inter√©s)</div>
          <div class="canvasWrap" style="margin-top:10px"><canvas id="sensChart"></canvas></div>
        </div>
        <div class="chartCard">
          <div style="font-weight:950;color:#eaf2ff">Lectura r√°pida</div>
          <div class="small" id="chartTips"></div>
          <div style="margin-top:10px;padding:12px;border-radius:12px;background:rgba(2,6,23,.35);color:#cbd5e1" id="quickExplain"></div>
        </div>
      </div>
      <div class="body" id="rBody"></div>
      <div class="note" id="rt"></div>
    </div>
    <div class="r" style="margin-top:10px">
      <button class="b" id="cp" type="button">Copiar</button>
      <button class="b" id="rs" type="button">Reiniciar</button>
      <button class="b ok" id="jumpX" type="button">Ir a Ejemplos</button>
      <button class="b ok" id="jumpAI" type="button">üí¨ AI Advisor</button>
    </div>
    <div class="share-bar">
      <button class="share-btn wa" id="shareWa" type="button">üì± WhatsApp</button>
      <button class="share-btn cl" id="shareCl" type="button">üìã Copiar</button>
    </div>
  </div>

  <div class="c" data-p="m" style="display:none">
    <div class="g">
      <div><label>Provincia</label><select id="cm"><option>Barcelona</option><option>Girona</option><option>Lleida</option><option>Tarragona</option></select></div>
      <div><label>m¬≤</label><input id="cm2" type="number" min="50"></div>
      <div><label>Habitaciones</label><input id="cbd" type="number" min="0" max="10"></div>
      <div><label>Ba√±os</label><input id="cba" type="number" min="1" max="10"></div>
      <div><label>Tipo</label><select id="cty"><option value="flat">Piso</option><option value="house">Casa</option></select></div>
      <div class="r" style="align-items:flex-start">
        <div style="width:100%">
          <label>Extras</label>
          <div class="r" style="margin-top:8px">
            <label><input type="checkbox" id="ct"><span>Terraza</span></label>
            <label><input type="checkbox" id="cp0"><span>Piscina</span></label>
            <label><input type="checkbox" id="cl0"><span>Ascensor</span></label>
            <label><input type="checkbox" id="ck0"><span>Aparcamiento</span></label>
            <label><input type="checkbox" id="cs0"><span>Trastero</span></label>
            <label><input type="checkbox" id="cj0"><span>Jard√≠n</span></label>
            <label><input type="checkbox" id="ca0"><span>Aire</span></label>
          </div>
        </div>
      </div>
    </div>
    <div id="cmap" style="width:100%;height:320px;border-radius:12px;margin-top:12px"></div>
    <div class="r" style="margin-top:10px">
      <button class="b" id="bc" type="button">Comparar</button>
      <button class="b ok" id="autoFillCmp" type="button">Usar mis datos</button>
    </div>
    <div class="cardx" style="margin-top:12px">
      <div class="top"><div class="title">Resultado</div><div class="chips" id="cmpChips"></div></div>
      <div class="body" id="cmg"></div>
      <div class="chartCard" style="margin-top:14px">
        <div style="font-weight:950;color:#eaf2ff">Comparaci√≥n visual</div>
        <div class="canvasWrap" style="margin-top:10px"><canvas id="cmpChart"></canvas></div>
      </div>
    </div>
  </div>

  <div class="c" data-p="x" style="display:none">
    <div class="n" id="xinfo"></div>
    <div class="r" style="margin-top:10px" id="xbtns"></div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n">Si elegiste varios municipios, salen botones por municipio.</div></div>
  </div>

  <div class="c" data-p="ai" style="display:none">
    <div class="cardx">
      <div class="top">
        <div class="title">ü§ñ AI Financial Advisor</div>
        <div class="chips"><span class="chip good">Conectado</span></div>
      </div>
      <div class="gu" style="margin-top:0;margin-bottom:16px">
        <span class="a">üí°</span>
        <div class="n"><b>Tu asesor financiero personal.</b> Preg√∫ntame sobre tu situaci√≥n, estrategias de ahorro, etc.</div>
      </div>
      <div class="suggestion-chips" id="aiSuggestions">
        <div class="suggestion-chip" data-q="¬øQu√© puedo hacer para mejorar mi situaci√≥n?">¬øC√≥mo mejorar?</div>
        <div class="suggestion-chip" data-q="¬øCu√°nto necesito ahorrar mensualmente?">¬øCu√°nto ahorrar?</div>
        <div class="suggestion-chip" data-q="¬øEs mejor comprar o alquilar en mi caso?">¬øComprar o alquilar?</div>
        <div class="suggestion-chip" data-q="¬øQu√© municipios me recomiendas?">¬øQu√© municipios?</div>
        <div class="suggestion-chip" data-q="¬øC√≥mo afecta el tipo de inter√©s?">¬øY si sube el tipo?</div>
        <div class="suggestion-chip" data-q="¬øQu√© alternativas tengo?">¬øAlternativas?</div>
      </div>
      <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
          <div class="chat-message ai">
            <div class="chat-avatar ai">AI</div>
            <div class="chat-bubble">üëã ¬°Hola! Soy tu asesor financiero. He analizado tu situaci√≥n y estoy aqu√≠ para ayudarte. ¬øEn qu√© puedo ayudarte?</div>
          </div>
        </div>
        <div class="chat-input-wrap">
          <textarea class="chat-input" id="chatInput" placeholder="Escribe tu pregunta aqu√≠..." rows="1"></textarea>
          <button class="chat-send-btn" id="chatSend">Enviar</button>
        </div>
      </div>
    </div>
  </div>

</div>

<div class="sig">
  <div class="br">Assessoria d'Habitatge</div>
  <div>
    <a href="https://www.assesoriahabitatge.com/" target="_blank">assesoriahabitatge.com</a> ¬∑
    <a href="mailto:info@assesoriahabitatge.com">info@assesoriahabitatge.com</a>
  </div>
</div>

<div id="ts" class="tst"></div>

<script>
const MUNICIPALITY_POLYGONS={
  "Cunit":[[41.208,1.623],[41.214,1.634],[41.219,1.648],[41.216,1.655],[41.209,1.658],[41.202,1.654],[41.196,1.645],[41.194,1.635],[41.198,1.626],[41.203,1.621],[41.208,1.623]],
  "Calafell":[[41.192,1.558],[41.201,1.565],[41.209,1.578],[41.213,1.590],[41.210,1.600],[41.202,1.607],[41.193,1.608],[41.185,1.602],[41.181,1.591],[41.182,1.575],[41.186,1.564],[41.192,1.558]],
  "El Vendrell":[[41.209,1.520],[41.221,1.528],[41.231,1.541],[41.235,1.553],[41.232,1.565],[41.225,1.573],[41.215,1.575],[41.206,1.568],[41.201,1.555],[41.202,1.542],[41.205,1.530],[41.209,1.520]],
  "Santa Oliva":[[41.244,1.540],[41.255,1.547],[41.263,1.558],[41.264,1.570],[41.259,1.580],[41.250,1.585],[41.241,1.583],[41.235,1.574],[41.234,1.562],[41.237,1.549],[41.244,1.540]],
  "Bellvei":[[41.230,1.568],[41.240,1.574],[41.248,1.584],[41.250,1.595],[41.245,1.604],[41.237,1.608],[41.228,1.606],[41.222,1.597],[41.220,1.585],[41.223,1.575],[41.230,1.568]],
  "L'Arbo√ß":[[41.256,1.595],[41.267,1.602],[41.275,1.612],[41.277,1.624],[41.272,1.634],[41.263,1.638],[41.254,1.636],[41.247,1.627],[41.246,1.615],[41.250,1.603],[41.256,1.595]],
  "Banyeres del Pened√®s":[[41.272,1.568],[41.283,1.575],[41.291,1.586],[41.293,1.598],[41.288,1.608],[41.279,1.612],[41.270,1.610],[41.263,1.600],[41.262,1.588],[41.265,1.576],[41.272,1.568]],
  "Albinyana":[[41.235,1.478],[41.246,1.485],[41.254,1.495],[41.256,1.507],[41.251,1.517],[41.242,1.521],[41.233,1.519],[41.227,1.509],[41.226,1.497],[41.229,1.486],[41.235,1.478]],
  "Bonastre":[[41.218,1.430],[41.229,1.437],[41.237,1.447],[41.239,1.459],[41.234,1.469],[41.225,1.473],[41.216,1.471],[41.210,1.461],[41.209,1.449],[41.212,1.438],[41.218,1.430]],
  "Maslloren√ß":[[41.266,1.405],[41.277,1.412],[41.285,1.422],[41.287,1.434],[41.282,1.444],[41.273,1.448],[41.264,1.446],[41.258,1.436],[41.257,1.424],[41.260,1.413],[41.266,1.405]],
  "La Bisbal del Pened√®s":[[41.269,1.480],[41.280,1.487],[41.288,1.497],[41.290,1.509],[41.285,1.519],[41.276,1.523],[41.267,1.521],[41.261,1.511],[41.260,1.499],[41.263,1.488],[41.269,1.480]],
  "Lloren√ß del Pened√®s":[[41.273,1.540],[41.284,1.547],[41.292,1.557],[41.294,1.569],[41.289,1.579],[41.280,1.583],[41.271,1.581],[41.265,1.571],[41.264,1.559],[41.267,1.548],[41.273,1.540]],
  "Sant Jaume dels Domenys":[[41.290,1.550],[41.301,1.557],[41.309,1.567],[41.311,1.579],[41.306,1.589],[41.297,1.593],[41.288,1.591],[41.282,1.581],[41.281,1.569],[41.284,1.558],[41.290,1.550]],
  "El Montmell":[[41.298,1.445],[41.309,1.452],[41.317,1.462],[41.319,1.474],[41.314,1.484],[41.305,1.488],[41.296,1.486],[41.290,1.476],[41.289,1.464],[41.292,1.453],[41.298,1.445]]
};

let leafletAttempts=0;
function waitForLeaflet(){
  if(typeof L!=="undefined"){initApp();}
  else if(leafletAttempts++<100){setTimeout(waitForLeaflet,50);}
  else{alert("Error: Leaflet no carg√≥");}
}

function initApp(){
const Q=s=>document.querySelector(s);
const QA=s=>[...document.querySelectorAll(s)];
const fmt=n=>Math.round(n).toLocaleString("es-ES");
const toast=m=>{const e=Q("#ts");e.textContent=m;e.classList.add("s");setTimeout(()=>e.classList.remove("s"),2000)};

const STORE_KEY="hx_v10",ZONE_KEY="hx_zone_v7",CHAT_KEY="hx_chat_v1";
let last=null,lastReq=null,zoneSel=new Set(),zmap=null,cmap=null,polygonsByName=new Map();
let chatHistory=[],isAIProcessing=false;

const show=p=>{
  QA("[data-p]").forEach(x=>x.style.display=x.getAttribute("data-p")===p?"block":"none");
  ["p","e","f","r","m","x","ai"].forEach(k=>{const t=Q("#t_"+k);if(t)t.classList.toggle("a",p===k)});
  if(p==="m")setTimeout(()=>{if(cmap)cmap.invalidateSize()},150);
  if(p==="ai")setTimeout(initChatUI,100);
  window.scrollTo({top:0,behavior:"smooth"});
};

const mort=(c,r,y)=>{let m=r/12,n=y*12;return r===0?c/n:c*(m*Math.pow(1+m,n))/(Math.pow(1+m,n)-1)};

const COEF={"Cunit":{c:1.157,r:.975},"El Vendrell":{c:.912,r:.842},"Calafell":{c:.856,r:.983},"Santa Oliva":{c:.783,r:.825},"Bellvei":{c:.783,r:.925},"L'Arbo√ß":{c:.735,r:.883},"Banyeres del Pened√®s":{c:.614,r:.783},"Albinyana":{c:.766,r:.825},"Bonastre":{c:.497,r:.683},"Maslloren√ß":{c:.549,r:.75},"La Bisbal del Pened√®s":{c:.623,r:.808},"Lloren√ß del Pened√®s":{c:.856,r:.65},"Sant Jaume dels Domenys":{c:.614,r:.65},"El Montmell":{c:.529,r:.675}};
const BASE={m2:2000,rent:10,close:.11,rate:.0299};

const buy=(a,m2,b,ba,e)=>{
  let base=m2*BASE.m2*(COEF[a]?.c||1),adj=b*5e3+ba*3e3,x=0;
  if(e.t)x+=base*.05;if(e.p)x+=base*.08;if(e.l)x+=base*.04;if(e.k)x+=base*.03;
  if(e.s)x+=base*.02;if(e.j)x+=base*.05;if(e.a)x+=base*.015;
  return Math.round(base+adj+x);
};

const rent=(a,m2,b,ba,e)=>{
  let base=m2*BASE.rent*(COEF[a]?.r||1),adj=b*50+ba*30,x=0;
  if(e.t)x+=base*.15;if(e.p)x+=base*.30;if(e.l)x+=base*.08;if(e.k)x+=base*.07;
  if(e.s)x+=base*.05;if(e.j)x+=base*.18;if(e.a)x+=base*.06;
  return Math.round(base+adj+x);
};

const analyze=()=>{
  let nm=(Q("#nm").value||"").trim(),ag=+Q("#ag").value||0,inc=+Q("#inc").value||0,sav=+Q("#sav").value||0,yrs=+Q("#yrs").value||25;
  let ar=Q("#ar").value,m2=+Q("#m2").value||0,bd=+Q("#bed").value||0,ba=+Q("#bat").value||0;
  if(!nm||ag<18||ag>100||m2<50||ba<1){toast("Revisa datos");return}

  let e={t:Q("#et").checked,p:Q("#ep").checked,l:Q("#el").checked,k:Q("#ek").checked,s:Q("#es").checked,j:Q("#ej").checked,a:Q("#ea").checked};
  
  let pb,muniList=[];
  if((ar==="*"||ar==="__multi__")&&zoneSel.size>1){
    muniList=[...zoneSel];
    pb=Math.round(muniList.map(m=>buy(m,m2,bd,ba,e)).reduce((a,b)=>a+b,0)/muniList.length);
  }else{
    const baseM=(ar==="__multi__"&&zoneSel.size===1)?[...zoneSel][0]:(ar==="*"?"Cunit":ar);
    muniList=[baseM];
    pb=buy(baseM,m2,bd,ba,e);
  }

  let pr=muniList.length>1?
    Math.round(muniList.map(m=>rent(m,m2,bd,ba,e)).reduce((a,b)=>a+b,0)/muniList.length):
    rent(muniList[0],m2,bd,ba,e);

  let dp=(Q("#fst").value==="y"?.1:.2),down=pb*dp,cl=pb*BASE.close,cap=Math.max(0,pb-down);
  let needCash=Math.round(down+cl),rate=BASE.rate;
  if(sav<needCash)rate+=.006;

  let pay=mort(cap,rate,yrs);
  let ratioM=inc>0?(pay/inc)*100:999,ratioR=inc>0?(pr/inc)*100:999;
  let need=sav<needCash,ratioOK=ratioM<=35,hor=Q("#hor").value==="y";

  let recCode=(!need&&ratioOK&&hor)?"BUY":"RENT";
  let rec=recCode==="BUY"?"COMPRAR":"ALQUILAR";

  last={nm,m2,bd,ba,pb,cap,rate,yrs,down,cl,pay,ratioM,ratioR,rec,recCode,needCash,inc,sav,pr,muniList};
  lastReq={ar,m2,bd,ba,e};

  Q("#k1").textContent=fmt(pb)+" ‚Ç¨";
  Q("#k2").textContent=fmt(pr)+" ‚Ç¨";
  Q("#k3").textContent=fmt(pay)+" ‚Ç¨";
  Q("#k4").textContent=rec;
  Q("#k1sub").textContent=m2>0?(Math.round(pb/m2).toLocaleString()+" ‚Ç¨/m¬≤"):"";
  Q("#k2sub").textContent=m2>0?(Math.round(pr/m2).toLocaleString()+" ‚Ç¨/m¬≤"):"";
  Q("#k3sub").textContent=`${yrs} a√±os ¬∑ ${(rate*100).toFixed(2)}%`;
  Q("#k4sub").textContent=recCode==="BUY"?"Encajas cash+esfuerzo":"Aprieta; alquilar m√°s seguro";

  const why=recCode==="BUY"?["Ahorros cubren entrada+costes","Esfuerzo razonable","Horizonte >5 a√±os ayuda"]:["Falta cash o esfuerzo muy alto","Alquilar m√°s seguro ahora"];

  Q("#rCard").style.display="block";
  Q("#rTitle").textContent="Resumen ¬∑ "+rec;
  Q("#rChips").innerHTML=`<span class="chip ${ratioM<=30?"good":ratioM<=35?"warn":"bad"}">Hipoteca: ${ratioM.toFixed(1)}%</span><span class="chip ${ratioR<=30?"good":ratioR<=35?"warn":"bad"}">Alquiler: ${ratioR.toFixed(1)}%</span><span class="chip ${need?"bad":"good"}">Cash: ${fmt(needCash)} ‚Ç¨</span>`;
  Q("#rBody").innerHTML=`<div style="padding:12px;background:rgba(56,189,248,.08);border-radius:12px;margin-top:12px">${why.map(x=>`<div>‚Ä¢ ${x}</div>`).join("")}</div>`;
  Q("#rMini").innerHTML=`<div class="mini"><div class="h">Precio</div><div class="v">${fmt(pb)} ‚Ç¨</div></div><div class="mini"><div class="h">Cuota</div><div class="v">${fmt(pay)} ‚Ç¨</div></div><div class="mini"><div class="h">Alquiler</div><div class="v">${fmt(pr)} ‚Ç¨</div></div>`;

  const muniTxt=muniList.length>1?`Media ${muniList.length} municipios`:muniList[0];
  let report=`Hola ${nm},\nPrecio: ${fmt(pb)} ‚Ç¨.\nVivienda: ${muniTxt} ¬∑ ${m2} m¬≤ ¬∑ ${bd} hab ¬∑ ${ba} ba√±os.\nEntrada: ${(dp*100).toFixed(0)}% ‚Üí ${fmt(down)} ‚Ç¨ ¬∑ Gastos: ${fmt(cl)} ‚Ç¨.\nA financiar: ${fmt(cap)} ‚Ç¨ ¬∑ ${yrs} a√±os ¬∑ ${(rate*100).toFixed(2)}%.\nCuota: ${fmt(pay)} ‚Ç¨ ¬∑ Alquiler: ${fmt(pr)} ‚Ç¨.\nRecomendaci√≥n: ${rec}`;
  Q("#rt").textContent=report;

  let tips=sav>=needCash?"‚Ä¢ Ahorros suficientes\n":(last.msv?`‚Ä¢ Con ahorro mensual llegar√°s en ${(((needCash-sav)/last.msv)/12).toFixed(1)} a√±os\n`:"");
  tips+="\n‚Ä¢ En Catalunya ~10% ITP + notar√≠a.";
  Q("#chartTips").textContent=tips;
  Q("#quickExplain").textContent=recCode==="BUY"?"Encajas: cash OK, esfuerzo OK, horizonte OK. Comprar tiene sentido.":"Falta cash o esfuerzo muy alto. Alquilar es m√°s seguro. C√©ntrate en ahorrar.";

  QA("#t_r,#t_m,#t_x,#t_ai").forEach(t=>t.classList.remove("dis"));
  drawCharts();
  show("r");
};

const renderZoneUI=()=>{
  const sel=zoneSel.size?[...zoneSel].join(", "):"ninguno";
  Q("#zoneNote").textContent="Seleccionados: "+sel;
  Q("#zoneApplied").textContent=zoneSel.size?("Activos: "+[...zoneSel].join(", ")):"";
  Q("#zoneChips").innerHTML=zoneSel.size?[...zoneSel].map(z=>`<span class="pchip on" data-z="${z}">${z}</span>`).join(""):`<span class="pchip off">Sin selecci√≥n</span>`;
  QA("[data-z]").forEach(ch=>ch.onclick=()=>toggleZone(ch.getAttribute("data-z"),true));
};

const applyPolygonState=name=>{
  const poly=polygonsByName.get(name);if(!poly)return;
  const on=zoneSel.has(name);
  poly.setStyle({fillColor:on?"#38bdf8":"#22c55e",fillOpacity:on?.35:.15,color:on?"#38bdf8":"#22c55e",weight:on?3:1.5,opacity:on?.9:.5});
};

const toggleZone=(name,fromChip)=>{
  zoneSel.has(name)?zoneSel.delete(name):zoneSel.add(name);
  applyPolygonState(name);
  renderZoneUI();
  if(!fromChip)localStorage.setItem(ZONE_KEY,JSON.stringify([...zoneSel]));
};

const initMap=()=>{
  if(zmap)return;
  zmap=L.map("zmap",{scrollWheelZoom:false}).setView([41.235,1.595],11);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'¬© OSM'}).addTo(zmap);

  Object.keys(MUNICIPALITY_POLYGONS).forEach(name=>{
    const coords=MUNICIPALITY_POLYGONS[name];
    const poly=L.polygon(coords,{
      fillColor:zoneSel.has(name)?"#38bdf8":"#22c55e",
      fillOpacity:zoneSel.has(name)?.35:.15,
      color:zoneSel.has(name)?"#38bdf8":"#22c55e",
      weight:zoneSel.has(name)?3:1.5,
      opacity:zoneSel.has(name)?.9:.5
    }).addTo(zmap);
    poly.bindTooltip(name,{permanent:false,direction:"center"});
    poly.on("click",()=>toggleZone(name,false));
    polygonsByName.set(name,poly);
  });

  setTimeout(()=>zmap.invalidateSize(),200);
  renderZoneUI();
};

const drawCharts=()=>{
  if(!last)return;
  setTimeout(()=>{
    const cv1=Q("#effChart");
    if(cv1){
      const ctx=cv1.getContext("2d");
      const w=cv1.clientWidth,h=cv1.clientHeight;
      cv1.width=w;cv1.height=h;
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle="#cbd5e1";
      ctx.font="14px sans-serif";
      ctx.fillText("Hipoteca: "+fmt(last.pay)+" ‚Ç¨",20,h/2-10);
      ctx.fillText("Alquiler: "+fmt(last.pr)+" ‚Ç¨",20,h/2+20);
    }

    const cv2=Q("#sensChart");
    if(cv2){
      const ctx=cv2.getContext("2d");
      const w=cv2.clientWidth,h=cv2.clientHeight;
      cv2.width=w;cv2.height=h;
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle="#cbd5e1";
      ctx.font="14px sans-serif";
      ctx.fillText("Tipo actual: "+(last.rate*100).toFixed(2)+"%",20,h/2);
    }
  },100);
};

const addMessageToChat=(role,content)=>{
  const mc=Q("#chatMessages");if(!mc)return;
  const md=document.createElement("div");
  md.className=`chat-message ${role}`;
  md.innerHTML=`<div class="chat-avatar ${role}">${role==="ai"?"AI":"T√ö"}</div><div class="chat-bubble">${content}</div>`;
  mc.appendChild(md);
  mc.scrollTop=mc.scrollHeight;
};

const sendMessageToAI=async msg=>{
  if(isAIProcessing||!msg.trim())return;
  isAIProcessing=true;

  const btn=Q("#chatSend"),inp=Q("#chatInput");
  if(btn)btn.disabled=true;
  if(inp)inp.disabled=true;

  addMessageToChat("user",msg);
  chatHistory.push({role:"user",content:msg});

  const thinking=document.createElement("div");
  thinking.id="thinking-msg";
  thinking.className="chat-message ai";
  thinking.innerHTML=`<div class="chat-avatar ai">AI</div><div class="chat-bubble thinking">Pensando...</div>`;
  Q("#chatMessages").appendChild(thinking);
  Q("#chatMessages").scrollTop=Q("#chatMessages").scrollHeight;

  try{
    const ctx=last?`Usuario: ${last.nm}, Ingresos: ${fmt(last.inc)}‚Ç¨, Ahorros: ${fmt(last.sav)}‚Ç¨, Precio: ${fmt(last.pb)}‚Ç¨, Cuota: ${fmt(last.pay)}‚Ç¨, Recomendaci√≥n: ${last.rec}`:"Sin an√°lisis";
    
    const response=await fetch("https://api.anthropic.com/v1/messages",{
      method:"POST",
      headers:{"Content-Type":"application/json","anthropic-version":"2023-06-01"},
      body:JSON.stringify({
        model:"claude-sonnet-4-20250514",
        max_tokens:1024,
        system:`Eres un asesor financiero experto en vivienda Catalunya. Conciso, pr√°ctico. Contexto: ${ctx}`,
        messages:[...chatHistory.slice(-10),{role:"user",content:msg}]
      })
    });

    const data=await response.json();
    thinking.remove();

    if(data.content?.[0]?.text){
      const aiResp=data.content[0].text;
      addMessageToChat("ai",aiResp);
      chatHistory.push({role:"assistant",content:aiResp});
      localStorage.setItem(CHAT_KEY,JSON.stringify(chatHistory));
    }else throw new Error("Invalid response");
  }catch(e){
    if(thinking.parentNode)thinking.remove();
    console.error("AI error:",e);
    addMessageToChat("ai","Lo siento, no pude procesar tu solicitud.");
  }finally{
    isAIProcessing=false;
    if(btn)btn.disabled=false;
    if(inp){inp.disabled=false;inp.value="";inp.focus()}
  }
};

const initChatUI=()=>{
  const btn=Q("#chatSend"),inp=Q("#chatInput");
  if(btn&&!btn.dataset.init){
    btn.dataset.init="1";
    btn.onclick=()=>{const m=inp?.value.trim();if(m)sendMessageToAI(m)};
  }
  if(inp&&!inp.dataset.init){
    inp.dataset.init="1";
    inp.onkeypress=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();const m=inp.value.trim();if(m)sendMessageToAI(m)}};
  }
  QA(".suggestion-chip").forEach(ch=>{
    if(!ch.dataset.init){
      ch.dataset.init="1";
      ch.onclick=()=>{const q=ch.getAttribute("data-q");if(q)sendMessageToAI(q)};
    }
  });
};

try{const zs=localStorage.getItem(ZONE_KEY);if(zs)zoneSel=new Set(JSON.parse(zs))}catch(e){}

Q("#np").onclick=()=>{if(!Q("#nm").value.trim()||+Q("#ag").value<18){toast("Revisa datos");return}show("e")};
Q("#ne").onclick=()=>show("f");
Q("#go").onclick=analyze;
Q("#cp").onclick=()=>navigator.clipboard.writeText(Q("#rt").textContent).then(()=>toast("Copiado"));
Q("#rs").onclick=()=>{if(confirm("¬øReiniciar?")){localStorage.clear();location.reload()}};
Q("#jumpX").onclick=()=>{if(!last){toast("Analiza primero");return}show("x")};
Q("#jumpAI").onclick=()=>{if(!last){toast("Analiza primero");return}show("ai")};

Q("#t_p").onclick=()=>show("p");
Q("#t_e").onclick=()=>show("e");
Q("#t_f").onclick=()=>show("f");
Q("#t_r").onclick=()=>{if(!last){toast("Analiza primero");return}show("r")};
Q("#t_m").onclick=()=>{if(!last){toast("Analiza primero");return}show("m")};
Q("#t_x").onclick=()=>{if(!last){toast("Analiza primero");return}show("x")};
Q("#t_ai").onclick=()=>{if(!last){toast("Analiza primero");return}show("ai")};

Q("#toggleMap").onclick=()=>{
  const box=Q("#zoneWrap");
  const open=box.style.display!=="none";
  box.style.display=open?"none":"block";
  if(!open){initMap();setTimeout(()=>zmap?.invalidateSize(),200)}
};

Q("#zoneClear").onclick=()=>{
  zoneSel.clear();
  polygonsByName.forEach((_,n)=>applyPolygonState(n));
  renderZoneUI();
  localStorage.setItem(ZONE_KEY,JSON.stringify([]));
  toast("Limpiado");
};

Q("#zoneApply").onclick=()=>{
  if(!zoneSel.size){toast("Selecciona municipios");return}
  const pm=Q("#ar").querySelector('[value="__multi__"]');
  if(pm)pm.remove();
  if(zoneSel.size===1){
    Q("#ar").value=[...zoneSel][0];
  }else{
    const mo=document.createElement("option");
    mo.value="__multi__";
    mo.textContent=[...zoneSel].join(", ");
    Q("#ar").insertBefore(mo,Q("#ar").options[1]);
    Q("#ar").value="__multi__";
  }
  localStorage.setItem(ZONE_KEY,JSON.stringify([...zoneSel]));
  toast("Aplicado");
};

console.log("App initialized v10 - Polygon maps + AI chatbot");
}

waitForLeaflet();
</script>
</body>
</html>
