<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Assessoria d'Habitatge</title>

<style>
:root{
  --bg:#020617;
  --card:rgba(15,23,42,.70);
  --card2:rgba(11,18,32,.88);
  --bd:rgba(148,163,184,.22);
  --bd2:rgba(148,163,184,.30);
  --t:#e5e7eb;
  --m:#94a3b8;
  --mut:#cbd5e1;
  --pill:#38bdf8;
  --p:#06b6d4;--ph:#0891b2;
  --ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;
  --g1:#3b4a60;--g2:#0b1220;
  --shadow-lg:0 10px 40px rgba(0,0,0,.35);
  --shadow-xl:0 20px 60px rgba(0,0,0,.48);
  --gradient-3:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
  --gradient-4:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);
}

html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  position:relative;
  overflow-x:hidden;
}
body::before{
  content:"";
  position:fixed;inset:0;
  background:
    radial-gradient(1400px 700px at 20% -10%,rgba(56,189,248,.18),transparent 60%),
    radial-gradient(1000px 600px at 85% 0%,rgba(34,197,94,.14),transparent 60%),
    radial-gradient(900px 520px at 60% 110%,rgba(168,85,247,.12),transparent 62%),
    linear-gradient(180deg,#0f172a 0%,#020617 55%,#000 100%);
  z-index:-1;pointer-events:none;
  animation:pulse 18s ease-in-out infinite;
}
@keyframes pulse{0%,100%{opacity:.80}50%{opacity:1}}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{opacity:0;transform:translateX(-18px)}to{opacity:1;transform:translateX(0)}}
@keyframes glow{0%,100%{box-shadow:0 0 18px rgba(56,189,248,.22)}50%{box-shadow:0 0 30px rgba(56,189,248,.42)}}

#hx{
  color:var(--t);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
  -webkit-font-smoothing:antialiased;
}
#hx *{box-sizing:border-box}
.w{max-width:1200px;margin:22px auto 18px;padding:0 16px}

.c{
  background:rgba(15,23,42,.86);
  border:1px solid var(--bd);
  border-radius:20px;
  padding:22px;
  margin:16px 0;
  backdrop-filter:blur(14px);
  box-shadow:var(--shadow-lg);
  animation:fadeIn .5s ease-out;
  transition:all .25s ease;
  position:relative;
  overflow:hidden;
}
.c::before{
  content:"";
  position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(56,189,248,.6),transparent);
  opacity:.55
}
.c:hover{border-color:rgba(56,189,248,.42);box-shadow:var(--shadow-xl)}

.r{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.hrow{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.n{opacity:.95;font-size:.95rem;color:#cbd5e1;line-height:1.6}
.small{font-size:.88rem;color:#b6c2d3;line-height:1.5}

.pill{
  background:var(--gradient-3);
  color:#001018;
  border-radius:999px;
  padding:10px 16px;
  font-weight:950;
  letter-spacing:.6px;
  text-transform:uppercase;
  font-size:.88rem;
  box-shadow:0 4px 16px rgba(56,189,248,.32);
  animation:glow 6s ease-in-out infinite;
  white-space:nowrap;
}
.lang{display:flex;gap:10px;align-items:center}
.langbtn{
  border:1px solid rgba(148,163,184,.28);
  background:rgba(11,18,32,.85);
  color:#cbd5e1;
  border-radius:999px;
  padding:8px 14px;
  font-weight:900;
  cursor:pointer;
  transition:all .18s ease;
  font-size:.84rem;
  letter-spacing:.5px;
}
.langbtn:hover{border-color:rgba(56,189,248,.55);transform:translateY(-1px)}
.langbtn.a{
  background:var(--gradient-3);
  color:#001018;
  border-color:#38bdf8;
  box-shadow:0 4px 14px rgba(56,189,248,.28)
}

.tabs{display:flex;gap:10px;margin:16px 0;flex-wrap:wrap;animation:slideIn .6s ease-out}
.tab{
  border:1px solid rgba(148,163,184,.25);
  background:rgba(11,18,32,.80);
  color:#cbd5e1;
  border-radius:999px;
  padding:10px 18px;
  cursor:pointer;
  font-weight:900;
  transition:all .18s ease;
  user-select:none;
  position:relative;
  overflow:hidden;
  font-size:.90rem;
  letter-spacing:.35px;
}
.tab:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(56,189,248,.28)}
.tab.a{background:var(--gradient-3);color:#001018;border-color:#38bdf8;box-shadow:0 4px 14px rgba(56,189,248,.36)}
.tab.dis{opacity:.40;cursor:not-allowed;filter:grayscale(.35)}
.tab.dis:hover{transform:none;box-shadow:none}

.b{
  background:var(--gradient-3);
  color:#001018;border:0;border-radius:14px;padding:12px 20px;
  cursor:pointer;font-weight:950;transition:all .18s ease;
  box-shadow:0 4px 15px rgba(56,189,248,.28);
  font-size:.95rem;letter-spacing:.3px;position:relative;overflow:hidden
}
.b:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(56,189,248,.42)}
.b.ok{background:var(--gradient-4);box-shadow:0 4px 15px rgba(67,233,123,.22)}
.b.ok:hover{box-shadow:0 6px 20px rgba(67,233,123,.42)}
.b.dis{opacity:.45;cursor:not-allowed;filter:grayscale(.25);transform:none;pointer-events:none}

.g{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
@media(max-width:900px){.g{grid-template-columns:1fr}}

#hx input[type=text],#hx input[type=number],#hx select, #hx textarea{
  width:100%;
  padding:12px 14px;
  border:1px solid rgba(148,163,184,.30);
  border-radius:12px;
  background:rgba(2,6,23,.86);
  color:var(--t);
  outline:none;
  transition:all .18s ease;
  font-size:.95rem
}
#hx input[type=text]:focus,#hx input[type=number]:focus,#hx select:focus,#hx textarea:focus{
  border-color:#38bdf8;
  box-shadow:0 0 0 4px rgba(56,189,248,.14);
  background:rgba(2,6,23,.96)
}
#hx input[type=checkbox]{accent-color:#38bdf8;width:18px;height:18px;cursor:pointer}
#hx label{color:#cbd5e1;font-weight:750;margin-bottom:6px;display:block;font-size:.9rem;letter-spacing:.25px}

.gu{
  margin-top:12px;padding:14px 16px;
  background:rgba(56,189,248,.08);
  border:1px solid rgba(56,189,248,.25);
  border-radius:14px;color:#dbeafe;
  display:flex;gap:12px;align-items:flex-start;
  border-left:4px solid #38bdf8
}
.gu .a{font-weight:950;line-height:1.2;margin-top:1px;font-size:1.15rem}

.tst{
  position:fixed;left:50%;bottom:22px;transform:translateX(-50%);
  background:rgba(2,6,23,.94);
  border:1px solid rgba(148,163,184,.35);
  color:var(--t);padding:10px 14px;border-radius:12px;
  opacity:0;pointer-events:none;transition:.2s;z-index:99999
}
.tst.s{opacity:1}

.sig{
  max-width:1100px;margin:10px auto 18px;padding:10px 12px;
  color:#a5b4fc;background:rgba(10,16,28,.65);
  border:1px solid rgba(148,163,184,.25);border-radius:12px;
  display:flex;gap:12px;align-items:center;justify-content:space-between;font-size:.95rem
}
.sig .br{font-weight:950;color:#e2e8f0}
.sig a{color:#93c5fd;text-decoration:none}
.sig a:hover{text-decoration:underline}

/* cards */
.cardx{
  margin-top:16px;
  background:linear-gradient(135deg,rgba(15,23,42,.86),rgba(11,18,32,.92));
  border:1px solid rgba(148,163,184,.25);
  border-radius:16px;padding:20px;
  box-shadow:0 4px 22px rgba(0,0,0,.22)
}
.cardx .top{
  display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;
  padding-bottom:16px;border-bottom:1px solid rgba(148,163,184,.14)
}
.cardx .title{font-weight:1000;color:#f1f5f9;font-size:1.15rem}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{
  border:1px solid rgba(148,163,184,.30);
  background:rgba(11,18,32,.82);
  color:#cbd5e1;border-radius:999px;
  padding:8px 14px;font-weight:850;font-size:.85rem;transition:.15s;
  text-shadow:0 1px 8px rgba(0,0,0,.25);
}
.chip:hover{transform:translateY(-1px)}
.chip.good{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.12);color:#86efac}
.chip.bad{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.12);color:#fca5a5}
.chip.warn{border-color:rgba(245,158,11,.45);background:rgba(245,158,11,.12);color:#fde68a}
.chip.neu{border-color:rgba(148,163,184,.35);color:#e2e8f0}

.body{margin-top:16px;color:#cbd5e1;line-height:1.65;font-size:.95rem}
.body b{color:#f8fafc;font-weight:800}

.grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:16px}
@media(max-width:980px){.grid3{grid-template-columns:1fr}}

.mini{
  background:linear-gradient(135deg,rgba(14,165,233,.10),rgba(6,182,212,.06));
  border:1px solid rgba(148,163,184,.25);
  border-radius:14px;padding:14px;transition:.15s
}
.mini:hover{border-color:rgba(56,189,248,.40);transform:translateY(-1px)}
.mini .h{color:#94a3b8;font-size:.82rem;font-weight:800;text-transform:uppercase;letter-spacing:.5px}
.mini .v{
  font-weight:1000;color:#f8fafc;margin-top:6px;font-size:1.15rem;
  text-shadow:0 2px 12px rgba(0,0,0,.35);
}
.note{
  margin-top:16px;color:#cbd5e1;white-space:pre-wrap;
  background:rgba(2,6,23,.62);
  padding:16px;border-radius:12px;border:1px solid rgba(148,163,184,.20);
  line-height:1.7;font-size:.92rem
}

/* KPI row */
.k{
  background:linear-gradient(145deg,rgba(14,165,233,.10),rgba(6,182,212,.06));
  border:1px solid rgba(56,189,248,.30);
  border-radius:18px;padding:18px 14px;text-align:left;
  position:relative;overflow:hidden;
  box-shadow:0 4px 18px rgba(0,0,0,.25);
  min-height:86px;
}
.k::before{
  content:"";
  position:absolute;inset:-40%;
  background:radial-gradient(circle,rgba(56,189,248,.10),transparent 70%);
  pointer-events:none;transition:transform .6s ease;
}
.k:hover::before{transform:scale(1.12)}
.k span{
  color:#a6b3c6;font-size:.78rem;font-weight:900;
  text-transform:uppercase;letter-spacing:.9px;display:block
}
.k b{
  font-size:30px;display:block;color:#f1f5f9;margin-top:10px;font-weight:1000;
  text-shadow:0 2px 14px rgba(0,0,0,.45);
  line-height:1.05;
}
.k .sub{
  margin-top:8px;
  font-size:.82rem;
  color:#9fb0c6;
  line-height:1.25;
}
@media(max-width:520px){ .k b{font-size:26px} }

/* progress bars */
.pbar-wrap{margin-top:8px;background:rgba(255,255,255,.07);border-radius:999px;height:8px;overflow:hidden}
.pbar{height:8px;border-radius:999px;transition:width .9s cubic-bezier(.4,0,.2,1)}
.pbar.good{background:linear-gradient(90deg,#22c55e,#4ade80)}
.pbar.warn{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.pbar.bad{background:linear-gradient(90deg,#ef4444,#f87171)}

/* tooltip */
.tip{position:relative;display:inline-flex;align-items:center;gap:4px}
.tip-icon{
  width:16px;height:16px;border-radius:50%;
  background:rgba(148,163,184,.22);color:#b6c2d3;
  font-size:10px;font-weight:950;
  cursor:help;display:inline-flex;align-items:center;justify-content:center;
  border:1px solid rgba(148,163,184,.30);flex-shrink:0;user-select:none
}
.tip-box{
  position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);
  background:#0f172a;border:1px solid rgba(56,189,248,.35);
  border-radius:10px;padding:10px 14px;color:#cbd5e1;
  font-size:.82rem;line-height:1.5;width:240px;z-index:9999;
  box-shadow:0 10px 26px rgba(0,0,0,.55);
  pointer-events:none;opacity:0;transition:opacity .14s;
}
.tip:hover .tip-box,.tip:focus-within .tip-box{opacity:1}

/* step indicator */
.steps{display:flex;align-items:center;margin-bottom:16px;animation:fadeIn .45s ease-out}
.step{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1;position:relative}
.step-dot{
  width:32px;height:32px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-weight:1000;font-size:.85rem;
  transition:all .25s ease;
  border:2px solid rgba(148,163,184,.22);
  background:rgba(11,18,32,.82);
  color:#94a3b8;z-index:1
}
.step.done .step-dot{background:var(--gradient-4);color:#001018;border-color:#22c55e;box-shadow:0 0 12px rgba(34,197,94,.35)}
.step.active .step-dot{background:var(--gradient-3);color:#001018;border-color:#38bdf8;box-shadow:0 0 12px rgba(56,189,248,.42)}
.step-label{font-size:.72rem;color:#475569;font-weight:850;text-align:center;white-space:nowrap}
.step.done .step-label,.step.active .step-label{color:#94a3b8}
.step-line{
  position:absolute;top:15px;left:calc(50% + 17px);
  width:calc(100% - 34px);height:2px;background:rgba(148,163,184,.14);
  transition:background .3s;z-index:0
}
.step.done .step-line{background:rgba(34,197,94,.28)}

/* share bar */
.share-bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;padding-top:12px;border-top:1px solid rgba(148,163,184,.12)}
.share-btn{
  border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.82);color:#cbd5e1;
  border-radius:10px;padding:8px 14px;cursor:pointer;font-weight:850;font-size:.82rem;
  transition:all .18s ease;display:flex;align-items:center;gap:6px
}
.share-btn:hover{transform:translateY(-2px)}
.share-btn.wa{border-color:rgba(37,211,102,.40);color:#4ade80}
.share-btn.wa:hover{background:rgba(37,211,102,.10);box-shadow:0 4px 12px rgba(37,211,102,.18)}
.share-btn.cl{border-color:rgba(56,189,248,.40);color:#7dd3fc}
.share-btn.cl:hover{background:rgba(56,189,248,.10);box-shadow:0 4px 12px rgba(56,189,248,.18)}

/* field validation */
#hx input.field-ok{border-color:rgba(34,197,94,.50)!important}
#hx input.field-err{border-color:rgba(239,68,68,.52)!important;box-shadow:0 0 0 3px rgba(239,68,68,.10)!important}
.field-hint{font-size:.78rem;margin-top:4px;min-height:16px;transition:all .2s}
.field-hint.ok{color:#4ade80}
.field-hint.err{color:#f87171}

/* range */
.range-bar{display:flex;gap:6px;align-items:center;margin-top:6px;flex-wrap:wrap}
.range-tag{font-size:.75rem;border-radius:8px;padding:2px 7px;font-weight:850}
.range-tag.lo{background:rgba(34,197,94,.12);color:#86efac;border:1px solid rgba(34,197,94,.25)}
.range-tag.hi{background:rgba(239,68,68,.12);color:#fca5a5;border:1px solid rgba(239,68,68,.25)}

/* countdown */
.countdown{
  margin-top:10px;padding:12px 14px;background:rgba(245,158,11,.08);
  border:1px solid rgba(245,158,11,.25);border-radius:12px;border-left:4px solid #f59e0b;
  color:#fde68a;font-size:.88rem;line-height:1.6
}

/* map */
#zoneWrap{margin-top:12px}
#zmap{height:420px;border-radius:12px;border:1px solid rgba(148,163,184,.22);overflow:hidden;max-width:100%}
.pchips{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.pchip{
  border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.75);color:#cbd5e1;border-radius:999px;
  padding:6px 10px;font-weight:1000;font-size:.85rem;cursor:pointer
}
.pchip.on{border-color:#38bdf8;color:#dbeafe}
.pchip.off{opacity:.75}
.legend{
  display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;
  padding:10px 12px;background:rgba(2,6,23,.45);
  border:1px solid rgba(148,163,184,.18);border-radius:12px;
  color:#bcd0ea;font-size:.86rem;
}
.legdot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:middle}
.leg1{background:#38bdf8}
.leg2{background:#22c55e}
.leg3{background:#ef4444}

/* charts */
.chartCard{
  background:linear-gradient(135deg,rgba(2,6,23,.35),rgba(15,23,42,.35));
  border:1px solid rgba(148,163,184,.18);
  border-radius:14px;
  padding:14px;
}
.canvasWrap{
  border:1px solid rgba(148,163,184,.16);
  border-radius:12px;
  overflow:hidden;
  background:rgba(2,6,23,.45);
}
canvas{display:block;width:100%;height:240px}
@media(max-width:700px){canvas{height:220px}}

::selection{background:rgba(56,189,248,.25)}

/* --------- NEW: AI chat UI --------- */
.chatWrap{
  display:flex;
  flex-direction:column;
  gap:12px;
}
.chatBox{
  border:1px solid rgba(148,163,184,.22);
  background:rgba(2,6,23,.55);
  border-radius:14px;
  padding:12px;
  height:420px;
  overflow:auto;
}
.msg{
  display:flex;
  gap:10px;
  margin:10px 0;
  align-items:flex-start;
}
.bubble{
  max-width:820px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(148,163,184,.16);
  white-space:pre-wrap;
  line-height:1.6;
  font-size:.93rem;
}
.msg.user .bubble{
  background:rgba(56,189,248,.10);
  border-color:rgba(56,189,248,.22);
}
.msg.ai .bubble{
  background:rgba(34,197,94,.08);
  border-color:rgba(34,197,94,.20);
}
.rolePill{
  font-weight:1000;
  font-size:.72rem;
  letter-spacing:.6px;
  text-transform:uppercase;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.22);
  background:rgba(11,18,32,.78);
  color:#cbd5e1;
  flex-shrink:0;
}
.msg.user .rolePill{border-color:rgba(56,189,248,.35);color:#7dd3fc}
.msg.ai .rolePill{border-color:rgba(34,197,94,.30);color:#86efac}

.chatInputRow{
  display:flex;
  gap:10px;
  align-items:flex-end;
  flex-wrap:wrap;
}
#aiQ{
  min-height:54px;
  resize:vertical;
}
.badgeWarn{
  margin-top:10px;
  font-size:.86rem;
  color:#cbd5e1;
  background:rgba(239,68,68,.06);
  border:1px solid rgba(239,68,68,.18);
  border-left:4px solid #ef4444;
  padding:12px 14px;
  border-radius:12px;
  line-height:1.6;
}
</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
</head>

<body>
<div class="w" id="hx">

  <div class="c hrow">
    <div class="pill" data-i="hdrTitle">Assessoria d'Habitatge ¬∑ Baix Pened√®s</div>
    <div class="r" style="justify-content:flex-end;flex:1">
      <div class="n" data-i="hdrHint">Ejemplos reales: solo despu√©s de Analizar.</div>
      <div class="lang" aria-label="Idioma">
        <button class="langbtn" id="L_CA" type="button">CA</button>
        <button class="langbtn a" id="L_ES" type="button">ES</button>
        <button class="langbtn" id="L_EN" type="button">EN</button>
      </div>
    </div>
  </div>

  <div class="steps" id="stepBar">
    <div class="step active" id="stp1"><div class="step-dot" id="sdot1">1</div><div class="step-label" id="slbl1">Personal</div><div class="step-line"></div></div>
    <div class="step" id="stp2"><div class="step-dot" id="sdot2">2</div><div class="step-label" id="slbl2">Econom√≠a</div><div class="step-line"></div></div>
    <div class="step" id="stp3"><div class="step-dot" id="sdot3">3</div><div class="step-label" id="slbl3">Preferencias</div><div class="step-line"></div></div>
    <div class="step" id="stp4"><div class="step-dot" id="sdot4">4</div><div class="step-label" id="slbl4">Resultado</div></div>
  </div>

  <div class="tabs">
    <div id="t_p" class="tab a" data-i="tab1">1 Personal</div>
    <div id="t_e" class="tab" data-i="tab2">2 Econom√≠a</div>
    <div id="t_f" class="tab" data-i="tab3">3 Preferencias</div>
    <div id="t_r" class="tab" data-i="tab4">4 Resultado</div>
    <div id="t_m" class="tab" data-i="tab5">5 Comparador</div>
    <div id="t_x" class="tab" data-i="tab6">6 Ejemplos reales</div>
    <!-- NEW TAB (does not break existing structure): -->
    <div id="t_ai" class="tab" data-i="tab7">7 IA Asesor</div>
  </div>

  <!-- 1 Personal -->
  <div class="c" data-p="p">
    <div class="g">
      <div><label data-i="lblName">Nombre y apellidos</label><input id="nm" type="text" autocomplete="name"></div>
      <div><label data-i="lblAge">Edad (18‚Äì100)</label><input id="ag" type="number" min="18" max="100"></div>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintP">Rellena los datos b√°sicos para continuar.</div></div>
    <div class="r" style="margin-top:10px"><button class="b" id="np" type="button" data-i="btnContinue">Continuar</button></div>
  </div>

  <!-- 2 Econom√≠a -->
  <div class="c" data-p="e" style="display:none">
    <div class="g">
      <div>
        <label data-i="lblInc">Ingresos mensuales (‚Ç¨)</label>
        <div class="tip">
          <input id="inc" type="number" min="0">
          <span class="tip-icon" tabindex="0">i</span>
          <span class="tip-box" data-i="tipInc">Ingresos netos (lo que realmente entra en tu cuenta). Si metes bruto, la recomendaci√≥n se distorsiona.</span>
        </div>
        <div class="field-hint" id="hint-inc"></div>
      </div>

      <div>
        <label data-i="lblSav">Ahorros disponibles (‚Ç¨)</label>
        <div class="tip">
          <input id="sav" type="number" min="0">
          <span class="tip-icon" tabindex="0">i</span>
          <span class="tip-box" data-i="tipSav">Solo lo que puedes usar de verdad (no ‚Äúdinero que igual me prestan‚Äù). Entrada + impuestos + notar√≠a van aqu√≠.</span>
        </div>
        <div class="field-hint" id="hint-sav"></div>
      </div>

      <div><label data-i="lblYrs">A√±os de hipoteca (5‚Äì40)</label><input id="yrs" type="number" min="5" max="40"></div>
      <div><label data-i="lblHor">¬øVivir√°s m√°s de 5 a√±os aqu√≠?</label><select id="hor"><option value="y" data-i="yes">S√≠</option><option value="n" data-i="no">No</option></select></div>
      <div><label data-i="lblFst">¬øPrimera vivienda o familia con menores?</label><select id="fst"><option value="y" data-i="yes">S√≠</option><option value="n" data-i="no">No</option></select></div>

      <div>
        <label data-i="lblMsv">Ahorro mensual (‚Ç¨)</label>
        <div class="tip">
          <input id="msv" type="number" min="0">
          <span class="tip-icon" tabindex="0">i</span>
          <span class="tip-box" data-i="tipMsv">Sirve para estimar cu√°nto tardas en llegar al ‚Äúcash necesario‚Äù si hoy no te da.</span>
        </div>
      </div>
    </div>

    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintE">Completa econom√≠a y sigue a preferencias.</div></div>
    <div class="r" style="margin-top:10px"><button class="b" id="ne" type="button" data-i="btnContinue">Continuar</button></div>
  </div>

  <!-- 3 Preferencias -->
  <div class="c" data-p="f" style="display:none">
    <div class="g">
      <div>
        <label data-i="lblMuni">Municipio (Baix Pened√®s)</label>
        <select id="ar">
          <option value="*">Cualquiera</option>
          <option>Cunit</option><option>El Vendrell</option><option>Calafell</option><option>Santa Oliva</option><option>Bellvei</option>
          <option>L'Arbo√ß</option><option>Banyeres del Pened√®s</option><option>Albinyana</option><option>Bonastre</option><option>Maslloren√ß</option>
          <option>La Bisbal del Pened√®s</option><option>Lloren√ß del Pened√®s</option><option>Sant Jaume dels Domenys</option><option>El Montmell</option>
        </select>
        <div class="small" style="margin-top:6px" data-i="lblMuniHelp">Si usas el mapa puedes elegir varios municipios para 'Ejemplos reales'.</div>
      </div>

      <div>
        <label data-i="lblM2">Metros cuadrados (‚â•50)</label>
        <input id="m2" type="number" min="50">
        <div class="field-hint" id="hint-m2"></div>
      </div>

      <div><label data-i="lblBed">Habitaciones</label><input id="bed" type="number" min="0" max="10"></div>
      <div><label data-i="lblBath">Ba√±os</label><input id="bat" type="number" min="1" max="10"></div>
      <div><label data-i="lblType">Tipo de vivienda</label><select id="ty"><option value="flat" data-i="optFlat">Piso</option><option value="house" data-i="optHouse">Casa</option></select></div>

      <div class="r" style="align-items:flex-start">
        <div style="width:100%">
          <label data-i="lblExtras">Extras (opcional)</label>
          <div class="small" data-i="lblExtrasHint">No son ‚Äúcaprichos‚Äù: cambian precio estimado y filtros de ejemplos reales.</div>
          <div class="r" style="margin-top:8px">
            <label><input type="checkbox" id="et"><span data-i="exTer">Terraza</span></label>
            <label><input type="checkbox" id="ep"><span data-i="exPis">Piscina</span></label>
            <label><input type="checkbox" id="el"><span data-i="exAsc">Ascensor</span></label>
            <label><input type="checkbox" id="ek"><span data-i="exGar">Aparcamiento</span></label>
            <label><input type="checkbox" id="es"><span data-i="exSto">Trastero</span></label>
            <label><input type="checkbox" id="ej"><span data-i="exGarD">Jard√≠n</span></label>
            <label><input type="checkbox" id="ea"><span data-i="exAir">Aire acondicionado</span></label>
          </div>
        </div>
      </div>
    </div>

    <div class="r" style="margin-top:10px">
      <button class="b" id="go" type="button" data-i="btnAnalyze">Analizar</button>
      <button class="b ok" id="toggleMap" type="button" data-i="btnMap">Mapa (zona real)</button>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintF">Si cambias preferencias, vuelve a Analizar para actualizar el resultado.</div></div>

    <div id="zoneWrap" class="cardx" style="display:none">
      <div class="top">
        <div>
          <div class="title" data-i="zoneTitle">Zona preferida (mapa real)</div>
          <div class="n" data-i="zoneHint">Haz clic en un municipio para seleccionarlo. Puedes elegir varios del Baix Pened√®s.</div>
          <div class="n" id="zoneNote" style="margin-top:6px">Seleccionados: ninguno</div>
        </div>
        <div class="pchips" id="zoneChips"></div>
      </div>

      <div class="r" style="margin-top:10px;justify-content:flex-end">
        <button class="b" id="zoneClear" type="button" data-i="btnClear">Limpiar</button>
        <button class="b ok" id="zoneApply" type="button" data-i="btnUse">Usar en Ejemplos reales</button>
      </div>

      <div id="zmap" style="margin-top:10px"></div>

      <div class="legend">
        <span><span class="legdot leg1"></span><span data-i="legSel">Seleccionado</span></span>
        <span><span class="legdot leg2"></span><span data-i="legOk">Buena se√±al</span></span>
        <span><span class="legdot leg3"></span><span data-i="legRisk">Riesgo</span></span>
        <span style="opacity:.9" data-i="legNote">Tip: aqu√≠ no ‚Äúaciertas‚Äù: haces tu b√∫squeda m√°s realista y m√°s f√°cil.</span>
      </div>

      <div class="n" id="zoneApplied" style="margin-top:10px"></div>

      <div class="badgeWarn" id="geojsonWarn" style="display:none">
        ‚ö†Ô∏è No se ha podido cargar el archivo de pol√≠gonos.
        <br>Para que el mapa pinte l√≠mites municipales reales, a√±ade un archivo <b>baix-penedes-munis.geojson</b> junto a este HTML (o cambia la URL en el c√≥digo).
      </div>
    </div>
  </div>

  <!-- 4 Resultado -->
  <div class="c" data-p="r" style="display:none">
    <div class="g">
      <div class="k">
        <span data-i="kPrice">Precio estimado</span>
        <b id="k1">0 ‚Ç¨</b>
        <div class="sub" id="k1sub"></div>
      </div>
      <div class="k">
        <span data-i="kRent">Alquiler estimado</span>
        <b id="k2">0 ‚Ç¨</b>
        <div class="sub" id="k2sub"></div>
      </div>
      <div class="k">
        <span data-i="kPay">Cuota hipoteca</span>
        <b id="k3">0 ‚Ç¨</b>
        <div class="sub" id="k3sub"></div>
      </div>
      <div class="k">
        <span data-i="kRec">Recomendaci√≥n</span>
        <b id="k4">‚Äì</b>
        <div class="sub" id="k4sub"></div>
      </div>
    </div>

    <div id="rCard" class="cardx" style="display:none">
      <div class="top">
        <div class="title" id="rTitle"></div>
        <div class="chips" id="rChips"></div>
      </div>

      <div class="grid3" id="rMini"></div>

      <!-- Charts row -->
      <div class="grid3" style="margin-top:14px">
        <div class="chartCard">
          <div style="font-weight:950;color:#eaf2ff" data-i="chartEffTitle">Esfuerzo mensual (visual)</div>
          <div class="small" data-i="chartEffHint">L√≠nea: ‚Äúcapacidad segura‚Äù (35% de ingresos). Barras: hipoteca vs alquiler.</div>
          <div class="canvasWrap" style="margin-top:10px"><canvas id="effChart"></canvas></div>
        </div>
        <div class="chartCard">
          <div style="font-weight:950;color:#eaf2ff" data-i="chartSensTitle">Sensibilidad (tipo de inter√©s)</div>
          <div class="small" data-i="chartSensHint">C√≥mo cambia la cuota si sube el tipo. No predice el futuro, solo muestra el riesgo.</div>
          <div class="canvasWrap" style="margin-top:10px"><canvas id="sensChart"></canvas></div>
        </div>
        <div class="chartCard">
          <div style="font-weight:950;color:#eaf2ff" data-i="chartTipsTitle">Lectura r√°pida</div>
          <div class="small" id="chartTips"></div>
          <div style="margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.18);background:rgba(2,6,23,.35);color:#cbd5e1;line-height:1.65" id="quickExplain"></div>
        </div>
      </div>

      <div class="body" id="rBody"></div>
      <div class="note" id="rt"></div>
    </div>

    <div class="r" style="margin-top:10px">
      <button class="b" id="cp" type="button" data-i="btnCopy">Copiar resumen</button>
      <button class="b" id="rs" type="button" data-i="btnReset">Reiniciar</button>
      <button class="b ok" id="jumpX" type="button" data-i="btnGoExamples">Ir a Ejemplos reales</button>
      <!-- NEW quick jump to AI -->
      <button class="b ok" id="jumpAI" type="button">Ir a IA Asesor</button>
    </div>
    <div class="share-bar">
      <button class="share-btn wa" id="shareWa" type="button">üì± WhatsApp</button>
      <button class="share-btn cl" id="shareCl" type="button">üìã <span data-i="btnCopy2">Copiar</span></button>
    </div>
  </div>

  <!-- 5 Comparador -->
  <div class="c" data-p="m" style="display:none">
    <div class="g">
      <div><label data-i="lblProv">Provincia (comparador)</label><select id="cm"><option>Barcelona</option><option>Girona</option><option>Lleida</option><option>Tarragona</option></select></div>
      <div><label data-i="lblM2s">m¬≤</label><input id="cm2" type="number" min="50"></div>
      <div><label data-i="lblBed">Habitaciones</label><input id="cbd" type="number" min="0" max="10"></div>
      <div><label data-i="lblBath">Ba√±os</label><input id="cba" type="number" min="1" max="10"></div>
      <div><label data-i="lblType2">Tipo</label><select id="cty"><option value="flat" data-i="optFlat">Piso</option><option value="house" data-i="optHouse">Casa</option></select></div>

      <div class="r" style="align-items:flex-start">
        <div style="width:100%">
          <label data-i="lblExtras2">Extras (comparador)</label>
          <div class="small" data-i="lblExtrasHint2">El comparador intenta ser justo: mismas caracter√≠sticas, distinta zona.</div>
          <div class="r" style="margin-top:8px">
            <label><input type="checkbox" id="ct"><span data-i="exTer">Terraza</span></label>
            <label><input type="checkbox" id="cp0"><span data-i="exPis">Piscina</span></label>
            <label><input type="checkbox" id="cl0"><span data-i="exAsc">Ascensor</span></label>
            <label><input type="checkbox" id="ck0"><span data-i="exGar">Aparcamiento</span></label>
            <label><input type="checkbox" id="cs0"><span data-i="exSto">Trastero</span></label>
            <label><input type="checkbox" id="cj0"><span data-i="exGarD">Jard√≠n</span></label>
            <label><input type="checkbox" id="ca0"><span data-i="exAir">Aire acondicionado</span></label>
          </div>
        </div>
      </div>
    </div>

    <div id="cmap" style="width:100%;height:320px;border:0;border-radius:12px;margin-top:12px"></div>

    <div class="r" style="margin-top:10px">
      <button class="b" id="bc" type="button" data-i="btnCompare">Comparar</button>
      <button class="b ok" id="autoFillCmp" type="button" data-i="btnUseMine">Usar mis datos</button>
    </div>

    <div class="cardx" style="margin-top:12px">
      <div class="top">
        <div class="title" data-i="cmpTitle">Resultado del comparador</div>
        <div class="chips" id="cmpChips"></div>
      </div>
      <div class="body" id="cmg"></div>

      <div class="chartCard" style="margin-top:14px">
        <div style="font-weight:950;color:#eaf2ff" data-i="cmpChartTitle">Comparaci√≥n visual</div>
        <div class="small" data-i="cmpChartHint">Tu zona (estimaci√≥n) vs provincia (estimaci√≥n). Misma vivienda, distinto contexto.</div>
        <div class="canvasWrap" style="margin-top:10px"><canvas id="cmpChart"></canvas></div>
      </div>
    </div>
  </div>

  <!-- 6 Ejemplos reales -->
  <div class="c" data-p="x" style="display:none">
    <div class="n" id="xinfo"></div>
    <div class="r" style="margin-top:10px" id="xbtns"></div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintX">Si elegiste varios municipios, salen botones por municipio (Idealista no soporta multi-municipio en 1 sola URL).</div></div>
  </div>

  <!-- 7 IA Asesor (NEW) -->
  <div class="c" data-p="ai" style="display:none">
    <div class="cardx">
      <div class="top">
        <div>
          <div class="title">ü§ñ IA Asesor (estilo ChatGPT)</div>
          <div class="n" id="aiHint">
            Pregunta lo que quieras: hipoteca vs alquiler, cu√°nto deber√≠as ahorrar, si tu esfuerzo es razonable, qu√© recortar, etc.
            <br><span style="opacity:.9">Usa tu an√°lisis actual como contexto si ya has pulsado ‚ÄúAnalizar‚Äù.</span>
          </div>
        </div>
        <div class="chips" id="aiChips"></div>
      </div>

      <div class="chatWrap" style="margin-top:14px">
        <div class="chatBox" id="aiChat" aria-label="Chat IA"></div>

        <div class="chatInputRow">
          <div style="flex:1;min-width:260px">
            <label>Tu pregunta</label>
            <textarea id="aiQ" placeholder="Ej.: ¬øQu√© tengo que mejorar para poder comprar sin ir ahogado?"></textarea>
          </div>
          <div class="r" style="align-items:center">
            <button class="b ok" id="aiAsk" type="button">Enviar</button>
            <button class="b" id="aiClear" type="button">Limpiar chat</button>
          </div>
        </div>

        <div class="badgeWarn">
          ‚ö†Ô∏è <b>Aviso</b>: La IA no sustituye asesoramiento financiero profesional. No compartas datos sensibles (DNI, cuentas, etc.).
        </div>
      </div>
    </div>
  </div>

</div>

<div class="sig">
  <div class="br">Assessoria d'Habitatge</div>
  <div>
    <a href="https://www.assesoriahabitatge.com/" target="_blank" rel="noopener">assesoriahabitatge.com</a> ¬∑
    <a href="mailto:info@assesoriahabitatge.com">info@assesoriahabitatge.com</a>
  </div>
</div>

<div id="ts" class="tst" role="status" aria-live="polite"></div>

<script>
let attempts=0,maxAttempts=100;
function waitForLeaflet(){
  if(typeof L!=="undefined") initApp();
  else if(attempts<maxAttempts){attempts++;setTimeout(waitForLeaflet,50);}
  else{console.error("Leaflet no se pudo cargar");alert("Error: No se pudo cargar el mapa. Recarga la p√°gina.");}
}

function initApp(){
(()=> {
  const Q=s=>document.querySelector(s);
  const QA=s=>[...document.querySelectorAll(s)];
  const fmtES=n=>Math.round(n).toLocaleString("es-ES");
  const fmtEN=n=>Math.round(n).toLocaleString("en-US");
  const pctEN=n=>Number(n).toFixed(1)+"%";
  const pctES=n=>Number(n).toFixed(1)+"%";

  const STORE_KEY="hx_form_v8";
  const ZONE_KEY="hx_zoneSel_v5";
  const LANG_KEY="hx_lang";
  const AI_CHAT_KEY="hx_ai_chat_v1";

  const I18N={
    ES:{
      hdrTitle:"Assessoria d'Habitatge ¬∑ Baix Pened√®s",
      hdrHint:"Ejemplos reales: solo despu√©s de Analizar.",
      tab1:"1 Personal",tab2:"2 Econom√≠a",tab3:"3 Preferencias",tab4:"4 Resultado",tab5:"5 Comparador",tab6:"6 Ejemplos reales",tab7:"7 IA Asesor",
      lblName:"Nombre y apellidos",lblAge:"Edad (18‚Äì100)",btnContinue:"Continuar",
      hintP:"Rellena los datos b√°sicos para continuar.",
      lblInc:"Ingresos mensuales (‚Ç¨)",lblSav:"Ahorros disponibles (‚Ç¨)",lblYrs:"A√±os de hipoteca (5‚Äì40)",lblHor:"¬øVivir√°s m√°s de 5 a√±os aqu√≠?",lblFst:"¬øPrimera vivienda o familia con menores?",lblMsv:"Ahorro mensual (‚Ç¨)",
      tipInc:"Ingresos netos (lo que realmente entra en tu cuenta). Si metes bruto, la recomendaci√≥n se distorsiona.",
      tipSav:"Solo lo que puedes usar de verdad (no ‚Äúdinero que igual me prestan‚Äù). Entrada + impuestos + notar√≠a van aqu√≠.",
      tipMsv:"Sirve para estimar cu√°nto tardas en llegar al ‚Äúcash necesario‚Äù si hoy no te da.",
      hintE:"Completa econom√≠a y sigue a preferencias.",
      lblMuni:"Municipio (Baix Pened√®s)",lblMuniHelp:"Si usas el mapa puedes elegir varios municipios para 'Ejemplos reales'.",
      lblM2:"Metros cuadrados (‚â•50)",lblBed:"Habitaciones",lblBath:"Ba√±os",lblType:"Tipo de vivienda",optFlat:"Piso",optHouse:"Casa",
      lblExtras:"Extras (opcional)",lblExtrasHint:"No son ‚Äúcaprichos‚Äù: cambian precio estimado y filtros de ejemplos reales.",
      exTer:"Terraza",exPis:"Piscina",exAsc:"Ascensor",exGar:"Aparcamiento",exSto:"Trastero",exGarD:"Jard√≠n",exAir:"Aire acondicionado",
      btnAnalyze:"Analizar",btnMap:"Mapa (zona real)",hintF:"Si cambias preferencias, vuelve a Analizar para actualizar el resultado.",
      zoneTitle:"Zona preferida (mapa real)",zoneHint:"Haz clic en un municipio para seleccionarlo. Puedes elegir varios del Baix Pened√®s.",
      btnClear:"Limpiar",btnUse:"Usar en Ejemplos reales",
      legSel:"Seleccionado",legOk:"Buena se√±al",legRisk:"Riesgo",legNote:"Tip: aqu√≠ no ‚Äúaciertas‚Äù: haces tu b√∫squeda m√°s realista y m√°s f√°cil.",
      kPrice:"Precio estimado",kRent:"Alquiler estimado",kPay:"Cuota hipoteca",kRec:"Recomendaci√≥n",
      btnCopy:"Copiar resumen",btnReset:"Reiniciar",btnGoExamples:"Ir a Ejemplos reales",
      chartEffTitle:"Esfuerzo mensual (visual)",chartEffHint:"L√≠nea: ‚Äúcapacidad segura‚Äù (35% de ingresos). Barras: hipoteca vs alquiler.",
      chartSensTitle:"Sensibilidad (tipo de inter√©s)",chartSensHint:"C√≥mo cambia la cuota si sube el tipo. No predice el futuro, solo muestra el riesgo.",
      chartTipsTitle:"Lectura r√°pida",
      lblProv:"Provincia (comparador)",lblM2s:"m¬≤",lblType2:"Tipo",btnCompare:"Comparar",btnUseMine:"Usar mis datos",
      lblExtras2:"Extras (comparador)",lblExtrasHint2:"El comparador intenta ser justo: mismas caracter√≠sticas, distinta zona.",
      cmpTitle:"Resultado del comparador",cmpChartTitle:"Comparaci√≥n visual",cmpChartHint:"Tu zona (estimaci√≥n) vs provincia (estimaci√≥n). Misma vivienda, distinto contexto.",
      hintX:"Si elegiste varios municipios, salen botones por municipio (Idealista no soporta multi-municipio en 1 sola URL).",
      yes:"S√≠",no:"No",
      recBuy:"COMPRAR",recRent:"ALQUILAR",recNotFeasible:"NO FACTIBLE",
      toastCheckNameAge:"Revisa nombre/edad y que m¬≤/ba√±os sean v√°lidos.",
      toastFirstAnalyze:"Primero analiza.",
      toastPrefsChanged:"Preferencias cambiadas: vuelve a Analizar.",
      toastNoLink:"No se pudo generar el link",
      toastCopied:"Copiado",
      toastZoneCleared:"Zona limpiada",
      toastNoZone:"No hay municipios seleccionados",
      toastZoneApplied:"Zona aplicada a Ejemplos reales",
      stateReady:"‚úÖ Disponible",
      stateNeedAnalyze:"‚õî Requiere Analizar / re-Analizar",
      xInfo:"Municipio (Preferencias): {muni} ¬∑ Estado: {state}.",
      sumTitle:"Resumen claro ¬∑ {rec}",
      chipMort:"Esfuerzo hipoteca: {pct}",
      chipRent:"Esfuerzo alquiler: {pct}",
      chipCash:"Entrada+gastos: {eur}",
      chipRate:"Tipo: {rate}",
      miniPrice:"Precio estimado",
      miniPay:"Cuota hipoteca",
      miniRent:"Alquiler estimado",
      reportHello:"Hola {name},",
      reportPrice:"Precio estimado: {eur}.",
      reportHome:"Vivienda: {muni} ¬∑ {m2} m¬≤ ¬∑ {bed} hab ¬∑ {bath} ba√±os ¬∑ {type}.",
      reportDown:"Entrada: {dp}% ‚Üí {down} ‚Ç¨ ¬∑ Gastos: {cl} ‚Ç¨. (Incluye ITP aprox.)",
      reportFin:"A financiar: {cap} ‚Ç¨ ¬∑ Plazo: {yrs} a√±os ¬∑ Tipo: {rate}.",
      reportPay:"Cuota hipoteca: {pay} ‚Ç¨ ¬∑ Alquiler: {rent} ‚Ç¨.",
      reportRec:"Recomendaci√≥n: {rec}",
      any:"Cualquiera",
      btnCopy2:"Copiar",
      savingsOk:"‚úÖ Ahorros suficientes para la entrada + costes.",
      yearsToSave:"Con {msv}/mes, alcanzar√°s el objetivo en ~{yrs} a√±os ({mos} meses).",
      itpNote:"En Catalunya, la compraventa suele implicar ~10% ITP + notar√≠a/registro (aprox.). Aqu√≠ se mete como ‚Äúcostes‚Äù para no venderte humo.",
      avgZone:"Media de {n} municipios",
      stepPersonal:"Personal",stepEco:"Econom√≠a",stepPref:"Preferencias",stepRes:"Resultado",
      cmpCheaper:"m√°s barato",cmpExpensive:"m√°s caro",cmpSame:"igual",
      cmpExplTitle:"Interpretaci√≥n humana",
      cmpExpl1:"No es ‚Äúmejor provincia‚Äù, es ‚Äúencaje con tu presupuesto y movilidad‚Äù.",
      cmpExpl2:"Mismo tama√±o + extras: si aqu√≠ es m√°s barato, quiz√° ganas margen; si es m√°s caro, necesitas m√°s cash o aceptar recortes.",
      cmpExpl3:"El alquiler comparado sirve para entender alternativa: pagar m√°s por alquilar puede ser normal si compras es inviable.",
      validateIncome:"Introduce ingresos v√°lidos",
      validateSavings:"Introduce tus ahorros",
      validateM2:"M√≠nimo 50 m¬≤",
      missingDataCmp:"Completa provincia, m¬≤ y ba√±os (m√≠nimo 1)."
    },
    CA:{ /* (mantengo tu CA/EN igual que tu base, recortado aqu√≠ por tama√±o) */ },
    EN:{ /* (mantengo tu CA/EN igual que tu base, recortado aqu√≠ por tama√±o) */ }
  };

  // If you want full CA/EN i18n: copia/pega tus bloques originales aqu√≠ sin cambiar nada.
  // Para no romper tu app: si falta CA/EN, cae a ES.
  if(!I18N.CA) I18N.CA={};
  if(!I18N.EN) I18N.EN={};

  let LANG=localStorage.getItem(LANG_KEY)||"ES";
  const t=(k)=> (I18N[LANG] && I18N[LANG][k]) || (I18N.ES[k]||k);
  const tpl=(s,vars)=>String(s||"").replace(/\{(\w+)\}/g,(_,k)=> (vars && vars[k]!=null)?vars[k]:"");

  const fmtMoney=(n)=>{
    if(!isFinite(n)) return "‚Äì";
    return (LANG==="EN"?fmtEN(n):fmtES(n))+" ‚Ç¨";
  };
  const fmtPct=(n)=> (LANG==="EN"?pctEN(n):pctES(n));
  const toast=(m)=>{let e=Q("#ts");e.textContent=m;e.classList.add("s");setTimeout(()=>e.classList.remove("s"),1900)};

  const applyStaticI18n=()=>{
    QA("[data-i]").forEach(el=>{
      const k=el.getAttribute("data-i");
      const v=t(k);
      if(v!=null) el.textContent=v;
    });
  };

  const setLang=(l)=>{
    LANG=l;
    localStorage.setItem(LANG_KEY,l);
    document.documentElement.lang = (l==="CA"?"ca":l==="ES"?"es":"en");
    Q("#L_CA").classList.toggle("a",l==="CA");
    Q("#L_ES").classList.toggle("a",l==="ES");
    Q("#L_EN").classList.toggle("a",l==="EN");
    applyStaticI18n();
    renderZoneUI();
    renderResult();
    refreshExamplesUI();
    updateSteps(document.querySelector("[data-p][style*='block']")?.getAttribute("data-p")||"p");
    liveValidate();
    renderAIChips();
  };

  const STORE_FIELDS_NUM=["ag","inc","sav","yrs","msv","m2","bed","bat","cm2","cbd","cba"];
  const STORE_FIELDS_SEL=["ar","ty","hor","fst","cm","cty"];
  const STORE_FIELDS_CHK=["et","ep","el","ek","es","ej","ea","ct","cp0","cl0","ck0","cs0","cj0","ca0"];

  const loadForm=()=>{
    let s=localStorage.getItem(STORE_KEY); if(!s) return;
    try{
      let d=JSON.parse(s)||{};
      STORE_FIELDS_NUM.forEach(id=>{ if(d[id]!=null && Q("#"+id)) Q("#"+id).value=d[id]; });
      STORE_FIELDS_SEL.forEach(id=>{ if(d[id]!=null && Q("#"+id)) Q("#"+id).value=d[id]; });
      STORE_FIELDS_CHK.forEach(id=>{ if(Q("#"+id) && d[id]!=null) Q("#"+id).checked=!!d[id]; });
      if(d.nm!=null && Q("#nm")) Q("#nm").value=d.nm;
    }catch(e){}
  };

  const saveForm=()=>{
    let d={};
    STORE_FIELDS_NUM.forEach(id=>{ if(Q("#"+id)) d[id]=Q("#"+id).value; });
    STORE_FIELDS_SEL.forEach(id=>{ if(Q("#"+id)) d[id]=Q("#"+id).value; });
    STORE_FIELDS_CHK.forEach(id=>{ if(Q("#"+id)) d[id]=Q("#"+id).checked?1:0; });
    if(Q("#nm")) d.nm=Q("#nm").value;
    localStorage.setItem(STORE_KEY,JSON.stringify(d));
  };

  const updateSteps=(p)=>{
    const stepMap={p:1,e:2,f:3,r:4,m:4,x:4,ai:4};
    const cur=stepMap[p]||1;
    [1,2,3,4].forEach(i=>{
      const s=Q("#stp"+i); if(!s) return;
      s.classList.remove("active","done");
      if(i<cur) s.classList.add("done");
      else if(i===cur) s.classList.add("active");
    });
    const lbls=[t("stepPersonal"),t("stepEco"),t("stepPref"),t("stepRes")];
    lbls.forEach((l,i)=>{const el=Q("#slbl"+(i+1));if(el)el.textContent=l;});
  };

  const show=p=>{
    QA("[data-p]").forEach(x=>x.style.display=x.getAttribute("data-p")==p?"block":"none");
    ["p","e","f","r","m","x","ai"].forEach(k=>Q("#t_"+k).classList.toggle("a",p===k));
    updateSteps(p);
    if(p==="m") setTimeout(()=>upMap(),100);
    if(p==="x") refreshExamplesUI();
    if(p==="ai") { renderAIChips(); setTimeout(()=>Q("#aiQ")?.focus(),50); }
    window.scrollTo({top:0,behavior:"smooth"});
  };

  // Finance math
  const mort=(c,r,y)=>{let m=r/12,n=y*12;return r===0?c/n:c*(m*Math.pow(1+m,n))/(Math.pow(1+m,n)-1)};

  // Region coefficients
  const COEF={"Cunit":{c:1.157,r:.975},"El Vendrell":{c:.912,r:.842},"Calafell":{c:.856,r:.983},"Santa Oliva":{c:.783,r:.825},"Bellvei":{c:.783,r:.925},"L'Arbo√ß":{c:.735,r:.883},"Banyeres del Pened√®s":{c:.614,r:.783},"Albinyana":{c:.766,r:.825},"Bonastre":{c:.497,r:.683},"Maslloren√ß":{c:.549,r:.75},"La Bisbal del Pened√®s":{c:.623,r:.808},"Lloren√ß del Pened√®s":{c:.856,r:.65},"Sant Jaume dels Domenys":{c:.614,r:.65},"El Montmell":{c:.529,r:.675}};
  const BASE={m2:2000,rent:10,close:.11,rate:.0299};
  const M={"Barcelona":{v:2986,l:21.9},"Girona":{v:2608,l:14.99},"Lleida":{v:1486,l:9.5},"Tarragona":{v:2100,l:13.5}};

  const extraImpactBuy=(base,e)=>{
    let x=0;
    if(e.t) x+=base*.05;
    if(e.p) x+=base*.08;
    if(e.l) x+=base*.04;
    if(e.k) x+=base*.03;
    if(e.s) x+=base*.02;
    if(e.j) x+=base*.05;
    if(e.a) x+=base*.015;
    return x;
  };
  const extraImpactRent=(base,e)=>{
    let x=0;
    if(e.t) x+=base*.15;
    if(e.p) x+=base*.30;
    if(e.l) x+=base*.08;
    if(e.k) x+=base*.07;
    if(e.s) x+=base*.05;
    if(e.j) x+=base*.18;
    if(e.a) x+=base*.06;
    return x;
  };

  const buy=(a,m2,b,ba,e)=>{
    let base=m2*BASE.m2*(COEF[a]?.c||1),adj=b*5e3+ba*3e3;
    return Math.round(base+adj+extraImpactBuy(base,e));
  };
  const rent=(a,m2,b,ba,e)=>{
    let base=m2*BASE.rent*(COEF[a]?.r||1),adj=b*50+ba*30;
    return Math.round(base+adj+extraImpactRent(base,e));
  };
  const buyM=(m,m2,b,ba,e)=>{
    let p=M[m]; if(!p) return NaN;
    let base=m2*p.v,adj=b*5e3+ba*3e3;
    return Math.round(base+adj+extraImpactBuy(base,e));
  };
  const rentM=(m,m2,b,ba,e)=>{
    let p=M[m]; if(!p) return NaN;
    let base=m2*p.l,adj=b*50+ba*30;
    return Math.round(base+adj+extraImpactRent(base,e));
  };

  // State
  let last=null,lastReq=null,lastReqSig="";

  const reqFromUI=()=>( {
    muni:Q("#ar").value,type:Q("#ty").value,m2:+Q("#m2").value||null,
    bed:(Q("#bed").value===""?null:+Q("#bed").value),
    bath:+Q("#bat").value||null,
    ex:{
      t:Q("#et").checked?1:0,p:Q("#ep").checked?1:0,l:Q("#el").checked?1:0,k:Q("#ek").checked?1:0,
      s:Q("#es").checked?1:0,j:Q("#ej").checked?1:0,a:Q("#ea").checked?1:0
    }
  });
  const sigOfReq=r=>[r.muni,r.type,r.m2,r.bed,r.bath,r.ex.t,r.ex.p,r.ex.l,r.ex.k,r.ex.s,r.ex.j,r.ex.a].join("|");
  const prefsChangedSinceAnalyze=()=>{ if(!lastReq) return true; return sigOfReq(reqFromUI())!==lastReqSig; };
  const setTabsEnabled=()=>{
    const needA=!lastReq;
    ["#t_r","#t_m","#t_x","#t_ai"].forEach(id=>Q(id).classList.toggle("dis",needA));
  };

  const typeLabel=(type)=> type==="flat"?t("optFlat"):t("optHouse");
  const muniLabel=(muni)=>{
    if(muni==="*") return t("any");
    if(muni==="__multi__") return [...zoneSel].join(", ");
    return muni;
  };

  // charts helpers
  const dpr=()=>window.devicePixelRatio||1;
  const setupCanvas=(cv)=>{
    const r=dpr();
    const rect=cv.getBoundingClientRect();
    cv.width=Math.max(320,Math.round(rect.width*r));
    cv.height=Math.max(220,Math.round(rect.height*r));
    const ctx=cv.getContext("2d");
    ctx.setTransform(r,0,0,r,0,0);
    return ctx;
  };
  const clear=(ctx,w,h)=>{
    ctx.clearRect(0,0,w,h);
    ctx.globalAlpha=1;
    ctx.lineWidth=1;
    ctx.strokeStyle="rgba(148,163,184,.12)";
    for(let i=0;i<6;i++){
      const y=14+i*(h-28)/5;
      ctx.beginPath();ctx.moveTo(12,y);ctx.lineTo(w-12,y);ctx.stroke();
    }
  };
  const drawText=(ctx,txt,x,y,sz,clr,align)=>{
    ctx.fillStyle=clr||"#cbd5e1";
    ctx.font=`${sz||12}px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif`;
    ctx.textAlign=align||"left";
    ctx.fillText(txt,x,y);
  };

  const drawEffortChart=()=>{
    if(!last) return;
    const cv=Q("#effChart"); if(!cv) return;
    const ctx=setupCanvas(cv);
    const w=cv.clientWidth,h=cv.clientHeight;
    clear(ctx,w,h);

    const safe=last.inc*0.35;
    const buyV=last.pay;
    const rentV=last.pr;
    const maxV=Math.max(safe,buyV,rentV)*1.15||1;

    const padL=12,padR=12,padT=18,padB=26;
    const plotW=w-padL-padR,plotH=h-padT-padB;

    const ySafe=padT+plotH*(1-(safe/maxV));
    ctx.strokeStyle="rgba(56,189,248,.90)";
    ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(padL,ySafe);ctx.lineTo(w-padR,ySafe);ctx.stroke();
    drawText(ctx, (LANG==="EN"?"Safe capacity ":"Capacidad segura ") + fmtMoney(safe), padL+6, ySafe-6, 12, "#7dd3fc","left");

    const barW=Math.min(120,plotW/4);
    const bx1=padL+plotW*0.35-barW/2;
    const bx2=padL+plotW*0.65-barW/2;

    const bar=(x,val,label,fill,txtClr)=>{
      const bh=plotH*(val/maxV);
      const y=padT+plotH-bh;
      ctx.fillStyle=fill;
      ctx.globalAlpha=0.95;
      ctx.fillRect(x,y,barW,bh);
      ctx.globalAlpha=1;
      ctx.strokeStyle="rgba(255,255,255,.14)";
      ctx.strokeRect(x,y,barW,bh);
      drawText(ctx,label,x+barW/2,padT+plotH+18,12,"#cbd5e1","center");
      drawText(ctx,fmtMoney(val),x+barW/2,y-6,12,txtClr||"#e5e7eb","center");
    };

    bar(bx1,buyV, LANG==="EN"?"BUY":"COMPRA","rgba(34,197,94,.60)","#86efac");
    bar(bx2,rentV, LANG==="EN"?"RENT":"ALQUILER","rgba(245,158,11,.58)","#fde68a");
    drawText(ctx, LANG==="EN"?"Monthly effort":"Esfuerzo mensual", padL, 14, 12, "rgba(148,163,184,.95)","left");
  };

  const drawSensitivityChart=()=>{
    if(!last) return;
    const cv=Q("#sensChart"); if(!cv) return;
    const ctx=setupCanvas(cv);
    const w=cv.clientWidth,h=cv.clientHeight;
    clear(ctx,w,h);

    const padL=12,padR=12,padT=18,padB=26;
    const plotW=w-padL-padR,plotH=h-padT-padB;

    const pts=[];
    for(let i=0;i<=4;i++){
      const r=last.rate + i*0.005;
      const p=mort(last.cap,r,last.yrs);
      pts.push({r,p});
    }
    const maxP=Math.max(...pts.map(x=>x.p))*1.10||1;
    const minP=Math.min(...pts.map(x=>x.p))*0.90||0;

    drawText(ctx, LANG==="EN"?"Rate increase (+0.5% steps)":"Subida de tipo (+0,5% pasos)", padL, h-8, 11, "rgba(148,163,184,.95)","left");
    drawText(ctx, LANG==="EN"?"Payment (‚Ç¨)":"Cuota (‚Ç¨)", w-padR, 14, 11, "rgba(148,163,184,.95)","right");

    ctx.strokeStyle="rgba(56,189,248,.92)";
    ctx.lineWidth=2;
    ctx.beginPath();
    pts.forEach((pt,i)=>{
      const x=padL + (plotW*(i/(pts.length-1)));
      const y=padT + plotH*(1-((pt.p-minP)/(maxP-minP||1)));
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    pts.forEach((pt,i)=>{
      const x=padL + (plotW*(i/(pts.length-1)));
      const y=padT + plotH*(1-((pt.p-minP)/(maxP-minP||1)));
      ctx.fillStyle="rgba(125,211,252,1)";
      ctx.beginPath();ctx.arc(x,y,3.5,0,Math.PI*2);ctx.fill();
      if(i===pts.length-1){
        drawText(ctx, fmtMoney(pt.p), x-4, y-10, 12, "#7dd3fc","right");
      }
    });

    const delta=pts[pts.length-1].p - pts[0].p;
    drawText(ctx, (delta>=0?"+":"")+fmtMoney(delta)+" @ +2%", w-12, h-8, 12, "#fde68a","right");
  };

  const drawCmpChart=(your,prov)=>{
    const cv=Q("#cmpChart"); if(!cv) return;
    const ctx=setupCanvas(cv);
    const w=cv.clientWidth,h=cv.clientHeight;
    clear(ctx,w,h);

    const padL=12,padR=12,padT=18,padB=26;
    const plotW=w-padL-padR,plotH=h-padT-padB;
    const maxV=Math.max(your,prov)*1.15||1;

    const barW=Math.min(160,plotW/3);
    const bx1=padL+plotW*0.33-barW/2;
    const bx2=padL+plotW*0.67-barW/2;

    const bar=(x,val,label,fill,txtClr)=>{
      const bh=plotH*(val/maxV);
      const y=padT+plotH-bh;
      ctx.fillStyle=fill;
      ctx.globalAlpha=0.95;
      ctx.fillRect(x,y,barW,bh);
      ctx.globalAlpha=1;
      ctx.strokeStyle="rgba(255,255,255,.14)";
      ctx.strokeRect(x,y,barW,bh);
      drawText(ctx,label,x+barW/2,padT+plotH+18,12,"#cbd5e1","center");
      drawText(ctx,fmtMoney(val),x+barW/2,y-6,12,txtClr||"#e5e7eb","center");
    };
    bar(bx1,your, LANG==="EN"?"Your area":"Tu zona", "rgba(56,189,248,.45)","#7dd3fc");
    bar(bx2,prov, LANG==="EN"?"Province":"Provincia", "rgba(168,85,247,.40)","#e9d5ff");
  };

  const analyze=()=>{
    let nm=(Q("#nm").value||"").trim(),ag=+Q("#ag").value||0,inc=+Q("#inc").value||0,sav=+Q("#sav").value||0,yrs=+Q("#yrs").value||25,hor=Q("#hor").value==="y",fst=Q("#fst").value==="y";
    let ar=Q("#ar").value,m2=+Q("#m2").value||0,bd=(Q("#bed").value===""?0:+Q("#bed").value||0),ba=+Q("#bat").value||0,type=Q("#ty").value;
    if(!nm||ag<18||ag>100||m2<50||ba<1){toast(t("toastCheckNameAge"));return;}

    let e={t:Q("#et").checked,p:Q("#ep").checked,l:Q("#el").checked,k:Q("#ek").checked,s:Q("#es").checked,j:Q("#ej").checked,a:Q("#ea").checked};

    let pb,pr,pbRange=null,prRange=null,muniList=[];
    if((ar==="*"||ar==="__multi__")&&zoneSel.size>1){
      muniList=[...zoneSel];
      const buys=muniList.map(m=>buy(m,m2,Math.max(0,bd),ba,e));
      const rents=muniList.map(m=>rent(m,m2,Math.max(0,bd),ba,e));
      pb=Math.round(buys.reduce((a,b)=>a+b,0)/buys.length);
      pr=Math.round(rents.reduce((a,b)=>a+b,0)/rents.length);
      pbRange={lo:Math.min(...buys),hi:Math.max(...buys)};
      prRange={lo:Math.min(...rents),hi:Math.max(...rents)};
    } else {
      const baseM=(ar==="__multi__"&&zoneSel.size===1)?[...zoneSel][0]:(ar==="*"?"Cunit":ar);
      muniList=[baseM];
      pb=buy(baseM,m2,Math.max(0,bd),ba,e);
      pr=rent(baseM,m2,Math.max(0,bd),ba,e);
    }

    let dp=fst?.1:.2,down=pb*dp,cl=pb*BASE.close,cap=Math.max(0,pb-down);

    let rate=BASE.rate;
    const needCash=Math.round(down+cl);
    if(sav<needCash) rate+=.006;

    let pay=mort(cap,rate,yrs);
    let ratio=inc>0?(pay/inc)*100:1e9;
    let rri=inc>0?(pr/inc)*100:1e9;

    let need=sav<needCash;
    let ratioOK=isFinite(ratio)&&ratio<=35;
    let rentOK=isFinite(rri)&&rri<=40;

    let recCode=(!need && ratioOK && hor) ? "BUY" : (rentOK ? "RENT" : "NOT_FEASIBLE");
    let rec = recCode==="BUY" ? t("recBuy") : recCode==="RENT" ? t("recRent") : t("recNotFeasible");

    last={
      nm,muni:ar,m2,bd:Math.max(0,bd),ba,type,
      pb,pr,pbRange,prRange,muniList,
      cap,rate,yrs,dp,sav,down,cl,pay,ratio,rri,
      rec,recCode,e,need,hor,inc,msv:+Q("#msv").value||0,
      needCash
    };
    lastReq=reqFromUI(); lastReqSig=sigOfReq(lastReq);

    Q("#k1").textContent=fmtMoney(pb);
    Q("#k2").textContent=fmtMoney(pr);
    Q("#k3").textContent=fmtMoney(pay);
    Q("#k4").textContent=rec;

    const pm2=last.m2>0?Math.round(last.pb/last.m2):0;
    Q("#k1sub").textContent = pm2? (pm2.toLocaleString(LANG==="EN"?"en-US":"es-ES")+" ‚Ç¨/m¬≤") : "";
    Q("#k2sub").textContent = (LANG==="EN"?"Monthly estimate":"Estimaci√≥n mensual");
    Q("#k3sub").textContent = `${last.yrs} ${LANG==="EN"?"years":"a√±os"} ¬∑ ${(last.rate*100).toFixed(2)}%`;
    Q("#k4sub").textContent = last.recCode==="BUY"
      ? (LANG==="EN"?"You fit cash + effort thresholds.":"Encajas cash + esfuerzo.")
      : last.recCode==="RENT"
        ? (LANG==="EN"?"Buying is tight; rent is safer.":"Comprar aprieta; alquilar es m√°s seguro.")
        : (LANG==="EN"?"Neither option fits safely yet.":"Ahora mismo no encaja con seguridad.");

    renderResult();
    setTabsEnabled();
    saveForm();
    show("r");
    setTimeout(()=>{ drawEffortChart(); drawSensitivityChart(); },120);

    // Suggest AI hint after analysis
    pushAIMessage("ai",
      "He cargado tu an√°lisis como contexto. Si quieres, preg√∫ntame: ‚Äú¬øQu√© deber√≠a cambiar para que la recomendaci√≥n pase a COMPRAR?‚Äù o ‚Äú¬øCu√°l es mi margen seguro mensual?‚Äù"
    );
    renderAIChips();
  };

  const renderResult=()=>{
    if(!last) return;

    const dti=isFinite(last.ratio)?last.ratio:999;
    const rti=isFinite(last.rri)?last.rri:999;

    const needCash=last.needCash;
    let clsDTI=dti<=30?"good":dti<=35?"warn":"bad";
    let clsRTI=rti<=35?"good":rti<=40?"warn":"bad";
    let clsCash=last.need?"bad":"good";
    let clsRate=(last.rate>BASE.rate)?"warn":"neu";

    Q("#rCard").style.display="block";
    Q("#rTitle").textContent=tpl(t("sumTitle"),{rec:last.rec});
    Q("#rChips").innerHTML=
      `<span class="chip ${clsDTI}">${tpl(t("chipMort"),{pct:fmtPct(dti)})}</span>`+
      `<span class="chip ${clsRTI}">${tpl(t("chipRent"),{pct:fmtPct(rti)})}</span>`+
      `<span class="chip ${clsCash}">${tpl(t("chipCash"),{eur:fmtMoney(needCash)})}</span>`+
      `<span class="chip ${clsRate}">${tpl(t("chipRate"),{rate:(last.rate*100).toFixed(2)+"%"})}</span>`;

    const isMulti=last.muniList&&last.muniList.length>1;
    const multiLbl=isMulti?`<div style='font-size:.72rem;color:#7dd3fc;margin-top:3px'>${tpl(t("avgZone"),{n:last.muniList.length})}</div>`:"";
    const pbRngHtml=(isMulti&&last.pbRange)?`<div class='range-bar'><span class='range-tag lo'>‚Üì ${fmtMoney(last.pbRange.lo)}</span><span class='range-tag hi'>‚Üë ${fmtMoney(last.pbRange.hi)}</span></div>`:"";
    const prRngHtml=(isMulti&&last.prRange)?`<div class='range-bar'><span class='range-tag lo'>‚Üì ${fmtMoney(last.prRange.lo)}</span><span class='range-tag hi'>‚Üë ${fmtMoney(last.prRange.hi)}</span></div>`:"";
    const pricePerM2=last.m2>0?Math.round(last.pb/last.m2):0;

    Q("#rMini").innerHTML=
      `<div class="mini"><div class="h">${t("miniPrice")}</div><div class="v">${fmtMoney(last.pb)}</div>${multiLbl}${pbRngHtml}<div style='font-size:.75rem;color:#64748b;margin-top:4px'>${pricePerM2.toLocaleString(LANG==="EN"?"en-US":"es-ES")} ‚Ç¨/m¬≤</div></div>`+
      `<div class="mini"><div class="h">${t("miniPay")}</div><div class="v">${fmtMoney(last.pay)}</div><div style='font-size:.75rem;color:#64748b;margin-top:4px'>${last.yrs} ${LANG==="EN"?"years":"a√±os"} ¬∑ ${(last.rate*100).toFixed(2)}%</div></div>`+
      `<div class="mini"><div class="h">${t("miniRent")}</div><div class="v">${fmtMoney(last.pr)}</div>${prRngHtml}<div style='font-size:.75rem;color:#64748b;margin-top:4px'>${LANG==="EN"?"Monthly estimate":"Estimaci√≥n mensual"}</div></div>`;

    const safe=last.inc*0.35;
    const cashGap=Math.max(0,last.needCash-last.sav);
    const why=[];
    if(last.recCode==="BUY"){
      why.push(LANG==="EN"?"Your savings cover the down payment + costs.":"Tus ahorros cubren entrada + costes.");
      why.push(LANG==="EN"?"Mortgage effort stays within the recommended band.":"El esfuerzo de hipoteca queda en banda recomendada.");
      if(last.hor) why.push(LANG==="EN"?"Staying >5 years helps amortize purchase costs.":"Quedarte >5 a√±os ayuda a amortizar costes.");
    }else if(last.recCode==="RENT"){
      if(last.need) why.push((LANG==="EN"?"Cash shortfall":"Falta cash")+": "+fmtMoney(cashGap));
      if(dti>35) why.push((LANG==="EN"?"Mortgage effort is high":"El esfuerzo de hipoteca es alto")+": "+fmtPct(dti));
      if(!last.hor) why.push(LANG==="EN"?"Short horizon: buying is usually less efficient.":"Horizonte corto: comprar suele ser menos eficiente.");
      why.push(LANG==="EN"?"Rent stays closer to a safer monthly load.":"El alquiler queda m√°s cerca de una carga mensual segura.");
    }else{
      if(last.need) why.push(LANG==="EN"?"Not enough cash for down payment + costs yet.":"A√∫n no hay cash suficiente para entrada + costes.");
      if(dti>35) why.push((LANG==="EN"?"Mortgage effort exceeds the recommended limit":"El esfuerzo hipoteca supera el l√≠mite recomendado")+": "+fmtPct(dti));
      if(rti>40) why.push((LANG==="EN"?"Rent effort also exceeds the recommended limit":"El esfuerzo alquiler tambi√©n supera el l√≠mite recomendado")+": "+fmtPct(rti));
    }

    Q("#chartTips").textContent =
      (LANG==="EN"?"Safe capacity is ":"Capacidad segura ") + fmtMoney(safe) +
      " ¬∑ " + (LANG==="EN"?"Mortgage ":"Hipoteca ") + fmtMoney(last.pay) +
      " ¬∑ " + (LANG==="EN"?"Rent ":"Alquiler ") + fmtMoney(last.pr);

    Q("#quickExplain").innerHTML =
      `<div style="font-weight:950;color:#e5e7eb;margin-bottom:8px">${last.recCode==="BUY"?"‚úÖ ":""}${last.recCode==="RENT"?"‚ö†Ô∏è ":""}${last.recCode==="NOT_FEASIBLE"?"‚ùå ":""}${t("cmpExplTitle")}</div>`+
      `<div style="display:grid;gap:6px">`+
      why.map(x=>`<div>‚Ä¢ ${x}</div>`).join("")+
      `</div>`;

    const muniTxt=muniLabel(last.muni);
    const typeTxt=typeLabel(last.type);
    const dpPct = Math.round(last.dp*100);

    Q("#rt").textContent=[
      tpl(t("reportHello"),{name:last.nm}),
      tpl(t("reportPrice"),{eur:fmtMoney(last.pb)}),
      tpl(t("reportHome"),{muni:muniTxt,m2:last.m2,bed:(last.bd||0),bath:last.ba,type:typeTxt}),
      tpl(t("reportDown"),{dp:dpPct,down:fmtMoney(last.down),cl:fmtMoney(last.cl)}),
      tpl(t("reportFin"),{cap:fmtMoney(last.cap),yrs:last.yrs,rate:(last.rate*100).toFixed(2)+"%"}),
      tpl(t("reportPay"),{pay:fmtMoney(last.pay),rent:fmtMoney(last.pr)}),
      tpl(t("reportRec"),{rec:last.rec})
    ].join("\n");

    setTimeout(()=>{ drawEffortChart(); drawSensitivityChart(); },70);
  };

  // Comparator map
  let cmap=null;
  const PROV_COORDS={"Barcelona":[41.3874,2.1686],"Girona":[41.9794,2.8214],"Lleida":[41.6176,0.6200],"Tarragona":[41.1189,1.2445]};
  const upMap=()=>{
    const m=Q("#cm").value||"Barcelona";
    const coords=PROV_COORDS[m]||[41.3874,2.1686];
    if(!cmap){
      cmap=L.map("cmap").setView(coords,11);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(cmap);
      L.marker(coords).addTo(cmap).bindPopup(m);
      setTimeout(()=>{if(cmap)cmap.invalidateSize()},200);
    } else {
      cmap.setView(coords,11);
      cmap.eachLayer(layer=>{if(layer instanceof L.Marker)cmap.removeLayer(layer)});
      L.marker(coords).addTo(cmap).bindPopup(m);
      setTimeout(()=>{if(cmap)cmap.invalidateSize()},120);
    }
  };

  const fillComparatorFromLast=()=>{
    if(!last){ toast(t("toastFirstAnalyze")); return; }
    Q("#cm2").value=last.m2||""; Q("#cbd").value=last.bd||""; Q("#cba").value=last.ba||"";
    Q("#cty").value=last.type||"flat";
    Q("#ct").checked=!!last.e?.t; Q("#cp0").checked=!!last.e?.p; Q("#cl0").checked=!!last.e?.l; Q("#ck0").checked=!!last.e?.k;
    Q("#cs0").checked=!!last.e?.s; Q("#cj0").checked=!!last.e?.j; Q("#ca0").checked=!!last.e?.a;
    saveForm();
  };

  const compare=()=>{
    if(!last){ Q("#cmg").textContent=t("toastFirstAnalyze"); return; }
    let m=Q("#cm").value,m2=+Q("#cm2").value||0,bd=+Q("#cbd").value||0,ba=+Q("#cba").value||0;
    let e={t:Q("#ct").checked,p:Q("#cp0").checked,l:Q("#cl0").checked,k:Q("#ck0").checked,s:Q("#cs0").checked,j:Q("#cj0").checked,a:Q("#ca0").checked};
    if(!M[m]||!(m2>0&&ba>0)){Q("#cmg").textContent=t("missingDataCmp"); Q("#cmpChips").innerHTML=""; return;}

    const p2=buyM(m,m2,Math.max(0,bd),ba,e);
    const r2=rentM(m,m2,Math.max(0,bd),ba,e);

    const d=p2-last.pb;
    const pct=(last.pb>0)?(d/last.pb)*100:0;

    const cls=d>0?"bad":d<0?"good":"neu";
    const arrow=d>0?"‚Üë":d<0?"‚Üì":"‚Üí";
    const sign=d>0?"+":"";
    const pctTxt=(d===0)?"0%":(sign+pct.toFixed(1)+"%");

    Q("#cmpChips").innerHTML=
      `<span class="chip ${cls}">${arrow} ${sign}${fmtMoney(d)}</span>`+
      `<span class="chip ${cls}">${pctTxt}</span>`+
      `<span class="chip neu">${fmtMoney(p2)}</span>`+
      `<span class="chip neu">${fmtMoney(r2)} ${LANG==="EN"?"/mo":"/mes"}</span>`;

    Q("#cmg").innerHTML=
      `<div style="display:grid;gap:10px">
        <div><b>${m}</b> ¬∑ ${typeLabel(Q("#cty").value)} ¬∑ ${m2} m¬≤ ¬∑ ${bd} ¬∑ ${ba}</div>
        <div style="padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.18);background:rgba(2,6,23,.35)">
          <div style="font-weight:950;color:#e5e7eb;margin-bottom:6px">${t("cmpExplTitle")}</div>
          <div style="color:#cbd5e1;line-height:1.7">
            <div>‚Ä¢ ${t("cmpExpl1")}</div>
            <div>‚Ä¢ ${t("cmpExpl2")}</div>
            <div>‚Ä¢ ${t("cmpExpl3")}</div>
          </div>
        </div>
        <div style="color:#cbd5e1;line-height:1.7">
          <div>‚Ä¢ Precio en provincia: <b>${fmtMoney(p2)}</b></div>
          <div>‚Ä¢ Precio en tu zona: <b>${fmtMoney(last.pb)}</b></div>
          <div>‚Ä¢ Diferencia: <b>${sign}${fmtMoney(d)}</b> (${pctTxt})</div>
          <div>‚Ä¢ Alquiler estimado en provincia: <b>${fmtMoney(r2)}</b></div>
          <div>‚Ä¢ Alquiler estimado en tu zona: <b>${fmtMoney(last.pr)}</b></div>
        </div>
      </div>`;
    drawCmpChart(last.pb,p2);
    upMap();
    saveForm();
  };

  // --------- MAP ZONE: REAL POLYGONS (GeoJSON) ---------
  // Expected GeoJSON: FeatureCollection with features having properties.name = municipality name
  // Example: { "type":"Feature", "properties": { "name":"Cunit" }, "geometry":{...} }
  const GEOJSON_URL="baix-penedes-munis.geojson"; // <- Put this file next to HTML, or change URL.
  let zmap=null, zReady=false, zoneSel=new Set();
  let geoLayer=null;
  let geoByName=new Map(); // name -> layer

  const loadZoneSel=()=>{
    try{
      const s=localStorage.getItem(ZONE_KEY);
      if(!s) return;
      const arr=JSON.parse(s)||[];
      zoneSel=new Set(arr.filter(Boolean));
    }catch(e){}
  };
  const saveZoneSel=()=>localStorage.setItem(ZONE_KEY, JSON.stringify([...zoneSel]));

  const renderZoneUI=()=>{
    const selTxt = zoneSel.size ? [...zoneSel].join(", ") : (LANG==="EN"?"none":(LANG==="CA"?"cap":"ninguno"));
    Q("#zoneNote").textContent = (LANG==="EN"?"Selected: ":(LANG==="CA"?"Seleccionats: ":"Seleccionados: ")) + selTxt;

    Q("#zoneApplied").textContent = zoneSel.size
      ? ((LANG==="EN"?"Active towns: ":(LANG==="CA"?"Municipis actius: ":"Municipios activos: ")) + [...zoneSel].join(", "))
      : (LANG==="EN"?"No area applied":(LANG==="CA"?"Cap zona aplicada":"Ninguna zona aplicada"));

    const zc=Q("#zoneChips");
    zc.innerHTML = zoneSel.size
      ? [...zoneSel].map(z=>`<span class="pchip on" data-z="${z}">${z}</span>`).join("")
      : `<span class="pchip off">${LANG==="EN"?"No selection":(LANG==="CA"?"Sense selecci√≥":"Sin selecci√≥n")}</span>`;

    zc.querySelectorAll("[data-z]").forEach(ch=>{
      ch.addEventListener("click",()=>{
        const n=ch.getAttribute("data-z");
        toggleZone(n,true);
      });
    });

    // refresh polygon styles
    geoByName.forEach((layer,name)=>applyPolyStyle(name));
  };

  const applyPolyStyle=(name)=>{
    const layer=geoByName.get(name);
    if(!layer) return;
    const on=zoneSel.has(name);

    // You can tune these to your ‚Äúleg2/leg3‚Äù logic; here is simple selected/unselected
    const style = on
      ? { color:"#38bdf8", weight:2, opacity:0.9, fillColor:"#38bdf8", fillOpacity:0.18 }
      : { color:"rgba(148,163,184,.35)", weight:1, opacity:0.5, fillColor:"rgba(148,163,184,.20)", fillOpacity:0.06 };

    layer.setStyle(style);
    try{ layer.bringToFront(); }catch(e){}
  };

  const toggleZone=(name,fromChip)=>{
    if(zoneSel.has(name)) zoneSel.delete(name); else zoneSel.add(name);
    applyPolyStyle(name);
    renderZoneUI();
    if(!fromChip) saveZoneSel();
  };

  const initMap=async ()=>{
    if(zReady) return;
    zReady=true;

    zmap=L.map("zmap",{scrollWheelZoom:false,tap:true}).setView([41.235,1.595],11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'Leaflet | ¬© OpenStreetMap'}).addTo(zmap);

    // Try load real polygons
    try{
      const res=await fetch(GEOJSON_URL,{cache:"no-store"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const gj=await res.json();

      geoLayer = L.geoJSON(gj,{
        style: (feat)=>{
          const name=(feat?.properties?.name || feat?.properties?.NOM || feat?.properties?.nom || "").trim();
          const on=zoneSel.has(name);
          return on
            ? { color:"#38bdf8", weight:2, opacity:0.9, fillColor:"#38bdf8", fillOpacity:0.18 }
            : { color:"rgba(148,163,184,.35)", weight:1, opacity:0.5, fillColor:"rgba(148,163,184,.20)", fillOpacity:0.06 };
        },
        onEachFeature:(feat,layer)=>{
          const raw=(feat?.properties?.name || feat?.properties?.NOM || feat?.properties?.nom || "").trim();
          const name=raw;
          if(!name) return;

          geoByName.set(name,layer);
          layer.bindTooltip(name,{direction:"top",opacity:0.95,sticky:true});

          layer.on("click",()=>toggleZone(name,false));
        }
      }).addTo(zmap);

      try{ zmap.fitBounds(geoLayer.getBounds(),{padding:[20,20]}); }catch(e){}

      Q("#geojsonWarn").style.display="none";
    }catch(err){
      console.warn("No se pudo cargar GeoJSON:",err);
      Q("#geojsonWarn").style.display="block";
      // fallback: keep map usable but empty (no fake circles)
      zmap.setView([41.235,1.595],11);
    }

    setTimeout(()=>zmap.invalidateSize(),160);
    renderZoneUI();
  };

  // Idealista links
  const IDEALISTA_BASE="https://www.idealista.com";
  const MUNI_SLUG={
    "Cunit":"cunit-tarragona","El Vendrell":"el-vendrell-tarragona","Calafell":"calafell-tarragona","Santa Oliva":"santa-oliva-tarragona",
    "Bellvei":"bellvei-tarragona","L'Arbo√ß":"l-arboc-tarragona","Banyeres del Pened√®s":"banyeres-del-penedes-tarragona","Albinyana":"albinyana-tarragona",
    "Bonastre":"bonastre-tarragona","Maslloren√ß":"masllorenc-tarragona","La Bisbal del Pened√®s":"la-bisbal-del-penedes-tarragona","Lloren√ß del Pened√®s":"llorenc-del-penedes-tarragona",
    "Sant Jaume dels Domenys":"sant-jaume-dels-domenys-tarragona","El Montmell":"el-montmell-tarragona",
  };

  const bedSlug=n=>{
    n=+n||0;
    if(n<=0) return "estudios";
    if(n===1) return "de-un-dormitorio";
    if(n===2) return "de-dos-dormitorios";
    if(n===3) return "de-tres-dormitorios";
    return "de-cuatro-cinco-habitaciones-o-mas";
  };
  const bathSlug=n=>{
    n=+n||0;
    if(n<=1) return "un-bano";
    if(n===2) return "dos-banos";
    return "tres-banos-o-mas";
  };
  const m2RangeSlugs=m2=>{
    m2=+m2||0; if(!(m2>0)) return [];
    let min=Math.max(0, Math.floor((m2-20)/10)*10);
    let max=Math.ceil((m2+20)/10)*10;
    if(max<=min) max=min+10;
    return [`metros-cuadrados-mas-de_${min}`, `metros-cuadrados-menos-de_${max}`];
  };

  const EXTRA_SLUG={ t:"terraza", p:"piscina", l:"ascensor", k:"garaje", s:"trastero", j:"jardin", a:"aire-acondicionado" };

  const buildIdealistaUrl=(mode,strict,muniOverride)=>{
    if(!lastReq) return null;
    const req=lastReq;
    const muni = muniOverride || req.muni;
    const area=(muni==="*"||muni==="__multi__") ? "tarragona/baix-penedes" : (MUNI_SLUG[muni]||null);
    if(!area) return null;

    const op=(mode==="buy")?"venta-viviendas":"alquiler-viviendas";
    const f=[];
    if(req.m2!=null) f.push(...m2RangeSlugs(req.m2));
    f.push(req.type==="flat"?"pisos":"chalets");
    if(req.bed!=null) f.push(bedSlug(req.bed));
    if(req.bath!=null) f.push(bathSlug(req.bath));

    if(strict){
      ["t","p","l","k","s","j","a"].forEach(k=>{
        if(req.ex[k]===1 && EXTRA_SLUG[k]) f.push(EXTRA_SLUG[k]);
      });
    }

    const joined=f.filter(Boolean).join("%2C");
    return `${IDEALISTA_BASE}/${op}/${area}/con-${joined}/`;
  };

  const openIdealista=(mode,strict,muniOverride)=>{
    if(!lastReq){toast(t("toastFirstAnalyze"));return;}
    if(prefsChangedSinceAnalyze()){toast(t("toastPrefsChanged"));return;}
    const url=buildIdealistaUrl(mode,strict,muniOverride);
    if(!url){toast(t("toastNoLink"));return;}
    window.open(url,"_blank","noopener");
  };

  const refreshExamplesUI=()=>{
    const muniTxt=muniLabel(Q("#ar").value);
    const ok=!!lastReq && !prefsChangedSinceAnalyze();
    const state= ok ? t("stateReady") : t("stateNeedAnalyze");
    Q("#xinfo").textContent = tpl(t("xInfo"),{muni:muniTxt,state:state});

    const wrap=Q("#xbtns");
    wrap.innerHTML="";

    const mkBtn=(label,fn)=>{
      const b=document.createElement("button");
      b.type="button";
      b.className="b ok";
      b.textContent=label;
      b.onclick=fn;
      if(!ok) b.classList.add("dis");
      wrap.appendChild(b);
    };

    const z=[...zoneSel].filter(x=>MUNI_SLUG[x]);
    const buyLabel = (LANG==="EN"?"BUY":(LANG==="CA"?"COMPRA":"COMPRA"));
    const rentLabel = (LANG==="EN"?"RENT":(LANG==="CA"?"LLOGUER":"ALQUILER"));
    const strictLabel = (LANG==="EN"?"strict":(LANG==="CA"?"estricte":"estricto"));
    const flexLabel = (LANG==="EN"?"flex":(LANG==="CA"?"flex":"flex"));

    if(z.length){
      z.forEach(m=>{
        mkBtn(`${buyLabel} (${strictLabel}) ¬∑ ${m}`,()=>openIdealista("buy",true,m));
        mkBtn(`${buyLabel} (${flexLabel}) ¬∑ ${m}`,()=>openIdealista("buy",false,m));
        mkBtn(`${rentLabel} (${strictLabel}) ¬∑ ${m}`,()=>openIdealista("rent",true,m));
        mkBtn(`${rentLabel} (${flexLabel}) ¬∑ ${m}`,()=>openIdealista("rent",false,m));
      });
    } else {
      mkBtn(`${buyLabel} (${strictLabel})`,()=>openIdealista("buy",true,null));
      mkBtn(`${buyLabel} (${flexLabel})`,()=>openIdealista("buy",false,null));
      mkBtn(`${rentLabel} (${strictLabel})`,()=>openIdealista("rent",true,null));
      mkBtn(`${rentLabel} (${flexLabel})`,()=>openIdealista("rent",false,null));
    }

    setTabsEnabled();
  };

  const copy=()=>navigator.clipboard.writeText(Q("#rt").textContent||"").then(()=>toast(t("toastCopied")));
  const shareWhatsApp=()=>{
    const txt=Q("#rt").textContent||"";
    if(!txt){toast(t("toastFirstAnalyze"));return;}
    window.open("https://wa.me/?text="+encodeURIComponent(txt),"_blank","noopener");
  };

  const reset=()=>{
    ["nm",...STORE_FIELDS_NUM].forEach(id=>{let e=document.getElementById(id);if(e)e.value=""});
    STORE_FIELDS_CHK.forEach(id=>{let e=document.getElementById(id);if(e)e.checked=false});
    Q("#ar").value="*"; Q("#cm").value="Barcelona"; Q("#hor").value="y"; Q("#fst").value="n";
    const pm2=Q("#ar").querySelector('[value="__multi__"]');if(pm2)pm2.remove();

    Q("#rt").textContent="";
    ["#k1","#k2","#k3"].forEach(k=>Q(k).textContent="0 ‚Ç¨");
    Q("#k4").textContent="‚Äì";
    Q("#k1sub").textContent="";Q("#k2sub").textContent="";Q("#k3sub").textContent="";Q("#k4sub").textContent="";
    Q("#cmg").textContent="";
    Q("#cmpChips").innerHTML="";
    Q("#rCard").style.display="none";

    last=null; lastReq=null; lastReqSig="";
    localStorage.removeItem(STORE_KEY);

    zoneSel.clear(); saveZoneSel();
    geoByName.forEach((_,name)=>applyPolyStyle(name));
    setTabsEnabled(); refreshExamplesUI(); renderZoneUI();
    clearAIChat(true);
    show("p");
  };

  const clamp=(id,min,max,len)=>{
    let el=document.getElementById(id);if(!el)return;
    const san=v=>{v=String(v||"").replace(/[^\d.]/g,"");let p=v.split(".");if(p.length>2)v=p.slice(0,2).join(".");return len?v.slice(0,len):v};
    el.addEventListener("input",()=>{el.value=san(el.value); saveForm();});
    el.addEventListener("blur",()=>{if(el.value==="")return;let n=+el.value;if(!isFinite(n))return;el.value=Math.min(max,Math.max(min,n)); saveForm();});
  };
  [["ag",18,100,3],["m2",50,999,3],["bed",0,10,2],["bat",1,10,2],["inc",0,1000000,7],["sav",0,10000000,8],["msv",0,1000000,7],["yrs",5,40,2],["cm2",50,999,3],["cbd",0,10,2],["cba",1,10,2]].forEach(x=>clamp(...x));

  const liveValidate=()=>{
    const vi=+Q("#inc").value||0, vs=+Q("#sav").value||0, vm=+Q("#m2").value||0;
    const fi=Q("#inc"),fs=Q("#sav"),fm=Q("#m2");
    const hi=Q("#hint-inc"),hs=Q("#hint-sav"),hm=Q("#hint-m2");
    const set=(inp,hint,ok,msg)=>{
      inp.classList.toggle("field-ok",ok&&inp.value!=="");
      inp.classList.toggle("field-err",!ok&&inp.value!=="");
      if(hint){
        hint.textContent=(!ok&&inp.value!=="")?"‚ö† "+msg:"";
        hint.className="field-hint"+(ok&&inp.value!=""?" ok":!ok&&inp.value!=""?" err":"");
      }
    };
    set(fi,hi,vi>0,t("validateIncome"));
    set(fs,hs,vs>=0 && fs.value!==""?true:vs>0,t("validateSavings"));
    set(fm,hm,vm>=50,t("validateM2"));
  };
  ["inc","sav","m2"].forEach(id=>{
    const el=Q("#"+id);
    if(el){el.addEventListener("input",liveValidate);el.addEventListener("change",liveValidate);}
  });

  // ---------------- AI CHAT (NEW) ----------------
  const aiChatEl=()=>Q("#aiChat");

  const loadAIChat=()=>{
    try{
      const s=localStorage.getItem(AI_CHAT_KEY);
      if(!s) return [];
      const arr=JSON.parse(s);
      return Array.isArray(arr)?arr:[];
    }catch(e){ return []; }
  };
  const saveAIChat=(arr)=>{
    try{ localStorage.setItem(AI_CHAT_KEY, JSON.stringify(arr.slice(-50))); }catch(e){}
  };

  let aiHistory=loadAIChat();

  const renderAIChat=()=>{
    const box=aiChatEl();
    if(!box) return;
    box.innerHTML="";
    const frag=document.createDocumentFragment();
    aiHistory.forEach(m=>{
      const row=document.createElement("div");
      row.className="msg "+(m.role==="user"?"user":"ai");
      const pill=document.createElement("div");
      pill.className="rolePill";
      pill.textContent=(m.role==="user"?"T√∫":"IA");
      const bub=document.createElement("div");
      bub.className="bubble";
      bub.textContent=m.content||"";
      row.appendChild(pill);
      row.appendChild(bub);
      frag.appendChild(row);
    });
    box.appendChild(frag);
    box.scrollTop=box.scrollHeight;
  };

  const pushAIMessage=(role,content)=>{
    aiHistory.push({role,content,ts:Date.now()});
    aiHistory=aiHistory.slice(-50);
    saveAIChat(aiHistory);
    renderAIChat();
  };

  const clearAIChat=(silent)=>{
    aiHistory=[];
    saveAIChat(aiHistory);
    renderAIChat();
    if(!silent) toast("Chat limpiado");
  };

  const contextSnapshot=()=>{
    // Pull safe context from current UI & analysis
    const nm=(Q("#nm").value||"").trim();
    const ag=+Q("#ag").value||0;
    const inc=+Q("#inc").value||0;
    const sav=+Q("#sav").value||0;
    const yrs=+Q("#yrs").value||0;
    const msv=+Q("#msv").value||0;

    const prefs=reqFromUI();
    const selected=[...zoneSel];

    // Use last analysis if available
    const analysis=last?{
      rec:last.rec,
      recCode:last.recCode,
      price:last.pb,
      rent:last.pr,
      pay:last.pay,
      rate:last.rate,
      years:last.yrs,
      cashNeeded:last.needCash,
      cashHave:last.sav,
      dti:last.ratio,
      rti:last.rri,
      horizon:last.hor
    }:null;

    return {
      lang:LANG,
      person:{name:nm||null,age:ag||null},
      finance:{income:inc||null,savings:sav||null,mortgageYears:yrs||null,monthlySavings:msv||null},
      preferences:prefs,
      zone:{selectedMunicipalities:selected},
      analysis
    };
  };

  const renderAIChips=()=>{
    const chips=Q("#aiChips");
    if(!chips) return;

    const ctx=contextSnapshot();
    const a=ctx.analysis;

    const c=[];
    if(a){
      const dti = isFinite(a.dti)?a.dti:999;
      const cashGap = Math.max(0,(a.cashNeeded||0)-(a.cashHave||0));
      c.push(`<span class="chip neu">Contexto: ‚úÖ an√°lisis</span>`);
      c.push(`<span class="chip ${dti<=35?"good":"bad"}">DTI: ${fmtPct(dti)}</span>`);
      c.push(`<span class="chip ${cashGap===0?"good":"warn"}">Cash gap: ${fmtMoney(cashGap)}</span>`);
      c.push(`<span class="chip neu">Rec: ${a.rec}</span>`);
    }else{
      c.push(`<span class="chip warn">Contexto: sin an√°lisis</span>`);
      c.push(`<span class="chip neu">Tip: pulsa ‚ÄúAnalizar‚Äù para respuestas m√°s precisas</span>`);
    }
    chips.innerHTML=c.join("");
  };

  const callAI=async (question)=>{
    // IMPORTANT: This calls your backend endpoint that you must implement securely.
    // It should call the model with a system prompt and user context.
    const payload={
      question,
      context: contextSnapshot(),
      history: aiHistory.slice(-12) // short context window
    };

    const res=await fetch("/api/ai",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    if(!res.ok){
      const txt=await res.text().catch(()=> "");
      throw new Error("AI error: "+res.status+" "+txt);
    }
    const data=await res.json();
    // expected { answer: "..." }
    return (data && data.answer) ? String(data.answer) : "No response";
  };

  const askAI=async ()=>{
    const ta=Q("#aiQ");
    const q=(ta.value||"").trim();
    if(!q) return;
    ta.value="";
    pushAIMessage("user",q);

    // quick local ‚Äúfallback‚Äù if no backend
    // (won‚Äôt be ‚ÄúChatGPT‚Äù, but prevents dead UI)
    const fallback=()=>{
      const ctx=contextSnapshot();
      const a=ctx.analysis;
      if(!a){
        return "Para aconsejarte mejor, pulsa primero ‚ÄúAnalizar‚Äù. Mientras: regla r√°pida ‚Üí hipoteca ideal <= 30‚Äì35% de ingresos netos, y no uses todos tus ahorros para la entrada (deja un colch√≥n).";
      }
      const cashGap=Math.max(0,(a.cashNeeded||0)-(a.cashHave||0));
      const dti=isFinite(a.dti)?a.dti:999;
      const tips=[];
      tips.push(`Tu recomendaci√≥n actual es: ${a.rec}.`);
      tips.push(`Esfuerzo hipoteca aprox: ${fmtPct(dti)} (objetivo: <= 35%).`);
      if(cashGap>0) tips.push(`Te falta cash para comprar: ${fmtMoney(cashGap)} (entrada + costes).`);
      tips.push("Si me dices si tienes deudas (coche, pr√©stamos) y tu estabilidad laboral, afino el consejo.");
      return tips.join("\n");
    };

    pushAIMessage("ai","‚Ä¶pensando‚Ä¶");

    // Replace the last message when we get response
    try{
      const answer=await callAI(q);
      aiHistory.pop();
      pushAIMessage("ai",answer);
    }catch(e){
      // keep it usable
      aiHistory.pop();
      pushAIMessage("ai", fallback() + "\n\n(Nota t√©cnica: no he podido contactar con /api/ai. Implementa el backend para IA real.)");
    }
    renderAIChips();
  };

  // Navigation / buttons
  Q("#np").addEventListener("click",()=>{
    let nm=(Q("#nm").value||"").trim();let ag=+Q("#ag").value||0;
    if(!nm||ag<18||ag>100){toast(t("toastCheckNameAge"));return;}
    saveForm(); show("e");
  });
  Q("#ne").addEventListener("click",()=>{saveForm(); show("f");});
  Q("#go").addEventListener("click",analyze);
  Q("#cp").addEventListener("click",copy);
  Q("#rs").addEventListener("click",reset);
  Q("#bc").addEventListener("click",compare);
  Q("#autoFillCmp").addEventListener("click",fillComparatorFromLast);
  Q("#cm").addEventListener("change",()=>{upMap();saveForm();});
  Q("#jumpX").addEventListener("click",()=>{ if(!lastReq){toast(t("toastFirstAnalyze"));return;} show("x"); });
  Q("#jumpAI").addEventListener("click",()=>{ if(!lastReq){toast(t("toastFirstAnalyze"));return;} show("ai"); });

  Q("#t_p").addEventListener("click",()=>show("p"));
  Q("#t_e").addEventListener("click",()=>show("e"));
  Q("#t_f").addEventListener("click",()=>show("f"));
  Q("#t_r").addEventListener("click",()=>{ if(!lastReq){toast(t("toastFirstAnalyze"));return;} show("r"); });
  Q("#t_m").addEventListener("click",()=>{ if(!lastReq){toast(t("toastFirstAnalyze"));return;} show("m"); setTimeout(()=>drawCmpChart(last?last.pb:0,last?last.pb:0),120); });
  Q("#t_x").addEventListener("click",()=>{ if(!lastReq){toast(t("toastFirstAnalyze"));return;} show("x"); });
  Q("#t_ai").addEventListener("click",()=>{ if(!lastReq){toast(t("toastFirstAnalyze"));return;} show("ai"); });

  Q("#toggleMap").addEventListener("click",()=>{
    const box=Q("#zoneWrap");
    const open=box.style.display!=="none";
    box.style.display=open?"none":"block";
    if(!open){
      initMap();
      setTimeout(()=>{ if(zmap) zmap.invalidateSize(); },200);
    }
  });

  Q("#zoneClear").addEventListener("click",()=>{
    zoneSel.clear(); saveZoneSel();
    geoByName.forEach((_,name)=>applyPolyStyle(name));

    const pm=Q("#ar").querySelector('[value="__multi__"]');
    if(pm){pm.remove();if(Q("#ar").value==="__multi__")Q("#ar").value="*";}
    renderZoneUI(); refreshExamplesUI(); toast(t("toastZoneCleared"));
  });

  Q("#zoneApply").addEventListener("click",()=>{
    if(zoneSel.size===0){toast(t("toastNoZone"));return;}
    const pm=Q("#ar").querySelector('[value="__multi__"]');if(pm)pm.remove();
    if(zoneSel.size===1){
      const only=[...zoneSel][0];
      if([...Q("#ar").options].some(o=>o.value===only||o.textContent===only)) Q("#ar").value=only;
      else Q("#ar").value="*";
    } else {
      const mo=document.createElement("option");
      mo.value="__multi__";
      mo.textContent=[...zoneSel].join(", ");
      Q("#ar").insertBefore(mo,Q("#ar").options[1]||null);
      Q("#ar").value="__multi__";
    }
    saveZoneSel(); renderZoneUI(); saveForm(); refreshExamplesUI();
    toast(t("toastZoneApplied"));
  });

  // persist changes
  ["#nm","#ar","#ty","#hor","#fst","#cm","#cty",
   "#et","#ep","#el","#ek","#es","#ej","#ea",
   "#ct","#cp0","#cl0","#ck0","#cs0","#cj0","#ca0",
   "#inc","#sav","#yrs","#msv","#m2","#bed","#bat","#cm2","#cbd","#cba"
  ].forEach(sel=>{
    let el=Q(sel); if(!el) return;
    el.addEventListener("change",()=>{saveForm(); refreshExamplesUI(); renderAIChips();});
    el.addEventListener("input",()=>{saveForm(); renderAIChips();});
  });

  Q("#L_CA").addEventListener("click",()=>setLang("CA"));
  Q("#L_ES").addEventListener("click",()=>setLang("ES"));
  Q("#L_EN").addEventListener("click",()=>setLang("EN"));
  if(Q("#shareWa")) Q("#shareWa").addEventListener("click",shareWhatsApp);
  if(Q("#shareCl")) Q("#shareCl").addEventListener("click",copy);

  // AI events
  Q("#aiAsk").addEventListener("click",askAI);
  Q("#aiClear").addEventListener("click",()=>clearAIChat(false));
  Q("#aiQ").addEventListener("keydown",(e)=>{
    if((e.ctrlKey||e.metaKey) && e.key==="Enter") askAI();
  });

  // init
  loadZoneSel();
  loadForm();
  setLang(LANG);
  upMap();
  updateSteps("p");
  liveValidate();
  setTabsEnabled();
  refreshExamplesUI();
  renderAIChat();
  renderAIChips();

  // seed AI chat if empty
  if(aiHistory.length===0){
    pushAIMessage("ai","Hola üëã Soy tu IA Asesor. Si ya analizaste, puedo recomendarte acciones concretas para acercarte a COMPRAR o confirmar ALQUILER con margen.");
  }

  // redraw charts on resize
  window.addEventListener("resize",()=>{
    if(last){
      drawEffortChart();
      drawSensitivityChart();
      if(Q("#cmpChart")) drawCmpChart(last.pb,last.pb);
    }
  });
})()
}

waitForLeaflet();
</script>

<!-- =========================================================
BACKEND REQUIRED (EXAMPLE)
=========================================================
You need an API endpoint POST /api/ai that returns JSON: { answer: "..." }

Example (Node/Express) skeleton (NOT executed in browser):

import express from "express";
import OpenAI from "openai";
const app=express();
app.use(express.json());
const client=new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

app.post("/api/ai", async (req,res)=>{
  const { question, context, history } = req.body || {};
  const system = `Eres un asesor financiero prudente y claro para vivienda en Catalunya.
No inventes datos. Si falta informaci√≥n, pregunta lo m√≠nimo.
Da recomendaciones accionables (presupuesto, esfuerzo, ahorro, riesgos).
Incluye disclaimer breve.`;

  const messages = [
    { role:"system", content: system },
    { role:"user", content: `Contexto (JSON): ${JSON.stringify(context)}` },
    ...(Array.isArray(history)?history.map(m=>({ role:m.role==="user"?"user":"assistant", content:String(m.content||"") })) : []),
    { role:"user", content: String(question||"") }
  ];

  const r = await client.chat.completions.create({
    model: "gpt-4.1-mini",
    messages,
    temperature: 0.4
  });
  const answer = r.choices?.[0]?.message?.content || "";
  res.json({ answer });
});

app.listen(3000);

========================================================== -->
</body>
</html>
