<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Assessoria d‚ÄôHabitatge ¬∑ Baix Pened√®s</title>

<style>
:root{
  --bg:#020617;
  --panel:rgba(15,23,42,.84);
  --panel2:rgba(11,18,32,.88);
  --bd:rgba(148,163,184,.20);
  --bd2:rgba(148,163,184,.28);
  --t:#e5e7eb;
  --m:#94a3b8;
  --muted:#a3b2c7;
  --pill:#38bdf8;
  --pill2:#06b6d4;
  --good:#22c55e;
  --warn:#f59e0b;
  --bad:#ef4444;
  --vio:#a78bfa;

  --g3:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
  --g4:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);
  --g5:linear-gradient(135deg,#fa709a 0%,#fee140 100%);

  --shadow:0 10px 30px rgba(0,0,0,.35);
  --shadow2:0 18px 55px rgba(0,0,0,.45);

  --r12:12px;
  --r16:16px;
  --r20:20px;

  --fs: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--t);font-family:var(--fs);
  -webkit-font-smoothing:antialiased; overflow-x:hidden;
}
body::before{
  content:"";position:fixed;inset:0;z-index:-1;pointer-events:none;
  background:
    radial-gradient(1200px 650px at 15% -10%, rgba(56,189,248,.20), transparent 60%),
    radial-gradient(900px 550px at 85% 0%, rgba(34,197,94,.14), transparent 60%),
    radial-gradient(700px 450px at 50% 110%, rgba(168,85,247,.12), transparent 60%),
    linear-gradient(180deg,#0f172a 0%,#020617 60%,#000 100%);
  animation:pulse 18s ease-in-out infinite;
}
@keyframes pulse{0%,100%{opacity:.85}50%{opacity:1}}

a{color:#93c5fd;text-decoration:none}
a:hover{text-decoration:underline}

.wrap{max-width:1220px;margin:18px auto 22px;padding:0 14px}
.card{
  background:var(--panel);border:1px solid var(--bd);
  border-radius:var(--r20);box-shadow:var(--shadow);
  backdrop-filter: blur(16px);
  padding:18px; margin:14px 0; position:relative; overflow:hidden;
}
.card::before{
  content:"";position:absolute;left:0;right:0;top:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(56,189,248,.55),transparent);
  opacity:.55;
}
.card:hover{border-color:rgba(56,189,248,.35); box-shadow:var(--shadow2)}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.row.between{justify-content:space-between}
.pill{
  background:var(--g3); color:#001018;
  padding:10px 16px;border-radius:999px;font-weight:950;
  text-transform:uppercase; letter-spacing:.6px; font-size:.88rem;
  box-shadow:0 6px 18px rgba(56,189,248,.25);
}
.hint{color:#cbd5e1;opacity:.95;font-size:.95rem;line-height:1.6}
.small{color:var(--m);font-size:.86rem;line-height:1.55}
.sep{height:1px;background:rgba(148,163,184,.12);margin:14px 0}

.lang{display:flex;gap:10px;align-items:center}
.lang button{
  border:1px solid rgba(148,163,184,.30);
  background:rgba(11,18,32,.86);
  color:#cbd5e1;
  border-radius:999px;
  padding:8px 14px;
  font-weight:950;letter-spacing:.5px;font-size:.85rem;
  cursor:pointer; transition:.15s;
}
.lang button:hover{transform:translateY(-1px);border-color:rgba(56,189,248,.45)}
.lang button.on{background:var(--g3);color:#001018;border-color:#38bdf8;box-shadow:0 6px 18px rgba(56,189,248,.25)}

.tabs{display:flex;gap:10px;flex-wrap:wrap}
.tab{
  border:1px solid rgba(148,163,184,.25);
  background:rgba(11,18,32,.78);
  color:#cbd5e1;
  border-radius:999px;
  padding:10px 16px;
  font-weight:950;
  cursor:pointer;
  transition:.15s;
  user-select:none;
  font-size:.90rem; letter-spacing:.2px;
}
.tab:hover{transform:translateY(-2px);border-color:rgba(56,189,248,.4);box-shadow:0 6px 16px rgba(56,189,248,.10)}
.tab.on{background:var(--g3);color:#001018;border-color:#38bdf8}
.tab.dis{opacity:.45;cursor:not-allowed}
.tab.dis:hover{transform:none;box-shadow:none}

.grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
@media(max-width:840px){.grid2{grid-template-columns:1fr}}
.grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
@media(max-width:980px){.grid3{grid-template-columns:1fr}}

label{display:flex;gap:8px;align-items:center;color:#cbd5e1;font-weight:800;margin:0 0 6px 0;font-size:.90rem}
label .q{
  width:16px;height:16px;border-radius:50%;
  display:inline-flex;align-items:center;justify-content:center;
  font-size:10px;font-weight:950;
  color:#93a4bd;background:rgba(148,163,184,.18);
  border:1px solid rgba(148,163,184,.25);
  cursor:help; user-select:none;
  position:relative;
}
label .q:hover .tip{opacity:1;transform:translateY(0)}
.tip{
  opacity:0;transform:translateY(6px);
  transition:.15s;
  position:absolute;left:50%;bottom:calc(100% + 8px);translate:-50% 0;
  width:260px; background:#0f172a; border:1px solid rgba(56,189,248,.35);
  border-radius:12px;padding:10px 12px;
  color:#cbd5e1;font-size:.82rem;line-height:1.5;
  box-shadow:0 12px 28px rgba(0,0,0,.55); z-index:9999;
  pointer-events:none;
}

input,select,textarea{
  width:100%;
  border:1px solid rgba(148,163,184,.30);
  background:rgba(2,6,23,.80);
  color:var(--t);
  border-radius:var(--r12);
  padding:12px 14px;
  outline:none;
  transition:.15s;
  font-size:.95rem;
}
textarea{min-height:92px;resize:vertical}
input:focus,select:focus,textarea:focus{border-color:#38bdf8;box-shadow:0 0 0 4px rgba(56,189,248,.12)}
input.ok{border-color:rgba(34,197,94,.45)}
input.err{border-color:rgba(239,68,68,.55); box-shadow:0 0 0 4px rgba(239,68,68,.10)}
.fhint{min-height:18px;margin-top:4px;font-size:.80rem}
.fhint.ok{color:#4ade80}
.fhint.err{color:#fca5a5}

.btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.btn{
  border:0;cursor:pointer;
  border-radius:14px;
  padding:12px 18px;
  font-weight:950;
  letter-spacing:.3px;
  transition:.15s;
  position:relative;
  overflow:hidden;
  font-size:.95rem;
}
.btn.primary{background:var(--g3);color:#001018;box-shadow:0 8px 22px rgba(56,189,248,.18)}
.btn.good{background:var(--g4);color:#001018;box-shadow:0 8px 22px rgba(67,233,123,.18)}
.btn.ghost{
  background:rgba(11,18,32,.78);
  color:#cbd5e1;border:1px solid rgba(148,163,184,.28)
}
.btn.warn{
  background:linear-gradient(135deg,rgba(245,158,11,.9),rgba(251,191,36,.9));
  color:#111827;
}
.btn:hover{transform:translateY(-2px)}
.btn:active{transform:translateY(0)}
.btn.dis{opacity:.45;cursor:not-allowed;filter:grayscale(.2)}
.btn.dis:hover{transform:none}

.notice{
  margin-top:12px;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid rgba(56,189,248,.25);
  background:rgba(56,189,248,.08);
  border-left:4px solid #38bdf8;
  display:flex;gap:12px;align-items:flex-start;
}
.notice .ic{font-size:1.15rem;line-height:1.1;margin-top:2px}
.notice .tx{color:#dbeafe;line-height:1.6;font-size:.92rem}

.kgrid{
  display:grid; gap:12px;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
}
.kpi{
  background:linear-gradient(145deg,rgba(14,165,233,.12),rgba(6,182,212,.07));
  border:1px solid rgba(56,189,248,.30);
  border-radius:18px;
  padding:16px;
  box-shadow:0 10px 24px rgba(0,0,0,.18);
  min-height:108px;
  position:relative;
  overflow:hidden;
}
.kpi::before{
  content:"";position:absolute;inset:-30%;
  background:radial-gradient(circle,rgba(56,189,248,.12),transparent 60%);
  opacity:.65; transform:scale(1);
  transition:.5s;
}
.kpi:hover::before{transform:scale(1.15)}
.kpi .k{position:relative;z-index:1;color:#a7b7cc;font-size:.78rem;font-weight:900;text-transform:uppercase;letter-spacing:.8px}
.kpi .v{
  position:relative;z-index:1;margin-top:10px;
  font-size:clamp(22px,3.1vw,34px);
  line-height:1.06;
  font-weight:980;
  color:#f1f5f9;
  text-shadow:0 2px 10px rgba(0,0,0,.35);
  word-break:break-word;
}
.kpi .s{position:relative;z-index:1;margin-top:7px;color:#8fa4bf;font-size:.80rem;line-height:1.35}

.badge{
  display:inline-flex;align-items:center;gap:8px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.26);
  background:rgba(11,18,32,.76);
  padding:8px 12px;
  font-weight:950;
  font-size:.85rem;
  color:#cbd5e1;
}
.badge.good{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10);color:#86efac}
.badge.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.10);color:#fde68a}
.badge.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.10);color:#fca5a5}

.panel{
  margin-top:14px;
  border:1px solid rgba(148,163,184,.20);
  background:linear-gradient(135deg,rgba(15,23,42,.85),rgba(11,18,32,.92));
  border-radius:16px;padding:16px;
}
.panel h3{margin:0 0 10px 0;font-size:1.05rem}
.panel p{margin:0;color:#cbd5e1;line-height:1.7;font-size:.95rem}

.progress{
  height:8px;border-radius:999px;background:rgba(255,255,255,.08);
  overflow:hidden;margin-top:6px
}
.bar{height:8px;border-radius:999px;transition:width .7s cubic-bezier(.4,0,.2,1)}
.bar.good{background:linear-gradient(90deg,#22c55e,#4ade80)}
.bar.warn{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.bar.bad{background:linear-gradient(90deg,#ef4444,#f87171)}

.canvasWrap{
  margin-top:12px;
  border:1px solid rgba(148,163,184,.18);
  background:rgba(2,6,23,.55);
  border-radius:14px;
  padding:10px;
}
canvas{width:100%;height:220px;display:block}
@media(max-width:820px){canvas{height:260px}}

#mapWrap{display:none}
#map{height:420px;border-radius:14px;border:1px solid rgba(148,163,184,.22);overflow:hidden}
@media(max-width:820px){#map{height:420px}}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{
  border:1px solid rgba(148,163,184,.25);
  background:rgba(11,18,32,.75);
  color:#cbd5e1;border-radius:999px;
  padding:7px 12px;font-weight:950;font-size:.85rem;
  cursor:pointer;transition:.15s
}
.chip:hover{transform:translateY(-1px);border-color:rgba(56,189,248,.4)}
.chip.on{border-color:#38bdf8;color:#dbeafe}
.chip.off{opacity:.75}

.footer{
  max-width:1220px;margin:10px auto 18px;padding:10px 14px;
  border:1px solid rgba(148,163,184,.20);
  background:rgba(11,18,32,.55);
  border-radius:14px;
  color:#a5b4fc;
  display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
}

/* Modal */
.modalBack{
  position:fixed;inset:0;display:none;place-items:center;
  background:rgba(0,0,0,.55);z-index:999999;
  padding:18px;
}
.modal{
  width:min(680px,100%);
  background:#0b1220;border:1px solid rgba(148,163,184,.25);
  border-radius:18px;box-shadow:0 30px 80px rgba(0,0,0,.6);
  padding:16px;
}
.modal h2{margin:0 0 8px 0;font-size:1.15rem}
.modal .mtext{color:#cbd5e1;line-height:1.6}
.modal .list{margin-top:10px;padding-left:18px;color:#cbd5e1}
.modal .list li{margin:6px 0}
.modal .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}

/* Toast */
.toast{
  position:fixed;left:50%;bottom:18px;translate:-50% 0;
  background:rgba(2,6,23,.92);border:1px solid rgba(148,163,184,.35);
  color:var(--t);padding:10px 14px;border-radius:12px;
  opacity:0;pointer-events:none;transition:.15s;
  z-index:999999;
}
.toast.on{opacity:1}
</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
</head>

<body>
<div class="wrap" id="app">
  <div class="card">
    <div class="row between">
      <div class="pill" id="hdrTitle">ASSESSORIA D‚ÄôHABITATGE ¬∑ BAIX PENED√àS</div>
      <div class="row" style="justify-content:flex-end;flex:1">
        <div class="hint" id="hdrHint">Ejemplos reales: solo despu√©s de Analizar.</div>
        <div class="lang" aria-label="language">
          <button id="btnCA" type="button">CA</button>
          <button id="btnES" type="button" class="on">ES</button>
          <button id="btnEN" type="button">EN</button>
        </div>
      </div>
    </div>

    <div class="sep"></div>

    <div class="tabs" role="tablist">
      <div class="tab on" id="tabP" role="tab">1 Personal</div>
      <div class="tab" id="tabE" role="tab">2 Econom√≠a</div>
      <div class="tab" id="tabF" role="tab">3 Preferencias</div>
      <div class="tab dis" id="tabR" role="tab">4 Resultado</div>
      <div class="tab dis" id="tabC" role="tab">5 Comparador</div>
      <div class="tab dis" id="tabX" role="tab">6 Ejemplos reales</div>
    </div>
  </div>

  <!-- PERSONAL -->
  <section class="card" data-page="p">
    <div class="grid2">
      <div>
        <label><span id="lblName">Nombre y apellidos</span>
          <span class="q">i<span class="tip" id="tipName">Usado solo para personalizar el resumen. No se env√≠a a ning√∫n sitio.</span></span>
        </label>
        <input id="nm" type="text" autocomplete="name" placeholder="Ej: Alex Garc√≠a">
        <div class="fhint" id="h_nm"></div>
      </div>
      <div>
        <label><span id="lblAge">Edad (18‚Äì100)</span>
          <span class="q">i<span class="tip" id="tipAge">La app est√° pensada para j√≥venes, pero funciona con cualquier edad.</span></span>
        </label>
        <input id="ag" type="number" min="18" max="100" placeholder="Ej: 19">
        <div class="fhint" id="h_ag"></div>
      </div>
    </div>

    <div class="notice">
      <div class="ic">‚û°Ô∏è</div>
      <div class="tx" id="hintP">Rellena lo b√°sico y contin√∫a. Luego podr√°s ajustar n√∫meros con calma.</div>
    </div>

    <div class="btns">
      <button class="btn primary" id="goE" type="button">Continuar</button>
      <button class="btn ghost" id="demoFill" type="button">Demo</button>
    </div>
  </section>

  <!-- ECONOMIA -->
  <section class="card" data-page="e" style="display:none">
    <div class="grid2">
      <div>
        <label><span id="lblInc">Ingresos mensuales (‚Ç¨)</span>
          <span class="q">i<span class="tip" id="tipInc">Ingresos netos aproximados al mes. Si var√≠a, pon una media.</span></span>
        </label>
        <input id="inc" type="number" min="0" placeholder="Ej: 1700">
        <div class="fhint" id="h_inc"></div>
      </div>
      <div>
        <label><span id="lblSav">Ahorros disponibles (‚Ç¨)</span>
          <span class="q">i<span class="tip" id="tipSav">Dinero que puedes usar como entrada + gastos sin quedarte a 0.</span></span>
        </label>
        <input id="sav" type="number" min="0" placeholder="Ej: 12000">
        <div class="fhint" id="h_sav"></div>
      </div>

      <div>
        <label><span id="lblYrs">A√±os de hipoteca (5‚Äì40)</span>
          <span class="q">i<span class="tip" id="tipYrs">M√°s a√±os: cuota m√°s baja, pero m√°s intereses totales.</span></span>
        </label>
        <input id="yrs" type="number" min="5" max="40" placeholder="Ej: 30">
        <div class="fhint" id="h_yrs"></div>
      </div>

      <div>
        <label><span id="lblMsv">Ahorro mensual (‚Ç¨)</span>
          <span class="q">i<span class="tip" id="tipMsv">Cu√°nto puedes ahorrar al mes sin ‚Äúmorirte‚Äù por el camino.</span></span>
        </label>
        <input id="msv" type="number" min="0" placeholder="Ej: 250">
        <div class="fhint" id="h_msv"></div>
      </div>

      <div>
        <label><span id="lblHor">¬øVivir√°s m√°s de 5 a√±os aqu√≠?</span></label>
        <select id="hor">
          <option value="y">S√≠</option>
          <option value="n">No</option>
        </select>
      </div>

      <div>
        <label><span id="lblFst">¬øPrimera vivienda o familia con menores?</span>
          <span class="q">i<span class="tip" id="tipFst">Afecta a la entrada estimada: 10% si ‚Äúprimer hogar‚Äù, 20% si no.</span></span>
        </label>
        <select id="fst">
          <option value="y">S√≠</option>
          <option value="n">No</option>
        </select>
      </div>
    </div>

    <div class="notice">
      <div class="ic">‚û°Ô∏è</div>
      <div class="tx" id="hintE">Completa econom√≠a y pasa a preferencias. Si algo no cuadra, te lo dir√° con un aviso.</div>
    </div>

    <div class="btns">
      <button class="btn primary" id="backP" type="button">‚Üê Volver</button>
      <button class="btn primary" id="goF" type="button">Continuar</button>
    </div>
  </section>

  <!-- PREFERENCIAS -->
  <section class="card" data-page="f" style="display:none">
    <div class="grid2">
      <div>
        <label><span id="lblMuni">Municipio (Baix Pened√®s)</span>
          <span class="q">i<span class="tip" id="tipMuni">Si eliges ‚ÄúCualquiera‚Äù, se usa tu selecci√≥n del mapa o una media.</span></span>
        </label>
        <select id="muni">
          <option value="*">Cualquiera</option>
          <option>Cunit</option><option>Calafell</option><option>El Vendrell</option><option>Santa Oliva</option><option>Bellvei</option>
          <option>L'Arbo√ß</option><option>Banyeres del Pened√®s</option><option>Albinyana</option><option>Bonastre</option><option>Maslloren√ß</option>
          <option>La Bisbal del Pened√®s</option><option>Lloren√ß del Pened√®s</option><option>Sant Jaume dels Domenys</option><option>El Montmell</option>
        </select>
        <div class="small" id="muniHelp" style="margin-top:6px">Tip: usa el mapa para seleccionar zona completa (varios municipios).</div>
      </div>

      <div>
        <label><span id="lblType">Tipo de vivienda</span></label>
        <select id="ptype">
          <option value="flat">Piso</option>
          <option value="house">Casa</option>
        </select>
      </div>

      <div>
        <label><span id="lblM2">Metros cuadrados (‚â•50)</span></label>
        <input id="m2" type="number" min="50" placeholder="Ej: 80">
        <div class="fhint" id="h_m2"></div>
      </div>

      <div class="grid2" style="gap:10px">
        <div>
          <label><span id="lblBed">Habitaciones</span></label>
          <input id="bed" type="number" min="0" max="10" placeholder="Ej: 2">
        </div>
        <div>
          <label><span id="lblBath">Ba√±os</span></label>
          <input id="bath" type="number" min="1" max="10" placeholder="Ej: 1">
          <div class="fhint" id="h_bath"></div>
        </div>
      </div>

      <div>
        <label><span id="lblExtras">Extras</span></label>
        <div class="small" id="extrasHint">Se aplican en modo ‚Äúestricto‚Äù. En ‚Äúflex‚Äù, no forzamos todos.</div>
        <div class="row" style="margin-top:10px">
          <label style="margin:0"><input type="checkbox" id="exT" style="width:auto"> <span id="exTer">Terraza</span></label>
          <label style="margin:0"><input type="checkbox" id="exP" style="width:auto"> <span id="exPis">Piscina</span></label>
          <label style="margin:0"><input type="checkbox" id="exL" style="width:auto"> <span id="exAsc">Ascensor</span></label>
          <label style="margin:0"><input type="checkbox" id="exK" style="width:auto"> <span id="exGar">Aparcamiento</span></label>
        </div>
      </div>

      <div>
        <label><span id="lblStrict">Modo de filtros</span>
          <span class="q">i<span class="tip" id="tipStrict">Estricto: exige extras seleccionados. Flex: prioriza, pero no bloquea resultados.</span></span>
        </label>
        <select id="strictMode">
          <option value="strict">Estricto</option>
          <option value="flex">Flex</option>
        </select>
      </div>
    </div>

    <div class="btns">
      <button class="btn ghost" id="toggleMapBtn" type="button">üó∫Ô∏è Mapa (zona real)</button>
      <button class="btn primary" id="analyzeBtn" type="button">Analizar</button>
      <button class="btn primary" id="backE" type="button">‚Üê Volver</button>
    </div>

    <div class="notice">
      <div class="ic">‚û°Ô∏è</div>
      <div class="tx" id="hintF">Si cambias preferencias, vuelve a Analizar. Si no, los ejemplos reales no coincidir√°n.</div>
    </div>

    <!-- MAP -->
    <div id="mapWrap" class="panel">
      <div class="row between">
        <div>
          <h3 id="mapTitle">Zona preferida (mapa real)</h3>
          <p id="mapHint">Clica un municipio para seleccionarlo. La zona se pinta para que se vea claro.</p>
          <div class="small" id="selText" style="margin-top:8px">Seleccionados: ninguno</div>
        </div>
        <div class="chips" id="selChips"></div>
      </div>

      <div class="btns">
        <button class="btn ghost" id="clearZone" type="button">Limpiar</button>
        <button class="btn good" id="applyZone" type="button">Usar selecci√≥n</button>
      </div>

      <div id="map" style="margin-top:10px"></div>

      <div class="small" style="margin-top:10px;color:#7dd3fc">
        ‚Ä¢ Visual: pin + zona coloreada. As√≠ no hay dudas de qu√© est√°s filtrando.
      </div>
    </div>
  </section>

  <!-- RESULTADO -->
  <section class="card" data-page="r" style="display:none">
    <div class="kgrid">
      <div class="kpi">
        <div class="k" id="kPriceLbl">Precio estimado</div>
        <div class="v" id="kPrice">0 ‚Ç¨</div>
        <div class="s" id="kPriceSub">‚Äì</div>
      </div>
      <div class="kpi">
        <div class="k" id="kRentLbl">Alquiler estimado</div>
        <div class="v" id="kRent">0 ‚Ç¨</div>
        <div class="s" id="kRentSub">‚Äì</div>
      </div>
      <div class="kpi">
        <div class="k" id="kPayLbl">Cuota hipoteca</div>
        <div class="v" id="kPay">0 ‚Ç¨</div>
        <div class="s" id="kPaySub">‚Äì</div>
      </div>
      <div class="kpi">
        <div class="k" id="kRecLbl">Recomendaci√≥n</div>
        <div class="v" id="kRec">‚Äì</div>
        <div class="s" id="kRecSub">‚Äì</div>
      </div>
    </div>

    <div class="panel" id="resultPanel" style="margin-top:14px;display:none">
      <div class="row between">
        <h3 id="rTitle" style="margin:0"></h3>
        <div class="row" id="rBadges"></div>
      </div>

      <div class="sep"></div>

      <div class="grid3">
        <div class="panel" style="margin:0">
          <h3 id="whyTitle">‚Äî</h3>
          <p id="whyText">‚Äî</p>
        </div>
        <div class="panel" style="margin:0">
          <h3 id="finTitle">Financiaci√≥n</h3>
          <p id="finText">‚Äî</p>
        </div>
        <div class="panel" style="margin:0">
          <h3 id="prefTitle">Preferencias</h3>
          <p id="prefText">‚Äî</p>
        </div>
      </div>

      <div class="sep"></div>

      <div class="grid2">
        <div class="panel" style="margin:0">
          <h3 id="effTitle">Esfuerzo mensual (visual)</h3>
          <p class="small" id="effHint">L√≠nea: ‚Äúcapacidad segura‚Äù (35% de ingresos). Barras: hipoteca vs alquiler.</p>
          <div class="canvasWrap"><canvas id="effCanvas" width="900" height="260"></canvas></div>
        </div>
        <div class="panel" style="margin:0">
          <h3 id="sensTitle">Sensibilidad (tipo de inter√©s)</h3>
          <p class="small" id="sensHint">C√≥mo cambia la cuota si sube el tipo. No predice el futuro, solo te ense√±a el riesgo.</p>
          <div class="canvasWrap"><canvas id="sensCanvas" width="900" height="260"></canvas></div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="panel" style="margin:0">
        <h3 id="reportTitle">Resumen copiable</h3>
        <textarea id="reportBox" readonly></textarea>
        <div class="btns">
          <button class="btn primary" id="copyBtn" type="button">Copiar</button>
          <button class="btn ghost" id="whatsBtn" type="button">WhatsApp</button>
          <button class="btn ghost" id="toExamplesBtn" type="button">Ir a Ejemplos reales</button>
        </div>
      </div>
    </div>

    <div class="btns">
      <button class="btn primary" id="backF" type="button">‚Üê Volver</button>
      <button class="btn ghost" id="resetBtn" type="button">Reiniciar</button>
    </div>
  </section>

  <!-- COMPARADOR -->
  <section class="card" data-page="c" style="display:none">
    <div class="grid2">
      <div>
        <label><span id="cmpProvLbl">Provincia (comparador)</span></label>
        <select id="cmpProv">
          <option>Barcelona</option>
          <option>Girona</option>
          <option>Lleida</option>
          <option>Tarragona</option>
        </select>
      </div>
      <div class="small" id="cmpDesc" style="align-self:end">
        Comparas tu zona (Baix Pened√®s) contra una provincia usando tus mismos filtros.
      </div>

      <div>
        <label id="cmpM2Lbl">m¬≤</label>
        <input id="cmpM2" type="number" min="50" placeholder="Ej: 80">
      </div>
      <div class="grid2" style="gap:10px">
        <div>
          <label id="cmpBedLbl">Habitaciones</label>
          <input id="cmpBed" type="number" min="0" max="10" placeholder="Ej: 2">
        </div>
        <div>
          <label id="cmpBathLbl">Ba√±os</label>
          <input id="cmpBath" type="number" min="1" max="10" placeholder="Ej: 1">
        </div>
      </div>

      <div>
        <label id="cmpTypeLbl">Tipo</label>
        <select id="cmpType">
          <option value="flat">Piso</option>
          <option value="house">Casa</option>
        </select>
      </div>

      <div>
        <label id="cmpExtrasLbl">Extras (comparador)</label>
        <div class="row">
          <label style="margin:0"><input type="checkbox" id="cT" style="width:auto"> <span id="cTer">Terraza</span></label>
          <label style="margin:0"><input type="checkbox" id="cP" style="width:auto"> <span id="cPis">Piscina</span></label>
          <label style="margin:0"><input type="checkbox" id="cL" style="width:auto"> <span id="cAsc">Ascensor</span></label>
          <label style="margin:0"><input type="checkbox" id="cK" style="width:auto"> <span id="cGar">Aparcamiento</span></label>
        </div>
      </div>
    </div>

    <div class="btns">
      <button class="btn primary" id="cmpRun" type="button">Comparar</button>
      <button class="btn good" id="cmpUseMine" type="button">Usar mis datos</button>
      <button class="btn ghost" id="backR" type="button">‚Üê Volver</button>
    </div>

    <div class="panel" id="cmpOut" style="display:none">
      <h3 id="cmpTitle">Resultado</h3>
      <p id="cmpText">‚Äî</p>
      <div class="canvasWrap"><canvas id="cmpCanvas" width="900" height="260"></canvas></div>
    </div>
  </section>

  <!-- EJEMPLOS REALES -->
  <section class="card" data-page="x" style="display:none">
    <div class="panel" style="margin:0">
      <h3 id="xTitle">Ejemplos reales</h3>
      <p id="xInfo">‚Äî</p>
      <div class="btns" id="xBtns"></div>
      <div class="notice">
        <div class="ic">‚û°Ô∏è</div>
        <div class="tx" id="xHint">
          Si has seleccionado varios municipios, salen botones por municipio. Idealista no soporta multi-municipio en una sola URL.
        </div>
      </div>
      <div class="btns">
        <button class="btn ghost" id="backC" type="button">‚Üê Volver</button>
      </div>
    </div>
  </section>
</div>

<div class="footer">
  <div><b>Assessoria d‚ÄôHabitatge</b></div>
  <div>
    <a href="https://www.assesoriahabitatge.com/" target="_blank" rel="noopener">assesoriahabitatge.com</a> ¬∑
    <a href="mailto:info@assesoriahabitatge.com">info@assesoriahabitatge.com</a>
  </div>
</div>

<!-- MODAL -->
<div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <h2 id="modalTitle">Revisa esto</h2>
    <div class="mtext" id="modalText">‚Äî</div>
    <ul class="list" id="modalList"></ul>
    <div class="actions">
      <button class="btn ghost" id="modalClose" type="button">Cerrar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const $$ = s => [...document.querySelectorAll(s)];

  const STORE="ah_v9_form";
  const ZKEY="ah_v9_zone";
  const LKEY="ah_v9_lang";

  const towns = [
    {name:"Cunit",lat:41.1989,lng:1.6368},
    {name:"Calafell",lat:41.2010,lng:1.5687},
    {name:"El Vendrell",lat:41.2204,lng:1.5340},
    {name:"Santa Oliva",lat:41.2533,lng:1.5510},
    {name:"Bellvei",lat:41.2392,lng:1.5767},
    {name:"L'Arbo√ß",lat:41.2650,lng:1.6050},
    {name:"Banyeres del Pened√®s",lat:41.2810,lng:1.5780},
    {name:"Albinyana",lat:41.2440,lng:1.4870},
    {name:"Bonastre",lat:41.2270,lng:1.4390},
    {name:"Maslloren√ß",lat:41.2750,lng:1.4140},
    {name:"La Bisbal del Pened√®s",lat:41.2780,lng:1.4890},
    {name:"Lloren√ß del Pened√®s",lat:41.2820,lng:1.5490},
    {name:"Sant Jaume dels Domenys",lat:41.2990,lng:1.5590},
    {name:"El Montmell",lat:41.3070,lng:1.4540},
  ];

  // Coefs (tu idea original)
  const COEF={
    "Cunit":{c:1.157,r:.975},"El Vendrell":{c:.912,r:.842},"Calafell":{c:.856,r:.983},
    "Santa Oliva":{c:.783,r:.825},"Bellvei":{c:.783,r:.925},"L'Arbo√ß":{c:.735,r:.883},
    "Banyeres del Pened√®s":{c:.614,r:.783},"Albinyana":{c:.766,r:.825},"Bonastre":{c:.497,r:.683},
    "Maslloren√ß":{c:.549,r:.75},"La Bisbal del Pened√®s":{c:.623,r:.808},"Lloren√ß del Pened√®s":{c:.856,r:.65},
    "Sant Jaume dels Domenys":{c:.614,r:.65},"El Montmell":{c:.529,r:.675}
  };
  const BASE={m2:2000,rent:10,close:.11,rate:.0299}; // close algo m√°s realista (ITP + notar√≠a aprox)
  const PROV={"Barcelona":{v:2986,l:21.9},"Girona":{v:2608,l:14.99},"Lleida":{v:1486,l:9.5},"Tarragona":{v:2100,l:13.5}};

  const SLUG={
    "Cunit":"cunit-tarragona","El Vendrell":"el-vendrell-tarragona","Calafell":"calafell-tarragona","Santa Oliva":"santa-oliva-tarragona",
    "Bellvei":"bellvei-tarragona","L'Arbo√ß":"l-arboc-tarragona","Banyeres del Pened√®s":"banyeres-del-penedes-tarragona","Albinyana":"albinyana-tarragona",
    "Bonastre":"bonastre-tarragona","Maslloren√ß":"masllorenc-tarragona","La Bisbal del Pened√®s":"la-bisbal-del-penedes-tarragona","Lloren√ß del Pened√®s":"llorenc-del-penedes-tarragona",
    "Sant Jaume dels Domenys":"sant-jaume-dels-domenys-tarragona","El Montmell":"el-montmell-tarragona"
  };

  // i18n (sin mezclar idiomas)
  const I18N={
    ES:{
      hdrTitle:"ASSESSORIA D‚ÄôHABITATGE ¬∑ BAIX PENED√àS",
      hdrHint:"Ejemplos reales: solo despu√©s de Analizar.",
      tabs:["1 Personal","2 Econom√≠a","3 Preferencias","4 Resultado","5 Comparador","6 Ejemplos reales"],
      hintP:"Rellena lo b√°sico y contin√∫a. Luego podr√°s ajustar n√∫meros con calma.",
      hintE:"Completa econom√≠a y pasa a preferencias. Si algo no cuadra, te lo dir√° con un aviso.",
      hintF:"Si cambias preferencias, vuelve a Analizar. Si no, los ejemplos reales no coincidir√°n.",
      muniHelp:"Tip: usa el mapa para seleccionar zona completa (varios municipios).",
      extrasHint:"Se aplican en modo ‚Äúestricto‚Äù. En ‚Äúflex‚Äù, no forzamos todos.",
      mapTitle:"Zona preferida (mapa real)",
      mapHint:"Clica un municipio para seleccionarlo. La zona se pinta para que se vea claro.",
      selPrefix:"Seleccionados: ",
      none:"ninguno",
      analyze:"Analizar",
      go:"Continuar",
      back:"‚Üê Volver",
      reset:"Reiniciar",
      copy:"Copiar",
      wa:"WhatsApp",
      toExamples:"Ir a Ejemplos reales",
      kPrice:"Precio estimado",kRent:"Alquiler estimado",kPay:"Cuota hipoteca",kRec:"Recomendaci√≥n",
      kSubPrice:"Rango realista seg√∫n tu zona",kSubRent:"Estimaci√≥n por zona",kSubPay:"Seg√∫n plazo y tipo",kSubRec:"Basado en esfuerzo y ahorros",
      whyBuy:"¬øPor qu√© COMPRAR?",whyRent:"¬øPor qu√© ALQUILAR?",whyNo:"NO FACTIBLE",
      finTitle:"Financiaci√≥n",prefTitle:"Preferencias",
      effTitle:"Esfuerzo mensual (visual)",effHint:"L√≠nea: capacidad segura (35% ingresos). Barras: hipoteca vs alquiler.",
      sensTitle:"Sensibilidad (tipo de inter√©s)",sensHint:"C√≥mo cambia la cuota si sube el tipo. Solo ense√±a riesgo.",
      reportTitle:"Resumen copiable",
      cmpDesc:"Comparas tu zona (Baix Pened√®s) contra una provincia usando tus mismos filtros.",
      cmpTitle:"Resultado",
      xTitle:"Ejemplos reales",
      xHint:"Si has seleccionado varios municipios, salen botones por municipio. Idealista no soporta multi-municipio en una sola URL.",
      modalTitle:"Revisa esto",
      modalText:"Faltan datos o hay valores fuera de rango:",
      firstAnalyze:"Primero analiza.",
      changed:"Preferencias cambiadas: vuelve a Analizar.",
      copied:"Copiado",
      zoneCleared:"Zona limpiada",
      zoneApplied:"Zona aplicada",
      stateReady:"‚úÖ Disponible",
      stateNeed:"‚õî Requiere Analizar / re-Analizar",
      strict:"estricto",flex:"flex",
      buy:"COMPRA",rent:"ALQUILER",
      inputErr:"Revisa los campos marcados en rojo."
    },
    CA:{
      hdrTitle:"ASSESSORIA D‚ÄôHABITATGE ¬∑ BAIX PENED√àS",
      hdrHint:"Exemples reals: nom√©s despr√©s d‚ÄôAnalitzar.",
      tabs:["1 Personal","2 Economia","3 Prefer√®ncies","4 Resultat","5 Comparador","6 Exemples reals"],
      hintP:"Omple el b√†sic i continua. Despr√©s podr√†s ajustar n√∫meros amb calma.",
      hintE:"Completa economia i passa a prefer√®ncies. Si alguna cosa no quadra, t‚Äôavisar√†.",
      hintF:"Si canvies prefer√®ncies, torna a Analitzar. Si no, els exemples reals no coincidiran.",
      muniHelp:"Tip: usa el mapa per seleccionar zona completa (diversos municipis).",
      extrasHint:"S‚Äôapliquen en mode ‚Äúestricte‚Äù. En ‚Äúflex‚Äù, no forcem tot.",
      mapTitle:"Zona preferida (mapa real)",
      mapHint:"Clica un municipi per seleccionar-lo. La zona es pinta perqu√® es vegi clar.",
      selPrefix:"Seleccionats: ",
      none:"cap",
      analyze:"Analitzar",
      go:"Continuar",
      back:"‚Üê Tornar",
      reset:"Reiniciar",
      copy:"Copiar",
      wa:"WhatsApp",
      toExamples:"Anar a Exemples reals",
      kPrice:"Preu estimat",kRent:"Lloguer estimat",kPay:"Quota hipoteca",kRec:"Recomanaci√≥",
      kSubPrice:"Rang realista segons la teva zona",kSubRent:"Estimaci√≥ per zona",kSubPay:"Segons termini i tipus",kSubRec:"Basat en esfor√ß i estalvis",
      whyBuy:"Per qu√® COMPRAR?",whyRent:"Per qu√® LLOGAR?",whyNo:"NO FACTIBLE",
      finTitle:"Finan√ßament",prefTitle:"Prefer√®ncies",
      effTitle:"Esfor√ß mensual (visual)",effHint:"L√≠nia: capacitat segura (35% ingressos). Barres: hipoteca vs lloguer.",
      sensTitle:"Sensibilitat (tipus d‚Äôinter√®s)",sensHint:"Com canvia la quota si puja el tipus. Nom√©s mostra risc.",
      reportTitle:"Resum copiable",
      cmpDesc:"Compares la teva zona (Baix Pened√®s) amb una prov√≠ncia usant els mateixos filtres.",
      cmpTitle:"Resultat",
      xTitle:"Exemples reals",
      xHint:"Si has seleccionat diversos municipis, surten botons per municipi. Idealista no admet multi-municipi en una sola URL.",
      modalTitle:"Revisa aix√≤",
      modalText:"Falten dades o hi ha valors fora de rang:",
      firstAnalyze:"Primer analitza.",
      changed:"Prefer√®ncies canviades: torna a Analitzar.",
      copied:"Copiat",
      zoneCleared:"Zona netejada",
      zoneApplied:"Zona aplicada",
      stateReady:"‚úÖ Disponible",
      stateNeed:"‚õî Cal Analitzar / re-Analitzar",
      strict:"estricte",flex:"flex",
      buy:"COMPRA",rent:"LLOGUER",
      inputErr:"Revisa els camps marcats en vermell."
    },
    EN:{
      hdrTitle:"HOUSING ADVISOR ¬∑ BAIX PENED√àS",
      hdrHint:"Real examples: only after Analyze.",
      tabs:["1 Personal","2 Finance","3 Preferences","4 Result","5 Comparator","6 Real examples"],
      hintP:"Fill the basics and continue. You can fine-tune numbers later.",
      hintE:"Complete finance and move to preferences. If something is off, you'll see a warning.",
      hintF:"If you change preferences, analyze again. Otherwise real examples won't match.",
      muniHelp:"Tip: use the map to select a whole area (multiple towns).",
      extrasHint:"Applied in strict mode. In flex, we don't hard-block results.",
      mapTitle:"Preferred area (real map)",
      mapHint:"Click a town to select it. The zone is colored for clarity.",
      selPrefix:"Selected: ",
      none:"none",
      analyze:"Analyze",
      go:"Continue",
      back:"‚Üê Back",
      reset:"Reset",
      copy:"Copy",
      wa:"WhatsApp",
      toExamples:"Go to Real examples",
      kPrice:"Estimated price",kRent:"Estimated rent",kPay:"Mortgage payment",kRec:"Recommendation",
      kSubPrice:"Realistic range for your area",kSubRent:"Area estimate",kSubPay:"Based on term and rate",kSubRec:"Based on effort and savings",
      whyBuy:"Why BUY?",whyRent:"Why RENT?",whyNo:"NOT FEASIBLE",
      finTitle:"Financing",prefTitle:"Preferences",
      effTitle:"Monthly effort (visual)",effHint:"Line: safe capacity (35% income). Bars: mortgage vs rent.",
      sensTitle:"Sensitivity (interest rate)",sensHint:"How payment changes if rate increases. Only shows risk.",
      reportTitle:"Copyable summary",
      cmpDesc:"You compare your area (Baix Pened√®s) vs a province using the same filters.",
      cmpTitle:"Result",
      xTitle:"Real examples",
      xHint:"If multiple towns are selected, you'll get buttons per town. Idealista doesn't support multi-town in one URL.",
      modalTitle:"Check this",
      modalText:"Missing data or values out of range:",
      firstAnalyze:"Analyze first.",
      changed:"Preferences changed: analyze again.",
      copied:"Copied",
      zoneCleared:"Area cleared",
      zoneApplied:"Area applied",
      stateReady:"‚úÖ Ready",
      stateNeed:"‚õî Needs Analyze / re-Analyze",
      strict:"strict",flex:"flex",
      buy:"BUY",rent:"RENT",
      inputErr:"Check the red fields."
    }
  };

  let LANG = localStorage.getItem(LKEY) || "ES";
  const t = (k) => (I18N[LANG] && I18N[LANG][k]) ?? (I18N.ES[k] ?? k);
  const fmt = (n) => {
    if(!isFinite(n)) return "‚Äì";
    const loc = (LANG==="EN") ? "en-US" : "es-ES";
    return Math.round(n).toLocaleString(loc) + " ‚Ç¨";
  };
  const pct = (n) => (isFinite(n)? n.toFixed(1) : "‚Äî") + "%";

  const toast = (msg) => {
    const el=$("#toast");
    el.textContent=msg;
    el.classList.add("on");
    setTimeout(()=>el.classList.remove("on"), 1600);
  };

  const showModal = (items) => {
    $("#modalTitle").textContent=t("modalTitle");
    $("#modalText").textContent=t("modalText");
    const ul=$("#modalList"); ul.innerHTML="";
    items.forEach(x=>{
      const li=document.createElement("li"); li.textContent=x; ul.appendChild(li);
    });
    $("#modalBack").style.display="grid";
  };
  const closeModal = ()=> $("#modalBack").style.display="none";
  $("#modalClose").addEventListener("click", closeModal);
  $("#modalBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBack") closeModal(); });

  // NAV
  const pages=["p","e","f","r","c","x"];
  const tabIds={p:"#tabP",e:"#tabE",f:"#tabF",r:"#tabR",c:"#tabC",x:"#tabX"};
  const goto = (p)=>{
    pages.forEach(x=>{
      const el=document.querySelector(`[data-page="${x}"]`);
      if(el) el.style.display = (x===p) ? "block" : "none";
    });
    Object.entries(tabIds).forEach(([k,sel])=>{
      const el=$(sel);
      if(!el) return;
      el.classList.toggle("on", k===p);
    });
    window.scrollTo({top:0,behavior:"smooth"});
    if(p==="x") renderExamples();
    if(p==="c") { if(!cmpInit) initCmpCanvas(); }
  };

  // Inputs
  const inputs = {
    nm:$("#nm"), ag:$("#ag"),
    inc:$("#inc"), sav:$("#sav"), yrs:$("#yrs"), msv:$("#msv"), hor:$("#hor"), fst:$("#fst"),
    muni:$("#muni"), ptype:$("#ptype"), m2:$("#m2"), bed:$("#bed"), bath:$("#bath"),
    exT:$("#exT"), exP:$("#exP"), exL:$("#exL"), exK:$("#exK"),
    strictMode:$("#strictMode"),
    cmpProv:$("#cmpProv"), cmpM2:$("#cmpM2"), cmpBed:$("#cmpBed"), cmpBath:$("#cmpBath"), cmpType:$("#cmpType"),
    cT:$("#cT"), cP:$("#cP"), cL:$("#cL"), cK:$("#cK")
  };

  let zoneSel = new Set();
  try{
    const z=JSON.parse(localStorage.getItem(ZKEY)||"[]"); zoneSel=new Set(z);
  }catch(e){}

  // Save/load
  const save = ()=>{
    const d={
      nm:inputs.nm.value, ag:inputs.ag.value,
      inc:inputs.inc.value, sav:inputs.sav.value, yrs:inputs.yrs.value, msv:inputs.msv.value,
      hor:inputs.hor.value, fst:inputs.fst.value,
      muni:inputs.muni.value, ptype:inputs.ptype.value, m2:inputs.m2.value, bed:inputs.bed.value, bath:inputs.bath.value,
      exT:inputs.exT.checked?1:0, exP:inputs.exP.checked?1:0, exL:inputs.exL.checked?1:0, exK:inputs.exK.checked?1:0,
      strictMode:inputs.strictMode.value,
      cmpProv:inputs.cmpProv.value, cmpM2:inputs.cmpM2.value, cmpBed:inputs.cmpBed.value, cmpBath:inputs.cmpBath.value, cmpType:inputs.cmpType.value,
      cT:inputs.cT.checked?1:0, cP:inputs.cP.checked?1:0, cL:inputs.cL.checked?1:0, cK:inputs.cK.checked?1:0
    };
    localStorage.setItem(STORE, JSON.stringify(d));
    localStorage.setItem(ZKEY, JSON.stringify([...zoneSel]));
  };

  const load = ()=>{
    const s=localStorage.getItem(STORE);
    if(!s) return;
    try{
      const d=JSON.parse(s)||{};
      Object.keys(d).forEach(k=>{
        if(inputs[k] && inputs[k].type==="checkbox") inputs[k].checked=!!d[k];
        else if(inputs[k]) inputs[k].value=d[k];
      });
    }catch(e){}
  };

  // Language apply
  const applyLang = ()=>{
    document.documentElement.lang = LANG==="CA"?"ca":LANG==="EN"?"en":"es";
    $("#btnCA").classList.toggle("on", LANG==="CA");
    $("#btnES").classList.toggle("on", LANG==="ES");
    $("#btnEN").classList.toggle("on", LANG==="EN");

    $("#hdrTitle").textContent=t("hdrTitle");
    $("#hdrHint").textContent=t("hdrHint");

    $("#tabP").textContent=t("tabs")[0];
    $("#tabE").textContent=t("tabs")[1];
    $("#tabF").textContent=t("tabs")[2];
    $("#tabR").textContent=t("tabs")[3];
    $("#tabC").textContent=t("tabs")[4];
    $("#tabX").textContent=t("tabs")[5];

    $("#hintP").textContent=t("hintP");
    $("#hintE").textContent=t("hintE");
    $("#hintF").textContent=t("hintF");
    $("#muniHelp").textContent=t("muniHelp");
    $("#extrasHint").textContent=t("extrasHint");

    $("#mapTitle").textContent=t("mapTitle");
    $("#mapHint").textContent=t("mapHint");

    $("#kPriceLbl").textContent=t("kPrice");
    $("#kRentLbl").textContent=t("kRent");
    $("#kPayLbl").textContent=t("kPay");
    $("#kRecLbl").textContent=t("kRec");

    $("#effTitle").textContent=t("effTitle");
    $("#effHint").textContent=t("effHint");
    $("#sensTitle").textContent=t("sensTitle");
    $("#sensHint").textContent=t("sensHint");
    $("#reportTitle").textContent=t("reportTitle");

    $("#cmpDesc").textContent=t("cmpDesc");
    $("#xTitle").textContent=t("xTitle");
    $("#xHint").textContent=t("xHint");

    // Mode labels
    $("#strictMode").options[0].text = t("strict");
    $("#strictMode").options[1].text = t("flex");

    renderZoneUI();
    updateTabsEnabled();
    if(last) renderResult();
    renderExamples();
  };

  $("#btnCA").addEventListener("click",()=>{LANG="CA";localStorage.setItem(LKEY,LANG);applyLang();});
  $("#btnES").addEventListener("click",()=>{LANG="ES";localStorage.setItem(LKEY,LANG);applyLang();});
  $("#btnEN").addEventListener("click",()=>{LANG="EN";localStorage.setItem(LKEY,LANG);applyLang();});

  // Validation helpers
  const setHint=(id, ok, msg)=>{
    const h=$("#h_"+id);
    const el=inputs[id];
    if(!el||!h) return;
    el.classList.toggle("ok", ok && el.value!=="");
    el.classList.toggle("err", !ok && el.value!=="");
    h.className="fhint " + (ok && el.value!=="" ? "ok" : (!ok && el.value!=="" ? "err" : ""));
    h.textContent = (!ok && el.value!=="") ? msg : "";
  };

  const validatePersonal=()=>{
    const problems=[];
    const nm=(inputs.nm.value||"").trim();
    const ag=+inputs.ag.value||0;
    const okNm = nm.length>=2;
    const okAg = ag>=18 && ag<=100;
    setHint("nm", okNm, t("inputErr"));
    setHint("ag", okAg, t("inputErr"));
    if(!okNm) problems.push(LANG==="EN"?"Enter your name.":LANG==="CA"?"Introdueix el teu nom.":"Introduce tu nombre.");
    if(!okAg) problems.push(LANG==="EN"?"Age must be 18‚Äì100.":LANG==="CA"?"L'edat ha de ser 18‚Äì100.":"La edad debe ser 18‚Äì100.");
    return problems;
  };

  const validateEconomy=()=>{
    const problems=[];
    const inc=+inputs.inc.value||0;
    const sav=+inputs.sav.value||0;
    const yrs=+inputs.yrs.value||0;
    const msv=+inputs.msv.value||0;

    const okInc = inc>0;
    const okSav = sav>=0 && inputs.sav.value!=="";
    const okYrs = yrs>=5 && yrs<=40;
    const okMsv = msv>=0;

    setHint("inc", okInc, t("inputErr"));
    setHint("sav", okSav, t("inputErr"));
    setHint("yrs", okYrs, t("inputErr"));
    setHint("msv", okMsv, t("inputErr"));

    if(!okInc) problems.push(LANG==="EN"?"Monthly income required.":LANG==="CA"?"Cal ingress mensual.":"Ingresos mensuales obligatorios.");
    if(!okSav) problems.push(LANG==="EN"?"Savings required (can be 0).":LANG==="CA"?"Cal estalvis (pot ser 0).":"Ahorros obligatorios (puede ser 0).");
    if(!okYrs) problems.push(LANG==="EN"?"Mortgage years must be 5‚Äì40.":LANG==="CA"?"Anys d'hipoteca 5‚Äì40.":"A√±os de hipoteca 5‚Äì40.");
    return problems;
  };

  const validatePrefs=()=>{
    const problems=[];
    const m2=+inputs.m2.value||0;
    const bath=+inputs.bath.value||0;
    const okM2 = m2>=50;
    const okBath = bath>=1;
    setHint("m2", okM2, t("inputErr"));
    setHint("bath", okBath, t("inputErr"));
    if(!okM2) problems.push(LANG==="EN"?"m¬≤ must be at least 50.":LANG==="CA"?"Els m¬≤ han de ser com a m√≠nim 50.":"Los m¬≤ deben ser m√≠nimo 50.");
    if(!okBath) problems.push(LANG==="EN"?"Bathrooms must be at least 1.":LANG==="CA"?"Els banys han de ser m√≠nim 1.":"Los ba√±os deben ser m√≠nimo 1.");
    return problems;
  };

  // Tabs enabled after analyze
  const updateTabsEnabled=()=>{
    const dis = !last;
    ["#tabR","#tabC","#tabX"].forEach(sel=>{
      const el=$(sel);
      el.classList.toggle("dis", dis);
    });
  };

  // Demo
  $("#demoFill").addEventListener("click",()=>{
    inputs.nm.value="Demo User";
    inputs.ag.value=19;
    inputs.inc.value=1700;
    inputs.sav.value=12000;
    inputs.yrs.value=30;
    inputs.msv.value=250;
    inputs.m2.value=80;
    inputs.bed.value=2;
    inputs.bath.value=1;
    inputs.muni.value="Cunit";
    inputs.ptype.value="flat";
    inputs.exT.checked=true;
    inputs.exK.checked=true;
    inputs.strictMode.value="flex";
    save();
    toast("Demo cargada");
  });

  // NAV buttons
  $("#goE").addEventListener("click",()=>{
    const p=validatePersonal();
    if(p.length){showModal(p);return;}
    save(); goto("e");
  });
  $("#backP").addEventListener("click",()=>goto("p"));
  $("#goF").addEventListener("click",()=>{
    const p=validateEconomy();
    if(p.length){showModal(p);return;}
    save(); goto("f");
  });
  $("#backE").addEventListener("click",()=>goto("e"));
  $("#backF").addEventListener("click",()=>goto("f"));
  $("#backR").addEventListener("click",()=>goto("r"));
  $("#backC").addEventListener("click",()=>goto("c"));

  // Tab clicks
  $("#tabP").addEventListener("click",()=>goto("p"));
  $("#tabE").addEventListener("click",()=>goto("e"));
  $("#tabF").addEventListener("click",()=>goto("f"));
  $("#tabR").addEventListener("click",()=>{ if(!last){toast(t("firstAnalyze"));return;} goto("r"); });
  $("#tabC").addEventListener("click",()=>{ if(!last){toast(t("firstAnalyze"));return;} goto("c"); });
  $("#tabX").addEventListener("click",()=>{ if(!last){toast(t("firstAnalyze"));return;} goto("x"); });

  // Calculations
  const mort = (cap, rate, yrs)=>{
    const r=rate/12, n=yrs*12;
    if(rate===0) return cap/n;
    const a = r*Math.pow(1+r,n);
    const b = Math.pow(1+r,n)-1;
    return cap*(a/b);
  };

  const buyPrice=(town,m2,bed,bath,ex)=>{
    const c=(COEF[town]?.c||1);
    let base=m2*BASE.m2*c;
    let adj=bed*5000 + bath*3000;
    let x=0;
    if(ex.t) x+=base*0.05;
    if(ex.p) x+=base*0.08;
    if(ex.l) x+=base*0.04;
    if(ex.k) x+=base*0.03;
    return Math.round(base+adj+x);
  };
  const rentPrice=(town,m2,bed,bath,ex)=>{
    const r=(COEF[town]?.r||1);
    let base=m2*BASE.rent*r;
    let adj=bed*50 + bath*30;
    let x=0;
    if(ex.t) x+=base*0.15;
    if(ex.p) x+=base*0.30;
    if(ex.l) x+=base*0.08;
    if(ex.k) x+=base*0.07;
    return Math.round(base+adj+x);
  };

  const provinceBuy=(prov,m2,bed,bath,ex)=>{
    const p=PROV[prov]; if(!p) return NaN;
    let base=m2*p.v;
    let adj=bed*5000 + bath*3000;
    let x=0;
    if(ex.t) x+=base*0.05;
    if(ex.p) x+=base*0.08;
    if(ex.l) x+=base*0.04;
    if(ex.k) x+=base*0.03;
    return Math.round(base+adj+x);
  };
  const provinceRent=(prov,m2,bed,bath,ex)=>{
    const p=PROV[prov]; if(!p) return NaN;
    let base=m2*p.l;
    let adj=bed*50 + bath*30;
    let x=0;
    if(ex.t) x+=base*0.15;
    if(ex.p) x+=base*0.30;
    if(ex.l) x+=base*0.08;
    if(ex.k) x+=base*0.07;
    return Math.round(base+adj+x);
  };

  const reqSig = (r)=>[
    r.muni,r.ptype,r.m2,r.bed,r.bath,
    r.ex.t?1:0,r.ex.p?1:0,r.ex.l?1:0,r.ex.k?1:0,
    r.strict
  ].join("|");

  let last=null;
  let lastReq=null;
  let lastSig="";

  const getReq=()=>({
    muni:inputs.muni.value,
    ptype:inputs.ptype.value,
    m2:+inputs.m2.value||0,
    bed:(inputs.bed.value===""?0:+inputs.bed.value||0),
    bath:+inputs.bath.value||0,
    ex:{t:inputs.exT.checked,p:inputs.exP.checked,l:inputs.exL.checked,k:inputs.exK.checked},
    strict:inputs.strictMode.value
  });

  const prefsChanged=()=>{
    if(!lastReq) return true;
    return reqSig(getReq())!==lastSig;
  };

  // Canvas helpers (simple, no libs)
  const drawEffort = (ctx, w, h, safe, mortPay, rentPay)=>{
    ctx.clearRect(0,0,w,h);
    const pad=22;
    const max = Math.max(safe, mortPay, rentPay) * 1.25;
    const y = (v)=> h-pad - (v/max)*(h-2*pad);
    const xMid = w/2;

    ctx.globalAlpha=1;
    // grid
    ctx.strokeStyle="rgba(148,163,184,.18)";
    ctx.lineWidth=1;
    for(let i=0;i<=4;i++){
      const yy=pad + i*(h-2*pad)/4;
      ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(w-pad,yy); ctx.stroke();
    }

    // safe line
    ctx.strokeStyle="rgba(56,189,248,.9)";
    ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(pad,y(safe)); ctx.lineTo(w-pad,y(safe)); ctx.stroke();

    ctx.fillStyle="rgba(226,232,240,.9)";
    ctx.font="700 12px system-ui";
    ctx.fillText("Safe capacity " + Math.round(safe) + " ‚Ç¨", pad+6, y(safe)-8);

    // bars
    const bw = Math.min(120, (w-2*pad)/5);
    const gap = 24;
    const bx1 = xMid - bw - gap;
    const bx2 = xMid + gap;

    const drawBar=(x, val, label, color)=>{
      const top=y(val);
      ctx.fillStyle=color;
      ctx.fillRect(x, top, bw, (h-pad)-top);
      ctx.fillStyle="rgba(226,232,240,.95)";
      ctx.font="900 12px system-ui";
      ctx.fillText(label, x, pad+12);
      ctx.fillText(Math.round(val)+" ‚Ç¨", x, top-6);
    };
    drawBar(bx1, mortPay, "BUY", "rgba(34,197,94,.72)");
    drawBar(bx2, rentPay, "RENT", "rgba(245,158,11,.65)");

    // axis label
    ctx.fillStyle="rgba(148,163,184,.9)";
    ctx.font="700 11px system-ui";
    ctx.fillText("Monthly effort", pad, h-8);
  };

  const drawSensitivity = (ctx,w,h, basePay, incRateStep)=>{
    ctx.clearRect(0,0,w,h);
    const pad=22;
    const points=[];
    // 0%, +0.5, +1, +1.5, +2
    for(let i=0;i<=4;i++){
      points.push({x:i, y: basePay + i*incRateStep});
    }
    const maxY=Math.max(...points.map(p=>p.y))*1.2;
    const minY=Math.min(...points.map(p=>p.y))*0.9;

    const X=(i)=> pad + i*(w-2*pad)/4;
    const Y=(v)=> h-pad - ((v-minY)/(maxY-minY))*(h-2*pad);

    // grid
    ctx.strokeStyle="rgba(148,163,184,.18)";
    ctx.lineWidth=1;
    for(let i=0;i<=4;i++){
      const yy=pad + i*(h-2*pad)/4;
      ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(w-pad,yy); ctx.stroke();
    }

    // line
    ctx.strokeStyle="rgba(56,189,248,.95)";
    ctx.lineWidth=2;
    ctx.beginPath();
    points.forEach((p,i)=>{
      const x=X(i), y=Y(p.y);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // dots
    points.forEach((p,i)=>{
      const x=X(i), y=Y(p.y);
      ctx.fillStyle="rgba(56,189,248,.95)";
      ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
    });

    ctx.fillStyle="rgba(226,232,240,.95)";
    ctx.font="900 12px system-ui";
    ctx.fillText("Payment (‚Ç¨)", w-pad-92, pad+12);

    ctx.fillStyle="rgba(148,163,184,.9)";
    ctx.font="700 11px system-ui";
    ctx.fillText("Rate increase (+0.5% steps)", pad, h-8);
  };

  const drawComparator = (ctx,w,h, base, prov)=>{
    ctx.clearRect(0,0,w,h);
    const pad=24;
    const max=Math.max(base,prov)*1.25;
    const y=(v)=> h-pad - (v/max)*(h-2*pad);

    // grid
    ctx.strokeStyle="rgba(148,163,184,.18)";
    ctx.lineWidth=1;
    for(let i=0;i<=4;i++){
      const yy=pad + i*(h-2*pad)/4;
      ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(w-pad,yy); ctx.stroke();
    }

    const bw=Math.min(160,(w-2*pad)/4);
    const x1=(w/2) - bw - 18;
    const x2=(w/2) + 18;

    const bar=(x,val,label,color)=>{
      const top=y(val);
      ctx.fillStyle=color;
      ctx.fillRect(x, top, bw, (h-pad)-top);
      ctx.fillStyle="rgba(226,232,240,.95)";
      ctx.font="900 12px system-ui";
      ctx.fillText(label, x, pad+12);
      ctx.fillText(Math.round(val).toLocaleString("en-US")+" ‚Ç¨", x, top-6);
    };

    bar(x1, base, "Your area", "rgba(56,189,248,.40)");
    bar(x2, prov, "Province", "rgba(168,85,247,.35)");
  };

  // Analysis
  $("#analyzeBtn").addEventListener("click",()=>{
    const p=[...validatePersonal(),...validateEconomy(),...validatePrefs()];
    if(p.length){ showModal(p); return; }

    const nm=(inputs.nm.value||"").trim();
    const inc=+inputs.inc.value||0;
    const sav=+inputs.sav.value||0;
    const yrs=+inputs.yrs.value||30;
    const m2=+inputs.m2.value||0;
    const bed=(inputs.bed.value===""?0:+inputs.bed.value||0);
    const bath=+inputs.bath.value||0;
    const hor=inputs.hor.value==="y";
    const fst=inputs.fst.value==="y";
    const req=getReq();

    // Determine zone towns used for estimation
    let list=[];
    if((req.muni==="*" && zoneSel.size>0) || req.muni==="__multi__"){
      list=[...zoneSel].filter(x=>COEF[x]);
      if(list.length===0) list=["Cunit","Calafell","El Vendrell"]; // fallback
    } else if(req.muni==="*"){
      list=["Cunit","Calafell","El Vendrell"]; // reasonable default
    } else {
      list=[req.muni];
    }

    const ex=req.ex;

    const buys=list.map(tw=>buyPrice(tw,m2,bed,bath,ex));
    const rents=list.map(tw=>rentPrice(tw,m2,bed,bath,ex));
    const pb=Math.round(buys.reduce((a,b)=>a+b,0)/buys.length);
    const pr=Math.round(rents.reduce((a,b)=>a+b,0)/rents.length);
    const pbLo=Math.min(...buys), pbHi=Math.max(...buys);
    const prLo=Math.min(...rents), prHi=Math.max(...rents);

    const dp=fst?0.10:0.20;
    const down=pb*dp;
    const close=pb*BASE.close;
    const needCash=down+close;

    let rate=BASE.rate;
    if(sav<down) rate += 0.005;

    const cap=Math.max(0,pb-down);
    const pay=mort(cap, rate, yrs);
    const dti=(pay/inc)*100;
    const rti=(pr/inc)*100;

    const need = sav < needCash;
    const dtiOk = dti<=35;
    const rtiOk = rti<=40;

    let recCode="NO";
    if(!need && dtiOk && hor) recCode="BUY";
    else if(rtiOk) recCode="RENT";
    else recCode="NO";

    last={
      nm, inc, sav, yrs, m2, bed, bath, hor, fst,
      req, list, pb, pr, pbLo, pbHi, prLo, prHi,
      dp, down, close, needCash, cap, rate, pay, dti, rti, need, recCode
    };
    lastReq=req;
    lastSig=reqSig(req);

    // Enable tabs
    updateTabsEnabled();
    $("#tabR").classList.remove("dis");
    $("#tabC").classList.remove("dis");
    $("#tabX").classList.remove("dis");

    renderResult();
    save();
    goto("r");
  });

  const recLabel=()=>{
    if(!last) return "‚Äì";
    return last.recCode==="BUY" ? (LANG==="EN"?"BUY":LANG==="CA"?"COMPRAR":"COMPRAR") :
           last.recCode==="RENT"? (LANG==="EN"?"RENT":LANG==="CA"?"LLOGAR":"ALQUILAR") :
           (LANG==="EN"?"NOT FEASIBLE":LANG==="CA"?"NO FACTIBLE":"NO FACTIBLE");
  };

  const renderResult=()=>{
    if(!last) return;

    // KPI
    $("#kPrice").textContent=fmt(last.pb);
    $("#kRent").textContent=fmt(last.pr);
    $("#kPay").textContent=fmt(last.pay);
    $("#kRec").textContent=recLabel();

    const multi=last.list.length>1;
    $("#kPriceSub").textContent = multi ? `${fmt(last.pbLo)} ‚Äì ${fmt(last.pbHi)} (${last.list.length} municipios)` : t("kSubPrice");
    $("#kRentSub").textContent  = multi ? `${fmt(last.prLo)} ‚Äì ${fmt(last.prHi)} (${last.list.length} municipios)` : t("kSubRent");
    $("#kPaySub").textContent   = `${last.yrs}y ¬∑ ${(last.rate*100).toFixed(2)}%`;
    $("#kRecSub").textContent   = t("kSubRec");

    $("#resultPanel").style.display="block";

    // Badges
    const badges=[];
    const needCash=last.needCash;
    badges.push({cls:last.need?"bad":"good", txt:(LANG==="EN"?"Cash needed: ":"CA"?"Efectiu necessari: ":"Efectivo necesario: ")+fmt(needCash)});
    badges.push({cls:last.dti<=30?"good":last.dti<=35?"warn":"bad", txt:(LANG==="EN"?"Mortgage effort: ":"CA"?"Esfor√ß hipoteca: ":"Esfuerzo hipoteca: ")+pct(last.dti)});
    badges.push({cls:last.rti<=35?"good":last.rti<=40?"warn":"bad", txt:(LANG==="EN"?"Rent effort: ":"CA"?"Esfor√ß lloguer: ":"Esfuerzo alquiler: ")+pct(last.rti)});
    badges.push({cls:last.rate>BASE.rate?"warn":"good", txt:(LANG==="EN"?"Rate: ":"CA"?"Tipus: ":"Tipo: ")+(last.rate*100).toFixed(2)+"%"});

    const rb=$("#rBadges"); rb.innerHTML="";
    badges.forEach(b=>{
      const s=document.createElement("span");
      s.className="badge "+b.cls;
      s.textContent=b.txt;
      rb.appendChild(s);
    });

    $("#rTitle").textContent = (LANG==="EN"?"Clear summary":"CA"?"Resum clar":"Resumen claro") + " ¬∑ " + recLabel();

    // Why
    const whyTitle = last.recCode==="BUY" ? t("whyBuy") : last.recCode==="RENT" ? t("whyRent") : t("whyNo");
    $("#whyTitle").textContent=whyTitle;

    const reasons=[];
    if(last.recCode==="BUY"){
      reasons.push(LANG==="EN"?"You have enough cash for down payment + closing costs.":LANG==="CA"?"Tens prou efectiu per a entrada + despeses.":"Tienes efectivo suficiente para entrada + gastos.");
      reasons.push((LANG==="EN"?"Mortgage effort is within limits":"CA"?"L‚Äôesfor√ß d‚Äôhipoteca √©s dins del l√≠mit":"El esfuerzo de hipoteca est√° dentro del l√≠mite")+` (${pct(last.dti)}).`);
      reasons.push(LANG==="EN"?"Staying longer than 5 years helps amortize buying costs.":LANG==="CA"?"Quedar-t'hi m√©s de 5 anys ajuda a amortitzar costos.":"Vivir m√°s de 5 a√±os ayuda a amortizar costes.");
    } else if(last.recCode==="RENT"){
      if(last.need) reasons.push(LANG==="EN"?"You are short on cash for down payment + costs.":LANG==="CA"?"Et falta efectiu per a entrada + despeses.":"Te falta efectivo para entrada + gastos.");
      if(last.dti>35) reasons.push((LANG==="EN"?"Mortgage effort is too high":"CA"?"L‚Äôesfor√ß d‚Äôhipoteca √©s massa alt":"El esfuerzo de hipoteca es demasiado alto")+` (${pct(last.dti)}).`);
      if(!last.hor) reasons.push(LANG==="EN"?"Short stay makes buying less efficient.":LANG==="CA"?"Estada curta fa la compra menys eficient.":"Estancia corta hace la compra menos eficiente.");
      reasons.push((LANG==="EN"?"Rent effort looks acceptable":"CA"?"L‚Äôesfor√ß del lloguer √©s acceptable":"El esfuerzo del alquiler parece aceptable")+` (${pct(last.rti)}).`);
    } else {
      const probs=[];
      if(last.need) probs.push(LANG==="EN"?"Not enough cash for down payment + closing costs.":LANG==="CA"?"No hi ha prou efectiu per a entrada + despeses.":"No hay suficiente efectivo para entrada + gastos.");
      if(last.dti>35) probs.push((LANG==="EN"?"Mortgage effort exceeds 35%":"CA"?"L‚Äôesfor√ß d‚Äôhipoteca supera el 35%":"El esfuerzo de hipoteca supera el 35%")+` (${pct(last.dti)}).`);
      if(last.rti>40) probs.push((LANG==="EN"?"Rent effort exceeds 40%":"CA"?"L‚Äôesfor√ß del lloguer supera el 40%":"El esfuerzo del alquiler supera el 40%")+` (${pct(last.rti)}).`);
      probs.forEach(x=>reasons.push(x));
    }
    $("#whyText").textContent = reasons.join(" ");

    // Financing
    const fin = [];
    fin.push((LANG==="EN"?"Down payment: ":"CA"?"Entrada: ":"Entrada: ")+Math.round(last.dp*100)+"% ‚Üí "+fmt(last.down)+".");
    fin.push((LANG==="EN"?"Closing costs (est.): ":"CA"?"Despeses (est.): ":"Gastos (est.): ")+fmt(last.close)+".");
    fin.push((LANG==="EN"?"To finance: ":"CA"?"A finan√ßar: ":"A financiar: ")+fmt(last.cap)+` (${last.yrs}y @ ${(last.rate*100).toFixed(2)}%).`);
    $("#finTitle").textContent=t("finTitle");
    $("#finText").textContent = fin.join(" ");

    // Preferences
    const prefs = [];
    const muniLabel = (last.req.muni==="*" ? (zoneSel.size? (LANG==="EN"?"Selected area":"CA"?"Zona seleccionada":"Zona seleccionada")+" ("+[...zoneSel].join(", ")+")" : (LANG==="EN"?"Any":"CA"?"Qualsevol":"Cualquiera")) : last.req.muni);
    prefs.push(`${muniLabel} ¬∑ ${last.m2} m¬≤ ¬∑ ${last.bed} ${LANG==="EN"?"bd":"hab"} ¬∑ ${last.bath} ${LANG==="EN"?"ba":"ba√±os"}`);
    prefs.push((LANG==="EN"?"Type: ":"CA"?"Tipus: ":"Tipo: ")+(last.req.ptype==="flat"?(LANG==="EN"?"Flat":"CA"?"Pis":"Piso"):(LANG==="EN"?"House":"CA"?"Casa":"Casa"))+".");
    const ex=[];
    if(last.req.ex.t) ex.push(LANG==="EN"?"Terrace":"CA"?"Terrassa":"Terraza");
    if(last.req.ex.p) ex.push(LANG==="EN"?"Pool":"CA"?"Piscina":"Piscina");
    if(last.req.ex.l) ex.push(LANG==="EN"?"Elevator":"CA"?"Ascensor":"Ascensor");
    if(last.req.ex.k) ex.push(LANG==="EN"?"Parking":"CA"?"Aparcament":"Aparcamiento");
    prefs.push((LANG==="EN"?"Extras: ":"CA"?"Extres: ":"Extras: ")+(ex.length?ex.join(", "):(LANG==="EN"?"none":"CA"?"cap":"ninguno"))+".");
    prefs.push((LANG==="EN"?"Filter mode: ":"CA"?"Mode de filtres: ":"Modo filtros: ")+ (last.req.strict==="strict"?t("strict"):t("flex"))+".");
    $("#prefTitle").textContent=t("prefTitle");
    $("#prefText").textContent=prefs.join(" ");

    // Charts
    const safe = last.inc*0.35;
    const effC=$("#effCanvas");
    const sC=$("#sensCanvas");
    drawEffort(effC.getContext("2d"), effC.width, effC.height, safe, last.pay, last.pr);

    // sensitivity: +0.5% approx effect: recompute payment quickly
    const payAt=(rate)=> mort(last.cap, rate, last.yrs);
    const step = payAt(last.rate+0.005) - payAt(last.rate);
    drawSensitivity(sC.getContext("2d"), sC.width, sC.height, last.pay, step);

    // Report
    const report = [];
    report.push((LANG==="EN"?"Hi ":"CA"?"Hola ":"Hola ")+last.nm+".");
    report.push((LANG==="EN"?"Recommendation: ":"CA"?"Recomanaci√≥: ":"Recomendaci√≥n: ")+recLabel()+".");
    report.push((LANG==="EN"?"Estimated buy: ":"CA"?"Compra estimada: ":"Compra estimada: ")+fmt(last.pb)+ (last.list.length>1?` (${fmt(last.pbLo)}‚Äì${fmt(last.pbHi)})`:"") +".");
    report.push((LANG==="EN"?"Estimated rent: ":"CA"?"Lloguer estimat: ":"Alquiler estimado: ")+fmt(last.pr)+ (last.list.length>1?` (${fmt(last.prLo)}‚Äì${fmt(last.prHi)})`:"") +".");
    report.push((LANG==="EN"?"Mortgage payment: ":"CA"?"Quota hipoteca: ":"Cuota hipoteca: ")+fmt(last.pay)+` (${last.yrs}y @ ${(last.rate*100).toFixed(2)}%).`);
    report.push((LANG==="EN"?"Effort: ":"CA"?"Esfor√ß: ":"Esfuerzo: ")+`DTI ${pct(last.dti)} ¬∑ RTI ${pct(last.rti)}.`);
    report.push((LANG==="EN"?"Cash needed: ":"CA"?"Efectiu necessari: ":"Efectivo necesario: ")+fmt(last.needCash)+` (Down ${fmt(last.down)} + Costs ${fmt(last.close)}).`);
    report.push((LANG==="EN"?"Preferences: ":"CA"?"Prefer√®ncies: ":"Preferencias: ")+prefs[0]+` ¬∑ ${prefs[1]}`);
    $("#reportBox").value = report.join("\n");
  };

  // Copy/Whats
  $("#copyBtn").addEventListener("click",()=>{
    navigator.clipboard.writeText($("#reportBox").value||"").then(()=>toast(t("copied")));
  });
  $("#whatsBtn").addEventListener("click",()=>{
    const txt=$("#reportBox").value||"";
    if(!txt){toast(t("firstAnalyze"));return;}
    window.open("https://wa.me/?text="+encodeURIComponent(txt),"_blank","noopener");
  });
  $("#toExamplesBtn").addEventListener("click",()=>{
    if(!last){toast(t("firstAnalyze"));return;}
    goto("x");
  });

  // Reset
  $("#resetBtn").addEventListener("click",()=>{
    localStorage.removeItem(STORE);
    zoneSel.clear();
    localStorage.setItem(ZKEY,"[]");
    last=null; lastReq=null; lastSig="";
    $$("#app input").forEach(i=>{ if(i.type==="checkbox") i.checked=false; else i.value=""; i.classList.remove("ok","err"); });
    $$("#app select").forEach(s=>{ if(s.id==="hor") s.value="y"; if(s.id==="fst") s.value="y"; if(s.id==="strictMode") s.value="strict"; });
    inputs.muni.value="*"; inputs.ptype.value="flat";
    $("#resultPanel").style.display="none";
    $("#kPrice").textContent="0 ‚Ç¨"; $("#kRent").textContent="0 ‚Ç¨"; $("#kPay").textContent="0 ‚Ç¨"; $("#kRec").textContent="‚Äì";
    updateTabsEnabled();
    renderZoneUI();
    if(mapReady) refreshMapStyles();
    toast(t("zoneCleared"));
    goto("p");
  });

  // Map
  let map=null;
  let mapReady=false;
  const markers=new Map();
  const circles=new Map();

  const pinIcon=(on)=>{
    const c1 = on ? "#38bdf8" : "#fb7185";
    const c2 = on ? "#00f2fe" : "#ef4444";
    return L.divIcon({
      className:"",
      html:`
        <svg width="28" height="28" viewBox="0 0 24 24" style="filter:drop-shadow(0 10px 16px rgba(0,0,0,.35))">
          <defs>
            <linearGradient id="gpin" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="${c1}"/>
              <stop offset="1" stop-color="${c2}"/>
            </linearGradient>
          </defs>
          <path d="M12 22s7-4.4 7-12a7 7 0 1 0-14 0c0 7.6 7 12 7 12z" fill="url(#gpin)" stroke="rgba(0,0,0,.35)" stroke-width="1"/>
          <circle cx="12" cy="10" r="3.2" fill="rgba(2,6,23,.9)" stroke="rgba(255,255,255,.7)" stroke-width="1"/>
        </svg>`,
      iconSize:[28,28],
      iconAnchor:[14,28]
    });
  };

  const circleStyle=(on)=>({
    radius: on?2200:1900,
    color: on?"#38bdf8":"rgba(148,163,184,.40)",
    weight: on?2:1,
    opacity: on?.9:.55,
    fillColor: on?"#38bdf8":"#0ea5e9",
    fillOpacity: on?.14:.06
  });

  const renderZoneUI=()=>{
    const names=[...zoneSel];
    $("#selText").textContent = t("selPrefix") + (names.length? names.join(", ") : t("none"));

    const wrap=$("#selChips");
    wrap.innerHTML="";
    if(!names.length){
      const sp=document.createElement("span");
      sp.className="chip off";
      sp.textContent=t("none");
      wrap.appendChild(sp);
    } else {
      names.forEach(n=>{
        const c=document.createElement("span");
        c.className="chip on";
        c.textContent=n;
        c.addEventListener("click",()=>toggleTown(n,true));
        wrap.appendChild(c);
      });
    }
  };

  const toggleTown=(name,fromChip)=>{
    if(zoneSel.has(name)) zoneSel.delete(name); else zoneSel.add(name);
    if(mapReady){
      const m=markers.get(name);
      const c=circles.get(name);
      if(m) m.setIcon(pinIcon(zoneSel.has(name)));
      if(c){
        c.setStyle(circleStyle(zoneSel.has(name)));
        c.setRadius(circleStyle(zoneSel.has(name)).radius);
        if(zoneSel.has(name)) c.bringToFront();
      }
    }
    renderZoneUI();
    if(!fromChip) save();
  };

  const refreshMapStyles=()=>{
    towns.forEach(p=>{
      const on=zoneSel.has(p.name);
      const m=markers.get(p.name);
      const c=circles.get(p.name);
      if(m) m.setIcon(pinIcon(on));
      if(c){
        c.setStyle(circleStyle(on));
        c.setRadius(circleStyle(on).radius);
        if(on) c.bringToFront();
      }
    });
  };

  const initMap=()=>{
    if(mapReady) return;
    mapReady=true;

    map=L.map("map",{scrollWheelZoom:false,tap:true}).setView([41.235,1.58],11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(map);

    const bounds=[];
    towns.forEach(p=>{
      bounds.push([p.lat,p.lng]);

      const c=L.circle([p.lat,p.lng], circleStyle(zoneSel.has(p.name))).addTo(map);
      c.on("click",()=>toggleTown(p.name,false));
      circles.set(p.name,c);

      const m=L.marker([p.lat,p.lng],{icon:pinIcon(zoneSel.has(p.name)),title:p.name,riseOnHover:true}).addTo(map);
      m.bindTooltip(p.name,{direction:"top",opacity:.95});
      m.on("click",()=>toggleTown(p.name,false));
      markers.set(p.name,m);
    });
    try{map.fitBounds(bounds,{padding:[30,30]});}catch(e){}
    setTimeout(()=>map.invalidateSize(),120);
    renderZoneUI();
  };

  $("#toggleMapBtn").addEventListener("click",()=>{
    const w=$("#mapWrap");
    const open = w.style.display==="block";
    w.style.display = open ? "none" : "block";
    if(!open){
      initMap();
      setTimeout(()=>map && map.invalidateSize(), 140);
    }
  });

  $("#clearZone").addEventListener("click",()=>{
    zoneSel.clear();
    save();
    renderZoneUI();
    if(mapReady) refreshMapStyles();
    toast(t("zoneCleared"));
  });

  $("#applyZone").addEventListener("click",()=>{
    // set muni option to '*' so estimation uses zoneSel if available
    inputs.muni.value="*";
    save();
    toast(t("zoneApplied"));
  });

  // Examples real
  const idealistaBase="https://www.idealista.com";
  const bedSlug=(n)=>{
    n=+n||0;
    if(n<=0) return "estudios";
    if(n===1) return "de-un-dormitorio";
    if(n===2) return "de-dos-dormitorios";
    if(n===3) return "de-tres-dormitorios";
    return "de-cuatro-cinco-habitaciones-o-mas";
  };
  const bathSlug=(n)=>{
    n=+n||1;
    if(n<=1) return "un-bano";
    if(n===2) return "dos-banos";
    return "tres-banos-o-mas";
  };
  const m2Slugs=(m2)=>{
    m2=+m2||0; if(!(m2>0)) return [];
    const min=Math.max(0, Math.floor((m2-20)/10)*10);
    const max=Math.ceil((m2+20)/10)*10;
    return [`metros-cuadrados-mas-de_${min}`, `metros-cuadrados-menos-de_${max}`];
  };

  const buildUrl=(mode, strict, townName)=>{
    const req = lastReq || getReq();
    const ex=req.ex;
    const area = townName ? SLUG[townName] : (req.muni==="*" ? "tarragona/baix-penedes" : SLUG[req.muni]);
    if(!area) return null;
    const op = mode==="buy" ? "venta-viviendas" : "alquiler-viviendas";

    const f=[];
    f.push(...m2Slugs(req.m2));
    f.push(req.ptype==="flat" ? "pisos" : "chalets");
    f.push(bedSlug(req.bed));
    f.push(bathSlug(req.bath));

    if(strict){
      if(ex.t) f.push("terraza");
      if(ex.p) f.push("piscina");
      if(ex.l) f.push("ascensor");
      if(ex.k) f.push("garaje");
    }

    const joined=f.filter(Boolean).join("%2C");
    return `${idealistaBase}/${op}/${area}/con-${joined}/`;
  };

  const openUrl=(mode,strict,townName)=>{
    if(!last){toast(t("firstAnalyze"));return;}
    if(prefsChanged()){toast(t("changed"));return;}
    const url=buildUrl(mode,strict,townName);
    if(!url){toast("No link");return;}
    window.open(url,"_blank","noopener");
  };

  const renderExamples=()=>{
    const info=$("#xInfo");
    const btns=$("#xBtns"); btns.innerHTML="";

    const ok = !!last && !prefsChanged();
    const state = ok ? t("stateReady") : t("stateNeed");
    const muniTxt = (inputs.muni.value==="*" ? (zoneSel.size? [...zoneSel].join(", ") : (LANG==="EN"?"Any":"CA"?"Qualsevol":"Cualquiera")) : inputs.muni.value);
    info.textContent = `${(LANG==="EN"?"Town / area":"CA"?"Municipi / zona":"Municipio / zona")}: ${muniTxt} ¬∑ ${state}`;

    const addBtn=(label,fn)=>{
      const b=document.createElement("button");
      b.type="button";
      b.className="btn good";
      b.textContent=label;
      if(!ok) b.classList.add("dis");
      b.addEventListener("click",fn);
      btns.appendChild(b);
    };

    const townsList = zoneSel.size ? [...zoneSel].filter(x=>SLUG[x]) : [];
    const many = townsList.length>0;

    const buy=t("buy"), rent=t("rent"), strict=t("strict"), flex=t("flex");

    if(many){
      townsList.forEach(tw=>{
        addBtn(`${buy} (${strict}) ¬∑ ${tw}`,()=>openUrl("buy",true,tw));
        addBtn(`${buy} (${flex}) ¬∑ ${tw}`,()=>openUrl("buy",false,tw));
        addBtn(`${rent} (${strict}) ¬∑ ${tw}`,()=>openUrl("rent",true,tw));
        addBtn(`${rent} (${flex}) ¬∑ ${tw}`,()=>openUrl("rent",false,tw));
      });
    } else {
      addBtn(`${buy} (${strict})`,()=>openUrl("buy",true,null));
      addBtn(`${buy} (${flex})`,()=>openUrl("buy",false,null));
      addBtn(`${rent} (${strict})`,()=>openUrl("rent",true,null));
      addBtn(`${rent} (${flex})`,()=>openUrl("rent",false,null));
    }
  };

  // Comparator
  let cmpInit=false;
  const initCmpCanvas=()=>{ cmpInit=true; };

  $("#cmpUseMine").addEventListener("click",()=>{
    if(!last){toast(t("firstAnalyze"));return;}
    inputs.cmpM2.value=last.m2;
    inputs.cmpBed.value=last.bed;
    inputs.cmpBath.value=last.bath;
    inputs.cmpType.value=last.req.ptype;
    inputs.cT.checked=!!last.req.ex.t;
    inputs.cP.checked=!!last.req.ex.p;
    inputs.cL.checked=!!last.req.ex.l;
    inputs.cK.checked=!!last.req.ex.k;
    save();
  });

  $("#cmpRun").addEventListener("click",()=>{
    if(!last){toast(t("firstAnalyze"));return;}
    const prov=inputs.cmpProv.value;
    const m2=+inputs.cmpM2.value||0;
    const bed=+inputs.cmpBed.value||0;
    const bath=+inputs.cmpBath.value||0;
    if(m2<50||bath<1){showModal([LANG==="EN"?"Comparator: m¬≤>=50 and bathrooms>=1.":LANG==="CA"?"Comparador: m¬≤>=50 i banys>=1.":"Comparador: m¬≤>=50 y ba√±os>=1."]);return;}

    const ex={t:inputs.cT.checked,p:inputs.cP.checked,l:inputs.cL.checked,k:inputs.cK.checked};
    const pb=provinceBuy(prov,m2,bed,bath,ex);
    const pr=provinceRent(prov,m2,bed,bath,ex);

    const diff = pb - last.pb;
    const dir = diff>0 ? (LANG==="EN"?"more expensive":LANG==="CA"?"m√©s car":"m√°s caro") :
               diff<0 ? (LANG==="EN"?"cheaper":LANG==="CA"?"m√©s barat":"m√°s barato") :
               (LANG==="EN"?"similar":LANG==="CA"?"similar":"similar");

    $("#cmpOut").style.display="block";
    $("#cmpTitle").textContent = t("cmpTitle");
    $("#cmpText").textContent =
      `${prov}: ${fmt(pb)} (${dir} por ${fmt(Math.abs(diff))}). `+
      `${LANG==="EN"?"Estimated rent":"CA"?"Lloguer estimat":"Alquiler estimado"}: ${fmt(pr)}.`;

    const c=$("#cmpCanvas");
    drawComparator(c.getContext("2d"), c.width, c.height, last.pb, pb);
    save();
  });

  // Buttons to nav from result
  $("#backF").addEventListener("click",()=>goto("f"));
  $("#backR").addEventListener("click",()=>goto("r"));
  $("#backC").addEventListener("click",()=>goto("c"));

  // Live save + simple live hints
  $$("#app input, #app select, #app textarea").forEach(el=>{
    el.addEventListener("input", save);
    el.addEventListener("change", save);
  });

  // Toggle map in preferences already
  // Prefs change should warn for examples
  $$("#muni,#ptype,#m2,#bed,#bath,#exT,#exP,#exL,#exK,#strictMode").forEach(sel=>{
    $(sel).addEventListener("change", ()=>{
      renderExamples();
    });
  });

  // Load + init
  load();
  // Tab state
  updateTabsEnabled();
  // Set language
  applyLang();
  // Start
  goto("p");
})();
</script>
</body>
</html>
