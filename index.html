padT-padB;

    const y0=padT+plotH;
    const safeLine=plotH*(1-safe/maxV);

    ctx.strokeStyle="rgba(245,158,11,.8)";
    ctx.lineWidth=2;
    ctx.setLineDash([6,4]);
    ctx.beginPath();
    ctx.moveTo(padL,padT+safeLine);
    ctx.lineTo(w-padR,padT+safeLine);
    ctx.stroke();
    ctx.setLineDash([]);

    const barW=Math.min(60,plotW/5);
    const x1=padL+plotW*0.25-barW/2;
    const x2=padL+plotW*0.75-barW/2;

    const h1=plotH*(buyV/maxV);
    const h2=plotH*(rentV/maxV);

    const g1=ctx.createLinearGradient(0,y0-h1,0,y0);
    g1.addColorStop(0,"#3b82f6");
    g1.addColorStop(1,"#1d4ed8");
    ctx.fillStyle=g1;
    ctx.fillRect(x1,y0-h1,barW,h1);

    const g2=ctx.createLinearGradient(0,y0-h2,0,y0);
    g2.addColorStop(0,"#22c55e");
    g2.addColorStop(1,"#15803d");
    ctx.fillStyle=g2;
    ctx.fillRect(x2,y0-h2,barW,h2);

    drawText(ctx,"Hipoteca",x1+barW/2,y0+18,11,"#94a3b8","center");
    drawText(ctx,"Alquiler",x2+barW/2,y0+18,11,"#94a3b8","center");
    drawText(ctx,fmtMoney(buyV),x1+barW/2,y0-h1-6,10,"#dbeafe","center");
    drawText(ctx,fmtMoney(rentV),x2+barW/2,y0-h2-6,10,"#86efac","center");
    drawText(ctx,"35%: "+fmtMoney(safe),w-padR-4,padT+safeLine-6,10,"#fde68a","right");
  };

  const drawSensChart=()=>{
    if(!last) return;
    const cv=Q("#sensChart");
    if(!cv) return;
    const ctx=setupCanvas(cv);
    const w=cv.clientWidth,h=cv.clientHeight;
    clear(ctx,w,h);

    const rates=[last.rate,last.rate+0.005,last.rate+0.01,last.rate+0.015,last.rate+0.02];
    const pays=rates.map(r=>mort(last.cap,r,last.yrs));
    const maxP=Math.max(...pays)*1.1||1;

    const padL=12,padR=12,padT=18,padB=26;
    const plotW=w-padL-padR,plotH=h-padT-padB;
    const y0=padT+plotH;
    const stepX=plotW/(rates.length-1);

    ctx.strokeStyle="rgba(56,189,248,.85)";
    ctx.lineWidth=2.5;
    ctx.beginPath();
    pays.forEach((p,i)=>{
      const x=padL+i*stepX;
      const y=y0-plotH*(p/maxP);
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    });
    ctx.stroke();

    pays.forEach((p,i)=>{
      const x=padL+i*stepX;
      const y=y0-plotH*(p/maxP);
      ctx.fillStyle=(i===0?"#38bdf8":"rgba(56,189,248,.65)");
      ctx.beginPath();
      ctx.arc(x,y,4,0,Math.PI*2);
      ctx.fill();
      drawText(ctx,((rates[i]*100).toFixed(2)+"%"),x,y0+14,9,"#94a3b8","center");
      if(i===0||i===rates.length-1){
        drawText(ctx,fmtMoney(p),x,y-10,9,"#dbeafe","center");
      }
    });
  };

  const drawCmpChart=()=>{
    const cv=Q("#cmpChart");
    if(!cv) return;
    const ctx=setupCanvas(cv);
    const w=cv.clientWidth,h=cv.clientHeight;
    clear(ctx,w,h);

    if(!last||!last.cmpBuy||!last.cmpRent) return;
    const buyU=last.pb,buyC=last.cmpBuy;
    const rentU=last.pr,rentC=last.cmpRent;
    const maxV=Math.max(buyU,buyC,rentU,rentC)*1.12||1;

    const padL=12,padR=12,padT=18,padB=30;
    const plotW=w-padL-padR,plotH=h-padT-padB;
    const y0=padT+plotH;
    const barW=Math.min(55,plotW/8);

    const x1=padL+plotW*0.25-barW;
    const x2=padL+plotW*0.25;
    const x3=padL+plotW*0.75-barW;
    const x4=padL+plotW*0.75;

    const h1=plotH*(buyU/maxV);
    const h2=plotH*(buyC/maxV);
    const h3=plotH*(rentU/maxV);
    const h4=plotH*(rentC/maxV);

    const g1=ctx.createLinearGradient(0,y0-h1,0,y0);
    g1.addColorStop(0,"#3b82f6");
    g1.addColorStop(1,"#1d4ed8");
    ctx.fillStyle=g1;
    ctx.fillRect(x1,y0-h1,barW,h1);

    const g2=ctx.createLinearGradient(0,y0-h2,0,y0);
    g2.addColorStop(0,"#8b5cf6");
    g2.addColorStop(1,"#6d28d9");
    ctx.fillStyle=g2;
    ctx.fillRect(x2,y0-h2,barW,h2);

    const g3=ctx.createLinearGradient(0,y0-h3,0,y0);
    g3.addColorStop(0,"#22c55e");
    g3.addColorStop(1,"#15803d");
    ctx.fillStyle=g3;
    ctx.fillRect(x3,y0-h3,barW,h3);

    const g4=ctx.createLinearGradient(0,y0-h4,0,y0);
    g4.addColorStop(0,"#f59e0b");
    g4.addColorStop(1,"#d97706");
    ctx.fillStyle=g4;
    ctx.fillRect(x4,y0-h4,barW,h4);

    drawText(ctx,"Compra Tu",x1+barW/2,y0+16,9,"#94a3b8","center");
    drawText(ctx,"Compra Prov",x2+barW/2,y0+16,9,"#94a3b8","center");
    drawText(ctx,"Alq Tu",x3+barW/2,y0+16,9,"#94a3b8","center");
    drawText(ctx,"Alq Prov",x4+barW/2,y0+16,9,"#94a3b8","center");
  };

  const analyze=()=>{
    const nm=(Q("#nm").value||"").trim(),ag=+Q("#ag").value||0;
    const inc=+Q("#inc").value||0,sav=+Q("#sav").value||0,yrs=+Q("#yrs").value||25;
    const msv=+Q("#msv").value||0;
    const ar=Q("#ar").value,m2=+Q("#m2").value||0,bd=(Q("#bed").value===""?0:+Q("#bed").value)||0,ba=+Q("#bat").value||0;
    const ty=Q("#ty").value;

    if(!nm||ag<18||ag>100||m2<50||ba<1){toast(t("toastCheckNameAge"));return}

    const e={
      t:Q("#et").checked,p:Q("#ep").checked,l:Q("#el").checked,k:Q("#ek").checked,
      s:Q("#es").checked,j:Q("#ej").checked,a:Q("#ea").checked
    };

    let pb,munis=[];
    if((ar==="*"||ar==="__multi__")&&zoneSel.size>1){
      munis=[...zoneSel];
      pb=Math.round(munis.map(m=>buy(m,m2,bd,ba,e)).reduce((a,b)=>a+b,0)/munis.length);
    }else{
      const baseM=(ar==="__multi__"&&zoneSel.size===1)?[...zoneSel][0]:(ar==="*"?"Cunit":ar);
      munis=[baseM];
      pb=buy(baseM,m2,bd,ba,e);
    }

    let pr=0;
    if(munis.length>1){
      pr=Math.round(munis.map(m=>rent(m,m2,bd,ba,e)).reduce((a,b)=>a+b,0)/munis.length);
    }else{
      pr=rent(munis[0],m2,bd,ba,e);
    }

    const dp=Q("#fst").value==="y"?0.1:0.2;
    const down=pb*dp,cl=pb*BASE.close;
    const needCash=Math.round(down+cl);
    let cap=Math.max(0,pb-down);
    let rate=BASE.rate;
    if(sav<needCash) rate+=0.006;

    const pay=mort(cap,rate,yrs);
    const ratioM=inc>0?(pay/inc)*100:999;
    const ratioR=inc>0?(pr/inc)*100:999;
    const need=sav<needCash;
    const ratioOK=ratioM<=35;
    const hor=Q("#hor").value==="y";

    let recCode=(!need&&ratioOK&&hor)?"BUY":"RENT";
    let rec=t(recCode==="BUY"?"recBuy":"recRent");

    last={nm,m2,bd,ba,pb,cap,rate,yrs,down,cl,pay,ratioM,ratioR,rec,recCode,needCash,inc,sav,msv,pr,dp,munis,ty};
    lastReq={ar,m2,bd,ba,e};
    lastReqSig=sigOfReq(lastReq);

    setTabsEnabled();
    renderResult();
    drawEffortChart();
    drawSensChart();
    show("r");
    saveForm();
  };

  const renderResult=()=>{
    if(!last) return;
    Q("#k1").textContent=fmtMoney(last.pb);
    Q("#k2").textContent=fmtMoney(last.pr);
    Q("#k3").textContent=fmtMoney(last.pay);
    Q("#k4").textContent=last.rec;

    Q("#k1sub").textContent=last.m2>0?(Math.round(last.pb/last.m2).toLocaleString()+" €/m²"):"";
    Q("#k2sub").textContent=last.m2>0?(Math.round(last.pr/last.m2).toLocaleString()+" €/m²"):"";
    Q("#k3sub").textContent=`${last.yrs} ${LANG==="EN"?"years":"años"} · ${(last.rate*100).toFixed(2)}%`;
    Q("#k4sub").textContent=last.recCode==="BUY"?(LANG==="EN"?"Cash+effort ok":"Encajas cash+esfuerzo"):(LANG==="EN"?"Rent safer now":"Aprieta; alquilar más seguro");

    Q("#rCard").style.display="block";
    Q("#rTitle").textContent=tpl(t("sumTitle"),{rec:last.rec});

    let chips="";
    chips+=`<span class="chip ${last.ratioM<=30?"good":last.ratioM<=35?"warn":"bad"}">${tpl(t("chipMort"),{pct:fmtPct(last.ratioM)})}</span>`;
    chips+=`<span class="chip ${last.ratioR<=30?"good":last.ratioR<=35?"warn":"bad"}">${tpl(t("chipRent"),{pct:fmtPct(last.ratioR)})}</span>`;
    chips+=`<span class="chip ${last.sav>=last.needCash?"good":"bad"}">${tpl(t("chipCash"),{eur:fmtMoney(last.needCash)})}</span>`;
    chips+=`<span class="chip neu">${tpl(t("chipRate"),{rate:(last.rate*100).toFixed(2)+"%"})}</span>`;
    Q("#rChips").innerHTML=chips;

    let miniHtml="";
    miniHtml+=`<div class="mini"><div class="h">${t("miniPrice")}</div><div class="v">${fmtMoney(last.pb)}</div></div>`;
    miniHtml+=`<div class="mini"><div class="h">${t("miniPay")}</div><div class="v">${fmtMoney(last.pay)}</div></div>`;
    miniHtml+=`<div class="mini"><div class="h">${t("miniRent")}</div><div class="v">${fmtMoney(last.pr)}</div></div>`;
    Q("#rMini").innerHTML=miniHtml;

    const why=last.recCode==="BUY"?
      (LANG==="EN"?
        ["Your savings cover down payment + costs","Mortgage effort is reasonable","Living > 5 years helps"]:
        ["Tus ahorros cubren entrada+costes","Esfuerzo hipoteca razonable","Horizonte >5 años ayuda"]):
      (LANG==="EN"?
        ["Cash short or effort too high","Renting is safer now"]:
        ["Te falta cash o esfuerzo muy alto","Alquilar más seguro ahora"]);

    Q("#rBody").innerHTML=`<div style="padding:12px;background:rgba(56,189,248,.08);border-radius:12px;margin-top:12px">${why.map(x=>`<div>• ${x}</div>`).join("")}</div>`;

    const muniTxt=last.munis.length>1?tpl(t("avgZone"),{n:last.munis.length}):last.munis[0];

    let report="";
    report+=tpl(t("reportHello"),{name:last.nm})+"\n";
    report+=tpl(t("reportPrice"),{eur:fmtMoney(last.pb)})+"\n";
    report+=tpl(t("reportHome"),{muni:muniTxt,m2:last.m2,bed:last.bd,bath:last.ba,type:typeLabel(last.ty)})+"\n";
    report+=tpl(t("reportDown"),{dp:(last.dp*100).toFixed(0),down:fmtMoney(last.down),cl:fmtMoney(last.cl)})+"\n";
    report+=tpl(t("reportFin"),{cap:fmtMoney(last.cap),yrs:last.yrs,rate:(last.rate*100).toFixed(2)+"%"})+"\n";
    report+=tpl(t("reportPay"),{pay:fmtMoney(last.pay),rent:fmtMoney(last.pr)})+"\n";
    report+=tpl(t("reportRec"),{rec:last.rec})+"\n";
    Q("#rt").textContent=report;

    let tips="";
    if(last.sav>=last.needCash){
      tips+="• "+t("savingsOk")+"\n";
    }else if(last.msv>0){
      const mo=Math.ceil((last.needCash-last.sav)/last.msv);
      const yr=(mo/12).toFixed(1);
      tips+="• "+tpl(t("yearsToSave"),{msv:fmtMoney(last.msv),yrs:yr,mos:mo})+"\n";
    }
    tips+="\n• "+t("itpNote");
    Q("#chartTips").textContent=tips;

    let qe="";
    if(last.recCode==="BUY"){
      qe=LANG==="EN"?
        "You fit the profile: cash is covered, effort is manageable, and you plan to stay > 5 years. Buying makes sense in your context.":
        "Encajas el perfil: cash cubierto, esfuerzo razonable, horizonte >5 años. Comprar tiene sentido en tu contexto.";
    }else{
      qe=LANG==="EN"?
        "Either cash is short or effort is too high. Renting is the safer route now. Focus on saving or improving income.":
        "O te falta cash o el esfuerzo es muy alto. Alquilar es lo más seguro ahora. Céntrate en ahorrar o mejorar ingresos.";
    }
    Q("#quickExplain").textContent=qe;

    setTimeout(()=>{drawEffortChart();drawSensChart();},100);
  };

  let zoneSel=new Set(), zmap=null, cmap=null, polygonsByName=new Map();

  const loadZone=()=>{try{const s=localStorage.getItem(ZONE_KEY);if(s){zoneSel=new Set(JSON.parse(s));}}catch(e){}};
  const saveZone=()=>{localStorage.setItem(ZONE_KEY,JSON.stringify([...zoneSel]))};

  const renderZoneUI=()=>{
    const sel=zoneSel.size?[...zoneSel].join(", "):(LANG==="EN"?"none":LANG==="CA"?"cap":"ninguno");
    Q("#zoneNote").textContent=(LANG==="EN"?"Selected: ":LANG==="CA"?"Seleccionats: ":"Seleccionados: ")+sel;
    Q("#zoneApplied").textContent=zoneSel.size?((LANG==="EN"?"Active towns: ":LANG==="CA"?"Municipis actius: ":"Municipios activos: ")+[...zoneSel].join(", ")):"";
    if(zoneSel.size){
      Q("#zoneChips").innerHTML=[...zoneSel].map(z=>`<span class="pchip on" data-z="${z}">${z}</span>`).join("");
    }else{
      Q("#zoneChips").innerHTML=`<span class="pchip off">${LANG==="EN"?"No selection":LANG==="CA"?"Sense selecció":"Sin selección"}</span>`;
    }
    QA("[data-z]").forEach(ch=>{
      ch.onclick=()=>toggleZone(ch.getAttribute("data-z"),true);
    });
  };

  const applyPolygonState=(name)=>{
    const poly=polygonsByName.get(name); if(!poly) return;
    const on=zoneSel.has(name);
    poly.setStyle({
      fillColor:on?"#38bdf8":"#22c55e",
      fillOpacity:on?0.35:0.15,
      color:on?"#38bdf8":"#22c55e",
      weight:on?3:1.5,
      opacity:on?0.9:0.5
    });
  };

  const toggleZone=(name,fromChip)=>{
    zoneSel.has(name)?zoneSel.delete(name):zoneSel.add(name);
    applyPolygonState(name);
    renderZoneUI();
    if(!fromChip) saveZone();
  };

  const initMap=()=>{
    if(zmap) return;
    zmap=L.map("zmap",{scrollWheelZoom:false}).setView([41.235,1.595],11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© OSM'}).addTo(zmap);

    Object.keys(MUNICIPALITY_POLYGONS).forEach(name=>{
      const coords=MUNICIPALITY_POLYGONS[name];
      const poly=L.polygon(coords,{
        fillColor:zoneSel.has(name)?"#38bdf8":"#22c55e",
        fillOpacity:zoneSel.has(name)?0.35:0.15,
        color:zoneSel.has(name)?"#38bdf8":"#22c55e",
        weight:zoneSel.has(name)?3:1.5,
        opacity:zoneSel.has(name)?0.9:0.5
      }).addTo(zmap);
      poly.bindTooltip(name,{permanent:false,direction:"center"});
      poly.on("click",()=>toggleZone(name,false));
      polygonsByName.set(name,poly);
    });

    setTimeout(()=>zmap.invalidateSize(),200);
    renderZoneUI();
  };

  const upMap=()=>{
    if(!cmap){
      cmap=L.map("cmap",{scrollWheelZoom:false}).setView([41.59,1.52],8);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'© OSM'}).addTo(cmap);
    }
    setTimeout(()=>cmap.invalidateSize(),100);
  };

  const doCompare=()=>{
    const prov=Q("#cm").value,m2=+Q("#cm2").value||0,bd=+Q("#cbd").value||0,ba=+Q("#cba").value||0;
    if(!prov||m2<50||ba<1){toast(t("missingDataCmp"));return}

    const e={
      t:Q("#ct").checked,p:Q("#cp0").checked,l:Q("#cl0").checked,k:Q("#ck0").checked,
      s:Q("#cs0").checked,j:Q("#cj0").checked,a:Q("#ca0").checked
    };

    const bM=buyM(prov,m2,bd,ba,e);
    const rM=rentM(prov,m2,bd,ba,e);

    if(!last){toast(t("toastFirstAnalyze"));return}

    last.cmpBuy=bM;
    last.cmpRent=rM;
    last.cmpProv=prov;

    const diffB=bM-last.pb,pctB=(diffB/last.pb)*100;
    const diffR=rM-last.pr,pctR=(diffR/last.pr)*100;

    let cmpChips="";
    cmpChips+=`<span class="chip ${diffB<0?"good":diffB===0?"neu":"bad"}">${LANG==="EN"?"Buy":LANG==="CA"?"Compra":"Compra"}: ${fmtPct(pctB)}</span>`;
    cmpChips+=`<span class="chip ${diffR<0?"good":diffR===0?"neu":"bad"}">${LANG==="EN"?"Rent":LANG==="CA"?"Lloguer":"Alquiler"}: ${fmtPct(pctR)}</span>`;
    Q("#cmpChips").innerHTML=cmpChips;

    const cmpTextB=diffB<0?t("cmpCheaper"):(diffB===0?t("cmpSame"):t("cmpExpensive"));
    const cmpTextR=diffR<0?t("cmpCheaper"):(diffR===0?t("cmpSame"):t("cmpExpensive"));

    let msg="";
    msg+=`${LANG==="EN"?"Your area":LANG==="CA"?"La teva zona":"Tu zona"}: ${fmtMoney(last.pb)} (${LANG==="EN"?"buy":LANG==="CA"?"compra":"compra"}) · ${fmtMoney(last.pr)} (${LANG==="EN"?"rent":LANG==="CA"?"lloguer":"alquiler"}).\n`;
    msg+=`${prov}: ${fmtMoney(bM)} (${LANG==="EN"?"buy":LANG==="CA"?"compra":"compra"}) · ${fmtMoney(rM)} (${LANG==="EN"?"rent":LANG==="CA"?"lloguer":"alquiler"}).\n`;
    msg+=`\n${prov} ${LANG==="EN"?"is":LANG==="CA"?"és":"es"} ${cmpTextB} ${LANG==="EN"?"for buying":LANG==="CA"?"per comprar":"para comprar"} (${fmtPct(Math.abs(pctB))}).\n`;
    msg+=`${prov} ${LANG==="EN"?"is":LANG==="CA"?"és":"es"} ${cmpTextR} ${LANG==="EN"?"for renting":LANG==="CA"?"per llogar":"para alquilar"} (${fmtPct(Math.abs(pctR))}).\n`;
    msg+=`\n<b>${t("cmpExplTitle")}</b>\n`;
    msg+=`• ${t("cmpExpl1")}\n`;
    msg+=`• ${t("cmpExpl2")}\n`;
    msg+=`• ${t("cmpExpl3")}\n`;
    Q("#cmg").innerHTML=msg.replace(/\n/g,"<br>");

    drawCmpChart();
  };

  const refreshExamplesUI=()=>{
    const hasReq=!!lastReq;
    const changed=prefsChangedSinceAnalyze();
    const st=hasReq&&!changed?t("stateReady"):t("stateNeedAnalyze");
    const m=lastReq?muniLabel(lastReq.muni):t("any");
    Q("#xinfo").innerHTML=tpl(t("xInfo"),{muni:m,state:st});

    if(!hasReq||changed){Q("#xbtns").innerHTML="";return}

    const makeBuySlug=(a,m2,bed,bath,ty,ex)=>{
      let s=`https://www.idealista.com/venta-viviendas/${a.toLowerCase().replace(/\s+/g,"-").replace(/[àá]/g,"a").replace(/[èé]/g,"e").replace(/[íï]/g,"i").replace(/[òó]/g,"o").replace(/[çc]/g,"c")}/`;
      let q=[];
      if(m2>=50){
        const loM2=Math.max(50,m2-15),hiM2=m2+25;
        q.push(`superficie-de-${loM2}-a-${hiM2}-metros-cuadrados`);
      }
      if(bed>=1) q.push(`con-${bed}-dormitorios`);
      if(bath>=1) q.push(`con-${bath}-banos`);
      if(ty==="flat") q.push(`pisos`);
      else if(ty==="house") q.push(`casas`);
      if(ex.t) q.push(`con-terraza`);
      if(ex.p) q.push(`con-piscina`);
      if(ex.l) q.push(`con-ascensor`);
      if(ex.k) q.push(`con-garaje`);
      if(ex.s) q.push(`con-trastero`);
      if(ex.j) q.push(`con-jardin`);
      if(ex.a) q.push(`con-aire-acondicionado`);
      return s+(q.length?q.join("/")+"/":" ");
    };

    const makeRentSlug=(a,m2,bed,bath,ty,ex)=>{
      let s=`https://www.idealista.com/alquiler-viviendas/${a.toLowerCase().replace(/\s+/g,"-").replace(/[àá]/g,"a").replace(/[èé]/g,"e").replace(/[íï]/g,"i").replace(/[òó]/g,"o").replace(/[çc]/g,"c")}/`;
      let q=[];
      if(m2>=50){
        const loM2=Math.max(50,m2-15),hiM2=m2+25;
        q.push(`superficie-de-${loM2}-a-${hiM2}-metros-cuadrados`);
      }
      if(bed>=1) q.push(`con-${bed}-dormitorios`);
      if(bath>=1) q.push(`con-${bath}-banos`);
      if(ty==="flat") q.push(`pisos`);
      else if(ty==="house") q.push(`casas`);
      if(ex.t) q.push(`con-terraza`);
      if(ex.p) q.push(`con-piscina`);
      if(ex.l) q.push(`con-ascensor`);
      if(ex.k) q.push(`con-garaje`);
      if(ex.s) q.push(`con-trastero`);
      if(ex.j) q.push(`con-jardin`);
      if(ex.a) q.push(`con-aire-acondicionado`);
      return s+(q.length?q.join("/")+"/":" ");
    };

    const muniList=(lastReq.muni==="__multi__"&&zoneSel.size>1)?[...zoneSel]:(lastReq.muni==="*"?["Cunit"]:[lastReq.muni]);

    let btnsHtml="";
    muniList.forEach(mu=>{
      const buyLink=makeBuySlug(mu,lastReq.m2,lastReq.bed,lastReq.bath,lastReq.type,lastReq.ex);
      const rentLink=makeRentSlug(mu,lastReq.m2,lastReq.bed,lastReq.bath,lastReq.type,lastReq.ex);
      btnsHtml+=`<button class="b" onclick="window.open('${buyLink}','_blank')">${LANG==="EN"?"Buy":LANG==="CA"?"Compra":"Compra"} · ${mu}</button>`;
      btnsHtml+=`<button class="b ok" onclick="window.open('${rentLink}','_blank')">${LANG==="EN"?"Rent":LANG==="CA"?"Lloguer":"Alquiler"} · ${mu}</button>`;
    });

    Q("#xbtns").innerHTML=btnsHtml;
  };

  const liveValidate=()=>{
    const inc=+Q("#inc").value||0,sav=+Q("#sav").value||0,m2=+Q("#m2").value||0;
    const hInc=Q("#hint-inc"),hSav=Q("#hint-sav"),hM2=Q("#hint-m2");
    const iInc=Q("#inc"),iSav=Q("#sav"),iM2=Q("#m2");

    if(inc>0){
      if(inc<800){iInc.classList.add("field-err");iInc.classList.remove("field-ok");hInc.textContent=(LANG==="EN"?"Low income":LANG==="CA"?"Ingressos baixos":"Ingresos bajos");hInc.className="field-hint err";}
      else if(inc<1200){iInc.classList.add("field-ok");iInc.classList.remove("field-err");hInc.textContent=(LANG==="EN"?"Tight but doable":LANG==="CA"?"Just però factible":"Justo pero factible");hInc.className="field-hint ok";}
      else{iInc.classList.add("field-ok");iInc.classList.remove("field-err");hInc.textContent=(LANG==="EN"?"Good income":LANG==="CA"?"Bons ingressos":"Buenos ingresos");hInc.className="field-hint ok";}
    }else{iInc.classList.remove("field-ok","field-err");hInc.textContent=t("validateIncome");hInc.className="field-hint";}

    if(sav>0){
      if(sav<15000){iSav.classList.add("field-err");iSav.classList.remove("field-ok");hSav.textContent=(LANG==="EN"?"Low savings":LANG==="CA"?"Estalvis baixos":"Ahorros bajos");hSav.className="field-hint err";}
      else if(sav<30000){iSav.classList.add("field-ok");iSav.classList.remove("field-err");hSav.textContent=(LANG==="EN"?"Decent savings":LANG==="CA"?"Estalvis decents":"Ahorros decentes");hSav.className="field-hint ok";}
      else{iSav.classList.add("field-ok");iSav.classList.remove("field-err");hSav.textContent=(LANG==="EN"?"Good savings":LANG==="CA"?"Bons estalvis":"Buenos ahorros");hSav.className="field-hint ok";}
    }else{iSav.classList.remove("field-ok","field-err");hSav.textContent=t("validateSavings");hSav.className="field-hint";}

    if(m2>0){
      if(m2<50){iM2.classList.add("field-err");iM2.classList.remove("field-ok");hM2.textContent=t("validateM2");hM2.className="field-hint err";}
      else if(m2<70){iM2.classList.add("field-ok");iM2.classList.remove("field-err");hM2.textContent=(LANG==="EN"?"Small but ok":LANG==="CA"?"Petit però ok":"Pequeño pero ok");hM2.className="field-hint ok";}
      else{iM2.classList.add("field-ok");iM2.classList.remove("field-err");hM2.textContent=(LANG==="EN"?"Good size":LANG==="CA"?"Bona mida":"Buen tamaño");hM2.className="field-hint ok";}
    }else{iM2.classList.remove("field-ok","field-err");hM2.textContent="";hM2.className="field-hint";}
  };

  let chatHistory=[], isAIProcessing=false;

  const loadChatHistory=()=>{
    try{
      const s=localStorage.getItem(CHAT_KEY);
      if(s){
        chatHistory=JSON.parse(s);
        chatHistory.forEach(m=>{
          if(m.role==="user"||m.role==="assistant"){
            addMessageToChat(m.role==="user"?"user":"ai",m.content);
          }
        });
      }
    }catch(e){}
  };

  const saveChatHistory=()=>{
    localStorage.setItem(CHAT_KEY,JSON.stringify(chatHistory));
  };

  const getUserContext=()=>{
    if(!last) return "El usuario no ha completado el análisis aún.";
    const muniTxt=last.munis.length>1?`${last.munis.length} municipios (${last.munis.join(", ")})`:last.munis[0];
    return `Usuario: ${last.nm}, ${last.ag} años. Ingresos: ${fmtMoney(last.inc)}, Ahorros: ${fmtMoney(last.sav)}, Ahorro mensual: ${fmtMoney(last.msv)}. Vivienda: ${muniTxt}, ${last.m2}m², ${last.bd} hab, ${last.ba} baños, ${typeLabel(last.ty)}. Precio estimado: ${fmtMoney(last.pb)}, Cuota hipoteca: ${fmtMoney(last.pay)}, Alquiler: ${fmtMoney(last.pr)}. Esfuerzo hipoteca: ${fmtPct(last.ratioM)}, Esfuerzo alquiler: ${fmtPct(last.ratioR)}. Cash necesario: ${fmtMoney(last.needCash)}. Recomendación: ${last.rec}.`;
  };

  const addMessageToChat=(role,content)=>{
    const mc=Q("#chatMessages");
    if(!mc) return;
    const md=document.createElement("div");
    md.className=`chat-message ${role}`;
    const av=document.createElement("div");
    av.className=`chat-avatar ${role}`;
    av.textContent=role==="ai"?"AI":(LANG==="EN"?"YOU":LANG==="CA"?"TU":"TÚ");
    const bub=document.createElement("div");
    bub.className="chat-bubble";
    bub.textContent=content;
    md.appendChild(av);
    md.appendChild(bub);
    mc.appendChild(md);
    mc.scrollTop=mc.scrollHeight;
  };

  const addThinkingBubble=()=>{
    const mc=Q("#chatMessages");
    if(!mc) return;
    const thinking=document.createElement("div");
    thinking.id="thinking-msg";
    thinking.className="chat-message ai";
    thinking.innerHTML=`<div class="chat-avatar ai">AI</div><div class="chat-bubble thinking">${LANG==="EN"?"Thinking...":LANG==="CA"?"Pensant...":"Pensando..."}</div>`;
    mc.appendChild(thinking);
    mc.scrollTop=mc.scrollHeight;
  };

  const removeThinkingBubble=()=>{
    const thinking=Q("#thinking-msg");
    if(thinking) thinking.remove();
  };

  const sendMessageToAI=async(userMessage)=>{
    if(isAIProcessing||!userMessage.trim()) return;
    isAIProcessing=true;

    const btn=Q("#chatSend"),inp=Q("#chatInput");
    if(btn) btn.disabled=true;
    if(inp) inp.disabled=true;

    addMessageToChat("user",userMessage);
    chatHistory.push({role:"user",content:userMessage});

    addThinkingBubble();

    try{
      const systemPrompt=`Eres un asesor financiero experto especializado en vivienda en Catalunya. Sé conciso pero útil. Tu tono debe ser profesional pero cercano. Das recomendaciones prácticas y específicas. Adviertes riesgos con tacto. Respondes en ${LANG==="ES"?"español":LANG==="CA"?"catalán":"inglés"}. Contexto del usuario: ${getUserContext()}`;

      const response=await fetch("https://api.anthropic.com/v1/messages",{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "anthropic-version":"2023-06-01"
        },
        body:JSON.stringify({
          model:"claude-sonnet-4-20250514",
          max_tokens:1024,
          system:systemPrompt,
          messages:[...chatHistory.slice(-10),{role:"user",content:userMessage}]
        })
      });

      const data=await response.json();
      removeThinkingBubble();

      if(data.content && data.content[0] && data.content[0].text){
        const aiResponse=data.content[0].text;
        addMessageToChat("ai",aiResponse);
        chatHistory.push({role:"assistant",content:aiResponse});
        saveChatHistory();
      }else{
        throw new Error("Invalid API response");
      }
    }catch(error){
      removeThinkingBubble();
      console.error("AI Error:",error);
      const errMsg=LANG==="EN"?"Sorry, I couldn't process your request. Please try again.":LANG==="CA"?"Ho sento, no he pogut processar la teva sol·licitud. Torna-ho a provar.":"Lo siento, no pude procesar tu solicitud. Inténtalo de nuevo.";
      addMessageToChat("ai",errMsg);
    }finally{
      isAIProcessing=false;
      if(btn) btn.disabled=false;
      if(inp){inp.disabled=false;inp.value="";inp.focus();}
    }
  };

  const initChatUI=()=>{
    if(Q("#chatMessages").children.length===0){
      loadChatHistory();
    }

    const btn=Q("#chatSend"),inp=Q("#chatInput");
    if(btn&&!btn.dataset.initialized){
      btn.dataset.initialized="true";
      btn.onclick=()=>{
        const msg=(inp?.value||"").trim();
        if(msg) sendMessageToAI(msg);
      };
    }

    if(inp&&!inp.dataset.initialized){
      inp.dataset.initialized="true";
      inp.onkeypress=(e)=>{
        if(e.key==="Enter"&&!e.shiftKey){
          e.preventDefault();
          const msg=(inp.value||"").trim();
          if(msg) sendMessageToAI(msg);
        }
      };
      inp.oninput=()=>{
        inp.style.height="auto";
        inp.style.height=Math.min(120,inp.scrollHeight)+"px";
      };
    }

    QA(".suggestion-chip").forEach(chip=>{
      if(!chip.dataset.initialized){
        chip.dataset.initialized="true";
        chip.onclick=()=>{
          const q=chip.getAttribute("data-q");
          if(q) sendMessageToAI(q);
        };
      }
    });
  };

  loadForm();
  loadZone();
  setLang(LANG);
  setTabsEnabled();

  Q("#np").onclick=()=>{
    const nm=Q("#nm").value.trim(),ag=+Q("#ag").value||0;
    if(!nm||ag<18||ag>100){toast(t("toastCheckNameAge"));return}
    saveForm();
    show("e");
  };

  Q("#ne").onclick=()=>{saveForm();show("f")};
  Q("#go").onclick=()=>{analyze()};

  Q("#cp").onclick=()=>{
    if(!last){toast(t("toastFirstAnalyze"));return}
    const txt=Q("#rt").textContent;
    navigator.clipboard.writeText(txt).then(()=>toast(t("toastCopied")));
  };

  Q("#rs").onclick=()=>{
    if(confirm(LANG==="EN"?"Reset all data?":LANG==="CA"?"Reiniciar totes les dades?":"¿Reiniciar todos los datos?")){
      localStorage.clear();
      location.reload();
    }
  };

  Q("#jumpX").onclick=()=>{if(!lastReq){toast(t("toastFirstAnalyze"));return}show("x")};
  Q("#jumpAI").onclick=()=>{if(!lastReq){toast(t("toastFirstAnalyze"));return}show("ai")};

  Q("#t_p").onclick=()=>show("p");
  Q("#t_e").onclick=()=>show("e");
  Q("#t_f").onclick=()=>show("f");
  Q("#t_r").onclick=()=>{if(!lastReq){toast(t("toastFirstAnalyze"));return}show("r")};
  Q("#t_m").onclick=()=>{if(!lastReq){toast(t("toastFirstAnalyze"));return}show("m")};
  Q("#t_x").onclick=()=>{if(!lastReq){toast(t("toastFirstAnalyze"));return}show("x")};
  Q("#t_ai").onclick=()=>{if(!lastReq){toast(t("toastFirstAnalyze"));return}show("ai")};

  Q("#toggleMap").onclick=()=>{
    const box=Q("#zoneWrap");
    const isOpen=box.style.display!=="none";
    box.style.display=isOpen?"none":"block";
    if(!isOpen){initMap();setTimeout(()=>zmap?.invalidateSize(),200)}
  };

  Q("#zoneClear").onclick=()=>{
    zoneSel.clear();
    polygonsByName.forEach((_,name)=>applyPolygonState(name));
    renderZoneUI();
    saveZone();
    toast(t("toastZoneCleared"));
  };

  Q("#zoneApply").onclick=()=>{
    if(!zoneSel.size){toast(t("toastNoZone"));return}
    const prevMulti=Q("#ar").querySelector('[value="__multi__"]');
    if(prevMulti) prevMulti.remove();
    if(zoneSel.size===1){
      Q("#ar").value=[...zoneSel][0];
    }else{
      const opt=document.createElement("option");
      opt.value="__multi__";
      opt.textContent=[...zoneSel].join(", ");
      Q("#ar").insertBefore(opt,Q("#ar").options[1]);
      Q("#ar").value="__multi__";
    }
    saveZone();
    toast(t("toastZoneApplied"));
  };

  Q("#bc").onclick=()=>doCompare();
  Q("#autoFillCmp").onclick=()=>{
    if(!lastReq){toast(t("toastFirstAnalyze"));return}
    Q("#cm2").value=lastReq.m2||"";
    Q("#cbd").value=lastReq.bed||"";
    Q("#cba").value=lastReq.bath||"";
    Q("#cty").value=lastReq.type||"flat";
    Q("#ct").checked=lastReq.ex.t;
    Q("#cp0").checked=lastReq.ex.p;
    Q("#cl0").checked=lastReq.ex.l;
    Q("#ck0").checked=lastReq.ex.k;
    Q("#cs0").checked=lastReq.ex.s;
    Q("#cj0").checked=lastReq.ex.j;
    Q("#ca0").checked=lastReq.ex.a;
    saveForm();
    toast(LANG==="EN"?"Data filled":LANG==="CA"?"Dades omplides":"Datos rellenados");
  };

  Q("#shareWa").onclick=()=>{
    if(!last){toast(t("toastFirstAnalyze"));return}
    const txt=Q("#rt").textContent;
    const url="https://wa.me/?text="+encodeURIComponent(txt);
    window.open(url,"_blank");
  };

  Q("#shareCl").onclick=()=>{
    if(!last){toast(t("toastFirstAnalyze"));return}
    const txt=Q("#rt").textContent;
    navigator.clipboard.writeText(txt).then(()=>toast(t("toastCopied")));
  };

  Q("#L_CA").onclick=()=>setLang("CA");
  Q("#L_ES").onclick=()=>setLang("ES");
  Q("#L_EN").onclick=()=>setLang("EN");

  ["inc","sav","m2"].forEach(id=>Q("#"+id).oninput=liveValidate);

  window.addEventListener("resize",()=>{
    if(zmap) setTimeout(()=>zmap.invalidateSize(),100);
    if(cmap) setTimeout(()=>cmap.invalidateSize(),100);
    if(last){drawEffortChart();drawSensChart();drawCmpChart();}
  });

  console.log("App initialized · v9 · Polygon maps · AI chatbot");
})();
}

waitForLeaflet();
</script>
</body>
</html>
