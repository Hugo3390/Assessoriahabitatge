<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessoria d'Habitatge - Suite Profesional v2.0</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- CORE THEME & VARIABLES --- */
        :root {
            --bg-deep: #020617;
            --bg-card: #0f172a;
            --bg-card-hover: #1e293b;
            --primary: #38bdf8;
            --primary-dark: #0284c7;
            --secondary: #22c55e;
            --accent: #818cf8;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: rgba(148, 163, 184, 0.15);
            --glass: rgba(15, 23, 42, 0.7);
            --gradient-main: linear-gradient(135deg, #0ea5e9 0%, #22d3ee 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --shadow-glow: 0 0 20px rgba(56, 189, 248, 0.15);
        }

        * { box-sizing: border-box; scroll-behavior: smooth; }
        
        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(34, 197, 94, 0.05) 0%, transparent 40%);
        }

        /* --- LAYOUT & CONTAINERS --- */
        .app-container { max-width: 1280px; margin: 0 auto; padding: 20px; }
        
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 0; margin-bottom: 30px; border-bottom: 1px solid var(--border);
        }

        .brand-pill {
            background: var(--gradient-main); color: #000;
            padding: 8px 20px; border-radius: 999px;
            font-weight: 800; font-size: 0.9rem; letter-spacing: 0.5px;
            box-shadow: var(--shadow-glow); text-transform: uppercase;
        }

        /* --- NAVIGATION STEPS --- */
        .stepper {
            display: flex; justify-content: space-between; position: relative;
            margin: 40px 0; max-width: 800px; margin-left: auto; margin-right: auto;
        }
        .stepper::before {
            content: ''; position: absolute; top: 15px; left: 0; right: 0;
            height: 2px; background: #1e293b; z-index: 0;
        }
        .step-item {
            position: relative; z-index: 1; text-align: center;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            cursor: pointer; transition: all 0.3s ease;
        }
        .step-circle {
            width: 34px; height: 34px; border-radius: 50%;
            background: var(--bg-card); border: 2px solid #334155;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: var(--text-muted); transition: all 0.3s;
        }
        .step-item.active .step-circle {
            background: var(--primary); color: #000; border-color: var(--primary);
            box-shadow: 0 0 15px var(--primary);
        }
        .step-item.completed .step-circle {
            background: var(--secondary); border-color: var(--secondary); color: #000;
        }
        .step-label { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
        .step-item.active .step-label { color: var(--primary); }

        /* --- MAIN TABS --- */
        .nav-tabs {
            display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto;
            padding-bottom: 5px; scrollbar-width: none;
        }
        .nav-btn {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            color: var(--text-muted); padding: 12px 24px; border-radius: 12px;
            font-weight: 600; cursor: pointer; white-space: nowrap; transition: 0.2s;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.08); }
        .nav-btn.active {
            background: var(--bg-card-hover); border-color: var(--primary);
            color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .nav-btn.special-ai {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
            border-color: var(--accent); color: var(--accent);
        }

        /* --- CARDS & PANELS --- */
        .panel { display: none; animation: fadeIn 0.4s ease; }
        .panel.active { display: block; }
        
        .card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 20px; padding: 25px; margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }

        @media(max-width: 900px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } }

        /* --- FORMS --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-muted); }
        .input-box {
            width: 100%; background: #020617; border: 1px solid #334155;
            padding: 14px; border-radius: 10px; color: white; font-size: 1rem;
            transition: 0.3s;
        }
        .input-box:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2); }
        
        .btn-action {
            width: 100%; padding: 16px; border-radius: 12px; font-weight: 800;
            text-transform: uppercase; cursor: pointer; border: none; font-size: 1rem;
            margin-top: 10px; transition: transform 0.2s;
        }
        .btn-primary { background: var(--gradient-main); color: #020617; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(56, 189, 248, 0.3); }

        /* --- RESULT DASHBOARD --- */
        .kpi-card {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            padding: 20px; border-radius: 16px; border: 1px solid var(--border);
            position: relative; overflow: hidden;
        }
        .kpi-card::after {
            content: ''; position: absolute; top: 0; right: 0; width: 60px; height: 60px;
            background: radial-gradient(circle, rgba(255,255,255,0.05), transparent);
        }
        .kpi-label { font-size: 0.8rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1px; }
        .kpi-value { font-size: 1.8rem; font-weight: 900; color: white; margin: 10px 0; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .kpi-sub { font-size: 0.85rem; color: #64748b; display: flex; align-items: center; gap: 5px; }
        
        .status-badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 800; }
        .bg-ok { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .bg-bad { background: rgba(239, 68, 68, 0.2); color: #f87171; }

        /* --- MAPS --- */
        .map-wrapper { height: 450px; width: 100%; border-radius: 16px; overflow: hidden; position: relative; z-index: 1; }
        #mainMap, #compareMap { width: 100%; height: 100%; }

        /* --- AI CHAT --- */
        .chat-interface {
            height: 600px; display: flex; flex-direction: column;
            background: #0b1120; border-radius: 20px; border: 1px solid var(--border);
            overflow: hidden;
        }
        .chat-header {
            padding: 15px 20px; background: #1e293b; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 10px;
        }
        .ai-status { width: 10px; height: 10px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 10px #22c55e; }
        .chat-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 80%; padding: 12px 18px; border-radius: 18px; line-height: 1.5; font-size: 0.95rem; animation: slideIn 0.3s; }
        .msg.ai { background: #1e293b; color: #e2e8f0; border-bottom-left-radius: 4px; align-self: flex-start; border: 1px solid var(--border); }
        .msg.user { background: var(--gradient-main); color: #020617; border-bottom-right-radius: 4px; align-self: flex-end; font-weight: 600; }
        .chat-input-area { padding: 20px; background: #0f172a; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        .typing-indicator { font-size: 0.8rem; color: var(--text-muted); margin-left: 10px; font-style: italic; opacity: 0; transition: 0.3s; }
        
        /* --- EXAMPLES LIST --- */
        .listing-item {
            display: flex; gap: 15px; padding: 15px; background: rgba(255,255,255,0.02);
            border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s;
        }
        .listing-item:hover { background: rgba(255,255,255,0.05); }
        .listing-price { font-weight: 800; color: var(--primary); font-size: 1.1rem; }
        .listing-details { font-size: 0.85rem; color: var(--text-muted); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

<div class="app-container">
    
    <header class="header">
        <div class="brand-pill">Assessoria d'Habitatge v2.0</div>
        <div style="color: var(--text-muted); font-size: 0.9rem;">Baix Pened√®s ¬∑ Tarragona</div>
    </header>

    <div class="stepper">
        <div class="step-item active" id="step1">
            <div class="step-circle">1</div>
            <div class="step-label">Perfil</div>
        </div>
        <div class="step-item" id="step2">
            <div class="step-circle">2</div>
            <div class="step-label">Econom√≠a</div>
        </div>
        <div class="step-item" id="step3">
            <div class="step-circle">3</div>
            <div class="step-label">Preferencias</div>
        </div>
        <div class="step-item" id="step4">
            <div class="step-circle">4</div>
            <div class="step-label">An√°lisis</div>
        </div>
    </div>

    <div class="nav-tabs">
        <button class="nav-btn active" onclick="app.nav('personal')">1. Personal</button>
        <button class="nav-btn" onclick="app.nav('economy')">2. Econom√≠a</button>
        <button class="nav-btn" onclick="app.nav('prefs')">3. Preferencias</button>
        <button class="nav-btn" onclick="app.nav('results')" id="btn-res" disabled style="opacity:0.5">4. Resultados</button>
        <button class="nav-btn" onclick="app.nav('examples')" id="btn-ex" disabled style="opacity:0.5">5. Ejemplos Reales</button>
        <button class="nav-btn" onclick="app.nav('compare')" id="btn-cmp" disabled style="opacity:0.5">6. Comparador</button>
        <button class="nav-btn special-ai" onclick="app.nav('ai')" id="btn-ai" disabled style="opacity:0.5">ü§ñ AI Advisor</button>
    </div>

    <div id="view-personal" class="panel active">
        <div class="card" style="max-width: 600px; margin: 0 auto;">
            <h2 style="margin-top:0">Datos Personales</h2>
            <div class="form-group">
                <label>Nombre Completo</label>
                <input type="text" class="input-box" id="inp-name" placeholder="Ej. Marc Garc√≠a">
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label>Edad</label>
                    <input type="number" class="input-box" id="inp-age" value="30">
                </div>
                <div class="form-group">
                    <label>Residencia Actual</label>
                    <select class="input-box" id="inp-residency">
                        <option>Alquiler</option>
                        <option>Padres</option>
                        <option>Propiedad</option>
                    </select>
                </div>
            </div>
            <button class="btn-action btn-primary" onclick="app.nav('economy')">Siguiente: Econom√≠a</button>
        </div>
    </div>

    <div id="view-economy" class="panel">
        <div class="card">
            <h2 style="margin-top:0">Perfil Financiero</h2>
            <div class="grid-2">
                <div class="form-group">
                    <label>Ingresos Netos Mensuales (Hogar)</label>
                    <input type="number" class="input-box" id="inp-income" placeholder="2500" value="2500">
                    <small style="color: #64748b">Suma de todas las n√≥minas netas x 12 / 12.</small>
                </div>
                <div class="form-group">
                    <label>Ahorros Disponibles (Total)</label>
                    <input type="number" class="input-box" id="inp-savings" placeholder="50000" value="40000">
                    <small style="color: #64748b">Entrada + Gastos.</small>
                </div>
                <div class="form-group">
                    <label>Deudas / Pr√©stamos Mensuales</label>
                    <input type="number" class="input-box" id="inp-debts" value="0">
                </div>
                <div class="form-group">
                    <label>A√±os de Hipoteca Deseados</label>
                    <input type="number" class="input-box" id="inp-years" value="30" max="40">
                </div>
            </div>
            <button class="btn-action btn-primary" onclick="app.nav('prefs')">Siguiente: Preferencias</button>
        </div>
    </div>

    <div id="view-prefs" class="panel">
        <div class="grid-2">
            <div class="card">
                <h3 style="margin-top:0">¬øQu√© est√°s buscando?</h3>
                <div class="form-group">
                    <label>Municipio Preferente</label>
                    <select class="input-box" id="inp-town" onchange="app.updateMapSelection()">
                        <option value="calafell">Calafell</option>
                        <option value="cunit">Cunit</option>
                        <option value="vendrell">El Vendrell</option>
                        <option value="arboc">L'Arbo√ß</option>
                        <option value="bellvei">Bellvei</option>
                        <option value="santas">Santa Oliva</option>
                    </select>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Superficie M√≠nima (m¬≤)</label>
                        <input type="number" class="input-box" id="inp-m2" value="80">
                    </div>
                    <div class="form-group">
                        <label>Habitaciones</label>
                        <input type="number" class="input-box" id="inp-rooms" value="3">
                    </div>
                </div>
                <div class="form-group">
                    <label>Tipo de Inmueble</label>
                    <select class="input-box" id="inp-type">
                        <option value="flat">Piso / Apartamento</option>
                        <option value="house">Casa / Chalet</option>
                        <option value="duplex">D√∫plex</option>
                    </select>
                </div>
                <button class="btn-action btn-primary" onclick="app.calculate()">ANALIZAR VIABILIDAD</button>
            </div>
            
            <div class="card" style="padding:0; overflow:hidden; display:flex; flex-direction:column;">
                <div style="padding:15px; background:var(--bg-card-hover); border-bottom:1px solid var(--border)">
                    <span style="font-weight:700">Explorador de Zona</span>
                </div>
                <div class="map-wrapper" id="map-container-pref">
                    <div id="mainMap"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-results" class="panel">
        
        <div class="grid-4" style="margin-bottom:25px">
            <div class="kpi-card">
                <div class="kpi-label">Precio M√°ximo Recomendado</div>
                <div class="kpi-value" id="res-max-price">0 ‚Ç¨</div>
                <div class="kpi-sub">Basado en endeudamiento 35%</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Cuota Hipoteca Estimada</div>
                <div class="kpi-value" id="res-quota">0 ‚Ç¨</div>
                <div class="kpi-sub" id="res-rate-info">Inter√©s fijo 3.2%</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Ahorro Necesario (Entrada)</div>
                <div class="kpi-value" id="res-savings-needed">0 ‚Ç¨</div>
                <div class="kpi-sub">20% Entrada + 10% ITP + Gastos</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Diagn√≥stico</div>
                <div class="kpi-value" id="res-status">--</div>
                <div class="kpi-sub" id="res-effort">Esfuerzo: 0%</div>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <h3>An√°lisis Visual de Esfuerzo</h3>
                <div style="height: 300px;">
                    <canvas id="chartResults"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>Detalle del Asesor</h3>
                <div id="res-text-analysis" style="line-height:1.7; color: #cbd5e1;">
                    </div>
                <div style="margin-top:20px; padding:15px; background:rgba(56,189,248,0.1); border-left:4px solid var(--primary); border-radius:4px;">
                    <strong>Consejo R√°pido:</strong> <span id="res-tip">...</span>
                </div>
                <div style="margin-top:20px; display:flex; gap:10px;">
                    <button class="btn-action btn-primary" style="font-size:0.9rem" onclick="app.nav('ai')">Preguntar a la IA</button>
                    <button class="btn-action" style="background:#1e293b; color:white; font-size:0.9rem" onclick="app.nav('examples')">Ver Casas Reales</button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-examples" class="panel">
        <div class="grid-2" style="grid-template-columns: 1fr 2fr;">
            <div class="card" style="height: 600px; overflow-y: auto; padding:0;">
                <div style="padding:15px; position:sticky; top:0; background:var(--bg-card); border-bottom:1px solid var(--border); z-index:10;">
                    <h3 style="margin:0">Inmuebles Disponibles</h3>
                    <small>Datos simulados del mercado real</small>
                </div>
                <div id="listings-container">
                    </div>
            </div>
            <div class="card" style="padding:0; overflow:hidden;">
                 <div class="map-wrapper" style="height:100%" id="map-container-ex">
                    <div id="exMap" style="width:100%; height:100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-ai" class="panel">
        <div class="chat-interface">
            <div class="chat-header">
                <div class="ai-status"></div>
                <div>
                    <div style="font-weight:700">Financial AI Advisor</div>
                    <div style="font-size:0.8rem; color:var(--text-muted)">Especialista en Mercado Inmobiliario Baix Pened√®s</div>
                </div>
            </div>
            <div class="chat-body" id="chat-feed">
                <div class="msg ai">
                    Hola. He procesado todo tu perfil financiero. Veo que tienes unos ingresos de <span id="ai-mem-inc">...</span> y buscas en <span id="ai-mem-town">...</span>.
                    <br><br>¬øEn qu√© puedo ayudarte? Puedes preguntarme sobre "riesgos", "impuestos", "mejor zona" o "alquiler vs compra".
                </div>
            </div>
            <div class="typing-indicator" id="typing">AI est√° escribiendo...</div>
            <div class="chat-input-area">
                <input type="text" class="input-box" id="chat-input" placeholder="Escribe tu consulta aqu√≠..." onkeydown="if(event.key==='Enter') app.chat.send()">
                <button class="btn-action btn-primary" style="width:auto; margin:0;" onclick="app.chat.send()">Enviar</button>
            </div>
        </div>
    </div>

</div>

<script>
/* --- 1. MOCK DATABASE (Datos Reales Simulados) --- */
const DB_VIVIENDAS = [
    { id: 1, town: 'cunit', price: 215000, m2: 90, rooms: 3, type: 'flat', lat: 41.1985, lng: 1.635, title: "Piso c√©ntrico cerca playa" },
    { id: 2, town: 'cunit', price: 350000, m2: 150, rooms: 4, type: 'house', lat: 41.2010, lng: 1.630, title: "Casa adosada reformada" },
    { id: 3, town: 'calafell', price: 185000, m2: 75, rooms: 2, type: 'flat', lat: 41.1920, lng: 1.570, title: "Apartamento Calafell Playa" },
    { id: 4, town: 'calafell', price: 420000, m2: 200, rooms: 5, type: 'house', lat: 41.2050, lng: 1.560, title: "Torre con piscina privada" },
    { id: 5, town: 'vendrell', price: 145000, m2: 85, rooms: 3, type: 'flat', lat: 41.2220, lng: 1.535, title: "Piso econ√≥mico El Tancat" },
    { id: 6, town: 'vendrell', price: 260000, m2: 140, rooms: 4, type: 'house', lat: 41.2150, lng: 1.540, title: "Casa en zona escolar" },
    { id: 7, town: 'arboc', price: 120000, m2: 95, rooms: 3, type: 'flat', lat: 41.2650, lng: 1.605, title: "Oportunidad L'Arbo√ß Centro" },
    { id: 8, town: 'bellvei', price: 210000, m2: 130, rooms: 4, type: 'house', lat: 41.2400, lng: 1.575, title: "Casa de pueblo tranquila" },
    { id: 9, town: 'santas', price: 295000, m2: 180, rooms: 4, type: 'house', lat: 41.2500, lng: 1.550, title: "Chalet independiente" },
    { id: 10, town: 'cunit', price: 175000, m2: 65, rooms: 2, type: 'flat', lat: 41.1960, lng: 1.640, title: "√Åtico con vistas" }
];

const TOWN_COORDS = {
    cunit: [41.198, 1.637],
    calafell: [41.200, 1.568],
    vendrell: [41.222, 1.533],
    arboc: [41.267, 1.603],
    bellvei: [41.242, 1.576],
    santas: [41.253, 1.551]
};

/* --- 2. APPLICATION STATE & LOGIC --- */
const app = {
    state: {
        name: '', age: 30,
        income: 2500, savings: 40000, debts: 0, years: 30,
        town: 'calafell', m2: 80,
        results: null
    },
    maps: {},
    chart: null,

    init: function() {
        // Inicializar mapas (Lazy load se maneja en nav)
        this.maps.main = L.map('mainMap').setView(TOWN_COORDS.calafell, 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(this.maps.main);
        
        this.maps.ex = L.map('exMap').setView(TOWN_COORDS.calafell, 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(this.maps.ex);
    },

    nav: function(viewId) {
        // UI Switching
        document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
        document.getElementById('view-'+viewId).classList.add('active');
        
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        // Find button that calls this nav
        const btns = Array.from(document.querySelectorAll('.nav-btn'));
        const activeBtn = btns.find(b => b.getAttribute('onclick').includes(viewId));
        if(activeBtn) activeBtn.classList.add('active');

        // Step Update
        const stepMap = { 'personal':1, 'economy':2, 'prefs':3, 'results':4 };
        if(stepMap[viewId]) {
            for(let i=1; i<=4; i++) {
                const el = document.getElementById('step'+i);
                el.classList.remove('active', 'completed');
                if(i < stepMap[viewId]) el.classList.add('completed');
                if(i === stepMap[viewId]) el.classList.add('active');
            }
        }

        // Map Fix (Invalidate Size para evitar gris)
        if(viewId === 'prefs') setTimeout(() => this.maps.main.invalidateSize(), 200);
        if(viewId === 'examples') {
            setTimeout(() => {
                this.maps.ex.invalidateSize();
                this.populateExamples();
            }, 200);
        }
        if(viewId === 'ai') this.chat.init();
    },

    updateMapSelection: function() {
        const town = document.getElementById('inp-town').value;
        const coords = TOWN_COORDS[town];
        if(coords) {
            this.maps.main.flyTo(coords, 14);
            // Dibujar radio
            if(this.maps.main.circle) this.maps.main.removeLayer(this.maps.main.circle);
            this.maps.main.circle = L.circle(coords, {
                color: '#38bdf8', fillColor: '#38bdf8', fillOpacity: 0.2, radius: 1000
            }).addTo(this.maps.main);
        }
    },

    calculate: function() {
        // 1. Get Values
        const s = this.state;
        s.name = document.getElementById('inp-name').value;
        s.age = parseInt(document.getElementById('inp-age').value);
        s.income = parseFloat(document.getElementById('inp-income').value);
        s.savings = parseFloat(document.getElementById('inp-savings').value);
        s.debts = parseFloat(document.getElementById('inp-debts').value);
        s.years = parseInt(document.getElementById('inp-years').value);
        s.town = document.getElementById('inp-town').value;

        // 2. Math Logic
        const maxEffortRate = 0.35; // 35% limite sano
        const availableForQuota = (s.income * maxEffortRate) - s.debts;
        const interestRate = 0.032; // 3.2%
        const r = interestRate / 12;
        const n = s.years * 12;

        // Cu√°nto dinero puede pedir prestado con esa cuota m√°xima
        // Formula PV = PMT * (1 - (1+r)^-n) / r
        let maxLoan = 0;
        if(availableForQuota > 0) {
            maxLoan = availableForQuota * (1 - Math.pow(1+r, -n)) / r;
        }

        // Costes Compraventa (ITP 10% + Notaria 3%)
        // Si es joven (<33) y vivienda habitual en Cat, ITP es 5% (simplificaci√≥n l√≥gica)
        const itpRate = s.age <= 32 && s.income < 30000 ? 0.05 : 0.10;
        const expensesRate = itpRate + 0.03; 

        // Precio Casa = (Ahorro + Hipoteca) / (1 + Gastos)
        // Pero el banco solo da el 80% del valor de tasaci√≥n/compra.
        // Limitante 1: Capacidad endeudamiento (maxLoan)
        // Limitante 2: Ahorros (deben cubrir 20% + Gastos)
        
        // Calculamos Precio M√°ximo seg√∫n Ahorros:
        // Ahorros = Precio * 0.20 + Precio * Gastos -> Ahorros = Precio * (0.20 + Gastos)
        const maxPriceBySavings = s.savings / (0.20 + expensesRate);
        
        // Calculamos Precio M√°ximo seg√∫n Hipoteca (Banco da 80%):
        // Hipoteca = Precio * 0.80 -> Precio = Hipoteca / 0.80
        const maxPriceByIncome = maxLoan / 0.80;

        // El real es el menor de los dos
        const feasiblePrice = Math.min(maxPriceBySavings, maxPriceByIncome);
        const estimatedQuota = (feasiblePrice * 0.80) * (r * Math.pow(1+r, n)) / (Math.pow(1+r, n) - 1);
        const effortPercent = (estimatedQuota / s.income) * 100;

        // Store Results
        s.results = {
            price: feasiblePrice,
            quota: estimatedQuota,
            effort: effortPercent,
            expenses: feasiblePrice * expensesRate,
            loan: feasiblePrice * 0.80,
            neededSavings: (feasiblePrice * 0.20) + (feasiblePrice * expensesRate)
        };

        // 3. Render
        document.getElementById('res-max-price').innerText = this.fmt(feasiblePrice);
        document.getElementById('res-quota').innerText = this.fmt(estimatedQuota) + "/mes";
        document.getElementById('res-savings-needed').innerText = this.fmt(s.results.neededSavings);
        
        const stEl = document.getElementById('res-status');
        const efEl = document.getElementById('res-effort');
        
        efEl.innerText = `Esfuerzo Real: ${effortPercent.toFixed(1)}%`;
        
        if(effortPercent > 40) {
            stEl.innerText = "NO VIABLE"; stEl.className = "kpi-value text-danger";
            document.getElementById('res-text-analysis').innerHTML = `Tu nivel de endeudamiento superar√≠a el 40%. Ning√∫n banco tradicional aprobar√° la operaci√≥n sin avalistas fuertes. Te faltan ahorros o ingresos.`;
            document.getElementById('res-tip').innerText = "Busca en zonas m√°s baratas como L'Arbo√ß o reduce m¬≤.";
        } else if(effortPercent > 33) {
            stEl.innerText = "AL L√çMITE"; stEl.className = "kpi-value text-warning";
             document.getElementById('res-text-analysis').innerHTML = `Es viable pero arriesgado. Est√°s justo en el l√≠mite del 35%. Cualquier subida del Euribor (si fuera variable) te pondr√≠a en aprietos.`;
             document.getElementById('res-tip').innerText = "Intenta negociar una rebaja del 5-10% en el precio final.";
        } else {
            stEl.innerText = "OPTIMO"; stEl.className = "kpi-value text-success";
             document.getElementById('res-text-analysis').innerHTML = `Situaci√≥n financiera excelente. Tienes luz verde para comprar. Tu cuota es c√≥moda y tienes colch√≥n de seguridad.`;
             document.getElementById('res-tip').innerText = "Pide hipoteca a tipo fijo y compara 3 bancos.";
        }

        // Enable Tabs
        document.getElementById('btn-res').disabled = false;
        document.getElementById('btn-ex').disabled = false;
        document.getElementById('btn-cmp').disabled = false;
        document.getElementById('btn-ai').disabled = false;
        
        document.querySelectorAll('.nav-btn').forEach(b => b.style.opacity = 1);
        
        this.nav('results');
        this.renderChart();
        this.updateAIContext();
    },

    fmt: function(n) {
        return n.toLocaleString('es-ES', {style:'currency', currency:'EUR', maximumFractionDigits:0});
    },

    renderChart: function() {
        const ctx = document.getElementById('chartResults').getContext('2d');
        if(this.chart) this.chart.destroy();
        
        const res = this.state.results;
        
        this.chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Cuota Hipoteca', 'Resto Ingresos'],
                datasets: [{
                    data: [res.quota, this.state.income - res.quota],
                    backgroundColor: [
                        res.effort > 35 ? '#ef4444' : '#38bdf8', 
                        '#1e293b'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: {color: '#94a3b8'} }
                },
                cutout: '70%'
            }
        });
    },

    populateExamples: function() {
        const list = document.getElementById('listings-container');
        list.innerHTML = '';
        
        // Filtrar por precio similar (hasta +20% de lo viable)
        const limit = this.state.results ? this.state.results.price * 1.2 : 1000000;
        const matches = DB_VIVIENDAS.filter(v => v.price <= limit);

        // Limpiar mapa viejo
        this.maps.ex.eachLayer((layer) => {
            if(!!layer.toGeoJSON) this.maps.ex.removeLayer(layer);
        });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(this.maps.ex);

        matches.forEach(v => {
            // HTML List
            const div = document.createElement('div');
            div.className = 'listing-item';
            div.innerHTML = `
                <div style="width:60px; height:60px; background:#334155; border-radius:8px; display:flex; align-items:center; justify-content:center;">üè†</div>
                <div>
                    <div style="font-weight:700; color:white">${v.title}</div>
                    <div class="listing-price">${this.fmt(v.price)}</div>
                    <div class="listing-details">${v.town} ¬∑ ${v.m2}m¬≤ ¬∑ ${v.rooms} hab</div>
                </div>
            `;
            div.onclick = () => {
                this.maps.ex.flyTo([v.lat, v.lng], 16);
                marker.openPopup();
            };
            list.appendChild(div);

            // Map Marker
            const marker = L.marker([v.lat, v.lng]).addTo(this.maps.ex);
            marker.bindPopup(`<b>${v.title}</b><br>${this.fmt(v.price)}`);
        });
    },

    /* --- 3. AI LOGIC (Regex Mock) --- */
    updateAIContext: function() {
        if(this.state.income) document.getElementById('ai-mem-inc').innerText = this.fmt(this.state.income);
        if(this.state.town) document.getElementById('ai-mem-town').innerText = this.state.town.toUpperCase();
    },

    chat: {
        init: function() {
            setTimeout(() => {
                const feed = document.getElementById('chat-feed');
                if(feed.childElementCount <= 1) { // Solo saludo inicial
                   // Nada que hacer, ya est√° el saludo
                }
            }, 500);
        },
        send: function() {
            const inp = document.getElementById('chat-input');
            const txt = inp.value.trim();
            if(!txt) return;

            // User msg
            this.addMsg(txt, 'user');
            inp.value = '';

            // Loading
            const typing = document.getElementById('typing');
            typing.style.opacity = 1;

            // Logic Simulation
            setTimeout(() => {
                typing.style.opacity = 0;
                const response = this.generateResponse(txt);
                this.addMsg(response, 'ai');
            }, 1200);
        },
        addMsg: function(txt, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = txt;
            const feed = document.getElementById('chat-feed');
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        },
        generateResponse: function(q) {
            const low = q.toLowerCase();
            const s = app.state;
            const res = s.results || { price: 0, effort: 0 };

            if(low.includes('hola') || low.includes('buen')) return "¬°Hola! ¬øListo para analizar tu futura vivienda?";
            
            if(low.includes('viab') || low.includes('puedo comprar')) {
                if(res.effort > 35) return `Siendo sincero, lo veo complicado. Tu tasa de esfuerzo es del ${res.effort.toFixed(1)}%. Deber√≠as reducir deuda o buscar algo m√°s econ√≥mico.`;
                return `S√≠, es viable. Tu tasa de esfuerzo es del ${res.effort.toFixed(1)}%, lo cual entra dentro de los par√°metros de riesgo aceptables.`;
            }

            if(low.includes('ahorr') || low.includes('entrada')) {
                return `Para una casa de ${app.fmt(res.price)}, necesitar√°s tener en el banco unos ${app.fmt(res.neededSavings)}. Esto cubre el 20% que no financia el banco m√°s el 10-12% de impuestos y gastos.`;
            }

            if(low.includes('calafell') || low.includes('zona')) {
                return "Calafell es excelente, pero el precio por m¬≤ ronda los 2.100‚Ç¨. Si buscas algo m√°s barato, Cunit o El Vendrell (zona Tancat) suelen ser opciones m√°s asequibles.";
            }

            if(low.includes('alquiler') || low.includes('rent')) {
                const rentEst = res.price * 0.045 / 12; // 4.5% yield
                return `Un alquiler equivalente te costar√≠a unos ${app.fmt(rentEst)}/mes. Si tu cuota hipotecaria es ${app.fmt(res.quota)}, compara ambas cifras. Normalmente comprar es mejor a largo plazo si te quedas +5 a√±os.`;
            }

            return "Entendido. Como asesor inmobiliario, te sugiero que revises bien el c√°lculo del ITP (Impuesto Transmisiones). ¬øQuieres que te explique c√≥mo afecta a tus ahorros?";
        }
    }
};

// Start
window.onload = function() {
    app.init();
};
</script>
</body>
</html>
