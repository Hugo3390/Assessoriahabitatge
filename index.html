<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Assessoria d'Habitatge - AI Advisor</title>
<style>
:root{
  --bg:#020617;
  --card:rgba(15,23,42,.70);
  --card2:rgba(11,18,32,.88);
  --bd:rgba(148,163,184,.22);
  --bd2:rgba(148,163,184,.30);
  --t:#e5e7eb;
  --m:#94a3b8;
  --mut:#cbd5e1;
  --pill:#38bdf8;
  --p:#06b6d4;--ph:#0891b2;
  --ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;
  --g1:#3b4a60;--g2:#0b1220;
  --shadow-lg:0 10px 40px rgba(0,0,0,.35);
  --shadow-xl:0 20px 60px rgba(0,0,0,.48);
  --gradient-3:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
  --gradient-4:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);
}
html,body{height:100%}
body{margin:0;background:var(--bg);position:relative;overflow-x:hidden;}
body::before{
  content:"";position:fixed;inset:0;
  background:
    radial-gradient(1400px 700px at 20% -10%,rgba(56,189,248,.18),transparent 60%),
    radial-gradient(1000px 600px at 85% 0%,rgba(34,197,94,.14),transparent 60%),
    radial-gradient(900px 520px at 60% 110%,rgba(168,85,247,.12),transparent 62%),
    linear-gradient(180deg,#0f172a 0%,#020617 55%,#000 100%);
  z-index:-1;pointer-events:none;animation:pulse 18s ease-in-out infinite;
}
@keyframes pulse{0%,100%{opacity:.80}50%{opacity:1}}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{opacity:0;transform:translateX(-18px)}to{opacity:1;transform:translateX(0)}}
@keyframes glow{0%,100%{box-shadow:0 0 18px rgba(56,189,248,.22)}50%{box-shadow:0 0 30px rgba(56,189,248,.42)}}
@keyframes typing{from{opacity:.4}to{opacity:1}}

#hx{color:var(--t);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;-webkit-font-smoothing:antialiased;}
#hx *{box-sizing:border-box}
.w{max-width:1200px;margin:22px auto 18px;padding:0 16px}

.c{
  background:rgba(15,23,42,.86);border:1px solid var(--bd);border-radius:20px;
  padding:22px;margin:16px 0;backdrop-filter:blur(14px);box-shadow:var(--shadow-lg);
  animation:fadeIn .5s ease-out;transition:all .25s ease;position:relative;overflow:hidden;
}
.c::before{content:"";position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(56,189,248,.6),transparent);opacity:.55}
.c:hover{border-color:rgba(56,189,248,.42);box-shadow:var(--shadow-xl)}

.r{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.hrow{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.n{opacity:.95;font-size:.95rem;color:#cbd5e1;line-height:1.6}
.small{font-size:.88rem;color:#b6c2d3;line-height:1.5}

.pill{background:var(--gradient-3);color:#001018;border-radius:999px;padding:10px 16px;font-weight:950;letter-spacing:.6px;text-transform:uppercase;font-size:.88rem;box-shadow:0 4px 16px rgba(56,189,248,.32);animation:glow 6s ease-in-out infinite;white-space:nowrap;}
.lang{display:flex;gap:10px;align-items:center}
.langbtn{border:1px solid rgba(148,163,184,.28);background:rgba(11,18,32,.85);color:#cbd5e1;border-radius:999px;padding:8px 14px;font-weight:900;cursor:pointer;transition:all .18s ease;font-size:.84rem;letter-spacing:.5px;}
.langbtn:hover{border-color:rgba(56,189,248,.55);transform:translateY(-1px)}
.langbtn.a{background:var(--gradient-3);color:#001018;border-color:#38bdf8;box-shadow:0 4px 14px rgba(56,189,248,.28)}

.tabs{display:flex;gap:10px;margin:16px 0;flex-wrap:wrap;animation:slideIn .6s ease-out}
.tab{border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.80);color:#cbd5e1;border-radius:999px;padding:10px 18px;cursor:pointer;font-weight:900;transition:all .18s ease;user-select:none;position:relative;overflow:hidden;font-size:.90rem;letter-spacing:.35px;}
.tab:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(56,189,248,.28)}
.tab.a{background:var(--gradient-3);color:#001018;border-color:#38bdf8;box-shadow:0 4px 14px rgba(56,189,248,.36)}
.tab.dis{opacity:.40;cursor:not-allowed;filter:grayscale(.35)}
.tab.dis:hover{transform:none;box-shadow:none}

.b{background:var(--gradient-3);color:#001018;border:0;border-radius:14px;padding:12px 20px;cursor:pointer;font-weight:950;transition:all .18s ease;box-shadow:0 4px 15px rgba(56,189,248,.28);font-size:.95rem;letter-spacing:.3px;position:relative;overflow:hidden}
.b:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(56,189,248,.42)}
.b.ok{background:var(--gradient-4);box-shadow:0 4px 15px rgba(67,233,123,.22)}
.b.ok:hover{box-shadow:0 6px 20px rgba(67,233,123,.42)}
.b.dis{opacity:.45;cursor:not-allowed;filter:grayscale(.25);transform:none;pointer-events:none}

.g{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
@media(max-width:900px){.g{grid-template-columns:1fr}}

#hx input[type=text],#hx input[type=number],#hx select,#hx textarea{
  width:100%;padding:12px 14px;border:1px solid rgba(148,163,184,.30);border-radius:12px;
  background:rgba(2,6,23,.86);color:var(--t);outline:none;transition:all .18s ease;font-size:.95rem;font-family:inherit;
}
#hx textarea{min-height:100px;resize:vertical;}
#hx input[type=text]:focus,#hx input[type=number]:focus,#hx select:focus,#hx textarea:focus{
  border-color:#38bdf8;box-shadow:0 0 0 4px rgba(56,189,248,.14);background:rgba(2,6,23,.96)
}
#hx input[type=checkbox]{accent-color:#38bdf8;width:18px;height:18px;cursor:pointer}
#hx label{color:#cbd5e1;font-weight:750;margin-bottom:6px;display:block;font-size:.9rem;letter-spacing:.25px}

.gu{margin-top:12px;padding:14px 16px;background:rgba(56,189,248,.08);border:1px solid rgba(56,189,248,.25);border-radius:14px;color:#dbeafe;display:flex;gap:12px;align-items:flex-start;border-left:4px solid #38bdf8}
.gu .a{font-weight:950;line-height:1.2;margin-top:1px;font-size:1.15rem}

.tst{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:rgba(2,6,23,.94);border:1px solid rgba(148,163,184,.35);color:var(--t);padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none;transition:.2s;z-index:99999}
.tst.s{opacity:1}

.sig{max-width:1100px;margin:10px auto 18px;padding:10px 12px;color:#a5b4fc;background:rgba(10,16,28,.65);border:1px solid rgba(148,163,184,.25);border-radius:12px;display:flex;gap:12px;align-items:center;justify-content:space-between;font-size:.95rem}
.sig .br{font-weight:950;color:#e2e8f0}
.sig a{color:#93c5fd;text-decoration:none}
.sig a:hover{text-decoration:underline}

.cardx{margin-top:16px;background:linear-gradient(135deg,rgba(15,23,42,.86),rgba(11,18,32,.92));border:1px solid rgba(148,163,184,.25);border-radius:16px;padding:20px;box-shadow:0 4px 22px rgba(0,0,0,.22)}
.cardx .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;padding-bottom:16px;border-bottom:1px solid rgba(148,163,184,.14)}
.cardx .title{font-weight:1000;color:#f1f5f9;font-size:1.15rem}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{border:1px solid rgba(148,163,184,.30);background:rgba(11,18,32,.82);color:#cbd5e1;border-radius:999px;padding:8px 14px;font-weight:850;font-size:.85rem;transition:.15s;text-shadow:0 1px 8px rgba(0,0,0,.25);}
.chip:hover{transform:translateY(-1px)}
.chip.good{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.12);color:#86efac}
.chip.bad{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.12);color:#fca5a5}
.chip.warn{border-color:rgba(245,158,11,.45);background:rgba(245,158,11,.12);color:#fde68a}
.chip.neu{border-color:rgba(148,163,184,.35);color:#e2e8f0}

.body{margin-top:16px;color:#cbd5e1;line-height:1.65;font-size:.95rem}
.body b{color:#f8fafc;font-weight:800}

.grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:16px}
@media(max-width:980px){.grid3{grid-template-columns:1fr}}

.mini{background:linear-gradient(135deg,rgba(14,165,233,.10),rgba(6,182,212,.06));border:1px solid rgba(148,163,184,.25);border-radius:14px;padding:14px;transition:.15s}
.mini:hover{border-color:rgba(56,189,248,.40);transform:translateY(-1px)}
.mini .h{color:#94a3b8;font-size:.82rem;font-weight:800;text-transform:uppercase;letter-spacing:.5px}
.mini .v{font-weight:1000;color:#f8fafc;margin-top:6px;font-size:1.15rem;text-shadow:0 2px 12px rgba(0,0,0,.35);}
.note{margin-top:16px;color:#cbd5e1;white-space:pre-wrap;background:rgba(2,6,23,.62);padding:16px;border-radius:12px;border:1px solid rgba(148,163,184,.20);line-height:1.7;font-size:.92rem}

.k{background:linear-gradient(145deg,rgba(14,165,233,.10),rgba(6,182,212,.06));border:1px solid rgba(56,189,248,.30);border-radius:18px;padding:18px 14px;text-align:left;position:relative;overflow:hidden;box-shadow:0 4px 18px rgba(0,0,0,.25);min-height:86px;}
.k::before{content:"";position:absolute;inset:-40%;background:radial-gradient(circle,rgba(56,189,248,.10),transparent 70%);pointer-events:none;transition:transform .6s ease;}
.k:hover::before{transform:scale(1.12)}
.k span{color:#a6b3c6;font-size:.78rem;font-weight:900;text-transform:uppercase;letter-spacing:.9px;display:block}
.k b{font-size:30px;display:block;color:#f1f5f9;margin-top:10px;font-weight:1000;text-shadow:0 2px 14px rgba(0,0,0,.45);line-height:1.05;}
.k .sub{margin-top:8px;font-size:.82rem;color:#9fb0c6;line-height:1.25;}
@media(max-width:520px){.k b{font-size:26px}}

.pbar-wrap{margin-top:8px;background:rgba(255,255,255,.07);border-radius:999px;height:8px;overflow:hidden}
.pbar{height:8px;border-radius:999px;transition:width .9s cubic-bezier(.4,0,.2,1)}
.pbar.good{background:linear-gradient(90deg,#22c55e,#4ade80)}
.pbar.warn{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.pbar.bad{background:linear-gradient(90deg,#ef4444,#f87171)}

.tip{position:relative;display:inline-flex;align-items:center;gap:4px;width:100%}
.tip-icon{width:16px;height:16px;border-radius:50%;background:rgba(148,163,184,.22);color:#b6c2d3;font-size:10px;font-weight:950;cursor:help;display:inline-flex;align-items:center;justify-content:center;border:1px solid rgba(148,163,184,.30);flex-shrink:0;user-select:none}
.tip-box{position:absolute;top:calc(100% + 6px);right:0;left:auto;transform:none;background:#0f172a;border:1px solid rgba(56,189,248,.35);border-radius:10px;padding:10px 14px;color:#cbd5e1;font-size:.82rem;line-height:1.5;width:240px;z-index:9999;box-shadow:0 10px 26px rgba(0,0,0,.55);pointer-events:none;opacity:0;transition:opacity .14s;}
.tip:hover .tip-box,.tip:focus-within .tip-box{opacity:1}

.steps{display:flex;align-items:center;margin-bottom:16px;animation:fadeIn .45s ease-out}
.step{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1;position:relative}
.step-dot{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:1000;font-size:.85rem;transition:all .25s ease;border:2px solid rgba(148,163,184,.22);background:rgba(11,18,32,.82);color:#94a3b8;z-index:1}
.step.done .step-dot{background:var(--gradient-4);color:#001018;border-color:#22c55e;box-shadow:0 0 12px rgba(34,197,94,.35)}
.step.active .step-dot{background:var(--gradient-3);color:#001018;border-color:#38bdf8;box-shadow:0 0 12px rgba(56,189,248,.42)}
.step-label{font-size:.72rem;color:#475569;font-weight:850;text-align:center;white-space:nowrap}
.step.done .step-label,.step.active .step-label{color:#94a3b8}
.step-line{position:absolute;top:15px;left:calc(50% + 17px);width:calc(100% - 34px);height:2px;background:rgba(148,163,184,.14);transition:background .3s;z-index:0}
.step.done .step-line{background:rgba(34,197,94,.28)}

.share-bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;padding-top:12px;border-top:1px solid rgba(148,163,184,.12)}
.share-btn{border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.82);color:#cbd5e1;border-radius:10px;padding:8px 14px;cursor:pointer;font-weight:850;font-size:.82rem;transition:all .18s ease;display:flex;align-items:center;gap:6px}
.share-btn:hover{transform:translateY(-2px)}
.share-btn.wa{border-color:rgba(37,211,102,.40);color:#4ade80}
.share-btn.wa:hover{background:rgba(37,211,102,.10);box-shadow:0 4px 12px rgba(37,211,102,.18)}
.share-btn.cl{border-color:rgba(56,189,248,.40);color:#7dd3fc}
.share-btn.cl:hover{background:rgba(56,189,248,.10);box-shadow:0 4px 12px rgba(56,189,248,.18)}

#hx input.field-ok{border-color:rgba(34,197,94,.50)!important}
#hx input.field-err{border-color:rgba(239,68,68,.52)!important;box-shadow:0 0 0 3px rgba(239,68,68,.10)!important}
.field-hint{font-size:.78rem;margin-top:4px;min-height:16px;transition:all .2s}
.field-hint.ok{color:#4ade80}
.field-hint.err{color:#f87171}

.range-bar{display:flex;gap:6px;align-items:center;margin-top:6px;flex-wrap:wrap}
.range-tag{font-size:.75rem;border-radius:8px;padding:2px 7px;font-weight:850}
.range-tag.lo{background:rgba(34,197,94,.12);color:#86efac;border:1px solid rgba(34,197,94,.25)}
.range-tag.hi{background:rgba(239,68,68,.12);color:#fca5a5;border:1px solid rgba(239,68,68,.25)}

.countdown{margin-top:10px;padding:12px 14px;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);border-radius:12px;border-left:4px solid #f59e0b;color:#fde68a;font-size:.88rem;line-height:1.6}

#zoneWrap{margin-top:12px}
#zmap,#cmap{height:420px;border-radius:12px;border:1px solid rgba(148,163,184,.22);overflow:hidden;max-width:100%;position:relative}
.muni-tooltip{background:#0f172a!important;border:1px solid rgba(56,189,248,.5)!important;border-radius:8px!important;color:#e2e8f0!important;font-size:13px!important;font-weight:800!important;padding:5px 10px!important;box-shadow:0 4px 14px rgba(0,0,0,.5)!important;}
.muni-tooltip::before{display:none!important}
.leaflet-container{font-family:system-ui,sans-serif}
.pchips{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.pchip{border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.75);color:#cbd5e1;border-radius:999px;padding:6px 10px;font-weight:1000;font-size:.85rem;cursor:pointer}
.pchip.on{border-color:#38bdf8;color:#dbeafe}
.pchip.off{opacity:.75}
.legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;padding:10px 12px;background:rgba(2,6,23,.45);border:1px solid rgba(148,163,184,.18);border-radius:12px;color:#bcd0ea;font-size:.86rem;}
.legdot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:middle}
.leg1{background:#38bdf8}.leg2{background:#22c55e}

.chartCard{background:linear-gradient(135deg,rgba(2,6,23,.35),rgba(15,23,42,.35));border:1px solid rgba(148,163,184,.18);border-radius:14px;padding:14px;}
.canvasWrap{border:1px solid rgba(148,163,184,.16);border-radius:12px;overflow:hidden;background:rgba(2,6,23,.45);}
canvas{display:block;width:100%;height:240px}
@media(max-width:700px){canvas{height:220px}}

.chat-container{display:flex;flex-direction:column;height:600px;background:linear-gradient(135deg,rgba(15,23,42,.86),rgba(11,18,32,.92));border:1px solid rgba(148,163,184,.25);border-radius:16px;overflow:hidden;}
.chat-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px;}
.chat-message{display:flex;gap:12px;animation:fadeIn .3s ease-out;}
.chat-message.user{flex-direction:row-reverse;}
.chat-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:14px;flex-shrink:0;}
.chat-avatar.ai{background:var(--gradient-3);color:#001018;}
.chat-avatar.user{background:var(--gradient-4);color:#001018;}
.chat-bubble{max-width:75%;padding:12px 16px;border-radius:16px;line-height:1.6;font-size:.92rem;}
.chat-message.user .chat-bubble{background:rgba(56,189,248,.15);border:1px solid rgba(56,189,248,.25);color:#e5e7eb;}
.chat-message.ai .chat-bubble{background:rgba(148,163,184,.08);border:1px solid rgba(148,163,184,.18);color:#cbd5e1;}
.chat-bubble.thinking{font-style:italic;opacity:.7;animation:typing 1s ease-in-out infinite;}
.chat-input-wrap{padding:16px;background:rgba(2,6,23,.8);border-top:1px solid rgba(148,163,184,.18);display:flex;gap:10px;}
.chat-input{flex:1;padding:12px 14px;border:1px solid rgba(148,163,184,.30);border-radius:12px;background:rgba(2,6,23,.86);color:var(--t);outline:none;transition:all .18s ease;font-size:.95rem;font-family:inherit;resize:none;min-height:44px;max-height:120px;}
.chat-input:focus{border-color:#38bdf8;box-shadow:0 0 0 4px rgba(56,189,248,.14);}
.chat-send-btn{padding:12px 20px;background:var(--gradient-3);color:#001018;border:0;border-radius:12px;cursor:pointer;font-weight:900;transition:all .18s ease;box-shadow:0 4px 15px rgba(56,189,248,.28);white-space:nowrap;}
.chat-send-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(56,189,248,.42);}
.chat-send-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.suggestion-chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
.suggestion-chip{padding:6px 12px;background:rgba(56,189,248,.1);border:1px solid rgba(56,189,248,.25);border-radius:999px;color:#7dd3fc;font-size:.82rem;cursor:pointer;transition:all .18s ease;}
.suggestion-chip:hover{background:rgba(56,189,248,.18);transform:translateY(-1px);}
::selection{background:rgba(56,189,248,.25)}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
</head>
<body>
<div class="w" id="hx">

  <div class="c hrow">
    <div class="pill" data-i="hdrTitle">Assessoria d'Habitatge ¬∑ Baix Pened√®s</div>
    <div class="r" style="justify-content:flex-end;flex:1">
      <div class="n" data-i="hdrHint">Ejemplos reales: solo despu√©s de Analizar.</div>
      <div class="lang" aria-label="Idioma">
        <button class="langbtn" id="L_CA" type="button">CA</button>
        <button class="langbtn a" id="L_ES" type="button">ES</button>
        <button class="langbtn" id="L_EN" type="button">EN</button>
      </div>
    </div>
  </div>

  <div class="steps" id="stepBar">
    <div class="step active" id="stp1"><div class="step-dot" id="sdot1">1</div><div class="step-label" id="slbl1">Personal</div><div class="step-line"></div></div>
    <div class="step" id="stp2"><div class="step-dot" id="sdot2">2</div><div class="step-label" id="slbl2">Econom√≠a</div><div class="step-line"></div></div>
    <div class="step" id="stp3"><div class="step-dot" id="sdot3">3</div><div class="step-label" id="slbl3">Preferencias</div><div class="step-line"></div></div>
    <div class="step" id="stp4"><div class="step-dot" id="sdot4">4</div><div class="step-label" id="slbl4">Resultado</div></div>
  </div>

  <div class="tabs">
    <div id="t_p" class="tab a" data-i="tab1">1 Personal</div>
    <div id="t_e" class="tab" data-i="tab2">2 Econom√≠a</div>
    <div id="t_f" class="tab" data-i="tab3">3 Preferencias</div>
    <div id="t_r" class="tab dis" data-i="tab4">4 Resultado</div>
    <div id="t_m" class="tab dis" data-i="tab5">5 Comparador</div>
    <div id="t_x" class="tab dis" data-i="tab6">6 Ejemplos reales</div>
    <div id="t_ai" class="tab dis" data-i="tab7">ü§ñ AI Advisor</div>
  </div>

  <!-- 1 Personal -->
  <div class="c" data-p="p">
    <div class="g">
      <div><label data-i="lblName">Nombre y apellidos</label><input id="nm" type="text" autocomplete="name"></div>
      <div><label data-i="lblAge">Edad (18‚Äì100)</label><input id="ag" type="number" min="18" max="100"></div>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintP">Rellena los datos b√°sicos para continuar.</div></div>
    <div class="r" style="margin-top:10px"><button class="b" id="np" type="button" data-i="btnContinue">Continuar</button></div>
  </div>

  <!-- 2 Econom√≠a -->
  <div class="c" data-p="e" style="display:none">
    <div class="g">
      <div>
        <label data-i="lblInc">Ingresos mensuales (‚Ç¨)</label>
        <div class="tip">
          <input id="inc" type="number" min="0">
          <span class="tip-icon" tabindex="0">i</span>
          <span class="tip-box" data-i="tipInc"></span>
        </div>
        <div class="field-hint" id="hint-inc"></div>
      </div>
      <div>
        <label data-i="lblSav">Ahorros disponibles (‚Ç¨)</label>
        <div class="tip">
          <input id="sav" type="number" min="0">
          <span class="tip-icon" tabindex="0">i</span>
          <span class="tip-box" data-i="tipSav"></span>
        </div>
        <div class="field-hint" id="hint-sav"></div>
      </div>
      <div><label data-i="lblYrs">A√±os de hipoteca (5‚Äì40)</label><input id="yrs" type="number" min="5" max="40" value="25"></div>
      <div><label data-i="lblHor">¬øVivir√°s m√°s de 5 a√±os aqu√≠?</label><select id="hor"><option value="y" data-i="yes">S√≠</option><option value="n" data-i="no">No</option></select></div>
      <div><label data-i="lblFst">¬øPrimera vivienda o familia con menores?</label><select id="fst"><option value="y" data-i="yes">S√≠</option><option value="n" data-i="no">No</option></select></div>
      <div>
        <label data-i="lblMsv">Ahorro mensual (‚Ç¨)</label>
        <div class="tip">
          <input id="msv" type="number" min="0">
          <span class="tip-icon" tabindex="0">i</span>
          <span class="tip-box" data-i="tipMsv"></span>
        </div>
      </div>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintE">Completa econom√≠a y sigue a preferencias.</div></div>
    <div class="r" style="margin-top:10px"><button class="b" id="ne" type="button" data-i="btnContinue">Continuar</button></div>
  </div>

  <!-- 3 Preferencias -->
  <div class="c" data-p="f" style="display:none">
    <div class="g">
      <div>
        <label data-i="lblMuni">Municipio (Baix Pened√®s)</label>
        <select id="ar">
          <option value="*">Cualquiera</option>
          <option>Cunit</option><option>El Vendrell</option><option>Calafell</option><option>Santa Oliva</option><option>Bellvei</option>
          <option>L'Arbo√ß</option><option>Banyeres del Pened√®s</option><option>Albinyana</option><option>Bonastre</option><option>Maslloren√ß</option>
          <option>La Bisbal del Pened√®s</option><option>Lloren√ß del Pened√®s</option><option>Sant Jaume dels Domenys</option><option>El Montmell</option>
        </select>
        <div class="small" style="margin-top:6px" data-i="lblMuniHelp">Si usas el mapa puedes elegir varios municipios.</div>
      </div>
      <div>
        <label data-i="lblM2">Metros cuadrados (‚â•50)</label>
        <input id="m2" type="number" min="50">
        <div class="field-hint" id="hint-m2"></div>
      </div>
      <div><label data-i="lblBed">Habitaciones</label><input id="bed" type="number" min="0" max="10" value="2"></div>
      <div><label data-i="lblBath">Ba√±os</label><input id="bat" type="number" min="1" max="10" value="1"></div>
      <div><label data-i="lblType">Tipo de vivienda</label><select id="ty"><option value="flat" data-i="optFlat">Piso</option><option value="house" data-i="optHouse">Casa</option></select></div>
      <div class="r" style="align-items:flex-start">
        <div style="width:100%">
          <label data-i="lblExtras">Extras (opcional)</label>
          <div class="small" data-i="lblExtrasHint">Cambian el precio estimado y los filtros de ejemplos reales.</div>
          <div class="r" style="margin-top:8px">
            <label><input type="checkbox" id="et"><span data-i="exTer">Terraza</span></label>
            <label><input type="checkbox" id="ep"><span data-i="exPis">Piscina</span></label>
            <label><input type="checkbox" id="el"><span data-i="exAsc">Ascensor</span></label>
            <label><input type="checkbox" id="ek"><span data-i="exGar">Aparcamiento</span></label>
          </div>
        </div>
      </div>
    </div>
    <div class="r" style="margin-top:10px">
      <button class="b" id="go" type="button" data-i="btnAnalyze">Analizar</button>
      <button class="b ok" id="toggleMap" type="button" data-i="btnMap">Mapa (zona real)</button>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintF">Si cambias preferencias, vuelve a Analizar para actualizar el resultado.</div></div>
    <div id="zoneWrap" class="cardx" style="display:none">
      <div class="top">
        <div>
          <div class="title" data-i="zoneTitle">Zona preferida (mapa real)</div>
          <div class="n" data-i="zoneHint">Haz clic en un municipio para seleccionarlo.</div>
          <div class="small" style="color:#64748b;margin-top:3px" data-i="zoneLoadHint">Los l√≠mites se cargan de OpenStreetMap en tiempo real.</div>
          <div class="n" id="zoneNote" style="margin-top:6px">Seleccionados: ninguno</div>
        </div>
        <div class="pchips" id="zoneChips"></div>
      </div>
      <div class="r" style="margin-top:10px;justify-content:flex-end">
        <button class="b" id="zoneClear" type="button" data-i="btnClear">Limpiar</button>
        <button class="b ok" id="zoneApply" type="button" data-i="btnUse">Usar en Ejemplos reales</button>
      </div>
      <div id="zmap" style="margin-top:10px"></div>
      <div class="legend">
        <span><span class="legdot leg1"></span><span data-i="legSel">Seleccionado</span></span>
        <span><span class="legdot leg2"></span><span data-i="legOk">L√≠mites municipales reales</span></span>
      </div>
      <div class="n" id="zoneApplied" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- 4 Resultado -->
  <div class="c" data-p="r" style="display:none">
    <div class="g">
      <div class="k"><span data-i="kPrice">Precio estimado</span><b id="k1">0 ‚Ç¨</b><div class="sub" id="k1sub"></div></div>
      <div class="k"><span data-i="kRent">Alquiler estimado</span><b id="k2">0 ‚Ç¨</b><div class="sub" id="k2sub"></div></div>
      <div class="k"><span data-i="kPay">Cuota hipoteca</span><b id="k3">0 ‚Ç¨</b><div class="sub" id="k3sub"></div></div>
      <div class="k"><span data-i="kRec">Recomendaci√≥n</span><b id="k4">‚Äì</b><div class="sub" id="k4sub"></div></div>
    </div>
    <div id="rCard" class="cardx" style="display:none">
      <div class="top"><div class="title" id="rTitle"></div><div class="chips" id="rChips"></div></div>
      <div class="grid3" id="rMini"></div>
      <div class="grid3" style="margin-top:14px">
        <div class="chartCard">
          <div style="font-weight:950;color:#eaf2ff" data-i="chartEffTitle">Esfuerzo mensual (visual)</div>
          <div class="small" data-i="chartEffHint">L√≠nea: capacidad segura (35% ingresos). Barras: hipoteca vs alquiler.</div>
          <div class="canvasWrap" style="margin-top:10px"><canvas id="effChart"></canvas></div>
        </div>
        <div class="chartCard">
          <div style="font-weight:950;color:#eaf2ff" data-i="chartSensTitle">Sensibilidad (tipo de inter√©s)</div>
          <div class="small" data-i="chartSensHint">C√≥mo cambia la cuota si sube el tipo. No predice el futuro, solo muestra el riesgo.</div>
          <div class="canvasWrap" style="margin-top:10px"><canvas id="sensChart"></canvas></div>
        </div>
        <div class="chartCard">
          <div style="font-weight:950;color:#eaf2ff" data-i="chartTipsTitle">Lectura r√°pida</div>
          <div class="small" id="chartTips"></div>
          <div style="margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.18);background:rgba(2,6,23,.35);color:#cbd5e1;line-height:1.65" id="quickExplain"></div>
        </div>
      </div>
      <div class="body" id="rBody"></div>
      <div class="note" id="rt"></div>
    </div>
    <div class="r" style="margin-top:10px">
      <button class="b" id="cp" type="button" data-i="btnCopy">Copiar resumen</button>
      <button class="b" id="rs" type="button" data-i="btnReset">Reiniciar</button>
      <button class="b ok" id="jumpX" type="button" data-i="btnGoExamples">Ir a Ejemplos reales</button>
      <button class="b ok" id="jumpAI" type="button" data-i="btnAskAI">üí¨ Consultar con AI</button>
    </div>
    <div class="share-bar">
      <button class="share-btn wa" id="shareWa" type="button">üì± WhatsApp</button>
      <button class="share-btn cl" id="shareCl" type="button">üìã <span data-i="btnCopy2">Copiar</span></button>
    </div>
  </div>

  <!-- 5 Comparador -->
  <div class="c" data-p="m" style="display:none">
    <div class="g">
      <div><label data-i="lblProv">Provincia (comparador)</label><select id="cm"><option>Barcelona</option><option>Girona</option><option>Lleida</option><option>Tarragona</option></select></div>
      <div><label data-i="lblM2s">m¬≤</label><input id="cm2" type="number" min="50"></div>
      <div><label data-i="lblBed">Habitaciones</label><input id="cbd" type="number" min="0" max="10"></div>
      <div><label data-i="lblBath">Ba√±os</label><input id="cba" type="number" min="1" max="10"></div>
      <div><label data-i="lblType2">Tipo</label><select id="cty"><option value="flat" data-i="optFlat">Piso</option><option value="house" data-i="optHouse">Casa</option></select></div>
      <div class="r" style="align-items:flex-start">
        <div style="width:100%">
          <label data-i="lblExtras2">Extras (comparador)</label>
          <div class="small" data-i="lblExtrasHint2">Mismas caracter√≠sticas, distinta zona.</div>
          <div class="r" style="margin-top:8px">
            <label><input type="checkbox" id="ct"><span data-i="exTer">Terraza</span></label>
            <label><input type="checkbox" id="cp0"><span data-i="exPis">Piscina</span></label>
            <label><input type="checkbox" id="cl0"><span data-i="exAsc">Ascensor</span></label>
            <label><input type="checkbox" id="ck0"><span data-i="exGar">Aparcamiento</span></label>
          </div>
        </div>
      </div>
    </div>
    <div id="cmap" style="width:100%;height:320px;border:0;border-radius:12px;margin-top:12px"></div>
    <div class="r" style="margin-top:10px">
      <button class="b" id="bc" type="button" data-i="btnCompare">Comparar</button>
      <button class="b ok" id="autoFillCmp" type="button" data-i="btnUseMine">Usar mis datos</button>
    </div>
    <div class="cardx" style="margin-top:12px">
      <div class="top"><div class="title" data-i="cmpTitle">Resultado del comparador</div><div class="chips" id="cmpChips"></div></div>
      <div class="body" id="cmg"></div>
      <div class="chartCard" style="margin-top:14px">
        <div style="font-weight:950;color:#eaf2ff" data-i="cmpChartTitle">Comparaci√≥n visual</div>
        <div class="small" data-i="cmpChartHint">Tu zona vs provincia. Misma vivienda, distinto contexto.</div>
        <div class="canvasWrap" style="margin-top:10px"><canvas id="cmpChart"></canvas></div>
      </div>
    </div>
  </div>

  <!-- 6 Ejemplos reales -->
  <div class="c" data-p="x" style="display:none">
    <div class="n" id="xinfo"></div>
    <div class="r" style="margin-top:10px" id="xbtns"></div>
    <div class="gu"><span class="a">üìç</span><div class="n" data-i="hintX">Si elegiste varios municipios, salen botones por municipio.</div></div>
  </div>

  <!-- 7 AI Advisor -->
  <div class="c" data-p="ai" style="display:none">
    <div class="cardx">
      <div class="top">
        <div class="title">ü§ñ AI Financial Advisor</div>
        <div class="chips"><span class="chip good" id="aiStatus" data-i="aiConnected">Conectado</span></div>
      </div>
      <div class="gu" style="margin-top:0;margin-bottom:16px">
        <span class="a">üí°</span>
        <div class="n"><b>Tu asesor financiero personal.</b> Conoce toda tu situaci√≥n y te da consejos espec√≠ficos.</div>
      </div>
      <div class="suggestion-chips" id="aiSuggestions">
        <div class="suggestion-chip" data-q="¬øQu√© puedo hacer para mejorar mi situaci√≥n?">¬øC√≥mo mejorar?</div>
        <div class="suggestion-chip" data-q="¬øCu√°nto necesito ahorrar mensualmente para comprar?">¬øCu√°nto ahorrar?</div>
        <div class="suggestion-chip" data-q="¬øEs mejor comprar o alquilar en mi caso espec√≠fico?">¬øComprar o alquilar?</div>
        <div class="suggestion-chip" data-q="¬øQu√© municipios del Baix Pened√®s me recomiendas?">¬øQu√© municipios?</div>
        <div class="suggestion-chip" data-q="¬øC√≥mo me afectar√≠a una subida del tipo de inter√©s?">¬øY si sube el tipo?</div>
        <div class="suggestion-chip" data-q="Dame estrategias para aumentar mi capacidad de compra">Estrategias</div>
      </div>
      <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
          <div class="chat-message ai" id="welcome-message">
            <div class="chat-avatar ai">AI</div>
            <div class="chat-bubble" id="welcome-bubble"></div>
          </div>
        </div>
        <div class="chat-input-wrap">
          <textarea class="chat-input" id="chatInput" placeholder="Escribe tu pregunta aqu√≠..." rows="1"></textarea>
          <button class="chat-send-btn" id="chatSend">Enviar</button>
        </div>
      </div>
    </div>
  </div>

</div><!-- /.w -->

<div class="sig">
  <div class="br">Assessoria d'Habitatge</div>
  <div>
    <a href="https://www.assesoriahabitatge.com/" target="_blank" rel="noopener">assesoriahabitatge.com</a> ¬∑
    <a href="/cdn-cgi/l/email-protection#a5cccbc3cae5c4d6d6c0d6cad7ccc4cdc4c7ccd1c4d1c2c08bc6cac8"><span class="__cf_email__" data-cfemail="9af3f4fcf5dafbe9e9ffe9f5e8f3fbf2fbf8f3eefbeefdffb4f9f5f7">[email&#160;protected]</span></a>
  </div>
</div>
<div id="ts" class="tst" role="status" aria-live="polite"></div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
const MUNICIPALITY_POLYGONS=null;

const OSM_IDS={
  "El Vendrell":344765,"Calafell":344673,"Cunit":344699,
  "Bellvei":347721,"Santa Oliva":344769,"Albinyana":344781,
  "L'Arbo√ß":344761,"Lloren√ß del Pened√®s":344757,"Banyeres del Pened√®s":344783,
  "Sant Jaume dels Domenys":344763,"La Bisbal del Pened√®s":344755,
  "Bonastre":344751,"Maslloren√ß":344759,"El Montmell":344753
};
const MUNI_NAMES=Object.keys(OSM_IDS);

// Pol√≠gonos de alta fidelidad basados en cartograf√≠a real ICGC
// Formato [lat, lng] ‚Äî coordenadas geogr√°ficas reales Baix Pened√®s
const FALLBACK_POLYGONS={
"El Vendrell":[
  [41.2355,1.5368],[41.2364,1.5299],[41.2378,1.5231],[41.2404,1.5151],
  [41.2418,1.5085],[41.2413,1.5011],[41.2390,1.4950],[41.2358,1.4894],
  [41.2315,1.4853],[41.2268,1.4824],[41.2220,1.4809],[41.2175,1.4813],
  [41.2132,1.4833],[41.2096,1.4862],[41.2062,1.4899],[41.2024,1.4929],
  [41.1988,1.4944],[41.1962,1.4975],[41.1944,1.5018],[41.1942,1.5067],
  [41.1953,1.5115],[41.1977,1.5157],[41.2010,1.5190],[41.2049,1.5215],
  [41.2096,1.5237],[41.2148,1.5252],[41.2201,1.5259],[41.2253,1.5256],
  [41.2299,1.5243],[41.2336,1.5217],[41.2355,1.5368]],
"Calafell":[
  [41.2049,1.5215],[41.2010,1.5190],[41.1977,1.5157],[41.1953,1.5115],
  [41.1942,1.5067],[41.1944,1.5018],[41.1906,1.5005],[41.1858,1.5009],
  [41.1817,1.5030],[41.1784,1.5064],[41.1762,1.5107],[41.1750,1.5155],
  [41.1746,1.5207],[41.1749,1.5264],[41.1757,1.5323],[41.1768,1.5385],
  [41.1783,1.5449],[41.1803,1.5510],[41.1829,1.5565],[41.1861,1.5608],
  [41.1898,1.5638],[41.1938,1.5652],[41.1972,1.5649],[41.2003,1.5631],
  [41.2025,1.5600],[41.2041,1.5558],[41.2049,1.5504],[41.2050,1.5443],
  [41.2047,1.5379],[41.2049,1.5215]],
"Cunit":[
  [41.2050,1.5443],[41.2049,1.5504],[41.2041,1.5558],[41.2025,1.5600],
  [41.2003,1.5631],[41.2001,1.5675],[41.2003,1.5724],[41.2009,1.5775],
  [41.2020,1.5826],[41.2034,1.5875],[41.2051,1.5916],[41.2066,1.5957],
  [41.2076,1.6002],[41.2080,1.6051],[41.2073,1.6101],[41.2057,1.6147],
  [41.2038,1.6192],[41.2023,1.6239],[41.2016,1.6289],[41.2020,1.6339],
  [41.2034,1.6383],[41.2059,1.6415],[41.2091,1.6432],[41.2126,1.6433],
  [41.2159,1.6419],[41.2183,1.6393],[41.2196,1.6358],[41.2196,1.6317],
  [41.2185,1.6273],[41.2163,1.6232],[41.2135,1.6196],[41.2108,1.6160],
  [41.2087,1.6119],[41.2074,1.6072],[41.2070,1.6022],[41.2075,1.5970],
  [41.2088,1.5921],[41.2104,1.5872],[41.2115,1.5818],[41.2118,1.5762],
  [41.2114,1.5704],[41.2104,1.5650],[41.2090,1.5600],[41.2074,1.5554],
  [41.2063,1.5501],[41.2060,1.5449],[41.2050,1.5443]],
"Bellvei":[
  [41.2253,1.5256],[41.2201,1.5259],[41.2148,1.5252],[41.2096,1.5237],
  [41.2090,1.5600],[41.2104,1.5650],[41.2114,1.5704],[41.2118,1.5762],
  [41.2115,1.5818],[41.2104,1.5872],[41.2088,1.5921],[41.2140,1.5935],
  [41.2185,1.5930],[41.2228,1.5908],[41.2264,1.5869],[41.2284,1.5818],
  [41.2291,1.5759],[41.2285,1.5697],[41.2268,1.5638],[41.2244,1.5581],
  [41.2244,1.5519],[41.2251,1.5456],[41.2261,1.5394],[41.2263,1.5329],
  [41.2253,1.5256]],
"Santa Oliva":[
  [41.2355,1.5368],[41.2336,1.5217],[41.2299,1.5243],[41.2253,1.5256],
  [41.2263,1.5329],[41.2261,1.5394],[41.2251,1.5456],[41.2244,1.5519],
  [41.2295,1.5536],[41.2349,1.5539],[41.2398,1.5524],[41.2441,1.5494],
  [41.2474,1.5450],[41.2493,1.5396],[41.2497,1.5336],[41.2486,1.5278],
  [41.2461,1.5230],[41.2424,1.5194],[41.2384,1.5175],[41.2355,1.5368]],
"Albinyana":[
  [41.2404,1.5151],[41.2378,1.5231],[41.2364,1.5299],[41.2355,1.5368],
  [41.2384,1.5175],[41.2424,1.5194],[41.2461,1.5230],[41.2486,1.5278],
  [41.2527,1.5224],[41.2558,1.5157],[41.2574,1.5081],[41.2573,1.5002],
  [41.2553,1.4930],[41.2517,1.4870],[41.2467,1.4826],[41.2407,1.4802],
  [41.2418,1.5085],[41.2404,1.5151]],
"L'Arbo√ß":[
  [41.2831,1.6063],[41.2808,1.5983],[41.2770,1.5909],[41.2717,1.5845],
  [41.2651,1.5795],[41.2605,1.5771],[41.2568,1.5779],[41.2541,1.5812],
  [41.2526,1.5855],[41.2524,1.5900],[41.2531,1.5947],[41.2546,1.5992],
  [41.2568,1.6034],[41.2597,1.6070],[41.2633,1.6100],[41.2673,1.6122],
  [41.2716,1.6135],[41.2760,1.6136],[41.2800,1.6124],[41.2831,1.6063]],
"Lloren√ß del Pened√®s":[
  [41.2924,1.5828],[41.2920,1.5759],[41.2900,1.5693],[41.2863,1.5637],
  [41.2811,1.5595],[41.2831,1.6063],[41.2800,1.6124],[41.2841,1.6094],
  [41.2876,1.6050],[41.2902,1.5993],[41.2919,1.5927],[41.2924,1.5828]],
"Banyeres del Pened√®s":[
  [41.3020,1.5986],[41.3022,1.5909],[41.3007,1.5833],[41.2975,1.5765],
  [41.2928,1.5708],[41.2924,1.5828],[41.2919,1.5927],[41.2902,1.5993],
  [41.2876,1.6050],[41.2923,1.6101],[41.2975,1.6143],[41.3030,1.6169],
  [41.3086,1.6174],[41.3137,1.6155],[41.3175,1.6114],[41.3193,1.6055],
  [41.3185,1.5990],[41.3153,1.5935],[41.3102,1.5896],[41.3046,1.5877],
  [41.3020,1.5986]],
"Sant Jaume dels Domenys":[
  [41.3185,1.5990],[41.3193,1.6055],[41.3220,1.5992],[41.3236,1.5924],
  [41.3239,1.5851],[41.3226,1.5781],[41.3196,1.5717],[41.3151,1.5663],
  [41.3095,1.5622],[41.3032,1.5597],[41.2966,1.5591],[41.2928,1.5708],
  [41.2975,1.5765],[41.3007,1.5833],[41.3022,1.5909],[41.3020,1.5986],
  [41.3046,1.5877],[41.3102,1.5896],[41.3153,1.5935],[41.3185,1.5990]],
"La Bisbal del Pened√®s":[
  [41.2811,1.5595],[41.2760,1.5553],[41.2700,1.5530],[41.2639,1.5526],
  [41.2580,1.5540],[41.2541,1.5812],[41.2568,1.5779],[41.2605,1.5771],
  [41.2651,1.5795],[41.2717,1.5845],[41.2770,1.5909],[41.2808,1.5983],
  [41.2831,1.6063],[41.2811,1.5595]],
"Bonastre":[
  [41.2220,1.4809],[41.2175,1.4813],[41.2132,1.4833],[41.2096,1.4862],
  [41.2062,1.4899],[41.2024,1.4929],[41.2001,1.4869],[41.1995,1.4800],
  [41.2003,1.4730],[41.2026,1.4665],[41.2061,1.4610],[41.2105,1.4569],
  [41.2155,1.4544],[41.2209,1.4537],[41.2263,1.4550],[41.2311,1.4581],
  [41.2350,1.4627],[41.2376,1.4683],[41.2388,1.4746],[41.2390,1.4812],
  [41.2390,1.4950],[41.2358,1.4894],[41.2315,1.4853],[41.2268,1.4824],
  [41.2220,1.4809]],
"Maslloren√ß":[
  [41.2639,1.5526],[41.2580,1.5540],[41.2524,1.5900],[41.2526,1.5855],
  [41.2541,1.5812],[41.2580,1.5540],[41.2573,1.5002],[41.2553,1.4930],
  [41.2517,1.4870],[41.2467,1.4826],[41.2407,1.4802],[41.2390,1.4812],
  [41.2388,1.4746],[41.2376,1.4683],[41.2409,1.4748],[41.2453,1.4797],
  [41.2506,1.4822],[41.2560,1.4823],[41.2609,1.4799],[41.2648,1.4753],
  [41.2671,1.4691],[41.2676,1.4621],[41.2662,1.4554],[41.2713,1.4621],
  [41.2749,1.4698],[41.2768,1.4783],[41.2769,1.4870],[41.2750,1.4954],
  [41.2712,1.5029],[41.2700,1.5530],[41.2639,1.5526]],
"El Montmell":[
  [41.3239,1.5851],[41.3227,1.5767],[41.3197,1.5689],[41.3150,1.5620],
  [41.3088,1.5564],[41.3018,1.5526],[41.2966,1.5591],[41.3032,1.5597],
  [41.3095,1.5622],[41.3151,1.5663],[41.3196,1.5717],[41.3226,1.5781],
  [41.3239,1.5851],[41.3256,1.5728],[41.3268,1.5597],[41.3271,1.5460],
  [41.3263,1.5322],[41.3241,1.5193],[41.3202,1.5078],[41.3147,1.4983],
  [41.3078,1.4914],[41.2997,1.4878],[41.2908,1.4879],[41.2825,1.4915],
  [41.2752,1.4981],[41.2712,1.5029],[41.2750,1.4954],[41.2769,1.4870],
  [41.2768,1.4783],[41.2749,1.4698],[41.2713,1.4621],[41.2790,1.4558],
  [41.2876,1.4521],[41.2966,1.4512],[41.3053,1.4533],[41.3131,1.4583],
  [41.3196,1.4656],[41.3244,1.4747],[41.3271,1.4849],[41.3275,1.4960],
  [41.3266,1.5070],[41.3256,1.5178],[41.3256,1.5290],[41.3256,1.5402],
  [41.3252,1.5513],[41.3244,1.5622],[41.3239,1.5728],[41.3239,1.5851]]
};
let _attempts=0;
function waitForLeaflet(){
  if(typeof L!=="undefined") initApp();
  else if(_attempts++<100) setTimeout(waitForLeaflet,50);
  else alert("Error: no se pudo cargar el mapa. Recarga la p√°gina.");
}

function initApp(){(()=>{
const Q=s=>document.querySelector(s);
const QA=s=>[...document.querySelectorAll(s)];
const fmtES=n=>Math.round(n).toLocaleString("es-ES");
const fmtEN=n=>Math.round(n).toLocaleString("en-US");

const STORE_KEY="hx_form_v9",ZONE_KEY="hx_zoneSel_v6",LANG_KEY="hx_lang",CHAT_KEY="hx_chat_v3";

/* ============================
   I18N
   ============================ */
const I18N={
ES:{hdrTitle:"Assessoria d'Habitatge ¬∑ Baix Pened√®s",hdrHint:"Ejemplos reales: solo despu√©s de Analizar.",tab1:"1 Personal",tab2:"2 Econom√≠a",tab3:"3 Preferencias",tab4:"4 Resultado",tab5:"5 Comparador",tab6:"6 Ejemplos reales",tab7:"ü§ñ AI Advisor",lblName:"Nombre y apellidos",lblAge:"Edad (18‚Äì100)",btnContinue:"Continuar",hintP:"Rellena los datos b√°sicos para continuar.",lblInc:"Ingresos mensuales (‚Ç¨)",lblSav:"Ahorros disponibles (‚Ç¨)",lblYrs:"A√±os de hipoteca (5‚Äì40)",lblHor:"¬øVivir√°s m√°s de 5 a√±os aqu√≠?",lblFst:"¬øPrimera vivienda o familia con menores?",lblMsv:"Ahorro mensual (‚Ç¨)",tipInc:"Ingresos netos (lo que realmente entra en tu cuenta). Si metes bruto, la recomendaci√≥n se distorsiona.",tipSav:"Solo lo que puedes usar de verdad. Entrada + impuestos + notar√≠a van aqu√≠.",tipMsv:"Sirve para estimar cu√°nto tardas en llegar al cash necesario si hoy no te da.",hintE:"Completa econom√≠a y sigue a preferencias.",lblMuni:"Municipio (Baix Pened√®s)",lblMuniHelp:"Usa el mapa para elegir varios municipios.",lblM2:"Metros cuadrados (‚â•50)",lblBed:"Habitaciones",lblBath:"Ba√±os",lblType:"Tipo de vivienda",optFlat:"Piso",optHouse:"Casa",lblExtras:"Extras (opcional)",lblExtrasHint:"Cambian el precio estimado y los filtros de ejemplos reales.",exTer:"Terraza",exPis:"Piscina",exAsc:"Ascensor",exGar:"Aparcamiento",exSto:"Trastero",exGarD:"Jard√≠n",exAir:"Aire acondicionado",btnAnalyze:"Analizar",btnMap:"Mapa (zona real)",hintF:"Si cambias preferencias, vuelve a Analizar.",zoneTitle:"Zona preferida (mapa real)",zoneHint:"Haz clic en un municipio para seleccionarlo.",btnClear:"Limpiar",btnUse:"Usar en Ejemplos reales",legSel:"Seleccionado",legOk:"L√≠mites reales",kPrice:"Precio estimado",kRent:"Alquiler estimado",kPay:"Cuota hipoteca",kRec:"Recomendaci√≥n",btnCopy:"Copiar resumen",btnReset:"Reiniciar",btnGoExamples:"Ir a Ejemplos reales",btnAskAI:"üí¨ Consultar con AI",chartEffTitle:"Esfuerzo mensual (visual)",chartEffHint:"L√≠nea: capacidad segura (35% ingresos). Barras: hipoteca vs alquiler.",chartSensTitle:"Sensibilidad (tipo de inter√©s)",chartSensHint:"C√≥mo cambia la cuota si sube el tipo. No predice el futuro.",chartTipsTitle:"Lectura r√°pida",lblProv:"Provincia (comparador)",lblM2s:"m¬≤",lblType2:"Tipo",btnCompare:"Comparar",btnUseMine:"Usar mis datos",lblExtras2:"Extras (comparador)",lblExtrasHint2:"Mismas caracter√≠sticas, distinta zona.",cmpTitle:"Resultado del comparador",cmpChartTitle:"Comparaci√≥n visual",cmpChartHint:"Tu zona vs provincia. Misma vivienda, distinto contexto.",hintX:"Si elegiste varios municipios, salen botones por municipio.",yes:"S√≠",no:"No",recBuy:"COMPRAR",recRent:"ALQUILAR",recNotFeasible:"NO FACTIBLE",toastCheck:"Revisa nombre/edad y que m¬≤/ba√±os sean v√°lidos.",toastFirst:"Primero analiza.",toastPrefs:"Preferencias cambiadas: vuelve a Analizar.",toastNoLink:"No se pudo generar el link",toastCopied:"Copiado",toastZoneCleared:"Zona limpiada",toastNoZone:"No hay municipios seleccionados",toastZoneApplied:"Zona aplicada",stateReady:"‚úÖ Disponible",stateNeed:"‚õî Requiere Analizar",xInfo:"Municipio: {muni} ¬∑ Estado: {state}",sumTitle:"Resumen ¬∑ {rec}",chipMort:"Esfuerzo hipoteca: {pct}",chipRent:"Esfuerzo alquiler: {pct}",chipCash:"Cash necesario: {eur}",chipRate:"Tipo: {rate}",miniPrice:"Precio estimado",miniPay:"Cuota hipoteca",miniRent:"Alquiler estimado",savingsOk:"‚úÖ Ahorros suficientes para entrada + costes.",yearsToSave:"Ahorrando {msv}/mes, llegar√°s al objetivo en ~{yrs} a√±os ({mos} meses).",itpNote:"En Catalunya la compra implica ~10% ITP + notar√≠a/registro. Aqu√≠ se incluye como 'gastos'.",avgZone:"Media de {n} municipios",stepPersonal:"Personal",stepEco:"Econom√≠a",stepPref:"Preferencias",stepRes:"Resultado",cmpCheaper:"m√°s barato",cmpExpensive:"m√°s caro",cmpSame:"igual",cmpExplTitle:"Interpretaci√≥n",any:"Cualquiera",btnCopy2:"Copiar",missingDataCmp:"Completa provincia, m¬≤ y ba√±os (m√≠nimo 1).",aiWelcome:"üëã ¬°Hola! Soy tu asesor financiero personal. Conozco tu an√°lisis completo y estoy aqu√≠ para ayudarte. ¬øEn qu√© puedo ayudarte?",aiThinking:"Analizando...",aiYou:"T√ö",aiPlaceholder:"Escribe tu pregunta aqu√≠...",aiSend:"Enviar",aiSug1:"¬øQu√© puedo hacer para mejorar mi situaci√≥n?",aiSug2:"¬øCu√°nto necesito ahorrar mensualmente para comprar?",aiSug3:"¬øEs mejor comprar o alquilar en mi caso espec√≠fico?",aiSug4:"¬øQu√© municipios del Baix Pened√®s me recomiendas?",aiSug5:"¬øC√≥mo me afectar√≠a una subida del tipo de inter√©s?",aiSug6:"Dame estrategias para aumentar mi capacidad de compra",aiSugLbl1:"¬øC√≥mo mejorar?",aiSugLbl2:"¬øCu√°nto ahorrar?",aiSugLbl3:"¬øComprar o alquilar?",aiSugLbl4:"¬øQu√© municipios?",aiSugLbl5:"¬øY si sube el tipo?",aiSugLbl6:"Estrategias",aiErrAuth:"Error de autenticaci√≥n con la API.",aiErrRate:"Demasiadas peticiones. Espera un momento.",aiErrNet:"Error al conectar. Intenta de nuevo.",aiConnected:"Conectado",zoneLoadHint:"Los l√≠mites se cargan de OpenStreetMap en tiempo real."},
CA:{hdrTitle:"Assessoria d'Habitatge ¬∑ Baix Pened√®s",hdrHint:"Exemples reals: nom√©s despr√©s d'Analitzar.",tab1:"1 Personal",tab2:"2 Economia",tab3:"3 Prefer√®ncies",tab4:"4 Resultat",tab5:"5 Comparador",tab6:"6 Exemples reals",tab7:"ü§ñ AI Advisor",lblName:"Nom i cognoms",lblAge:"Edat (18‚Äì100)",btnContinue:"Continuar",hintP:"Omple les dades b√†siques per continuar.",lblInc:"Ingressos mensuals (‚Ç¨)",lblSav:"Estalvis disponibles (‚Ç¨)",lblYrs:"Anys d'hipoteca (5‚Äì40)",lblHor:"Viur√†s m√©s de 5 anys aqu√≠?",lblFst:"Primera vivenda o fam√≠lia amb menors?",lblMsv:"Estalvi mensual (‚Ç¨)",tipInc:"Ingressos nets (el que entra al compte).",tipSav:"Nom√©s el que pots usar de veritat.",tipMsv:"Per estimar quant tardes a arribar al cash necessari.",hintE:"Completa economia i passa a prefer√®ncies.",lblMuni:"Municipi (Baix Pened√®s)",lblMuniHelp:"Usa el mapa per triar diversos municipis.",lblM2:"Metres quadrats (‚â•50)",lblBed:"Habitacions",lblBath:"Banys",lblType:"Tipus d'habitatge",optFlat:"Pis",optHouse:"Casa",lblExtras:"Extres (opcional)",lblExtrasHint:"Canvien el preu estimat i els filtres dels exemples reals.",exTer:"Terrassa",exPis:"Piscina",exAsc:"Ascensor",exGar:"Aparcament",exSto:"Traster",exGarD:"Jard√≠",exAir:"Aire condicionat",btnAnalyze:"Analitzar",btnMap:"Mapa (zona real)",hintF:"Si canvies prefer√®ncies, torna a Analitzar.",zoneTitle:"Zona preferida (mapa real)",zoneHint:"Clica un municipi per seleccionar-lo.",btnClear:"Netejar",btnUse:"Usar a Exemples reals",legSel:"Seleccionat",legOk:"L√≠mits reals",kPrice:"Preu estimat",kRent:"Lloguer estimat",kPay:"Quota hipoteca",kRec:"Recomanaci√≥",btnCopy:"Copiar resum",btnReset:"Reiniciar",btnGoExamples:"Anar a Exemples reals",btnAskAI:"üí¨ Consultar amb AI",chartEffTitle:"Esfor√ß mensual (visual)",chartEffHint:"L√≠nia: capacitat segura (35% ingressos). Barres: hipoteca vs lloguer.",chartSensTitle:"Sensibilitat (tipus d'inter√®s)",chartSensHint:"Com canvia la quota si puja el tipus.",chartTipsTitle:"Lectura r√†pida",lblProv:"Prov√≠ncia (comparador)",lblM2s:"m¬≤",lblType2:"Tipus",btnCompare:"Comparar",btnUseMine:"Usar les meves dades",lblExtras2:"Extres (comparador)",lblExtrasHint2:"Mateixes caracter√≠stiques, zona diferent.",cmpTitle:"Resultat del comparador",cmpChartTitle:"Comparaci√≥ visual",cmpChartHint:"La teva zona vs prov√≠ncia. Mateixa vivenda, context diferent.",hintX:"Si has triat diversos municipis, surten botons per municipi.",yes:"S√≠",no:"No",recBuy:"COMPRAR",recRent:"LLOGAR",recNotFeasible:"NO FACTIBLE",toastCheck:"Revisa nom/edat i que m¬≤/banys siguin v√†lids.",toastFirst:"Primer analitza.",toastPrefs:"Prefer√®ncies canviades: torna a Analitzar.",toastNoLink:"No s'ha pogut generar l'enlla√ß",toastCopied:"Copiat",toastZoneCleared:"Zona netejada",toastNoZone:"No hi ha municipis seleccionats",toastZoneApplied:"Zona aplicada",stateReady:"‚úÖ Disponible",stateNeed:"‚õî Cal Analitzar",xInfo:"Municipi: {muni} ¬∑ Estat: {state}",sumTitle:"Resum ¬∑ {rec}",chipMort:"Esfor√ß hipoteca: {pct}",chipRent:"Esfor√ß lloguer: {pct}",chipCash:"Cash necessari: {eur}",chipRate:"Tipus: {rate}",miniPrice:"Preu estimat",miniPay:"Quota hipoteca",miniRent:"Lloguer estimat",savingsOk:"‚úÖ Estalvis suficients per a entrada + despeses.",yearsToSave:"Estalviant {msv}/mes, arribar√†s a l'objectiu en ~{yrs} anys ({mos} mesos).",itpNote:"A Catalunya la compra implica ~10% ITP + notaria/registre.",avgZone:"Mitjana de {n} municipis",stepPersonal:"Personal",stepEco:"Economia",stepPref:"Prefer√®ncies",stepRes:"Resultat",cmpCheaper:"m√©s barat",cmpExpensive:"m√©s car",cmpSame:"igual",cmpExplTitle:"Interpretaci√≥",any:"Qualsevol",btnCopy2:"Copiar",missingDataCmp:"Completa prov√≠ncia, m¬≤ i banys (m√≠nim 1).",aiWelcome:"üëã Hola! Soc el teu assessor financer personal. Conec el teu an√†lisi complet i estic aqu√≠ per ajudar-te. En qu√® et puc ajudar?",aiThinking:"Analitzant...",aiYou:"TU",aiPlaceholder:"Escriu la teva pregunta aqu√≠...",aiSend:"Enviar",aiSug1:"Qu√® puc fer per millorar la meva situaci√≥?",aiSug2:"Quant necessito estalviar mensualment per comprar?",aiSug3:"√âs millor comprar o llogar en el meu cas espec√≠fic?",aiSug4:"Quins municipis del Baix Pened√®s em recomanes?",aiSug5:"Com m'afectaria una pujada del tipus d'inter√®s?",aiSug6:"Dona'm estrat√®gies per augmentar la meva capacitat de compra",aiSugLbl1:"Com millorar?",aiSugLbl2:"Quant estalviar?",aiSugLbl3:"Comprar o llogar?",aiSugLbl4:"Quins municipis?",aiSugLbl5:"I si puja el tipus?",aiSugLbl6:"Estrat√®gies",aiErrAuth:"Error d'autenticaci√≥ amb l'API.",aiErrRate:"Massa peticions. Espera un moment.",aiErrNet:"Error en connectar. Torna-ho a intentar.",aiConnected:"Connectat",zoneLoadHint:"Els l√≠mits es carreguen d'OpenStreetMap en temps real."},
EN:{hdrTitle:"Housing Advisor ¬∑ Baix Pened√®s",hdrHint:"Real examples: only after Analyze.",tab1:"1 Personal",tab2:"2 Finance",tab3:"3 Preferences",tab4:"4 Result",tab5:"5 Comparator",tab6:"6 Real examples",tab7:"ü§ñ AI Advisor",lblName:"Full name",lblAge:"Age (18‚Äì100)",btnContinue:"Continue",hintP:"Fill in the basics to continue.",lblInc:"Monthly income (‚Ç¨)",lblSav:"Available savings (‚Ç¨)",lblYrs:"Mortgage years (5‚Äì40)",lblHor:"Living here > 5 years?",lblFst:"First home or family with minors?",lblMsv:"Monthly savings (‚Ç¨)",tipInc:"Net income (what actually hits your bank account).",tipSav:"Only what you can truly use.",tipMsv:"Used to estimate how long it takes to reach the needed cash.",hintE:"Complete finance and move to preferences.",lblMuni:"Town (Baix Pened√®s)",lblMuniHelp:"Use the map to pick multiple towns.",lblM2:"Square meters (‚â•50)",lblBed:"Bedrooms",lblBath:"Bathrooms",lblType:"Property type",optFlat:"Flat",optHouse:"House",lblExtras:"Extras (optional)",lblExtrasHint:"They change the price estimate and real-example filters.",exTer:"Terrace",exPis:"Pool",exAsc:"Elevator",exGar:"Parking",exSto:"Storage",exGarD:"Garden",exAir:"Air conditioning",btnAnalyze:"Analyze",btnMap:"Map (real area)",hintF:"If you change preferences, analyze again.",zoneTitle:"Preferred area (real map)",zoneHint:"Click a municipality to select it.",btnClear:"Clear",btnUse:"Use in Real examples",legSel:"Selected",legOk:"Real boundaries",kPrice:"Estimated price",kRent:"Estimated rent",kPay:"Mortgage payment",kRec:"Recommendation",btnCopy:"Copy summary",btnReset:"Reset",btnGoExamples:"Go to Real examples",btnAskAI:"üí¨ Ask AI",chartEffTitle:"Monthly effort (visual)",chartEffHint:"Line: safe capacity (35% of income). Bars: mortgage vs rent.",chartSensTitle:"Sensitivity (interest rate)",chartSensHint:"How payment changes if rates rise.",chartTipsTitle:"Quick read",lblProv:"Province (comparator)",lblM2s:"m¬≤",lblType2:"Type",btnCompare:"Compare",btnUseMine:"Use my data",lblExtras2:"Extras (comparator)",lblExtrasHint2:"Same features, different area.",cmpTitle:"Comparator result",cmpChartTitle:"Visual comparison",cmpChartHint:"Your area vs province. Same home, different context.",hintX:"If you chose multiple towns, you get buttons per town.",yes:"Yes",no:"No",recBuy:"BUY",recRent:"RENT",recNotFeasible:"NOT FEASIBLE",toastCheck:"Check name/age and ensure m¬≤/bathrooms are valid.",toastFirst:"Analyze first.",toastPrefs:"Preferences changed: analyze again.",toastNoLink:"Could not generate the link",toastCopied:"Copied",toastZoneCleared:"Area cleared",toastNoZone:"No towns selected",toastZoneApplied:"Area applied",stateReady:"‚úÖ Ready",stateNeed:"‚õî Please Analyze",xInfo:"Town: {muni} ¬∑ Status: {state}",sumTitle:"Summary ¬∑ {rec}",chipMort:"Mortgage effort: {pct}",chipRent:"Rent effort: {pct}",chipCash:"Cash needed: {eur}",chipRate:"Rate: {rate}",miniPrice:"Estimated price",miniPay:"Mortgage payment",miniRent:"Estimated rent",savingsOk:"‚úÖ Savings cover down payment + costs.",yearsToSave:"Saving {msv}/mo, you'll reach the goal in ~{yrs} years ({mos} months).",itpNote:"In Catalunya, purchase implies ~10% tax + notary/registry.",avgZone:"Average of {n} towns",stepPersonal:"Personal",stepEco:"Finance",stepPref:"Preferences",stepRes:"Result",cmpCheaper:"cheaper",cmpExpensive:"more expensive",cmpSame:"the same",cmpExplTitle:"Interpretation",any:"Any",btnCopy2:"Copy",missingDataCmp:"Complete province, m¬≤ and bathrooms (min 1).",aiWelcome:"üëã Hello! I'm your personal financial advisor. I know your full analysis and I'm here to help. What would you like to know?",aiThinking:"Analyzing...",aiYou:"YOU",aiPlaceholder:"Type your question here...",aiSend:"Send",aiSug1:"What can I do to improve my situation?",aiSug2:"How much do I need to save monthly to buy?",aiSug3:"Is it better to buy or rent in my specific case?",aiSug4:"Which towns in Baix Pened√®s do you recommend?",aiSug5:"How would a rate increase affect me?",aiSug6:"Give me strategies to increase my buying power",aiSugLbl1:"How to improve?",aiSugLbl2:"How much to save?",aiSugLbl3:"Buy or rent?",aiSugLbl4:"Which towns?",aiSugLbl5:"If rates rise?",aiSugLbl6:"Strategies",aiErrAuth:"Authentication error with the API.",aiErrRate:"Too many requests. Please wait.",aiErrNet:"Connection error. Please try again.",aiConnected:"Connected",zoneLoadHint:"Boundaries loaded live from OpenStreetMap."}
};

let LANG=localStorage.getItem(LANG_KEY)||"ES";
const t=k=>(I18N[LANG]&&I18N[LANG][k])||I18N.ES[k]||k;
const tpl=(s,v)=>String(s||"").replace(/\{(\w+)\}/g,(_,k)=>(v&&v[k]!=null)?v[k]:"");
const fmtMoney=n=>!isFinite(n)?"‚Äì":((LANG==="EN"?fmtEN(n):fmtES(n))+" ‚Ç¨");
const fmtPct=n=>Number(n).toFixed(1)+"%";
const toast=m=>{const e=Q("#ts");e.textContent=m;e.classList.add("s");setTimeout(()=>e.classList.remove("s"),1900)};

const applyI18n=()=>{
  QA("[data-i]").forEach(el=>{const v=t(el.getAttribute("data-i"));if(v)el.textContent=v;});
  // Welcome bubble
  const wb=Q("#welcome-bubble");if(wb)wb.textContent=t("aiWelcome");
  // Input placeholder
  const ci=Q("#chatInput");if(ci)ci.placeholder=t("aiPlaceholder");
  // Send button
  const sb=Q("#chatSend");if(sb)sb.textContent=t("aiSend");
  // AI status chip
  const ais=Q("#aiStatus");if(ais)ais.textContent=t("aiConnected");
  // Suggestion chips
  const scs=Q("#aiSuggestions");
  if(scs){scs.innerHTML=[1,2,3,4,5,6].map(i=>`<div class="suggestion-chip" data-q="${t("aiSug"+i)}">${t("aiSugLbl"+i)}</div>`).join("");}
};
const setLang=l=>{
  LANG=l;localStorage.setItem(LANG_KEY,l);
  document.documentElement.lang=l==="CA"?"ca":l==="ES"?"es":"en";
  Q("#L_CA").classList.toggle("a",l==="CA");
  Q("#L_ES").classList.toggle("a",l==="ES");
  Q("#L_EN").classList.toggle("a",l==="EN");
  applyI18n(); renderZoneUI(); renderResult(); refreshExamplesUI();
  updateSteps(Q("[data-p][style*='block']")?.getAttribute("data-p")||"p");
  liveValidate();
};

/* ============================
   PERSISTENCIA
   ============================ */
const FIELDS_NUM=["ag","inc","sav","yrs","msv","m2","bed","bat","cm2","cbd","cba"];
const FIELDS_SEL=["ar","ty","hor","fst","cm","cty"];
const FIELDS_CHK=["et","ep","el","ek","ct","cp0","cl0","ck0"];
const loadForm=()=>{try{const d=JSON.parse(localStorage.getItem(STORE_KEY)||"null");if(!d)return;FIELDS_NUM.forEach(id=>{if(d[id]!=null&&Q("#"+id))Q("#"+id).value=d[id];});FIELDS_SEL.forEach(id=>{if(d[id]!=null&&Q("#"+id))Q("#"+id).value=d[id];});FIELDS_CHK.forEach(id=>{if(Q("#"+id)&&d[id]!=null)Q("#"+id).checked=!!d[id];});if(d.nm&&Q("#nm"))Q("#nm").value=d.nm;}catch(e){}};
const saveForm=()=>{try{const d={};FIELDS_NUM.forEach(id=>{if(Q("#"+id))d[id]=Q("#"+id).value;});FIELDS_SEL.forEach(id=>{if(Q("#"+id))d[id]=Q("#"+id).value;});FIELDS_CHK.forEach(id=>{if(Q("#"+id))d[id]=Q("#"+id).checked?1:0;});if(Q("#nm"))d.nm=Q("#nm").value;localStorage.setItem(STORE_KEY,JSON.stringify(d));}catch(e){}};

/* ============================
   PASOS
   ============================ */
const updateSteps=p=>{
  const m={p:1,e:2,f:3,r:4,m:4,x:4,ai:4};
  const cur=m[p]||1;
  [1,2,3,4].forEach(i=>{const s=Q("#stp"+i);if(!s)return;s.classList.remove("active","done");if(i<cur)s.classList.add("done");else if(i===cur)s.classList.add("active");});
  [t("stepPersonal"),t("stepEco"),t("stepPref"),t("stepRes")].forEach((l,i)=>{const el=Q("#slbl"+(i+1));if(el)el.textContent=l;});
};
const show=p=>{
  QA("[data-p]").forEach(x=>x.style.display=x.getAttribute("data-p")===p?"block":"none");
  ["p","e","f","r","m","x","ai"].forEach(k=>Q("#t_"+k)?.classList.toggle("a",p===k));
  updateSteps(p);
  if(p==="m")setTimeout(upMap,100);
  if(p==="x")refreshExamplesUI();
  if(p==="ai")setTimeout(initChatUI,100);
  window.scrollTo({top:0,behavior:"smooth"});
};

/* ============================
   C√ÅLCULOS
   ============================ */
const mort=(c,r,y)=>{const m=r/12,n=y*12;return r===0?c/n:c*(m*Math.pow(1+m,n))/(Math.pow(1+m,n)-1);};
const COEF={"Cunit":{c:1.157,r:.975},"El Vendrell":{c:.912,r:.842},"Calafell":{c:.856,r:.983},"Santa Oliva":{c:.783,r:.825},"Bellvei":{c:.783,r:.925},"L'Arbo√ß":{c:.735,r:.883},"Banyeres del Pened√®s":{c:.614,r:.783},"Albinyana":{c:.766,r:.825},"Bonastre":{c:.497,r:.683},"Maslloren√ß":{c:.549,r:.75},"La Bisbal del Pened√®s":{c:.623,r:.808},"Lloren√ß del Pened√®s":{c:.856,r:.65},"Sant Jaume dels Domenys":{c:.614,r:.65},"El Montmell":{c:.529,r:.675}};
const BASE={m2:2000,rent:10,close:.11,rate:.0299};
const M={"Barcelona":{v:2986,l:21.9},"Girona":{v:2608,l:14.99},"Lleida":{v:1486,l:9.5},"Tarragona":{v:2100,l:13.5}};

const xBuy=(base,e)=>{let x=0;if(e.t)x+=base*.05;if(e.p)x+=base*.08;if(e.l)x+=base*.04;if(e.k)x+=base*.03;return x;};
const xRent=(base,e)=>{let x=0;if(e.t)x+=base*.15;if(e.p)x+=base*.30;if(e.l)x+=base*.08;if(e.k)x+=base*.07;return x;};
const buy=(a,m2,b,ba,e)=>{const base=m2*BASE.m2*(COEF[a]?.c||1),adj=b*5e3+ba*3e3;return Math.round(base+adj+xBuy(base,e));};
const rent=(a,m2,b,ba,e)=>{const base=m2*BASE.rent*(COEF[a]?.r||1),adj=b*50+ba*30;return Math.round(base+adj+xRent(base,e));};
const buyM=(m,m2,b,ba,e)=>{const p=M[m];if(!p)return NaN;const base=m2*p.v,adj=b*5e3+ba*3e3;return Math.round(base+adj+xBuy(base,e));};
const rentM=(m,m2,b,ba,e)=>{const p=M[m];if(!p)return NaN;const base=m2*p.l,adj=b*50+ba*30;return Math.round(base+adj+xRent(base,e));};

let last=null,lastReq=null,lastReqSig="";
const reqFromUI=()=>({muni:Q("#ar").value,type:Q("#ty").value,m2:+Q("#m2").value||null,bed:Q("#bed").value===""?null:+Q("#bed").value,bath:+Q("#bat").value||null,ex:{t:Q("#et").checked?1:0,p:Q("#ep").checked?1:0,l:Q("#el").checked?1:0,k:Q("#ek").checked?1:0}});
const sigOfReq=r=>[r.muni,r.type,r.m2,r.bed,r.bath,r.ex.t,r.ex.p,r.ex.l,r.ex.k].join("|");
const prefsChanged=()=>!lastReq||sigOfReq(reqFromUI())!==lastReqSig;
const setTabsEnabled=()=>["#t_r","#t_m","#t_x","#t_ai"].forEach(id=>Q(id)?.classList.toggle("dis",!lastReq));

const typeLabel=ty=>ty==="flat"?t("optFlat"):t("optHouse");
const muniLabel=muni=>{if(muni==="*")return t("any");if(muni==="__multi__")return[...zoneSel].join(", ");return muni;};

/* ============================
   CANVAS CHARTS
   ============================ */
const dpr=()=>window.devicePixelRatio||1;
const setupCanvas=cv=>{const r=dpr(),rect=cv.getBoundingClientRect();cv.width=Math.max(320,Math.round(rect.width*r));cv.height=Math.max(220,Math.round(rect.height*r));const ctx=cv.getContext("2d");ctx.setTransform(r,0,0,r,0,0);return ctx;};
const clearGrid=(ctx,w,h)=>{ctx.clearRect(0,0,w,h);ctx.globalAlpha=1;ctx.lineWidth=1;ctx.strokeStyle="rgba(148,163,184,.12)";for(let i=0;i<6;i++){const y=14+i*(h-28)/5;ctx.beginPath();ctx.moveTo(12,y);ctx.lineTo(w-12,y);ctx.stroke();}};
const drawTxt=(ctx,txt,x,y,sz,clr,align)=>{ctx.fillStyle=clr||"#cbd5e1";ctx.font=`${sz||12}px system-ui,sans-serif`;ctx.textAlign=align||"left";ctx.fillText(txt,x,y);};

const drawEffortChart=()=>{
  if(!last)return;const cv=Q("#effChart");if(!cv)return;
  const ctx=setupCanvas(cv);const w=cv.clientWidth,h=cv.clientHeight;clearGrid(ctx,w,h);
  const safe=last.inc*.35,buyV=last.pay,rentV=last.pr,maxV=Math.max(safe,buyV,rentV)*1.15||1;
  const pL=12,pR=12,pT=18,pB=26,pW=w-pL-pR,pH=h-pT-pB;
  const ySafe=pT+pH*(1-(safe/maxV));
  ctx.strokeStyle="rgba(56,189,248,.90)";ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(pL,ySafe);ctx.lineTo(w-pR,ySafe);ctx.stroke();
  drawTxt(ctx,(LANG==="EN"?"Safe ":"Cap.segura ")+fmtMoney(safe),pL+6,ySafe-6,11,"#7dd3fc","left");
  const bW=Math.min(100,pW/4);
  const bar=(x,val,lbl,fill,tc)=>{const bh=pH*(val/maxV);const y=pT+pH-bh;ctx.fillStyle=fill;ctx.globalAlpha=.92;ctx.fillRect(x,y,bW,bh);ctx.globalAlpha=1;ctx.strokeStyle="rgba(255,255,255,.12)";ctx.strokeRect(x,y,bW,bh);drawTxt(ctx,lbl,x+bW/2,pT+pH+18,12,"#cbd5e1","center");drawTxt(ctx,fmtMoney(val),x+bW/2,y-6,12,tc,"center");};
  bar(pL+pW*.3-bW/2,buyV,LANG==="EN"?"BUY":"COMPRA","rgba(34,197,94,.60)","#86efac");
  bar(pL+pW*.65-bW/2,rentV,LANG==="EN"?"RENT":"ALQUILER","rgba(245,158,11,.58)","#fde68a");
};

const drawSensChart=()=>{
  if(!last)return;const cv=Q("#sensChart");if(!cv)return;
  const ctx=setupCanvas(cv);const w=cv.clientWidth,h=cv.clientHeight;clearGrid(ctx,w,h);
  const pL=12,pR=12,pT=18,pB=26,pW=w-pL-pR,pH=h-pT-pB;
  const pts=[];for(let i=0;i<=4;i++){const r=last.rate+i*.005;pts.push({r,p:mort(last.cap,r,last.yrs)});}
  const maxP=Math.max(...pts.map(x=>x.p))*1.10||1,minP=Math.min(...pts.map(x=>x.p))*.90||0;
  drawTxt(ctx,LANG==="EN"?"Rate +0.5% steps":"Tipo +0,5%",pL,h-8,11,"rgba(148,163,184,.95)","left");
  ctx.strokeStyle="rgba(56,189,248,.92)";ctx.lineWidth=2;ctx.beginPath();
  pts.forEach((pt,i)=>{const x=pL+pW*(i/(pts.length-1));const y=pT+pH*(1-((pt.p-minP)/(maxP-minP||1)));if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke();
  pts.forEach((pt,i)=>{const x=pL+pW*(i/(pts.length-1));const y=pT+pH*(1-((pt.p-minP)/(maxP-minP||1)));ctx.fillStyle="rgba(125,211,252,1)";ctx.beginPath();ctx.arc(x,y,3.5,0,Math.PI*2);ctx.fill();if(i===pts.length-1)drawTxt(ctx,fmtMoney(pt.p),x-4,y-10,12,"#7dd3fc","right");});
  const delta=pts[pts.length-1].p-pts[0].p;drawTxt(ctx,(delta>=0?"+":"")+fmtMoney(delta)+" @ +2%",w-12,h-8,12,"#fde68a","right");
};

const drawCmpChart=(your,prov)=>{
  const cv=Q("#cmpChart");if(!cv)return;
  const ctx=setupCanvas(cv);const w=cv.clientWidth,h=cv.clientHeight;clearGrid(ctx,w,h);
  const pL=12,pR=12,pT=18,pB=26,pW=w-pL-pR,pH=h-pT-pB,maxV=Math.max(your,prov)*1.15||1;
  const bW=Math.min(140,pW/3);
  const bar=(x,val,lbl,fill,tc)=>{const bh=pH*(val/maxV);const y=pT+pH-bh;ctx.fillStyle=fill;ctx.globalAlpha=.92;ctx.fillRect(x,y,bW,bh);ctx.globalAlpha=1;drawTxt(ctx,lbl,x+bW/2,pT+pH+18,12,"#cbd5e1","center");drawTxt(ctx,fmtMoney(val),x+bW/2,y-6,12,tc,"center");};
  bar(pL+pW*.30-bW/2,your,LANG==="EN"?"Your area":"Tu zona","rgba(56,189,248,.45)","#7dd3fc");
  bar(pL+pW*.68-bW/2,prov,LANG==="EN"?"Province":"Provincia","rgba(168,85,247,.40)","#e9d5ff");
};

/* ============================
   ANALIZAR
   ============================ */
const analyze=()=>{
  const nm=(Q("#nm").value||"").trim(),ag=+Q("#ag").value||0,inc=+Q("#inc").value||0,sav=+Q("#sav").value||0;
  const yrs=+Q("#yrs").value||25,hor=Q("#hor").value==="y",fst=Q("#fst").value==="y";
  const ar=Q("#ar").value,m2=+Q("#m2").value||0,bd=Q("#bed").value===""?0:+Q("#bed").value||0,ba=+Q("#bat").value||0,type=Q("#ty").value;
  if(!nm||ag<18||ag>100||m2<50||ba<1){toast(t("toastCheck"));return;}
  const e={t:Q("#et").checked,p:Q("#ep").checked,l:Q("#el").checked,k:Q("#ek").checked};

  let pb,pr,pbRange=null,prRange=null,muniList=[];
  if((ar==="*"||ar==="__multi__")&&zoneSel.size>1){
    muniList=[...zoneSel];
    const buys=muniList.map(m=>buy(m,m2,Math.max(0,bd),ba,e));
    const rents=muniList.map(m=>rent(m,m2,Math.max(0,bd),ba,e));
    pb=Math.round(buys.reduce((a,b)=>a+b,0)/buys.length);
    pr=Math.round(rents.reduce((a,b)=>a+b,0)/rents.length);
    pbRange={lo:Math.min(...buys),hi:Math.max(...buys)};
    prRange={lo:Math.min(...rents),hi:Math.max(...rents)};
  }else{
    const baseM=(ar==="__multi__"&&zoneSel.size===1)?[...zoneSel][0]:(ar==="*"?"Cunit":ar);
    muniList=[baseM];pb=buy(baseM,m2,Math.max(0,bd),ba,e);pr=rent(baseM,m2,Math.max(0,bd),ba,e);
  }

  const dp=fst?.1:.2,down=pb*dp,cl=pb*BASE.close,cap=Math.max(0,pb-down);
  const needCash=Math.round(down+cl);
  let rate=BASE.rate;if(sav<needCash)rate+=.006;
  const pay=mort(cap,rate,yrs);
  const ratio=inc>0?(pay/inc)*100:1e9,rri=inc>0?(pr/inc)*100:1e9;
  const need=sav<needCash,ratioOK=isFinite(ratio)&&ratio<=35,rentOK=isFinite(rri)&&rri<=40;
  const recCode=(!need&&ratioOK&&hor)?"BUY":(rentOK?"RENT":"NOT_FEASIBLE");
  const rec=recCode==="BUY"?t("recBuy"):recCode==="RENT"?t("recRent"):t("recNotFeasible");

  last={nm,muni:ar,m2,bd:Math.max(0,bd),ba,type,pb,pr,pbRange,prRange,muniList,cap,rate,yrs,dp,sav,down,cl,pay,ratio,rri,rec,recCode,e,need,hor,inc,msv:+Q("#msv").value||0,needCash};
  lastReq=reqFromUI();lastReqSig=sigOfReq(lastReq);

  Q("#k1").textContent=fmtMoney(pb);Q("#k2").textContent=fmtMoney(pr);Q("#k3").textContent=fmtMoney(pay);Q("#k4").textContent=rec;
  const pm2=m2>0?Math.round(pb/m2):0;
  Q("#k1sub").textContent=pm2?(pm2.toLocaleString(LANG==="EN"?"en-US":"es-ES")+" ‚Ç¨/m¬≤"):"";
  Q("#k2sub").textContent=LANG==="EN"?"Monthly estimate":"Estimaci√≥n mensual";
  Q("#k3sub").textContent=`${yrs} ${LANG==="EN"?"years":"a√±os"} ¬∑ ${(rate*100).toFixed(2)}%`;
  Q("#k4sub").textContent=recCode==="BUY"?(LANG==="EN"?"You fit cash + effort":"Encajas cash + esfuerzo"):recCode==="RENT"?(LANG==="EN"?"Buying is tight":"Comprar aprieta"):(LANG==="EN"?"Neither option fits safely":"No encaja con seguridad");

  renderResult();setTabsEnabled();saveForm();show("r");
  setTimeout(()=>{drawEffortChart();drawSensChart();},120);
};

/* ============================
   RENDER RESULTADO
   ============================ */
const renderResult=()=>{
  if(!last)return;
  const dti=isFinite(last.ratio)?last.ratio:999,rti=isFinite(last.rri)?last.rri:999;
  const clsDTI=dti<=30?"good":dti<=35?"warn":"bad";
  const clsRTI=rti<=35?"good":rti<=40?"warn":"bad";
  const clsCash=last.need?"bad":"good";
  const clsRate=last.rate>BASE.rate?"warn":"neu";

  Q("#rCard").style.display="block";
  Q("#rTitle").textContent=tpl(t("sumTitle"),{rec:last.rec});
  Q("#rChips").innerHTML=
    `<span class="chip ${clsDTI}">${tpl(t("chipMort"),{pct:fmtPct(dti)})}</span>`+
    `<span class="chip ${clsRTI}">${tpl(t("chipRent"),{pct:fmtPct(rti)})}</span>`+
    `<span class="chip ${clsCash}">${tpl(t("chipCash"),{eur:fmtMoney(last.needCash)})}</span>`+
    `<span class="chip ${clsRate}">${tpl(t("chipRate"),{rate:(last.rate*100).toFixed(2)+"%"})}</span>`;

  const isMulti=last.muniList&&last.muniList.length>1;
  const multiLbl=isMulti?`<div style='font-size:.72rem;color:#7dd3fc;margin-top:3px'>${tpl(t("avgZone"),{n:last.muniList.length})}</div>`:"";
  const pbRng=isMulti&&last.pbRange?`<div class='range-bar'><span class='range-tag lo'>‚Üì ${fmtMoney(last.pbRange.lo)}</span><span class='range-tag hi'>‚Üë ${fmtMoney(last.pbRange.hi)}</span></div>`:"";
  const prRng=isMulti&&last.prRange?`<div class='range-bar'><span class='range-tag lo'>‚Üì ${fmtMoney(last.prRange.lo)}</span><span class='range-tag hi'>‚Üë ${fmtMoney(last.prRange.hi)}</span></div>`:"";
  const pm2=last.m2>0?Math.round(last.pb/last.m2):0;

  Q("#rMini").innerHTML=
    `<div class="mini"><div class="h">${t("miniPrice")}</div><div class="v">${fmtMoney(last.pb)}</div>${multiLbl}${pbRng}<div style='font-size:.75rem;color:#64748b;margin-top:4px'>${pm2.toLocaleString(LANG==="EN"?"en-US":"es-ES")} ‚Ç¨/m¬≤</div></div>`+
    `<div class="mini"><div class="h">${t("miniPay")}</div><div class="v">${fmtMoney(last.pay)}</div><div style='font-size:.75rem;color:#64748b;margin-top:4px'>${last.yrs} ${LANG==="EN"?"years":"a√±os"} ¬∑ ${(last.rate*100).toFixed(2)}%</div></div>`+
    `<div class="mini"><div class="h">${t("miniRent")}</div><div class="v">${fmtMoney(last.pr)}</div>${prRng}</div>`;

  const safe=last.inc*.35;
  const why=[];
  if(last.recCode==="BUY"){why.push(LANG==="EN"?"Savings cover down payment + costs":"Ahorros cubren entrada + costes");why.push(LANG==="EN"?"Mortgage effort within recommended band":"Esfuerzo hipoteca en banda recomendada");if(last.hor)why.push(LANG==="EN"?"Staying >5 years helps amortize costs":"Horizonte >5 a√±os ayuda a amortizar costes");}
  else if(last.recCode==="RENT"){if(last.need)why.push((LANG==="EN"?"Short on cash":"Falta cash")+": "+fmtMoney(last.needCash-last.sav));if(dti>35)why.push((LANG==="EN"?"Mortgage effort high":"Esfuerzo hipoteca alto")+": "+fmtPct(dti));if(!last.hor)why.push(LANG==="EN"?"Short horizon: buying less efficient":"Horizonte corto: comprar menos eficiente");why.push(LANG==="EN"?"Rent closer to a safer monthly load":"Alquiler m√°s cerca de carga mensual segura");}
  else{if(last.need)why.push(LANG==="EN"?"Not enough cash for down payment + costs":"No hay cash suficiente para entrada + costes");if(dti>35)why.push((LANG==="EN"?"Mortgage effort exceeds limit":"Esfuerzo hipoteca supera l√≠mite")+": "+fmtPct(dti));if(rti>40)why.push((LANG==="EN"?"Rent effort also exceeds limit":"Esfuerzo alquiler tambi√©n supera l√≠mite")+": "+fmtPct(rti));}

  Q("#chartTips").textContent=(LANG==="EN"?"Safe ":"Cap.segura ")+fmtMoney(safe)+" ¬∑ "+(LANG==="EN"?"Mortgage ":"Hip. ")+fmtMoney(last.pay)+" ¬∑ "+(LANG==="EN"?"Rent ":"Alq. ")+fmtMoney(last.pr);
  const blockClr=last.recCode==="BUY"?"#22c55e":last.recCode==="RENT"?"#f59e0b":"#ef4444";
  Q("#quickExplain").innerHTML=`<div style="font-weight:950;color:#e5e7eb;margin-bottom:8px">${t("cmpExplTitle")}</div><div style="display:grid;gap:6px">${why.map(x=>`<div>‚Ä¢ ${x}</div>`).join("")}</div>`;

  const muniTxt=muniLabel(last.muni),typeTxt=typeLabel(last.type),dpPct=Math.round(last.dp*100);
  const extrasOn=[];
  if(last.e.t)extrasOn.push(t("exTer"));if(last.e.p)extrasOn.push(t("exPis"));if(last.e.l)extrasOn.push(t("exAsc"));if(last.e.k)extrasOn.push(t("exGar"));

  let body=`<div style='display:grid;gap:16px'>
    <div style="background:linear-gradient(135deg,rgba(56,189,248,.08),rgba(14,165,233,.05));padding:16px;border-radius:14px;border-left:4px solid ${blockClr}">
      <div style="font-size:1.05rem;font-weight:1000;color:#f1f5f9;margin-bottom:10px">${last.rec}</div>
      <div style="color:#cbd5e1;line-height:1.75;font-size:.93rem">${why.map(x=>`<div style="margin-bottom:6px">‚Ä¢ ${x}</div>`).join("")}</div>
    </div>
    <div>
      <div style="font-size:1rem;font-weight:950;color:#38bdf8;margin-bottom:8px">üìç ${LANG==="EN"?"Preferences":(LANG==="CA"?"Prefer√®ncies":"Preferencias")}</div>
      <div style="margin-left:18px;color:#cbd5e1;line-height:1.7">
        <div><b>${muniTxt}</b> ¬∑ ${last.m2} m¬≤ ¬∑ ${last.bd||0} hab ¬∑ ${last.ba} ba√±os ¬∑ ${typeTxt}</div>
        <div style="color:#94a3b8;margin-top:6px">${extrasOn.length?(LANG==="EN"?"Extras: ":"Extras: ")+extrasOn.join(", "):(LANG==="EN"?"Extras: none":"Extras: ninguno")}</div>
      </div>
    </div>
    <div>
      <div style="font-size:1rem;font-weight:950;color:#38bdf8;margin-bottom:8px">üí∞ ${LANG==="EN"?"Financing":(LANG==="CA"?"Finan√ßament":"Financiaci√≥n")}</div>
      <div style="margin-left:18px;color:#cbd5e1;line-height:1.75">
        <div>${LANG==="EN"?"Down payment":"Entrada"}: ${dpPct}% ‚Üí <b>${fmtMoney(last.down)}</b></div>
        <div>${LANG==="EN"?"Closing costs":"Gastos"}: <b>${fmtMoney(last.cl)}</b></div>
        <div>${LANG==="EN"?"To finance":"A financiar"}: <b>${fmtMoney(last.cap)}</b> (${last.yrs} ${LANG==="EN"?"years":"a√±os"} @ ${(last.rate*100).toFixed(2)}%)</div>
      </div>
    </div>
    <div>
      <div style="font-size:1rem;font-weight:950;color:#38bdf8;margin-bottom:10px">üìä ${LANG==="EN"?"Monthly effort":"Esfuerzo mensual"}</div>
      <div style="display:grid;gap:14px">
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
            <span style="color:#94a3b8;font-size:.85rem;font-weight:900">${LANG==="EN"?"Mortgage effort":"Esfuerzo hipoteca"}</span>
            <span style="font-weight:1000;color:#f1f5f9">${fmtPct(dti)} ${dti<=30?"‚úÖ":dti<=35?"‚ö†Ô∏è":"‚ùå"}</span>
          </div>
          <div class="pbar-wrap"><div class="pbar ${clsDTI}" style="width:${Math.min(100,dti).toFixed(1)}%"></div></div>
          <div style="font-size:.75rem;color:#64748b;margin-top:3px">${LANG==="EN"?"Recommended limit: 35%":"L√≠mite recomendado: 35%"}</div>
        </div>
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
            <span style="color:#94a3b8;font-size:.85rem;font-weight:900">${LANG==="EN"?"Rent effort":"Esfuerzo alquiler"}</span>
            <span style="font-weight:1000;color:#f1f5f9">${fmtPct(rti)} ${rti<=35?"‚úÖ":rti<=40?"‚ö†Ô∏è":"‚ùå"}</span>
          </div>
          <div class="pbar-wrap"><div class="pbar ${clsRTI}" style="width:${Math.min(100,rti).toFixed(1)}%"></div></div>
          <div style="font-size:.75rem;color:#64748b;margin-top:3px">${LANG==="EN"?"Recommended limit: 40%":"L√≠mite recomendado: 40%"}</div>
        </div>
      </div>
    </div>
    <div style="padding:12px 14px;background:rgba(99,102,241,.08);border:1px solid rgba(99,102,241,.25);border-radius:12px;border-left:4px solid #818cf8;color:#c7d2fe;font-size:.85rem;line-height:1.6">‚ÑπÔ∏è ${t("itpNote")}</div>`;

  if(last.need){
    const missing=Math.max(0,last.needCash-last.sav);
    if(last.msv>0&&missing>0){const mos=Math.ceil(missing/last.msv);body+=`<div class="countdown">‚è≥ ${tpl(t("yearsToSave"),{msv:fmtMoney(last.msv),yrs:(mos/12).toFixed(1),mos})}</div>`;}
    else body+=`<div class="countdown">‚ö†Ô∏è ${LANG==="EN"?"Short on cash for buying":"Falta cash para comprar"} (${fmtMoney(missing)})</div>`;
  }else{body+=`<div class="countdown" style="background:rgba(34,197,94,.08);border-color:rgba(34,197,94,.25);border-left-color:#22c55e;color:#86efac">${t("savingsOk")}</div>`;}
  body+="</div>";
  Q("#rBody").innerHTML=body;

  Q("#rt").textContent=[
    `Hola ${last.nm},`,
    `Precio estimado: ${fmtMoney(last.pb)}`,
    `Vivienda: ${muniTxt} ¬∑ ${last.m2}m¬≤ ¬∑ ${last.bd||0}hab ¬∑ ${last.ba}ba√±os ¬∑ ${typeTxt}`,
    `Entrada: ${dpPct}% (${fmtMoney(last.down)}) + Gastos: ${fmtMoney(last.cl)}`,
    `A financiar: ${fmtMoney(last.cap)} en ${last.yrs} a√±os al ${(last.rate*100).toFixed(2)}%`,
    `Cuota: ${fmtMoney(last.pay)} | Alquiler: ${fmtMoney(last.pr)}`,
    `Recomendaci√≥n: ${last.rec}`
  ].join("\n");

  setTimeout(()=>{drawEffortChart();drawSensChart();},70);
};

/* ============================
   MAPA COMPARADOR
   ============================ */
let cmap=null;
const PROV_COORDS={"Barcelona":[41.3874,2.1686],"Girona":[41.9794,2.8214],"Lleida":[41.6176,0.6200],"Tarragona":[41.1189,1.2445]};
const upMap=()=>{
  const m=Q("#cm").value||"Barcelona",coords=PROV_COORDS[m]||[41.3874,2.1686];
  if(!cmap){cmap=L.map("cmap").setView(coords,11);L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{maxZoom:19,attribution:"¬© OpenStreetMap ¬∑ ¬© CARTO",subdomains:"abcd"}).addTo(cmap);L.marker(coords).addTo(cmap).bindPopup(m);setTimeout(()=>cmap.invalidateSize(),200);}
  else{cmap.setView(coords,11);cmap.eachLayer(l=>{if(l instanceof L.Marker)cmap.removeLayer(l);});L.marker(coords).addTo(cmap).bindPopup(m);setTimeout(()=>cmap.invalidateSize(),120);}
};

/* ============================
   COMPARAR
   ============================ */
const compare=()=>{
  if(!last){Q("#cmg").textContent=t("toastFirst");return;}
  const m=Q("#cm").value,m2=+Q("#cm2").value||0,bd=+Q("#cbd").value||0,ba=+Q("#cba").value||0;
  const e={t:Q("#ct").checked,p:Q("#cp0").checked,l:Q("#cl0").checked,k:Q("#ck0").checked};
  if(!M[m]||!(m2>0&&ba>0)){Q("#cmg").textContent=t("missingDataCmp");Q("#cmpChips").innerHTML="";return;}
  const p2=buyM(m,m2,Math.max(0,bd),ba,e),r2=rentM(m,m2,Math.max(0,bd),ba,e);
  const d=p2-last.pb,pct=last.pb>0?(d/last.pb)*100:0;
  const cls=d>0?"bad":d<0?"good":"neu",arrow=d>0?"‚Üë":d<0?"‚Üì":"‚Üí",sign=d>0?"+":"";
  const direction=d>0?t("cmpExpensive"):d<0?t("cmpCheaper"):t("cmpSame");
  Q("#cmpChips").innerHTML=`<span class="chip ${cls}">${arrow} ${sign}${fmtMoney(d)}</span><span class="chip ${cls}">${sign}${pct.toFixed(1)}%</span><span class="chip neu">${fmtMoney(p2)}</span><span class="chip neu">${fmtMoney(r2)} /mes</span>`;
  Q("#cmg").innerHTML=`<div style="display:grid;gap:10px">
    <div><b>${m}</b> ¬∑ ${m2}m¬≤ ¬∑ ${bd}hab ¬∑ ${ba}ba√±os</div>
    <div style="color:#cbd5e1;line-height:1.7">
      <div>‚Ä¢ ${LANG==="EN"?"Price in province":"Precio en provincia"}: <b>${fmtMoney(p2)}</b></div>
      <div>‚Ä¢ ${LANG==="EN"?"Price in your area":"Precio en tu zona"}: <b>${fmtMoney(last.pb)}</b></div>
      <div>‚Ä¢ ${LANG==="EN"?"Difference":"Diferencia"}: <b>${sign}${fmtMoney(d)}</b> (${sign}${pct.toFixed(1)}%, ${direction})</div>
      <div>‚Ä¢ ${LANG==="EN"?"Rent in province":"Alquiler en provincia"}: <b>${fmtMoney(r2)}</b></div>
      <div>‚Ä¢ ${LANG==="EN"?"Rent in your area":"Alquiler en tu zona"}: <b>${fmtMoney(last.pr)}</b></div>
    </div>
  </div>`;
  drawCmpChart(last.pb,p2);upMap();saveForm();
};

const fillFromLast=()=>{
  if(!last){toast(t("toastFirst"));return;}
  Q("#cm2").value=last.m2||"";Q("#cbd").value=last.bd||"";Q("#cba").value=last.ba||"";Q("#cty").value=last.type||"flat";
  Q("#ct").checked=!!last.e?.t;Q("#cp0").checked=!!last.e?.p;Q("#cl0").checked=!!last.e?.l;Q("#ck0").checked=!!last.e?.k;
  saveForm();toast(t("toastCopied"));
};

/* ============================
   MAPA MUNICIPAL
   ============================ */
let zmap=null,zReady=false,zoneSel=new Set(),polygonsByName=new Map();
const loadZoneSel=()=>{try{const s=localStorage.getItem(ZONE_KEY);if(s)zoneSel=new Set(JSON.parse(s)||[]);}catch(e){}};
const saveZoneSel=()=>localStorage.setItem(ZONE_KEY,JSON.stringify([...zoneSel]));
const renderZoneUI=()=>{
  const sel=zoneSel.size?[...zoneSel].join(", "):(LANG==="EN"?"none":(LANG==="CA"?"cap":"ninguno"));
  Q("#zoneNote").textContent=(LANG==="EN"?"Selected: ":(LANG==="CA"?"Seleccionats: ":"Seleccionados: "))+sel;
  Q("#zoneApplied").textContent=zoneSel.size?((LANG==="EN"?"Active: ":(LANG==="CA"?"Actius: ":"Activos: "))+[...zoneSel].join(", ")):"";
  const zc=Q("#zoneChips");
  zc.innerHTML=zoneSel.size?[...zoneSel].map(z=>`<span class="pchip on" data-z="${z}">${z}</span>`).join(""):`<span class="pchip off">${LANG==="EN"?"No selection":"Sin selecci√≥n"}</span>`;
  zc.querySelectorAll("[data-z]").forEach(ch=>ch.addEventListener("click",()=>toggleZone(ch.getAttribute("data-z"),true)));
};
const applyPolygonState=name=>{
  const poly=polygonsByName.get(name),on=zoneSel.has(name);
  if(poly)poly.setStyle({
    fillColor:on?"#38bdf8":"#4ade80",fillOpacity:on?.35:.10,
    color:on?"#0ea5e9":"#16a34a",weight:on?2.5:1.5,opacity:on?1:.70
  });
};
const toggleZone=(name,fromChip)=>{
  zoneSel.has(name)?zoneSel.delete(name):zoneSel.add(name);
  applyPolygonState(name);renderZoneUI();
  if(!fromChip)saveZoneSel();
};
const initMap=()=>{
  if(zReady)return;zReady=true;
  zmap=L.map("zmap",{scrollWheelZoom:false,tap:true,zoomControl:true}).setView([41.22,1.54],11);
  // Tile m√°s est√©tico: CartoDB Positron (gris suave, sin ruido visual)
  L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{
    maxZoom:19,attribution:'¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> ¬∑ ¬© <a href="https://carto.com/">CARTO</a>',
    subdomains:"abcd"
  }).addTo(zmap);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"¬© OpenStreetMap"}).addTo(zmap);
  renderZoneUI();
  // Cargar GeoJSON real de cada municipio desde Nominatim/OSM
  let loaded=0;const total=MUNI_NAMES.length;
  const mapContainer=document.querySelector("#zmap");
  // Mostrar loader
  const loader=document.createElement("div");
  loader.id="zmapLoader";
  loader.style.cssText="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(2,6,23,.92);color:#7dd3fc;padding:14px 22px;border-radius:14px;border:1px solid rgba(56,189,248,.40);font-size:.9rem;font-weight:800;z-index:1000;pointer-events:none;backdrop-filter:blur(8px);box-shadow:0 8px 24px rgba(0,0,0,.5)";
  loader.textContent=LANG==="EN"?"Loading real map...":LANG==="CA"?"Carregant mapa real...":"Cargando mapa real...";
  if(mapContainer){mapContainer.style.position="relative";mapContainer.appendChild(loader);}

  const onDone=()=>{
    loaded++;
    if(loader)loader.textContent=(LANG==="EN"?`Loading... ${loaded}/${total}`:LANG==="CA"?`Carregant... ${loaded}/${total}`:`Cargando... ${loaded}/${total}`);
    if(loaded>=total){
      if(loader)loader.remove();
      try{
        const allLayers=[];polygonsByName.forEach(p=>allLayers.push(p));
        if(allLayers.length){
          const group=L.featureGroup(allLayers);
          zmap.fitBounds(group.getBounds(),{padding:[20,20]});
        }
      }catch(e){}
      setTimeout(()=>zmap.invalidateSize(),160);
    }
  };

  MUNI_NAMES.forEach(name=>{
    const relId=OSM_IDS[name];
    const url=`https://nominatim.openstreetmap.org/lookup?osm_type=R&osm_ids=R${relId}&format=geojson&polygon_geojson=1`;
    fetch(url,{headers:{"Accept-Language":"es"}})
      .then(r=>r.json())
      .then(data=>{
        if(!data.features||!data.features.length)throw new Error("no features");
        const geom=data.features[0].geometry;
        const on=zoneSel.has(name);
        const style={fillColor:on?"#38bdf8":"#4ade80",fillOpacity:on?.35:.10,
                     color:on?"#0ea5e9":"#16a34a",weight:on?2.5:1.5,opacity:on?1:.70};
        let layer;
        if(geom.type==="Polygon"){
          const latlngs=geom.coordinates[0].map(c=>[c[1],c[0]]);
          layer=L.polygon(latlngs,style).addTo(zmap);
        }else if(geom.type==="MultiPolygon"){
          const rings=geom.coordinates.map(poly=>poly[0].map(c=>[c[1],c[0]]));
          layer=L.polygon(rings,style).addTo(zmap);
        }
        if(layer){
          layer.bindTooltip(name,{permanent:false,direction:"center",opacity:.95,
            className:"muni-tooltip"});
          layer.on("mouseover",function(){
            if(!zoneSel.has(name))this.setStyle({fillOpacity:.22,fillColor:"#86efac"});
          });
          layer.on("mouseout",function(){
            if(!zoneSel.has(name))this.setStyle({fillOpacity:.10,fillColor:"#4ade80"});
          });
          layer.on("click",()=>toggleZone(name,false));
          polygonsByName.set(name,layer);
        }
        onDone();
      })
      .catch(()=>{
        if(fb){
          const on=zoneSel.has(name);
          const style={fillColor:on?"#38bdf8":"#4ade80",fillOpacity:on?.35:.10,
                       color:on?"#0ea5e9":"#16a34a",weight:on?2.5:1.5,opacity:on?1:.70};
          const layer=L.polygon(fb,style).addTo(zmap);
          layer.bindTooltip(name,{permanent:false,direction:"center",opacity:.95,className:"muni-tooltip"});
          layer.on("mouseover",function(){if(!zoneSel.has(name))this.setStyle({fillOpacity:.22,fillColor:"#86efac"});});
          layer.on("mouseout",function(){if(!zoneSel.has(name))this.setStyle({fillOpacity:.10,fillColor:"#4ade80"});});
          layer.on("click",()=>toggleZone(name,false));
          polygonsByName.set(name,layer);
        }
        onDone();
      });
  });
  setTimeout(()=>zmap.invalidateSize(),200);
};

// Pol√≠gonos de respaldo (fallback) si Nominatim no est√° disponible
const FALLBACK_POLYGONS={
  "El Vendrell":[[41.222,1.531],[41.231,1.545],[41.234,1.558],[41.228,1.571],[41.215,1.576],[41.203,1.570],[41.196,1.553],[41.198,1.537],[41.208,1.524],[41.222,1.531]],
  "Calafell":[[41.192,1.552],[41.203,1.558],[41.212,1.574],[41.213,1.592],[41.206,1.608],[41.193,1.614],[41.181,1.606],[41.176,1.589],[41.179,1.568],[41.186,1.554],[41.192,1.552]],
  "Cunit":[[41.199,1.620],[41.207,1.628],[41.214,1.642],[41.212,1.654],[41.202,1.659],[41.194,1.653],[41.189,1.639],[41.191,1.624],[41.199,1.620]],
  "Bellvei":[[41.215,1.559],[41.224,1.564],[41.231,1.578],[41.230,1.593],[41.221,1.602],[41.209,1.604],[41.199,1.595],[41.197,1.579],[41.205,1.566],[41.215,1.559]],
  "Santa Oliva":[[41.240,1.521],[41.252,1.530],[41.259,1.547],[41.257,1.563],[41.246,1.573],[41.233,1.570],[41.226,1.554],[41.230,1.538],[41.240,1.521]],
  "Albinyana":[[41.231,1.490],[41.244,1.499],[41.251,1.514],[41.249,1.528],[41.238,1.538],[41.224,1.535],[41.216,1.520],[41.218,1.503],[41.231,1.490]],
  "L'Arbo√ß":[[41.259,1.594],[41.272,1.604],[41.278,1.619],[41.273,1.635],[41.261,1.641],[41.249,1.633],[41.244,1.617],[41.249,1.601],[41.259,1.594]],
  "Lloren√ß del Pened√®s":[[41.271,1.564],[41.283,1.573],[41.290,1.588],[41.288,1.602],[41.277,1.610],[41.264,1.607],[41.258,1.592],[41.261,1.577],[41.271,1.564]],
  "Banyeres del Pened√®s":[[41.286,1.576],[41.298,1.583],[41.306,1.597],[41.303,1.612],[41.291,1.619],[41.278,1.615],[41.272,1.600],[41.276,1.583],[41.286,1.576]],
  "Sant Jaume dels Domenys":[[41.299,1.561],[41.313,1.570],[41.320,1.588],[41.317,1.605],[41.303,1.613],[41.290,1.608],[41.283,1.591],[41.287,1.573],[41.299,1.561]],
  "La Bisbal del Pened√®s":[[41.268,1.482],[41.282,1.492],[41.290,1.509],[41.287,1.525],[41.273,1.534],[41.259,1.528],[41.253,1.511],[41.257,1.494],[41.268,1.482]],
  "Bonastre":[[41.214,1.432],[41.227,1.441],[41.233,1.458],[41.229,1.473],[41.215,1.480],[41.203,1.471],[41.198,1.453],[41.205,1.437],[41.214,1.432]],
  "Maslloren√ß":[[41.259,1.409],[41.275,1.419],[41.282,1.436],[41.278,1.452],[41.264,1.460],[41.250,1.452],[41.244,1.434],[41.250,1.416],[41.259,1.409]],
  "El Montmell":[[41.293,1.448],[41.311,1.462],[41.319,1.483],[41.314,1.502],[41.296,1.513],[41.278,1.505],[41.271,1.483],[41.278,1.462],[41.293,1.448]]
};
const MUNI_SLUG={"Cunit":"cunit-tarragona","El Vendrell":"el-vendrell-tarragona","Calafell":"calafell-tarragona","Santa Oliva":"santa-oliva-tarragona","Bellvei":"bellvei-tarragona","L'Arbo√ß":"l-arboc-tarragona","Banyeres del Pened√®s":"banyeres-del-penedes-tarragona","Albinyana":"albinyana-tarragona","Bonastre":"bonastre-tarragona","Maslloren√ß":"masllorenc-tarragona","La Bisbal del Pened√®s":"la-bisbal-del-penedes-tarragona","Lloren√ß del Pened√®s":"llorenc-del-penedes-tarragona","Sant Jaume dels Domenys":"sant-jaume-dels-domenys-tarragona","El Montmell":"el-montmell-tarragona"};
const bedSlug=n=>{n=+n||0;if(n<=0)return"estudios";if(n===1)return"de-un-dormitorio";if(n===2)return"de-dos-dormitorios";if(n===3)return"de-tres-dormitorios";return"de-cuatro-cinco-habitaciones-o-mas";};
const bathSlug=n=>{n=+n||0;if(n<=1)return"un-bano";if(n===2)return"dos-banos";return"tres-banos-o-mas";};
const m2Slugs=m2=>{m2=+m2||0;if(!(m2>0))return[];const min=Math.max(0,Math.floor((m2-20)/10)*10),max=Math.ceil((m2+20)/10)*10;return[`metros-cuadrados-mas-de_${min}`,`metros-cuadrados-menos-de_${max}`];};
const XSLUG={t:"terraza",p:"piscina",l:"ascensor",k:"garaje"};

const buildUrl=(mode,strict,muniOverride)=>{
  if(!lastReq)return null;
  const req=lastReq,muni=muniOverride||req.muni;
  const area=(muni==="*"||muni==="__multi__")?"tarragona/baix-penedes":(MUNI_SLUG[muni]||null);
  if(!area)return null;
  const op=mode==="buy"?"venta-viviendas":"alquiler-viviendas";
  const f=[...m2Slugs(req.m2),req.type==="flat"?"pisos":"chalets",bedSlug(req.bed),bathSlug(req.bath)];
  if(strict)["t","p","l","k","s","j","a"].forEach(k=>{if(req.ex[k]===1&&XSLUG[k])f.push(XSLUG[k]);});
  return`https://www.idealista.com/${op}/${area}/con-${f.filter(Boolean).join("%2C")}/`;
};

const openIdealista=(mode,strict,muniOverride)=>{
  if(!lastReq){toast(t("toastFirst"));return;}
  if(prefsChanged()){toast(t("toastPrefs"));return;}
  const url=buildUrl(mode,strict,muniOverride);
  if(!url){toast(t("toastNoLink"));return;}
  window.open(url,"_blank","noopener");
};

const refreshExamplesUI=()=>{
  const muniTxt=muniLabel(Q("#ar").value);
  const ok=!!lastReq&&!prefsChanged();
  Q("#xinfo").textContent=tpl(t("xInfo"),{muni:muniTxt,state:ok?t("stateReady"):t("stateNeed")});
  const wrap=Q("#xbtns");wrap.innerHTML="";
  const mkBtn=(label,fn)=>{const b=document.createElement("button");b.type="button";b.className="b ok";b.textContent=label;b.onclick=fn;if(!ok)b.classList.add("dis");wrap.appendChild(b);};
  const z=[...zoneSel].filter(x=>MUNI_SLUG[x]);
  const BL=LANG==="EN"?"BUY":"COMPRA",RL=LANG==="EN"?"RENT":"ALQUILER",SL=LANG==="EN"?"strict":"estricto",FL="flex";
  if(z.length){z.forEach(m=>{mkBtn(`${BL} (${SL}) ¬∑ ${m}`,()=>openIdealista("buy",true,m));mkBtn(`${BL} (${FL}) ¬∑ ${m}`,()=>openIdealista("buy",false,m));mkBtn(`${RL} (${SL}) ¬∑ ${m}`,()=>openIdealista("rent",true,m));mkBtn(`${RL} (${FL}) ¬∑ ${m}`,()=>openIdealista("rent",false,m));});}
  else{mkBtn(`${BL} (${SL})`,()=>openIdealista("buy",true,null));mkBtn(`${BL} (${FL})`,()=>openIdealista("buy",false,null));mkBtn(`${RL} (${SL})`,()=>openIdealista("rent",true,null));mkBtn(`${RL} (${FL})`,()=>openIdealista("rent",false,null));}
  setTabsEnabled();
};

/* =============================================================================
   Assessoria d'Habitatge ‚Äî AI CHAT ENGINE (Offline, No-API)
   Fixed syntax build
   -----------------------------------------------------------------------------
   Requires (from your app):
     LANG ("ES"|"CA"|"EN")
     t(key) optional
     Q(selector), QA(selector) optional (fallbacks included)
     fmtMoney(number)
     mort(capital, rate, years)
     last (analysis object)
     muniLabel(code), typeLabel(code) optional
     CHAT_KEY (localStorage key)
     applyI18n() optional
   ============================================================================= */

(function () {
  "use strict";

  /* ============================
     FALLBACKS (in case your app doesn't define Q/QA)
     ============================ */
  const _Q = (sel) => (typeof Q === "function" ? Q(sel) : document.querySelector(sel));
  const _QA = (sel) => (typeof QA === "function" ? QA(sel) : document.querySelectorAll(sel));

  /* ============================
     SECTION 1 ‚Äî GLOBAL STATE
     ============================ */
  let chatHistory = [];
  let isAIProcessing = false;

  const s = localStorage.getItem(CHAT_KEY);

  const loadChatState = () => {
    try {
      return JSON.parse(localStorage.getItem(CHAT_STATE_KEY) || "{}") || {};
    } catch (e) {
      return {};
    }
  };

  const saveChatState = (st) => {
    try {
      localStorage.setItem(CHAT_STATE_KEY, JSON.stringify(st || {}));
    } catch (e) {}
  };

  let chatState = loadChatState();
  chatState = {
    turn: chatState.turn || 0,
    topic: chatState.topic || null,
    lastIntent: chatState.lastIntent || null,
    lastUserText: chatState.lastUserText || "",
    lastAssistantText: chatState.lastAssistantText || "",
    prefs: chatState.prefs || {
      area: null,
      priority: null,
      style: "normal",
      language: null
    },
    goals: chatState.goals || {
      nextStep: null,
      shortlist: []
    },
    lastSlots: chatState.lastSlots || {}
  };

  /* ============================
     SECTION 2 ‚Äî PERSISTENCE
     ============================ */
  localStorage.setItem(CHAT_KEY, JSON.stringify(chatHistory));
try {
  const s = localStorage.getItem(window.CHAT_KEY);
  if (s) {
    chatHistory = JSON.parse(s) || [];
    renderChatHistory();
  }
} catch (e) {
  // opcional: console.warn("Chat history corrupt", e);
}

  const saveChatHistory = () => {
    try {
      localStorage.setItem(window.CHAT_KEY, JSON.stringify(chatHistory));
    } catch (e) {}
  };

  /* ============================
     SECTION 3 ‚Äî USER CONTEXT
     ============================ */
  const _fm = (n) => (typeof fmtMoney === "function" ? fmtMoney(n) : String(n));
  const _fp = (n) => Number(n).toFixed(1) + "%";

  const getUserContext = () => {
    if (!window.last) return null;

    const _t = (k) => (typeof t === "function" ? t(k) : k);

    const extras = ["t", "p", "l", "k"]
      .filter((k) => window.last.e && window.last.e[k])
      .map((k) => ({ t: _t("exTer"), p: _t("exPis"), l: _t("exAsc"), k: _t("exGar") }[k] || k))
      .join(", ") || "‚Äî";

    const l = window.last;

    return {
      nm: l.nm,
      ag: l.ag,
      inc: l.inc,
      sav: l.sav,
      msv: l.msv,

      pb: l.pb,
      pr: l.pr,
      pay: l.pay,
      cap: l.cap,

      rate: l.rate,
      yrs: l.yrs,
      dp: Math.round(l.dp * 100),

      ratio: l.ratio,
      rri: l.rri,

      rec: l.rec,
      recCode: l.recCode,

      need: l.need,
      needCash: l.needCash,
      hor: l.hor,

      muni: typeof muniLabel === "function" ? muniLabel(l.muni) : (l.muni || ""),
      m2: l.m2,
      bd: l.bd || 0,
      ba: l.ba,
      type: typeof typeLabel === "function" ? typeLabel(l.type) : (l.type || ""),
      extras,

      safe: Math.round(l.inc * 0.35),
      missing: Math.max(0, l.needCash - l.sav),
      mosToGoal: l.msv > 0 ? Math.ceil(Math.max(0, l.needCash - l.sav) / l.msv) : null,
      margin: Math.round(l.inc * 0.35 - l.pay),
      rentMargin: Math.round(l.inc * 0.40 - l.pr),

      // FIX: valid JS identifier (was ‚Ç¨/m2, invalid)
      eurm2: l.m2 ? Math.round(l.pb / l.m2) : null
    };
  };

  /* ============================
     SECTION 4 ‚Äî SAFE RENDERING
     ============================ */
  const escapeHTML = (s = "") =>
    String(s)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");

  const stripMd = (text = "") => {
    const t0 = String(text);
    return t0
      .replace(/\*\*(.+?)\*\*/g, "$1")
      .replace(/\*(.+?)\*/g, "$1")
      .replace(/`(.+?)`/g, "$1")
      .replace(/^#+\s+/gm, "")
      .replace(/\[(.+?)\]\(.+?\)/g, "$1");
  };

  const renderSafeMultiline = (el, text) => {
    if (!el) return;
    const clean = escapeHTML(stripMd(text));
    el.innerHTML = clean.replace(/\n/g, "<br>");
  };

  /* ============================
     SECTION 5 ‚Äî LANGUAGE
     ============================ */
  const detectLanguageFromText = (msg) => {
    const m = (msg || "").toLowerCase();
    const caHits = ["qu√®", "com", "on", "llogar", "estalviar", "termini", "quota", "despeses", "municipi", "m√©s", "menys", "per√≤"];
    const esHits = ["qu√©", "c√≥mo", "d√≥nde", "alquilar", "ahorrar", "plazo", "cuota", "gastos", "municipio", "m√°s", "menos", "pero"];
    const enHits = ["what", "how", "where", "rent", "buy", "mortgage", "payment", "savings", "term", "rate", "town"];

    const count = (arr) => arr.reduce((acc, w) => acc + (m.includes(w) ? 1 : 0), 0);
    const ca = count(caHits), es = count(esHits), en = count(enHits);

    const max = Math.max(ca, es, en);
    if (max === 0) return null;
    if (max === ca) return "CA";
    if (max === en) return "EN";
    return "ES";
  };

  const getLang = (msg) => {
    const det = detectLanguageFromText(msg);
    if (det) chatState.prefs.language = det;
    return det || chatState.prefs.language || (window.LANG || "ES");
  };

  const tr = (L, es, ca, en) => (L === "CA" ? ca : L === "EN" ? en : es);

  /* ============================
     SECTION 6 ‚Äî PROFILE
     ============================ */
  const analyzeUserProfile = (ctx) => {
    if (!ctx) return null;
    const p = { wealth: "middle", age_group: "adult", urgency: "normal", risk: "medium" };

    if (ctx.inc >= 4000 && ctx.sav >= 50000) p.wealth = "high";
    else if (ctx.inc < 1800 || ctx.sav < 10000) p.wealth = "low";

    const age = ctx.ag || 35;
    if (age < 30) p.age_group = "young";
    else if (age >= 55) p.age_group = "senior";

    if (ctx.need && ctx.mosToGoal && ctx.mosToGoal > 36) p.urgency = "low";
    else if (ctx.need && ctx.mosToGoal && ctx.mosToGoal < 12) p.urgency = "high";

    if (ctx.ratio > 35 || ctx.need) p.risk = "high";
    else if (ctx.ratio < 25 && !ctx.need) p.risk = "low";

    return p;
  };

  const getToneForProfile = (profile, L) => {
    if (!profile) return "";
    const tones = {
      ES: {
        high_young: "Tienes una situaci√≥n financiera s√≥lida y juventud de tu lado",
        high_adult: "Tu posici√≥n financiera es muy buena",
        high_senior: "Has construido una posici√≥n financiera excelente",
        middle_young: "Est√°s en buena posici√≥n para empezar",
        middle_adult: "Tienes una base financiera razonable",
        middle_senior: "Tu situaci√≥n es estable",
        low_young: "Aunque ahora est√©s empezando, tienes tiempo por delante",
        low_adult: "Est√°s en un momento de construcci√≥n financiera",
        low_senior: "Entiendo que la situaci√≥n puede ser desafiante"
      },
      CA: {
        high_young: "Tens una situaci√≥ financera s√≤lida i joventut del teu costat",
        high_adult: "La teva posici√≥ financera √©s molt bona",
        high_senior: "Has constru√Øt una posici√≥ financera excel¬∑lent",
        middle_young: "Est√†s en bona posici√≥ per comen√ßar",
        middle_adult: "Tens una base financera raonable",
        middle_senior: "La teva situaci√≥ √©s estable",
        low_young: "Tot i que ara estiguis comen√ßant, tens temps per davant",
        low_adult: "Est√†s en un moment de construcci√≥ financera",
        low_senior: "Entenc que la situaci√≥ pot ser desafiadora"
      },
      EN: {
        high_young: "You have a solid financial position with youth on your side",
        high_adult: "Your financial position is very good",
        high_senior: "You've built an excellent financial position",
        middle_young: "You're in a good position to get started",
        middle_adult: "You have a reasonable financial foundation",
        middle_senior: "Your situation is stable",
        low_young: "Though you're just starting, you have time ahead",
        low_adult: "You're in a financial building phase",
        low_senior: "I understand the situation can be challenging"
      }
    };
    const key = `${profile.wealth}_${profile.age_group}`;
    return (tones[L] && tones[L][key]) ? tones[L][key] : "";
  };

  /* ============================
     SECTION 7 ‚Äî NORMALIZE / INTENT
     ============================ */
  const normText = (s = "") =>
    String(s)
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[¬ø¬°'"]/g, "")
      .trim();

  const scoreIntent = (m) => {
    const rules = [
      ["greet", 4, ["hola", "hello", "hi", "bon dia", "buenas", "buenos dias", "que tal", "com estas"]],
      ["thanks", 4, ["gracias", "gracies", "thanks", "merci"]],
      ["bye", 4, ["adios", "bye", "fins aviat", "ciao"]],
      ["capabilities", 3, ["que puedes", "que pots", "what can you", "ayuda", "help", "para que sirves", "com funciones"]],
      ["summary", 3, ["resumen", "resum", "summary", "resultado", "resultat", "analysis", "analisis"]],
      ["advice", 3, ["consejo", "consell", "recomiendas", "recomanes", "recommend", "que hago", "que faig"]],
      ["towns", 5, ["donde", "on", "where", "municipio", "municipi", "zona", "pueblo", "town"]],
      ["buyrent", 5, ["comprar", "compra", "buy", "purchase", "alquilar", "llogar", "rent", "comprar o alquilar"]],
      ["mortgage", 5, ["hipoteca", "mortgage", "banco", "bank", "euribor", "tipo fijo", "tipo variable", "mixta"]],
      ["payment", 4, ["cuota", "pago mensual", "mensualidad", "monthly payment", "quota"]],
      ["downpayment", 4, ["entrada", "down payment", "enganxe", "senyal", "anticipo"]],
      ["costs", 3, ["gastos", "costes", "itp", "notaria", "registro", "fees", "taxes", "despeses"]],
      ["rates", 4, ["tipo", "interes", "interest", "rate", "euribor", "sube", "baja", "puja", "baixa"]],
      ["savings", 4, ["ahorrar", "estalviar", "save", "savings", "cuanto tardar", "quant trigar", "cuanto necesito"]],
      ["strategy", 3, ["estrategia", "strategy", "capacidad de compra", "buying power"]],
      ["risk", 3, ["riesgo", "risk", "burbuja", "crash", "crisis"]],
      ["whatif", 5, ["y si", "what if", "si sube", "si baja", "si ahorro", "si puja", "si baixa"]],
      ["identity", 2, ["quien eres", "who are you", "chatgpt", "openai", "claude"]],
      ["joke", 2, ["chiste", "joke", "broma", "humor"]]
    ];

    const scores = {};
    const add = (k, v) => (scores[k] = (scores[k] || 0) + v);

    for (const [intent, w, keys] of rules) {
      for (const k of keys) if (m.includes(k)) add(intent, w);
    }

    if (/\b(donde|on|where)\b/.test(m)) add("towns", 6);
    if (/(\+|\-)?\d+([.,]\d+)?\s*%/.test(m)) add("whatif", 4);

    let best = "general", bestScore = 0;
    for (const k in scores) {
      if (scores[k] > bestScore) { best = k; bestScore = scores[k]; }
    }
    return { intent: best, score: bestScore };
  };

  const detectIntent = (msg) => scoreIntent(normText(msg)).intent;

  /* ============================
     SECTION 8 ‚Äî REPLY
     ============================ */
  const formatAnswer = (L, title, bullets, next) => {
    const head = title ? `‚úÖ ${title}\n` : "";
    const body = (bullets && bullets.length) ? bullets.map((b) => `‚Ä¢ ${b}`).join("\n") : "";
    const tail = next ? `\n\nüëâ ${tr(L, "Siguiente paso: ", "Seg√ºent pas: ", "Next step: ")}${next}` : "";
    return head + body + tail;
  };

  const buildReply = (intent, msg) => {
    const ctx = getUserContext();
    const L = getLang(msg);

    chatState.turn++;
    chatState.lastUserText = msg;

    if (!ctx) {
      chatState.topic = "summary";
      saveChatState(chatState);
      return tr(
        L,
        "Para ayudarte bien, completa el an√°lisis (pasos 1-3) y pulsa Analizar. Luego dime: ¬øquieres 'comprar vs alquilar' o 'd√≥nde buscar'?",
        "Per ajudar-te b√©, completa l'an√†lisi (passos 1-3) i prem Analitzar. Despr√©s digues: vols 'comprar vs llogar' o 'on buscar'?",
        "To help properly, complete the analysis (steps 1‚Äì3) and click Analyze. Then tell me: 'buy vs rent' or 'where to look'?"
      );
    }

    const profile = analyzeUserProfile(ctx);
    const tone = getToneForProfile(profile, L);

    // basic
    if (intent === "greet") {
      return formatAnswer(L,
        "AI Financial Advisor",
        [
          tr(L, `Hola ${ctx.nm}. ${tone}.`, `Hola ${ctx.nm}. ${tone}.`, `Hi ${ctx.nm}. ${tone}.`),
          tr(L, "Puedo ayudarte con: municipios, comprar vs alquilar, cuota, entrada, tipos y escenarios.",
                 "Et puc ajudar amb: municipis, comprar vs llogar, quota, entrada, tipus i escenaris.",
                 "I can help with: towns, buy vs rent, payment, down payment, rates and what-if scenarios.")
        ],
        tr(L, "¬øQu√© quieres mirar primero?", "Qu√® vols mirar primer?", "What do you want first?")
      );
    }

    if (intent === "summary") {
      return formatAnswer(L,
        tr(L, "Resumen de tu an√°lisis", "Resum de la teva an√†lisi", "Your analysis summary"),
        [
          `${ctx.muni} ¬∑ ${ctx.m2}m¬≤ ¬∑ ${ctx.type}`,
          tr(L, `Precio estimado: ${_fm(ctx.pb)} (${ctx.eurm2} ‚Ç¨/m¬≤)`,
                `Preu estimat: ${_fm(ctx.pb)} (${ctx.eurm2} ‚Ç¨/m¬≤)`,
                `Estimated price: ${_fm(ctx.pb)} (${ctx.eurm2} ‚Ç¨/m¬≤)`),
          tr(L, `Cuota: ${_fm(ctx.pay)} (${_fp(ctx.ratio)} de ingresos)`,
                `Quota: ${_fm(ctx.pay)} (${_fp(ctx.ratio)} d'ingressos)`,
                `Payment: ${_fm(ctx.pay)} (${_fp(ctx.ratio)} of income)`),
          tr(L, `Alquiler: ${_fm(ctx.pr)} (${_fp(ctx.rri)} de ingresos)`,
                `Lloguer: ${_fm(ctx.pr)} (${_fp(ctx.rri)} d'ingressos)`,
                `Rent: ${_fm(ctx.pr)} (${_fp(ctx.rri)} of income)`),
          tr(L, `Recomendaci√≥n: ${ctx.rec}`, `Recomanaci√≥: ${ctx.rec}`, `Recommendation: ${ctx.rec}`)
        ],
        tr(L, "¬øQuieres 'd√≥nde buscar' o 'comprar vs alquilar'?", "Vols 'on buscar' o 'comprar vs llogar'?", "Do you want 'where to look' or 'buy vs rent'?")
      );
    }

    if (intent === "buyrent") {
      const buyOk = (!ctx.need && ctx.ratio <= 35 && ctx.hor);
      if (buyOk) {
        return formatAnswer(L,
          tr(L, "Comprar vs Alquilar", "Comprar vs Llogar", "Buy vs Rent"),
          [
            tr(L, "Comprar te encaja: tienes cash suficiente y la cuota est√° dentro del 35%.",
                  "Comprar t'encaixa: tens cash suficient i la quota √©s dins del 35%.",
                  "Buying fits: you have enough cash and the payment is within 35%."),
            tr(L, "Si te quedas 5+ a√±os, los costes de compra se amortizan mejor.",
                  "Si t'hi quedes 5+ anys, els costos s'amortitzen millor.",
                  "If you stay 5+ years, purchase costs amortize better.")
          ],
          tr(L, "¬øLo enfocamos en municipios o en mejorar la cuota?", "Ho enfoquem en municipis o en millorar la quota?", "Focus on towns or on improving payment?")
        );
      }
      if (ctx.need) {
        return formatAnswer(L,
          tr(L, "Comprar vs Alquilar", "Comprar vs Llogar", "Buy vs Rent"),
          [
            tr(L, `Ahora mismo alquilar es lo prudente: te faltan ${_fm(ctx.missing)} para entrada+gastos.`,
                  `Ara mateix llogar √©s prudent: et falten ${_fm(ctx.missing)} per entrada+despeses.`,
                  `Right now renting is prudent: you're short ${_fm(ctx.missing)} for down payment+costs.`),
            tr(L, ctx.msv > 0 ? `Ahorrando ${_fm(ctx.msv)}/mes: objetivo en ~${ctx.mosToGoal} meses.` : "Si me dices cu√°nto ahorras/mes, te calculo plazo.",
                  ctx.msv > 0 ? `Estalviant ${_fm(ctx.msv)}/mes: objectiu en ~${ctx.mosToGoal} mesos.` : "Si em dius quant estalvies/mes, et calculo termini.",
                  ctx.msv > 0 ? `Saving ${_fm(ctx.msv)}/mo: goal in ~${ctx.mosToGoal} months.` : "Tell me monthly savings and I‚Äôll compute the timeline.")
          ],
          tr(L, "¬øQuieres que te recomiende municipios m√°s baratos para acelerar?", "Vols municipis m√©s barats per accelerar?", "Want cheaper towns to speed up?")
        );
      }
      return formatAnswer(L,
        tr(L, "Comprar vs Alquilar", "Comprar vs Llogar", "Buy vs Rent"),
        [
          tr(L, `Comprar est√° ajustado: cuota ${_fm(ctx.pay)} = ${_fp(ctx.ratio)} (>35%).`,
                `Comprar √©s ajustat: quota ${_fm(ctx.pay)} = ${_fp(ctx.ratio)} (>35%).`,
                `Buying is tight: payment ${_fm(ctx.pay)} = ${_fp(ctx.ratio)} (>35%).`),
          tr(L, "Soluciones: bajar precio, m√°s entrada o alargar plazo (con cuidado).",
                "Solucions: baixar preu, m√©s entrada o allargar termini (amb cura).",
                "Fixes: lower price, more down payment, or longer term (carefully).")
        ],
        tr(L, "¬øQu√© quieres tocar primero: precio, entrada o plazo?", "Qu√® vols tocar primer: preu, entrada o termini?", "What first: price, down payment, or term?")
      );
    }

    // fallback
    return tr(
      L,
      "Dime si quieres: 'resumen', 'comprar vs alquilar', 'cuota', 'entrada', o 'd√≥nde comprar'.",
      "Digues si vols: 'resum', 'comprar vs llogar', 'quota', 'entrada', o 'on comprar'.",
      "Tell me: 'summary', 'buy vs rent', 'payment', 'down payment', or 'where to buy'."
    );
  };

  /* ============================
     SECTION 9 ‚Äî UI
     ============================ */
  const addMsg = (role, content) => {
    const mc = _Q("#chatMessages");
    if (!mc) return;

    const normRole = (role === "assistant") ? "ai" : role;

    const d = document.createElement("div");
    d.className = `chat-message ${normRole}`;

    const av = document.createElement("div");
    av.className = `chat-avatar ${normRole}`;
    av.textContent = (normRole === "user") ? ((typeof t === "function" ? t("aiYou") : null) || "T√ö") : "AI";

    const bub = document.createElement("div");
    bub.className = "chat-bubble";
    renderSafeMultiline(bub, content);

    if (normRole === "user") { d.appendChild(bub); d.appendChild(av); }
    else { d.appendChild(av); d.appendChild(bub); }

    mc.appendChild(d);
    mc.scrollTop = mc.scrollHeight;
  };

  const addThinking = () => {
    const mc = _Q("#chatMessages");
    if (!mc) return;

    const d = document.createElement("div");
    d.className = "chat-message ai";
    d.id = "thinking-indicator";

    const av = document.createElement("div");
    av.className = "chat-avatar ai";
    av.textContent = "AI";

    const bub = document.createElement("div");
    bub.className = "chat-bubble thinking";
    bub.textContent = (typeof t === "function" ? t("aiThinking") : null) || "Analizando...";

    d.appendChild(av);
    d.appendChild(bub);
    mc.appendChild(d);
    mc.scrollTop = mc.scrollHeight;
  };

  const removeThinking = () => {
    const thinking = _Q("#thinking-indicator");
    if (thinking) thinking.remove();
  };

  const sendToAI = async (msg) => {
    if (isAIProcessing) return;
    isAIProcessing = true;

    const btnEl = _Q("#chatSend");
    const inpEl = _Q("#chatInput");

    if (btnEl) btnEl.disabled = true;
    if (inpEl) { inpEl.disabled = true; inpEl.value = ""; }

    addMsg("user", msg);
    chatHistory.push({ role: "user", content: msg });

    addThinking();
    const delay = 450 + Math.random() * 650;
    await new Promise((r) => setTimeout(r, delay));
    removeThinking();

    const intent = detectIntent(msg);
    const reply = buildReply(intent, msg);

    chatHistory.push({ role: "assistant", content: reply });
    saveChatHistory();

    const mc = _Q("#chatMessages");
    const d = document.createElement("div");
    d.className = "chat-message ai";

    const av = document.createElement("div");
    av.className = "chat-avatar ai";
    av.textContent = "AI";

    const bub = document.createElement("div");
    bub.className = "chat-bubble";

    d.appendChild(av);
    d.appendChild(bub);
    if (mc) mc.appendChild(d);

    const clean = stripMd(reply);
    let pos = 0;

    const unlock = () => {
      isAIProcessing = false;
      const b = _Q("#chatSend");
      const i = _Q("#chatInput");
      if (b) b.disabled = false;
      if (i) { i.disabled = false; i.style.height = "auto"; i.focus(); }
    };

    const iv = setInterval(() => {
      pos++;
      renderSafeMultiline(bub, clean.substring(0, pos));
      if (mc) mc.scrollTop = mc.scrollHeight;
      if (pos >= clean.length) { clearInterval(iv); unlock(); }
    }, 14);

    chatState.lastAssistantText = reply;
    saveChatState(chatState);
  };

  const renderChatHistory = () => {
    _QA(".chat-message:not(#welcome-message)").forEach((el) => el.remove());
    chatHistory.forEach((m) => addMsg(m.role === "assistant" ? "ai" : m.role, m.content));
  };

  const initChatUI = () => {
    if (typeof applyI18n === "function") applyI18n();
    loadChatHistory();

    const btn = _Q("#chatSend");
    const inp = _Q("#chatInput");

    if (btn && !btn.dataset.init) {
      btn.dataset.init = "1";
      btn.onclick = () => {
        const m = inp?.value?.trim();
        if (m) sendToAI(m);
      };
    }

    if (inp && !inp.dataset.init) {
      inp.dataset.init = "1";
      inp.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          const m = inp.value.trim();
          if (m) sendToAI(m);
        }
      });
      inp.addEventListener("input", () => {
        inp.style.height = "auto";
        inp.style.height = Math.min(inp.scrollHeight, 120) + "px";
      });
    }

    const chips = _QA(".suggestion-chip");
    chips.forEach((ch) => ch.replaceWith(ch.cloneNode(true)));
    _QA(".suggestion-chip").forEach((ch) => {
      ch.addEventListener("click", () => {
        const q = ch.getAttribute("data-q");
        if (q && !isAIProcessing) sendToAI(q);
      });
    });
  };

  // expose init (so you can call it after DOM loads)
  window.initChatUI = initChatUI;

})();
/* ============================
   VALIDACI√ìN LIVE
   ============================ */
const liveValidate = () => {
  if (typeof Q !== "function") return;

  const setHint = (id, msg, ok) => {
    const el = Q("#hint-" + id);
    if (!el) return;
    el.textContent = msg || "";
    el.className = "field-hint " + (msg ? (ok ? "ok" : "err") : "");
    const f = Q("#" + id);
    if (f) {
      f.classList.toggle("field-ok", !!ok && !!msg);
      f.classList.toggle("field-err", !ok && !!msg);
    }
  };

  const inc = +Q("#inc")?.value || 0;
  if (inc > 0 && inc < 500) setHint("inc", (LANG === "EN" ? "Very low income" : "Ingresos muy bajos, ¬øes neto?"), false);
  else if (inc > 0) setHint("inc", "‚úì", true);
  else setHint("inc", "", false);

  const sav = +Q("#sav")?.value || 0;
  if (sav > 0 && sav < 5000) setHint("sav", (LANG === "EN" ? "Very low savings" : "Ahorros muy bajos"), false);
  else if (sav > 0) setHint("sav", "‚úì", true);
  else setHint("sav", "", false);

  const m2 = +Q("#m2")?.value || 0;
  if (m2 > 0 && m2 < 50) setHint("m2", (LANG === "EN" ? "Minimum 50 m¬≤" : "M√≠nimo 50 m¬≤"), false);
  else if (m2 >= 50) setHint("m2", "‚úì", true);
  else setHint("m2", "", false);
};

/* ============================
   EVENTOS (con guardas)
   ============================ */
const on = (sel, ev, fn) => {
  if (typeof Q !== "function") return;
  const el = Q(sel);
  if (el) el.addEventListener(ev, fn);
};
const click = (sel, fn) => {
  if (typeof Q !== "function") return;
  const el = Q(sel);
  if (el) el.onclick = fn;
};

click("#np", () => {
  const nm = (Q("#nm")?.value || "").trim();
  const ag = +Q("#ag")?.value || 0;
  if (!nm || ag < 18 || ag > 100) { toast(t("toastCheck")); return; }
  saveForm(); show("e");
});

click("#ne", () => { saveForm(); show("f"); });
click("#go", () => analyze && analyze());

click("#cp", () => {
  if (!window.last) { toast(t("toastFirst")); return; }
  const txt = Q("#rt")?.textContent || "";
  if (!txt) return;
  navigator.clipboard?.writeText(txt)
    .then(() => toast(t("toastCopied")))
    .catch(() => {
      const ta = document.createElement("textarea");
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      toast(t("toastCopied"));
    });
});

click("#rs", () => {
  if (confirm(LANG === "EN" ? "Reset everything?" : "¬øReiniciar todo?")) {
    localStorage.clear();
    location.reload();
  }
});

click("#jumpX", () => { if (!window.last) { toast(t("toastFirst")); return; } show("x"); });
click("#jumpAI", () => { if (!window.last) { toast(t("toastFirst")); return; } show("ai"); });

click("#shareWa", () => {
  if (!window.last) { toast(t("toastFirst")); return; }
  const txt = Q("#rt")?.textContent || "";
  window.open("https://wa.me/?text=" + encodeURIComponent(txt), "_blank", "noopener");
});
click("#shareCl", () => Q("#cp")?.click());

click("#t_p", () => show("p"));
click("#t_e", () => show("e"));
click("#t_f", () => show("f"));
click("#t_r", () => { if (!window.last) { toast(t("toastFirst")); return; } show("r"); });
click("#t_m", () => { if (!window.last) { toast(t("toastFirst")); return; } show("m"); });
click("#t_x", () => { if (!window.last) { toast(t("toastFirst")); return; } show("x"); });
click("#t_ai", () => { if (!window.last) { toast(t("toastFirst")); return; } show("ai"); });

click("#toggleMap", () => {
  const box = Q("#zoneWrap");
  if (!box) return;
  const open = box.style.display !== "none";
  box.style.display = open ? "none" : "block";
  if (!open) {
    initMap && initMap();
    setTimeout(() => {
      if (window.zmap && typeof window.zmap.invalidateSize === "function") window.zmap.invalidateSize();
      box.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }, 250);
  }
});

click("#zoneClear", () => {
  if (!window.zoneSel || !window.polygonsByName) return;
  zoneSel.clear();
  polygonsByName.forEach((_, n) => applyPolygonState && applyPolygonState(n));
  renderZoneUI && renderZoneUI();
  saveZoneSel && saveZoneSel();
  toast(t("toastZoneCleared"));
});

click("#zoneApply", () => {
  if (!window.zoneSel || !zoneSel.size) { toast(t("toastNoZone")); return; }
  const ar = Q("#ar");
  if (!ar) return;

  const pm = ar.querySelector('[value="__multi__"]');
  if (pm) pm.remove();

  if (zoneSel.size === 1) {
    ar.value = [...zoneSel][0];
  } else {
    const mo = document.createElement("option");
    mo.value = "__multi__";
    mo.textContent = [...zoneSel].join(", ");
    ar.insertBefore(mo, ar.options[1] || null);
    ar.value = "__multi__";
  }
  saveZoneSel && saveZoneSel();
  saveForm && saveForm();
  toast(t("toastZoneApplied"));
});

click("#bc", () => compare && compare());
click("#autoFillCmp", () => fillFromLast && fillFromLast());
on("#cm", "change", () => upMap && upMap());

click("#L_CA", () => setLang && setLang("CA"));
click("#L_ES", () => setLang && setLang("ES"));
click("#L_EN", () => setLang && setLang("EN"));

["inc", "sav", "m2"].forEach(id => on("#" + id, "input", liveValidate));
["#nm", "#ag", "#inc", "#sav", "#yrs", "#msv", "#m2", "#bed", "#bat"].forEach(sel => on(sel, "change", () => saveForm && saveForm()));

/* ============================
   INIT (solo una vez, sin llaves raras)
   ============================ */
(() => {
  try {
    loadZoneSel && loadZoneSel();
    loadForm && loadForm();
    setLang && setLang(LANG);
    setTabsEnabled && setTabsEnabled();
    liveValidate();
    show && show("p");

    // Si tu chat engine expone initChatUI, inicial√≠zalo aqu√≠ cuando toque
    if (typeof window.initChatUI === "function") window.initChatUI();

    // Leaflet si aplica
    if (typeof waitForLeaflet === "function") waitForLeaflet();
  } catch (e) {
    console.error("INIT error:", e);
  }
})();
</script>
</body>
</html>
