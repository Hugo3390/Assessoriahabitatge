<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="theme-color" content="#0b1220"/>
  <title>Assessoria d‚ÄôHabitatge ¬∑ Baix Pened√®s</title>
  <meta name="description" content="Assessoria d‚ÄôHabitatge: simulador profesional y humano para decidir entre alquilar o comprar, con recomendaciones personalizadas, comparador y b√∫squeda de ejemplos."/>
  <meta property="og:title" content="Assessoria d‚ÄôHabitatge ¬∑ Baix Pened√®s"/>
  <meta property="og:description" content="Decide entre alquilar o comprar con recomendaciones personalizadas, comparador y ejemplos reales."/>
  <meta property="og:type" content="website"/>
  <style>
    :root{
      --bg:#070b14;
      --bg2:#0b1220;
      --card:rgba(17,24,39,.72);
      --card2:rgba(2,6,23,.62);
      --bd:rgba(148,163,184,.20);
      --bd2:rgba(148,163,184,.10);
      --t:#e5e7eb;
      --m:#a7b0c0;
      --muted:#94a3b8;
      --pill:#38bdf8;
      --pill2:#22c55e;
      --warn:#f59e0b;
      --bad:#fb7185;
      --good:#34d399;
      --shadow:0 18px 65px rgba(0,0,0,.50);
      --shadow2:0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --r2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--t);
      background:
        radial-gradient(900px 420px at 15% 8%, rgba(56,189,248,.18), transparent 55%),
        radial-gradient(900px 420px at 85% 12%, rgba(34,197,94,.14), transparent 55%),
        radial-gradient(1100px 520px at 40% 95%, rgba(245,158,11,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{max-width:1220px;margin:0 auto;padding:22px 16px 46px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      position:sticky;top:0;z-index:10;
      margin:-22px -16px 18px;
      padding:14px 16px;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(7,11,20,.85), rgba(7,11,20,.55));
      border-bottom:1px solid var(--bd2);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:240px}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:
        radial-gradient(12px 12px at 30% 30%, rgba(255,255,255,.85), transparent 60%),
        linear-gradient(135deg, rgba(56,189,248,.95), rgba(34,197,94,.85));
      box-shadow:0 10px 30px rgba(56,189,248,.12);
      border:1px solid rgba(255,255,255,.12);
    }
    .brand h1{font-size:14.5px;margin:0;letter-spacing:.2px;line-height:1.1}
    .brand p{margin:2px 0 0;color:var(--m);font-size:12px}
    .toolbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      background:rgba(15,23,42,.72);
      border:1px solid var(--bd2);
      box-shadow: var(--shadow2);
    }
    .btn{
      appearance:none;border:none;cursor:pointer;
      padding:10px 12px;border-radius:12px;
      background:rgba(15,23,42,.85);
      color:var(--t);
      border:1px solid var(--bd2);
      box-shadow: var(--shadow2);
      transition:transform .08s ease, border-color .2s ease, background .2s ease;
      font-weight:650;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(56,189,248,.35)}
    .btn:active{transform:translateY(0)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(56,189,248,.95), rgba(34,197,94,.78));
      color:#041018;border-color:rgba(255,255,255,.18)
    }
    .btn.ghost{background:transparent}
    .btn.bad{background:rgba(251,113,133,.12);border-color:rgba(251,113,133,.28);color:#ffdbe2}
    .select, .input{
      width:100%;
      background:rgba(2,6,23,.55);
      border:1px solid var(--bd2);
      color:var(--t);
      padding:11px 12px;
      border-radius:14px;
      outline:none;
      transition:border-color .2s ease, box-shadow .2s ease;
    }
    .input:focus, .select:focus{border-color:rgba(56,189,248,.45);box-shadow:0 0 0 4px rgba(56,189,248,.10)}
    .label{display:flex;align-items:flex-end;justify-content:space-between;gap:8px}
    .label span{font-size:12px;color:var(--m)}
    .hint{font-size:12px;color:var(--muted);line-height:1.45}
    .grid{
      display:grid;gap:14px;
      grid-template-columns: 1.15fr .85fr;
      align-items:start;
    }
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background: linear-gradient(180deg, rgba(17,24,39,.74), rgba(2,6,23,.55));
      border:1px solid var(--bd2);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:16px 16px 10px;
      border-bottom:1px solid rgba(148,163,184,.10);
    }
    .title{margin:0;font-size:14px;letter-spacing:.2px}
    .sub{margin:2px 0 0;color:var(--m);font-size:12px}
    .body{padding:16px}
    .kpiRow{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
    @media (max-width:680px){.kpiRow{grid-template-columns:1fr}}
    .kpi{
      padding:12px 12px;border-radius:16px;border:1px solid rgba(148,163,184,.12);
      background:rgba(2,6,23,.45);
    }
    .kpi .k{font-size:11px;color:var(--m);letter-spacing:.2px}
    .kpi .v{margin-top:6px;font-size:18px;font-weight:800}
    .kpi .d{margin-top:4px;font-size:12px;color:var(--muted);line-height:1.35}
    .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media (max-width:680px){.row{grid-template-columns:1fr}}
    .sep{height:1px;background:rgba(148,163,184,.12);margin:14px 0}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(2,6,23,.45);
      color:var(--t);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{width:9px;height:9px;border-radius:999px;background:var(--pill)}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .panel{
      padding:14px;border-radius:16px;
      border:1px solid rgba(148,163,184,.12);
      background:rgba(2,6,23,.45);
    }
    .panel h3{margin:0 0 8px;font-size:13px}
    .panel p{margin:0;color:var(--m);font-size:13px;line-height:1.55}
    .list{margin:10px 0 0;padding:0;list-style:none;display:grid;gap:8px}
    .li{
      padding:10px 10px;border-radius:14px;
      border:1px solid rgba(148,163,184,.10);
      background:rgba(15,23,42,.35);
      display:flex;gap:10px;align-items:flex-start;
    }
    .li b{display:block;font-size:12.5px}
    .li span{display:block;font-size:12px;color:var(--muted);line-height:1.45;margin-top:2px}
    .mini{
      width:100%;height:120px;border-radius:16px;border:1px solid rgba(148,163,184,.12);
      background:linear-gradient(180deg, rgba(2,6,23,.45), rgba(2,6,23,.20));
      position:relative;overflow:hidden;
    }
    canvas{display:block;width:100%;height:100%}
    .footer{
      margin-top:16px;color:rgba(167,176,192,.95);
      font-size:12px;line-height:1.55;
      opacity:.95;
    }
    .toastWrap{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.55);z-index:50;padding:18px;
    }
    .toast{
      width:min(560px, 100%);
      border-radius:20px;
      border:1px solid rgba(148,163,184,.20);
      background:linear-gradient(180deg, rgba(17,24,39,.95), rgba(2,6,23,.86));
      box-shadow:0 20px 80px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .toast .thd{
      padding:14px 16px;border-bottom:1px solid rgba(148,163,184,.12);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .toast .thd b{font-size:13px}
    .toast .tbd{padding:14px 16px}
    .toast .tbd p{margin:0;color:var(--m);font-size:13px;line-height:1.6}
    .toast .tft{padding:12px 16px;border-top:1px solid rgba(148,163,184,.12);display:flex;justify-content:flex-end;gap:10px}
    .kbd{font-family:var(--mono);font-size:11px;color:#cbd5e1;border:1px solid rgba(148,163,184,.20);background:rgba(2,6,23,.55);padding:2px 6px;border-radius:8px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .right{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:14px;
      border:1px solid rgba(148,163,184,.12);
      background:rgba(2,6,23,.45);
      font-size:12px;color:var(--m)
    }
    .mono{font-family:var(--mono)}
    .sr{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
    .twoCol{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media (max-width:680px){.twoCol{grid-template-columns:1fr}}
    .donateGrid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media (max-width:980px){.donateGrid{grid-template-columns:1fr}}
    .notice{
      padding:12px 12px;border-radius:16px;border:1px solid rgba(148,163,184,.12);
      background:rgba(56,189,248,.08);
      color:#dbeafe;
      font-size:12.5px;line-height:1.5
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand" role="banner">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1 id="appTitle">Assessoria d‚ÄôHabitatge</h1>
        <p id="appSubtitle">Simulador realista ¬∑ Baix Pened√®s</p>
      </div>
    </div>

    <div class="toolbar">
      <div class="pill" title="Idioma">
        <span class="muted small" id="langLbl">Idioma</span>
        <select class="select" id="lang" style="width:auto;min-width:140px;padding:9px 10px;border-radius:999px">
          <option value="es">Espa√±ol</option>
          <option value="ca">Catal√†</option>
          <option value="en">English</option>
        </select>
      </div>
      <button class="btn ghost" id="btnVisit" type="button">Visit site</button>
      <button class="btn bad" id="btnReset" type="button">Reset</button>
      <button class="btn primary" id="btnAnalyze" type="button">Analyze</button>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">

      <!-- LEFT: FORM -->
      <section class="card" aria-labelledby="formTitle">
        <div class="hd">
          <div>
            <h2 class="title" id="formTitle">Datos de tu caso</h2>
            <p class="sub" id="formSub">Cuanto m√°s preciso seas, m√°s honesta ser√° la recomendaci√≥n.</p>
          </div>
          <div class="right">
            <span class="badge" id="scopeBadge">√Åmbito: Baix Pened√®s</span>
            <span class="badge mono" id="versionBadge">v2.0</span>
          </div>
        </div>

        <div class="body">
          <div class="row">
            <div>
              <div class="label">
                <span id="munLbl">Municipio (para contexto)</span>
                <span class="hint" id="munHint">La b√∫squeda se hace en todo el Baix Pened√®s.</span>
              </div>
              <select class="select" id="municipi">
                <option value="">0</option>
                <option>Cunit</option>
                <option>Calafell</option>
                <option>El Vendrell</option>
                <option>Santa Oliva</option>
                <option>L‚ÄôArbo√ß</option>
                <option>Bellvei</option>
                <option>La Bisbal del Pened√®s</option>
                <option>Banyeres del Pened√®s</option>
                <option>Sant Jaume dels Domenys</option>
              </select>
              <div class="hint" id="munFoot" style="margin-top:6px">
                No bloquea nada si eliges otro municipio: solo ajusta el ‚Äútono‚Äù y referencias de precios.
              </div>
            </div>

            <div>
              <div class="label">
                <span id="typeLbl">Tipo de vivienda</span>
                <span class="hint" id="typeHint">Cambia la l√≥gica de extras y comparables.</span>
              </div>
              <select class="select" id="tipus">
                <option value="">0</option>
                <option value="flat">Piso</option>
                <option value="house">Casa</option>
              </select>
              <div class="hint" id="typeFoot" style="margin-top:6px">
                Piso = m√°s peso a comunidad/ascensor. Casa = m√°s peso a estado, parcela y mantenimiento.
              </div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row">
            <div>
              <div class="label"><span id="roomsLbl">Habitaciones</span><span class="hint"><span class="kbd">0</span> si no sabes</span></div>
              <input class="input" id="rooms" type="number" min="0" step="1" value="0" inputmode="numeric"/>
            </div>
            <div>
              <div class="label"><span id="bathsLbl">Ba√±os</span><span class="hint"><span class="kbd">0</span> si no sabes</span></div>
              <input class="input" id="baths" type="number" min="0" step="1" value="0" inputmode="numeric"/>
            </div>
          </div>

          <div style="margin-top:12px" class="row">
            <div>
              <div class="label"><span id="m2Lbl">Metros cuadrados (m¬≤)</span><span class="hint">√ötil para comparar precios</span></div>
              <input class="input" id="m2" type="number" min="0" step="1" value="0" inputmode="numeric" placeholder="0"/>
              <div class="hint" id="m2Foot" style="margin-top:6px">
                Si pones 0, el comparador ser√° menos preciso, pero no te va a insultar (mucho).
              </div>
            </div>
            <div>
              <div class="label"><span id="budgetLbl">Presupuesto (compra o alquiler)</span><span class="hint">‚Ç¨ / mes o ‚Ç¨ total</span></div>
              <input class="input" id="budget" type="number" min="0" step="50" value="0" inputmode="numeric"/>
              <div class="hint" id="budgetFoot" style="margin-top:6px">
                Si quieres alquiler: pon tu tope mensual. Si quieres compra: pon el precio objetivo total.
              </div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row">
            <div>
              <div class="label"><span id="incomeLbl">Ingresos netos mensuales</span><span class="hint">‚Ç¨</span></div>
              <input class="input" id="income" type="number" min="0" step="50" value="0" inputmode="numeric"/>
            </div>
            <div>
              <div class="label"><span id="savingsLbl">Ahorros disponibles</span><span class="hint">‚Ç¨</span></div>
              <input class="input" id="savings" type="number" min="0" step="100" value="0" inputmode="numeric"/>
            </div>
          </div>

          <div style="margin-top:12px" class="row">
            <div>
              <div class="label"><span id="termLbl">Plazo hipoteca</span><span class="hint">a√±os</span></div>
              <input class="input" id="term" type="number" min="0" step="1" value="0" inputmode="numeric"/>
            </div>
            <div>
              <div class="label"><span id="rateLbl">Inter√©s anual (aprox.)</span><span class="hint">%</span></div>
              <input class="input" id="rate" type="number" min="0" step="0.1" value="0" inputmode="decimal"/>
            </div>
          </div>

          <div class="sep"></div>

          <div class="panel">
            <h3 id="extrasTitle">Extras (opcional)</h3>
            <p id="extrasSub">No son ‚Äúcaprichos‚Äù: cambian el precio real y los comparables.</p>
            <ul class="list" id="extrasList"></ul>
          </div>

          <div class="footer" id="formFooter">
            Consejo realista: si metes todo a cero, te dar√© una recomendaci√≥n igualmente, pero ser√° muy gen√©rica.
            En la vida real, las decisiones con datos ‚Äú0‚Äù suelen acabar en ‚Äúsorpresa‚Äù. Y no de las buenas.
          </div>
        </div>
      </section>

      <!-- RIGHT: OUTPUT -->
      <aside class="card" aria-labelledby="outTitle">
        <div class="hd">
          <div>
            <h2 class="title" id="outTitle">Resultado y recomendaci√≥n</h2>
            <p class="sub" id="outSub">Explicaci√≥n clara, realista y accionable. Sin humo.</p>
          </div>
          <div class="right">
            <span class="tag" id="statusTag"><span class="dot" id="statusDot"></span><span id="statusTxt">Sin analizar</span></span>
          </div>
        </div>

        <div class="body">
          <div class="kpiRow" aria-label="Indicadores">
            <div class="kpi">
              <div class="k" id="kpi1k">Capacidad mensual</div>
              <div class="v" id="kpi1v">0 ‚Ç¨</div>
              <div class="d" id="kpi1d">Lo que puedes destinar sin asfixiarte.</div>
            </div>
            <div class="kpi">
              <div class="k" id="kpi2k">Precio estimado</div>
              <div class="v" id="kpi2v">0 ‚Ç¨</div>
              <div class="d" id="kpi2d">Estimaci√≥n basada en Baix Pened√®s.</div>
            </div>
            <div class="kpi">
              <div class="k" id="kpi3k">Decisi√≥n sugerida</div>
              <div class="v" id="kpi3v">‚Äî</div>
              <div class="d" id="kpi3d">Compra, alquiler o espera con plan.</div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="mini" aria-label="Mini gr√°fica">
            <canvas id="chart"></canvas>
          </div>
          <div class="hint" id="chartHint" style="margin-top:8px">
            Visual r√°pido: coste mensual compra vs alquiler, y el margen de seguridad seg√∫n tus ingresos.
          </div>

          <div class="sep"></div>

          <div class="panel" id="humanPanel">
            <h3 id="humanTitle">Explicaci√≥n humana</h3>
            <p id="humanText">Introduce tus datos y pulsa <b>Analyze</b>. Te dir√© lo que har√≠a una persona sensata, no un anuncio.</p>
          </div>

          <div class="sep"></div>

          <div class="twoCol">
            <div class="panel">
              <h3 id="nextTitle">Siguientes pasos</h3>
              <ul class="list" id="nextSteps"></ul>
            </div>
            <div class="panel">
              <h3 id="compareTitle">Comparador r√°pido</h3>
              <p id="compareText">Te mostrar√© si tu precio objetivo cuadra con un rango realista del Baix Pened√®s.</p>
              <div class="sep"></div>
              <div id="compareBadges" style="display:flex;gap:10px;flex-wrap:wrap"></div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="panel">
            <h3 id="searchTitle">B√∫squeda de ejemplos (Baix Pened√®s)</h3>
            <p id="searchSub">No puedo ‚Äúleer‚Äù portales en tiempo real desde un HTML est√°tico, pero s√≠ puedo generarte b√∫squedas limpias y √∫tiles.</p>
            <div class="sep"></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <a class="btn" id="btnIdealista" target="_blank" rel="noreferrer">Idealista</a>
              <a class="btn" id="btnFotocasa" target="_blank" rel="noreferrer">Fotocasa</a>
              <a class="btn" id="btnHabitaclia" target="_blank" rel="noreferrer">Habitaclia</a>
            </div>
            <div class="hint" id="searchFoot" style="margin-top:8px">
              Se abre en nueva pesta√±a con filtros aproximados: zona Baix Pened√®s, tipo, habitaciones y un rango de m¬≤ (¬±20).
            </div>
          </div>

          <div class="sep"></div>

          <div class="card" style="background:transparent;border:1px solid rgba(148,163,184,.12);box-shadow:none">
            <div class="body donateGrid">
              <div>
                <div class="notice" id="donNotice">
                  Esto es gratis porque as√≠ debe ser. Si te ahorra tiempo o errores, puedes dejar una aportaci√≥n voluntaria para mantener y mejorar descargables y herramientas.
                </div>
                <div style="margin-top:10px" class="hint" id="donHint">
                  Importante: esto no desbloquea funciones. Es solo un ‚Äúgracias‚Äù opcional.
                </div>
              </div>
              <div>
                <div class="label"><span id="donLbl">Aportaci√≥n voluntaria</span><span class="hint">‚Ç¨</span></div>
                <input class="input" id="donAmount" type="number" min="0" step="1" value="0" inputmode="numeric"/>
                <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
                  <button class="btn" id="btnCopyBizum" type="button">Copy details</button>
                  <button class="btn primary" id="btnDonate" type="button">Donate</button>
                </div>
                <div class="hint" id="donFoot" style="margin-top:8px">
                  Aqu√≠ puedes poner Bizum/PayPal/Stripe link cuando lo tengas. Por ahora, se queda en modo ‚Äúcopiar‚Äù.
                </div>
              </div>
            </div>
          </div>

          <div class="footer" id="legal">
            Aviso: esto es una gu√≠a educativa. No es asesoramiento financiero oficial. Aun as√≠, est√° hecho para sonar y pensar como una persona real, no como un folleto.
          </div>

        </div>
      </aside>

    </div>
  </div>

  <!-- POPUP -->
  <div class="toastWrap" id="toastWrap" role="dialog" aria-modal="true" aria-labelledby="toastTitle">
    <div class="toast">
      <div class="thd">
        <b id="toastTitle">Atenci√≥n</b>
        <button class="btn ghost" id="toastClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="tbd">
        <p id="toastMsg"></p>
      </div>
      <div class="tft">
        <button class="btn primary" id="toastOk" type="button">OK</button>
      </div>
    </div>
  </div>

<script>
/*  Assessoria d‚ÄôHabitatge ¬∑ v2
    - No backend. HTML est√°tico. Enfocado en: claridad, validaci√≥n, explicaci√≥n humana y acciones.
    - √Åmbito: Baix Pened√®s (siempre). El municipio es contexto, no filtro restrictivo.
*/
(() => {
  "use strict";

  // ---------- Utilities ----------
  const $ = (id) => document.getElementById(id);
  const clamp = (n, a, b) => Math.min(b, Math.max(a, n));
  const num = (v) => {
    const x = Number(String(v ?? "").replace(",", "."));
    return isFinite(x) ? x : 0;
  };
  const fmtEUR = (v) => new Intl.NumberFormat(undefined, { style:"currency", currency:"EUR", maximumFractionDigits:0 }).format(v);
  const fmtPct = (v) => (Math.round(v*10)/10).toFixed(1) + "%";
  const safeText = (s) => String(s ?? "").replace(/[<>]/g, "");
  const now = () => Date.now();

  // ---------- i18n ----------
  const I18N = {
    es: {
      appTitle: "Assessoria d‚ÄôHabitatge",
      appSubtitle: "Simulador realista ¬∑ Baix Pened√®s",
      langLbl: "Idioma",
      formTitle: "Datos de tu caso",
      formSub: "Cuanto m√°s preciso seas, m√°s honesta ser√° la recomendaci√≥n.",
      scopeBadge: "√Åmbito: Baix Pened√®s",
      munLbl: "Municipio (para contexto)",
      munHint: "La b√∫squeda se hace en todo el Baix Pened√®s.",
      munFoot: "No bloquea nada si eliges otro municipio: solo ajusta el ‚Äútono‚Äù y referencias de precios.",
      typeLbl: "Tipo de vivienda",
      typeHint: "Cambia la l√≥gica de extras y comparables.",
      typeFoot: "Piso = m√°s peso a comunidad/ascensor. Casa = m√°s peso a estado, parcela y mantenimiento.",
      roomsLbl: "Habitaciones",
      bathsLbl: "Ba√±os",
      m2Lbl: "Metros cuadrados (m¬≤)",
      m2Foot: "Si pones 0, el comparador ser√° menos preciso, pero no te va a insultar (mucho).",
      budgetLbl: "Presupuesto (compra o alquiler)",
      budgetFoot: "Si quieres alquiler: pon tu tope mensual. Si quieres compra: pon el precio objetivo total.",
      incomeLbl: "Ingresos netos mensuales",
      savingsLbl: "Ahorros disponibles",
      termLbl: "Plazo hipoteca",
      rateLbl: "Inter√©s anual (aprox.)",
      extrasTitle: "Extras (opcional)",
      extrasSub: "No son ‚Äúcaprichos‚Äù: cambian el precio real y los comparables.",
      formFooter: "Consejo realista: si metes todo a cero, te dar√© una recomendaci√≥n igualmente, pero ser√° muy gen√©rica. En la vida real, las decisiones con datos ‚Äú0‚Äù suelen acabar en ‚Äúsorpresa‚Äù. Y no de las buenas.",
      outTitle: "Resultado y recomendaci√≥n",
      outSub: "Explicaci√≥n clara, realista y accionable. Sin humo.",
      statusIdle: "Sin analizar",
      statusOk: "Listo",
      statusWarn: "Revisar",
      statusBad: "Faltan datos",
      kpi1k: "Capacidad mensual",
      kpi1d: "Lo que puedes destinar sin asfixiarte.",
      kpi2k: "Precio estimado",
      kpi2d: "Estimaci√≥n basada en Baix Pened√®s.",
      kpi3k: "Decisi√≥n sugerida",
      kpi3d: "Compra, alquiler o espera con plan.",
      chartHint: "Visual r√°pido: coste mensual compra vs alquiler, y el margen de seguridad seg√∫n tus ingresos.",
      humanTitle: "Explicaci√≥n humana",
      humanIdle: "Introduce tus datos y pulsa Analyze. Te dir√© lo que har√≠a una persona sensata, no un anuncio.",
      nextTitle: "Siguientes pasos",
      compareTitle: "Comparador r√°pido",
      compareText: "Te mostrar√© si tu precio objetivo cuadra con un rango realista del Baix Pened√®s.",
      searchTitle: "B√∫squeda de ejemplos (Baix Pened√®s)",
      searchSub: "No puedo ‚Äúleer‚Äù portales en tiempo real desde un HTML est√°tico, pero s√≠ puedo generarte b√∫squedas limpias y √∫tiles.",
      searchFoot: "Se abre en nueva pesta√±a con filtros aproximados: zona Baix Pened√®s, tipo, habitaciones y un rango de m¬≤ (¬±20).",
      donateNotice: "Esto es gratis porque as√≠ debe ser. Si te ahorra tiempo o errores, puedes dejar una aportaci√≥n voluntaria para mantener y mejorar descargables y herramientas.",
      donateHint: "Importante: esto no desbloquea funciones. Es solo un ‚Äúgracias‚Äù opcional.",
      donLbl: "Aportaci√≥n voluntaria",
      btnCopy: "Copy details",
      btnDonate: "Donate",
      donFoot: "Aqu√≠ puedes poner Bizum/PayPal/Stripe link cuando lo tengas. Por ahora, se queda en modo ‚Äúcopiar‚Äù.",
      legal: "Aviso: esto es una gu√≠a educativa. No es asesoramiento financiero oficial. Aun as√≠, est√° hecho para sonar y pensar como una persona real, no como un folleto.",
      visit: "Visit site",
      reset: "Reset",
      analyze: "Analyze",
      ok: "OK",
      toastTitle: "Atenci√≥n",
      // validation messages
      v_needSomething: "Ahora mismo todo est√° a 0. Puedo analizar igual, pero la recomendaci√≥n ser√° muy gen√©rica. Si quieres algo realmente √∫til, a√±ade al menos: ingresos, presupuesto y m¬≤.",
      v_budgetIncome: "Para darte una recomendaci√≥n realista necesito al menos: ingresos mensuales y tu presupuesto (compra o alquiler).",
      v_buyNeedsTermRate: "Si quieres analizar compra con hipoteca, necesito plazo (a√±os) e inter√©s (%). Si no los sabes, pon una estimaci√≥n (por ejemplo 25 a√±os y 3.5%).",
      v_m2TooLow: "Los m¬≤ no pueden ser negativos. S√≠, hay pisos peque√±os, pero no en el multiverso.",
      copied: "Copiado. Pega aqu√≠ tus datos reales (Bizum/PayPal/Stripe) cuando los tengas.",
      donated: "Vale. En esta demo no se cobra nada. Pero tu intenci√≥n es preciosa y rar√≠sima. üëå",
      // extras
      ex_terrace: "Terraza / balc√≥n",
      ex_elevator: "Ascensor",
      ex_parking: "Parking",
      ex_pool: "Piscina",
      ex_garden: "Jard√≠n",
      ex_renovated: "Reformado",
      ex_seaview: "Vistas / cerca del mar",
      ex_storage: "Trastero",
      ex_ac: "Aire acondicionado",
      ex_heating: "Calefacci√≥n",
      // next steps templates
      ns1: "Define tu objetivo real (alquiler vs compra) con un n√∫mero concreto, no con ‚Äúya veremos‚Äù.",
      ns2: "Si compras: reserva 10‚Äì12% extra del precio para impuestos y gastos (aprox.).",
      ns3: "No te enamores del primer anuncio. Compara m√≠nimo 8‚Äì12 opciones con tus filtros.",
      ns4: "Con tu capacidad mensual, fija un ‚Äúl√≠mite duro‚Äù y uno ‚Äúc√≥modo‚Äù. Lo c√≥modo es el que te salva.",
      ns5: "Haz una lista de no-negociables (m¬≤, luz natural, ubicaci√≥n, estado) y una de caprichos.",
    },
    ca: {
      appTitle: "Assessoria d‚ÄôHabitatge",
      appSubtitle: "Simulador realista ¬∑ Baix Pened√®s",
      langLbl: "Idioma",
      formTitle: "Dades del teu cas",
      formSub: "Com m√©s prec√≠s siguis, m√©s honesta ser√† la recomanaci√≥.",
      scopeBadge: "√Ämbit: Baix Pened√®s",
      munLbl: "Municipi (per context)",
      munHint: "La cerca es fa a tot el Baix Pened√®s.",
      munFoot: "No bloqueja res si tries un altre municipi: nom√©s ajusta el ‚Äúto‚Äù i refer√®ncies de preus.",
      typeLbl: "Tipus d‚Äôhabitatge",
      typeHint: "Canvia la l√≤gica d‚Äôextres i comparables.",
      typeFoot: "Pis = m√©s pes a comunitat/ascensor. Casa = m√©s pes a estat, parcel¬∑la i manteniment.",
      roomsLbl: "Habitacions",
      bathsLbl: "Banys",
      m2Lbl: "Metres quadrats (m¬≤)",
      m2Foot: "Si poses 0, el comparador ser√† menys prec√≠s, per√≤ no et faltar√† al respecte (gaire).",
      budgetLbl: "Pressupost (compra o lloguer)",
      budgetFoot: "Si vols lloguer: posa el teu m√†xim mensual. Si vols compra: posa el preu objectiu total.",
      incomeLbl: "Ingressos nets mensuals",
      savingsLbl: "Estalvis disponibles",
      termLbl: "Termini hipoteca",
      rateLbl: "Inter√®s anual (aprox.)",
      extrasTitle: "Extres (opcional)",
      extrasSub: "No s√≥n ‚Äúcapricis‚Äù: canvien el preu real i els comparables.",
      formFooter: "Consell realista: si ho deixes tot a zero, t‚Äôanalitzar√© igual, per√≤ ser√† gen√®ric. A la vida real, les decisions amb dades ‚Äú0‚Äù acaben en ‚Äúsorpresa‚Äù. I no de les bones.",
      outTitle: "Resultat i recomanaci√≥",
      outSub: "Explicaci√≥ clara, realista i accionable. Sense fum.",
      statusIdle: "Sense analitzar",
      statusOk: "Fet",
      statusWarn: "Revisar",
      statusBad: "Falten dades",
      kpi1k: "Capacitat mensual",
      kpi1d: "El que pots destinar sense ofegar-te.",
      kpi2k: "Preu estimat",
      kpi2d: "Estimaci√≥ basada en Baix Pened√®s.",
      kpi3k: "Decisi√≥ suggerida",
      kpi3d: "Compra, lloguer o esperar amb pla.",
      chartHint: "Visual r√†pid: cost mensual compra vs lloguer, i marge de seguretat segons ingressos.",
      humanTitle: "Explicaci√≥ humana",
      humanIdle: "Introdueix dades i prem Analyze. Et dir√© qu√® faria una persona sensata, no un anunci.",
      nextTitle: "Seg√ºents passos",
      compareTitle: "Comparador r√†pid",
      compareText: "Et mostrar√© si el teu objectiu encaixa amb un rang realista del Baix Pened√®s.",
      searchTitle: "Cerca d‚Äôexemples (Baix Pened√®s)",
      searchSub: "No puc ‚Äúllegir‚Äù portals en temps real des d‚Äôun HTML est√†tic, per√≤ s√≠ generar cerques netes i √∫tils.",
      searchFoot: "S‚Äôobre en una pestanya nova amb filtres aproximats: Baix Pened√®s, tipus, habitacions i rang de m¬≤ (¬±20).",
      donateNotice: "Aix√≤ √©s gratis perqu√® aix√≠ ha de ser. Si t‚Äôestalvia temps o errors, pots deixar una aportaci√≥ volunt√†ria per mantenir i millorar descarregables i eines.",
      donateHint: "Important: aix√≤ no desbloqueja funcions. √âs nom√©s un ‚Äúgr√†cies‚Äù opcional.",
      donLbl: "Aportaci√≥ volunt√†ria",
      btnCopy: "Copy details",
      btnDonate: "Donate",
      donFoot: "Aqu√≠ pots posar Bizum/PayPal/Stripe quan ho tinguis. Per ara queda en mode ‚Äúcopiar‚Äù.",
      legal: "Av√≠s: guia educativa. No √©s assessorament financer oficial. Tot i aix√≠, est√† pensat per sonar i pensar com una persona real, no com un fullet√≥.",
      visit: "Visit site",
      reset: "Reset",
      analyze: "Analyze",
      ok: "OK",
      toastTitle: "Atenci√≥",
      v_needSomething: "Ara mateix tot √©s 0. Puc analitzar igual, per√≤ ser√† molt gen√®ric. Si vols utilitat real, afegeix com a m√≠nim: ingressos, pressupost i m¬≤.",
      v_budgetIncome: "Per una recomanaci√≥ realista necessito com a m√≠nim: ingressos mensuals i pressupost (compra o lloguer).",
      v_buyNeedsTermRate: "Si vols analitzar compra amb hipoteca, necessito termini (anys) i inter√®s (%). Si no els saps, posa una estimaci√≥ (p. ex. 25 anys i 3.5%).",
      v_m2TooLow: "Els m¬≤ no poden ser negatius. S√≠, hi ha pisos petits, per√≤ no aix√≠.",
      copied: "Copiat. Quan tinguis dades reals (Bizum/PayPal/Stripe), les enganxes on toqui.",
      donated: "En aquesta demo no es cobra res. Per√≤ la intenci√≥ √©s bona i rara. üëå",
      ex_terrace: "Terrassa / balc√≥",
      ex_elevator: "Ascensor",
      ex_parking: "P√†rquing",
      ex_pool: "Piscina",
      ex_garden: "Jard√≠",
      ex_renovated: "Reformat",
      ex_seaview: "Vistes / a prop del mar",
      ex_storage: "Traster",
      ex_ac: "Aire condicionat",
      ex_heating: "Calefacci√≥",
      ns1: "Defineix l‚Äôobjectiu real (lloguer vs compra) amb un n√∫mero concret, no amb ‚Äúja veurem‚Äù.",
      ns2: "Si compres: reserva un 10‚Äì12% extra per impostos i despeses (aprox.).",
      ns3: "No t‚Äôenamoris del primer anunci. Compara m√≠nim 8‚Äì12 opcions amb els teus filtres.",
      ns4: "Amb la teva capacitat mensual, fixa un ‚Äúl√≠mit dur‚Äù i un ‚Äúc√≤mode‚Äù. El c√≤mode et salva.",
      ns5: "Fes una llista de no-negociables (m¬≤, llum, ubicaci√≥, estat) i una de capricis.",
    },
    en: {
      appTitle: "Housing Advisor",
      appSubtitle: "Realistic simulator ¬∑ Baix Pened√®s",
      langLbl: "Language",
      formTitle: "Your case details",
      formSub: "The more accurate you are, the more honest the recommendation will be.",
      scopeBadge: "Scope: Baix Pened√®s",
      munLbl: "Town (context only)",
      munHint: "Search always covers the entire Baix Pened√®s.",
      munFoot: "This does not restrict anything: it only adjusts tone and local references.",
      typeLbl: "Property type",
      typeHint: "Changes how extras and comps are evaluated.",
      typeFoot: "Flat = more weight on community/elevator. House = more weight on condition, land and maintenance.",
      roomsLbl: "Bedrooms",
      bathsLbl: "Bathrooms",
      m2Lbl: "Square meters (m¬≤)",
      m2Foot: "If you set 0, comparisons get less precise, but it still works.",
      budgetLbl: "Budget (rent or buy)",
      budgetFoot: "If renting: set your monthly cap. If buying: set your target total price.",
      incomeLbl: "Monthly net income",
      savingsLbl: "Available savings",
      termLbl: "Mortgage term",
      rateLbl: "Annual interest (approx.)",
      extrasTitle: "Extras (optional)",
      extrasSub: "Not just ‚Äúnice-to-haves‚Äù: they change real price and comparables.",
      formFooter: "Reality check: if everything is 0, I can still analyze, but it will be generic. Decisions with ‚Äú0 data‚Äù usually end in bad surprises.",
      outTitle: "Result & recommendation",
      outSub: "Clear, realistic, actionable. No fluff.",
      statusIdle: "Not analyzed",
      statusOk: "Ready",
      statusWarn: "Review",
      statusBad: "Missing data",
      kpi1k: "Monthly capacity",
      kpi1d: "What you can pay without choking.",
      kpi2k: "Estimated price",
      kpi2d: "Estimate based on Baix Pened√®s.",
      kpi3k: "Suggested decision",
      kpi3d: "Buy, rent, or wait with a plan.",
      chartHint: "Quick visual: buy monthly cost vs rent, and your safety margin vs income.",
      humanTitle: "Human explanation",
      humanIdle: "Enter your data and click Analyze. You‚Äôll get a sensible, human recommendation.",
      nextTitle: "Next steps",
      compareTitle: "Quick comparator",
      compareText: "I‚Äôll show whether your target price fits a realistic Baix Pened√®s range.",
      searchTitle: "Example search (Baix Pened√®s)",
      searchSub: "A static HTML can‚Äôt read portals live, but it can build clean searches with your filters.",
      searchFoot: "Opens in a new tab with approximate filters: Baix Pened√®s area, type, bedrooms, and m¬≤ range (¬±20).",
      donateNotice: "This is free because it should be. If it saves you time or mistakes, you can leave a voluntary tip to help maintain tools and downloads.",
      donateHint: "Important: this does not unlock features. It‚Äôs just an optional thanks.",
      donLbl: "Voluntary tip",
      btnCopy: "Copy details",
      btnDonate: "Donate",
      donFoot: "Add your Bizum/PayPal/Stripe link later. For now it‚Äôs ‚Äúcopy mode‚Äù.",
      legal: "Note: educational guidance only. Not official financial advice. Still: it‚Äôs designed to think like a real person, not a brochure.",
      visit: "Visit site",
      reset: "Reset",
      analyze: "Analyze",
      ok: "OK",
      toastTitle: "Heads up",
      v_needSomething: "Everything is 0 right now. I can still analyze, but it‚Äôll be generic. For useful output, add at least: income, budget, and m¬≤.",
      v_budgetIncome: "For a realistic recommendation I need at least: monthly income and your budget (rent or buy).",
      v_buyNeedsTermRate: "If you want a mortgage buy analysis, I need term (years) and interest (%). If unsure, estimate (e.g., 25 years and 3.5%).",
      v_m2TooLow: "m¬≤ can‚Äôt be negative. Physics is still a thing.",
      copied: "Copied. Replace with your real Bizum/PayPal/Stripe details when ready.",
      donated: "This demo doesn‚Äôt charge anything. But the intent is noted.",
      ex_terrace: "Terrace / balcony",
      ex_elevator: "Elevator",
      ex_parking: "Parking",
      ex_pool: "Pool",
      ex_garden: "Garden",
      ex_renovated: "Renovated",
      ex_seaview: "Views / near the sea",
      ex_storage: "Storage",
      ex_ac: "Air conditioning",
      ex_heating: "Heating",
      ns1: "Pick a real goal (rent vs buy) with a number, not ‚Äòwe‚Äôll see‚Äô.",
      ns2: "If buying: reserve ~10‚Äì12% extra for taxes and fees (approx.).",
      ns3: "Don‚Äôt fall for the first listing. Compare at least 8‚Äì12 options with your filters.",
      ns4: "Set a ‚Äòhard limit‚Äô and a ‚Äòcomfortable limit‚Äô. Comfortable is what saves you.",
      ns5: "Write non-negotiables (m¬≤, light, location, condition) and ‚Äònice-to-haves‚Äô.",
    }
  };

  function t(key){
    const lang = state.lang;
    return (I18N[lang] && I18N[lang][key]) || I18N.es[key] || key;
  }

  // ---------- State ----------
  const state = {
    lang: "es",
    lastAnalyzeAt: 0,
    extras: {
      terrace:false, elevator:false, parking:false, pool:false, garden:false,
      renovated:false, seaview:false, storage:false, ac:false, heating:false
    }
  };

  // ---------- Extras setup ----------
  const EXTRAS_DEF = [
    { key:"terrace",   labelKey:"ex_terrace",   weightBuy:+0.04, weightRent:+0.03 },
    { key:"elevator",  labelKey:"ex_elevator",  weightBuy:+0.02, weightRent:+0.02, only:"flat" },
    { key:"parking",   labelKey:"ex_parking",   weightBuy:+0.03, weightRent:+0.03 },
    { key:"pool",      labelKey:"ex_pool",      weightBuy:+0.05, weightRent:+0.04, mostly:"house" },
    { key:"garden",    labelKey:"ex_garden",    weightBuy:+0.05, weightRent:+0.03, mostly:"house" },
    { key:"renovated", labelKey:"ex_renovated", weightBuy:+0.03, weightRent:+0.03 },
    { key:"seaview",   labelKey:"ex_seaview",   weightBuy:+0.04, weightRent:+0.04 },
    { key:"storage",   labelKey:"ex_storage",   weightBuy:+0.02, weightRent:+0.02 },
    { key:"ac",        labelKey:"ex_ac",        weightBuy:+0.01, weightRent:+0.01 },
    { key:"heating",   labelKey:"ex_heating",   weightBuy:+0.01, weightRent:+0.01 },
  ];

  function renderExtras(){
    const list = $("extrasList");
    list.innerHTML = "";
    const type = $("tipus").value || "";
    EXTRAS_DEF.forEach(x => {
      if(x.only && x.only !== type && type) return;
      const li = document.createElement("li");
      li.className = "li";
      const id = "ex_" + x.key;

      li.innerHTML = `
        <input id="${id}" type="checkbox" style="margin-top:2px;transform:scale(1.05)"/>
        <div>
          <b>${safeText(t(x.labelKey))}</b>
          <span class="muted">${extraMicrocopy(x, type)}</span>
        </div>
      `;
      list.appendChild(li);

      const cb = $(id);
      cb.checked = !!state.extras[x.key];
      cb.addEventListener("change", () => {
        state.extras[x.key] = cb.checked;
      });
    });
  }

  function extraMicrocopy(x, type){
    const isFlat = type==="flat";
    const isHouse = type==="house";
    let s = "";
    if(x.only==="flat") s = (state.lang==="en") ? "Usually relevant for apartment buildings." : (state.lang==="ca" ? "Normalment rellevant en edificis de pisos." : "Normalmente relevante en edificios de pisos.");
    else if(x.mostly==="house") s = isFlat ? (state.lang==="en" ? "Still possible, but less common in flats." : (state.lang==="ca" ? "Possible, per√≤ menys habitual en pisos." : "Posible, pero menos habitual en pisos.")) : (state.lang==="en" ? "Commonly impacts price for houses." : (state.lang==="ca" ? "Sovint impacta el preu en cases." : "Suele impactar el precio en casas."));
    else s = (state.lang==="en") ? "Can move comparable prices noticeably." : (state.lang==="ca" ? "Pot moure els preus comparables." : "Puede mover los precios comparables.");
    return s;
  }

  // ---------- Popups ----------
  function toast(msg, title){
    $("toastTitle").textContent = title || t("toastTitle");
    $("toastMsg").textContent = msg;
    $("toastWrap").style.display = "flex";
    $("toastOk").focus();
  }
  function closeToast(){
    $("toastWrap").style.display = "none";
  }

  $("toastClose").addEventListener("click", closeToast);
  $("toastOk").addEventListener("click", closeToast);
  $("toastWrap").addEventListener("click", (e) => {
    if(e.target === $("toastWrap")) closeToast();
  });
  window.addEventListener("keydown", (e) => {
    if(e.key === "Escape") closeToast();
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "enter") analyze();
  });

  // ---------- UI text apply ----------
  function applyLang(){
    $("appTitle").textContent = t("appTitle");
    $("appSubtitle").textContent = t("appSubtitle");
    $("langLbl").textContent = t("langLbl");
    $("formTitle").textContent = t("formTitle");
    $("formSub").textContent = t("formSub");
    $("scopeBadge").textContent = t("scopeBadge");
    $("munLbl").textContent = t("munLbl");
    $("munHint").textContent = t("munHint");
    $("munFoot").textContent = t("munFoot");
    $("typeLbl").textContent = t("typeLbl");
    $("typeHint").textContent = t("typeHint");
    $("typeFoot").textContent = t("typeFoot");
    $("roomsLbl").textContent = t("roomsLbl");
    $("bathsLbl").textContent = t("bathsLbl");
    $("m2Lbl").textContent = t("m2Lbl");
    $("m2Foot").textContent = t("m2Foot");
    $("budgetLbl").textContent = t("budgetLbl");
    $("budgetFoot").textContent = t("budgetFoot");
    $("incomeLbl").textContent = t("incomeLbl");
    $("savingsLbl").textContent = t("savingsLbl");
    $("termLbl").textContent = t("termLbl");
    $("rateLbl").textContent = t("rateLbl");
    $("extrasTitle").textContent = t("extrasTitle");
    $("extrasSub").textContent = t("extrasSub");
    $("formFooter").textContent = t("formFooter");
    $("outTitle").textContent = t("outTitle");
    $("outSub").textContent = t("outSub");

    $("kpi1k").textContent = t("kpi1k");
    $("kpi1d").textContent = t("kpi1d");
    $("kpi2k").textContent = t("kpi2k");
    $("kpi2d").textContent = t("kpi2d");
    $("kpi3k").textContent = t("kpi3k");
    $("kpi3d").textContent = t("kpi3d");

    $("chartHint").textContent = t("chartHint");
    $("humanTitle").textContent = t("humanTitle");
    $("humanText").innerHTML = t("humanIdle").replace("Analyze","<b>Analyze</b>");

    $("nextTitle").textContent = t("nextTitle");
    $("compareTitle").textContent = t("compareTitle");
    $("compareText").textContent = t("compareText");

    $("searchTitle").textContent = t("searchTitle");
    $("searchSub").textContent = t("searchSub");
    $("searchFoot").textContent = t("searchFoot");

    $("donNotice").textContent = t("donateNotice");
    $("donHint").textContent = t("donateHint");
    $("donLbl").textContent = t("donLbl");
    $("btnCopyBizum").textContent = t("btnCopy");
    $("btnDonate").textContent = t("btnDonate");
    $("donFoot").textContent = t("donFoot");

    $("legal").textContent = t("legal");

    $("btnVisit").textContent = t("visit");
    $("btnReset").textContent = t("reset");
    $("btnAnalyze").textContent = t("analyze");
    $("toastOk").textContent = t("ok");

    setStatus("idle");
    renderExtras();
    renderNextSteps();
    renderCompareBadges(null);
    updateSearchLinks();
    drawChart({buyMonthly:0,rentMonthly:0,capacity:0});
  }

  // ---------- Default zeros & example-disappear behavior ----------
  function resetAll(){
    $("municipi").value = "";
    $("tipus").value = "";
    $("rooms").value = "0";
    $("baths").value = "0";
    $("m2").value = "0";
    $("budget").value = "0";
    $("income").value = "0";
    $("savings").value = "0";
    $("term").value = "0";
    $("rate").value = "0";
    Object.keys(state.extras).forEach(k => state.extras[k] = false);
    renderExtras();

    setStatus("idle");
    $("kpi1v").textContent = "0 ‚Ç¨";
    $("kpi2v").textContent = "0 ‚Ç¨";
    $("kpi3v").textContent = "‚Äî";
    $("humanText").innerHTML = t("humanIdle").replace("Analyze","<b>Analyze</b>");
    renderNextSteps();
    renderCompareBadges(null);
    updateSearchLinks();
    drawChart({buyMonthly:0,rentMonthly:0,capacity:0});
  }

  // ‚ÄúExample disappears when typing‚Äù: for 0 fields we keep 0, but if user starts typing we clear the 0 once.
  function attachAutoClearZero(id){
    const el = $(id);
    let cleared = false;
    el.addEventListener("focus", () => {
      if(!cleared && String(el.value).trim()==="0"){
        el.select();
      }
    });
    el.addEventListener("input", () => {
      // if user types a non-empty non-zero, consider it "custom"
      if(String(el.value).trim() !== "") cleared = true;
      updateSearchLinks();
    });
    el.addEventListener("keydown", (e) => {
      if(!cleared && String(el.value).trim()==="0"){
        // first printable key clears
        if(e.key.length===1 && !e.ctrlKey && !e.metaKey && !e.altKey){
          el.value = "";
          cleared = true;
        }
      }
    });
    el.addEventListener("blur", () => {
      // if left empty, restore 0 for your ‚Äúall values start at 0‚Äù requirement
      if(String(el.value).trim()==="") el.value = "0";
    });
  }

  // ---------- Data model (simple but realistic-ish) ----------
  // These are heuristic ranges for Baix Pened√®s, not official. Good enough for a front-end guidance tool.
  const MARKET = {
    base_m2_buy: {
      Cunit: 2100, Calafell: 2400, "El Vendrell": 1900, default: 2100
    },
    base_m2_rent: {
      Cunit: 11.5, Calafell: 12.5, "El Vendrell": 10.5, default: 11.3
    }
  };

  function getBaseM2Buy(mun){
    return MARKET.base_m2_buy[mun] || MARKET.base_m2_buy.default;
  }
  function getBaseM2Rent(mun){
    return MARKET.base_m2_rent[mun] || MARKET.base_m2_rent.default;
  }

  function extrasMultiplier(mode, type){
    // mode: "buy" or "rent"
    let mult = 1;
    EXTRAS_DEF.forEach(x => {
      if(x.only && type && x.only !== type) return;
      if(state.extras[x.key]){
        mult += (mode==="buy" ? x.weightBuy : x.weightRent);
      }
    });
    // house vs flat subtle shift
    if(type==="house") mult += (mode==="buy" ? 0.03 : 0.01);
    if(type==="flat") mult += (mode==="buy" ? 0.00 : 0.00);
    return mult;
  }

  function estimateBuyPriceEUR({mun,type,m2,rooms,baths}){
    const base = getBaseM2Buy(mun) * (m2>0? m2 : 75); // fallback
    let adj = 1;

    // rooms/baths add signal when m2 unknown or to tweak quality
    if(m2<=0){
      adj += clamp(rooms,0,6) * 0.03;
      adj += clamp(baths,0,4) * 0.04;
    } else {
      // if rooms unusually high/low for m2, adjust slightly
      const ratio = rooms>0 ? (m2/rooms) : m2;
      if(rooms>0 && ratio < 18) adj += 0.03; // tight layout -> often more expensive per m2
      if(rooms>0 && ratio > 35) adj -= 0.02;
    }

    adj *= extrasMultiplier("buy", type);

    // keep reasonable band
    const price = clamp(base*adj, 35000, 950000);
    return Math.round(price);
  }

  function estimateRentMonthlyEUR({mun,type,m2,rooms,baths}){
    const base = getBaseM2Rent(mun) * (m2>0? m2 : 70);
    let adj = 1;
    if(m2<=0){
      adj += clamp(rooms,0,6) * 0.04;
      adj += clamp(baths,0,4) * 0.05;
    } else {
      const ratio = rooms>0 ? (m2/rooms) : m2;
      if(rooms>0 && ratio < 18) adj += 0.03;
      if(rooms>0 && ratio > 35) adj -= 0.02;
    }
    adj *= extrasMultiplier("rent", type);
    const rent = clamp(base*adj, 350, 3800);
    return Math.round(rent);
  }

  function mortgageMonthly(payment){
    return Math.round(payment);
  }

  function calcMortgageMonthly(principal, annualRatePct, years){
    const r = (annualRatePct/100)/12;
    const n = years*12;
    if(principal<=0 || years<=0) return 0;
    if(r<=0) return Math.round(principal/n);
    const m = principal * (r * Math.pow(1+r,n)) / (Math.pow(1+r,n)-1);
    return Math.round(m);
  }

  function monthlyCapacity(income){
    // simple conservative: 30% of net income
    return Math.round(Math.max(0, income*0.30));
  }

  // ---------- Comparator & decision logic ----------
  function decide({income, budget, savings, buyPrice, rentMonthly, term, rate, wantsBuySignal}){
    const cap = monthlyCapacity(income);

    // If wantsBuySignal: budget is total price target. Else budget is rent cap.
    const targetBuyPrice = wantsBuySignal ? budget : buyPrice;
    const targetRentCap = wantsBuySignal ? rentMonthly : budget;

    // buy scenario
    const taxesFees = targetBuyPrice * 0.11; // approx 10‚Äì12%
    const minCashNeeded = targetBuyPrice*0.20 + taxesFees; // conservative 20% + costs
    const principal = Math.max(0, targetBuyPrice*0.80); // assume 80% financed
    const mort = calcMortgageMonthly(principal, rate, term);
    const buyAllMonthly = mort + Math.round(targetBuyPrice*0.0012); // maintenance-ish ~0.12%/month

    // rent scenario
    const rentAllMonthly = targetRentCap;

    // scoring
    let scoreBuy = 0, scoreRent = 0, scoreWait = 0;

    // affordability
    if(buyAllMonthly <= cap) scoreBuy += 3;
    else if(buyAllMonthly <= cap*1.15) scoreBuy += 1;
    else scoreBuy -= 3;

    if(rentAllMonthly <= cap) scoreRent += 2;
    else if(rentAllMonthly <= cap*1.20) scoreRent += 1;
    else scoreRent -= 2;

    // savings
    if(savings >= minCashNeeded) scoreBuy += 3;
    else if(savings >= minCashNeeded*0.70) scoreBuy += 1;
    else scoreBuy -= 2;

    // safety margin
    const marginBuy = cap - buyAllMonthly;
    const marginRent = cap - rentAllMonthly;
    if(marginRent > marginBuy) scoreRent += 1;
    if(marginBuy > 0) scoreBuy += 1;

    // if both are bad -> wait
    if(buyAllMonthly > cap*1.15 && rentAllMonthly > cap*1.20) scoreWait += 4;
    if(savings < Math.min(minCashNeeded*0.60, 25000)) scoreWait += 2;

    // decision
    let decision = "wait";
    const best = Math.max(scoreBuy, scoreRent, scoreWait);
    if(best === scoreBuy) decision = "buy";
    else if(best === scoreRent) decision = "rent";
    else decision = "wait";

    // confidence
    const spread = best - Math.max(
      decision==="buy"? Math.max(scoreRent, scoreWait) :
      decision==="rent"? Math.max(scoreBuy, scoreWait) :
      Math.max(scoreBuy, scoreRent)
    );
    const conf = clamp(spread, 0, 5);

    return {
      cap,
      minCashNeeded: Math.round(minCashNeeded),
      buyAllMonthly,
      rentAllMonthly,
      decision,
      conf,
      taxesFees: Math.round(taxesFees),
      principal: Math.round(principal),
      mort
    };
  }

  function setStatus(kind){
    const dot = $("statusDot");
    const txt = $("statusTxt");
    if(kind==="ok"){
      dot.className = "dot good"; txt.textContent = t("statusOk");
    } else if(kind==="warn"){
      dot.className = "dot warn"; txt.textContent = t("statusWarn");
    } else if(kind==="bad"){
      dot.className = "dot bad"; txt.textContent = t("statusBad");
    } else {
      dot.className = "dot"; txt.textContent = t("statusIdle");
    }
  }

  // ---------- Search links (Baix Pened√®s always) ----------
  function updateSearchLinks(){
    const rooms = clamp(num($("rooms").value),0,10);
    const m2 = num($("m2").value);
    const type = $("tipus").value;
    const m2min = (m2>0 ? Math.max(10, Math.round(m2-20)) : "");
    const m2max = (m2>0 ? Math.round(m2+20) : "");
    const zone = "Baix Pened√®s";

    // Build a human search query. Portals differ; we use site search or generic query approach.
    const typeTxt = type==="house" ? (state.lang==="en" ? "house" : (state.lang==="ca" ? "casa" : "casa")) :
                    type==="flat" ? (state.lang==="en" ? "apartment" : (state.lang==="ca" ? "pis" : "piso")) : "";
    const roomsTxt = rooms>0 ? `${rooms} ${state.lang==="en" ? "bedroom" : (state.lang==="ca" ? "habitacions" : "habitaciones")}` : "";
    const m2Txt = (m2>0) ? `${m2min}-${m2max} m2` : "";

    const q = [zone, typeTxt, roomsTxt, m2Txt, "venta OR alquiler"].filter(Boolean).join(" ");

    // Use portal + query style links (more robust than trying to guess internal filter URLs).
    $("btnIdealista").href = "https://www.google.com/search?q=" + encodeURIComponent("site:idealista.com " + q);
    $("btnFotocasa").href  = "https://www.google.com/search?q=" + encodeURIComponent("site:fotocasa.es " + q);
    $("btnHabitaclia").href= "https://www.google.com/search?q=" + encodeURIComponent("site:habitaclia.com " + q);
  }

  // ---------- Next steps ----------
  function renderNextSteps(custom){
    const list = $("nextSteps");
    list.innerHTML = "";
    const arr = custom && custom.length ? custom : [t("ns1"),t("ns2"),t("ns3"),t("ns4"),t("ns5")];
    arr.forEach(s => {
      const li = document.createElement("li");
      li.className = "li";
      li.innerHTML = `<div class="dot good" style="margin-top:4px"></div><div><b>${safeText(s)}</b><span class="muted"></span></div>`;
      list.appendChild(li);
    });
  }

  function renderCompareBadges(data){
    const box = $("compareBadges");
    box.innerHTML = "";
    if(!data){
      box.innerHTML = `<span class="badge">${state.lang==="en"?"Waiting for analysis.":(state.lang==="ca"?"Esperant l‚Äôan√†lisi.":"Esperando el an√°lisis.")}</span>`;
      return;
    }
    const {rangeLow, rangeHigh, target, label} = data;
    const b1 = document.createElement("span");
    b1.className = "badge";
    b1.textContent = `${label}: ${fmtEUR(rangeLow)} ‚Äì ${fmtEUR(rangeHigh)}`;
    const b2 = document.createElement("span");
    b2.className = "badge";
    b2.textContent = `${state.lang==="en"?"Your target":"Tu objetivo"}: ${fmtEUR(target)}`;
    const b3 = document.createElement("span");
    b3.className = "badge";
    const ok = target>=rangeLow && target<=rangeHigh;
    b3.textContent = ok ? (state.lang==="en"?"Looks realistic":"Pinta realista") : (state.lang==="ca"?"Cal revisar":"Hay que revisar");
    box.appendChild(b1); box.appendChild(b2); box.appendChild(b3);
  }

  // ---------- Chart ----------
  function drawChart({buyMonthly, rentMonthly, capacity}){
    const c = $("chart");
    const rect = c.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    c.width = Math.max(360, Math.round(rect.width * dpr));
    c.height = Math.round(rect.height * dpr);
    const ctx = c.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);

    const w = rect.width, h = rect.height;
    ctx.clearRect(0,0,w,h);

    // subtle grid
    ctx.globalAlpha = 0.25;
    ctx.strokeStyle = "rgba(148,163,184,.35)";
    for(let i=1;i<=4;i++){
      const y = (h/5)*i;
      ctx.beginPath(); ctx.moveTo(12,y); ctx.lineTo(w-12,y); ctx.stroke();
    }
    ctx.globalAlpha = 1;

    const maxV = Math.max(1, capacity*1.15, buyMonthly*1.1, rentMonthly*1.1);
    const toY = (v)=> h-18 - (v/maxV)*(h-32);

    // bars: buy & rent
    const barW = 44;
    const xBuy = w*0.32, xRent = w*0.62;

    // capacity line
    ctx.lineWidth = 2;
    ctx.strokeStyle = "rgba(56,189,248,.85)";
    ctx.beginPath(); ctx.moveTo(12, toY(capacity)); ctx.lineTo(w-12, toY(capacity)); ctx.stroke();
    ctx.fillStyle = "rgba(229,231,235,.95)";
    ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
    ctx.fillText((state.lang==="en"?"Capacity":"Capacidad") + ": " + Math.round(capacity) + "‚Ç¨", 14, toY(capacity)-6);

    // buy bar
    ctx.fillStyle = "rgba(34,197,94,.75)";
    ctx.fillRect(xBuy-barW/2, toY(buyMonthly), barW, (h-18)-toY(buyMonthly));
    ctx.fillStyle = "rgba(229,231,235,.95)";
    ctx.fillText((state.lang==="en"?"Buy":"Compra") + " " + Math.round(buyMonthly) + "‚Ç¨", xBuy-barW/2, 14);

    // rent bar
    ctx.fillStyle = "rgba(245,158,11,.75)";
    ctx.fillRect(xRent-barW/2, toY(rentMonthly), barW, (h-18)-toY(rentMonthly));
    ctx.fillStyle = "rgba(229,231,235,.95)";
    ctx.fillText((state.lang==="en"?"Rent":"Alquiler") + " " + Math.round(rentMonthly) + "‚Ç¨", xRent-barW/2, 14);

    // safety zone
    ctx.globalAlpha = 0.12;
    ctx.fillStyle = "rgba(56,189,248,.85)";
    ctx.fillRect(0, toY(capacity), w, h - toY(capacity));
    ctx.globalAlpha = 1;
  }

  // ---------- Human explanation builder ----------
  function humanExplain(input, est, dec){
    const {mun,type,rooms,baths,m2,budget,income,savings,term,rate} = input;
    const wantsBuySignal = budget > 2000; // rough heuristic: above 2000 likely buy price, below likely rent cap
    const typeLabel = type==="house" ? (state.lang==="en"?"house":(state.lang==="ca"?"casa":"casa")) :
                     type==="flat" ? (state.lang==="en"?"flat":(state.lang==="ca"?"pis":"piso")) :
                     (state.lang==="en"?"property":(state.lang==="ca"?"habitatge":"vivienda"));

    const muni = mun || (state.lang==="en"?"(no town selected)":(state.lang==="ca"?"(sense municipi)":"(sin municipio)"));
    const m2txt = m2>0 ? `${m2} m¬≤` : (state.lang==="en"?"unknown size":"m¬≤ desconocidos");
    const rtxt = rooms>0 ? `${rooms}` : "0";
    const btxt = baths>0 ? `${baths}` : "0";

    const cap = dec.cap;
    const buyM = dec.buyAllMonthly;
    const rentM = dec.rentAllMonthly;

    const decision = dec.decision;
    const conf = dec.conf;

    const confWord = conf>=4 ? (state.lang==="en"?"high":"alta") : conf>=2 ? (state.lang==="en"?"medium":"media") : (state.lang==="en"?"low":"baja");

    let intro;
    if(state.lang==="en"){
      intro = `Based on your inputs for a ${typeLabel} in ${muni} (${rtxt} bed / ${btxt} bath, ${m2txt}), here‚Äôs the honest version.`;
    } else if(state.lang==="ca"){
      intro = `Amb les teves dades per a un/a ${typeLabel} a ${muni} (${rtxt} hab / ${btxt} bany, ${m2txt}), aqu√≠ tens la versi√≥ honesta.`;
    } else {
      intro = `Con tus datos para un/a ${typeLabel} en ${muni} (${rtxt} hab / ${btxt} ba√±os, ${m2txt}), aqu√≠ va la versi√≥n honesta.`;
    }

    // logic statements
    const lines = [];
    lines.push(intro);

    // capacity line
    if(state.lang==="en"){
      lines.push(`Your safe monthly capacity is about ${fmtEUR(cap)} (‚âà30% of your net income). That‚Äôs the line where you still get to live like a human.`);
    } else if(state.lang==="ca"){
      lines.push(`La teva capacitat mensual ‚Äúsegura‚Äù √©s d‚Äôuns ${fmtEUR(cap)} (‚âà30% del teu net). √âs la l√≠nia on encara vius com una persona.`);
    } else {
      lines.push(`Tu capacidad mensual ‚Äúsegura‚Äù es de unos ${fmtEUR(cap)} (‚âà30% de tu neto). Es la l√≠nea donde todav√≠a vives como una persona.`);
    }

    // rent line
    if(state.lang==="en"){
      lines.push(`A realistic rent for this profile is around ${fmtEUR(rentM)}/month. ${rentM<=cap ? "It fits your capacity." : "It squeezes you."}`);
    } else if(state.lang==="ca"){
      lines.push(`Un lloguer realista per aquest perfil √©s d‚Äôuns ${fmtEUR(rentM)}/mes. ${rentM<=cap ? "Entra dins la teva capacitat." : "Et pressiona."}`);
    } else {
      lines.push(`Un alquiler realista para este perfil ronda ${fmtEUR(rentM)}/mes. ${rentM<=cap ? "Encaja con tu capacidad." : "Te aprieta."}`);
    }

    // buy line
    if(term>0 && rate>0){
      if(state.lang==="en"){
        lines.push(`A mortgage-style buy (term ${term}y, rate ${fmtPct(rate)}) would land around ${fmtEUR(buyM)}/month including a basic maintenance buffer. ${buyM<=cap ? "Affordable on paper." : "Too tight on paper."}`);
      } else if(state.lang==="ca"){
        lines.push(`Una compra amb hipoteca (termini ${term}a, inter√®s ${fmtPct(rate)}) quedaria a uns ${fmtEUR(buyM)}/mes incloent un marge de manteniment. ${buyM<=cap ? "Assumible sobre el paper." : "Massa just sobre el paper."}`);
      } else {
        lines.push(`Una compra con hipoteca (plazo ${term}a, inter√©s ${fmtPct(rate)}) quedar√≠a en unos ${fmtEUR(buyM)}/mes incluyendo un margen b√°sico de mantenimiento. ${buyM<=cap ? "Asumible sobre el papel." : "Demasiado justo sobre el papel."}`);
      }
    } else {
      if(state.lang==="en"){
        lines.push(`Buy analysis is less precise because term/rate are missing. If you add them, the recommendation gets sharper.`);
      } else if(state.lang==="ca"){
        lines.push(`L‚Äôan√†lisi de compra √©s menys prec√≠s perqu√® falta termini/inter√®s. Si els afegeixes, la recomanaci√≥ millora molt.`);
      } else {
        lines.push(`El an√°lisis de compra es menos preciso porque faltan plazo/inter√©s. Si los a√±ades, la recomendaci√≥n se afina mucho.`);
      }
    }

    // cash needed
    if(state.lang==="en"){
      lines.push(`Cash reality: to buy safely you often need roughly ${fmtEUR(dec.minCashNeeded)} (down payment + taxes/fees). You have ${fmtEUR(savings)}.`);
    } else if(state.lang==="ca"){
      lines.push(`Realitat de caixa: per comprar amb seguretat sovint calen uns ${fmtEUR(dec.minCashNeeded)} (entrada + impostos/despeses). Tu tens ${fmtEUR(savings)}.`);
    } else {
      lines.push(`Realidad de caja: para comprar con seguridad suele hacer falta aprox. ${fmtEUR(dec.minCashNeeded)} (entrada + impuestos/gastos). T√∫ tienes ${fmtEUR(savings)}.`);
    }

    // final decision with tone
    let fin;
    if(decision==="buy"){
      if(state.lang==="en"){
        fin = `Recommendation: BUY (confidence: ${confWord}). Not because buying is ‚Äúbetter‚Äù, but because your numbers can carry it without turning life into a monthly panic attack.`;
      } else if(state.lang==="ca"){
        fin = `Recomanaci√≥: COMPRAR (confian√ßa: ${confWord}). No perqu√® comprar sigui ‚Äúmillor‚Äù, sin√≥ perqu√® els teus n√∫meros ho poden sostenir sense convertir cada mes en p√†nic.`;
      } else {
        fin = `Recomendaci√≥n: COMPRAR (confianza: ${confWord}). No porque comprar sea ‚Äúmejor‚Äù, sino porque tus n√∫meros lo aguantan sin convertir cada mes en p√°nico.`;
      }
    } else if(decision==="rent"){
      if(state.lang==="en"){
        fin = `Recommendation: RENT (confidence: ${confWord}). It protects your cash and keeps flexibility while you build a stronger buying position.`;
      } else if(state.lang==="ca"){
        fin = `Recomanaci√≥: LLOGAR (confian√ßa: ${confWord}). Protegeix estalvis i et dona flexibilitat mentre millores posici√≥ de compra.`;
      } else {
        fin = `Recomendaci√≥n: ALQUILAR (confianza: ${confWord}). Protege ahorros y te da flexibilidad mientras construyes una mejor posici√≥n para comprar.`;
      }
    } else {
      if(state.lang==="en"){
        fin = `Recommendation: WAIT WITH A PLAN (confidence: ${confWord}). Right now the numbers look tight. Waiting isn‚Äôt ‚Äúdoing nothing‚Äù: it‚Äôs saving, improving income, and watching the right listings.`;
      } else if(state.lang==="ca"){
        fin = `Recomanaci√≥: ESPERAR AMB PLA (confian√ßa: ${confWord}). Ara mateix els n√∫meros van justos. Esperar no √©s ‚Äúno fer res‚Äù: √©s estalviar, millorar ingressos i vigilar anuncis bons.`;
      } else {
        fin = `Recomendaci√≥n: ESPERAR CON PLAN (confianza: ${confWord}). Ahora mismo los n√∫meros van justos. Esperar no es ‚Äúno hacer nada‚Äù: es ahorrar, mejorar ingresos y vigilar anuncios correctos.`;
      }
    }
    lines.push(fin);

    return lines.join(" ");
  }

  // ---------- Analyze ----------
  function analyze(){
    const mun = $("municipi").value;
    const type = $("tipus").value;
    const rooms = clamp(num($("rooms").value), 0, 12);
    const baths = clamp(num($("baths").value), 0, 8);
    const m2 = num($("m2").value);
    const budget = num($("budget").value);
    const income = num($("income").value);
    const savings = num($("savings").value);
    const term = clamp(num($("term").value), 0, 40);
    const rate = clamp(num($("rate").value), 0, 12);

    if(m2 < 0){
      setStatus("bad");
      toast(t("v_m2TooLow"));
      return;
    }

    // validation logic: keep it helpful, not annoying.
    const allZeros = !mun && !type && rooms===0 && baths===0 && m2===0 && budget===0 && income===0 && savings===0 && term===0 && rate===0;
    if(allZeros){
      setStatus("warn");
      toast(t("v_needSomething"));
      // continue anyway (user asked)
    } else {
      if(income<=0 || budget<=0){
        setStatus("bad");
        toast(t("v_budgetIncome"));
        return;
      }
    }

    // Determine intent: if budget looks like a rent cap or a buy price
    // Heuristic: if budget <= 3500 assume rent cap, else buy target price.
    const wantsBuySignal = budget > 3500;

    // If buy path but missing term/rate, ask (but not block if they clearly want rent).
    if(wantsBuySignal && (term<=0 || rate<=0)){
      setStatus("warn");
      toast(t("v_buyNeedsTermRate"));
      return;
    }

    const input = {mun,type,rooms,baths,m2,budget,income,savings,term,rate};
    const buyPriceEst = estimateBuyPriceEUR(input);
    const rentEst = estimateRentMonthlyEUR(input);

    // if renting intent, treat budget as rent cap; for buy intent treat as buy target
    const targetBuy = wantsBuySignal ? budget : buyPriceEst;
    const dec = decide({
      income, budget, savings,
      buyPrice: targetBuy,
      rentMonthly: wantsBuySignal ? rentEst : budget,
      term, rate,
      wantsBuySignal
    });

    // KPI updates
    $("kpi1v").textContent = fmtEUR(dec.cap).replace("‚Ç¨", " ‚Ç¨");
    $("kpi2v").textContent = fmtEUR(wantsBuySignal ? targetBuy : rentEst) + (wantsBuySignal ? "" : "");
    $("kpi3v").textContent =
      dec.decision==="buy" ? (state.lang==="en"?"BUY":(state.lang==="ca"?"COMPRAR":"COMPRAR")) :
      dec.decision==="rent"? (state.lang==="en"?"RENT":(state.lang==="ca"?"LLOGAR":"ALQUILAR")) :
                             (state.lang==="en"?"WAIT":(state.lang==="ca"?"ESPERAR":"ESPERAR"));

    // status
    setStatus(dec.decision==="wait" ? "warn" : "ok");

    // Human explanation
    $("humanText").textContent = humanExplain(input, {buyPriceEst,rentEst}, dec);

    // Next steps tuned
    const steps = [];
    if(dec.decision==="buy"){
      steps.push(state.lang==="en"?"Get a pre-approval simulation from your bank (or two).":"Pide simulaci√≥n/preaprobaci√≥n al banco (o a dos).");
      steps.push(state.lang==="en"?"Keep a buffer: emergencies + maintenance is not optional.":"Mant√©n colch√≥n: emergencias + mantenimiento no es opcional.");
      steps.push(state.lang==="en"?"Negotiate with data: comps, condition, and time on market.":"Negocia con datos: comparables, estado y tiempo publicado.");
      steps.push(t("ns3"));
      steps.push(t("ns5"));
    } else if(dec.decision==="rent"){
      steps.push(state.lang==="en"?"Use renting to build a stronger down payment plan.":"Usa el alquiler para construir un plan de entrada m√°s fuerte.");
      steps.push(state.lang==="en"?"Avoid stretching rent above your safe capacity.":"Evita estirar el alquiler por encima de tu capacidad segura.");
      steps.push(t("ns3"));
      steps.push(t("ns4"));
      steps.push(t("ns5"));
    } else {
      steps.push(state.lang==="en"?"Set a monthly saving target (automatic transfer).":"Fija un objetivo mensual de ahorro (transferencia autom√°tica).");
      steps.push(state.lang==="en"?"Improve income or reduce target expectations: pick one.":"Mejora ingresos o baja expectativas: elige una.");
      steps.push(t("ns3"));
      steps.push(t("ns4"));
      steps.push(t("ns5"));
    }
    renderNextSteps(steps);

    // Comparator badges:
    // if buy intent, compare target buy price to estimated band; else compare rent cap to estimated rent band
    if(wantsBuySignal){
      const bandLow = Math.round(buyPriceEst*0.85);
      const bandHigh= Math.round(buyPriceEst*1.18);
      renderCompareBadges({rangeLow:bandLow, rangeHigh:bandHigh, target:targetBuy, label: state.lang==="en"?"Buy price range":"Rango compra"});
    } else {
      const bandLow = Math.round(rentEst*0.88);
      const bandHigh= Math.round(rentEst*1.20);
      renderCompareBadges({rangeLow:bandLow, rangeHigh:bandHigh, target:budget, label: state.lang==="en"?"Rent range":"Rango alquiler"});
    }

    // Chart data:
    const buyMonthly = wantsBuySignal ? dec.buyAllMonthly : calcMortgageMonthly(Math.round(buyPriceEst*0.80), Math.max(rate,3.5), Math.max(term,25)) + Math.round(buyPriceEst*0.0012);
    const rentMonthly = wantsBuySignal ? rentEst : budget;
    drawChart({buyMonthly, rentMonthly, capacity: dec.cap});

    // Search links update
    updateSearchLinks();

    state.lastAnalyzeAt = now();
  }

  // ---------- Donate ----------
  $("btnCopyBizum").addEventListener("click", () => {
    const txt = "Bizum/PayPal/Stripe: (replace this with your real details)\nProject: Assessoria d‚ÄôHabitatge\nNote: voluntary support";
    navigator.clipboard?.writeText(txt).then(() => toast(t("copied"))).catch(() => toast(txt));
  });

  $("btnDonate").addEventListener("click", () => {
    toast(t("donated"));
  });

  // ---------- Buttons ----------
  $("btnAnalyze").addEventListener("click", analyze);
  $("btnReset").addEventListener("click", resetAll);
  $("btnVisit").addEventListener("click", () => {
    // if you later use custom domain, update here
    window.open(window.location.href, "_blank", "noopener,noreferrer");
  });

  // ---------- Language selector ----------
  $("lang").addEventListener("change", () => {
    state.lang = $("lang").value;
    document.documentElement.lang = state.lang;
    applyLang();
  });

  // ---------- Type change affects extras display ----------
  $("tipus").addEventListener("change", () => {
    renderExtras();
    updateSearchLinks();
  });

  // ---------- attach auto-clear for inputs ----------
  ["rooms","baths","m2","budget","income","savings","term","rate"].forEach(attachAutoClearZero);

  // init
  state.lang = $("lang").value || "es";
  document.documentElement.lang = state.lang;
  applyLang();
  resetAll();
})();
</script>
</body>
</html>
