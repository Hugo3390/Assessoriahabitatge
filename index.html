<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Assessoria d'Habitatge - AI Advisor v2</title>
<style>
:root{
  --bg:#020617;--card:rgba(15,23,42,.70);--card2:rgba(11,18,32,.88);
  --bd:rgba(148,163,184,.22);--bd2:rgba(148,163,184,.30);
  --t:#e5e7eb;--m:#94a3b8;--mut:#cbd5e1;--pill:#38bdf8;
  --p:#06b6d4;--ph:#0891b2;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;
  --g1:#3b4a60;--g2:#0b1220;
  --shadow-lg:0 10px 40px rgba(0,0,0,.35);--shadow-xl:0 20px 60px rgba(0,0,0,.48);
  --gradient-3:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
  --gradient-4:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);
}
html,body{height:100%}
body{margin:0;background:var(--bg);position:relative;overflow-x:hidden;}
body::before{content:"";position:fixed;inset:0;background:radial-gradient(1400px 700px at 20% -10%,rgba(56,189,248,.18),transparent 60%),radial-gradient(1000px 600px at 85% 0%,rgba(34,197,94,.14),transparent 60%),radial-gradient(900px 520px at 60% 110%,rgba(168,85,247,.12),transparent 62%),linear-gradient(180deg,#0f172a 0%,#020617 55%,#000 100%);z-index:-1;pointer-events:none;animation:pulse 18s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:.80}50%{opacity:1}}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{opacity:0;transform:translateX(-18px)}to{opacity:1;transform:translateX(0)}}
@keyframes glow{0%,100%{box-shadow:0 0 18px rgba(56,189,248,.22)}50%{box-shadow:0 0 30px rgba(56,189,248,.42)}}
@keyframes typing{from{opacity:.4}to{opacity:1}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
#hx{color:var(--t);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;-webkit-font-smoothing:antialiased;}
#hx *{box-sizing:border-box}
.w{max-width:1200px;margin:22px auto 18px;padding:0 16px}
.c{background:rgba(15,23,42,.86);border:1px solid var(--bd);border-radius:20px;padding:22px;margin:16px 0;backdrop-filter:blur(14px);box-shadow:var(--shadow-lg);animation:fadeIn .5s ease-out;transition:all .25s ease;position:relative;overflow:hidden;}
.c::before{content:"";position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(56,189,248,.6),transparent);opacity:.55}
.c:hover{border-color:rgba(56,189,248,.42);box-shadow:var(--shadow-xl)}
.r{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.hrow{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.n{opacity:.95;font-size:.95rem;color:#cbd5e1;line-height:1.6}
.small{font-size:.88rem;color:#b6c2d3;line-height:1.5}
.pill{background:var(--gradient-3);color:#001018;border-radius:999px;padding:10px 16px;font-weight:950;letter-spacing:.6px;text-transform:uppercase;font-size:.88rem;box-shadow:0 4px 16px rgba(56,189,248,.32);animation:glow 6s ease-in-out infinite;white-space:nowrap;}
.lang{display:flex;gap:10px;align-items:center}
.langbtn{border:1px solid rgba(148,163,184,.28);background:rgba(11,18,32,.85);color:#cbd5e1;border-radius:999px;padding:8px 14px;font-weight:900;cursor:pointer;transition:all .18s ease;font-size:.84rem;letter-spacing:.5px;}
.langbtn:hover{border-color:rgba(56,189,248,.55);transform:translateY(-1px)}
.langbtn.a{background:var(--gradient-3);color:#001018;border-color:#38bdf8;box-shadow:0 4px 14px rgba(56,189,248,.28)}
.tabs{display:flex;gap:10px;margin:16px 0;flex-wrap:wrap;animation:slideIn .6s ease-out}
.tab{border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.80);color:#cbd5e1;border-radius:999px;padding:10px 18px;cursor:pointer;font-weight:900;transition:all .18s ease;user-select:none;position:relative;overflow:hidden;font-size:.90rem;letter-spacing:.35px;}
.tab:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(56,189,248,.28)}
.tab.a{background:var(--gradient-3);color:#001018;border-color:#38bdf8;box-shadow:0 4px 14px rgba(56,189,248,.36)}
.tab.dis{opacity:.40;cursor:not-allowed;filter:grayscale(.35)}
.tab.dis:hover{transform:none;box-shadow:none}
.b{background:var(--gradient-3);color:#001018;border:0;border-radius:14px;padding:12px 20px;cursor:pointer;font-weight:950;transition:all .18s ease;box-shadow:0 4px 15px rgba(56,189,248,.28);font-size:.95rem;letter-spacing:.3px;position:relative;overflow:hidden}
.b:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(56,189,248,.42)}
.b.ok{background:var(--gradient-4);box-shadow:0 4px 15px rgba(67,233,123,.22)}
.b.ok:hover{box-shadow:0 6px 20px rgba(67,233,123,.42)}
.b.dis{opacity:.45;cursor:not-allowed;filter:grayscale(.25);transform:none;pointer-events:none}
.g{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
@media(max-width:900px){.g{grid-template-columns:1fr}}
#hx input[type=text],#hx input[type=number],#hx select,#hx textarea{width:100%;padding:12px 14px;border:1px solid rgba(148,163,184,.30);border-radius:12px;background:rgba(2,6,23,.86);color:var(--t);outline:none;transition:all .18s ease;font-size:.95rem;font-family:inherit;}
#hx textarea{min-height:100px;resize:vertical;}
#hx input[type=text]:focus,#hx input[type=number]:focus,#hx select:focus,#hx textarea:focus{border-color:#38bdf8;box-shadow:0 0 0 4px rgba(56,189,248,.14);background:rgba(2,6,23,.96)}
#hx input[type=checkbox]{accent-color:#38bdf8;width:18px;height:18px;cursor:pointer}
#hx label{color:#cbd5e1;font-weight:750;margin-bottom:6px;display:block;font-size:.9rem;letter-spacing:.25px}
.gu{margin-top:12px;padding:14px 16px;background:rgba(56,189,248,.08);border:1px solid rgba(56,189,248,.25);border-radius:14px;color:#dbeafe;display:flex;gap:12px;align-items:flex-start;border-left:4px solid #38bdf8}
.gu .a{font-weight:950;line-height:1.2;margin-top:1px;font-size:1.15rem}
.tst{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:rgba(2,6,23,.94);border:1px solid rgba(148,163,184,.35);color:var(--t);padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none;transition:.2s;z-index:99999}
.tst.s{opacity:1}
.sig{max-width:1100px;margin:10px auto 18px;padding:10px 12px;color:#a5b4fc;background:rgba(10,16,28,.65);border:1px solid rgba(148,163,184,.25);border-radius:12px;display:flex;gap:12px;align-items:center;justify-content:space-between;font-size:.95rem}
.sig .br{font-weight:950;color:#e2e8f0}
.sig a{color:#93c5fd;text-decoration:none}
.sig a:hover{text-decoration:underline}
.cardx{margin-top:16px;background:linear-gradient(135deg,rgba(15,23,42,.86),rgba(11,18,32,.92));border:1px solid rgba(148,163,184,.25);border-radius:16px;padding:20px;box-shadow:0 4px 22px rgba(0,0,0,.22)}
.cardx .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;padding-bottom:16px;border-bottom:1px solid rgba(148,163,184,.14)}
.cardx .title{font-weight:1000;color:#f1f5f9;font-size:1.15rem}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{border:1px solid rgba(148,163,184,.30);background:rgba(11,18,32,.82);color:#cbd5e1;border-radius:999px;padding:8px 14px;font-weight:850;font-size:.85rem;transition:.15s;text-shadow:0 1px 8px rgba(0,0,0,.25);}
.chip:hover{transform:translateY(-1px)}
.chip.good{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.12);color:#86efac}
.chip.bad{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.12);color:#fca5a5}
.chip.warn{border-color:rgba(245,158,11,.45);background:rgba(245,158,11,.12);color:#fde68a}
.chip.neu{border-color:rgba(148,163,184,.35);color:#e2e8f0}
.body{margin-top:16px;color:#cbd5e1;line-height:1.65;font-size:.95rem}
.body b{color:#f8fafc;font-weight:800}
.grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:16px}
@media(max-width:980px){.grid3{grid-template-columns:1fr}}
.mini{background:linear-gradient(135deg,rgba(14,165,233,.10),rgba(6,182,212,.06));border:1px solid rgba(148,163,184,.25);border-radius:14px;padding:14px;transition:.15s}
.mini:hover{border-color:rgba(56,189,248,.40);transform:translateY(-1px)}
.mini .h{color:#94a3b8;font-size:.82rem;font-weight:800;text-transform:uppercase;letter-spacing:.5px}
.mini .v{font-weight:1000;color:#f8fafc;margin-top:6px;font-size:1.15rem;text-shadow:0 2px 12px rgba(0,0,0,.35);}
.note{margin-top:16px;color:#cbd5e1;white-space:pre-wrap;background:rgba(2,6,23,.62);padding:16px;border-radius:12px;border:1px solid rgba(148,163,184,.20);line-height:1.7;font-size:.92rem}
.k{background:linear-gradient(145deg,rgba(14,165,233,.10),rgba(6,182,212,.06));border:1px solid rgba(56,189,248,.30);border-radius:18px;padding:18px 14px;text-align:left;position:relative;overflow:hidden;box-shadow:0 4px 18px rgba(0,0,0,.25);min-height:86px;}
.k::before{content:"";position:absolute;inset:-40%;background:radial-gradient(circle,rgba(56,189,248,.10),transparent 70%);pointer-events:none;transition:transform .6s ease;}
.k:hover::before{transform:scale(1.12)}
.k span{color:#a6b3c6;font-size:.78rem;font-weight:900;text-transform:uppercase;letter-spacing:.9px;display:block}
.k b{font-size:30px;display:block;color:#f1f5f9;margin-top:10px;font-weight:1000;text-shadow:0 2px 14px rgba(0,0,0,.45);line-height:1.05;}
.k .sub{margin-top:8px;font-size:.82rem;color:#9fb0c6;line-height:1.25;}
@media(max-width:520px){.k b{font-size:26px}}
.pbar-wrap{margin-top:8px;background:rgba(255,255,255,.07);border-radius:999px;height:8px;overflow:hidden}
.pbar{height:8px;border-radius:999px;transition:width .9s cubic-bezier(.4,0,.2,1)}
.pbar.good{background:linear-gradient(90deg,#22c55e,#4ade80)}
.pbar.warn{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.pbar.bad{background:linear-gradient(90deg,#ef4444,#f87171)}
.tip{position:relative;display:inline-flex;align-items:center;gap:4px;width:100%}
.tip-icon{width:16px;height:16px;border-radius:50%;background:rgba(148,163,184,.22);color:#b6c2d3;font-size:10px;font-weight:950;cursor:help;display:inline-flex;align-items:center;justify-content:center;border:1px solid rgba(148,163,184,.30);flex-shrink:0;user-select:none}
.tip-box{position:absolute;top:calc(100% + 6px);right:0;left:auto;transform:none;background:#0f172a;border:1px solid rgba(56,189,248,.35);border-radius:10px;padding:10px 14px;color:#cbd5e1;font-size:.82rem;line-height:1.5;width:240px;z-index:9999;box-shadow:0 10px 26px rgba(0,0,0,.55);pointer-events:none;opacity:0;transition:opacity .14s;}
.tip:hover .tip-box,.tip:focus-within .tip-box{opacity:1}
.steps{display:flex;align-items:center;margin-bottom:16px;animation:fadeIn .45s ease-out}
.step{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1;position:relative}
.step-dot{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:1000;font-size:.85rem;transition:all .25s ease;border:2px solid rgba(148,163,184,.22);background:rgba(11,18,32,.82);color:#94a3b8;z-index:1}
.step.done .step-dot{background:var(--gradient-4);color:#001018;border-color:#22c55e;box-shadow:0 0 12px rgba(34,197,94,.35)}
.step.active .step-dot{background:var(--gradient-3);color:#001018;border-color:#38bdf8;box-shadow:0 0 12px rgba(56,189,248,.42)}
.step-label{font-size:.72rem;color:#475569;font-weight:850;text-align:center;white-space:nowrap}
.step.done .step-label,.step.active .step-label{color:#94a3b8}
.step-line{position:absolute;top:15px;left:calc(50% + 17px);width:calc(100% - 34px);height:2px;background:rgba(148,163,184,.14);transition:background .3s;z-index:0}
.step.done .step-line{background:rgba(34,197,94,.28)}
.share-bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;padding-top:12px;border-top:1px solid rgba(148,163,184,.12)}
.share-btn{border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.82);color:#cbd5e1;border-radius:10px;padding:8px 14px;cursor:pointer;font-weight:850;font-size:.82rem;transition:all .18s ease;display:flex;align-items:center;gap:6px}
.share-btn:hover{transform:translateY(-2px)}
.share-btn.wa{border-color:rgba(37,211,102,.40);color:#4ade80}
.share-btn.wa:hover{background:rgba(37,211,102,.10)}
.share-btn.cl{border-color:rgba(56,189,248,.40);color:#7dd3fc}
.share-btn.cl:hover{background:rgba(56,189,248,.10)}
#hx input.field-ok{border-color:rgba(34,197,94,.50)!important}
#hx input.field-err{border-color:rgba(239,68,68,.52)!important;box-shadow:0 0 0 3px rgba(239,68,68,.10)!important}
.field-hint{font-size:.78rem;margin-top:4px;min-height:16px;transition:all .2s}
.field-hint.ok{color:#4ade80}
.field-hint.err{color:#f87171}
.range-bar{display:flex;gap:6px;align-items:center;margin-top:6px;flex-wrap:wrap}
.range-tag{font-size:.75rem;border-radius:8px;padding:2px 7px;font-weight:850}
.range-tag.lo{background:rgba(34,197,94,.12);color:#86efac;border:1px solid rgba(34,197,94,.25)}
.range-tag.hi{background:rgba(239,68,68,.12);color:#fca5a5;border:1px solid rgba(239,68,68,.25)}
.countdown{margin-top:10px;padding:12px 14px;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);border-radius:12px;border-left:4px solid #f59e0b;color:#fde68a;font-size:.88rem;line-height:1.6}
#zoneWrap{margin-top:12px}
#zmap,#cmap{height:460px;border-radius:12px;border:1px solid rgba(148,163,184,.22);overflow:hidden;max-width:100%;position:relative}
/* ‚îÄ‚îÄ MAPA: etiquetas permanentes ‚îÄ‚îÄ */
.muni-label{background:transparent!important;border:0!important;box-shadow:none!important;pointer-events:none;}
.muni-label span{font-size:10px;font-weight:900;color:#e2e8f0;text-shadow:0 1px 3px rgba(0,0,0,.9),0 0 8px rgba(0,0,0,.7);white-space:nowrap;letter-spacing:.3px;pointer-events:none;}
.muni-tooltip{background:#0f172a!important;border:1px solid rgba(56,189,248,.5)!important;border-radius:8px!important;color:#e2e8f0!important;font-size:13px!important;font-weight:800!important;padding:5px 10px!important;box-shadow:0 4px 14px rgba(0,0,0,.5)!important;}
.muni-tooltip::before{display:none!important}
.leaflet-container{font-family:system-ui,sans-serif}
.pchips{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.pchip{border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.75);color:#cbd5e1;border-radius:999px;padding:6px 10px;font-weight:1000;font-size:.85rem;cursor:pointer}
.pchip.on{border-color:#38bdf8;color:#dbeafe}
.pchip.off{opacity:.75}
.legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;padding:10px 12px;background:rgba(2,6,23,.45);border:1px solid rgba(148,163,184,.18);border-radius:12px;color:#bcd0ea;font-size:.86rem;}
.legdot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:middle}
.leg1{background:#38bdf8}.leg2{background:#22c55e}
.chartCard{background:linear-gradient(135deg,rgba(2,6,23,.35),rgba(15,23,42,.35));border:1px solid rgba(148,163,184,.18);border-radius:14px;padding:14px;}
.canvasWrap{border:1px solid rgba(148,163,184,.16);border-radius:12px;overflow:hidden;background:rgba(2,6,23,.45);}
canvas{display:block;width:100%;height:240px}
@media(max-width:700px){canvas{height:220px}}
/* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
.chat-container{display:flex;flex-direction:column;height:600px;background:linear-gradient(135deg,rgba(15,23,42,.86),rgba(11,18,32,.92));border:1px solid rgba(148,163,184,.25);border-radius:16px;overflow:hidden;}
.chat-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px;}
.chat-message{display:flex;gap:12px;animation:fadeIn .3s ease-out;}
.chat-message.user{flex-direction:row-reverse;}
.chat-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:14px;flex-shrink:0;}
.chat-avatar.ai{background:var(--gradient-3);color:#001018;}
.chat-avatar.user{background:var(--gradient-4);color:#001018;}
.chat-bubble{max-width:75%;padding:12px 16px;border-radius:16px;line-height:1.6;font-size:.92rem;}
.chat-message.user .chat-bubble{background:rgba(56,189,248,.15);border:1px solid rgba(56,189,248,.25);color:#e5e7eb;}
.chat-message.ai .chat-bubble{background:rgba(148,163,184,.08);border:1px solid rgba(148,163,184,.18);color:#cbd5e1;}
.chat-bubble.thinking{font-style:italic;opacity:.7;animation:typing 1s ease-in-out infinite;}
.chat-input-wrap{padding:16px;background:rgba(2,6,23,.8);border-top:1px solid rgba(148,163,184,.18);display:flex;gap:10px;}
.chat-input{flex:1;padding:12px 14px;border:1px solid rgba(148,163,184,.30);border-radius:12px;background:rgba(2,6,23,.86);color:var(--t);outline:none;transition:all .18s ease;font-size:.95rem;font-family:inherit;resize:none;min-height:44px;max-height:120px;}
.chat-input:focus{border-color:#38bdf8;box-shadow:0 0 0 4px rgba(56,189,248,.14);}
.chat-send-btn{padding:12px 20px;background:var(--gradient-3);color:#001018;border:0;border-radius:12px;cursor:pointer;font-weight:900;transition:all .18s ease;box-shadow:0 4px 15px rgba(56,189,248,.28);white-space:nowrap;}
.chat-send-btn:hover{transform:translateY(-2px);}
.chat-send-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.suggestion-chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
.suggestion-chip{padding:6px 12px;background:rgba(56,189,248,.1);border:1px solid rgba(56,189,248,.25);border-radius:999px;color:#7dd3fc;font-size:.82rem;cursor:pointer;transition:all .18s ease;}
.suggestion-chip:hover{background:rgba(56,189,248,.18);transform:translateY(-1px);}
.ai-toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
.ai-tool-btn{padding:7px 12px;border-radius:999px;border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.75);color:#cbd5e1;font-size:.82rem;font-weight:900;cursor:pointer;transition:all .18s ease;}
.ai-tool-btn:hover{border-color:rgba(56,189,248,.55);transform:translateY(-1px);}
.ai-context{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
.ai-context-chip{padding:6px 10px;border-radius:999px;background:rgba(56,189,248,.10);border:1px solid rgba(56,189,248,.28);color:#dbeafe;font-size:.80rem;font-weight:850;}
.ai-context-chip.warn{background:rgba(245,158,11,.10);border-color:rgba(245,158,11,.35);color:#fde68a;}
/* ‚îÄ‚îÄ AI status badge ‚îÄ‚îÄ */
.ai-badge{display:inline-flex;align-items:center;gap:6px;font-size:.78rem;font-weight:900;padding:4px 10px;border-radius:999px;border:1px solid rgba(56,189,248,.35);background:rgba(56,189,248,.08);color:#7dd3fc;}
.ai-badge .dot{width:7px;height:7px;border-radius:50%;background:#22c55e;animation:pulse 2s infinite;}
.ai-badge.api{border-color:rgba(34,197,94,.40);background:rgba(34,197,94,.08);color:#86efac;}
.ai-badge.local{border-color:rgba(245,158,11,.40);background:rgba(245,158,11,.08);color:#fde68a;}
.ai-badge.error{border-color:rgba(239,68,68,.40);background:rgba(239,68,68,.08);color:#fca5a5;}
.ai-badge .dot.local{background:#f59e0b;}
.ai-badge .dot.error{background:#ef4444;}
/* ‚îÄ‚îÄ spinner para AI loading ‚îÄ‚îÄ */
.chat-bubble .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(148,163,184,.3);border-top-color:#38bdf8;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:6px;}
::selection{background:rgba(56,189,248,.25)}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
</head>
<body>
<div class="w" id="hx">

  <div class="c hrow">
    <div class="pill" data-i="hdrTitle">Assessoria d'Habitatge ¬∑ Baix Pened√®s</div>
    <div class="r" style="justify-content:flex-end;flex:1">
      <div class="n" data-i="hdrHint">Ejemplos reales: solo despu√©s de Analizar.</div>
      <div class="lang" aria-label="Idioma">
        <button class="langbtn" id="L_CA" type="button">CA</button>
        <button class="langbtn a" id="L_ES" type="button">ES</button>
        <button class="langbtn" id="L_EN" type="button">EN</button>
      </div>
    </div>
  </div>

  <div class="steps" id="stepBar">
    <div class="step active" id="stp1"><div class="step-dot" id="sdot1">1</div><div class="step-label" id="slbl1">Personal</div><div class="step-line"></div></div>
    <div class="step" id="stp2"><div class="step-dot" id="sdot2">2</div><div class="step-label" id="slbl2">Econom√≠a</div><div class="step-line"></div></div>
    <div class="step" id="stp3"><div class="step-dot" id="sdot3">3</div><div class="step-label" id="slbl3">Preferencias</div><div class="step-line"></div></div>
    <div class="step" id="stp4"><div class="step-dot" id="sdot4">4</div><div class="step-label" id="slbl4">Resultado</div></div>
  </div>

  <div class="tabs">
    <div id="t_p" class="tab a" data-i="tab1">1 Personal</div>
    <div id="t_e" class="tab" data-i="tab2">2 Econom√≠a</div>
    <div id="t_f" class="tab" data-i="tab3">3 Preferencias</div>
    <div id="t_r" class="tab dis" data-i="tab4">4 Resultado</div>
    <div id="t_m" class="tab dis" data-i="tab5">5 Comparador</div>
    <div id="t_x" class="tab dis" data-i="tab6">6 Ejemplos reales</div>
    <div id="t_ai" class="tab dis" data-i="tab7">ü§ñ AI Advisor</div>
  </div>

  <!-- 1 Personal -->
  <div class="c" data-p="p">
    <div class="g">
      <div><label data-i="lblName">Nombre y apellidos</label><input id="nm" type="text" autocomplete="name"></div>
      <div><label data-i="lblAge">Edad (18‚Äì100)</label><input id="ag" type="number" min="18" max="100"></div>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintP">Rellena los datos b√°sicos para continuar.</div></div>
    <div class="r" style="margin-top:10px"><button class="b" id="np" type="button" data-i="btnContinue">Continuar</button></div>
  </div>

  <!-- 2 Econom√≠a -->
  <div class="c" data-p="e" style="display:none">
    <div class="g">
      <div>
        <label data-i="lblInc">Ingresos mensuales (‚Ç¨)</label>
        <div class="tip"><input id="inc" type="number" min="0"><span class="tip-icon" tabindex="0">i</span><span class="tip-box" id="tipIncBox" data-i="tipInc"></span></div>
        <div class="field-hint" id="hint-inc"></div>
      </div>
      <div>
        <label data-i="lblSav">Ahorros disponibles (‚Ç¨)</label>
        <div class="tip"><input id="sav" type="number" min="0"><span class="tip-icon" tabindex="0">i</span><span class="tip-box" id="tipSavBox" data-i="tipSav"></span></div>
        <div class="field-hint" id="hint-sav"></div>
      </div>
      <div><label data-i="lblYrs">A√±os de hipoteca (5‚Äì40)</label><input id="yrs" type="number" min="5" max="40" value="25"></div>
      <div><label data-i="lblHor">¬øVivir√°s m√°s de 5 a√±os aqu√≠?</label><select id="hor"><option value="y" data-i="yes">S√≠</option><option value="n" data-i="no">No</option></select></div>
      <div><label data-i="lblFst">¬øPrimera vivienda o familia con menores?</label><select id="fst"><option value="y" data-i="yes">S√≠</option><option value="n" data-i="no">No</option></select></div>
      <div>
        <label data-i="lblMsv">Ahorro mensual (‚Ç¨)</label>
        <div class="tip"><input id="msv" type="number" min="0"><span class="tip-icon" tabindex="0">i</span><span class="tip-box" id="tipMsvBox" data-i="tipMsv"></span></div>
      </div>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintE">Completa econom√≠a y sigue a preferencias.</div></div>
    <div class="r" style="margin-top:10px"><button class="b" id="ne" type="button" data-i="btnContinue">Continuar</button></div>
  </div>

  <!-- 3 Preferencias -->
  <div class="c" data-p="f" style="display:none">
    <div class="g">
      <div>
        <label data-i="lblMuni">Municipio (Baix Pened√®s)</label>
        <select id="ar">
          <option value="*" data-i="any">Cualquiera</option>
          <option>Cunit</option><option>El Vendrell</option><option>Calafell</option><option>Santa Oliva</option><option>Bellvei</option>
          <option>L'Arbo√ß</option><option>Banyeres del Pened√®s</option><option>Albinyana</option><option>Bonastre</option><option>Maslloren√ß</option>
          <option>La Bisbal del Pened√®s</option><option>Lloren√ß del Pened√®s</option><option>Sant Jaume dels Domenys</option><option>El Montmell</option>
        </select>
        <div class="small" style="margin-top:6px" data-i="lblMuniHelp">Si usas el mapa puedes elegir varios municipios.</div>
      </div>
      <div>
        <label data-i="lblM2">Metros cuadrados (‚â•50)</label>
        <input id="m2" type="number" min="50" max="1000">
        <div class="field-hint" id="hint-m2"></div>
      </div>
      <div><label data-i="lblBed">Habitaciones</label><input id="bed" type="number" min="0" max="10" value="2"></div>
      <div><label data-i="lblBath">Ba√±os</label><input id="bat" type="number" min="1" max="10" value="1"></div>
      <div><label data-i="lblType">Tipo de vivienda</label><select id="ty"><option value="flat" data-i="optFlat">Piso</option><option value="house" data-i="optHouse">Casa</option></select></div>
      <div class="r" style="align-items:flex-start">
        <div style="width:100%">
          <label data-i="lblExtras">Extras (opcional)</label>
          <div class="small" data-i="lblExtrasHint">Cambian el precio estimado.</div>
          <div class="r" style="margin-top:8px">
            <label><input type="checkbox" id="et"><span data-i="exTer">Terraza</span></label>
            <label><input type="checkbox" id="ep"><span data-i="exPis">Piscina</span></label>
            <label><input type="checkbox" id="el"><span data-i="exAsc">Ascensor</span></label>
            <label><input type="checkbox" id="ek"><span data-i="exGar">Aparcamiento</span></label>
          </div>
        </div>
      </div>
    </div>
    <div class="r" style="margin-top:10px">
      <button class="b" id="go" type="button" data-i="btnAnalyze">Analizar</button>
      <button class="b ok" id="toggleMap" type="button" data-i="btnMap">Mapa (zona real)</button>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintF">Si cambias preferencias, vuelve a Analizar para actualizar el resultado.</div></div>
    <div id="zoneWrap" class="cardx" style="display:none">
      <div class="top">
        <div>
          <div class="title" data-i="zoneTitle">Zona preferida (mapa real)</div>
          <div class="n" data-i="zoneHint">Haz clic en un municipio para seleccionarlo. Clic de nuevo para deseleccionar.</div>
          <div class="n" id="zoneNote" style="margin-top:6px">Seleccionados: ninguno</div>
        </div>
        <div class="pchips" id="zoneChips"></div>
      </div>
      <div class="r" style="margin-top:10px;justify-content:flex-end">
        <button class="b" id="zoneFitAll" type="button" data-i="btnFitAll">Ver todo</button>
        <button class="b" id="zoneClear" type="button" data-i="btnClear">Limpiar</button>
        <button class="b ok" id="zoneApply" type="button" data-i="btnUse">Usar en Ejemplos reales</button>
      </div>
      <div id="zmap" style="margin-top:10px"></div>
      <div class="legend">
        <span><span class="legdot leg1"></span><span data-i="legSel">Seleccionado</span></span>
        <span><span class="legdot leg2"></span><span data-i="legOk">Municipio disponible</span></span>
      </div>
      <div class="n" id="zoneApplied" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- 4 Resultado -->
  <div class="c" data-p="r" style="display:none">
    <div class="g">
      <div class="k"><span data-i="kPrice">Precio estimado</span><b id="k1">0 ‚Ç¨</b><div class="sub" id="k1sub"></div></div>
      <div class="k"><span data-i="kRent">Alquiler estimado</span><b id="k2">0 ‚Ç¨</b><div class="sub" id="k2sub"></div></div>
      <div class="k"><span data-i="kPay">Cuota hipoteca</span><b id="k3">0 ‚Ç¨</b><div class="sub" id="k3sub"></div></div>
      <div class="k"><span data-i="kRec">Recomendaci√≥n</span><b id="k4">‚Äì</b><div class="sub" id="k4sub"></div></div>
    </div>
    <div id="rCard" class="cardx" style="display:none">
      <div class="top"><div class="title" id="rTitle"></div><div class="chips" id="rChips"></div></div>
      <div class="grid3" id="rMini"></div>
      <div class="grid3" style="margin-top:14px">
        <div class="chartCard">
          <div style="font-weight:950;color:#eaf2ff" data-i="chartEffTitle">Esfuerzo mensual</div>
          <div class="small" data-i="chartEffHint">L√≠nea: 35% ingresos. Barras: hipoteca vs alquiler.</div>
          <div class="canvasWrap" style="margin-top:10px"><canvas id="effChart"></canvas></div>
        </div>
        <div class="chartCard">
          <div style="font-weight:950;color:#eaf2ff" data-i="chartSensTitle">Sensibilidad tipo</div>
          <div class="small" data-i="chartSensHint">C√≥mo cambia la cuota si sube el tipo.</div>
          <div class="canvasWrap" style="margin-top:10px"><canvas id="sensChart"></canvas></div>
        </div>
        <div class="chartCard">
          <div style="font-weight:950;color:#eaf2ff" data-i="chartTipsTitle">Lectura r√°pida</div>
          <div class="small" id="chartTips"></div>
          <div style="margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.18);background:rgba(2,6,23,.35);color:#cbd5e1;line-height:1.65" id="quickExplain"></div>
        </div>
      </div>
      <div class="body" id="rBody"></div>
      <div class="note" id="rt"></div>
    </div>
    <div class="r" style="margin-top:10px">
      <button class="b" id="cp" type="button" data-i="btnCopy">Copiar resumen</button>
      <button class="b" id="rs" type="button" data-i="btnReset">Reiniciar</button>
      <button class="b ok" id="jumpX" type="button" data-i="btnGoExamples">Ir a Ejemplos reales</button>
      <button class="b ok" id="jumpAI" type="button" data-i="btnAskAI">üí¨ Consultar con AI</button>
    </div>
    <div class="share-bar">
      <button class="share-btn wa" id="shareWa" type="button">üì± WhatsApp</button>
      <button class="share-btn cl" id="shareCl" type="button">üìã <span data-i="btnCopy2">Copiar</span></button>
    </div>
  </div>

  <!-- 5 Comparador -->
  <div class="c" data-p="m" style="display:none">
    <div class="g">
      <div><label data-i="lblProv">Provincia (comparador)</label><select id="cm"><option>Barcelona</option><option>Girona</option><option>Lleida</option><option>Tarragona</option></select></div>
      <div><label data-i="lblM2s">m¬≤</label><input id="cm2" type="number" min="50"></div>
      <div><label data-i="lblBed">Habitaciones</label><input id="cbd" type="number" min="0" max="10"></div>
      <div><label data-i="lblBath">Ba√±os</label><input id="cba" type="number" min="1" max="10"></div>
      <div><label data-i="lblType2">Tipo</label><select id="cty"><option value="flat" data-i="optFlat">Piso</option><option value="house" data-i="optHouse">Casa</option></select></div>
      <div class="r" style="align-items:flex-start">
        <div style="width:100%">
          <label data-i="lblExtras2">Extras (comparador)</label>
          <div class="r" style="margin-top:8px">
            <label><input type="checkbox" id="ct"><span data-i="exTer">Terraza</span></label>
            <label><input type="checkbox" id="cp0"><span data-i="exPis">Piscina</span></label>
            <label><input type="checkbox" id="cl0"><span data-i="exAsc">Ascensor</span></label>
            <label><input type="checkbox" id="ck0"><span data-i="exGar">Aparcamiento</span></label>
          </div>
        </div>
      </div>
    </div>
    <div id="cmap" style="width:100%;height:320px;border:0;border-radius:12px;margin-top:12px"></div>
    <div class="r" style="margin-top:10px">
      <button class="b" id="bc" type="button" data-i="btnCompare">Comparar</button>
      <button class="b ok" id="autoFillCmp" type="button" data-i="btnUseMine">Usar mis datos</button>
    </div>
    <div class="cardx" style="margin-top:12px">
      <div class="top"><div class="title" data-i="cmpTitle">Resultado del comparador</div><div class="chips" id="cmpChips"></div></div>
      <div class="body" id="cmg"></div>
      <div class="chartCard" style="margin-top:14px">
        <div style="font-weight:950;color:#eaf2ff" data-i="cmpChartTitle">Comparaci√≥n visual</div>
        <div class="small" data-i="cmpChartHint">Tu zona vs provincia.</div>
        <div class="canvasWrap" style="margin-top:10px"><canvas id="cmpChart"></canvas></div>
      </div>
    </div>
  </div>

  <!-- 6 Ejemplos reales -->
  <div class="c" data-p="x" style="display:none">
    <div class="n" id="xinfo"></div>
    <div class="r" style="margin-top:10px" id="xbtns"></div>
    <div class="gu"><span class="a">üìç</span><div class="n" data-i="hintX">Si elegiste varios municipios, salen botones por municipio.</div></div>
  </div>

  <!-- 7 AI Advisor -->
  <div class="c" data-p="ai" style="display:none">
    <div class="cardx">
      <div class="top">
        <div class="title">ü§ñ AI Financial Advisor</div>
        <div class="chips">
          <span class="ai-badge api" id="aiBadge"><span class="dot" id="aiBadgeDot"></span><span id="aiBadgeTxt" data-i="aiConnected">Conectado</span></span>
        </div>
      </div>
      <div class="gu" style="margin-top:0;margin-bottom:16px">
        <span class="a">üí°</span>
        <div class="n"><b data-i="aiAdvisorTitle">Tu asesor financiero personal.</b> <span data-i="aiAdvisorDesc">Usa IA real (Claude API) ‚Äî responde cualquier pregunta, no solo de vivienda.</span></div>
      </div>
      <div class="ai-toolbar">
        <button class="ai-tool-btn" id="aiPlanBtn" type="button" data-i="aiPlanBtnLbl">üß≠ Plan de acci√≥n</button>
        <button class="ai-tool-btn" id="aiClearBtn" type="button" data-i="aiClearBtnLbl">üóëÔ∏è Limpiar chat</button>
        <button class="ai-tool-btn" id="aiCopyBtn" type="button" data-i="aiCopyBtnLbl">üìã Copiar chat</button>
      </div>
      <div class="ai-context" id="aiContext"></div>
      <div class="suggestion-chips" id="aiSuggestions"></div>
      <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
          <div class="chat-message ai" id="welcome-message">
            <div class="chat-avatar ai">AI</div>
            <div class="chat-bubble" id="welcome-bubble"></div>
          </div>
        </div>
        <div class="chat-input-wrap">
          <textarea class="chat-input" id="chatInput" rows="1"></textarea>
          <button class="chat-send-btn" id="chatSend" data-i="aiSend">Enviar</button>
        </div>
      </div>
    </div>
  </div>

</div><!-- /.w -->

<div class="sig">
  <div class="br">Assessoria d'Habitatge</div>
  <div>
    <a href="https://www.assesoriahabitatge.com/" target="_blank" rel="noopener">assesoriahabitatge.com</a> ¬∑
    <a href="mailto:info@assessoriahabitatge.com">info@assessoriahabitatge.com</a>
  </div>
</div>
<div id="ts" class="tst" role="status" aria-live="polite"></div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MAPA: Pol√≠gonos de alta fidelidad (30+ puntos por municipio)
//  Coordenadas reales del Baix Pened√®s (ICGC / OpenStreetMap)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FALLBACK_POLYGONS={
  "El Vendrell":[
    [41.1965,1.5020],[41.2020,1.5085],[41.2075,1.5120],[41.2130,1.5180],
    [41.2185,1.5240],[41.2230,1.5310],[41.2265,1.5390],[41.2280,1.5470],
    [41.2270,1.5560],[41.2245,1.5640],[41.2200,1.5700],[41.2140,1.5740],
    [41.2075,1.5760],[41.2010,1.5750],[41.1960,1.5720],[41.1920,1.5680],
    [41.1890,1.5630],[41.1875,1.5570],[41.1870,1.5500],[41.1880,1.5430],
    [41.1900,1.5360],[41.1930,1.5290],[41.1945,1.5210],[41.1955,1.5130],[41.1965,1.5020]
  ],
  "Calafell":[
    [41.1680,1.5460],[41.1730,1.5510],[41.1800,1.5590],[41.1870,1.5650],
    [41.1940,1.5700],[41.2000,1.5730],[41.2060,1.5770],[41.2100,1.5820],
    [41.2120,1.5890],[41.2110,1.5960],[41.2085,1.6030],[41.2050,1.6090],
    [41.2000,1.6130],[41.1940,1.6150],[41.1875,1.6140],[41.1810,1.6110],
    [41.1750,1.6060],[41.1700,1.6000],[41.1660,1.5930],[41.1630,1.5850],
    [41.1620,1.5770],[41.1625,1.5690],[41.1645,1.5620],[41.1665,1.5540],[41.1680,1.5460]
  ],
  "Cunit":[
    [41.1920,1.6110],[41.1975,1.6150],[41.2035,1.6200],[41.2090,1.6260],
    [41.2130,1.6330],[41.2145,1.6410],[41.2140,1.6490],[41.2115,1.6560],
    [41.2070,1.6620],[41.2010,1.6660],[41.1940,1.6680],[41.1870,1.6670],
    [41.1810,1.6640],[41.1760,1.6590],[41.1730,1.6530],[41.1710,1.6460],
    [41.1710,1.6390],[41.1730,1.6320],[41.1760,1.6260],[41.1800,1.6210],
    [41.1850,1.6170],[41.1900,1.6140],[41.1920,1.6110]
  ],
  "Bellvei":[
    [41.2000,1.5540],[41.2060,1.5590],[41.2120,1.5650],[41.2170,1.5720],
    [41.2200,1.5800],[41.2210,1.5880],[41.2195,1.5960],[41.2165,1.6030],
    [41.2115,1.6080],[41.2055,1.6110],[41.1990,1.6120],[41.1930,1.6100],
    [41.1880,1.6060],[41.1845,1.6000],[41.1830,1.5930],[41.1835,1.5860],
    [41.1855,1.5790],[41.1890,1.5730],[41.1935,1.5680],[41.1975,1.5630],[41.2000,1.5540]
  ],
  "Santa Oliva":[
    [41.2230,1.5100],[41.2300,1.5160],[41.2365,1.5230],[41.2420,1.5310],
    [41.2455,1.5400],[41.2470,1.5490],[41.2460,1.5580],[41.2430,1.5660],
    [41.2385,1.5720],[41.2325,1.5760],[41.2255,1.5780],[41.2185,1.5770],
    [41.2125,1.5740],[41.2075,1.5700],[41.2040,1.5640],[41.2025,1.5570],
    [41.2030,1.5500],[41.2050,1.5430],[41.2085,1.5360],[41.2130,1.5300],
    [41.2175,1.5240],[41.2210,1.5180],[41.2230,1.5100]
  ],
  "Albinyana":[
    [41.2175,1.4720],[41.2245,1.4790],[41.2315,1.4870],[41.2375,1.4960],
    [41.2415,1.5060],[41.2435,1.5160],[41.2430,1.5255],[41.2400,1.5340],
    [41.2350,1.5410],[41.2285,1.5460],[41.2210,1.5485],[41.2135,1.5490],
    [41.2065,1.5475],[41.2005,1.5445],[41.1960,1.5400],[41.1930,1.5345],
    [41.1920,1.5285],[41.1930,1.5225],[41.1955,1.5165],[41.1995,1.5110],
    [41.2045,1.5060],[41.2100,1.5010],[41.2145,1.4960],[41.2175,1.4720]
  ],
  "L'Arbo√ß":[
    [41.2820,1.5700],[41.2890,1.5760],[41.2950,1.5840],[41.2995,1.5930],
    [41.3020,1.6030],[41.3020,1.6130],[41.2995,1.6220],[41.2950,1.6300],
    [41.2885,1.6360],[41.2810,1.6395],[41.2730,1.6405],[41.2650,1.6390],
    [41.2580,1.6350],[41.2525,1.6290],[41.2490,1.6220],[41.2475,1.6140],
    [41.2480,1.6060],[41.2505,1.5980],[41.2545,1.5910],[41.2600,1.5850],
    [41.2665,1.5800],[41.2730,1.5760],[41.2790,1.5730],[41.2820,1.5700]
  ],
  "Lloren√ß del Pened√®s":[
    [41.2600,1.5380],[41.2675,1.5440],[41.2745,1.5520],[41.2800,1.5610],
    [41.2835,1.5710],[41.2845,1.5815],[41.2830,1.5910],[41.2795,1.5995],
    [41.2740,1.6065],[41.2670,1.6115],[41.2590,1.6140],[41.2510,1.6140],
    [41.2435,1.6115],[41.2370,1.6070],[41.2325,1.6010],[41.2300,1.5940],
    [41.2295,1.5870],[41.2310,1.5800],[41.2340,1.5735],[41.2385,1.5675],
    [41.2440,1.5625],[41.2500,1.5585],[41.2560,1.5560],[41.2600,1.5380]
  ],
  "Banyeres del Pened√®s":[
    [41.2810,1.5000],[41.2885,1.5070],[41.2955,1.5160],[41.3010,1.5260],
    [41.3045,1.5370],[41.3060,1.5480],[41.3050,1.5580],[41.3020,1.5670],
    [41.2970,1.5745],[41.2905,1.5800],[41.2830,1.5830],[41.2750,1.5840],
    [41.2675,1.5820],[41.2605,1.5785],[41.2550,1.5735],[41.2510,1.5675],
    [41.2490,1.5605],[41.2490,1.5535],[41.2510,1.5465],[41.2545,1.5400],
    [41.2595,1.5345],[41.2655,1.5300],[41.2720,1.5265],[41.2785,1.5235],[41.2810,1.5000]
  ],
  "Sant Jaume dels Domenys":[
    [41.3000,1.4820],[41.3080,1.4895],[41.3155,1.4985],[41.3215,1.5085],
    [41.3255,1.5195],[41.3270,1.5310],[41.3260,1.5420],[41.3225,1.5520],
    [41.3170,1.5600],[41.3100,1.5660],[41.3020,1.5700],[41.2940,1.5715],
    [41.2860,1.5705],[41.2790,1.5675],[41.2730,1.5625],[41.2685,1.5565],
    [41.2660,1.5495],[41.2655,1.5425],[41.2665,1.5355],[41.2695,1.5290],
    [41.2735,1.5230],[41.2785,1.5175],[41.2840,1.5125],[41.2900,1.5080],[41.3000,1.4820]
  ],
  "La Bisbal del Pened√®s":[
    [41.2490,1.4600],[41.2570,1.4670],[41.2645,1.4755],[41.2710,1.4850],
    [41.2755,1.4955],[41.2780,1.5060],[41.2780,1.5165],[41.2755,1.5260],
    [41.2710,1.5340],[41.2650,1.5405],[41.2575,1.5450],[41.2495,1.5475],
    [41.2415,1.5475],[41.2345,1.5455],[41.2285,1.5420],[41.2240,1.5370],
    [41.2215,1.5310],[41.2210,1.5245],[41.2225,1.5180],[41.2255,1.5120],
    [41.2300,1.5065],[41.2355,1.5015],[41.2415,1.4970],[41.2455,1.4785],[41.2490,1.4600]
  ],
  "Bonastre":[
    [41.1980,1.4100],[41.2060,1.4180],[41.2140,1.4275],[41.2205,1.4380],
    [41.2255,1.4495],[41.2285,1.4615],[41.2290,1.4730],[41.2270,1.4840],
    [41.2230,1.4935],[41.2170,1.5015],[41.2095,1.5080],[41.2010,1.5125],
    [41.1920,1.5145],[41.1835,1.5140],[41.1755,1.5115],[41.1690,1.5070],
    [41.1640,1.5010],[41.1610,1.4940],[41.1600,1.4865],[41.1610,1.4790],
    [41.1640,1.4720],[41.1680,1.4660],[41.1730,1.4605],[41.1790,1.4555],
    [41.1855,1.4510],[41.1920,1.4470],[41.1980,1.4100]
  ],
  "Maslloren√ß":[
    [41.2460,1.3900],[41.2540,1.3980],[41.2615,1.4080],[41.2680,1.4195],
    [41.2725,1.4315],[41.2750,1.4440],[41.2750,1.4560],[41.2725,1.4670],
    [41.2680,1.4765],[41.2620,1.4845],[41.2545,1.4905],[41.2460,1.4945],
    [41.2375,1.4960],[41.2295,1.4950],[41.2225,1.4920],[41.2170,1.4875],
    [41.2130,1.4820],[41.2110,1.4755],[41.2110,1.4690],[41.2130,1.4625],
    [41.2165,1.4565],[41.2215,1.4510],[41.2275,1.4460],[41.2340,1.4415],
    [41.2405,1.4375],[41.2460,1.3900]
  ],
  "El Montmell":[
    [41.2900,1.4140],[41.2990,1.4230],[41.3075,1.4345],[41.3145,1.4470],
    [41.3195,1.4605],[41.3225,1.4745],[41.3230,1.4880],[41.3210,1.5010],
    [41.3170,1.5125],[41.3110,1.5225],[41.3035,1.5305],[41.2950,1.5365],
    [41.2860,1.5405],[41.2770,1.5420],[41.2685,1.5410],[41.2610,1.5380],
    [41.2545,1.5330],[41.2495,1.5270],[41.2460,1.5200],[41.2445,1.5125],
    [41.2450,1.5055],[41.2470,1.4985],[41.2505,1.4920],[41.2555,1.4860],
    [41.2615,1.4800],[41.2680,1.4740],[41.2745,1.4680],[41.2810,1.4615],
    [41.2860,1.4545],[41.2900,1.4140]
  ]
};

// Centroides para etiquetas permanentes
const MUNI_CENTROIDS={
  "El Vendrell":[41.2075,1.5390],
  "Calafell":[41.1875,1.5850],
  "Cunit":[41.1930,1.6390],
  "Bellvei":[41.2020,1.5830],
  "Santa Oliva":[41.2250,1.5440],
  "Albinyana":[41.2175,1.5100],
  "L'Arbo√ß":[41.2750,1.6050],
  "Lloren√ß del Pened√®s":[41.2570,1.5860],
  "Banyeres del Pened√®s":[41.2770,1.5530],
  "Sant Jaume dels Domenys":[41.2960,1.5270],
  "La Bisbal del Pened√®s":[41.2495,1.5040],
  "Bonastre":[41.1945,1.4810],
  "Maslloren√ß":[41.2430,1.4580],
  "El Montmell":[41.2840,1.4790]
};

const MUNI_NAMES=Object.keys(FALLBACK_POLYGONS);
let _attempts=0;
function waitForLeaflet(){
  if(typeof L!=="undefined") initApp();
  else if(_attempts++<100) setTimeout(waitForLeaflet,50);
  else alert("Error: no se pudo cargar el mapa. Recarga la p√°gina.");
}

function initApp(){(()=>{
const Q=s=>document.querySelector(s);
const QA=s=>[...document.querySelectorAll(s)];
const fmtES=n=>Math.round(n).toLocaleString("es-ES");
const fmtEN=n=>Math.round(n).toLocaleString("en-US");

const STORE_KEY="hx_form_v10",ZONE_KEY="hx_zoneSel_v7",LANG_KEY="hx_lang",CHAT_KEY="hx_chat_v4";

/* =====================
   I18N ‚Äî Multiidioma completo
   ===================== */
const I18N={
ES:{
  hdrTitle:"Assessoria d'Habitatge ¬∑ Baix Pened√®s",hdrHint:"Ejemplos reales: solo despu√©s de Analizar.",
  tab1:"1 Personal",tab2:"2 Econom√≠a",tab3:"3 Preferencias",tab4:"4 Resultado",tab5:"5 Comparador",
  tab6:"6 Ejemplos reales",tab7:"ü§ñ AI Advisor",
  lblName:"Nombre y apellidos",lblAge:"Edad (18‚Äì100)",btnContinue:"Continuar",
  hintP:"Rellena los datos b√°sicos para continuar.",
  lblInc:"Ingresos mensuales (‚Ç¨)",lblSav:"Ahorros disponibles (‚Ç¨)",lblYrs:"A√±os de hipoteca (5‚Äì40)",
  lblHor:"¬øVivir√°s m√°s de 5 a√±os aqu√≠?",lblFst:"¬øPrimera vivienda o familia con menores?",lblMsv:"Ahorro mensual (‚Ç¨)",
  tipInc:"Ingresos netos (lo que entra en tu cuenta). Si metes bruto, la recomendaci√≥n se distorsiona.",
  tipSav:"Solo lo que puedes usar de verdad. Entrada + impuestos + notar√≠a van aqu√≠.",
  tipMsv:"Sirve para estimar cu√°nto tardas en llegar al cash necesario.",
  hintE:"Completa econom√≠a y sigue a preferencias.",
  lblMuni:"Municipio (Baix Pened√®s)",lblMuniHelp:"Usa el mapa para elegir varios municipios.",
  lblM2:"Metros cuadrados (‚â•50)",lblBed:"Habitaciones",lblBath:"Ba√±os",lblType:"Tipo de vivienda",
  optFlat:"Piso",optHouse:"Casa",lblExtras:"Extras (opcional)",lblExtrasHint:"Cambian el precio estimado.",
  exTer:"Terraza",exPis:"Piscina",exAsc:"Ascensor",exGar:"Aparcamiento",
  btnAnalyze:"Analizar",btnMap:"Mapa (zona real)",
  hintF:"Si cambias preferencias, vuelve a Analizar.",
  zoneTitle:"Zona preferida (mapa real)",zoneHint:"Haz clic en un municipio para seleccionarlo. Clic de nuevo para deseleccionar.",
  btnClear:"Limpiar",btnUse:"Usar en Ejemplos reales",btnFitAll:"Ver todo",
  legSel:"Seleccionado",legOk:"Municipio disponible",
  kPrice:"Precio estimado",kRent:"Alquiler estimado",kPay:"Cuota hipoteca",kRec:"Recomendaci√≥n",
  btnCopy:"Copiar resumen",btnReset:"Reiniciar",btnGoExamples:"Ir a Ejemplos reales",btnAskAI:"üí¨ Consultar con AI",
  chartEffTitle:"Esfuerzo mensual",chartEffHint:"L√≠nea: 35% ingresos. Barras: hipoteca vs alquiler.",
  chartSensTitle:"Sensibilidad tipo",chartSensHint:"C√≥mo cambia la cuota si sube el tipo.",chartTipsTitle:"Lectura r√°pida",
  lblProv:"Provincia (comparador)",lblM2s:"m¬≤",lblType2:"Tipo",btnCompare:"Comparar",btnUseMine:"Usar mis datos",
  lblExtras2:"Extras (comparador)",lblExtrasHint2:"Mismas caracter√≠sticas, distinta zona.",
  cmpTitle:"Resultado del comparador",cmpChartTitle:"Comparaci√≥n visual",cmpChartHint:"Tu zona vs provincia.",
  hintX:"Si elegiste varios municipios, salen botones por municipio.",
  yes:"S√≠",no:"No",
  recBuy:"COMPRAR",recRent:"ALQUILAR",recNotFeasible:"NO FACTIBLE",
  toastCheck:"Revisa nombre/edad y que m¬≤/ba√±os sean v√°lidos.",toastFirst:"Primero analiza.",
  toastPrefs:"Preferencias cambiadas: vuelve a Analizar.",toastNoLink:"No se pudo generar el link",
  toastCopied:"Copiado",toastZoneCleared:"Zona limpiada",toastNoZone:"No hay municipios seleccionados",
  toastZoneApplied:"Zona aplicada",
  stateReady:"‚úÖ Disponible",stateNeed:"‚õî Requiere Analizar",
  xInfo:"Municipio: {muni} ¬∑ Estado: {state}",sumTitle:"Resumen ¬∑ {rec}",
  chipMort:"Esfuerzo hipoteca: {pct}",chipRent:"Esfuerzo alquiler: {pct}",
  chipCash:"Cash necesario: {eur}",chipRate:"Tipo: {rate}",
  miniPrice:"Precio estimado",miniPay:"Cuota hipoteca",miniRent:"Alquiler estimado",
  savingsOk:"‚úÖ Ahorros suficientes para entrada + costes.",
  yearsToSave:"Ahorrando {msv}/mes, llegar√°s al objetivo en ~{yrs} a√±os ({mos} meses).",
  itpNote:"En Catalunya la compra implica ~10% ITP + notar√≠a/registro.",
  avgZone:"Media de {n} municipios",
  stepPersonal:"Personal",stepEco:"Econom√≠a",stepPref:"Preferencias",stepRes:"Resultado",
  cmpCheaper:"m√°s barato",cmpExpensive:"m√°s caro",cmpSame:"igual",cmpExplTitle:"Interpretaci√≥n",
  any:"Cualquiera",btnCopy2:"Copiar",missingDataCmp:"Completa provincia, m¬≤ y ba√±os (m√≠nimo 1).",
  // I18N completado: claves de resultado
  yrs:"a√±os",beds:"hab.",baths:"ba√±o(s)",noExtras:"Sin extras",
  safeCapacity:"Capacidad segura",buyLabel:"COMPRA",rentLabel:"ALQUILER",
  strictLabel:"estricto",flexLabel:"flex",
  selectedLabel:"Seleccionados:",noneLabel:"ninguno",activeLabel:"Activos:",noSelection:"Sin selecci√≥n",
  diffLabel:"Diferencia",priceInProv:"Precio en provincia",priceInZone:"Precio en tu zona",
  rentInProv:"Alquiler en provincia",rentInZone:"Alquiler en tu zona",
  mortgageEffortLabel:"Esfuerzo hipoteca",rentEffortLabel:"Esfuerzo alquiler",
  recLimit35:"L√≠mite recomendado: 35%",recLimit40:"L√≠mite recomendado: 40%",
  financingTitle:"Financiaci√≥n",prefsTitle:"Preferencias",monthlyEffortTitle:"Esfuerzo mensual",
  downPaymentLabel:"Entrada",closingCostsLabel:"Gastos",toFinanceLabel:"A financiar",
  // AI
  aiConnected:"API Claude activa",aiLocalMode:"Motor local activo",aiError:"Error de conexi√≥n",
  aiAdvisorTitle:"Tu asesor financiero personal.",
  aiAdvisorDesc:"Usa IA real (Claude API) ‚Äî responde cualquier pregunta, no solo de vivienda.",
  aiWelcome:"üëã ¬°Hola! Soy tu asesor financiero personal potenciado por Claude AI. Puedo ayudarte con cualquier pregunta ‚Äî desde hipotecas hasta inversiones, negocios, tecnolog√≠a, o cualquier otro tema. ¬øEn qu√© puedo ayudarte hoy?",
  aiThinking:"Pensando...",aiYou:"T√ö",aiPlaceholder:"Escribe cualquier pregunta...",aiSend:"Enviar",
  aiPlanBtnLbl:"üß≠ Plan de acci√≥n",aiClearBtnLbl:"üóëÔ∏è Limpiar chat",aiCopyBtnLbl:"üìã Copiar chat",
  aiSug1:"¬øC√≥mo mejorar mi situaci√≥n?",aiSug2:"¬øCu√°nto ahorrar para comprar?",
  aiSug3:"¬øComprar o alquilar?",aiSug4:"¬øQu√© municipio me recomiendas?",
  aiSug5:"¬øY si sube el tipo de inter√©s?",aiSug6:"Estrategias de compra"
},
CA:{
  hdrTitle:"Assessoria d'Habitatge ¬∑ Baix Pened√®s",hdrHint:"Exemples reals: nom√©s despr√©s d'Analitzar.",
  tab1:"1 Personal",tab2:"2 Economia",tab3:"3 Prefer√®ncies",tab4:"4 Resultat",tab5:"5 Comparador",
  tab6:"6 Exemples reals",tab7:"ü§ñ AI Advisor",
  lblName:"Nom i cognoms",lblAge:"Edat (18‚Äì100)",btnContinue:"Continuar",
  hintP:"Omple les dades b√†siques per continuar.",
  lblInc:"Ingressos mensuals (‚Ç¨)",lblSav:"Estalvis disponibles (‚Ç¨)",lblYrs:"Anys d'hipoteca (5‚Äì40)",
  lblHor:"Viur√†s m√©s de 5 anys aqu√≠?",lblFst:"Primera vivenda o fam√≠lia amb menors?",lblMsv:"Estalvi mensual (‚Ç¨)",
  tipInc:"Ingressos nets (el que entra al compte).",
  tipSav:"Nom√©s el que pots usar de veritat.",
  tipMsv:"Per estimar quant tardes a arribar al cash necessari.",
  hintE:"Completa economia i passa a prefer√®ncies.",
  lblMuni:"Municipi (Baix Pened√®s)",lblMuniHelp:"Usa el mapa per triar diversos municipis.",
  lblM2:"Metres quadrats (‚â•50)",lblBed:"Habitacions",lblBath:"Banys",lblType:"Tipus d'habitatge",
  optFlat:"Pis",optHouse:"Casa",lblExtras:"Extres (opcional)",lblExtrasHint:"Canvien el preu estimat.",
  exTer:"Terrassa",exPis:"Piscina",exAsc:"Ascensor",exGar:"Aparcament",
  btnAnalyze:"Analitzar",btnMap:"Mapa (zona real)",
  hintF:"Si canvies prefer√®ncies, torna a Analitzar.",
  zoneTitle:"Zona preferida (mapa real)",zoneHint:"Clica un municipi per seleccionar-lo. Torna a clicar per deseleccionar.",
  btnClear:"Netejar",btnUse:"Usar a Exemples reals",btnFitAll:"Veure tot",
  legSel:"Seleccionat",legOk:"Municipi disponible",
  kPrice:"Preu estimat",kRent:"Lloguer estimat",kPay:"Quota hipoteca",kRec:"Recomanaci√≥",
  btnCopy:"Copiar resum",btnReset:"Reiniciar",btnGoExamples:"Anar a Exemples reals",btnAskAI:"üí¨ Consultar amb AI",
  chartEffTitle:"Esfor√ß mensual",chartEffHint:"L√≠nia: 35% ingressos. Barres: hipoteca vs lloguer.",
  chartSensTitle:"Sensibilitat tipus",chartSensHint:"Com canvia la quota si puja el tipus.",chartTipsTitle:"Lectura r√†pida",
  lblProv:"Prov√≠ncia (comparador)",lblM2s:"m¬≤",lblType2:"Tipus",btnCompare:"Comparar",btnUseMine:"Usar les meves dades",
  lblExtras2:"Extres (comparador)",lblExtrasHint2:"Mateixes caracter√≠stiques, zona diferent.",
  cmpTitle:"Resultat del comparador",cmpChartTitle:"Comparaci√≥ visual",cmpChartHint:"La teva zona vs prov√≠ncia.",
  hintX:"Si has triat diversos municipis, surten botons per municipi.",
  yes:"S√≠",no:"No",
  recBuy:"COMPRAR",recRent:"LLOGAR",recNotFeasible:"NO FACTIBLE",
  toastCheck:"Revisa nom/edat i que m¬≤/banys siguin v√†lids.",toastFirst:"Primer analitza.",
  toastPrefs:"Prefer√®ncies canviades: torna a Analitzar.",toastNoLink:"No s'ha pogut generar l'enlla√ß",
  toastCopied:"Copiat",toastZoneCleared:"Zona netejada",toastNoZone:"No hi ha municipis seleccionats",
  toastZoneApplied:"Zona aplicada",
  stateReady:"‚úÖ Disponible",stateNeed:"‚õî Cal Analitzar",
  xInfo:"Municipi: {muni} ¬∑ Estat: {state}",sumTitle:"Resum ¬∑ {rec}",
  chipMort:"Esfor√ß hipoteca: {pct}",chipRent:"Esfor√ß lloguer: {pct}",
  chipCash:"Cash necessari: {eur}",chipRate:"Tipus: {rate}",
  miniPrice:"Preu estimat",miniPay:"Quota hipoteca",miniRent:"Lloguer estimat",
  savingsOk:"‚úÖ Estalvis suficients per a entrada + despeses.",
  yearsToSave:"Estalviant {msv}/mes, arribar√†s a l'objectiu en ~{yrs} anys ({mos} mesos).",
  itpNote:"A Catalunya la compra implica ~10% ITP + notaria/registre.",
  avgZone:"Mitjana de {n} municipis",
  stepPersonal:"Personal",stepEco:"Economia",stepPref:"Prefer√®ncies",stepRes:"Resultat",
  cmpCheaper:"m√©s barat",cmpExpensive:"m√©s car",cmpSame:"igual",cmpExplTitle:"Interpretaci√≥",
  any:"Qualsevol",btnCopy2:"Copiar",missingDataCmp:"Completa prov√≠ncia, m¬≤ i banys (m√≠nim 1).",
  yrs:"anys",beds:"hab.",baths:"bany(s)",noExtras:"Sense extres",
  safeCapacity:"Capacitat segura",buyLabel:"COMPRA",rentLabel:"LLOGUER",
  strictLabel:"estricte",flexLabel:"flex",
  selectedLabel:"Seleccionats:",noneLabel:"cap",activeLabel:"Actius:",noSelection:"Sense selecci√≥",
  diffLabel:"Difer√®ncia",priceInProv:"Preu a la prov√≠ncia",priceInZone:"Preu a la teva zona",
  rentInProv:"Lloguer a la prov√≠ncia",rentInZone:"Lloguer a la teva zona",
  mortgageEffortLabel:"Esfor√ß hipoteca",rentEffortLabel:"Esfor√ß lloguer",
  recLimit35:"L√≠mit recomanat: 35%",recLimit40:"L√≠mit recomanat: 40%",
  financingTitle:"Finan√ßament",prefsTitle:"Prefer√®ncies",monthlyEffortTitle:"Esfor√ß mensual",
  downPaymentLabel:"Entrada",closingCostsLabel:"Despeses",toFinanceLabel:"A finan√ßar",
  aiConnected:"API Claude activa",aiLocalMode:"Motor local actiu",aiError:"Error de connexi√≥",
  aiAdvisorTitle:"El teu assessor financer personal.",
  aiAdvisorDesc:"Usa IA real (Claude API) ‚Äî respon qualsevol pregunta, no nom√©s d'habitatge.",
  aiWelcome:"üëã Hola! Soc el teu assessor financer personal potenciat per Claude AI. Et puc ajudar amb qualsevol pregunta ‚Äî des d'hipoteques fins a inversions, negocis, tecnologia, o qualsevol altre tema. En qu√® et puc ajudar avui?",
  aiThinking:"Pensant...",aiYou:"TU",aiPlaceholder:"Escriu qualsevol pregunta...",aiSend:"Enviar",
  aiPlanBtnLbl:"üß≠ Pla d'acci√≥",aiClearBtnLbl:"üóëÔ∏è Netejar xat",aiCopyBtnLbl:"üìã Copiar xat",
  aiSug1:"Com millorar la meva situaci√≥?",aiSug2:"Quant estalviar per comprar?",
  aiSug3:"Comprar o llogar?",aiSug4:"Quin municipi em recomanes?",
  aiSug5:"I si puja el tipus d'inter√®s?",aiSug6:"Estrat√®gies de compra"
},
EN:{
  hdrTitle:"Housing Advisor ¬∑ Baix Pened√®s",hdrHint:"Real examples: only after Analyze.",
  tab1:"1 Personal",tab2:"2 Finance",tab3:"3 Preferences",tab4:"4 Result",tab5:"5 Comparator",
  tab6:"6 Real examples",tab7:"ü§ñ AI Advisor",
  lblName:"Full name",lblAge:"Age (18‚Äì100)",btnContinue:"Continue",
  hintP:"Fill in the basics to continue.",
  lblInc:"Monthly income (‚Ç¨)",lblSav:"Available savings (‚Ç¨)",lblYrs:"Mortgage years (5‚Äì40)",
  lblHor:"Living here > 5 years?",lblFst:"First home or family with minors?",lblMsv:"Monthly savings (‚Ç¨)",
  tipInc:"Net income (what actually hits your bank account).",
  tipSav:"Only what you can truly use.",
  tipMsv:"Used to estimate how long to reach the needed cash.",
  hintE:"Complete finance and move to preferences.",
  lblMuni:"Town (Baix Pened√®s)",lblMuniHelp:"Use the map to pick multiple towns.",
  lblM2:"Square meters (‚â•50)",lblBed:"Bedrooms",lblBath:"Bathrooms",lblType:"Property type",
  optFlat:"Flat",optHouse:"House",lblExtras:"Extras (optional)",lblExtrasHint:"They change the price estimate.",
  exTer:"Terrace",exPis:"Pool",exAsc:"Elevator",exGar:"Parking",
  btnAnalyze:"Analyze",btnMap:"Map (real area)",
  hintF:"If you change preferences, analyze again.",
  zoneTitle:"Preferred area (real map)",zoneHint:"Click a municipality to select it. Click again to deselect.",
  btnClear:"Clear",btnUse:"Use in Real examples",btnFitAll:"Fit all",
  legSel:"Selected",legOk:"Available municipality",
  kPrice:"Estimated price",kRent:"Estimated rent",kPay:"Mortgage payment",kRec:"Recommendation",
  btnCopy:"Copy summary",btnReset:"Reset",btnGoExamples:"Go to Real examples",btnAskAI:"üí¨ Ask AI",
  chartEffTitle:"Monthly effort",chartEffHint:"Line: 35% income. Bars: mortgage vs rent.",
  chartSensTitle:"Rate sensitivity",chartSensHint:"How payment changes if rates rise.",chartTipsTitle:"Quick read",
  lblProv:"Province (comparator)",lblM2s:"m¬≤",lblType2:"Type",btnCompare:"Compare",btnUseMine:"Use my data",
  lblExtras2:"Extras (comparator)",lblExtrasHint2:"Same features, different area.",
  cmpTitle:"Comparator result",cmpChartTitle:"Visual comparison",cmpChartHint:"Your area vs province.",
  hintX:"If you chose multiple towns, you get buttons per town.",
  yes:"Yes",no:"No",
  recBuy:"BUY",recRent:"RENT",recNotFeasible:"NOT FEASIBLE",
  toastCheck:"Check name/age and ensure m¬≤/bathrooms are valid.",toastFirst:"Analyze first.",
  toastPrefs:"Preferences changed: analyze again.",toastNoLink:"Could not generate the link",
  toastCopied:"Copied",toastZoneCleared:"Area cleared",toastNoZone:"No towns selected",
  toastZoneApplied:"Area applied",
  stateReady:"‚úÖ Ready",stateNeed:"‚õî Please Analyze",
  xInfo:"Town: {muni} ¬∑ Status: {state}",sumTitle:"Summary ¬∑ {rec}",
  chipMort:"Mortgage effort: {pct}",chipRent:"Rent effort: {pct}",
  chipCash:"Cash needed: {eur}",chipRate:"Rate: {rate}",
  miniPrice:"Estimated price",miniPay:"Mortgage payment",miniRent:"Estimated rent",
  savingsOk:"‚úÖ Savings cover down payment + costs.",
  yearsToSave:"Saving {msv}/mo, you'll reach the goal in ~{yrs} years ({mos} months).",
  itpNote:"In Catalunya, purchase implies ~10% tax + notary/registry.",
  avgZone:"Average of {n} towns",
  stepPersonal:"Personal",stepEco:"Finance",stepPref:"Preferences",stepRes:"Result",
  cmpCheaper:"cheaper",cmpExpensive:"more expensive",cmpSame:"the same",cmpExplTitle:"Interpretation",
  any:"Any",btnCopy2:"Copy",missingDataCmp:"Complete province, m¬≤ and bathrooms (min 1).",
  yrs:"years",beds:"bed(s)",baths:"bath(s)",noExtras:"No extras",
  safeCapacity:"Safe capacity",buyLabel:"BUY",rentLabel:"RENT",
  strictLabel:"strict",flexLabel:"flex",
  selectedLabel:"Selected:",noneLabel:"none",activeLabel:"Active:",noSelection:"No selection",
  diffLabel:"Difference",priceInProv:"Price in province",priceInZone:"Price in your area",
  rentInProv:"Rent in province",rentInZone:"Rent in your area",
  mortgageEffortLabel:"Mortgage effort",rentEffortLabel:"Rent effort",
  recLimit35:"Recommended limit: 35%",recLimit40:"Recommended limit: 40%",
  financingTitle:"Financing",prefsTitle:"Preferences",monthlyEffortTitle:"Monthly effort",
  downPaymentLabel:"Down payment",closingCostsLabel:"Closing costs",toFinanceLabel:"To finance",
  aiConnected:"AI connected",aiLocalMode:"Local engine active",aiError:"Connection error",
  aiAdvisorTitle:"Your personal financial advisor.",
  aiAdvisorDesc:"Uses real AI (Groq via Cloudflare Worker) ‚Äî answers any question, not just housing.",
  aiWelcome:"üëã Hello! I'm your personal financial advisor powered by real AI. I can help you with any question ‚Äî from mortgages to investments, business, technology, or anything else. What would you like to know today?",
  aiThinking:"Thinking...",aiYou:"YOU",aiPlaceholder:"Ask anything...",aiSend:"Send",
  aiPlanBtnLbl:"üß≠ Action plan",aiClearBtnLbl:"üóëÔ∏è Clear chat",aiCopyBtnLbl:"üìã Copy chat",
  aiSug1:"How to improve my situation?",aiSug2:"How much to save for buying?",
  aiSug3:"Buy or rent?",aiSug4:"Which municipality do you recommend?",
  aiSug5:"What if rates rise?",aiSug6:"Buying strategies"
}
};

let LANG=localStorage.getItem(LANG_KEY)||"ES";
const t=k=>(I18N[LANG]&&I18N[LANG][k])||I18N.ES[k]||k;
const tpl=(s,v)=>String(s||"").replace(/\{(\w+)\}/g,(_,k)=>(v&&v[k]!=null)?v[k]:"");
const fmtMoney=n=>!isFinite(n)?"‚Äì":((LANG==="EN"?fmtEN(n):fmtES(n))+" ‚Ç¨");

/* =====================
   GROQ AI VIA WORKER
   ===================== */
// IMPORTANTE: Reemplaza esta URL con la de tu Cloudflare Worker
const AI_PROXY_URL="https://soft-poetry-232f.hibanezborreguero.workers.dev/";

// Llamar a Groq v√≠a Worker
const callGroqViaWorker = async (messages, opts = {}) => {
  try {
    const res = await fetch(AI_PROXY_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        temperature: typeof opts.temperature === "number" ? opts.temperature : 0.4,
        max_tokens: typeof opts.max_tokens === "number" ? opts.max_tokens : 900,
        messages
      })
    });

    if (!res.ok) {
      const t = await res.text();
      console.error("Worker HTTP error:", res.status, t);
      return null;
    }

    const data = await res.json();
    return (data?.choices?.[0]?.message?.content || "").trim() || null;
  } catch (e) {
    console.error("Worker fetch failed:", e);
    return null;
  }
};

// Construir prompt para LLM con contexto (robusto, sin romper si falta algo)
const buildLLMPrompt = (userMsg) => {
  let ctx = null;

  // 1) Intentar obtener contexto si existe calcContext()
  try {
    if (typeof calcContext === "function") ctx = calcContext();
  } catch (e) {
    console.warn("calcContext failed:", e);
    ctx = null;
  }

  // 2) Construir "systemContext" sin petar aunque falten campos
  let systemContext = "";
  if (ctx && typeof ctx === "object") {
    const nm = ctx.nm ?? "An√≥nimo";
    const ag = (ctx.ag ?? "?");
    const inc = (ctx.inc ?? null);
    const sav = (ctx.sav ?? null);
    const muni = ctx.muni ?? "no especificado";
    const pb = (ctx.pb ?? null);
    const pay = (ctx.pay ?? null);
    const ratio = (ctx.ratio ?? null);
    const rec = ctx.rec ?? "pendiente de an√°lisis";

    systemContext =
`Usuario: ${nm}, ${ag} a√±os
Ingresos: ${inc!=null?fmtMoney(inc)+"/mes":"no especificado"}
Ahorros: ${sav!=null?fmtMoney(sav):"no especificado"}
Municipio: ${muni}
Precio objetivo: ${pb!=null?fmtMoney(pb):"no especificado"}
Cuota hipoteca: ${pay!=null?fmtMoney(pay)+"/mes":"no calculado"}
Esfuerzo: ${ratio!=null?(ratio*100).toFixed(1)+"%":"no calculado"}
Recomendaci√≥n: ${rec}`;
  }

  // 3) Prompt final
  return [
    "Eres un asesor inmobiliario/financiero en Espa√±a (Baix Pened√®s).",
    "Da recomendaciones concretas con pasos y motivos. No repitas literalmente los datos del usuario; √∫salos para razonar.",
    systemContext ? ("Datos del usuario:\n" + systemContext) : "",
    "Pregunta del usuario:\n" + userMsg
  ].filter(Boolean).join("\n\n");
};

const fmtPct=n=>Number(n).toFixed(1)+"%";
const toast=m=>{const e=Q("#ts");e.textContent=m;e.classList.add("s");setTimeout(()=>e.classList.remove("s"),1900)};

const applyI18n=()=>{
  QA("[data-i]").forEach(el=>{const v=t(el.getAttribute("data-i"));if(v)el.textContent=v;});
  // Tooltips ‚Äî se regeneran al cambiar idioma
  const tipMap={tipIncBox:"tipInc",tipSavBox:"tipSav",tipMsvBox:"tipMsv"};
  Object.entries(tipMap).forEach(([id,key])=>{const el=Q("#"+id);if(el)el.textContent=t(key);});
  // Chat
  const wb=Q("#welcome-bubble");if(wb&&!wb.dataset.set)wb.textContent=t("aiWelcome");
  const ci=Q("#chatInput");if(ci)ci.placeholder=t("aiPlaceholder");
  renderAISuggestions();
  renderAIContext();
};

const setLang=l=>{
  LANG=l;localStorage.setItem(LANG_KEY,l);
  document.documentElement.lang=l==="CA"?"ca":l==="ES"?"es":"en";
  Q("#L_CA").classList.toggle("a",l==="CA");
  Q("#L_ES").classList.toggle("a",l==="ES");
  Q("#L_EN").classList.toggle("a",l==="EN");
  applyI18n();renderZoneUI();renderResult();refreshExamplesUI();
  updateSteps(Q("[data-p][style*='block']")?.getAttribute("data-p")||"p");
  liveValidate();
};

/* =====================
   PERSISTENCIA
   ===================== */
const FIELDS_NUM=["ag","inc","sav","yrs","msv","m2","bed","bat","cm2","cbd","cba"];
const FIELDS_SEL=["ar","ty","hor","fst","cm","cty"];
const FIELDS_CHK=["et","ep","el","ek","ct","cp0","cl0","ck0"];
const loadForm=()=>{try{const d=JSON.parse(localStorage.getItem(STORE_KEY)||"null");if(!d)return;FIELDS_NUM.forEach(id=>{if(d[id]!=null&&Q("#"+id))Q("#"+id).value=d[id];});FIELDS_SEL.forEach(id=>{if(d[id]!=null&&Q("#"+id))Q("#"+id).value=d[id];});FIELDS_CHK.forEach(id=>{if(Q("#"+id)&&d[id]!=null)Q("#"+id).checked=!!d[id];});if(d.nm&&Q("#nm"))Q("#nm").value=d.nm;}catch(e){}};
const saveForm=()=>{try{const d={};FIELDS_NUM.forEach(id=>{if(Q("#"+id))d[id]=Q("#"+id).value;});FIELDS_SEL.forEach(id=>{if(Q("#"+id))d[id]=Q("#"+id).value;});FIELDS_CHK.forEach(id=>{if(Q("#"+id))d[id]=Q("#"+id).checked?1:0;});if(Q("#nm"))d.nm=Q("#nm").value;localStorage.setItem(STORE_KEY,JSON.stringify(d));}catch(e){}};

/* =====================
   PASOS
   ===================== */
const updateSteps=p=>{
  const m={p:1,e:2,f:3,r:4,m:4,x:4,ai:4};const cur=m[p]||1;
  [1,2,3,4].forEach(i=>{const s=Q("#stp"+i);if(!s)return;s.classList.remove("active","done");if(i<cur)s.classList.add("done");else if(i===cur)s.classList.add("active");});
  [t("stepPersonal"),t("stepEco"),t("stepPref"),t("stepRes")].forEach((l,i)=>{const el=Q("#slbl"+(i+1));if(el)el.textContent=l;});
};
const show=p=>{
  QA("[data-p]").forEach(x=>x.style.display=x.getAttribute("data-p")===p?"block":"none");
  ["p","e","f","r","m","x","ai"].forEach(k=>Q("#t_"+k)?.classList.toggle("a",p===k));
  updateSteps(p);
  if(p==="m")setTimeout(upMap,100);
  if(p==="x")refreshExamplesUI();
  if(p==="ai")setTimeout(initChatUI,100);
  window.scrollTo({top:0,behavior:"smooth"});
};

/* =====================
   C√ÅLCULOS
   ===================== */
const mort=(c,r,y)=>{const m=r/12,n=y*12;return r===0?c/n:c*(m*Math.pow(1+m,n))/(Math.pow(1+m,n)-1);};
const COEF={"Cunit":{c:1.157,r:.975},"El Vendrell":{c:.912,r:.842},"Calafell":{c:.856,r:.983},"Santa Oliva":{c:.783,r:.825},"Bellvei":{c:.783,r:.925},"L'Arbo√ß":{c:.735,r:.883},"Banyeres del Pened√®s":{c:.614,r:.783},"Albinyana":{c:.766,r:.825},"Bonastre":{c:.497,r:.683},"Maslloren√ß":{c:.549,r:.75},"La Bisbal del Pened√®s":{c:.623,r:.808},"Lloren√ß del Pened√®s":{c:.856,r:.65},"Sant Jaume dels Domenys":{c:.614,r:.65},"El Montmell":{c:.529,r:.675}};
const BASE={m2:2000,rent:10,close:.11,rate:.0299};
const M={"Barcelona":{v:2986,l:21.9},"Girona":{v:2608,l:14.99},"Lleida":{v:1486,l:9.5},"Tarragona":{v:2100,l:13.5}};
const xBuy=(base,e)=>{let x=0;if(e.t)x+=base*.05;if(e.p)x+=base*.08;if(e.l)x+=base*.04;if(e.k)x+=base*.03;return x;};
const xRent=(base,e)=>{let x=0;if(e.t)x+=base*.15;if(e.p)x+=base*.30;if(e.l)x+=base*.08;if(e.k)x+=base*.07;return x;};
const buy=(a,m2,b,ba,e)=>{const base=m2*BASE.m2*(COEF[a]?.c||1),adj=b*5e3+ba*3e3;return Math.round(base+adj+xBuy(base,e));};
const rent=(a,m2,b,ba,e)=>{const base=m2*BASE.rent*(COEF[a]?.r||1),adj=b*50+ba*30;return Math.round(base+adj+xRent(base,e));};
const buyM=(m,m2,b,ba,e)=>{const p=M[m];if(!p)return NaN;const base=m2*p.v,adj=b*5e3+ba*3e3;return Math.round(base+adj+xBuy(base,e));};
const rentM=(m,m2,b,ba,e)=>{const p=M[m];if(!p)return NaN;const base=m2*p.l,adj=b*50+ba*30;return Math.round(base+adj+xRent(base,e));};

let last=null,lastReq=null,lastReqSig="";
const reqFromUI=()=>({muni:Q("#ar").value,type:Q("#ty").value,m2:+Q("#m2").value||null,bed:Q("#bed").value===""?null:+Q("#bed").value,bath:+Q("#bat").value||null,ex:{t:Q("#et").checked?1:0,p:Q("#ep").checked?1:0,l:Q("#el").checked?1:0,k:Q("#ek").checked?1:0}});
const sigOfReq=r=>[r.muni,r.type,r.m2,r.bed,r.bath,r.ex.t,r.ex.p,r.ex.l,r.ex.k].join("|");
const prefsChanged=()=>!lastReq||sigOfReq(reqFromUI())!==lastReqSig;
const setTabsEnabled=()=>["#t_r","#t_m","#t_x","#t_ai"].forEach(id=>Q(id)?.classList.toggle("dis",!lastReq));
const typeLabel=ty=>ty==="flat"?t("optFlat"):t("optHouse");
const muniLabel=muni=>{if(muni==="*")return t("any");if(muni==="__multi__")return[...zoneSel].join(", ");return muni;};

/* =====================
   CANVAS CHARTS
   ===================== */
const dpr=()=>window.devicePixelRatio||1;
const setupCanvas=cv=>{const r=dpr(),rect=cv.getBoundingClientRect();cv.width=Math.max(320,Math.round(rect.width*r));cv.height=Math.max(220,Math.round(rect.height*r));const ctx=cv.getContext("2d");ctx.setTransform(r,0,0,r,0,0);return ctx;};
const clearGrid=(ctx,w,h)=>{ctx.clearRect(0,0,w,h);ctx.globalAlpha=1;ctx.lineWidth=1;ctx.strokeStyle="rgba(148,163,184,.12)";for(let i=0;i<6;i++){const y=14+i*(h-28)/5;ctx.beginPath();ctx.moveTo(12,y);ctx.lineTo(w-12,y);ctx.stroke();}};
const drawTxt=(ctx,txt,x,y,sz,clr,align)=>{ctx.fillStyle=clr||"#cbd5e1";ctx.font=`${sz||12}px system-ui,sans-serif`;ctx.textAlign=align||"left";ctx.fillText(txt,x,y);};

const drawEffortChart=()=>{
  if(!last)return;const cv=Q("#effChart");if(!cv)return;
  const ctx=setupCanvas(cv);const w=cv.clientWidth,h=cv.clientHeight;clearGrid(ctx,w,h);
  const safe=last.inc*.35,buyV=last.pay,rentV=last.pr,maxV=Math.max(safe,buyV,rentV)*1.15||1;
  const pL=12,pR=12,pT=18,pB=26,pW=w-pL-pR,pH=h-pT-pB;
  const ySafe=pT+pH*(1-(safe/maxV));
  ctx.strokeStyle="rgba(56,189,248,.90)";ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(pL,ySafe);ctx.lineTo(w-pR,ySafe);ctx.stroke();
  drawTxt(ctx,t("safeCapacity")+" "+fmtMoney(safe),pL+6,ySafe-6,10,"#7dd3fc","left");
  const bW=Math.min(100,pW/4);
  const bar=(x,val,lbl,fill,tc)=>{const bh=pH*(val/maxV);const y=pT+pH-bh;ctx.fillStyle=fill;ctx.globalAlpha=.92;ctx.fillRect(x,y,bW,bh);ctx.globalAlpha=1;drawTxt(ctx,lbl,x+bW/2,pT+pH+18,12,"#cbd5e1","center");drawTxt(ctx,fmtMoney(val),x+bW/2,y-6,12,tc,"center");};
  bar(pL+pW*.3-bW/2,buyV,t("buyLabel"),"rgba(34,197,94,.60)","#86efac");
  bar(pL+pW*.65-bW/2,rentV,t("rentLabel"),"rgba(245,158,11,.58)","#fde68a");
};
const drawSensChart=()=>{
  if(!last)return;const cv=Q("#sensChart");if(!cv)return;
  const ctx=setupCanvas(cv);const w=cv.clientWidth,h=cv.clientHeight;clearGrid(ctx,w,h);
  const pL=12,pR=12,pT=18,pB=26,pW=w-pL-pR,pH=h-pT-pB;
  const pts=[];for(let i=0;i<=4;i++){const r=last.rate+i*.005;pts.push({r,p:mort(last.cap,r,last.yrs)});}
  const maxP=Math.max(...pts.map(x=>x.p))*1.10||1,minP=Math.min(...pts.map(x=>x.p))*.90||0;
  drawTxt(ctx,LANG==="EN"?"Rate +0.5% steps":(LANG==="CA"?"Tipus +0,5%":"Tipo +0,5%"),pL,h-8,11,"rgba(148,163,184,.95)","left");
  ctx.strokeStyle="rgba(56,189,248,.92)";ctx.lineWidth=2;ctx.beginPath();
  pts.forEach((pt,i)=>{const x=pL+pW*(i/(pts.length-1));const y=pT+pH*(1-((pt.p-minP)/(maxP-minP||1)));if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke();
  pts.forEach((pt,i)=>{const x=pL+pW*(i/(pts.length-1));const y=pT+pH*(1-((pt.p-minP)/(maxP-minP||1)));ctx.fillStyle="rgba(125,211,252,1)";ctx.beginPath();ctx.arc(x,y,3.5,0,Math.PI*2);ctx.fill();if(i===pts.length-1)drawTxt(ctx,fmtMoney(pt.p),x-4,y-10,12,"#7dd3fc","right");});
  const delta=pts[pts.length-1].p-pts[0].p;drawTxt(ctx,(delta>=0?"+":"")+fmtMoney(delta)+" @ +2%",w-12,h-8,12,"#fde68a","right");
};
const drawCmpChart=(your,prov)=>{
  const cv=Q("#cmpChart");if(!cv)return;
  const ctx=setupCanvas(cv);const w=cv.clientWidth,h=cv.clientHeight;clearGrid(ctx,w,h);
  const pL=12,pR=12,pT=18,pB=26,pW=w-pL-pR,pH=h-pT-pB,maxV=Math.max(your,prov)*1.15||1;
  const bW=Math.min(140,pW/3);
  const bar=(x,val,lbl,fill,tc)=>{const bh=pH*(val/maxV);const y=pT+pH-bh;ctx.fillStyle=fill;ctx.globalAlpha=.92;ctx.fillRect(x,y,bW,bh);ctx.globalAlpha=1;drawTxt(ctx,lbl,x+bW/2,pT+pH+18,12,"#cbd5e1","center");drawTxt(ctx,fmtMoney(val),x+bW/2,y-6,12,tc,"center");};
  const yourLbl=LANG==="EN"?"Your area":(LANG==="CA"?"La teva zona":"Tu zona");
  const provLbl=LANG==="EN"?"Province":(LANG==="CA"?"Prov√≠ncia":"Provincia");
  bar(pL+pW*.30-bW/2,your,yourLbl,"rgba(56,189,248,.45)","#7dd3fc");
  bar(pL+pW*.68-bW/2,prov,provLbl,"rgba(168,85,247,.40)","#e9d5ff");
};

/* =====================
   ANALIZAR
   ===================== */
const analyze=()=>{
  const nm=(Q("#nm").value||"").trim(),ag=+Q("#ag").value||0,inc=+Q("#inc").value||0,sav=+Q("#sav").value||0;
  const yrs=+Q("#yrs").value||25,hor=Q("#hor").value==="y",fst=Q("#fst").value==="y";
  const ar=Q("#ar").value,m2=+Q("#m2").value||0,bd=Q("#bed").value===""?0:+Q("#bed").value||0,ba=+Q("#bat").value||0,type=Q("#ty").value;
  if(!nm||ag<18||ag>100||m2<50||ba<1){toast(t("toastCheck"));return;}
  const e={t:Q("#et").checked,p:Q("#ep").checked,l:Q("#el").checked,k:Q("#ek").checked};

  let pb,pr,pbRange=null,prRange=null,muniList=[];
  if((ar==="*"||ar==="__multi__")&&zoneSel.size>1){
    muniList=[...zoneSel];
    const buys=muniList.map(m=>buy(m,m2,Math.max(0,bd),ba,e));
    const rents=muniList.map(m=>rent(m,m2,Math.max(0,bd),ba,e));
    pb=Math.round(buys.reduce((a,b)=>a+b,0)/buys.length);
    pr=Math.round(rents.reduce((a,b)=>a+b,0)/rents.length);
    pbRange={lo:Math.min(...buys),hi:Math.max(...buys)};
    prRange={lo:Math.min(...rents),hi:Math.max(...rents)};
  }else{
    const baseM=(ar==="__multi__"&&zoneSel.size===1)?[...zoneSel][0]:(ar==="*"?"Cunit":ar);
    muniList=[baseM];pb=buy(baseM,m2,Math.max(0,bd),ba,e);pr=rent(baseM,m2,Math.max(0,bd),ba,e);
  }

  const dp=fst?.1:.2,down=pb*dp,cl=pb*BASE.close,cap=Math.max(0,pb-down);
  const needCash=Math.round(down+cl);
  let rate=BASE.rate;if(sav<needCash)rate+=.006;
  const pay=mort(cap,rate,yrs);
  const ratio=inc>0?(pay/inc)*100:1e9,rri=inc>0?(pr/inc)*100:1e9;
  const need=sav<needCash,ratioOK=isFinite(ratio)&&ratio<=35,rentOK=isFinite(rri)&&rri<=40;
  const recCode=(!need&&ratioOK&&hor)?"BUY":(rentOK?"RENT":"NOT_FEASIBLE");
  const rec=recCode==="BUY"?t("recBuy"):recCode==="RENT"?t("recRent"):t("recNotFeasible");

  last={nm,muni:ar,m2,bd:Math.max(0,bd),ba,type,pb,pr,pbRange,prRange,muniList,cap,rate,yrs,dp,sav,down,cl,pay,ratio,rri,rec,recCode,e,need,hor,inc,msv:+Q("#msv").value||0,needCash,ag};
  lastReq=reqFromUI();lastReqSig=sigOfReq(lastReq);

  Q("#k1").textContent=fmtMoney(pb);Q("#k2").textContent=fmtMoney(pr);Q("#k3").textContent=fmtMoney(pay);Q("#k4").textContent=rec;
  const pm2=m2>0?Math.round(pb/m2):0;
  Q("#k1sub").textContent=pm2?(pm2.toLocaleString(LANG==="EN"?"en-US":"es-ES")+" ‚Ç¨/m¬≤"):"";
  Q("#k2sub").textContent=LANG==="EN"?"Monthly estimate":(LANG==="CA"?"Estimaci√≥ mensual":"Estimaci√≥n mensual");
  Q("#k3sub").textContent=`${yrs} ${t("yrs")} ¬∑ ${(rate*100).toFixed(2)}%`;
  Q("#k4sub").textContent=recCode==="BUY"?(LANG==="EN"?"Cash + effort OK":(LANG==="CA"?"Cash + esfor√ß OK":"Encajas cash + esfuerzo")):recCode==="RENT"?(LANG==="EN"?"Buying is tight":(LANG==="CA"?"Comprar apura":"Comprar aprieta")):(LANG==="EN"?"Neither option fits safely":(LANG==="CA"?"Cap opci√≥ encaixa de forma segura":"No encaja con seguridad"));

  renderResult();renderAIContext();renderAISuggestions();setTabsEnabled();saveForm();show("r");
  setTimeout(()=>{drawEffortChart();drawSensChart();},120);
};

/* =====================
   RENDER RESULTADO ‚Äî i18n corregido
   ===================== */
const renderResult=()=>{
  if(!last)return;
  const dti=isFinite(last.ratio)?last.ratio:999,rti=isFinite(last.rri)?last.rri:999;
  const clsDTI=dti<=30?"good":dti<=35?"warn":"bad";
  const clsRTI=rti<=35?"good":rti<=40?"warn":"bad";
  const clsCash=last.need?"bad":"good";
  const clsRate=last.rate>BASE.rate?"warn":"neu";

  Q("#rCard").style.display="block";
  Q("#rTitle").textContent=tpl(t("sumTitle"),{rec:last.rec});
  Q("#rChips").innerHTML=
    `<span class="chip ${clsDTI}">${tpl(t("chipMort"),{pct:fmtPct(dti)})}</span>`+
    `<span class="chip ${clsRTI}">${tpl(t("chipRent"),{pct:fmtPct(rti)})}</span>`+
    `<span class="chip ${clsCash}">${tpl(t("chipCash"),{eur:fmtMoney(last.needCash)})}</span>`+
    `<span class="chip ${clsRate}">${tpl(t("chipRate"),{rate:(last.rate*100).toFixed(2)+"%"})}</span>`;

  const isMulti=last.muniList&&last.muniList.length>1;
  const multiLbl=isMulti?`<div style='font-size:.72rem;color:#7dd3fc;margin-top:3px'>${tpl(t("avgZone"),{n:last.muniList.length})}</div>`:"";
  const pbRng=isMulti&&last.pbRange?`<div class='range-bar'><span class='range-tag lo'>‚Üì ${fmtMoney(last.pbRange.lo)}</span><span class='range-tag hi'>‚Üë ${fmtMoney(last.pbRange.hi)}</span></div>`:"";
  const prRng=isMulti&&last.prRange?`<div class='range-bar'><span class='range-tag lo'>‚Üì ${fmtMoney(last.prRange.lo)}</span><span class='range-tag hi'>‚Üë ${fmtMoney(last.prRange.hi)}</span></div>`:"";
  const pm2=last.m2>0?Math.round(last.pb/last.m2):0;

  Q("#rMini").innerHTML=
    `<div class="mini"><div class="h">${t("miniPrice")}</div><div class="v">${fmtMoney(last.pb)}</div>${multiLbl}${pbRng}<div style='font-size:.75rem;color:#64748b;margin-top:4px'>${pm2.toLocaleString(LANG==="EN"?"en-US":"es-ES")} ‚Ç¨/m¬≤</div></div>`+
    `<div class="mini"><div class="h">${t("miniPay")}</div><div class="v">${fmtMoney(last.pay)}</div><div style='font-size:.75rem;color:#64748b;margin-top:4px'>${last.yrs} ${t("yrs")} ¬∑ ${(last.rate*100).toFixed(2)}%</div></div>`+
    `<div class="mini"><div class="h">${t("miniRent")}</div><div class="v">${fmtMoney(last.pr)}</div>${prRng}</div>`;

  const safe=last.inc*.35;
  const why=[];
  if(last.recCode==="BUY"){
    why.push(LANG==="EN"?"Savings cover down payment + costs":(LANG==="CA"?"Estalvis cobreixen entrada + despeses":"Ahorros cubren entrada + costes"));
    why.push(LANG==="EN"?"Mortgage effort within recommended band":(LANG==="CA"?"Esfor√ß hipoteca dins la banda recomanada":"Esfuerzo hipoteca en banda recomendada"));
    if(last.hor)why.push(LANG==="EN"?"Staying >5 years amortizes costs":(LANG==="CA"?"Horitz√≥ >5 anys amortitza costos":"Horizonte >5 a√±os amortiza costes"));
  }else if(last.recCode==="RENT"){
    if(last.need)why.push((LANG==="EN"?"Short on cash":(LANG==="CA"?"Falta cash":"Falta cash"))+": "+fmtMoney(last.needCash-last.sav));
    if(dti>35)why.push((LANG==="EN"?"High mortgage effort":(LANG==="CA"?"Esfor√ß hipoteca alt":"Esfuerzo hipoteca alto"))+": "+fmtPct(dti));
    if(!last.hor)why.push(LANG==="EN"?"Short horizon: buying less efficient":(LANG==="CA"?"Horitz√≥ curt: comprar menys eficient":"Horizonte corto: comprar menos eficiente"));
    why.push(LANG==="EN"?"Renting is a safer monthly load":(LANG==="CA"?"Llogar √©s una c√†rrega mensual m√©s segura":"Alquiler es carga mensual m√°s segura"));
  }else{
    if(last.need)why.push(LANG==="EN"?"Not enough cash":(LANG==="CA"?"No hi ha prou cash":"No hay cash suficiente"));
    if(dti>35)why.push((LANG==="EN"?"Mortgage effort exceeds limit":(LANG==="CA"?"Esfor√ß hipoteca supera l√≠mit":"Esfuerzo hipoteca supera l√≠mite"))+": "+fmtPct(dti));
    if(rti>40)why.push((LANG==="EN"?"Rent effort also exceeds limit":(LANG==="CA"?"Esfor√ß lloguer supera l√≠mit":"Esfuerzo alquiler supera l√≠mite"))+": "+fmtPct(rti));
  }

  Q("#chartTips").textContent=t("safeCapacity")+" "+fmtMoney(safe)+" ¬∑ "+t("mortgageEffortLabel")+" "+fmtMoney(last.pay)+" ¬∑ "+t("rentEffortLabel")+" "+fmtMoney(last.pr);
  const blockClr=last.recCode==="BUY"?"#22c55e":last.recCode==="RENT"?"#f59e0b":"#ef4444";
  Q("#quickExplain").innerHTML=`<div style="font-weight:950;color:#e5e7eb;margin-bottom:8px">${t("cmpExplTitle")}</div><div style="display:grid;gap:6px">${why.map(x=>`<div>‚Ä¢ ${x}</div>`).join("")}</div>`;

  const muniTxt=muniLabel(last.muni),typeTxt=typeLabel(last.type),dpPct=Math.round(last.dp*100);
  const extrasOn=[];
  if(last.e.t)extrasOn.push(t("exTer"));if(last.e.p)extrasOn.push(t("exPis"));if(last.e.l)extrasOn.push(t("exAsc"));if(last.e.k)extrasOn.push(t("exGar"));
  const extrasStr=extrasOn.length?extrasOn.join(", "):t("noExtras");

  let body=`<div style='display:grid;gap:16px'>
    <div style="background:linear-gradient(135deg,rgba(56,189,248,.08),rgba(14,165,233,.05));padding:16px;border-radius:14px;border-left:4px solid ${blockClr}">
      <div style="font-size:1.05rem;font-weight:1000;color:#f1f5f9;margin-bottom:10px">${last.rec}</div>
      <div style="color:#cbd5e1;line-height:1.75;font-size:.93rem">${why.map(x=>`<div style="margin-bottom:6px">‚Ä¢ ${x}</div>`).join("")}</div>
    </div>
    <div>
      <div style="font-size:1rem;font-weight:950;color:#38bdf8;margin-bottom:8px">üìç ${t("prefsTitle")}</div>
      <div style="margin-left:18px;color:#cbd5e1;line-height:1.7">
        <div><b>${muniTxt}</b> ¬∑ ${last.m2} m¬≤ ¬∑ ${last.bd||0} ${t("beds")} ¬∑ ${last.ba} ${t("baths")} ¬∑ ${typeTxt}</div>
        <div style="color:#94a3b8;margin-top:6px">${extrasStr}</div>
      </div>
    </div>
    <div>
      <div style="font-size:1rem;font-weight:950;color:#38bdf8;margin-bottom:8px">üí∞ ${t("financingTitle")}</div>
      <div style="margin-left:18px;color:#cbd5e1;line-height:1.75">
        <div>${t("downPaymentLabel")}: ${dpPct}% ‚Üí <b>${fmtMoney(last.down)}</b></div>
        <div>${t("closingCostsLabel")}: <b>${fmtMoney(last.cl)}</b></div>
        <div>${t("toFinanceLabel")}: <b>${fmtMoney(last.cap)}</b> (${last.yrs} ${t("yrs")} @ ${(last.rate*100).toFixed(2)}%)</div>
      </div>
    </div>
    <div>
      <div style="font-size:1rem;font-weight:950;color:#38bdf8;margin-bottom:10px">üìä ${t("monthlyEffortTitle")}</div>
      <div style="display:grid;gap:14px">
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
            <span style="color:#94a3b8;font-size:.85rem;font-weight:900">${t("mortgageEffortLabel")}</span>
            <span style="font-weight:1000;color:#f1f5f9">${fmtPct(dti)} ${dti<=30?"‚úÖ":dti<=35?"‚ö†Ô∏è":"‚ùå"}</span>
          </div>
          <div class="pbar-wrap"><div class="pbar ${clsDTI}" style="width:${Math.min(100,dti).toFixed(1)}%"></div></div>
          <div style="font-size:.75rem;color:#64748b;margin-top:3px">${t("recLimit35")}</div>
        </div>
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
            <span style="color:#94a3b8;font-size:.85rem;font-weight:900">${t("rentEffortLabel")}</span>
            <span style="font-weight:1000;color:#f1f5f9">${fmtPct(rti)} ${rti<=35?"‚úÖ":rti<=40?"‚ö†Ô∏è":"‚ùå"}</span>
          </div>
          <div class="pbar-wrap"><div class="pbar ${clsRTI}" style="width:${Math.min(100,rti).toFixed(1)}%"></div></div>
          <div style="font-size:.75rem;color:#64748b;margin-top:3px">${t("recLimit40")}</div>
        </div>
      </div>
    </div>
    <div style="padding:12px 14px;background:rgba(99,102,241,.08);border:1px solid rgba(99,102,241,.25);border-radius:12px;border-left:4px solid #818cf8;color:#c7d2fe;font-size:.85rem;line-height:1.6">‚ÑπÔ∏è ${t("itpNote")}</div>`;

  if(last.need){
    const missing=Math.max(0,last.needCash-last.sav);
    if(last.msv>0&&missing>0){const mos=Math.ceil(missing/last.msv);body+=`<div class="countdown">‚è≥ ${tpl(t("yearsToSave"),{msv:fmtMoney(last.msv),yrs:(mos/12).toFixed(1),mos})}</div>`;}
    else body+=`<div class="countdown">‚ö†Ô∏è ${LANG==="EN"?"Short on cash for buying":(LANG==="CA"?"Falta cash per comprar":"Falta cash para comprar")} (${fmtMoney(missing)})</div>`;
  }else{body+=`<div class="countdown" style="background:rgba(34,197,94,.08);border-color:rgba(34,197,94,.25);border-left-color:#22c55e;color:#86efac">${t("savingsOk")}</div>`;}
  body+="</div>";
  Q("#rBody").innerHTML=body;

  Q("#rt").textContent=[
    `${last.nm},`,
    `${t("miniPrice")}: ${fmtMoney(last.pb)}`,
    `${muniTxt} ¬∑ ${last.m2}m¬≤ ¬∑ ${last.bd||0} ${t("beds")} ¬∑ ${last.ba} ${t("baths")} ¬∑ ${typeTxt}`,
    `${t("downPaymentLabel")}: ${dpPct}% (${fmtMoney(last.down)}) + ${t("closingCostsLabel")}: ${fmtMoney(last.cl)}`,
    `${t("toFinanceLabel")}: ${fmtMoney(last.cap)} ¬∑ ${last.yrs} ${t("yrs")} ¬∑ ${(last.rate*100).toFixed(2)}%`,
    `${t("miniPay")}: ${fmtMoney(last.pay)} | ${t("miniRent")}: ${fmtMoney(last.pr)}`,
    `${t("kRec")}: ${last.rec}`
  ].join("\n");

  setTimeout(()=>{drawEffortChart();drawSensChart();},70);
};

/* =====================
   MAPA COMPARADOR
   ===================== */
let cmap=null;
const PROV_COORDS={"Barcelona":[41.3874,2.1686],"Girona":[41.9794,2.8214],"Lleida":[41.6176,0.6200],"Tarragona":[41.1189,1.2445]};
const upMap=()=>{
  const m=Q("#cm").value||"Barcelona",coords=PROV_COORDS[m]||[41.3874,2.1686];
  if(!cmap){cmap=L.map("cmap").setView(coords,11);L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{maxZoom:19,attribution:"¬© OpenStreetMap ¬∑ ¬© CARTO",subdomains:"abcd"}).addTo(cmap);L.marker(coords).addTo(cmap).bindPopup(m);setTimeout(()=>cmap.invalidateSize(),200);}
  else{cmap.setView(coords,11);cmap.eachLayer(l=>{if(l instanceof L.Marker)cmap.removeLayer(l);});L.marker(coords).addTo(cmap).bindPopup(m);setTimeout(()=>cmap.invalidateSize(),120);}
};

/* =====================
   COMPARAR ‚Äî i18n corregido
   ===================== */
const compare=()=>{
  if(!last){Q("#cmg").textContent=t("toastFirst");return;}
  const m=Q("#cm").value,m2=+Q("#cm2").value||0,bd=+Q("#cbd").value||0,ba=+Q("#cba").value||0;
  const e={t:Q("#ct").checked,p:Q("#cp0").checked,l:Q("#cl0").checked,k:Q("#ck0").checked};
  if(!M[m]||!(m2>0&&ba>0)){Q("#cmg").textContent=t("missingDataCmp");Q("#cmpChips").innerHTML="";return;}
  const p2=buyM(m,m2,Math.max(0,bd),ba,e),r2=rentM(m,m2,Math.max(0,bd),ba,e);
  const d=p2-last.pb,pct=last.pb>0?(d/last.pb)*100:0;
  const cls=d>0?"bad":d<0?"good":"neu",arrow=d>0?"‚Üë":d<0?"‚Üì":"‚Üí",sign=d>0?"+":"";
  const direction=d>0?t("cmpExpensive"):d<0?t("cmpCheaper"):t("cmpSame");
  Q("#cmpChips").innerHTML=`<span class="chip ${cls}">${arrow} ${sign}${fmtMoney(d)}</span><span class="chip ${cls}">${sign}${pct.toFixed(1)}%</span><span class="chip neu">${fmtMoney(p2)}</span><span class="chip neu">${fmtMoney(r2)} /mes</span>`;
  Q("#cmg").innerHTML=`<div style="display:grid;gap:10px">
    <div><b>${m}</b> ¬∑ ${m2}m¬≤ ¬∑ ${bd} ${t("beds")} ¬∑ ${ba} ${t("baths")}</div>
    <div style="color:#cbd5e1;line-height:1.7">
      <div>‚Ä¢ ${t("priceInProv")}: <b>${fmtMoney(p2)}</b></div>
      <div>‚Ä¢ ${t("priceInZone")}: <b>${fmtMoney(last.pb)}</b></div>
      <div>‚Ä¢ ${t("diffLabel")}: <b>${sign}${fmtMoney(d)}</b> (${sign}${pct.toFixed(1)}%, ${direction})</div>
      <div>‚Ä¢ ${t("rentInProv")}: <b>${fmtMoney(r2)}</b></div>
      <div>‚Ä¢ ${t("rentInZone")}: <b>${fmtMoney(last.pr)}</b></div>
    </div>
  </div>`;
  drawCmpChart(last.pb,p2);upMap();saveForm();
};

const fillFromLast=()=>{
  if(!last){toast(t("toastFirst"));return;}
  Q("#cm2").value=last.m2||"";Q("#cbd").value=last.bd||"";Q("#cba").value=last.ba||"";Q("#cty").value=last.type||"flat";
  Q("#ct").checked=!!last.e?.t;Q("#cp0").checked=!!last.e?.p;Q("#cl0").checked=!!last.e?.l;Q("#ck0").checked=!!last.e?.k;
  saveForm();toast(t("toastCopied"));
};

/* =====================
   MAPA MUNICIPAL ‚Äî Versi√≥n mejorada
   ===================== */
let zmap=null,zReady=false,zoneSel=new Set(),polygonsByName=new Map(),labelsByName=new Map();
const loadZoneSel=()=>{try{const s=localStorage.getItem(ZONE_KEY);if(s)zoneSel=new Set(JSON.parse(s)||[]);}catch(e){}};
const saveZoneSel=()=>localStorage.setItem(ZONE_KEY,JSON.stringify([...zoneSel]));

const renderZoneUI=()=>{
  const sel=zoneSel.size?[...zoneSel].join(", "):t("noneLabel");
  Q("#zoneNote").textContent=t("selectedLabel")+" "+sel;
  Q("#zoneApplied").textContent=zoneSel.size?(t("activeLabel")+" "+[...zoneSel].join(", ")):"";
  const zc=Q("#zoneChips");
  zc.innerHTML=zoneSel.size?[...zoneSel].map(z=>`<span class="pchip on" data-z="${z}">${z} √ó</span>`).join(""):`<span class="pchip off">${t("noSelection")}</span>`;
  zc.querySelectorAll("[data-z]").forEach(ch=>ch.addEventListener("click",()=>toggleZone(ch.getAttribute("data-z"),true)));
};

const applyPolygonState=name=>{
  const poly=polygonsByName.get(name);
  if(!poly)return;
  const on=zoneSel.has(name);
  poly.setStyle({
    fillColor:on?"#38bdf8":"#22c55e",
    fillOpacity:on?0.7:0.3,
    color:on?"#0ea5e9":"#4ade80",
    weight:on?3:2,
    opacity:1
  });
  if(on)poly.bringToFront();
};

const toggleZone=(name,fromChip)=>{
  zoneSel.has(name)?zoneSel.delete(name):zoneSel.add(name);
  applyPolygonState(name);renderZoneUI();
  if(!fromChip)saveZoneSel();
};

const initMap=()=>{
  if(zReady)return;zReady=true;
  zmap=L.map("zmap",{scrollWheelZoom:false,tap:true,zoomControl:true}).setView([41.235,1.52],10);
  L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{
    maxZoom:19,
    attribution:'¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> ¬∑ ¬© <a href="https://carto.com/">CARTO</a>',
    subdomains:"abcd"
  }).addTo(zmap);

  renderZoneUI();

  MUNI_NAMES.forEach(name=>{
    const pts=FALLBACK_POLYGONS[name];
    if(!pts)return;
    const on=zoneSel.has(name);
    
    const layer=L.polygon(pts,{
      fillColor:on?"#38bdf8":"#22c55e",
      fillOpacity:on?0.7:0.3,
      color:on?"#0ea5e9":"#4ade80",
      weight:on?3:2,
      opacity:1,
      smoothFactor:0.3
    }).addTo(zmap);

    layer.bindTooltip(name,{
      permanent:false,
      direction:"top",
      offset:[0,-10],
      opacity:1,
      className:"muni-tooltip"
    });

    layer.on("mouseover",function(){
      if(!zoneSel.has(name)){
        this.setStyle({fillOpacity:0.55,weight:3});
      }
      this.openTooltip();
    });
    
    layer.on("mouseout",function(){
      if(!zoneSel.has(name)){
        this.setStyle({fillOpacity:0.3,weight:2});
      }
      this.closeTooltip();
    });

    layer.on("click",()=>toggleZone(name,false));
    polygonsByName.set(name,layer);

    const ctr=MUNI_CENTROIDS[name];
    if(ctr){
      const fs=name.length>18?"7px":name.length>14?"8px":"9px";
      const lbl=L.marker(ctr,{
        icon:L.divIcon({
          className:"muni-label",
          html:`<span style="font-size:${fs};font-weight:900;text-shadow:0 2px 6px rgba(0,0,0,1),0 0 15px rgba(0,0,0,0.9);color:#fff;">${name}</span>`,
          iconSize:[150,26],
          iconAnchor:[75,13]
        }),
        interactive:false,
        zIndexOffset:1000
      }).addTo(zmap);
      labelsByName.set(name,lbl);
    }
  });

  setTimeout(()=>{
    try{
      const allLayers=[...polygonsByName.values()];
      if(allLayers.length){
        const group=L.featureGroup(allLayers);
        zmap.fitBounds(group.getBounds(),{padding:[40,40],maxZoom:10.5});
      }
    }catch(e){}
    zmap.invalidateSize();
  },300);

  const mapEl=Q("#zmap");
  if(mapEl&&window.ResizeObserver){
    new ResizeObserver(()=>zmap?.invalidateSize()).observe(mapEl);
  }
};

// Bot√≥n "Ver todo"
const fitAllZone=()=>{
  if(!zmap)return;
  try{
    const allLayers=[...polygonsByName.values()];
    if(allLayers.length){
      const group=L.featureGroup(allLayers);
      zmap.fitBounds(group.getBounds(),{padding:[24,24]});
    }
  }catch(e){}
};

const MUNI_SLUG={"Cunit":"cunit-tarragona","El Vendrell":"el-vendrell-tarragona","Calafell":"calafell-tarragona","Santa Oliva":"santa-oliva-tarragona","Bellvei":"bellvei-tarragona","L'Arbo√ß":"l-arboc-tarragona","Banyeres del Pened√®s":"banyeres-del-penedes-tarragona","Albinyana":"albinyana-tarragona","Bonastre":"bonastre-tarragona","Maslloren√ß":"masllorenc-tarragona","La Bisbal del Pened√®s":"la-bisbal-del-penedes-tarragona","Lloren√ß del Pened√®s":"llorenc-del-penedes-tarragona","Sant Jaume dels Domenys":"sant-jaume-dels-domenys-tarragona","El Montmell":"el-montmell-tarragona"};
const bedSlug=n=>{n=+n||0;if(n<=0)return"estudios";if(n===1)return"de-un-dormitorio";if(n===2)return"de-dos-dormitorios";if(n===3)return"de-tres-dormitorios";return"de-cuatro-cinco-habitaciones-o-mas";};
const bathSlug=n=>{n=+n||0;if(n<=1)return"un-bano";if(n===2)return"dos-banos";return"tres-banos-o-mas";};
const m2Slugs=m2=>{m2=+m2||0;if(!(m2>0))return[];const min=Math.max(0,Math.floor((m2-20)/10)*10),max=Math.ceil((m2+20)/10)*10;return[`metros-cuadrados-mas-de_${min}`,`metros-cuadrados-menos-de_${max}`];};
const XSLUG={t:"terraza",p:"piscina",l:"ascensor",k:"garaje"};

const buildUrl=(mode,strict,muniOverride)=>{
  if(!lastReq)return null;
  const req=lastReq,muni=muniOverride||req.muni;
  const area=(muni==="*"||muni==="__multi__")?"tarragona/baix-penedes":(MUNI_SLUG[muni]||null);
  if(!area)return null;
  const op=mode==="buy"?"venta-viviendas":"alquiler-viviendas";
  const f=[...m2Slugs(req.m2),req.type==="flat"?"pisos":"chalets",bedSlug(req.bed),bathSlug(req.bath)];
  if(strict)["t","p","l","k"].forEach(k=>{if(req.ex[k]===1&&XSLUG[k])f.push(XSLUG[k]);});
  return`https://www.idealista.com/${op}/${area}/con-${f.filter(Boolean).join("%2C")}/`;
};

const openIdealista=(mode,strict,muniOverride)=>{
  if(!lastReq){toast(t("toastFirst"));return;}
  if(prefsChanged()){toast(t("toastPrefs"));return;}
  const url=buildUrl(mode,strict,muniOverride);
  if(!url){toast(t("toastNoLink"));return;}
  window.open(url,"_blank","noopener");
};

const refreshExamplesUI=()=>{
  const muniTxt=muniLabel(Q("#ar").value);
  const ok=!!lastReq&&!prefsChanged();
  Q("#xinfo").textContent=tpl(t("xInfo"),{muni:muniTxt,state:ok?t("stateReady"):t("stateNeed")});
  const wrap=Q("#xbtns");wrap.innerHTML="";
  const mkBtn=(label,fn)=>{const b=document.createElement("button");b.type="button";b.className="b ok";b.textContent=label;b.onclick=fn;if(!ok)b.classList.add("dis");wrap.appendChild(b);};
  const z=[...zoneSel].filter(x=>MUNI_SLUG[x]);
  const BL=t("buyLabel"),RL=t("rentLabel"),SL=t("strictLabel"),FL=t("flexLabel");
  if(z.length){z.forEach(m=>{mkBtn(`${BL} (${SL}) ¬∑ ${m}`,()=>openIdealista("buy",true,m));mkBtn(`${BL} (${FL}) ¬∑ ${m}`,()=>openIdealista("buy",false,m));mkBtn(`${RL} (${SL}) ¬∑ ${m}`,()=>openIdealista("rent",true,m));mkBtn(`${RL} (${FL}) ¬∑ ${m}`,()=>openIdealista("rent",false,m));});}
  else{mkBtn(`${BL} (${SL})`,()=>openIdealista("buy",true,null));mkBtn(`${BL} (${FL})`,()=>openIdealista("buy",false,null));mkBtn(`${RL} (${SL})`,()=>openIdealista("rent",true,null));mkBtn(`${RL} (${FL})`,()=>openIdealista("rent",false,null));}
  setTabsEnabled();
};

/* =====================
   AI CHAT ‚Äî Motor local completo (sin API, 100% offline)
   ===================== */
let chatHistory=[],isAIProcessing=false;

const loadChatHistory=()=>{try{const s=localStorage.getItem(CHAT_KEY);if(s)chatHistory=JSON.parse(s)||[];}catch(e){}};
const saveChatHistory=()=>{try{localStorage.setItem(CHAT_KEY,JSON.stringify(chatHistory.slice(-40)));}catch(e){}};

const setBadge=()=>{
  const badge=Q("#aiBadge"),dot=Q("#aiBadgeDot"),txt=Q("#aiBadgeTxt");
  if(!badge)return;
  badge.className="ai-badge local";
  if(dot)dot.className="dot local";
  if(txt)txt.textContent=t("aiLocalMode")||"Motor local";
};

/* ‚îÄ‚îÄ Contexto del usuario ‚îÄ‚îÄ */
const getUserContext=()=>{
  if(!last)return null;
  const extras=["t","p","l","k"].filter(k=>last.e[k]).map(k=>({t:t("exTer"),p:t("exPis"),l:t("exAsc"),k:t("exGar")}[k]||k)).join(", ")||"‚Äî";
  return{
    nm:last.nm,ag:last.ag||35,inc:last.inc,sav:last.sav,msv:last.msv||0,
    pb:last.pb,pr:last.pr,pay:last.pay,cap:last.cap,
    rate:last.rate,yrs:last.yrs,dp:Math.round(last.dp*100),
    ratio:last.ratio,rri:last.rri,rec:last.rec,recCode:last.recCode,
    need:last.need,needCash:last.needCash,hor:last.hor,
    muni:muniLabel(last.muni),m2:last.m2,bd:last.bd||0,ba:last.ba,
    type:typeLabel(last.type),extras,
    safe:Math.round(last.inc*0.35),
    missing:Math.max(0,last.needCash-last.sav),
    mosToGoal:last.msv>0?Math.ceil(Math.max(0,last.needCash-last.sav)/last.msv):null
  };
};

const renderAIContext=()=>{
  const box=Q("#aiContext");if(!box)return;
  const c=getUserContext();
  if(!c){
    box.innerHTML=`<span class="ai-context-chip warn">${LANG==="EN"?"Complete steps 1‚Äì3 for personalized answers":(LANG==="CA"?"Completa els passos 1‚Äì3 per a respostes personalitzades":"Completa los pasos 1‚Äì3 para respuestas personalizadas")}</span>`;
    return;
  }
  const gap=Math.max(0,c.needCash-c.sav);
  box.innerHTML=[
    `<span class="ai-context-chip">üéØ ${c.rec}</span>`,
    `<span class="ai-context-chip ${c.ratio>35?"warn":""}">üè¶ ${t("mortgageEffortLabel")}: ${fmtPct(c.ratio)}</span>`,
    gap>0?`<span class="ai-context-chip warn">üí∏ ${LANG==="EN"?"Gap":(LANG==="CA"?"Falta":"Falta")}: ${fmtMoney(gap)}</span>`:`<span class="ai-context-chip">‚úÖ ${LANG==="EN"?"Cash OK":(LANG==="CA"?"Cash cobert":"Cash cubierto")}</span>`
  ].join("");
};

const renderAISuggestions=()=>{
  const scs=Q("#aiSuggestions");if(!scs)return;
  scs.innerHTML=[1,2,3,4,5,6].map(i=>`<div class="suggestion-chip" data-q="${t("aiSug"+i)}">${t("aiSug"+i)}</div>`).join("");
  scs.querySelectorAll(".suggestion-chip").forEach(ch=>{
    ch.addEventListener("click",()=>{const q=ch.getAttribute("data-q");if(q&&!isAIProcessing)sendToAI(q);});
  });
};

const escapeHTML=s=>String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

const addMsg=(role,content)=>{
  const mc=Q("#chatMessages");if(!mc)return;
  const d=document.createElement("div");d.className=`chat-message ${role}`;
  const av=document.createElement("div");av.className=`chat-avatar ${role}`;av.textContent=role==="user"?t("aiYou"):"AI";
  const bub=document.createElement("div");bub.className="chat-bubble";
  bub.innerHTML=escapeHTML(content).replace(/\n/g,"<br>").replace(/\*\*(.+?)\*\*/g,"<b>$1</b>");
  if(role==="user"){d.appendChild(bub);d.appendChild(av);}else{d.appendChild(av);d.appendChild(bub);}
  mc.appendChild(d);mc.scrollTop=mc.scrollHeight;
};

const addThinking=()=>{
  const mc=Q("#chatMessages");if(!mc)return;
  const d=document.createElement("div");d.className="chat-message ai";d.id="thinking-indicator";
  const av=document.createElement("div");av.className="chat-avatar ai";av.textContent="AI";
  const bub=document.createElement("div");bub.className="chat-bubble thinking";
  bub.innerHTML=`<span class="spinner"></span>${t("aiThinking")||"..."}`;
  d.appendChild(av);d.appendChild(bub);mc.appendChild(d);mc.scrollTop=mc.scrollHeight;
};
const removeThinking=()=>{Q("#thinking-indicator")?.remove();};

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   MOTOR DE INTENCIONES ‚Äî detecta
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const normMsg=s=>s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\p{L}\p{N}\s]/gu," ").replace(/\s+/g," ").trim();
const has=(m,...kw)=>kw.some(k=>m.includes(k));

const detectIntent=msg=>{
  const m=normMsg(msg);
  // salutaciones / meta
  if(has(m,"hola","bon dia","buenos dias","buenas","hey","hi ","hello","benvingut","bona tarda"))return"greet";
  if(has(m,"gracias","gracies","thanks","thank you","genial","perfecto","guay","molt be","molt b√©","chapeau","bravo"))return"thanks";
  if(has(m,"quien eres","qui ets","que eres","what are you","com et dius","como te llamas","presentate","qui soc"))return"identity";
  if(has(m,"que puedes","que pots","what can","capacidades","funcions","funciones","ajuda","help me","com funciones","como funciones"))return"capabilities";
  if(has(m,"adios","hasta luego","bye","ciao","fins aviat","hasta pronto","fins ara"))return"bye";
  // vivienda ‚Äî decisi√≥n
  if(has(m,"comprar o alquilar","comprar o llogar","buy or rent","mejor opcion","millor opcio","que es mejor","which is better","hauria de comprar","deberia comprar"))return"buyrent";
  if(has(m,"cuota","quota","pago mensual","monthly payment","mensualitat","quanto pago"))return"payment";
  if(has(m,"hipoteca","mortgage","prestamo hipotecario","prestec","financiacion","financiament"))return"mortgage";
  if(has(m,"banco","banc","bank","entitat","prestamista","ING","CaixaBank","Sabadell","Bankinter","BBVA","Santander"))return"bank";
  if(has(m,"entrada","down payment","enganxe","inicial","anticipo","senyal","paga y se√±al"))return"downpayment";
  if(has(m,"gastos","costes","notaria","itp","impost","taxes","registro","gestoria","tasacion"))return"costs";
  if(has(m,"tipo de interes","tipus d interes","euribor","rate","tipo fijo","tipo variable","interes","interes","TAE","TIN"))return"rates";
  if(has(m,"ahorrar","estalviar","save","ahorro","estalvi","cuanto necesito","quant necessito","cuando podre","quando podre"))return"savings";
  if(has(m,"municipio","municipi","pueblo","pobl","zona","town","village","donde vivir","on viure","calafell","cunit","vendrell","bonastre","arboc","bisbal","lloren√ß","banyeres","montmell","albinyana","masllorenc","bellvei","santa oliva"))return"towns";
  if(has(m,"consejo","consell","advice","recomienda","recomana","que hago","que faig","que deberia","que hauria","que haria","que faria"))return"advice";
  if(has(m,"plan","roadmap","pasos","hoja de ruta","next steps","pla d accio","plan de accion","plan a seguir","que hago primero"))return"actionplan";
  if(has(m,"negociar","negociacio","oferta","offer","regatear","rebaja","descuento","bajar precio","bajar el precio"))return"negotiation";
  if(has(m,"estrategia","strategy","aumentar","millorar","capacitat de compra","buying power","como mejorar","com millorar","mas barato","mes barat"))return"strategy";
  if(has(m,"plazo","termini","anos","anys","years","duracion","term","cuantos anos","quants anys"))return"term";
  if(has(m,"precio","preu","price","cuanto vale","cuanto cuesta","quanto costa","valor","‚Ç¨/m","euros metro"))return"price";
  if(has(m,"alquiler","lloguer","rent","arrendar","arrendatari","inquilino"))return"rent";
  if(has(m,"riesgo","risc","risk","emergencia","seguridad","imprevisto","crash","burbuja","caer","crisis"))return"risk";
  if(has(m,"ayuda","ajuda","subvencio","subvencion","irpf","deduccion","bonificacion","habitatge assequible","hpo"))return"subsidy";
  if(has(m,"amortiz","pagar antes","pagar avans","overpay","cancelar","reducir hipoteca","pagar extra"))return"amortize";
  if(has(m,"inflacion","inflacio","inflation","ipc","poder adquisitivo","subida de precio"))return"inflation";
  if(has(m,"mercado","mercat","market","tendencia","sube","baja","previsio","futuro inmobiliario","futuro del mercado"))return"market";
  if(has(m,"resumen","resum","summary","dime todo","cuentame","conta m","analisis completo","mis datos","las cifras"))return"summary";
  if(has(m,"comparar","compare","provincia","barcelona","girona","lleida","tarragona","vs ","versus"))return"compare";
  if(has(m,"trabajo","feina","job","sueldo","salari","salary","nomina","ingresos","sou"))return"income";
  if(has(m,"primera vivienda","primera vivenda","first home","primer habitatge","primera casa"))return"firsthome";
  if(has(m,"metro","m2","metros","metres","tamano","tamany","size","superficie","cuantos metros"))return"size";
  if(has(m,"extras","piscina","pool","terraza","garaje","parking","ascensor","reforma","jard√≠n"))return"extras";
  if(has(m,"seguro","asseguranca","insurance","vida","hogar","multiriscos"))return"insurance";
  // temas generales
  if(has(m,"invertir","inversion","etf","fondo","acciones","bolsa","stocks","portfolio","broker","bono"))return"gen_investing";
  if(has(m,"presupuesto","budget","deuda","debt","finanzas personales","finances","50 30 20","regla del"))return"gen_personalfin";
  if(has(m,"python","javascript","codigo","code","programar","programacio","algoritmo","software","bug","debug","html","css","js","react","typescript","sql","api","backend","frontend"))return"gen_code";
  if(has(m,"inteligencia artificial","machine learning","ia","llm","neural","chatgpt","openai","gemini","copilot","gpt","transformer"))return"gen_ai";
  if(has(m,"empresa","startup","negocio","marketing","ventas","cliente","cashflow","ebitda","facturar","emprender"))return"gen_business";
  if(has(m,"salud","health","ejercicio","deporte","dieta","nutricion","dormir","stress","ansiedad","medicina"))return"gen_health";
  if(has(m,"historia","history","guerra","imperio","romana","medieval","siglo","antigua","revoluc"))return"gen_history";
  if(has(m,"matematica","math","estadistica","probabilidad","calculo","algebra","geometria","numero"))return"gen_math";
  if(has(m,"filosofia","etica","moral","sentido","existencial","estoicismo","platon","aristoteles","kant"))return"gen_philosophy";
  if(has(m,"idioma","ingles","frances","aleman","catala","aprender","vocabulario","grammar","traducir","translate"))return"gen_language";
  if(has(m,"vino","vi","cava","penedes","bodega","vinya","maridaje","sumiller","priorat"))return"gen_wine";
  if(has(m,"tiempo","clima","weather","llueve","sol","calor","fred","temperatura","pronostico"))return"gen_weather";
  if(has(m,"futbol","bar√ßa","barca","madrid","deportes","esports","liga","champions","tenis","basket","nba"))return"gen_sport";
  if(has(m,"receta","cocina","menjar","comida","restaurante","pizza","pasta","paella","plato"))return"gen_food";
  if(has(m,"chiste","joke","broma","gracioso","humor","rie","riure","divertido","funny"))return"gen_joke";
  if(has(m,"viaje","viatge","travel","vacacion","vacances","visitar","turismo","vuelo","hotel"))return"gen_travel";
  if(has(m,"libro","llibre","book","lectura","novela","leer","autor","literatura"))return"gen_book";
  if(has(m,"musica","m√∫sica","can√ß√≥","cancion","artista","banda","concert","spotify"))return"gen_music";
  return"general";
};

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   GENERADOR DE RESPUESTAS
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const buildReply=msg=>{
  const c=getUserContext();
  const L=LANG;
  const es=(esStr,caStr,enStr)=>L==="CA"?caStr:L==="EN"?enStr:esStr;
  const fm=n=>fmtMoney(n);
  const fp=n=>Number(n).toFixed(1)+"%";
  const norm=s=>s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  const m=norm(msg);
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // EXTRACCI√ìN DE ENTIDADES (equipos, lugares, personas, etc.)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  // EQUIPOS DE F√öTBOL
  const teams={
    'espanyol':'RCD Espanyol',
    'espa√±ol':'RCD Espanyol',
    'barca':'FC Barcelona',
    'bar√ßa':'FC Barcelona',
    'barcelona':'FC Barcelona',
    'madrid':'Real Madrid',
    'real madrid':'Real Madrid',
    'atletico':'Atl√©tico Madrid',
    'atleti':'Atl√©tico Madrid',
    'valencia':'Valencia CF',
    'sevilla':'Sevilla FC',
    'betis':'Real Betis',
    'villarreal':'Villarreal CF',
    'athletic':'Athletic Club',
    'real sociedad':'Real Sociedad',
    'girona':'Girona FC',
    'getafe':'Getafe CF',
    'mallorca':'RCD Mallorca',
    'celta':'Celta de Vigo',
    'osasuna':'CA Osasuna'
  };
  
  let detectedTeam=null;
  for(const[key,val]of Object.entries(teams)){
    if(m.includes(key)){
      detectedTeam=val;
      break;
    }
  }
  
  // MUNICIPIOS
  const municipalities=['cunit','calafell','vendrell','bellvei','santa oliva','albinyana',
                       'arboc','llorenc','banyeres','sant jaume','bisbal','bonastre',
                       'masllorenc','montmell'];
  let detectedMuni=null;
  for(const muni of municipalities){
    if(m.includes(muni)){
      detectedMuni=muni.charAt(0).toUpperCase()+muni.slice(1);
      break;
    }
  }
  
  // N√öMEROS Y CANTIDADES
  const numbers=msg.match(/\d+(?:[.,]\d+)?/g);
  const amount=numbers?parseFloat(numbers[0].replace(',','.')):null;
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // RESPUESTAS BASADAS EN ENTIDADES DETECTADAS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  // Si detect√≥ un equipo de f√∫tbol
  if(detectedTeam){
    return es(
      `‚öΩ **${detectedTeam}**\n\nSoy un asesor financiero de vivienda, no tengo acceso a datos en tiempo real de deportes.\n\nPara info actualizada del ${detectedTeam}:\n‚Ä¢ **Resultados y clasificaci√≥n:** google.com/search?q=${encodeURIComponent(detectedTeam+' resultados')}\n‚Ä¢ **Noticias:** marca.com, mundodeportivo.com, sport.es\n‚Ä¢ **Estad√≠sticas:** sofascore.com, flashscore.es\n\n¬øNecesitas ayuda con vivienda, finanzas o alg√∫n otro tema?`,
      `‚öΩ **${detectedTeam}**\n\nS√≥c assessor financer, no tinc dades en temps real d'esports.\n\nPer info del ${detectedTeam}: google.com, marca.com, mundodeportivo.com\n\n¬øNecessites ajuda amb habitatge o finances?`,
      `‚öΩ **${detectedTeam}**\n\nI'm a financial advisor, I don't have real-time sports data.\n\nFor ${detectedTeam} info: google.com, marca.com, sofascore.com\n\nNeed help with housing or finance?`
    );
  }
  
  // Si detect√≥ un municipio
  if(detectedMuni&&!c){
    return es(
      `üìç **${detectedMuni}**\n\nEs uno de los municipios del Baix Pened√®s. Para darte datos espec√≠ficos de precios, necesito que:\n\n1. Completes los pasos 1-3 (Personal, Econom√≠a, Preferencias)\n2. Selecciones ${detectedMuni} en el mapa\n3. Pulses **Analizar**\n\nEntonces podr√© decirte precios estimados, cuotas de hipoteca, y si es factible en tu caso.\n\n¬øQuieres que te explique algo sobre ${detectedMuni} en general?`,
      `üìç **${detectedMuni}**\n\n√âs un municipi del Baix Pened√®s. Completa els passos 1-3 i selecciona ${detectedMuni} per tenir dades espec√≠fiques de preus i quotes.\n\n¬øVols que t'expliqui alguna cosa sobre ${detectedMuni}?`,
      `üìç **${detectedMuni}**\n\nIt's a Baix Pened√®s municipality. Complete steps 1-3 and select ${detectedMuni} to get specific prices and payments.\n\nWant me to explain something about ${detectedMuni}?`
    );
  }
  
  // Si menciona un n√∫mero sin contexto claro
  if(amount&&amount>1000&&!c){
    return es(
      `üí∞ **${fm(amount)}**\n\nVeo que mencionas ${fm(amount)}. ¬øEs el precio de una vivienda?\n\nSi es as√≠, puedo calcular:\n‚Ä¢ Cuota de hipoteca estimada\n‚Ä¢ Entrada necesaria (20%): ${fm(amount*0.2)}\n‚Ä¢ Gastos (ITP+notar√≠a ~11%): ${fm(amount*0.11)}\n‚Ä¢ **Total cash necesario: ${fm(amount*0.31)}**\n\nPara un c√°lculo personalizado, completa los pasos 1-3 y pulsa Analizar.`,
      `üí∞ **${fm(amount)}**\n\n√âs el preu d'un habitatge?\n\nEntra–¥–∞ (20%): ${fm(amount*0.2)}\nDespeses (~11%): ${fm(amount*0.11)}\n**Total cash: ${fm(amount*0.31)}**`,
      `üí∞ **${fm(amount)}**\n\nIs that a property price?\n\nDown (20%): ${fm(amount*0.2)}\nCosts (~11%): ${fm(amount*0.11)}\n**Total cash: ${fm(amount*0.31)}**`
    );
  }
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // DETECCI√ìN DE PREGUNTAS DE SEGUIMIENTO
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const isFollowUp=/^(por\s*que|porque|perque|why|como|com|how|cuando|quan|where|donde|on|y\s+|i\s+|and\s+|pero|but|entonces|so|que\s+pasa|mas\s|mes\s|more|explica|detalla|ejemplo)/.test(m);
  
  if(isFollowUp&&chatHistory.length>1){
    const lastAI=chatHistory.slice().reverse().find(h=>h.role==="assistant")?.content||"";
    
    // ¬øPOR QU√â?
    if(/^(por\s*que|porque|perque|why)/.test(m)){
      if(/COMPRAR|BUY|comprar/i.test(lastAI)||/ALQUILAR|RENT|llogar/i.test(lastAI)){
        if(!c)return es("üí° Completa pasos 1-3 para explicarte por qu√©.","üí° Completa passos 1-3.","üí° Complete steps 1-3.");
        return es(
          c.rec==="COMPRAR"?
          `ü§î **¬øPor qu√© COMPRAR?**\n\n‚úÖ **Razones espec√≠ficas de tu caso:**\n‚Ä¢ Tu esfuerzo hipoteca: ${fp(c.ratio)} ${c.ratio<=35?"(saludable, <35%)":"(alto pero asumible)"}\n‚Ä¢ Tu cuota: ${fm(c.pay)}/mes ${c.pay<c.pr?"‚Üí MENOR que alquiler ("+fm(c.pr)+")":"‚Üí similar al alquiler"}\n‚Ä¢ Entrada: ${c.need?"Necesitas ahorrar "+fm(c.missing)+" ("+c.mosToGoal+" meses)":"YA tienes los "+fm(c.needCash)}\n‚Ä¢ Construyes patrimonio propio\n‚Ä¢ La vivienda se revaloriza (~3%/a√±o hist√≥rico)\n\n‚ö†Ô∏è **Importante:**\n‚Ä¢ Qu√©date m√≠nimo 5 a√±os (sino pierdes en gastos)\n‚Ä¢ Ten fondo emergencia ${fm(c.inc*6)} (6 meses)\n${c.ratio>40?"‚Ä¢ Tu esfuerzo es MUY alto ‚Äî asegura ingresos estables":""}`
          :
          `ü§î **¬øPor qu√© ALQUILAR en tu caso?**\n\n‚úÖ **Razones:**\n‚Ä¢ Tu esfuerzo hipoteca ser√≠a ${fp(c.ratio)} ${c.ratio>40?"(MUY alto, >40%)":"(alto, >35%)"}\n‚Ä¢ Supera el l√≠mite recomendado ‚Üí riesgo financiero\n‚Ä¢ ${c.need?"Te falta "+fm(c.missing)+" para la entrada"+(c.mosToGoal?" ("+c.mosToGoal+" meses)":""):""}\n‚Ä¢ Alquilar = flexibilidad sin compromiso 25 a√±os\n‚Ä¢ Puedes seguir ahorrando sin presi√≥n\n\nüéØ **Cu√°ndo replantear compra:**\n‚Ä¢ Ahorres ${c.need?fm(c.missing)+" m√°s":"15-20% m√°s"}\n‚Ä¢ Ingresos suban +20%\n‚Ä¢ Encuentres vivienda 15-20% m√°s barata`,
          c.rec==="COMPRAR"?`ü§î **Per qu√® COMPRAR?**\n\nEsfor√ß ${fp(c.ratio)} ${c.ratio<=35?"OK":"alt"}\nQuota ${fm(c.pay)} ${c.pay<c.pr?"< lloguer":""}\n${c.need?"Necessites "+fm(c.missing):"Cash OK"}\nPatrimoni propi`:`ü§î **Per qu√® LLOGAR?**\n\nEsfor√ß ${fp(c.ratio)} massa alt\n${c.need?"Falta "+fm(c.missing):""}\nFlexibilitat`,
          c.rec==="BUY"?`ü§î **Why BUY?**\n\nEffort ${fp(c.ratio)} ${c.ratio<=35?"OK":"high"}\nPayment ${fm(c.pay)} ${c.pay<c.pr?"< rent":""}\n${c.need?"Need "+fm(c.missing):"Cash OK"}\nBuild equity`:`ü§î **Why RENT?**\n\nEffort ${fp(c.ratio)} too high\n${c.need?"Gap "+fm(c.missing):""}\nFlexibility`
        );
      }
      
      if(/hipoteca|mortgage|prestamo|pr√©stamo/i.test(lastAI)){
        return es(
          `ü§î **¬øPor qu√© una hipoteca?**\n\n**Porque te permite comprar SIN tener todo el dinero ahora.**\n\nüìä **C√≥mo funciona:**\n\n1. **Banco presta** ‚Üí ${c?"El "+(100-c.dp)+"%":"~80%"} del precio\n2. **T√∫ devuelves** ‚Üí Capital + intereses cada mes\n3. **Garant√≠a** ‚Üí La vivienda (si no pagas, el banco se la queda)\n4. **Al final** ‚Üí Tras ${c?c.yrs:"25"} a√±os, la casa es 100% tuya\n\n‚úÖ **Ventajas:**\n‚Ä¢ Pagas ${c?fm(c.pay):"menos"} al mes (vs ahorrar todo)\n‚Ä¢ Vives en TU casa mientras pagas\n‚Ä¢ Te beneficias si sube el precio\n\n‚ùå **Desventajas:**\n‚Ä¢ Compromiso largo (${c?c.yrs:"20-30"} a√±os)\n‚Ä¢ Riesgo: si suben tipos ‚Üí cuota sube\n‚Ä¢ Necesitas entrada (${c?c.dp+"%":"15-20%"}) = ${c?fm(Math.round(c.pb*c.dp/100)):"mucho dinero"}`,
          `ü§î **Per qu√® una hipoteca?**\n\nPermet comprar sense tenir tots els diners.\n\nBanc presta ${c?(100-c.dp)+"%":"~80%"}\nTu retornes capital + interessos\nAl final (${c?c.yrs:"25"} anys) √©s teva\n\n‚úÖ Viure mentre pagues\n‚ùå Comprom√≠s llarg, risc tipus`,
          `ü§î **Why a mortgage?**\n\nLets you buy WITHOUT all the money now.\n\nBank lends ${c?(100-c.dp)+"%":"~80%"}\nYou repay principal + interest\nAfter ${c?c.yrs:"25"} years it's yours\n\n‚úÖ Live while paying\n‚ùå Long commitment, rate risk`
        );
      }
      
      if(/tipo|tae|interes|interest|rate/i.test(lastAI)){
        return es(
          `ü§î **¬øPor qu√© importa el tipo de inter√©s?**\n\n**Porque determina cu√°nto pagas DE M√ÅS al banco por prestarte el dinero.**\n\nüìä **Ejemplo ${c?"con tus datos":"real"}:**\n\n‚Ä¢ Pr√©stamo: ${c?fm(c.cap):"150.000‚Ç¨"}\n‚Ä¢ Plazo: ${c?c.yrs:"25"} a√±os\n\n**Al ${c?(c.rate*100).toFixed(2):"3.5"}%:**\n‚Üí Cuota: ${c?fm(c.pay):"1.100‚Ç¨"}/mes\n‚Üí Total pagado: ${c?fm(c.pay*c.yrs*12):"330.000‚Ç¨"}\n‚Üí De intereses: ${c?fm(c.pay*c.yrs*12-c.cap):"180.000‚Ç¨"}\n\n**Si sube a ${c?((c.rate+0.01)*100).toFixed(2):"4.5"}% (+1%):**\n‚Üí Cuota: ${c?fm(mort(c.cap,c.rate+0.01,c.yrs)):"1.230‚Ç¨"}/mes (+${c?fm(mort(c.cap,c.rate+0.01,c.yrs)-c.pay):"130‚Ç¨"})\n‚Üí Total pagado: ${c?fm(mort(c.cap,c.rate+0.01,c.yrs)*c.yrs*12):"369.000‚Ç¨"}\n‚Üí **Pagas ${c?fm((mort(c.cap,c.rate+0.01,c.yrs)-c.pay)*c.yrs*12):"39.000‚Ç¨"} M√ÅS en total**\n\nüí° **Por eso es cr√≠tico:**\n‚Ä¢ Negociar el mejor tipo posible\n‚Ä¢ Considerar hipoteca fija (sin sorpresas)\n‚Ä¢ Tener margen por si suben tipos`,
          `ü§î **Per qu√® importa el tipus?**\n\nDetermina quan pagues DE M√âS.\n\nAl ${c?(c.rate*100).toFixed(2):"3.5"}%: ${c?fm(c.pay):"1.1k‚Ç¨"}/mes\nSi +1%: ${c?fm(mort(c.cap,c.rate+0.01,c.yrs)):"1.23k‚Ç¨"}/mes\n\nTotal M√âS: ${c?fm((mort(c.cap,c.rate+0.01,c.yrs)-c.pay)*c.yrs*12):"39k‚Ç¨"}`,
          `ü§î **Why does rate matter?**\n\nDetermines how much MORE you pay.\n\nAt ${c?(c.rate*100).toFixed(2):"3.5"}%: ${c?fm(c.pay):"1.1k‚Ç¨"}/mo\nIf +1%: ${c?fm(mort(c.cap,c.rate+0.01,c.yrs)):"1.23k‚Ç¨"}/mo\n\nTotal MORE: ${c?fm((mort(c.cap,c.rate+0.01,c.yrs)-c.pay)*c.yrs*12):"39k‚Ç¨"}`
        );
      }
      
      // Respuesta gen√©rica para por qu√©
      return es(
        `ü§î **Buena pregunta "¬øpor qu√©?"**\n\nPara darte una respuesta m√°s espec√≠fica, ¬øpuedes decirme a qu√© te refieres exactamente?\n\n¬øEs sobre:\n‚Ä¢ ¬øPor qu√© comprar vs alquilar?\n‚Ä¢ ¬øPor qu√© ese precio/cuota?\n‚Ä¢ ¬øPor qu√© necesitas esa entrada?\n‚Ä¢ ¬øOtra cosa?`,
        `ü§î **Bona pregunta.**\n\nA qu√® et refereixes exactament? Comprar vs llogar? Preu? Entrada?`,
        `ü§î **Good question.**\n\nWhat specifically? Buy vs rent? Price? Down payment?`
      );
    }
    
    // ¬øC√ìMO?
    if(/^(como|com|how)/.test(m)){
      if(/ahorr|estalvi|save|ahorro/i.test(lastAI)){
        if(!c)return es(
          `üí∞ **¬øC√≥mo ahorrar?**\n\n**Plan b√°sico:**\n\n1. **Automatiza** ‚Üí Transferencia autom√°tica el d√≠a 1 del mes\n2. **Objetivo** ‚Üí 15-20% de tus ingresos netos\n3. **Reduce** ‚Üí Cancela 2-3 suscripciones que no usas\n4. **Cocina** ‚Üí Comer en casa vs restaurante = +150‚Ç¨/mes\n5. **Revisa** ‚Üí Seguros, telefon√≠a (a menudo puedes bajar 30-50‚Ç¨/mes)\n\n**Completa pasos 1-3 para un plan personalizado con fechas y objetivos.**`,
          `üí∞ **Com estalviar?**\n\n1. Automatitza transfer√®ncia dia 1\n2. Objectiu: 15-20% ingressos\n3. Cancel¬∑la subscripcions\n4. Cuina a casa\n\nCompleta passos 1-3 per pla espec√≠fic.`,
          `üí∞ **How to save?**\n\n1. Automate transfer on day 1\n2. Target: 15-20% income\n3. Cancel subscriptions\n4. Cook at home\n\nComplete steps 1-3 for specific plan.`
        );
        
        return es(
          `üí∞ **Tu plan para llegar a ${fm(c.needCash)}:**\n\nüìä **Estado actual:**\n‚Ä¢ Tienes: ${fm(c.sav)}\n‚Ä¢ Necesitas: ${fm(c.needCash)}\n‚Ä¢ **Falta: ${fm(c.missing)}**\n\nüìÖ **Cronograma:**\n‚Ä¢ Ahorro mensual: ${fm(c.msv||Math.round(c.inc*0.15))}/mes\n‚Ä¢ **Tiempo estimado: ${c.mosToGoal||"??"} meses** (${c.mosToGoal?((c.mosToGoal/12).toFixed(1)):"?"} a√±os)\n‚Ä¢ Fecha objetivo: ${c.mosToGoal?new Date(Date.now()+c.mosToGoal*30*86400000).toLocaleDateString("es-ES",{month:"long",year:"numeric"}):"--"}\n\n‚ö° **C√≥mo acelerar:**\n\n1. **D√≠a 1:** Automatiza ${fm(c.msv||Math.round(c.inc*0.15))} ‚Üí cuenta ahorro\n2. **Suscripciones:** Cancela Netflix/Spotify no usas ‚Üí +${fm(25)}/mes\n3. **Telefon√≠a:** Cambia a operador low-cost ‚Üí +${fm(20)}/mes  \n4. **Comida:** 3 cenas/semana en casa ‚Üí +${fm(120)}/mes\n5. **Seguros:** Revisa coche/hogar ‚Üí +${fm(30)}/mes\n\nüí° **Con +${fm(100)}/mes ahorras ${Math.round(c.missing/100)} meses**\n\nüéØ **Nuevo ahorro ${fm((c.msv||0)+195)}/mes ‚Üí solo ${Math.ceil(c.missing/((c.msv||0)+195))} meses**`,
          `üí∞ **Pla per ${fm(c.needCash)}:**\n\nTens: ${fm(c.sav)}\nFalta: ${fm(c.missing)}\n\nüìÖ ${fm(c.msv||Math.round(c.inc*0.15))}/mes ‚Üí ${c.mosToGoal||"??"} mesos\n\n‚ö° Accelera:\n‚Ä¢ Automatitza\n‚Ä¢ Cancel¬∑la subscripcions\n‚Ä¢ Cuina casa\n‚Ä¢ Revisa assegurances`,
          `üí∞ **Plan to ${fm(c.needCash)}:**\n\nHave: ${fm(c.sav)}\nGap: ${fm(c.missing)}\n\nüìÖ ${fm(c.msv||Math.round(c.inc*0.15))}/mo ‚Üí ${c.mosToGoal||"??"} months\n\n‚ö° Accelerate:\n‚Ä¢ Automate\n‚Ä¢ Cancel subscriptions\n‚Ä¢ Cook home\n‚Ä¢ Review insurance`
        );
      }
      
      if(/negociar|negociar|negotiate|oferta|rebajar/i.test(lastAI)){
        return es(
          `ü§ù **C√≥mo negociar el precio paso a paso:**\n\n**FASE 1: INVESTIGACI√ìN** (antes de ofertar)\n\n1. Busca 3 pisos similares en ${c?c.muni:"la zona"}\n2. Calcula ‚Ç¨/m¬≤ medio${c?" (ahora pagas: "+Math.round(c.pb/c.m2)+" ‚Ç¨/m¬≤)":""}\n3. Anota TODOS los defectos: humedades, ventanas viejas, cocina antigua, etc.\n4. Pregunta cu√°nto tiempo lleva en venta\n\n**FASE 2: ESTRATEGIA DE OFERTAS**\n\n**1¬™ Oferta: -10% a -12%**\n${c?"Precio pedido: "+fm(c.pb)+"  \n‚Üí Tu oferta: "+fm(Math.round(c.pb*0.88))+" ‚Äì "+fm(Math.round(c.pb*0.90)):""}\n"He visto que est√° X meses en venta"\n\n**2¬™ Oferta (si rechazan): -7% a -8%**\n${c?"‚Üí "+fm(Math.round(c.pb*0.92))+" ‚Äì "+fm(Math.round(c.pb*0.93)):""}\n"Las ventanas necesitan cambio (-3.000‚Ç¨)"\n"He conseguido preaprobaci√≥n solo para X"\n\n**3¬™ Oferta (final): -4% a -5%**\n${c?"‚Üí "+fm(Math.round(c.pb*0.95))+" ‚Äì "+fm(Math.round(c.pb*0.96)):""}\n"Es mi l√≠mite m√°ximo absoluto"\n"Pero puedo firmar esta semana"\n\nüí° **TRUCOS PROFESIONALES:**\n\n‚Ä¢ Negocia TODO junto: precio + fecha firma + arras\n‚Ä¢ Cada defecto = argumento de bajada\n‚Ä¢ Pide inspecci√≥n t√©cnica (asusta al vendedor)\n‚Ä¢ Si no bajan m√°s: pide garaje, muebles, electrodom√©sticos\n\nüî¥ **L√çMITE M√ÅXIMO: ${c?fm(Math.round(c.pb*(c.ratio>35?0.88:0.96))):"Tu capacidad real"}**\n\n‚ö†Ô∏è Si superas esto ‚Üí esfuerzo excesivo`,
          `ü§ù **Com negociar:**\n\n**INVESTIGACI√ì:**\n1. Busca 3 similars\n2. Calcula ‚Ç¨/m¬≤${c?" ("+Math.round(c.pb/c.m2)+")":""}\n3. Anota defectes\n\n**OFERTES:**\n‚Ä¢ 1a: -10%${c?" ‚Üí "+fm(Math.round(c.pb*0.90)):""}\n‚Ä¢ 2a: -7% ("necessita X")\n‚Ä¢ Final: -5% ("m√†xim absolut")\n\nüí° Negocia preu+data+arres junts\nüî¥ M√†xim: ${c?fm(Math.round(c.pb*0.96)):"Capacitat"}`,
          `ü§ù **How to negotiate:**\n\n**RESEARCH:**\n1. Find 3 similar\n2. Calculate ‚Ç¨/m¬≤${c?" ("+Math.round(c.pb/c.m2)+")":""}\n3. Note defects\n\n**OFFERS:**\n‚Ä¢ 1st: -10%${c?" ‚Üí "+fm(Math.round(c.pb*0.90)):""}\n‚Ä¢ 2nd: -7% ("needs X")\n‚Ä¢ Final: -5% ("absolute max")\n\nüí° Negotiate price+date+deposit together\nüî¥ Max: ${c?fm(Math.round(c.pb*0.96)):"Your capacity"}`
        );
      }
    }
    
    // ¬øCU√ÅNTO?
    if(/^(cuanto|cuant|how\s+much|quanto)/.test(m)){
      if(!c)return es(
        `üìä **Para calcular cantidades espec√≠ficas:**\n\nNecesito que completes los pasos 1-3 y pulses **Analizar**.\n\nAs√≠ podr√© darte:\n‚Ä¢ Cuota de hipoteca exacta\n‚Ä¢ Entrada necesaria\n‚Ä¢ Gastos totales\n‚Ä¢ Tiempo de ahorro\n‚Ä¢ TODO personalizado para ti`,
        `üìä Completa passos 1-3 i prem **Analitzar** per calcular quantitats espec√≠fiques.`,
        `üìä Complete steps 1-3 and press **Analyze** to calculate specific amounts.`
      );
      
      return es(
        `üìä **Todas las cantidades de tu caso:**\n\nüí∞ **VIVIENDA:**\n‚Ä¢ Precio total: ${fm(c.pb)}\n‚Ä¢ Precio por m¬≤: ${Math.round(c.pb/c.m2)} ‚Ç¨/m¬≤\n‚Ä¢ Alquiler estimado: ${fm(c.pr)}/mes\n\nüè¶ **HIPOTECA:**\n‚Ä¢ Capital prestado: ${fm(c.cap)}\n‚Ä¢ Tipo inter√©s: ${(c.rate*100).toFixed(2)}%\n‚Ä¢ Plazo: ${c.yrs} a√±os\n‚Ä¢ **Cuota mensual: ${fm(c.pay)}/mes**\n‚Ä¢ Total a pagar: ${fm(c.pay*c.yrs*12)}\n‚Ä¢ Solo en intereses: ${fm(c.pay*c.yrs*12-c.cap)}\n\nüíµ **ENTRADA Y GASTOS:**\n‚Ä¢ Entrada (${c.dp}%): ${fm(Math.round(c.pb*c.dp/100))}\n‚Ä¢ ITP (~10%): ${fm(Math.round(c.pb*0.10))}\n‚Ä¢ Notar√≠a (~0.5%): ${fm(Math.round(c.pb*0.005))}\n‚Ä¢ Registro (~0.3%): ${fm(Math.round(c.pb*0.003))}\n‚Ä¢ Gestor√≠a (~0.2%): ${fm(Math.round(c.pb*0.002))}\n‚Ä¢ **TOTAL CASH NECESARIO: ${fm(c.needCash)}**\n\nüí∞ **AHORRO:**\n‚Ä¢ Tienes actualmente: ${fm(c.sav)}\n${c.need?"‚Ä¢ **Te falta: "+fm(c.missing)+"**\n‚Ä¢ Ahorrando "+fm(c.msv)+"/mes ‚Üí "+c.mosToGoal+" meses":"‚Ä¢ ‚úÖ **Ya tienes el cash cubierto**"}\n\nüìä **ESFUERZO:**\n‚Ä¢ Hipoteca: ${fp(c.ratio)} de tus ingresos ${c.ratio<=35?"‚úÖ":"‚ö†Ô∏è"}\n‚Ä¢ Alquiler: ${fp(c.rri)} de tus ingresos\n‚Ä¢ L√≠mite recomendado: 35%`,
        `üìä **Quantitats:**\n\nüí∞ Preu: ${fm(c.pb)} (${Math.round(c.pb/c.m2)} ‚Ç¨/m¬≤)\nüí∏ Lloguer: ${fm(c.pr)}/mes\n\nüè¶ **Hipoteca:**\n‚Ä¢ Capital: ${fm(c.cap)}\n‚Ä¢ Quota: ${fm(c.pay)}/mes\n‚Ä¢ Total: ${fm(c.pay*c.yrs*12)}\n‚Ä¢ Interessos: ${fm(c.pay*c.yrs*12-c.cap)}\n\nüíµ **Entrada:**\n‚Ä¢ ${c.dp}%: ${fm(Math.round(c.pb*c.dp/100))}\n‚Ä¢ Despeses: ${fm(Math.round(c.pb*0.11))}\n‚Ä¢ **TOTAL: ${fm(c.needCash)}**\n\n${c.need?"‚ùå Falta: "+fm(c.missing)+(c.mosToGoal?" ("+c.mosToGoal+" mesos)":""):"‚úÖ Cash cobert"}`,
        `üìä **Amounts:**\n\nüí∞ Price: ${fm(c.pb)} (${Math.round(c.pb/c.m2)} ‚Ç¨/m¬≤)\nüí∏ Rent: ${fm(c.pr)}/mo\n\nüè¶ **Mortgage:**\n‚Ä¢ Principal: ${fm(c.cap)}\n‚Ä¢ Payment: ${fm(c.pay)}/mo\n‚Ä¢ Total: ${fm(c.pay*c.yrs*12)}\n‚Ä¢ Interest: ${fm(c.pay*c.yrs*12-c.cap)}\n\nüíµ **Down payment:**\n‚Ä¢ ${c.dp}%: ${fm(Math.round(c.pb*c.dp/100))}\n‚Ä¢ Costs: ${fm(Math.round(c.pb*0.11))}\n‚Ä¢ **TOTAL: ${fm(c.needCash)}**\n\n${c.need?"‚ùå Gap: "+fm(c.missing)+(c.mosToGoal?" ("+c.mosToGoal+" months)":""):"‚úÖ Cash OK"}`
      );
    }
  }
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CONTIN√öA CON DETECCI√ìN NORMAL DE INTENTS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const intent=detectIntent(msg);

  // Intents que necesitan contexto de an√°lisis
  const needsCtx=new Set(["payment","mortgage","bank","downpayment","costs","rates","savings","advice","actionplan","negotiation","strategy","term","price","rent","risk","subsidy","amortize","inflation","market","summary","compare","income","firsthome","size","extras","buyrent","towns","insurance"]);
  if(!c&&needsCtx.has(intent)){
    return es(
      `üí° Para responderte de forma personalizada sobre **esto**, completa primero los pasos 1‚Äì3 (Personal, Econom√≠a, Preferencias) y pulsa **Analizar**.\n\nMientras tanto puedo ayudarte con preguntas generales de finanzas, tecnolog√≠a, o cualquier otra cosa.`,
      `üí° Per donar-te una resposta personalitzada sobre **aix√≥**, completa primer els passos 1‚Äì3 i prem **Analitzar**.\n\nMentrestant et puc ajudar amb preguntes generals.`,
      `üí° For a personalized answer, complete steps 1‚Äì3 first and press **Analyze**.\n\nMeanwhile I can answer general finance, tech or any other questions.`
    );
  }

  switch(intent){

  /* ‚îÄ‚îÄ SALUTACIONES / META ‚îÄ‚îÄ */
  case"greet":return es(
    c?`üëã ¬°Hola ${c.nm}! Tengo tu an√°lisis cargado:\nüìç **${c.muni}** ¬∑ ${c.m2}m¬≤ ¬∑ ${c.bd} hab ¬∑ ~${fm(c.pb)}\nüéØ Recomendaci√≥n actual: **${c.rec}**\n\n¬øEn qu√© puedo ayudarte?`
      :`üëã ¬°Hola! Soy el **AI Advisor** de Assessoria d'Habitatge. Funciono 100% offline.\n\nPuedo ayudarte con hipotecas, alquiler, municipios del Baix Pened√®s, finanzas personales, inversi√≥n, tecnolog√≠a... ¬°cualquier pregunta! ¬øPor d√≥nde empezamos?`,
    c?`üëã Hola ${c.nm}! Tinc la teva an√†lisi:\nüìç **${c.muni}** ¬∑ ${c.m2}m¬≤ ¬∑ ~${fm(c.pb)}\nüéØ Recomanaci√≥: **${c.rec}**\n\nEn qu√® et puc ajudar?`
      :`üëã Hola! Soc l'**AI Advisor** d'Assessoria d'Habitatge. Funciono 100% offline.\n\nPuc ajudar-te amb hipoteques, lloguer, municipis, finances, inversi√≥ o qualsevol pregunta. Per on comencem?`,
    c?`üëã Hi ${c.nm}! Your analysis is loaded:\nüìç **${c.muni}** ¬∑ ${c.m2}m¬≤ ¬∑ ~${fm(c.pb)}\nüéØ Recommendation: **${c.rec}**\n\nHow can I help?`
      :`üëã Hello! I'm the **AI Advisor** from Assessoria d'Habitatge. I work 100% offline.\n\nI can help with mortgages, rent, Baix Pened√®s towns, personal finance, investing, tech... anything! Where shall we start?`
  );

  case"thanks":return es(
    `üòä ¬°De nada${c?" "+c.nm:""}! Aqu√≠ estoy para lo que necesites.`,
    `üòä De res${c?" "+c.nm:""}! Estic aqu√≠ per al que necessitis.`,
    `üòä You're welcome${c?" "+c.nm:""}! I'm here whenever you need.`
  );

  case"identity":return es(
    `ü§ñ Soy el **AI Advisor** de Assessoria d'Habitatge.\n\nFunciono **100% offline** ‚Äî sin internet ni APIs externas. Todo el procesamiento ocurre en tu navegador.\n\nEstoy especializado en el mercado del Baix Pened√®s pero respondo sobre cualquier tema: finanzas, inversi√≥n, tecnolog√≠a, ciencia, idiomas... ¬øQu√© quieres saber?`,
    `ü§ñ Soc l'**AI Advisor** d'Assessoria d'Habitatge.\n\nFunciono **100% offline** ‚Äî sense internet ni APIs externes. Tot el processament passa al teu navegador.\n\nEspecialitzat en el Baix Pened√®s per√≤ responc sobre qualsevol tema.`,
    `ü§ñ I'm the **AI Advisor** from Assessoria d'Habitatge.\n\nI work **100% offline** ‚Äî no internet or external APIs. All processing happens in your browser.\n\nSpecialized in Baix Pened√®s real estate but I answer any topic. What would you like to know?`
  );

  case"capabilities":return es(
    `üõ†Ô∏è **Lo que puedo hacer**\n\nüè† **Vivienda (personalizado):** cuota hipoteca, entrada, comprar vs alquilar, municipios, negociaci√≥n, subvenciones, ITP, eur√≠bor, amortizaci√≥n, estrategias, plan de acci√≥n\nüí∞ **Finanzas personales:** ahorro, presupuesto, inversi√≥n, riesgo, deuda\nüíª **Tecnolog√≠a:** c√≥digo, IA, programaci√≥n, software\nüìö **General:** historia, ciencia, matem√°ticas, idiomas, negocios, viajes, cocina, humor...\n\n‚úÖ Todo funciona **100% offline**, sin conexi√≥n a internet.`,
    `üõ†Ô∏è **El que puc fer**\n\nüè† Habitatge personalitzat ¬∑ üí∞ Finances personals ¬∑ üíª Tecnologia ¬∑ üìö General\n\n‚úÖ Tot funciona **100% offline**.`,
    `üõ†Ô∏è **What I can do**\n\nüè† **Housing (personalized):** mortgage payment, down payment, buy vs rent, towns, negotiation, subsidies, amortization, strategies\nüí∞ **Personal finance:** savings, budget, investing, risk\nüíª **Tech:** code, AI, programming\nüìö **General:** history, science, math, languages, business, travel, cooking...\n\n‚úÖ All **100% offline**.`
  );

  case"bye":return es(
    `üëã ¬°Hasta pronto${c?" "+c.nm:""}! Recuerda que estoy aqu√≠ cuando quieras revisar tu situaci√≥n.`,
    `üëã Fins aviat${c?" "+c.nm:""}! Recorda que soc aqu√≠ quan vulguis.`,
    `üëã Take care${c?" "+c.nm:""}! I'll be here whenever you want to review your situation.`
  );

  /* ‚îÄ‚îÄ VIVIENDA ‚Äî an√°lisis ‚îÄ‚îÄ */
  case"summary":return es(
    `üìä **Resumen completo**\n\nüè† ${c.muni} ¬∑ ${c.m2}m¬≤ ¬∑ ${c.bd} hab ¬∑ ${c.ba} ba√±os ¬∑ ${c.type}\nüí∞ Precio: **${fm(c.pb)}** (${Math.round(c.pb/c.m2)} ‚Ç¨/m¬≤)\nüìÖ Cuota: **${fm(c.pay)}**/mes ¬∑ ${c.yrs} a√±os ¬∑ ${(c.rate*100).toFixed(2)}%\nüè† Alquiler: **${fm(c.pr)}**/mes\nüìà Esfuerzo compra: ${fp(c.ratio)} ${c.ratio<=35?"‚úÖ":"‚ùå"} | Alquiler: ${fp(c.rri)} ${c.rri<=40?"‚úÖ":"‚ùå"}\nüí∂ Cash necesario: ${fm(c.needCash)} ${c.need?"‚ùå faltan "+fm(c.missing):"‚úÖ cubierto"}\n\nüéØ **Recomendaci√≥n: ${c.rec}**`,
    `üìä **Resum complet**\n\nüè† ${c.muni} ¬∑ ${c.m2}m¬≤ ¬∑ ${c.bd} hab ¬∑ ${c.ba} banys ¬∑ ${c.type}\nüí∞ Preu: **${fm(c.pb)}** (${Math.round(c.pb/c.m2)} ‚Ç¨/m¬≤)\nüìÖ Quota: **${fm(c.pay)}**/mes ¬∑ ${c.yrs} anys ¬∑ ${(c.rate*100).toFixed(2)}%\nüè† Lloguer: **${fm(c.pr)}**/mes\nüìà Esfor√ß compra: ${fp(c.ratio)} ${c.ratio<=35?"‚úÖ":"‚ùå"} | Lloguer: ${fp(c.rri)}\nüí∂ Cash: ${fm(c.needCash)} ${c.need?"‚ùå falten "+fm(c.missing):"‚úÖ cobert"}\n\nüéØ **Recomanaci√≥: ${c.rec}**`,
    `üìä **Full summary**\n\nüè† ${c.muni} ¬∑ ${c.m2}m¬≤ ¬∑ ${c.bd} bed ¬∑ ${c.ba} bath ¬∑ ${c.type}\nüí∞ Price: **${fm(c.pb)}** (${Math.round(c.pb/c.m2)} ‚Ç¨/m¬≤)\nüìÖ Payment: **${fm(c.pay)}**/mo ¬∑ ${c.yrs} yrs ¬∑ ${(c.rate*100).toFixed(2)}%\nüè† Rent: **${fm(c.pr)}**/mo\nüìà Buy effort: ${fp(c.ratio)} ${c.ratio<=35?"‚úÖ":"‚ùå"} | Rent: ${fp(c.rri)}\nüí∂ Cash needed: ${fm(c.needCash)} ${c.need?"‚ùå short "+fm(c.missing):"‚úÖ covered"}\n\nüéØ **Recommendation: ${c.rec}**`
  );

  case"buyrent":{
    const buyOk=!c.need&&c.ratio<=35&&c.hor;
    return es(
      buyOk
        ?`üè† **En tu caso: COMPRAR tiene sentido.**\n\n‚úÖ Ahorros (${fm(c.sav)}) cubren entrada + gastos (${fm(c.needCash)})\n‚úÖ Cuota ${fm(c.pay)}/mes = ${fp(c.ratio)} de ingresos ‚Äî dentro del 35%\n‚úÖ Horizonte >5 a√±os amortiza los costes iniciales\n\nüí° El alquiler ser√≠a ${fm(c.pr)}/mes. Comprando ahorras **${fm(c.pay-c.pr>0?c.pay-c.pr:0)}/mes** en ${c.pay-c.pr>0?"coste":"ganas "+fm(c.pr-c.pay)+"/mes menos"}.`
        :c.need
          ?`üè† **Ahora mismo: ALQUILAR es la opci√≥n m√°s segura.**\n\n‚ùå Te faltan **${fm(c.missing)}** para la entrada + gastos (${fm(c.needCash)})\nüìÖ Alquilando a ${fm(c.pr)}/mes sigues ahorrando${c.mosToGoal?` ‚Äî en ~${c.mosToGoal} meses llegas al objetivo`:""}\n\nüí° Con ${fm(c.msv||300)}/mes de ahorro llegas a la entrada m√°s r√°pido.`
          :`‚ö†Ô∏è **Situaci√≥n ajustada ‚Äî valorar con cuidado.**\n\nüìä Cuota ${fm(c.pay)}/mes = **${fp(c.ratio)}** de ingresos (supera el 35%)\nüè† Alquiler ${fm(c.pr)}/mes = ${fp(c.rri)} ‚Äî m√°s manejable\nüí° Opciones: buscar a ~${fm(c.pb*0.85)} (-15%), ampliar a ${Math.min(40,c.yrs+5)} a√±os o esperar a m√°s ahorros.`,
      buyOk
        ?`üè† **Al teu cas: COMPRAR t√© sentit.**\n\n‚úÖ Estalvis (${fm(c.sav)}) cobreixen entrada + despeses (${fm(c.needCash)})\n‚úÖ Quota ${fm(c.pay)}/mes = ${fp(c.ratio)} ‚Äî dins del 35%\n‚úÖ Horitz√≥ >5 anys amortitza els costos inicials`
        :c.need
          ?`üè† **Ara: LLOGAR √©s l'opci√≥ m√©s segura.**\n\n‚ùå Et falten **${fm(c.missing)}** per l'entrada + despeses\nüìÖ Llogant a ${fm(c.pr)}/mes pots seguir estalviant`
          :`‚ö†Ô∏è **Situaci√≥ ajustada ‚Äî valorar amb cura.**\n\nüìä Quota ${fm(c.pay)}/mes = **${fp(c.ratio)}** (supera el 35%)\nüí° Considera cercar a ~${fm(c.pb*0.85)} o ampliar a ${Math.min(40,c.yrs+5)} anys.`,
      buyOk
        ?`üè† **In your case: BUYING makes sense.**\n\n‚úÖ Savings (${fm(c.sav)}) cover down payment + costs (${fm(c.needCash)})\n‚úÖ Payment ${fm(c.pay)}/mo = ${fp(c.ratio)} of income ‚Äî within 35%\n‚úÖ 5+ year horizon amortizes purchase costs`
        :c.need
          ?`üè† **Right now: RENTING is the safer choice.**\n\n‚ùå You're **${fm(c.missing)}** short for down payment + costs\nüìÖ Renting at ${fm(c.pr)}/mo lets you keep saving${c.mosToGoal?` ‚Äî goal in ~${c.mosToGoal} months`:""}`
          :`‚ö†Ô∏è **Tight situation ‚Äî evaluate carefully.**\n\nüìä Payment ${fm(c.pay)}/mo = **${fp(c.ratio)}** of income (above 35%)\nüí° Options: find at ~${fm(c.pb*0.85)} (-15%), extend to ${Math.min(40,c.yrs+5)} years, or save more.`
    );
  }

  case"payment":return es(
    `üìÖ **Cuota hipoteca: ${fm(c.pay)}/mes**\n\nüìä Representa el **${fp(c.ratio)}** de tus ingresos netos (${fm(c.inc)})\n${c.ratio<=30?"‚úÖ Excelente ‚Äî por debajo del 30%, muy holgado":c.ratio<=35?"‚ö†Ô∏è Aceptable ‚Äî justo en el l√≠mite del 35%":"‚ùå Elevado ‚Äî supera el 35% recomendado"}\n\nüí∞ Capacidad segura (35%): ${fm(c.safe)}/mes\nCapital a financiar: ${fm(c.cap)}\nPlazo: ${c.yrs} a√±os al ${(c.rate*100).toFixed(2)}%\nTotal pagado: ~${fm(c.pay*c.yrs*12)} (intereses incluidos)`,
    `üìÖ **Quota: ${fm(c.pay)}/mes** ‚Üí ${fp(c.ratio)} dels ingressos (${fm(c.inc)})\n${c.ratio<=35?"‚ö†Ô∏è Acceptable":"‚ùå Elevat ‚Äî supera el 35%"}\n\nCapacitat segura (35%): ${fm(c.safe)}/mes ¬∑ Total pagat: ~${fm(c.pay*c.yrs*12)}`,
    `üìÖ **Mortgage payment: ${fm(c.pay)}/mo**\n\nüìä That's **${fp(c.ratio)}** of your income (${fm(c.inc)})\n${c.ratio<=30?"‚úÖ Excellent ‚Äî under 30%, very comfortable":c.ratio<=35?"‚ö†Ô∏è Acceptable ‚Äî right at the 35% limit":"‚ùå High ‚Äî above recommended 35%"}\n\nSafe capacity (35%): ${fm(c.safe)}/mo ¬∑ Total paid: ~${fm(c.pay*c.yrs*12)}`
  );

  case"mortgage":return es(
    `üè¶ **Hipoteca para ${fm(c.pb)}**\n\nüìå Entrada (${c.dp}%): ${fm(Math.round(c.pb*c.dp/100))}\nüìã ITP + gastos (~11%): ${fm(Math.round(c.pb*.11))}\nüí∂ **Cash total necesario: ${fm(c.needCash)}**\n\n${c.need?"‚ùå Te faltan **"+fm(c.missing)+"**"+(c.mosToGoal?" ‚Äî en ~"+c.mosToGoal+" meses ahorrando "+fm(c.msv)+"/mes":""): "‚úÖ Tus ahorros ("+fm(c.sav)+") lo cubren"}\n\nCapital: ${fm(c.cap)} ¬∑ ${c.yrs} a√±os ¬∑ ${(c.rate*100).toFixed(2)}%\nCuota: **${fm(c.pay)}**/mes ¬∑ Total: ~${fm(c.pay*c.yrs*12)}\n\nüí° Tip: el banco exige ~24 meses de antig√ºedad laboral + historial limpio.`,
    `üè¶ **Hipoteca per ${fm(c.pb)}**\n\nEntrada (${c.dp}%): ${fm(Math.round(c.pb*c.dp/100))} + ITP+notaria (~11%): ${fm(Math.round(c.pb*.11))}\nüí∂ **Cash total: ${fm(c.needCash)}**\n\n${c.need?"‚ùå Falten "+fm(c.missing):"‚úÖ Estalvis cobreixen ("+fm(c.sav)+")"}\n\nCapital: ${fm(c.cap)} ¬∑ ${c.yrs} anys ¬∑ ${(c.rate*100).toFixed(2)}% ¬∑ Quota: **${fm(c.pay)}**/mes`,
    `üè¶ **Mortgage for ${fm(c.pb)}**\n\nDown payment (${c.dp}%): ${fm(Math.round(c.pb*c.dp/100))} + Tax+fees (~11%): ${fm(Math.round(c.pb*.11))}\nüí∂ **Total cash needed: ${fm(c.needCash)}**\n\n${c.need?"‚ùå Short **"+fm(c.missing)+"**"+(c.mosToGoal?" ‚Äî ~"+c.mosToGoal+" months at "+fm(c.msv)+"/mo":""):"‚úÖ Savings ("+fm(c.sav)+") cover it"}\n\nPrincipal: ${fm(c.cap)} ¬∑ ${c.yrs} yrs ¬∑ ${(c.rate*100).toFixed(2)}% ¬∑ Payment: **${fm(c.pay)}**/mo`
  );

  case"bank":return es(
    `üè¶ **Comparar bancos ‚Äî qu√© mirar**\n\nüìä **TIN vs TAE:** pide siempre el TAE, que incluye todos los costes\nüìã **Vinculaciones:** n√≥mina domiciliada + seguros pueden compensar si bajan el tipo >0.25%\nüîí **Tipo fijo vs variable:** con tipos actuales (~${(c.rate*100).toFixed(2)}%), el fijo da seguridad\nüí° **Proceso recomendado:**\n1. Pide preaprobaci√≥n en 3 bancos (sin coste)\n2. Negocia con las 3 ofertas en la mano\n3. Compara: cuota, TAE, vinculaciones, comisi√≥n amortizaci√≥n anticipada\n\n‚ö° Bancos competitivos en Catalunya: CaixaBank, Sabadell, ING, Bankinter, Kutxabank.`,
    `üè¶ **Comparar bancs**\n\nüìä Demana sempre el TAE, no el TIN\nüîí Tipus fix vs variable: amb tipus actuals (~${(c.rate*100).toFixed(2)}%), el fix d√≥na seguretat\nüí° Sol¬∑licita preaprovaci√≥ en 3 bancs, negocia amb les 3 ofertes.`,
    `üè¶ **Comparing banks ‚Äî what to look for**\n\nüìä **APR not just rate:** always compare APR, which includes all costs\nüîí **Fixed vs variable:** at current rates (~${(c.rate*100).toFixed(2)}%), fixed gives stability\nüí° **Process:** get pre-approval from 3 banks, then negotiate with all 3 offers in hand.`
  );

  case"downpayment":return es(
    `üí∞ **Desglose de la entrada**\n\nPrecio: ${fm(c.pb)}\nüìå Entrada (${c.dp}%): ${fm(Math.round(c.pb*c.dp/100))}\nüìã ITP (~10%): ${fm(Math.round(c.pb*.10))}\nüìù Notar√≠a + registro (~1%): ${fm(Math.round(c.pb*.01))}\nüí∂ **Cash total: ${fm(c.needCash)}**\n\n${c.need?"‚ùå Faltan **"+fm(c.missing)+"**"+(c.mosToGoal?" (~"+c.mosToGoal+" meses ahorrando "+fm(c.msv)+"/mes)":""):"‚úÖ Ahorros suficientes ("+fm(c.sav)+")"}\n\nüí° Primera vivienda: entrada m√≠nima al 10% ‚Üí necesitar√≠as solo ${fm(Math.round(c.pb*.10+c.pb*.11))}`,
    `üí∞ **Entrada**\n\nPreu: ${fm(c.pb)} ¬∑ Entrada (${c.dp}%): ${fm(Math.round(c.pb*c.dp/100))} ¬∑ ITP+notaria: ${fm(Math.round(c.pb*.11))}\nüí∂ **Total: ${fm(c.needCash)}**\n\n${c.need?"‚ùå Falten "+fm(c.missing):"‚úÖ Estalvis cobreixen ("+fm(c.sav)+")"}`,
    `üí∞ **Down payment breakdown**\n\nPrice: ${fm(c.pb)} ¬∑ Down (${c.dp}%): ${fm(Math.round(c.pb*c.dp/100))} ¬∑ Tax+fees: ${fm(Math.round(c.pb*.11))}\nüí∂ **Total: ${fm(c.needCash)}**\n\n${c.need?"‚ùå Short **"+fm(c.missing)+"**"+(c.mosToGoal?" (~"+c.mosToGoal+" months at "+fm(c.msv)+"/mo)":""):"‚úÖ Savings cover it ("+fm(c.sav)+")"}`
  );

  case"costs":return es(
    `üìã **Gastos de compra en Catalunya**\n\nüèõÔ∏è ITP (primera vivenda habituals 5%, resto 10%): **${fm(Math.round(c.pb*.10))}**\nüìù Notar√≠a: ~${fm(Math.round(c.pb*.005))}\nüìë Registro propiedad: ~${fm(Math.round(c.pb*.003))}\nüè¶ Gestor√≠a + tasaci√≥n: ~${fm(Math.round(c.pb*.002))}\n\nüí∂ **Total estimado: ~${fm(Math.round(c.pb*.11))}** (11%)\n\nüí° Si es primera vivienda: ITP al 5% ‚Üí ahorras **${fm(Math.round(c.pb*.05))}**\n‚ö†Ô∏è El impuesto se paga en los 30 d√≠as posteriores a la firma ante notario.`,
    `üìã **Despeses de compra a Catalunya**\n\nITP (10% o 5% primera vivenda): **${fm(Math.round(c.pb*.10))}** ¬∑ Notaria: ~${fm(Math.round(c.pb*.005))} ¬∑ Registre: ~${fm(Math.round(c.pb*.003))}\nüí∂ **Total: ~${fm(Math.round(c.pb*.11))}**\n\nüí° Primera vivenda: ITP 5% ‚Üí estalvis **${fm(Math.round(c.pb*.05))}**`,
    `üìã **Purchase costs in Catalunya**\n\nProperty Tax (ITP, 10% or 5% first home): **${fm(Math.round(c.pb*.10))}** ¬∑ Notary: ~${fm(Math.round(c.pb*.005))} ¬∑ Registry: ~${fm(Math.round(c.pb*.003))}\nüí∂ **Total: ~${fm(Math.round(c.pb*.11))}** (11%)\n\nüí° First home: ITP 5% ‚Üí save **${fm(Math.round(c.pb*.05))}**`
  );

  case"rates":{
    const r0=c.rate;
    const deltas=[.005,.01,.015,.02];
    const rows=deltas.map(d=>{const np=mort(c.cap,r0+d,c.yrs);return `+${(d*100).toFixed(2)}% ‚Üí ${fm(np)}/mes (+${fm(np-c.pay)})`;});
    return es(
      `üìà **Sensibilidad al tipo** (actual: ${(r0*100).toFixed(2)}%)\n\n${rows.join("\n")}\n\nüí° Si el eur√≠bor sube **1%**, tu cuota aumenta ~${fm(mort(c.cap,r0+.01,c.yrs)-c.pay)}/mes.\nüîí Con hipoteca **fija** estar√≠as protegido de estas subidas.\nüìä Hipoteca mixta: tipo fijo los primeros 5-10 a√±os, luego variable.`,
      `üìà **Sensibilitat al tipus** (actual: ${(r0*100).toFixed(2)}%)\n\n${rows.join("\n")}\n\nüí° Si l'eur√≠bor puja 1%, la quota augmenta ~${fm(mort(c.cap,r0+.01,c.yrs)-c.pay)}/mes.\nüîí Hipoteca fixa = protecci√≥ garantida.`,
      `üìà **Rate sensitivity** (current: ${(r0*100).toFixed(2)}%)\n\n${rows.join("\n")}\n\nüí° If rates rise **1%**, your payment increases ~${fm(mort(c.cap,r0+.01,c.yrs)-c.pay)}/mo.\nüîí Fixed mortgage = guaranteed protection against rises.`
    );
  }

  case"savings":return es(
    c.need
      ?`üí∞ **Plan para llegar a la entrada**\n\nObjetivo: ${fm(c.needCash)} ¬∑ Tienes: ${fm(c.sav)} ¬∑ **Faltan: ${fm(c.missing)}**\n\n${c.msv>0?`üìÖ Ahorrando ${fm(c.msv)}/mes ‚Üí **~${c.mosToGoal} meses** (${(c.mosToGoal/12).toFixed(1)} a√±os)`:"‚ö†Ô∏è Introduce tu ahorro mensual en el paso 2 para calcular el plazo."}\n\nüéØ Consejos para llegar antes:\n‚Ä¢ Automatiza la transferencia el d√≠a de cobro\n‚Ä¢ Cancela suscripciones innecesarias ‚Üí +${fm(50)}/mes\n‚Ä¢ Cada ${fm(10000)} extra que pongas de entrada ‚Üí cuota baja ~${fm(mort(c.cap-10000,c.rate,c.yrs)-c.pay)}/mes`
      :`‚úÖ **¬°Buenas noticias!** Tus ahorros (${fm(c.sav)}) cubren la entrada + gastos (${fm(c.needCash)}).\n\nNo necesitas ahorrar m√°s para la compra. Prioriza:\n1. Negociar bien el precio\n2. Conseguir preaprobaci√≥n bancaria\n3. Mantener un fondo de emergencia de 6 meses (${fm(c.inc*6)})`,
    c.need
      ?`üí∞ **Pla per arribar a l'entrada**\n\nObjectiu: ${fm(c.needCash)} ¬∑ Tens: ${fm(c.sav)} ¬∑ **Falten: ${fm(c.missing)}**\n\n${c.msv>0?`üìÖ Estalviant ${fm(c.msv)}/mes ‚Üí **~${c.mosToGoal} mesos**`:"‚ö†Ô∏è Introdueix l'estalvi mensual al pas 2."}`
      :`‚úÖ **Bones not√≠cies!** Els teus estalvis (${fm(c.sav)}) cobreixen l'entrada + despeses (${fm(c.needCash)}).`,
    c.need
      ?`üí∞ **Savings plan for the down payment**\n\nTarget: ${fm(c.needCash)} ¬∑ Have: ${fm(c.sav)} ¬∑ **Gap: ${fm(c.missing)}**\n\n${c.msv>0?`üìÖ Saving ${fm(c.msv)}/mo ‚Üí **~${c.mosToGoal} months** (${(c.mosToGoal/12).toFixed(1)} years)`:"‚ö†Ô∏è Enter your monthly savings in step 2 to calculate the timeline."}`
      :`‚úÖ **Great news!** Your savings (${fm(c.sav)}) cover down payment + costs (${fm(c.needCash)}).`
  );

  case"towns":return es(
    `üìç **Municipios del Baix Pened√®s por perfil**\n\nüèñÔ∏è **Costa ‚Äî m√°s caros, mejor comunicados:**\n‚Ä¢ Cunit, Calafell, El Vendrell ‚Äî playa a 5 min, tren a BCN ~45 min\n\n‚öñÔ∏è **Equilibrio precio/servicios:**\n‚Ä¢ L'Arbo√ß, La Bisbal del Pened√®s, Lloren√ß del Pened√®s\n‚Ä¢ Banyeres del Pened√®s, Santa Oliva, Bellvei\n\nüåø **Interior ‚Äî m√°s baratos, m√°s tranquilos:**\n‚Ä¢ Bonastre, Maslloren√ß, El Montmell, Albinyana ‚Äî hasta 50% menos que la costa\n\nüí° Ahora buscas en **${c.muni}** (~${Math.round(c.pb/c.m2)} ‚Ç¨/m¬≤). En Bonastre o Maslloren√ß la misma vivienda costar√≠a ~${fm(Math.round(c.pb*0.5))}‚Äì${fm(Math.round(c.pb*0.6))}.`,
    `üìç **Municipis del Baix Pened√®s**\n\nüèñÔ∏è **Costa:** Cunit, Calafell, El Vendrell ‚Äî platja + tren a BCN ~45 min\n‚öñÔ∏è **Equilibri:** L'Arbo√ß, La Bisbal, Lloren√ß del Pened√®s, Banyeres\nüåø **Interior (m√©s barats):** Bonastre, Maslloren√ß, El Montmell ‚Äî fins 50% menys\n\nüí° Busques a **${c.muni}** (~${Math.round(c.pb/c.m2)} ‚Ç¨/m¬≤). A l'interior podria costar ~${fm(Math.round(c.pb*0.5))}‚Äì${fm(Math.round(c.pb*0.6))}.`,
    `üìç **Baix Pened√®s municipalities by profile**\n\nüèñÔ∏è **Coast ‚Äî pricier, better connected:** Cunit, Calafell, El Vendrell ‚Äî beach 5 min, train to BCN ~45 min\n‚öñÔ∏è **Balanced:** L'Arbo√ß, La Bisbal, Lloren√ß del Pened√®s, Banyeres\nüåø **Inland ‚Äî cheapest:** Bonastre, Maslloren√ß, El Montmell ‚Äî up to 50% cheaper\n\nüí° You're looking in **${c.muni}** (~${Math.round(c.pb/c.m2)} ‚Ç¨/m¬≤). Inland the same property could cost ~${fm(Math.round(c.pb*0.5))}‚Äì${fm(Math.round(c.pb*0.6))}.`
  );

  case"actionplan":return es(
    `üß≠ **Plan de acci√≥n en 90 d√≠as para ${c.nm}**\n\n**üìå Semanas 1‚Äì2: Auditor√≠a financiera**\n‚Ä¢ Lista todos los gastos fijos y variables\n‚Ä¢ Objetivo de ahorro mensual: ${fm(Math.max(c.msv||0,Math.round(c.inc*.15)))}/mes\n\n**üìå Semanas 3‚Äì4: Libera cashflow**\n‚Ä¢ Cancela 2‚Äì3 suscripciones no esenciales\n‚Ä¢ Negocia seguro del coche y hogar\n\n**üìå Semanas 5‚Äì8: Ahorro autom√°tico**\n‚Ä¢ Transferencia autom√°tica el d√≠a de cobro: ${fm(c.msv||Math.round(c.inc*.15))}/mes\n\n**üìå Semanas 9‚Äì10: Documentaci√≥n**\n‚Ä¢ √öltimas 3 n√≥minas ¬∑ Declaraci√≥n IRPF ¬∑ Vida laboral\n\n**üìå Semanas 11‚Äì12: Bancos**\n‚Ä¢ Preaprobaci√≥n en 3 bancos ¬∑ Comparar TAE real\n\n${c.need?"üéØ **Objetivo:** llegar a "+fm(c.needCash)+(c.mosToGoal?" (~"+c.mosToGoal+" meses)":""):"üéØ **Ya tienes el cash cubierto** ‚Äî prioriza negociaci√≥n"}`,
    `üß≠ **Pla d'acci√≥ 90 dies per a ${c.nm}**\n\nüìå **S1‚Äì2:** Auditoria financera ¬∑ objectiu estalvi: ${fm(Math.max(c.msv||0,Math.round(c.inc*.15)))}/mes\nüìå **S3‚Äì4:** Allibera cashflow ‚Äî cancel¬∑la subscripcions\nüìå **S5‚Äì8:** Transfer√®ncia autom√†tica ${fm(c.msv||Math.round(c.inc*.15))}/mes el dia de cobrament\nüìå **S9‚Äì10:** Documentaci√≥ banc√†ria (n√≤mines, IRPF, vida laboral)\nüìå **S11‚Äì12:** Preaprovaci√≥ en 3 bancs, comparar TAE\n\n${c.need?"üéØ Objectiu: arribar a "+fm(c.needCash)+(c.mosToGoal?" (~"+c.mosToGoal+" mesos)":""):"üéØ Ja tens el cash ‚Äî prioritza negociaci√≥"}`,
    `üß≠ **90-day action plan for ${c.nm}**\n\nüìå **Weeks 1‚Äì2:** Financial audit ¬∑ savings target: ${fm(Math.max(c.msv||0,Math.round(c.inc*.15)))}/mo\nüìå **Weeks 3‚Äì4:** Free up cashflow ‚Äî cancel non-essential subscriptions\nüìå **Weeks 5‚Äì8:** Auto-transfer ${fm(c.msv||Math.round(c.inc*.15))}/mo on payday\nüìå **Weeks 9‚Äì10:** Bank documents: payslips, tax return, work history\nüìå **Weeks 11‚Äì12:** Pre-approval from 3 banks, compare real APR\n\n${c.need?"üéØ **Goal:** reach "+fm(c.needCash)+(c.mosToGoal?" (~"+c.mosToGoal+" months)":""):"üéØ **Cash covered** ‚Äî focus on negotiation and pre-approval"}`
  );

  case"negotiation":return es(
    `ü§ù **Gu√≠a de negociaci√≥n**\n\nüìä **Precio m√°ximo que puedes pagar:** ${fm(c.pay<=c.safe?c.pb:Math.round(c.pb*(c.safe/c.pay)))}\n\n**Pasos:**\n1. Investiga 3 pisos similares en la misma zona (‚Ç¨/m¬≤ real)\n2. Empieza ofertando **8‚Äì12% por debajo** ‚Üí ${fm(Math.round(c.pb*0.90))}‚Äì${fm(Math.round(c.pb*0.92))}\n3. Negocia precio + arras + fecha firma como paquete\n4. Solicita inspecci√≥n t√©cnica ‚Äî cada defecto = argumento de bajada\n5. Si no bajan m√°s, pide: garaje, muebles, reforma o plaza de parking\n\nüî¥ **Nunca superes: ${fm(c.pb*(c.ratio>35?0.90:1))}**`,
    `ü§ù **Guia de negociaci√≥**\n\n1. Investiga 3 comparables a la zona\n2. Comen√ßa a **8‚Äì12% per sota** ‚Üí ${fm(Math.round(c.pb*0.90))}‚Äì${fm(Math.round(c.pb*0.92))}\n3. Negocia preu + arres + data com a paquet\n4. Inspecci√≥ t√®cnica = arguments de baixada\n5. Si no baixen: demana garatge, mobles o reformes\n\nüî¥ M√†xim: ${fm(c.pb*(c.ratio>35?0.90:1))}`,
    `ü§ù **Negotiation guide**\n\n1. Research 3 similar properties (real ‚Ç¨/m¬≤)\n2. Open **8‚Äì12% below** asking ‚Üí ${fm(Math.round(c.pb*0.90))}‚Äì${fm(Math.round(c.pb*0.92))}\n3. Negotiate price + deposit + closing date as a package\n4. Request inspection ‚Äî each issue is a negotiating point\n5. If they won't lower: ask for parking, furniture, or repairs\n\nüî¥ **Never exceed: ${fm(c.pb*(c.ratio>35?0.90:1))}**`
  );

  case"strategy":return es(
    `üéØ **Estrategias para mejorar tu capacidad de compra**\n\nüí∞ **M√°s entrada:** cada ${fm(10000)} extra ‚Üí cuota baja ~${fm(mort(c.cap-10000,c.rate,c.yrs)-c.pay)}/mes y menos intereses\nüìÖ **M√°s plazo:** ${Math.min(40,c.yrs+5)} a√±os ‚Üí cuota ~${fm(mort(c.cap,c.rate,Math.min(40,c.yrs+5)))}/mes (‚àí${fm(c.pay-mort(c.cap,c.rate,Math.min(40,c.yrs+5)))})\nüè† **Menor precio:** a ${fm(c.pb*0.85)} ‚Üí cuota ~${fm(mort(c.cap*0.85,c.rate,c.yrs))}/mes\nüìç **Municipio interior:** Bonastre/Maslloren√ß/Montmell ‚Üí hasta 50% m√°s barato que la costa\nüè¶ **Negociar tipo:** -0.25% ‚Üí ahorra ~${fm((c.pay*c.yrs*12)-(mort(c.cap,c.rate-.0025,c.yrs)*c.yrs*12))} en total`,
    `üéØ **Estrat√®gies per millorar la capacitat de compra**\n\nüí∞ +Entrada: cada ${fm(10000)} extra ‚Üí quota baixa ~${fm(mort(c.cap-10000,c.rate,c.yrs)-c.pay)}/mes\nüìÖ +Termini: ${Math.min(40,c.yrs+5)} anys ‚Üí quota ~${fm(mort(c.cap,c.rate,Math.min(40,c.yrs+5)))}/mes\nüè† -Preu: a ${fm(c.pb*0.85)} ‚Üí quota ~${fm(mort(c.cap*0.85,c.rate,c.yrs))}/mes\nüìç Interior: Bonastre/Maslloren√ß fins 50% menys`,
    `üéØ **Strategies to boost buying power**\n\nüí∞ **More down payment:** each ${fm(10000)} extra ‚Üí payment drops ~${fm(mort(c.cap-10000,c.rate,c.yrs)-c.pay)}/mo\nüìÖ **Longer term:** ${Math.min(40,c.yrs+5)} years ‚Üí payment ~${fm(mort(c.cap,c.rate,Math.min(40,c.yrs+5)))}/mo\nüè† **Lower price:** at ${fm(c.pb*0.85)} ‚Üí payment ~${fm(mort(c.cap*0.85,c.rate,c.yrs))}/mo\nüìç **Inland towns:** up to 50% cheaper than coast`
  );

  case"term":{
    const t1=Math.max(15,c.yrs-5),t2=Math.min(40,c.yrs+5);
    return es(
      `üìÖ **Comparativa de plazos**\n\n‚¨ÜÔ∏è ${t1} a√±os (cuota m√°s alta, menos intereses): **${fm(mort(c.cap,c.rate,t1))}**/mes\n‚ñ∂Ô∏è ${c.yrs} a√±os (actual): **${fm(c.pay)}**/mes\n‚¨áÔ∏è ${t2} a√±os (cuota m√°s baja, m√°s intereses): **${fm(mort(c.cap,c.rate,t2))}**/mes\n\nüí∂ Diferencia total pagada ${t1} vs ${t2} a√±os: ${fm((mort(c.cap,c.rate,t2)*t2*12)-(mort(c.cap,c.rate,t1)*t1*12))} m√°s intereses con plazo largo\n\nüí° Elige el plazo que te d√© **estabilidad de cashflow** ‚Äî siempre puedes amortizar antes.`,
      `üìÖ **Comparativa terminis**\n\n${t1} anys: **${fm(mort(c.cap,c.rate,t1))}**/mes ¬∑ ${c.yrs} anys (actual): **${fm(c.pay)}**/mes ¬∑ ${t2} anys: **${fm(mort(c.cap,c.rate,t2))}**/mes`,
      `üìÖ **Term comparison**\n\n${t1} years: **${fm(mort(c.cap,c.rate,t1))}**/mo ¬∑ ${c.yrs} years (current): **${fm(c.pay)}**/mo ¬∑ ${t2} years: **${fm(mort(c.cap,c.rate,t2))}**/mo\n\nüí° Choose based on **cashflow stability** ‚Äî you can always repay early.`
    );
  }

  case"amortize":return es(
    `üí° **Amortizaci√≥n anticipada ‚Äî gu√≠a**\n\nS√≠, suele valer la pena. La ley hipotecaria (2022) limita la comisi√≥n al 0%‚Äì2% seg√∫n el a√±o.\n\nüìä Si amortizas ${fm(10000)} hoy:\n‚Ä¢ Ahorras ~${fm(Math.round(10000*c.rate*c.yrs*0.5))} en intereses\n‚Ä¢ O reduces el plazo en ~${Math.round(10000/(c.cap/c.yrs)/12)} meses\n\nüéØ **Estrategia √≥ptima:** elige siempre **reducir plazo** (no cuota) ‚Äî es donde m√°s intereses te ahorras.\nüí° El momento ideal: enero, cuando el banco recalcula desde el inicio del a√±o.`,
    `üí° **Amortitzaci√≥ anticipada**\n\nAmortitzar ${fm(10000)} ara ‚Üí estalvis ~${fm(Math.round(10000*c.rate*c.yrs*0.5))} en interessos.\nüéØ Sempre redueix **termini** (no quota) ‚Äî on estalvies m√©s.`,
    `üí° **Early repayment ‚Äî guide**\n\nUsually worth it. Law caps the fee at 0%‚Äì2% depending on year.\n\nüìä Repaying ${fm(10000)} today: saves ~${fm(Math.round(10000*c.rate*c.yrs*0.5))} in interest\nüéØ **Best strategy:** always choose to **reduce term** (not payment) ‚Äî that's where you save most.`
  );

  case"price":return es(
    `üè† **Precio estimado: ${fm(c.pb)}**\n\nüìç ${c.muni} ¬∑ ${c.m2}m¬≤ ¬∑ ${c.bd} hab ¬∑ ${c.ba} ba√±os ¬∑ ${c.type}\nüìä ${Math.round(c.pb/c.m2)} ‚Ç¨/m¬≤\n\nVariaciones de precio:\n‚Ä¢ +10m¬≤ ‚Üí ~${fm(Math.round(c.pb+c.pb/c.m2*10))} | ‚àí10m¬≤ ‚Üí ~${fm(Math.round(c.pb-c.pb/c.m2*10))}\n‚Ä¢ +1 hab ‚Üí ~${fm(c.pb+5000)} | +1 ba√±o ‚Üí ~${fm(c.pb+3000)}\n\nüí° El Baix Pened√®s est√° un **40‚Äì60% por debajo** de Barcelona ciudad y un 15‚Äì25% por debajo de Tarragona capital.`,
    `üè† **Preu estimat: ${fm(c.pb)}**\n\n${c.muni} ¬∑ ${c.m2}m¬≤ ¬∑ ${Math.round(c.pb/c.m2)} ‚Ç¨/m¬≤\n\n+10m¬≤ ‚Üí ~${fm(Math.round(c.pb+c.pb/c.m2*10))} | +1 hab ‚Üí ~${fm(c.pb+5000)}\n\nüí° El Baix Pened√®s √©s un 40‚Äì60% per sota de Barcelona.`,
    `üè† **Estimated price: ${fm(c.pb)}**\n\n${c.muni} ¬∑ ${c.m2}m¬≤ ¬∑ ${Math.round(c.pb/c.m2)} ‚Ç¨/m¬≤\n\n+10m¬≤ ‚Üí ~${fm(Math.round(c.pb+c.pb/c.m2*10))} | +1 bed ‚Üí ~${fm(c.pb+5000)}\n\nüí° Baix Pened√®s is **40‚Äì60% below** Barcelona city.`
  );

  case"rent":return es(
    `üè† **Alquiler estimado: ${fm(c.pr)}/mes**\n\nüìä Eso es el **${fp(c.rri)}** de tus ingresos ${c.rri<=40?"‚úÖ":"‚ùå"} (l√≠mite recomendado: 40%)\n\nVs hipoteca: ${c.pay>c.pr?"comprar cuesta **"+fm(c.pay-c.pr)+"/mes m√°s**":"alquilar cuesta **"+fm(c.pr-c.pay)+"/mes m√°s**"}\n\nüí° **Ventajas de alquilar ahora:**\n‚Ä¢ Flexibilidad total\n‚Ä¢ Sin riesgo de tipos de inter√©s\n‚Ä¢ Puedes seguir acumulando ahorros para la entrada\n‚Ä¢ Sin costes de mantenimiento inesperados`,
    `üè† **Lloguer estimat: ${fm(c.pr)}/mes** ‚Äî ${fp(c.rri)} dels ingressos ${c.rri<=40?"‚úÖ":"‚ùå"}\n\nVs hipoteca: ${c.pay>c.pr?"comprar costa **"+fm(c.pay-c.pr)+"/mes m√©s**":"llogar costa **"+fm(c.pr-c.pay)+"/mes m√©s**"}`,
    `üè† **Estimated rent: ${fm(c.pr)}/mo** ‚Äî ${fp(c.rri)} of income ${c.rri<=40?"‚úÖ":"‚ùå"}\n\nVs mortgage: ${c.pay>c.pr?"buying costs **"+fm(c.pay-c.pr)+"/mo more**":"renting costs **"+fm(c.pr-c.pay)+"/mo more**"}`
  );

  case"risk":return es(
    `‚ö†Ô∏è **An√°lisis de riesgos**\n\n${c.ratio>35?"‚ùå Esfuerzo hipoteca **alto** ("+fp(c.ratio)+") ‚Äî si bajan ingresos o suben tipos, puede apurar":"‚úÖ Esfuerzo hipoteca OK ("+fp(c.ratio)+")"}\n${c.rate<.045?"‚ö†Ô∏è Tipo variable ‚Äî expuesto al eur√≠bor (puede subir)":""}\n${c.need?"‚ùå Sin margen de cash ‚Äî cualquier imprevisto compromete la operaci√≥n":"‚úÖ Cash cubierto ‚Äî tienes margen"}\n\nüõ°Ô∏è **C√≥mo protegerte:**\n‚Ä¢ Fondo emergencia 6 meses: ${fm(c.inc*6)}\n‚Ä¢ Hipoteca fija o mixta (5-10 a√±os fijos)\n‚Ä¢ No comprometer m√°s del 90% del ahorro en la compra\n‚Ä¢ Seguro de vida + seguro hogar vinculado a la hipoteca`,
    `‚ö†Ô∏è **An√†lisi de riscos**\n\n${c.ratio>35?"‚ùå Esfor√ß alt ("+fp(c.ratio)+")":"‚úÖ Esfor√ß OK ("+fp(c.ratio)+")"} ¬∑ ${c.need?"‚ùå Cash just":"‚úÖ Cash cobert"}\n\nüõ°Ô∏è Proteccions: fons d'emerg√®ncia ${fm(c.inc*6)} ¬∑ hipoteca fixa o mixta ¬∑ asseguran√ßa llar+vida`,
    `‚ö†Ô∏è **Risk analysis**\n\n${c.ratio>35?"‚ùå High effort ("+fp(c.ratio)+") ‚Äî vulnerable to income drops or rate rises":"‚úÖ Effort OK ("+fp(c.ratio)+")"}\n${c.need?"‚ùå Tight on cash":"‚úÖ Cash covered"}\n\nüõ°Ô∏è **Protect yourself:** Emergency fund ${fm(c.inc*6)} ¬∑ Fixed/hybrid mortgage ¬∑ Home+life insurance`
  );

  case"subsidy":return es(
    `üèõÔ∏è **Ayudas disponibles en Catalunya**\n\n‚úÖ **ITP reducido al 5%** (primera vivienda habitual) ‚Üí ahorras ${fm(Math.round(c.pb*.05))}\n‚úÖ **Deducci√≥n IRPF** auton√≥mica: hasta 1.140‚Ç¨/a√±o en la declaraci√≥n\n‚úÖ **Joves fins 35 anys** con ingresos <35.000‚Ç¨/a√±o: bonificaciones adicionales en ITP\n‚úÖ **Habitatge Assequible:** si ingresos son bajos, acceso a HPO (Habitatge de Protecci√≥ Oficial)\n\nüìû **D√≥nde consultar:**\n‚Ä¢ Ag√®ncia de l'Habitatge de Catalunya\n‚Ä¢ Ajuntament de ${c.muni}\n‚Ä¢ Consell Comarcal del Baix Pened√®s`,
    `üèõÔ∏è **Ajudes a Catalunya**\n\n‚úÖ ITP al 5% (primera vivenda) ‚Üí ${fm(Math.round(c.pb*.05))} d'estalvi\n‚úÖ Deducci√≥ IRPF fins 1.140‚Ç¨/any\n‚úÖ Joves <35 anys: bonificaci√≥ addicional\n\nüìû Ag√®ncia de l'Habitatge de Catalunya ¬∑ Ajuntament de ${c.muni}`,
    `üèõÔ∏è **Available subsidies in Catalunya**\n\n‚úÖ Reduced ITP (5% first home) ‚Üí save ${fm(Math.round(c.pb*.05))}\n‚úÖ Regional tax deduction up to 1,140‚Ç¨/year\n‚úÖ Under 35 with income <35,000‚Ç¨/year: additional bonuses\n\nüìû Ag√®ncia de l'Habitatge de Catalunya`
  );

  case"firsthome":return es(
    `üè† **Ventajas de primera vivienda**\n\n‚úÖ Entrada m√≠nima **10%** (vs 20% normal) ‚Üí necesitas ${fm(Math.round(c.pb*.10+c.pb*.11))} en vez de ${fm(Math.round(c.pb*.20+c.pb*.11))}\n‚úÖ ITP reducido al **5%** ‚Üí ahorras ${fm(Math.round(c.pb*.05))}\n‚úÖ Deducciones IRPF auton√≥micas aplicables\n\n‚ö†Ô∏è **Condiciones:**\n‚Ä¢ Vivir >3 a√±os como residencia habitual\n‚Ä¢ No tener ninguna otra vivienda en propiedad en Espa√±a\n‚Ä¢ Inscribirse en el padr√≥n del municipio\n‚Ä¢ Ingresos por debajo de ciertos umbrales (consultarlo con gestor)`,
    `üè† **Avantatges primera vivenda**\n\n‚úÖ Entrada m√≠nima **10%** ‚Üí ${fm(Math.round(c.pb*.10+c.pb*.11))} (vs ${fm(Math.round(c.pb*.20+c.pb*.11))})\n‚úÖ ITP al **5%** ‚Üí ${fm(Math.round(c.pb*.05))} d'estalvi\n\n‚ö†Ô∏è Cal viure-hi >3 anys com resid√®ncia habitual, sense cap altra vivenda a Espanya.`,
    `üè† **First home benefits**\n\n‚úÖ Minimum **10%** down ‚Üí ${fm(Math.round(c.pb*.10+c.pb*.11))} (vs ${fm(Math.round(c.pb*.20+c.pb*.11))})\n‚úÖ Reduced ITP (**5%**) ‚Üí save ${fm(Math.round(c.pb*.05))}\n\n‚ö†Ô∏è Must live there >3 years as primary residence, no other property owned in Spain.`
  );

  case"insurance":return es(
    `üõ°Ô∏è **Seguros vinculados a la hipoteca**\n\nüè† **Seguro hogar (multiriscos):** obligatorio si la hipoteca lo exige. Precio orientativo: ${fm(Math.round(c.pb*.0015))}/a√±o\n‚ù§Ô∏è **Seguro de vida:** recomendado (cubre la deuda si falleces). Coste orientativo: ${fm(Math.round(c.pay*.08))}/mes\nüí° El banco puede pedirte que contrates sus seguros (vinculaci√≥n), pero NO est√°s obligado a aceptar. Compara con otras aseguradoras.\n\n‚ö†Ô∏è Si te vinculan con seguros del banco, pide cu√°nto te bajan el tipo ‚Äî puede compensar o no.`,
    `üõ°Ô∏è **Assegurances hipoteques**\n\nLlar (multiriscos): ~${fm(Math.round(c.pb*.0015))}/any ¬∑ Vida: ~${fm(Math.round(c.pay*.08))}/mes\nüí° No est√†s obligat a contractar les assegurances del banc. Compara.`,
    `üõ°Ô∏è **Mortgage-linked insurance**\n\nHome insurance (required): ~${fm(Math.round(c.pb*.0015))}/year ¬∑ Life insurance (recommended): ~${fm(Math.round(c.pay*.08))}/mo\nüí° You're NOT required to take the bank's insurance. Always compare with other providers.`
  );

  case"advice":return es(
    c.recCode==="BUY"
      ?`üéØ **Mi consejo para ${c.nm}**\n\nTu situaci√≥n es favorable. Aqu√≠ mi plan:\n\n1. **No te precipites** ‚Äî visita m√≠nimo 5 propiedades reales\n2. **Negocia** ‚Äî hay margen del 5‚Äì10% en el Baix Pened√®s\n3. **Pide preaprobaci√≥n** bancaria antes de ofertar ‚Äî te da ventaja\n4. **Hipoteca fija o mixta** ‚Äî prot√©gete de subidas del eur√≠bor\n5. **Guarda ${fm(c.inc*3)} de emergencia** tras la compra, no te quedes sin colch√≥n\n\nüèÜ Objetivo de precio m√°ximo: ${fm(c.pb*(c.ratio>35?0.90:1))}`
      :c.need
        ?`üéØ **Mi consejo para ${c.nm}**\n\nAhora no es el momento de comprar ‚Äî y est√° bien:\n\n1. **Sigue alquilando** a ${fm(c.pr)}/mes ‚Äî menor estr√©s financiero\n2. **Automatiza ${fm(c.msv||300)}/mes** ‚Äî en ~${c.mosToGoal||"X"} meses llegas al objetivo\n3. **Mejora perfil bancario** ‚Äî sin descubiertos, sin deudas\n4. **Monitoriza el mercado** ‚Äî los precios del Baix Pened√®s se mueven lento\n5. **Revisa en 6 meses** ‚Äî si ingresos suben o encuentras precio menor`
        :`üéØ **Mi consejo para ${c.nm}**\n\nSituaci√≥n ajustada ‚Äî hay que ser estrat√©gico:\n\n1. **Baja el objetivo de precio** a ~${fm(c.pb*0.85)} (-15%)\n2. **Ampl√≠a el plazo** a ${Math.min(40,c.yrs+5)} a√±os ‚Üí cuota ${fm(mort(c.cap,c.rate,Math.min(40,c.yrs+5)))}/mes\n3. **Explora interior** ‚Äî Bonastre, Maslloren√ß, El Montmell son mucho m√°s baratos\n4. **No fuerces la compra** si el esfuerzo supera el 35%`,
    c.recCode==="BUY"
      ?`üéØ **El meu consell per a ${c.nm}**\n\n1. Visita m√≠nim 5 propietats\n2. Negocia (5‚Äì10% de marge)\n3. Preaprovaci√≥ banc√†ria\n4. Hipoteca fixa o mixta\n5. Guarda ${fm(c.inc*3)} d'emerg√®ncia`
      :`üéØ **El meu consell per a ${c.nm}**\n\nAra no √©s el moment. Segueix llogant a ${fm(c.pr)}/mes, automatitza ${fm(c.msv||300)}/mes d'estalvi i revisa en 6 mesos.`,
    c.recCode==="BUY"
      ?`üéØ **My advice for ${c.nm}**\n\n1. Visit at least 5 properties\n2. Negotiate (5‚Äì10% margin is common)\n3. Get bank pre-approval before offering\n4. Choose fixed or hybrid mortgage\n5. Keep ${fm(c.inc*3)} emergency fund after purchase`
      :`üéØ **My advice for ${c.nm}**\n\nNow is not the time to buy:\n\n1. Keep renting at ${fm(c.pr)}/mo\n2. Auto-save ${fm(c.msv||300)}/mo\n3. Clean up bank profile\n4. Reassess in 6 months`
  );

  case"compare":return es(
    `üó∫Ô∏è **${c.muni} vs otras zonas de Catalunya**\n\nüìç ${c.muni}: ~${Math.round(c.pb/c.m2)} ‚Ç¨/m¬≤ ¬∑ alquiler ~${fm(c.pr)}/mes\nüìç Barcelona ciudad: ~4.500‚Äì5.500 ‚Ç¨/m¬≤ ¬∑ alquiler ~1.800‚Äì2.500‚Ç¨/mes\nüìç Tarragona capital: ~1.800‚Äì2.200 ‚Ç¨/m¬≤ ¬∑ alquiler ~900‚Äì1.200‚Ç¨/mes\nüìç Vilanova i la G.: ~2.100‚Äì2.600 ‚Ç¨/m¬≤ ¬∑ alquiler ~900‚Äì1.100‚Ç¨/mes\nüìç Interior Pened√®s: ~800‚Äì1.400 ‚Ç¨/m¬≤\n\nüí° El Baix Pened√®s tiene: playa + aire limpio + tren a BCN en ~45 min. Relaci√≥n calidad/precio excepcional.`,
    `üó∫Ô∏è **${c.muni} vs altres zones**\n\n${c.muni}: ~${Math.round(c.pb/c.m2)} ‚Ç¨/m¬≤ ¬∑ Barcelona: ~4.500‚Äì5.500 ‚Ç¨/m¬≤ ¬∑ Tarragona: ~1.800‚Äì2.200 ‚Ç¨/m¬≤\n\nüí° Baix Pened√®s = platja + tren a BCN ~45 min + molt millor preu.`,
    `üó∫Ô∏è **${c.muni} vs other areas**\n\n${c.muni}: ~${Math.round(c.pb/c.m2)} ‚Ç¨/m¬≤ ¬∑ Barcelona: ~4,500‚Äì5,500 ‚Ç¨/m¬≤ ¬∑ Tarragona: ~1,800‚Äì2,200 ‚Ç¨/m¬≤\n\nüí° Baix Pened√®s: beach + clean air + train to BCN ~45 min. Exceptional value.`
  );

  case"income":return es(
    `üí∂ **Ingresos y capacidad (${fm(c.inc)}/mes)**\n\n‚úÖ Capacidad hipoteca al 35%: **${fm(c.safe)}/mes**\nTu cuota (${fm(c.pay)}) = **${fp(c.ratio)}** ‚Üí ${c.ratio<=35?"‚úÖ dentro del l√≠mite":"‚ùå supera el 35%"}\n\nüí° Para esfuerzo c√≥modo (30%): necesitar√≠as ingresos de ~${fm(Math.round(c.pay/0.30))}/mes\nPara comprar a -15% (${fm(c.pb*0.85)}): cuota ~${fm(mort(c.cap*0.85,c.rate,c.yrs))}/mes ‚Üí ${fp(mort(c.cap*0.85,c.rate,c.yrs)/c.inc*100)} de ingresos`,
    `üí∂ **Ingressos i capacitat (${fm(c.inc)}/mes)**\n\nCapacitat hipoteca (35%): **${fm(c.safe)}/mes**\nLa teva quota (${fm(c.pay)}) = **${fp(c.ratio)}** ‚Üí ${c.ratio<=35?"‚úÖ dins del l√≠mit":"‚ùå supera el 35%"}`,
    `üí∂ **Income and capacity (${fm(c.inc)}/mo)**\n\nSafe mortgage capacity (35%): **${fm(c.safe)}/mo**\nYour payment (${fm(c.pay)}) = **${fp(c.ratio)}** ‚Üí ${c.ratio<=35?"‚úÖ within limit":"‚ùå above 35%"}`
  );

  case"size":return es(
    `üìê **Sobre el tama√±o (${c.m2}m¬≤)**\n\n${Math.round(c.pb/c.m2)} ‚Ç¨/m¬≤ en ${c.muni}\n\n‚Ä¢ +10m¬≤ ‚Üí ~${fm(Math.round(c.pb+c.pb/c.m2*10))} (+${fm(Math.round(c.pb/c.m2*10))})\n‚Ä¢ ‚àí10m¬≤ ‚Üí ~${fm(Math.round(c.pb-c.pb/c.m2*10))} (‚àí${fm(Math.round(c.pb/c.m2*10))})\n‚Ä¢ ‚àí5m¬≤ ahorra cuota ~${fm(mort(c.cap-c.pb/c.m2*5*.8,c.rate,c.yrs)-c.pay)}/mes\n\nüí° En el Baix Pened√®s con ${c.m2}m¬≤ tienes espacio para vivir c√≥modamente. Los precios por m¬≤ son m√°s bajos que en grandes ciudades.`,
    `üìê **Mida (${c.m2}m¬≤)** ‚Äî ${Math.round(c.pb/c.m2)} ‚Ç¨/m¬≤\n\n+10m¬≤ ‚Üí ~${fm(Math.round(c.pb+c.pb/c.m2*10))} | ‚àí10m¬≤ ‚Üí ~${fm(Math.round(c.pb-c.pb/c.m2*10))}`,
    `üìê **Size (${c.m2}m¬≤)** ‚Äî ${Math.round(c.pb/c.m2)} ‚Ç¨/m¬≤\n\n+10m¬≤ ‚Üí ~${fm(Math.round(c.pb+c.pb/c.m2*10))} | ‚àí10m¬≤ ‚Üí ~${fm(Math.round(c.pb-c.pb/c.m2*10))}`
  );

  case"extras":return es(
    `üèä **Impacto de los extras en el precio**\n\n${c.extras!=="‚Äî"?`Extras activos: **${c.extras}**`:"No tienes extras seleccionados."}\n\nüìä Incrementos sobre el precio base:\n‚Ä¢ üåø Terraza: +5% = ${fm(Math.round(c.pb*.05))}\n‚Ä¢ üèä Piscina: +8% = ${fm(Math.round(c.pb*.08))}\n‚Ä¢ üõó Ascensor: +4% = ${fm(Math.round(c.pb*.04))}\n‚Ä¢ üöó Garaje: +3% = ${fm(Math.round(c.pb*.03))}\n\nüí° Si eliminas extras no esenciales, bajas precio y cuota. √ösalos como argumento de negociaci√≥n.`,
    `üèä **Impacte dels extres**\n\nTerrassa +5% | Piscina +8% | Ascensor +4% | Garatge +3%\nüí° Elimina extres no essencials per baixar preu i quota.`,
    `üèä **Extras impact on price**\n\nTerrace +5% | Pool +8% | Elevator +4% | Parking +3%\nüí° Removing non-essential extras lowers price and monthly payment.`
  );

  case"market":return es(
    `üìà **Mercado inmobiliario Baix Pened√®s**\n\nüîç Tendencias 2023‚Äì2025:\n‚Ä¢ Demanda sostenida por migraci√≥n desde Barcelona (teletrabajo)\n‚Ä¢ Precios costeros: +4‚Äì6%/a√±o (Cunit, Calafell, Vendrell)\n‚Ä¢ Oferta limitada en primera l√≠nea de playa\n‚Ä¢ Interior: precios m√°s estables, mayor oferta disponible\n\n‚ö†Ô∏è **Nadie puede predecir el mercado a corto plazo.** Compra cuando tus n√∫meros funcionen, no especulando con la evoluci√≥n del precio.`,
    `üìà **Mercat del Baix Pened√®s**\n\nDemanda sostinguda per migraci√≥ de Barcelona ¬∑ Preus costaners +4‚Äì6%/any ¬∑ Interior m√©s estable\n\n‚ö†Ô∏è Compra quan els teus n√∫meros funcionen, no especulant.`,
    `üìà **Baix Pened√®s real estate market**\n\nSustained demand driven by Barcelona migration ¬∑ Coastal +4‚Äì6%/year ¬∑ Inland more stable\n\n‚ö†Ô∏è Buy when your numbers work ‚Äî don't speculate on price trends.`
  );

  case"inflation":return es(
    `üìà **Inflaci√≥n e inmobiliario**\n\nLa vivienda costera catalana hist√≥ricamente sube ~3‚Äì4%/a√±o a largo plazo.\n\n${fm(c.pb)} hoy ‚Üí en 10 a√±os podr√≠a valer ~${fm(Math.round(c.pb*Math.pow(1.035,10)))}\n\nPero la inflaci√≥n tambi√©n erosiona el valor real de tu deuda hipotecaria ‚Äî si pagas cuota fija mientras los precios suben, cada a√±o "pagas menos en t√©rminos reales".\n\n‚ö†Ô∏è Rentabilidad pasada ‚â† futura. Compra para vivir, no como especulaci√≥n.`,
    `üìà **Inflaci√≥ i habitatge**\n\n${fm(c.pb)} avui ‚Üí en 10 anys podria valer ~${fm(Math.round(c.pb*Math.pow(1.035,10)))}\n‚ö†Ô∏è Compra per viure, no per especular.`,
    `üìà **Inflation & housing**\n\n${fm(c.pb)} today ‚Üí could be ~${fm(Math.round(c.pb*Math.pow(1.035,10)))} in 10 years\n‚ö†Ô∏è Past returns ‚â† future. Buy to live in, not to speculate.`
  );

  /* ‚îÄ‚îÄ TEMAS GENERALES ‚îÄ‚îÄ */
  case"gen_investing":return es(
    `üìä **Inversi√≥n ‚Äî principios fundamentales**\n\n‚Ä¢ **Riesgo y retorno van juntos:** alta rentabilidad implica alta volatilidad\n‚Ä¢ **Diversifica:** ETF de √≠ndice amplio (S&P 500, MSCI World) + renta fija seg√∫n perfil de riesgo\n‚Ä¢ **Costes bajos importan:** TER <0.3%/a√±o hace diferencia enorme a largo plazo\n‚Ä¢ **Horizonte temporal:** <3 a√±os ‚Üí conservador; >10 a√±os ‚Üí puedes asumir m√°s riesgo\n‚Ä¢ **Dollar-cost averaging (DCA):** invertir cantidad fija mensual reduce el impacto de la volatilidad\n\n‚ö†Ô∏è **Antes de invertir en bolsa:** asegura fondo de emergencia (3‚Äì6 meses) y paga deudas de alto inter√©s.`,
    `üìä **Inversi√≥ ‚Äî principis clau**\n\n‚Ä¢ Risc i retorn van junts\n‚Ä¢ Diversifica: ETF d'√≠ndex + renda fixa\n‚Ä¢ Costos baixos (TER <0.3%)\n‚Ä¢ DCA: quantitat fixa mensual\n‚ö†Ô∏è Primer: fons d'emerg√®ncia + deutes pagats`,
    `üìä **Investing ‚Äî core principles**\n\n‚Ä¢ Risk and return are linked\n‚Ä¢ Diversify: broad index ETF (S&P 500, MSCI World) + bonds\n‚Ä¢ Low costs matter: TER <0.3%/year\n‚Ä¢ Time horizon: <3 years ‚Üí conservative; >10 years ‚Üí more risk OK\n‚Ä¢ DCA: fixed monthly amount reduces timing risk\n\n‚ö†Ô∏è Before investing: emergency fund + high-interest debt paid.`
  );

  case"gen_personalfin":return es(
    `üí∞ **Finanzas personales ‚Äî estructura s√≥lida**\n\nüìã **Regla 50/30/20:**\n‚Ä¢ 50% necesidades (vivienda, comida, transporte)\n‚Ä¢ 30% deseos (ocio, restaurantes, viajes)\n‚Ä¢ 20% ahorro e inversi√≥n\n\nüéØ **Prioridades en orden:**\n1. Fondo emergencia: 3‚Äì6 meses de gastos\n2. Pagar deudas con inter√©s >5%\n3. Plan de pensiones (si hay deducci√≥n fiscal)\n4. Inversi√≥n a largo plazo (ETF indexado)\n5. Objetivos a medio plazo\n\nüí° El truco: **automatiza todo** el d√≠a de cobro ‚Äî tu cerebro no tiene que tomar decisiones dif√≠ciles.`,
    `üí∞ **Finances personals**\n\nüìã Regla 50/30/20: 50% necessitats ¬∑ 30% desitjos ¬∑ 20% estalvi\nüéØ Ordre: fons emerg√®ncia ‚Üí deutes alts ‚Üí pla de pensions ‚Üí inversi√≥`,
    `üí∞ **Personal finance ‚Äî solid structure**\n\nüìã **50/30/20 rule:** 50% needs ¬∑ 30% wants ¬∑ 20% savings/investing\nüéØ **Priority order:** Emergency fund ‚Üí debt >5% ‚Üí pension ‚Üí long-term investing ‚Üí medium goals\nüí° **The trick:** automate everything on payday.`
  );

  case"gen_code":return es(
    `üíª **Programaci√≥n ‚Äî principios clave**\n\nüß± **C√≥digo limpio:**\n‚Ä¢ Nombres descriptivos > comentarios extensos\n‚Ä¢ Funciones peque√±as con responsabilidad √∫nica (SRP)\n‚Ä¢ DRY: no te repitas\n‚Ä¢ KISS: la soluci√≥n m√°s simple suele ser la mejor\n\nüêõ **Debugging eficiente:**\n‚Ä¢ Reproduce el error de forma m√≠nima y aislada\n‚Ä¢ Lee el stack trace completo ‚Äî el error real suele estar al final\n‚Ä¢ Usa el debugger del navegador/IDE, no solo console.log\n\nüìö **Recursos recomendados:**\n‚Ä¢ JavaScript: MDN Web Docs, javascript.info\n‚Ä¢ Python: docs.python.org, Real Python\n‚Ä¢ General: The Odin Project, freeCodeCamp\n\n¬øTienes un error concreto? ¬°P√°salo y lo miramos!`,
    `üíª **Programaci√≥**\n\nCodi net: noms descriptius, funcions petites (SRP), DRY, KISS\nDebug: reprodueix m√≠nim el error, llegeix el stack trace complet\n¬øTens un error concret? Passa'l!`,
    `üíª **Programming ‚Äî key principles**\n\nüß± Clean code: descriptive names, small single-purpose functions, DRY, KISS\nüêõ Debugging: minimize + isolate the error, read full stack trace\nüìö Resources: MDN, javascript.info, Real Python, freeCodeCamp\n\nHave a specific error? Share it!`
  );

  case"gen_ai":return es(
    `ü§ñ **Inteligencia Artificial ‚Äî c√≥mo funciona**\n\nüß† **LLMs (Large Language Models):**\n‚Ä¢ Predicen el siguiente token bas√°ndose en patrones estad√≠sticos del entrenamiento\n‚Ä¢ No "piensan" en el sentido humano ‚Äî generan texto probable\n‚Ä¢ Pueden alucinar (inventar hechos) ‚Äî verifica info cr√≠tica siempre\n\nüìù **Prompts efectivos:**\n‚Ä¢ S√© espec√≠fico: rol + contexto + tarea + formato de salida\n‚Ä¢ Para tareas complejas: divide en pasos y pide razonamiento paso a paso\n‚Ä¢ Usa ejemplos del output que quieres\n\nüîÆ **Tendencias 2024‚Äì2025:**\n‚Ä¢ Modelos multimodales (texto + imagen + audio + v√≠deo)\n‚Ä¢ Agentes aut√≥nomos con acceso a herramientas\n‚Ä¢ RAG (Retrieval Augmented Generation) para datos propios`,
    `ü§ñ **Intel¬∑lig√®ncia Artificial**\n\nEls LLMs prediquen el proper token estad√≠sticament. Poden al¬∑lucinar ‚Äî verifica sempre.\n\nPrompts efectius: rol + context + tasca + format. Per a tasques complexes, divideix en passos.`,
    `ü§ñ **Artificial Intelligence**\n\nLLMs predict next tokens statistically ‚Äî they don't truly "think". Can hallucinate ‚Äî always verify critical info.\n\nEffective prompts: role + context + task + output format. For complex tasks: break into steps, ask for step-by-step reasoning.`
  );

  case"gen_business":return es(
    `üíº **Negocios y emprendimiento ‚Äî claves**\n\nüéØ **Antes de lanzar:**\n‚Ä¢ Valida el problema (habla con 10 clientes potenciales)\n‚Ä¢ Calcula el CAC (coste adquisici√≥n cliente) y el LTV (valor de vida del cliente)\n‚Ä¢ LTV debe ser >3√ó el CAC para tener un modelo sano\n\nüí∞ **Finanzas del negocio:**\n‚Ä¢ Controla el cashflow mensual ‚Äî muchos negocios rentables quiebran por falta de liquidez\n‚Ä¢ Margen bruto objetivo: >40% (servicio), >60% (software/SaaS)\n\nüìà **Crecer con sentido:**\n‚Ä¢ Retenci√≥n > adquisici√≥n: cuesta 5√ó m√°s conseguir un cliente nuevo que mantener uno actual\n‚Ä¢ Focal√≠zate en los canales que mejor convierten antes de diversificar`,
    `üíº **Negocis ‚Äî claus**\n\nüéØ Valida el problema (parla amb 10 clients) ¬∑ LTV >3√ó CAC\nüí∞ Controla el cashflow ‚Äî molts negocis rendibles queden per falta de liquiditat\nüìà Retenci√≥ > adquisici√≥`,
    `üíº **Business ‚Äî key principles**\n\nüéØ Validate the problem (talk to 10 potential customers) ¬∑ LTV must be >3√ó CAC\nüí∞ Control cashflow ‚Äî profitable businesses fail due to liquidity issues\nüìà Retention > acquisition: keeping a customer costs 5√ó less than acquiring one`
  );

  case"gen_health":return es(
    `üèÉ **Salud ‚Äî evidencia cient√≠fica resumida**\n\nüí§ **Sue√±o (el m√°s infravalorado):**\n‚Ä¢ 7‚Äì9h/noche para adultos ¬∑ Horario constante incluso el fin de semana ¬∑ Oscuridad total\n\nüèãÔ∏è **Ejercicio:**\n‚Ä¢ 150 min/semana de cardio moderado (o 75 min intenso) ¬∑ 2 sesiones de fuerza\n‚Ä¢ El sedentarismo es tan da√±ino como fumar\n\nü•ó **Nutrici√≥n b√°sica:**\n‚Ä¢ Prioriza: verduras, prote√≠na completa, grasas buenas\n‚Ä¢ Reduce: ultraprocesados, az√∫car a√±adido, alcohol\n\nüßò **Estr√©s y ansiedad:**\n‚Ä¢ Respiraci√≥n diafragm√°tica: 5 seg inhala, 5 ret√©n, 5 exhala ‚Äî efecto inmediato\n‚Ä¢ Ejercicio es el mejor antidepresivo natural evidenciado`,
    `üèÉ **Salut ‚Äî resum cient√≠fic**\n\nüí§ 7‚Äì9h de son, horari constant\nüèãÔ∏è 150 min/setmana cardio + 2 sessions de for√ßa\nü•ó Prioritza verdures, prote√Øna, greixos bons. Redueix ultraprocesats\nüßò Respiraci√≥ diafragm√†tica per l'estr√®s (5-5-5)`,
    `üèÉ **Health ‚Äî science summary**\n\nüí§ Sleep: 7‚Äì9h/night, consistent schedule, full darkness\nüèãÔ∏è Exercise: 150 min/week moderate cardio + 2 strength sessions\nü•ó Nutrition: prioritize vegetables, complete protein, healthy fats ¬∑ reduce ultraprocessed, added sugar\nüßò Stress: diaphragmatic breathing (5s in, 5s hold, 5s out) ‚Äî immediate effect`
  );

  case"gen_history":return es(
    `üìö **Historia ‚Äî pistas para entender el presente**\n\nLa historia no se repite exactamente, pero rima (Mark Twain).\n\nüîë **Patrones recurrentes:**\n‚Ä¢ Las grandes civilizaciones caen t√≠picamente por causas combinadas: colapso econ√≥mico + tensi√≥n social + presi√≥n externa\n‚Ä¢ Las revoluciones tecnol√≥gicas siempre generan resistencia antes de transformar la sociedad\n‚Ä¢ El comercio ha unido culturas m√°s que cualquier ideolog√≠a\n\nüìñ Si buscas algo concreto (una √©poca, evento o civilizaci√≥n), ¬°pregunta! Puedo profundizar en lo que m√°s te interese.`,
    `üìö **Hist√≤ria**\n\nLa hist√≤ria no es repeteix exactament, per√≤ rima.\nPatrons: les grans civilitzacions cauen per causes combinades ¬∑ les revolucions tecnol√≤giques generen resist√®ncia ¬∑ el comer√ß uneix cultures\n\nVols profunditzar en algun tema o √®poca concreta?`,
    `üìö **History**\n\nHistory doesn't repeat exactly, but it rhymes.\n\nRecurring patterns: great civilizations fall from combined causes ¬∑ technological revolutions face resistance before transforming society ¬∑ trade connects cultures more than ideology\n\nAsk me about any specific period or event!`
  );

  case"gen_math":return es(
    `üî¢ **Matem√°ticas ‚Äî ayuda concreta**\n\n¬øQu√© necesitas?\n\nüìä **Estad√≠stica:** media, mediana, desviaci√≥n est√°ndar, probabilidad b√°sica\nüìê **Geometr√≠a:** √°reas, vol√∫menes, trigonometr√≠a\nüî¢ **√Ålgebra:** ecuaciones, funciones, derivadas\nüìà **Finanzas:** inter√©s compuesto, VAN, TIR\n\nüí° P√°same el problema concreto con los datos y lo resolvemos paso a paso. Las matem√°ticas son m√°s f√°ciles con ejemplos reales.`,
    `üî¢ **Matem√†tiques**\n\nPassa'm el problema concret amb les dades i ho resolem pas a pas: estad√≠stica, geometria, √†lgebra, finances...`,
    `üî¢ **Mathematics**\n\nShare the specific problem with its data and we'll solve it step by step: statistics, geometry, algebra, finance...\n\nüí° Math is always easier with real examples!`
  );

  case"gen_philosophy":return es(
    `ü§î **Filosof√≠a ‚Äî ideas para reflexionar**\n\n**Estoicismo (muy aplicable hoy):**\n‚Ä¢ Distingue lo que est√° en tu control (tus acciones, pensamientos) de lo que no (el mercado, la opini√≥n ajena)\n‚Ä¢ Memento mori: la consciencia de la finitud da urgencia y perspectiva\n‚Ä¢ Marco Aurelio, S√©neca, Epicteto ‚Äî sorprendentemente modernos\n\n**Preguntas fundamentales:**\n‚Ä¢ ¬øQu√© es una vida bien vivida?\n‚Ä¢ ¬øC√≥mo tomar buenas decisiones bajo incertidumbre?\n‚Ä¢ ¬øCu√°l es la relaci√≥n entre libertad y responsabilidad?\n\n¬øHay alguna corriente o pregunta concreta que quieras explorar?`,
    `ü§î **Filosofia**\n\nEstoicisme: distingeix el que controles del que no ¬∑ Memento mori d√≥na perspectiva\nVols explorar alguna corrent o pregunta concreta?`,
    `ü§î **Philosophy**\n\nStoicism (highly applicable today): distinguish what's in your control from what isn't ¬∑ Memento mori gives perspective and urgency\n\nWant to explore any specific school of thought or question?`
  );

  case"gen_language":return es(
    `üåç **Aprender idiomas ‚Äî m√©todo efectivo**\n\nüèÜ **Orden de prioridades:**\n1. Input comprensible (escuchar/leer mucho, ligeramente por encima de tu nivel)\n2. Vocabulario de alta frecuencia primero (1.000 palabras cubren ~85% del uso)\n3. Output desde el d√≠a 1 (aunque sea b√°sico ‚Äî el error es parte del aprendizaje)\n4. Consistencia diaria > sesiones largas espor√°dicas\n\nüõ†Ô∏è **Recursos top:**\n‚Ä¢ Anki (flashcards con repetici√≥n espaciada)\n‚Ä¢ Language Transfer (cursos gratuitos de audio)\n‚Ä¢ Pimsleur para pronunciaci√≥n\n‚Ä¢ Itaki/Preply para conversaci√≥n con nativos\n\n¬øQu√© idioma est√°s aprendiendo?`,
    `üåç **Aprendre idiomes**\n\n1. Input comprensible (escoltar/llegir molt)\n2. Vocabulari alta freq√º√®ncia primer\n3. Output des del dia 1\n4. Consist√®ncia di√†ria > sessions llargues\n\nAnki, Language Transfer i conversar amb nadius.`,
    `üåç **Learning languages ‚Äî effective method**\n\n1. Comprehensible input (listen/read a lot, slightly above your level)\n2. High-frequency vocabulary first (1,000 words cover ~85%)\n3. Output from day 1 (errors are part of learning)\n4. Daily consistency > sporadic long sessions\n\nTools: Anki, Language Transfer, italki. What language are you learning?`
  );

  case"gen_wine":return es(
    `üç∑ **Vinos del Pened√®s**\n\nEl Baix Pened√®s forma parte de la DO Pened√®s y es vecino del Cava (DO Cava).\n\nüçæ **Cava:** elaborado con variedades aut√≥ctonas (Macabeu, Xarel¬∑lo, Parellada) + internacionales (Chardonnay, Pinot Noir). Crianza m√≠nima 9 meses en botella.\n\nüç∑ **Vinos blancos del Pened√®s:** Xarel¬∑lo joven ‚Äî fresco, c√≠trico. Torres y Juv√© & Camps son referencias.\n\nüçá **Consell:** visita bodegas en El Vendrell, Bonastre o la zona de Subirats ‚Äî muchas abren sin reserva y tienen precios de bodega directa (muy por debajo de tiendas).`,
    `üç∑ **Vins del Pened√®s**\n\nDO Pened√®s (blancs: Xarel¬∑lo, Macabeu) + DO Cava (Macabeu, Xarel¬∑lo, Parellada).\nVisita cellers a El Vendrell, Bonastre o Subirats ‚Äî molts oberts sense reserva.`,
    `üç∑ **Pened√®s wines**\n\nDO Pened√®s + DO Cava nearby. Key grapes: Macabeu, Xarel¬∑lo, Parellada for Cava; also great whites and reds.\n\nTip: visit cellars in El Vendrell or Bonastre area ‚Äî many open without reservation at cellar-door prices.`
  );

  case"gen_weather":return es(
    `‚òÄÔ∏è **Clima del Baix Pened√®s**\n\nClima mediterr√°neo costero: inviernos suaves (media enero ~10¬∞C), veranos c√°lidos (media julio ~25¬∞C).\n\n‚Ä¢ Precipitaci√≥n: ~500‚Äì600 mm/a√±o, concentrada en primavera y oto√±o\n‚Ä¢ Horas de sol: ~2.500/a√±o ‚Äî de las m√°s altas de Europa\n‚Ä¢ Playa: temporada de ba√±o de junio a septiembre\n‚Ä¢ Viento: Tramuntana (norte) y Llevant (este)\n\nPara el tiempo actual te recomiendo: tiempo.com o aemet.es`,
    `‚òÄÔ∏è **Clima del Baix Pened√®s**\n\nMediterrani costaner: hiverns suaus (~10¬∞C gener), estius c√†lids (~25¬∞C juliol). ~2.500h de sol/any. Per al temps actual: meteo.cat`,
    `‚òÄÔ∏è **Baix Pened√®s climate**\n\nCoastal Mediterranean: mild winters (~10¬∞C Jan), warm summers (~25¬∞C July). ~2,500 sun hours/year. Swimming season: June‚ÄìSeptember.\n\nFor current weather: weather.com or aemet.es`
  );

  case"gen_sport":return es(
    `‚öΩ **Deportes ‚Äî datos y an√°lisis**\n\nEl Baix Pened√®s tiene buena tradici√≥n deportiva local ‚Äî p√°del, golf y ciclismo son muy populares en la zona.\n\nSobre el Bar√ßa, Madrid, la Liga, Champions u otros deportes ‚Äî puedo hablar de historia, estad√≠sticas y an√°lisis, aunque para resultados en tiempo real necesitar√°s una app de noticias deportivas (mi informaci√≥n tiene un corte de fecha).\n\n¬øQu√© deporte o equipo te interesa?`,
    `‚öΩ **Esports**\n\nEl Baix Pened√®s t√© bona tradici√≥ en p√†del, golf i ciclisme.\nSobre el Bar√ßa, la Lliga, Champions o altres esports ‚Äî puc parlar d'hist√≤ria i an√†lisi, per√≤ per a resultats en temps real necessites una app esportiva.`,
    `‚öΩ **Sports**\n\nBaix Pened√®s has good local traditions in padel, golf and cycling.\nFor historical stats, analysis and team discussions I'm here ‚Äî but for live scores you'll need a sports app.\n\nWhat sport or team interests you?`
  );

  case"gen_food":return es(
    `üçΩÔ∏è **Gastronom√≠a del Baix Pened√®s**\n\nLa cocina local combina lo mejor del mar y la monta√±a:\n\nüêü **Marinera:** fideu√†, arr√≤s a la cassola, suquet de peix\nü•© **De interior:** cargols a la llauna, botifarra amb mongetes, escalivada\nüç∑ **Maridaje natural:** cava o vino blanco del Pened√®s con los mariscos; tinto local con las carnes\n\nüìç **Mercados recomendados:** Mercado de El Vendrell (martes y s√°bados)\n\n¬øBuscas receta concreta o restaurantes de la zona?`,
    `üçΩÔ∏è **Gastronomia del Baix Pened√®s**\n\nMar: fideu√†, arr√≤s a la cassola, suquet de peix\nMuntanya: cargols a la llauna, botifarra amb mongetes, escalivada\nMaridatge: cava o vi blanc del Pened√®s\n\nBusques una recepta concreta o restaurants?`,
    `üçΩÔ∏è **Baix Pened√®s gastronomy**\n\nSea: fideu√†, rice stew, fish suquet\nLand: snails, botifarra with beans, escalivada\nPairing: local cava or white wine\n\nLooking for a specific recipe or restaurant recommendation?`
  );

  case"gen_joke":return es(
    `üòÑ Un chiste inmobiliario:\n\n‚Äî ¬øPor qu√© el piso en el Pened√®s era tan especial?\n‚Äî Porque no solo vend√≠a metros cuadrados... ¬°vend√≠a metros de cava! üçæ\n\n...Bueno, no soy el mejor c√≥mico del mercado inmobiliario, pero soy un asesor bastante decente. ¬øEn qu√© puedo ayudarte?`,
    `üòÑ Un acudit immobiliari:\n\n‚Äî Per qu√® el pis al Pened√®s era tan especial?\n‚Äî Perqu√® no venia nom√©s metres quadrats... venia metres de cava! üçæ\n\n...No soc el millor c√≤mic, per√≤ soc un assessor for√ßa decent. En qu√® et puc ajudar?`,
    `üòÑ A real estate joke:\n\n‚Äî Why was the flat in Pened√®s so special?\n‚Äî Because it didn't just sell square meters... it sold meters of cava! üçæ\n\n...Not my best material, but I'm a decent advisor. What can I help you with?`
  );

  case"gen_travel":return es(
    `‚úàÔ∏è **Viajes ‚Äî el Baix Pened√®s como destino**\n\n¬øSab√≠as que el Baix Pened√®s es perfecto para una escapada desde Barcelona?\n\nüèñÔ∏è **Playas:** Calafell, Cunit, Segur de Calafell ‚Äî menos masificadas que la Costa Daurada\nüöÇ **C√≥mo llegar:** tren desde Sants en ~45 min, c√≥modo y econ√≥mico\nüç∑ **Ruta del cava:** visitas a bodegas en el Alt Pened√®s (Sant Sadurn√≠ d'Anoia a 20 min)\nüè∞ **Patrimonio:** Castillo de Calafell, Arco de Ber√† (era romana)\n\n¬øPreguntas sobre un destino concreto? ¬°Pregunta!`,
    `‚úàÔ∏è **Viatges ‚Äî Baix Pened√®s com a dest√≠**\n\nPlatges menys massificades que Costa Daurada ¬∑ Tren des de Sants ~45 min ¬∑ Ruta del cava ¬∑ Patrimoni rom√† (Arc de Ber√†)\n\nVols informaci√≥ sobre algun dest√≠ concret?`,
    `‚úàÔ∏è **Travel ‚Äî Baix Pened√®s as a destination**\n\nLess crowded beaches than Costa Daurada ¬∑ Train from Barcelona Sants ~45 min ¬∑ Cava wine route ¬∑ Roman heritage (Arc de Ber√†)\n\nLooking for info on a specific destination?`
  );

  case"gen_book":return es(
    `üìö **Libros recomendados por categor√≠a**\n\nüí∞ **Finanzas personales:** "Padre Rico Padre Pobre" (Kiyosaki) ¬∑ "El inversor inteligente" (Graham) ¬∑ "Un peque√±o paso puede cambiar tu vida" (Maurer)\nüè† **Inmobiliario:** "The Millionaire Real Estate Investor" (Keller) ¬∑ "Rich Dad's Guide to Investing"\nü§î **Pensamiento:** "Pensar r√°pido, pensar despacio" (Kahneman) ¬∑ "El arte de la guerra" (Sun Tzu)\nüöÄ **Emprendimiento:** "The Lean Startup" (Ries) ¬∑ "Cero a uno" (Thiel)\n\n¬øTienes alg√∫n tema concreto para el que buscas recomendaci√≥n?`,
    `üìö **Llibres recomanats**\n\nFinances: "Pare Ric Pare Pobre" ¬∑ "L'inversor intel¬∑ligent"\nPensament: "Pensar r√†pid, pensar a poc a poc"\nNegoci: "The Lean Startup" ¬∑ "De zero a u"\n\nTens un tema concret?`,
    `üìö **Recommended books**\n\nPersonal finance: "Rich Dad Poor Dad" ¬∑ "The Intelligent Investor"\nThinking: "Thinking Fast and Slow"\nBusiness: "The Lean Startup" ¬∑ "Zero to One"\n\nLooking for a specific genre or topic?`
  );

  case"gen_music":return es(
    `üéµ **M√∫sica ‚Äî curiosidades y ayuda**\n\nPuedo hablar de historia de la m√∫sica, g√©neros, artistas, teor√≠a musical b√°sica... aunque para reproducir canciones necesitar√°s Spotify, YouTube o similar.\n\nüé∏ **G√©neros del Baix Pened√®s:** la zona tiene buena escena de m√∫sica en directo, especialmente en verano (festivales en El Vendrell y Calafell).\n\n¬øQu√© tipo de m√∫sica te interesa o en qu√© puedo ayudarte?`,
    `üéµ **M√∫sica**\n\nPuc parlar d'hist√≤ria musical, g√®neres, artistes, teoria... per√≤ per reproduir can√ßons necessites Spotify o similar.\n¬øQuin estil o artista t'interessa?`,
    `üéµ **Music**\n\nI can discuss music history, genres, artists, basic theory... but for actually playing music you'll need Spotify, YouTube etc.\n\nWhat style or artist interests you?`
  );

  /* ‚îÄ‚îÄ FALLBACK ‚îÄ‚îÄ */
  default:{
    const m=normMsg(msg);
    // Intento de respuesta contextual gen√©rica
    if(c&&(m.includes("mi caso")||m.includes("mis datos")||m.includes("my case")||m.includes("el meu cas"))){
      return es(
        `üìä **Tu situaci√≥n en resumen:**\n\n${c.nm} ¬∑ ${c.muni} ¬∑ ${c.m2}m¬≤ ¬∑ ${c.bd} hab ¬∑ ${c.type}\nPrecio: ${fm(c.pb)} ¬∑ Cuota: ${fm(c.pay)}/mes ¬∑ Alquiler: ${fm(c.pr)}/mes\nEsfuerzo compra: ${fp(c.ratio)} ¬∑ Cash: ${c.need?"‚ùå faltan "+fm(c.missing):"‚úÖ cubierto"}\n\nüéØ Recomendaci√≥n: **${c.rec}**\n\n¬øQu√© aspecto concreto quieres analizar?`,
        `üìä **La teva situaci√≥:**\n\n${c.nm} ¬∑ ${c.muni} ¬∑ ${c.m2}m¬≤ ¬∑ Preu: ${fm(c.pb)} ¬∑ Quota: ${fm(c.pay)}/mes\nRecomanaci√≥: **${c.rec}**`,
        `üìä **Your situation:**\n\n${c.nm} ¬∑ ${c.muni} ¬∑ ${c.m2}m¬≤ ¬∑ Price: ${fm(c.pb)} ¬∑ Payment: ${fm(c.pay)}/mo\nRecommendation: **${c.rec}**`
      );
    }
    return es(
      `üí¨ Entiendo tu pregunta sobre **"${msg}"**.\n\nPuedo ayudarte con:\n‚Ä¢ üè† Hipoteca, cuotas, entrada, alquiler vs compra, municipios del Baix Pened√®s\n‚Ä¢ üí∞ Finanzas personales, ahorro, inversi√≥n\n‚Ä¢ üíª Tecnolog√≠a, programaci√≥n, IA\n‚Ä¢ üìö Historia, ciencia, idiomas, negocios, viajes, cocina\n\n¬øPuedes darme m√°s detalle sobre lo que necesitas? As√≠ te doy la respuesta m√°s √∫til posible.`,
      `üí¨ Entenc la teva pregunta sobre **"${msg}"**.\n\nPuc ajudar-te amb: hipoteca, lloguer, municipis, finances, tecnologia, historia, idiomes...\n\nPots donar-me m√©s detall?`,
      `üí¨ I understand you're asking about **"${msg}"**.\n\nI can help with: mortgage, rent, towns, finance, investing, technology, history, languages, business...\n\nCan you give me more detail? That way I can give you the most useful answer possible.`
    );
  }

  }// end switch
};
  
// Fallback seguro si alg√∫n sitio llama a buildReply2
if (typeof window.buildReply2 !== "function") {
  window.buildReply2 = function(msg){
    return (typeof window.buildReply === "function")
      ? window.buildReply(msg)
      : "No tengo respuesta local ahora mismo. Intenta reformular la pregunta.";
  };
}

/* ‚îÄ‚îÄ ENVIAR MENSAJE AL AI ‚îÄ‚îÄ */
const sendToAI=async (msg)=>{
  if(isAIProcessing)return;
  isAIProcessing=true;
  const btnEl=Q("#chatSend"),inpEl=Q("#chatInput");
  if(btnEl)btnEl.disabled=true;
  if(inpEl){inpEl.disabled=true;inpEl.value="";inpEl.style.height="auto";}
  addMsg("user",msg);
  chatHistory.push({role:"user",content:msg});
  addThinking();
  
// Determinar si usar IA real o local
const m = msg.toLowerCase().trim();
const useRealAI = (
  m.length > 100 ||
  /\b(plan|estrategia|consejo|recomiend|analiza|compara|explica|detalla|como|por que|cuando|donde)\b/i.test(m) ||
  /\b(inversion|negocio|tecnologia|programacion|viaje|cocina|historia)\b/i.test(m)
);

let reply = "";

// Intentar IA real (Worker)
if (useRealAI && AI_PROXY_URL && /^https?:\/\//.test(AI_PROXY_URL)) {
  try {
    const prompt = buildLLMPrompt(msg);

    const systemMsg = {
      role: "system",
      content: LANG === "CA"
        ? "Ets un assessor financer expert. Respon en catal√† de forma clara i pr√†ctica."
        : LANG === "EN"
          ? "You are an expert financial advisor. Respond in English clearly and practically."
          : "Eres un asesor financiero experto. Responde en espa√±ol de forma clara y pr√°ctica."
    };

    const messages = [systemMsg, { role: "user", content: prompt }];

    const aiReply = await callGroqViaWorker(messages, { temperature: 0.4, max_tokens: 900 });

    if (aiReply) reply = aiReply;

  } catch (e) {
    console.error("AI via Worker failed:", e);
  }
}

// Fallback local si la IA real no responde
if (!reply) {
  reply = buildReply2(msg);
}

  // Peque√±o delay para efecto visual
  setTimeout(()=>{
    removeThinking();
    chatHistory.push({role:"assistant",content:reply});
    saveChatHistory();
    // Efecto typing
    const mc=Q("#chatMessages");
    const d=document.createElement("div");d.className="chat-message ai";
    const av=document.createElement("div");av.className="chat-avatar ai";av.textContent="AI";
    const bub=document.createElement("div");bub.className="chat-bubble";
    d.appendChild(av);d.appendChild(bub);
    if(mc)mc.appendChild(d);
    const clean=escapeHTML(reply).replace(/\n/g,"<br>").replace(/\*\*(.+?)\*\*/g,"<b>$1</b>");
    let pos=0;
    const unlock=()=>{
      isAIProcessing=false;
      const b=Q("#chatSend"),i=Q("#chatInput");
      if(b)b.disabled=false;
      if(i){i.disabled=false;i.focus();}
    };
    const iv=setInterval(()=>{
      pos=Math.min(pos+4,clean.length);
      bub.innerHTML=clean.substring(0,pos);
      if(mc)mc.scrollTop=mc.scrollHeight;
      if(pos>=clean.length){clearInterval(iv);unlock();}
    },8);
  },350);
};

const renderChatHistory=()=>{
  QA(".chat-message:not(#welcome-message)").forEach(el=>el.remove());
  chatHistory.forEach(m=>{if(m.role==="user")addMsg("user",m.content);else if(m.role==="assistant")addMsg("ai",m.content);});
};

const initChatUI=()=>{
  applyI18n();
  loadChatHistory();
  renderChatHistory();
  renderAIContext();
  setBadge();
  const btn=Q("#chatSend"),inp=Q("#chatInput");
  if(btn&&!btn.dataset.init){
    btn.dataset.init="1";
    btn.onclick=()=>{const m=inp?.value?.trim();if(m)sendToAI(m);};
  }
  if(inp&&!inp.dataset.init){
    inp.dataset.init="1";
    inp.addEventListener("keypress",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();const m=inp.value.trim();if(m)sendToAI(m);}});
    inp.addEventListener("input",()=>{inp.style.height="auto";inp.style.height=Math.min(inp.scrollHeight,120)+"px";});
  }
  const clearBtn=Q("#aiClearBtn");
  if(clearBtn&&!clearBtn.dataset.init){
    clearBtn.dataset.init="1";
    clearBtn.addEventListener("click",()=>{
      chatHistory=[];saveChatHistory();
      QA(".chat-message:not(#welcome-message)").forEach(el=>el.remove());
      const wb=Q("#welcome-bubble");if(wb)wb.textContent=t("aiWelcome");
      toast(LANG==="EN"?"Chat cleared":(LANG==="CA"?"Xat netejat":"Chat limpiado"));
    });
  }
  const copyBtn=Q("#aiCopyBtn");
  if(copyBtn&&!copyBtn.dataset.init){
    copyBtn.dataset.init="1";
    copyBtn.addEventListener("click",()=>{
      const lines=chatHistory.map(m=>`${m.role==="user"?t("aiYou"):"AI"}: ${m.content}`);
      const txt=lines.join("\n\n")||(LANG==="EN"?"No messages yet":"Sin mensajes a√∫n");
      navigator.clipboard?.writeText(txt).then(()=>toast(t("toastCopied"))).catch(()=>toast("Error"));
    });
  }
  const planBtn=Q("#aiPlanBtn");
  if(planBtn&&!planBtn.dataset.init){
    planBtn.dataset.init="1";
    planBtn.addEventListener("click",()=>{
      if(!isAIProcessing)sendToAI(LANG==="EN"?"Create a detailed 90-day action plan for my specific situation":(LANG==="CA"?"Fes-me un pla d'acci√≥ detallat de 90 dies per a la meva situaci√≥":"Hazme un plan de acci√≥n detallado de 90 d√≠as para mi situaci√≥n"));
    });
  }
  renderAISuggestions();
};

/* =====================
   VALIDACI√ìN LIVE
   ===================== */
const liveValidate=()=>{
  const setHint=(id,msg,ok)=>{const el=Q("#hint-"+id);if(!el)return;el.textContent=msg||"";el.className="field-hint "+(msg?(ok?"ok":"err"):"");Q("#"+id)?.classList.toggle("field-ok",!!ok&&!!msg);Q("#"+id)?.classList.toggle("field-err",!ok&&!!msg);};
  const inc=+Q("#inc")?.value||0;if(inc>0&&inc<500)setHint("inc",LANG==="EN"?"Very low income":(LANG==="CA"?"Ingressos molt baixos":"Ingresos muy bajos, ¬øes neto?"),false);else if(inc>0)setHint("inc","‚úì",true);else setHint("inc","","");
  const sav=+Q("#sav")?.value||0;if(sav>0&&sav<5000)setHint("sav",LANG==="EN"?"Very low savings":(LANG==="CA"?"Estalvis molt baixos":"Ahorros muy bajos"),false);else if(sav>0)setHint("sav","‚úì",true);else setHint("sav","","");
  const m2=+Q("#m2")?.value||0;if(m2>0&&m2<50)setHint("m2",LANG==="EN"?"Minimum 50 m¬≤":(LANG==="CA"?"M√≠nim 50 m¬≤":"M√≠nimo 50 m¬≤"),false);else if(m2>=50)setHint("m2","‚úì",true);else setHint("m2","","");
};

/* =====================
   EVENTOS
   ===================== */
Q("#np").onclick=()=>{const nm=(Q("#nm").value||"").trim(),ag=+Q("#ag").value||0;if(!nm||ag<18||ag>100){toast(t("toastCheck"));return;}saveForm();show("e");};
Q("#ne").onclick=()=>{saveForm();show("f");};
Q("#go").onclick=analyze;
Q("#cp").onclick=()=>{if(!last){toast(t("toastFirst"));return;}navigator.clipboard?.writeText(Q("#rt").textContent||"").then(()=>toast(t("toastCopied"))).catch(()=>{});};
Q("#rs").onclick=()=>{if(confirm(LANG==="EN"?"Reset everything?":(LANG==="CA"?"Reiniciar tot?":"¬øReiniciar todo?"))){localStorage.clear();location.reload();}};
Q("#jumpX").onclick=()=>{if(!last){toast(t("toastFirst"));return;}show("x");};
Q("#jumpAI").onclick=()=>{if(!last){toast(t("toastFirst"));return;}show("ai");};
Q("#shareWa").onclick=()=>{if(!last){toast(t("toastFirst"));return;}window.open("https://wa.me/?text="+encodeURIComponent(Q("#rt").textContent||""),"_blank","noopener");};
Q("#shareCl").onclick=()=>Q("#cp").click();

Q("#t_p").onclick=()=>show("p");
Q("#t_e").onclick=()=>show("e");
Q("#t_f").onclick=()=>show("f");
Q("#t_r").onclick=()=>{if(!last){toast(t("toastFirst"));return;}show("r");};
Q("#t_m").onclick=()=>{if(!last){toast(t("toastFirst"));return;}show("m");};
Q("#t_x").onclick=()=>{if(!last){toast(t("toastFirst"));return;}show("x");};
Q("#t_ai").onclick=()=>{if(!last){toast(t("toastFirst"));return;}show("ai");};

Q("#toggleMap").onclick=()=>{
  const box=Q("#zoneWrap"),open=box.style.display!=="none";
  box.style.display=open?"none":"block";
  if(!open){initMap();setTimeout(()=>{zmap?.invalidateSize();box.scrollIntoView({behavior:"smooth",block:"nearest"});},300);}
};
Q("#zoneFitAll").onclick=fitAllZone;
Q("#zoneClear").onclick=()=>{zoneSel.clear();polygonsByName.forEach((_,n)=>applyPolygonState(n));renderZoneUI();saveZoneSel();toast(t("toastZoneCleared"));};
Q("#zoneApply").onclick=()=>{
  if(!zoneSel.size){toast(t("toastNoZone"));return;}
  const pm=Q("#ar").querySelector('[value="__multi__"]');if(pm)pm.remove();
  if(zoneSel.size===1){Q("#ar").value=[...zoneSel][0];}
  else{const mo=document.createElement("option");mo.value="__multi__";mo.textContent=[...zoneSel].join(", ");Q("#ar").insertBefore(mo,Q("#ar").options[1]);Q("#ar").value="__multi__";}
  saveZoneSel();saveForm();toast(t("toastZoneApplied"));
};
Q("#bc").onclick=compare;
Q("#autoFillCmp").onclick=fillFromLast;
Q("#cm").onchange=upMap;
Q("#L_CA").onclick=()=>setLang("CA");
Q("#L_ES").onclick=()=>setLang("ES");
Q("#L_EN").onclick=()=>setLang("EN");
["inc","sav","m2"].forEach(id=>Q("#"+id)?.addEventListener("input",liveValidate));
["nm","ag","inc","sav","yrs","msv","m2","bed","ar","em","tel","notes"].forEach(id=>Q("#"+id)?.addEventListener("blur",saveForm));

})();}

window.addEventListener("load",initApp);
</script>
</body>
</html>
