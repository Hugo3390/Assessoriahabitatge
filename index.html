<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Assessoria d'Habitatge</title>
<style>
:root{
  --card:rgba(15,23,42,.68);--bd:#334155;--t:#e5e7eb;--m:#94a3b8;--pill:#0ea5e9;
  --p:#06b6d4;--ph:#0891b2;--ok:#22c55e;--tab:#0b1220;--tb:#415269;--ta:#0ea5e9;
  --g1:#3b4a60;--g2:#0b1220;--good:#16a34a;--warn:#f59e0b;--bad:#ef4444;
  --gradient-1:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  --gradient-2:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);
  --gradient-3:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
  --gradient-4:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);
  --gradient-5:linear-gradient(135deg,#fa709a 0%,#fee140 100%);
  --shadow-lg:0 10px 40px rgba(0,0,0,.3);
  --shadow-xl:0 20px 60px rgba(0,0,0,.4);
}
html,body{height:auto}
body{margin:0;background:#020617;position:relative;overflow-x:hidden}
body::before{content:"";position:fixed;top:0;left:0;right:0;bottom:0;
  background:radial-gradient(1400px 700px at 20% -10%,rgba(56,189,248,.18),transparent 60%),
  radial-gradient(1000px 600px at 85% 0%,rgba(34,197,94,.14),transparent 60%),
  radial-gradient(800px 500px at 50% 100%,rgba(168,85,247,.12),transparent 60%),
  linear-gradient(180deg,#0f172a 0%,#020617 50%,#000000 100%);
  z-index:-1;pointer-events:none;animation:pulse 20s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:.8}50%{opacity:1}}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{opacity:0;transform:translateX(-30px)}to{opacity:1;transform:translateX(0)}}
@keyframes glow{0%,100%{box-shadow:0 0 20px rgba(56,189,248,.3)}50%{box-shadow:0 0 30px rgba(56,189,248,.6)}}

#hx{color:var(--t);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;-webkit-font-smoothing:antialiased}
#hx *{box-sizing:border-box}
.w{max-width:1200px;margin:22px auto 18px;padding:0 16px}
.c{background:rgba(15,23,42,.85);border:1px solid rgba(148,163,184,.2);border-radius:20px;padding:24px;margin:16px 0;
  backdrop-filter:blur(16px);box-shadow:var(--shadow-lg);animation:fadeIn .6s ease-out;
  transition:all .3s ease;position:relative;overflow:hidden}
.c::before{content:"";position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(56,189,248,.6),transparent);opacity:.5}
.c:hover{border-color:rgba(56,189,248,.4);box-shadow:var(--shadow-xl)}
.r{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.pill{background:var(--gradient-3);color:#001018;border-radius:24px;padding:10px 18px;font-weight:900;
  box-shadow:0 4px 15px rgba(56,189,248,.4);animation:glow 3s ease-in-out infinite;
  letter-spacing:.5px;text-transform:uppercase;font-size:.9rem}
.n{opacity:.95;font-size:.95rem;color:#cbd5e1;line-height:1.6}
.small{font-size:.88rem;color:#b6c2d3;line-height:1.5}

.tabs{display:flex;gap:10px;margin:16px 0;flex-wrap:wrap;animation:slideIn .7s ease-out}
.tab{border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.8);color:#cbd5e1;
  border-radius:999px;padding:10px 18px;cursor:pointer;font-weight:800;transition:all .2s ease;
  user-select:none;position:relative;overflow:hidden;font-size:.9rem;letter-spacing:.3px}
.tab::before{content:"";position:absolute;top:0;left:-100%;width:100%;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);
  transition:left .5s ease}
.tab:hover::before{left:100%}
.tab:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(56,189,248,.3)}
.tab.a{background:var(--gradient-3);color:#001018;border-color:#38bdf8;
  box-shadow:0 4px 15px rgba(56,189,248,.4);font-weight:900}
.tab.dis{opacity:.4;cursor:not-allowed;filter:grayscale(.4)}
.tab.dis:hover{transform:none;box-shadow:none}

.b{background:var(--gradient-3);color:#001018;border:0;border-radius:14px;padding:12px 20px;
  cursor:pointer;font-weight:900;transition:all .2s ease;box-shadow:0 4px 15px rgba(56,189,248,.3);
  font-size:.95rem;letter-spacing:.3px;position:relative;overflow:hidden}
.b::before{content:"";position:absolute;top:50%;left:50%;width:0;height:0;
  border-radius:50%;background:rgba(255,255,255,.3);transform:translate(-50%,-50%);
  transition:width .5s,height .5s}
.b:hover::before{width:300px;height:300px}
.b:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(56,189,248,.5)}
.b.ok{background:var(--gradient-4);color:#001018;box-shadow:0 4px 15px rgba(67,233,123,.3)}
.b.ok:hover{box-shadow:0 6px 20px rgba(67,233,123,.5)}
.b.dis{opacity:.4;cursor:not-allowed;filter:grayscale(.3);transform:none;pointer-events:none}

.g{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
@media(max-width:800px){.g{grid-template-columns:1fr}}
#hx input[type=text],#hx input[type=number],#hx select{width:100%;padding:12px 14px;border:1px solid rgba(148,163,184,.3);border-radius:12px;background:rgba(2,6,23,.85);color:var(--t);outline:none;transition:all .2s ease;font-size:.95rem}
#hx input[type=text]:focus,#hx input[type=number]:focus,#hx select:focus{border-color:#38bdf8;box-shadow:0 0 0 4px rgba(56,189,248,.15);background:rgba(2,6,23,.95)}
#hx input[type=checkbox]{width:auto;margin-right:8px;accent-color:#38bdf8;width:18px;height:18px;cursor:pointer}
#hx label{color:#cbd5e1;font-weight:600;margin-bottom:6px;display:block;font-size:.9rem;letter-spacing:.3px}

.gu{margin-top:12px;padding:14px 16px;background:rgba(56,189,248,.08);border:1px solid rgba(56,189,248,.25);border-radius:14px;color:#dbeafe;display:flex;gap:12px;align-items:flex-start;border-left:4px solid #38bdf8}
.gu .a{font-weight:900;line-height:1.2;margin-top:1px;font-size:1.2rem}

.k{background:linear-gradient(145deg,rgba(14,165,233,.12),rgba(6,182,212,.08));
  border:1px solid rgba(56,189,248,.35);border-radius:18px;padding:20px 16px;text-align:center;
  transition:all .3s ease;position:relative;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,.2)}
.k::before{content:"";position:absolute;top:-50%;left:-50%;width:200%;height:200%;
  background:radial-gradient(circle,rgba(56,189,248,.1),transparent 70%);
  transition:transform .6s ease;pointer-events:none}
.k:hover::before{transform:scale(1.2)}
.k:hover{border-color:rgba(56,189,248,.6);transform:translateY(-4px);box-shadow:0 8px 25px rgba(56,189,248,.25)}
.k span{color:#94a3b8;font-size:.82rem;font-weight:700;text-transform:uppercase;
  letter-spacing:.8px;display:block;position:relative;z-index:1}
.k b{font-size:32px;display:block;color:#f1f5f9;margin-top:10px;font-weight:900;
  position:relative;z-index:1;text-shadow:0 2px 10px rgba(0,0,0,.3)}

.tst{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:rgba(2,6,23,.92);border:1px solid rgba(148,163,184,.35);color:var(--t);padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none;transition:.2s;z-index:99999}
.tst.s{opacity:1}

.sig{max-width:1100px;margin:10px auto 18px;padding:10px 12px;color:#a5b4fc;background:rgba(10,16,28,.65);border:1px solid rgba(148,163,184,.25);border-radius:12px;display:flex;gap:12px;align-items:center;justify-content:space-between;font-size:.95rem}
.sig .br{font-weight:950;color:#e2e8f0}
.sig a{color:#93c5fd;text-decoration:none}.sig a:hover{text-decoration:underline}

/* cards */
.cardx{margin-top:16px;background:linear-gradient(135deg,rgba(15,23,42,.85),rgba(11,18,32,.9));border:1px solid rgba(148,163,184,.25);border-radius:16px;padding:20px;box-shadow:0 4px 20px rgba(0,0,0,.2)}
.cardx .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;padding-bottom:16px;border-bottom:1px solid rgba(148,163,184,.15)}
.cardx .title{font-weight:950;color:#f1f5f9;font-size:1.15rem}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{border:1px solid rgba(148,163,184,.3);background:rgba(11,18,32,.8);color:#cbd5e1;border-radius:999px;padding:8px 14px;font-weight:700;font-size:.85rem;transition:.15s}
.chip:hover{transform:translateY(-1px)}
.chip.good{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.12);color:#86efac}
.chip.bad{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.12);color:#fca5a5}
.chip.warn{border-color:rgba(245,158,11,.45);background:rgba(245,158,11,.12);color:#fde68a}
.chip.neu{border-color:rgba(148,163,184,.35);color:#e2e8f0}
.body{margin-top:16px;color:#cbd5e1;line-height:1.6;font-size:.95rem}
.body b{color:#f8fafc;font-weight:700}
.grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:16px}
@media(max-width:900px){.grid3{grid-template-columns:1fr}}
.mini{background:linear-gradient(135deg,rgba(14,165,233,.08),rgba(6,182,212,.05));border:1px solid rgba(148,163,184,.25);border-radius:14px;padding:14px;transition:.15s}
.mini:hover{border-color:rgba(56,189,248,.4);transform:translateY(-1px)}
.mini .h{color:#94a3b8;font-size:.82rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.mini .v{font-weight:900;color:#f8fafc;margin-top:6px;font-size:1.1rem}
.note{margin-top:16px;color:#cbd5e1;white-space:pre-wrap;background:rgba(2,6,23,.6);padding:16px;border-radius:12px;border:1px solid rgba(148,163,184,.2);line-height:1.7;font-size:.92rem}

/* mapa real */
#zoneWrap{margin-top:12px}
#zmap{height:380px;border-radius:12px;border:1px solid rgba(148,163,184,.22);overflow:hidden;max-width:100%}
.pchips{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.pchip{border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.7);color:#cbd5e1;border-radius:999px;padding:6px 10px;font-weight:950;font-size:.85rem;cursor:pointer}
.pchip.on{border-color:#38bdf8;color:#dbeafe}
.pchip.off{opacity:.75}

/* "pin" */
.pinWrap{position:relative;width:26px;height:26px;transform:translate(-50%,-100%)}
.pin{
  width:18px;height:18px;background:#ef4444;border:2px solid #7f1d1d;border-radius:18px 18px 18px 0;
  transform:rotate(-45deg);position:absolute;left:4px;top:4px;
  box-shadow:0 2px 10px rgba(0,0,0,.35);
}
.pin::after{content:"";width:7px;height:7px;background:#fff;border-radius:999px;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) rotate(45deg)}
.pin.off{opacity:.42;filter:grayscale(.15)}
.pin.on{opacity:1}

/* header row */
.hrow{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.lang{display:flex;gap:10px;align-items:center}
.langbtn{border:1px solid rgba(148,163,184,.3);background:rgba(11,18,32,.85);color:#cbd5e1;border-radius:999px;padding:8px 14px;font-weight:800;cursor:pointer;transition:all .2s ease;font-size:.85rem;letter-spacing:.5px}
.langbtn:hover{border-color:rgba(56,189,248,.5);transform:translateY(-1px)}
.langbtn.a{background:var(--gradient-3);color:#001018;border-color:#38bdf8;box-shadow:0 4px 15px rgba(56,189,248,.3)}
/* progress bars DTI/RTI */
.pbar-wrap{margin-top:8px;background:rgba(255,255,255,.07);border-radius:999px;height:8px;overflow:hidden}
.pbar{height:8px;border-radius:999px;transition:width .9s cubic-bezier(.4,0,.2,1)}
.pbar.good{background:linear-gradient(90deg,#22c55e,#4ade80)}
.pbar.warn{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.pbar.bad{background:linear-gradient(90deg,#ef4444,#f87171)}
/* tooltip */
.tip{position:relative;display:inline-flex;align-items:center;gap:4px}
.tip-icon{width:16px;height:16px;border-radius:50%;background:rgba(148,163,184,.25);color:#94a3b8;font-size:10px;font-weight:900;cursor:help;display:inline-flex;align-items:center;justify-content:center;border:1px solid rgba(148,163,184,.3);flex-shrink:0;user-select:none}
.tip-box{position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#0f172a;border:1px solid rgba(56,189,248,.35);border-radius:10px;padding:10px 14px;color:#cbd5e1;font-size:.82rem;line-height:1.5;width:220px;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,.5);pointer-events:none;opacity:0;transition:opacity .15s}
.tip:hover .tip-box,.tip:focus-within .tip-box{opacity:1}
/* step indicator */
.steps{display:flex;align-items:center;margin-bottom:16px;animation:fadeIn .5s ease-out}
.step{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1;position:relative}
.step-dot{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:.85rem;transition:all .3s ease;border:2px solid rgba(148,163,184,.25);background:rgba(11,18,32,.8);color:#94a3b8;z-index:1}
.step.done .step-dot{background:var(--gradient-4);color:#001018;border-color:#22c55e;box-shadow:0 0 12px rgba(34,197,94,.4)}
.step.active .step-dot{background:var(--gradient-3);color:#001018;border-color:#38bdf8;box-shadow:0 0 12px rgba(56,189,248,.5)}
.step-label{font-size:.72rem;color:#475569;font-weight:700;text-align:center;white-space:nowrap}
.step.done .step-label,.step.active .step-label{color:#94a3b8}
.step-line{position:absolute;top:15px;left:calc(50% + 17px);width:calc(100% - 34px);height:2px;background:rgba(148,163,184,.15);transition:background .4s;z-index:0}
.step.done .step-line{background:rgba(34,197,94,.35)}
/* share bar */
.share-bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;padding-top:12px;border-top:1px solid rgba(148,163,184,.12)}
.share-btn{border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.8);color:#cbd5e1;border-radius:10px;padding:8px 14px;cursor:pointer;font-weight:700;font-size:.82rem;transition:all .2s ease;display:flex;align-items:center;gap:6px}
.share-btn:hover{transform:translateY(-2px)}
.share-btn.wa{border-color:rgba(37,211,102,.4);color:#4ade80}
.share-btn.wa:hover{background:rgba(37,211,102,.1);box-shadow:0 4px 12px rgba(37,211,102,.2)}
.share-btn.cl{border-color:rgba(56,189,248,.4);color:#7dd3fc}
.share-btn.cl:hover{background:rgba(56,189,248,.1);box-shadow:0 4px 12px rgba(56,189,248,.2)}
/* field validation */
#hx input.field-ok{border-color:rgba(34,197,94,.5)!important}
#hx input.field-err{border-color:rgba(239,68,68,.5)!important;box-shadow:0 0 0 3px rgba(239,68,68,.1)!important}
.field-hint{font-size:.78rem;margin-top:4px;min-height:16px;transition:all .2s}
.field-hint.ok{color:#4ade80}
.field-hint.err{color:#f87171}
/* rango multi-zona */
.range-bar{display:flex;gap:6px;align-items:center;margin-top:5px;flex-wrap:wrap}
.range-tag{font-size:.75rem;border-radius:8px;padding:2px 7px;font-weight:700}
.range-tag.lo{background:rgba(34,197,94,.12);color:#86efac;border:1px solid rgba(34,197,94,.25)}
.range-tag.hi{background:rgba(239,68,68,.12);color:#fca5a5;border:1px solid rgba(239,68,68,.25)}
/* ahorro countdown */
.countdown{margin-top:10px;padding:12px 14px;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);border-radius:12px;border-left:4px solid #f59e0b;color:#fde68a;font-size:.88rem;line-height:1.6}
</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
</head>

<body>
<div class="w" id="hx">
  <div class="c hrow">
    <div class="pill" data-i="hdrTitle">Assessoria d'Habitatge ¬∑ Baix Pened√®s</div>
    <div class="r" style="justify-content:flex-end;flex:1">
      <div class="n" data-i="hdrHint">Ejemplos reales: solo despu√©s de Analizar.</div>
      <div class="lang" aria-label="Idioma">
        <button class="langbtn" id="L_CA" type="button">CA</button>
        <button class="langbtn a" id="L_ES" type="button">ES</button>
        <button class="langbtn" id="L_EN" type="button">EN</button>
      </div>
    </div>
  </div>

  <div class="steps" id="stepBar">
    <div class="step active" id="stp1"><div class="step-dot" id="sdot1">1</div><div class="step-label" id="slbl1">Personal</div><div class="step-line"></div></div>
    <div class="step" id="stp2"><div class="step-dot" id="sdot2">2</div><div class="step-label" id="slbl2">Econom&#237;a</div><div class="step-line"></div></div>
    <div class="step" id="stp3"><div class="step-dot" id="sdot3">3</div><div class="step-label" id="slbl3">Preferencias</div><div class="step-line"></div></div>
    <div class="step" id="stp4"><div class="step-dot" id="sdot4">4</div><div class="step-label" id="slbl4">Resultado</div></div>
  </div>
  <div class="tabs">
    <div id="t_p" class="tab a" data-i="tab1">1 Personal</div>
    <div id="t_e" class="tab" data-i="tab2">2 Econom√≠a</div>
    <div id="t_f" class="tab" data-i="tab3">3 Preferencias</div>
    <div id="t_r" class="tab" data-i="tab4">4 Resultado</div>
    <div id="t_m" class="tab" data-i="tab5">5 Comparador</div>
    <div id="t_x" class="tab" data-i="tab6">6 Ejemplos reales</div>
  </div>

  <div class="c" data-p="p">
    <div class="g">
      <div><label data-i="lblName">Nombre y apellidos</label><input id="nm" type="text" autocomplete="name"></div>
      <div><label data-i="lblAge">Edad (18‚Äì100)</label><input id="ag" type="number" min="18" max="100"></div>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintP">Rellena los datos b√°sicos para continuar.</div></div>
    <div class="r" style="margin-top:10px"><button class="b" id="np" type="button" data-i="btnContinue">Continuar</button></div>
  </div>

  <div class="c" data-p="e" style="display:none">
    <div class="g">
      <div><label data-i="lblInc">Ingresos mensuales (‚Ç¨) <span class="tip"><span class="tip-icon">?</span><span class="tip-box">Suma todos los ingresos netos mensuales. Si hay dos titulares, s&#250;malos.</span></span></label><input id="inc" type="number" min="0"><div class="field-hint" id="hint-inc"></div></div>
      <div><label data-i="lblSav">Ahorros disponibles (‚Ç¨) <span class="tip"><span class="tip-icon">?</span><span class="tip-box">Dinero l&#237;quido real hoy. Necesitar&#225;s 10&#8211;20% de entrada + ~10% en gastos (notar√≠a, ITP&#8230;).</span></span></label><input id="sav" type="number" min="0"><div class="field-hint" id="hint-sav"></div></div>
      <div><label data-i="lblYrs">A√±os de hipoteca (5‚Äì40)</label><input id="yrs" type="number" min="5" max="40"></div>
      <div><label data-i="lblHor">¬øVivir√°s m√°s de 5 a√±os aqu√≠?</label><select id="hor"><option value="y" data-i="yes">S√≠</option><option value="n" data-i="no">No</option></select></div>
      <div><label data-i="lblFst">¬øPrimera vivienda o familia con menores?</label><select id="fst"><option value="y" data-i="yes">S√≠</option><option value="n" data-i="no">No</option></select></div>
      <div><label data-i="lblMsv">Ahorro mensual (‚Ç¨) <span class="tip"><span class="tip-icon">?</span><span class="tip-box">Cu√°nto puedes ahorrar cada mes. Sirve para calcular en cu&#225;nto tiempo llegar&#237;as al objetivo de compra.</span></span></label><input id="msv" type="number" min="0"></div>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintE">Completa econom√≠a y sigue a preferencias.</div></div>
    <div class="r" style="margin-top:10px"><button class="b" id="ne" type="button" data-i="btnContinue">Continuar</button></div>
  </div>

  <div class="c" data-p="f" style="display:none">
    <div class="g">
      <div>
        <label data-i="lblMuni">Municipio (Baix Pened√®s)</label>
        <select id="ar">
          <option value="*">Cualquiera</option>
          <option>Cunit</option><option>El Vendrell</option><option>Calafell</option><option>Santa Oliva</option><option>Bellvei</option>
          <option>L'Arbo√ß</option><option>Banyeres del Pened√®s</option><option>Albinyana</option><option>Bonastre</option><option>Maslloren√ß</option>
          <option>La Bisbal del Pened√®s</option><option>Lloren√ß del Pened√®s</option><option>Sant Jaume dels Domenys</option><option>El Montmell</option>
        </select>
        <div class="small" style="margin-top:6px" data-i="lblMuniHelp">Si usas el mapa puedes elegir varios municipios para 'Ejemplos reales'.</div>
      </div>
      <div><label data-i="lblM2">Metros cuadrados (‚â•50)</label><input id="m2" type="number" min="50"><div class="field-hint" id="hint-m2"></div></div>
      <div><label data-i="lblBed">Habitaciones</label><input id="bed" type="number" min="0" max="10"></div>
      <div><label data-i="lblBath">Ba√±os</label><input id="bat" type="number" min="1" max="10"></div>
      <div><label data-i="lblType">Tipo de vivienda</label><select id="ty"><option value="flat" data-i="optFlat">Piso</option><option value="house" data-i="optHouse">Casa</option></select></div>
      <div class="r">
        <label><input type="checkbox" id="et"><span data-i="exTer">Terraza</span></label>
        <label><input type="checkbox" id="ep"><span data-i="exPis">Piscina</span></label>
        <label><input type="checkbox" id="el"><span data-i="exAsc">Ascensor</span></label>
        <label><input type="checkbox" id="ek"><span data-i="exGar">Aparcamiento</span></label>
      </div>
    </div>

    <div class="r" style="margin-top:10px">
      <button class="b" id="go" type="button" data-i="btnAnalyze">Analizar</button>
      <button class="b ok" id="toggleMap" type="button" data-i="btnMap">Mapa (zona real)</button>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintF">Si cambias preferencias, vuelve a Analizar para actualizar el resultado.</div></div>

    <div id="zoneWrap" class="cardx" style="display:none">
      <div class="top">
        <div>
          <div class="title" data-i="zoneTitle">Zona preferida (mapa real)</div>
          <div class="n" data-i="zoneHint">Haz clic en un pin para seleccionar municipios. Puedes elegir varios del Baix Pened√®s.</div>
          <div class="n" id="zoneNote" style="margin-top:6px">Seleccionados: ninguno</div>
        </div>
        <div class="pchips" id="zoneChips"></div>
      </div>

      <div class="r" style="margin-top:10px;justify-content:flex-end">
        <button class="b" id="zoneClear" type="button" data-i="btnClear">Limpiar</button>
        <button class="b ok" id="zoneApply" type="button" data-i="btnUse">Usar en Ejemplos reales</button>
      </div>

      <div id="zmap" style="margin-top:10px"></div>
      <div class="n" id="zoneApplied" style="margin-top:10px"></div>
    </div>
  </div>

  <div class="c" data-p="r" style="display:none">
    <div class="g">
      <div class="k"><span data-i="kPrice">Precio estimado</span><b id="k1">0 ‚Ç¨</b></div>
      <div class="k"><span data-i="kRent">Alquiler estimado</span><b id="k2">0 ‚Ç¨</b></div>
      <div class="k"><span data-i="kPay">Cuota hipoteca</span><b id="k3">0 ‚Ç¨</b></div>
      <div class="k"><span data-i="kRec">Recomendaci√≥n</span><b id="k4">‚Äì</b></div>
    </div>

    <div id="rCard" class="cardx" style="display:none">
      <div class="top">
        <div class="title" id="rTitle"></div>
        <div class="chips" id="rChips"></div>
      </div>
      <div class="grid3" id="rMini"></div>
      <div class="body" id="rBody"></div>
      <div class="note" id="rt"></div>
    </div>

    <div class="r" style="margin-top:10px">
      <button class="b" id="cp" type="button" data-i="btnCopy">Copiar resumen</button>
      <button class="b" id="rs" type="button" data-i="btnReset">Reiniciar</button>
    </div>
    <div class="share-bar">
      <button class="share-btn wa" id="shareWa" type="button">&#128241; WhatsApp</button>
      <button class="share-btn cl" id="shareCl" type="button">&#128203; Copiar</button>
    </div>
  </div>

  <div class="c" data-p="m" style="display:none">
    <div class="g">
      <div><label data-i="lblProv">Provincia (comparador)</label><select id="cm"><option>Barcelona</option><option>Girona</option><option>Lleida</option><option>Tarragona</option></select></div>
      <div><label data-i="lblM2s">m¬≤</label><input id="cm2" type="number" min="50"></div>
      <div><label data-i="lblBed">Habitaciones</label><input id="cbd" type="number" min="0" max="10"></div>
      <div><label data-i="lblBath">Ba√±os</label><input id="cba" type="number" min="1" max="10"></div>
      <div><label data-i="lblType2">Tipo</label><select id="cty"><option value="flat" data-i="optFlat">Piso</option><option value="house" data-i="optHouse">Casa</option></select></div>
      <div class="r">
        <label><input type="checkbox" id="ct"><span data-i="exTer">Terraza</span></label>
        <label><input type="checkbox" id="cp0"><span data-i="exPis">Piscina</span></label>
        <label><input type="checkbox" id="cl0"><span data-i="exAsc">Ascensor</span></label>
        <label><input type="checkbox" id="ck0"><span data-i="exGar">Aparcamiento</span></label>
      </div>
    </div>
    <div id="cmap" style="width:100%;height:320px;border:0;border-radius:12px;margin-top:12px"></div>
    <div class="r" style="margin-top:10px">
      <button class="b" id="bc" type="button" data-i="btnCompare">Comparar</button>
      <button class="b ok" id="autoFillCmp" type="button" data-i="btnUseMine">Usar mis datos</button>
    </div>
    <div class="n" id="cmg" style="margin-top:10px"></div>
  </div>

  <div class="c" data-p="x" style="display:none">
    <div class="n" id="xinfo"></div>
    <div class="r" style="margin-top:10px" id="xbtns"></div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintX">Si elegiste varios municipios, salen botones por municipio (Idealista no soporta multi-municipio en 1 sola URL).</div></div>
  </div>
</div>

<div class="sig">
  <div class="br">Assessoria d'Habitatge</div>
  <div>
    <a href="https://www.assesoriahabitatge.com/" target="_blank" rel="noopener">assesoriahabitatge.com</a> ¬∑
    <a href="/cdn-cgi/l/email-protection#1b52757d745b7a68687e687469727a737a79726f7a6f7c7e35787476"><span class="__cf_email__" data-cfemail="5f163139301f3e2c2c3a2c302d363e373e3d362b3e2b383a713c3032">[email&#160;protected]</span></a>
  </div>
</div>

<div id="ts" class="tst" role="status" aria-live="polite"></div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// Esperar a que Leaflet se cargue con timeout de seguridad
let attempts = 0;
const maxAttempts = 100; // 5 segundos m√°ximo

function waitForLeaflet() {
  if (typeof L !== 'undefined') {
    // Leaflet est√° listo, ejecutar c√≥digo
    initApp();
  } else if (attempts < maxAttempts) {
    attempts++;
    setTimeout(waitForLeaflet, 50);
  } else {
    console.error('Leaflet no se pudo cargar despu√©s de 5 segundos');
    alert('Error: No se pudo cargar el mapa. Por favor recarga la p√°gina.');
  }
}

function initApp() {
(()=> {
  const Q=s=>document.querySelector(s);
  const QA=s=>[...document.querySelectorAll(s)];
  const fmtES=n=>Math.round(n).toLocaleString("es-ES");
  const fmtEN=n=>Math.round(n).toLocaleString("en-US");
  const pctEN=n=>Number(n).toFixed(1)+"%";
  const pctES=n=>Number(n).toFixed(1)+"%";

  const STORE_KEY="hx_form_v7";
  const ZONE_KEY="hx_zoneSel_v4";
  const LANG_KEY="hx_lang";

  const I18N={
    ES:{
      hdrTitle:"Assessoria d'Habitatge ¬∑ Baix Pened√®s",
      hdrHint:"Ejemplos reales: solo despu√©s de Analizar.",
      tab1:"1 Personal",tab2:"2 Econom√≠a",tab3:"3 Preferencias",tab4:"4 Resultado",tab5:"5 Comparador",tab6:"6 Ejemplos reales",
      lblName:"Nombre y apellidos",lblAge:"Edad (18‚Äì100)",btnContinue:"Continuar",
      hintP:"Rellena los datos b√°sicos para continuar.",
      lblInc:"Ingresos mensuales (‚Ç¨)",lblSav:"Ahorros disponibles (‚Ç¨)",lblYrs:"A√±os de hipoteca (5‚Äì40)",lblHor:"¬øVivir√°s m√°s de 5 a√±os aqu√≠?",lblFst:"¬øPrimera vivienda o familia con menores?",lblMsv:"Ahorro mensual (‚Ç¨)",
      hintE:"Completa econom√≠a y sigue a preferencias.",
      lblMuni:"Municipio (Baix Pened√®s)",lblMuniHelp:"Si usas el mapa puedes elegir varios municipios para 'Ejemplos reales'.",
      lblM2:"Metros cuadrados (‚â•50)",lblBed:"Habitaciones",lblBath:"Ba√±os",lblType:"Tipo de vivienda",optFlat:"Piso",optHouse:"Casa",
      exTer:"Terraza",exPis:"Piscina",exAsc:"Ascensor",exGar:"Aparcamiento",
      btnAnalyze:"Analizar",btnMap:"Mapa (zona real)",hintF:"Si cambias preferencias, vuelve a Analizar para actualizar el resultado.",
      zoneTitle:"Zona preferida (mapa real)",zoneHint:"Haz clic en un pin para seleccionar municipios. Puedes elegir varios del Baix Pened√®s.",
      btnClear:"Limpiar",btnUse:"Usar en Ejemplos reales",
      kPrice:"Precio estimado",kRent:"Alquiler estimado",kPay:"Cuota hipoteca",kRec:"Recomendaci√≥n",
      btnCopy:"Copiar resumen",btnReset:"Reiniciar",
      lblProv:"Provincia (comparador)",lblM2s:"m¬≤",lblType2:"Tipo",btnCompare:"Comparar",btnUseMine:"Usar mis datos",
      hintX:"Si elegiste varios municipios, salen botones por municipio (Idealista no soporta multi-municipio en 1 sola URL).",
      yes:"S√≠",no:"No",

      // Recomendaciones traducidas
      recBuy:"COMPRAR",
      recRent:"ALQUILAR",
      recNotFeasible:"NO FACTIBLE",

      // din√°micos JS
      toastCheckNameAge:"Revisa nombre/edad",
      toastFirstAnalyze:"Primero analiza.",
      toastPrefsChanged:"Preferencias cambiadas: vuelve a Analizar.",
      toastNoLink:"No se pudo generar el link",
      toastCopied:"Copiado",
      toastZoneCleared:"Zona limpiada",
      toastNoZone:"No hay municipios seleccionados",
      toastZoneApplied:"Zona aplicada a Ejemplos reales",
      stateReady:"‚úÖ Disponible",
      stateNeedAnalyze:"‚õî Requiere Analizar / re-Analizar",
      xInfo:"Municipio (Preferencias): {muni} ¬∑ Estado: {state}.",
      sumTitle:"Resumen claro ¬∑ {rec}",
      chipMort:"Esfuerzo hipoteca: {pct}",
      chipRent:"Esfuerzo alquiler: {pct}",
      chipCash:"Entrada+gastos: {eur}",
      chipRate:"Tipo: {rate}",
      miniPrice:"Precio estimado",
      miniPay:"Cuota hipoteca",
      miniRent:"Alquiler estimado",
      bodyPrefs:"Preferencias: {muni} ¬∑ {m2} m¬≤ ¬∑ {bed} hab ¬∑ {bath} ba√±os ¬∑ {type}",
      reportHello:"Hola {name},",
      reportPrice:"Precio estimado: {eur}.",
      reportHome:"Vivienda: {muni} ¬∑ {m2} m¬≤ ¬∑ {bed} hab ¬∑ {bath} ba√±os ¬∑ {type}.",
      reportDown:"Entrada: {dp}% ‚Üí {down} ‚Ç¨ ¬∑ Gastos: {cl} ‚Ç¨.",
      reportFin:"A financiar: {cap} ‚Ç¨ ¬∑ Plazo: {yrs} a√±os ¬∑ Tipo: {rate}.",
      reportPay:"Cuota hipoteca: {pay} ‚Ç¨ ¬∑ Alquiler: {rent} ‚Ç¨.",
      reportRec:"Recomendaci√≥n: {rec}",
      any:"Cualquiera",
      btnCopy2:"Copiar",
      savingsOk:"\u2705 Ahorros suficientes para la entrada.",
      yearsToSave:"Con {msv}/mes, alcanzar\u00e1s el objetivo en ~{yrs} a\u00f1os ({mos} meses).",
      itpNote:"En Catalunya, la compraventa tributa un 10% de ITP + ~1% en gastos de notar\u00eda y registro. Ya incluido en los gastos de cierre estimados.",
      avgZone:"Media de {n} municipios",
      priceRange:"Rango: {lo} \u2013 {hi}",
      stepPersonal:"Personal",stepEco:"Econom\u00eda",stepPref:"Preferencias",stepRes:"Resultado",
      
      // Comparador mejorado
      cmpCheaper:"m√°s barato",
      cmpExpensive:"m√°s caro",
      cmpSame:"igual",
      cmpExplain:"Esto significa que {typeText} en {prov} es {diff} {direction} que en tu zona (Baix Pened√®s). La diferencia de precio es de {absDiff}, lo que representa un {pct} {direction2}.",
      cmpContext:"En {prov}, el precio medio por m¬≤ es de {avgM2}. Si aplicas las mismas caracter√≠sticas que buscas (tama√±o, habitaciones, extras), el coste total ser√≠a de {total}.",
      cmpRent:"El alquiler mensual estimado en {prov} ser√≠a de {rent}, comparado con {yourRent} en tu zona.",
      cmpAdvice:"üí° Esto puede ayudarte a decidir si vale la pena buscar en otras provincias seg√∫n tu presupuesto y necesidades de movilidad."
    },
    CA:{
      hdrTitle:"Assessoria d'Habitatge ¬∑ Baix Pened√®s",
      hdrHint:"Exemples reals: nom√©s despr√©s d'Analitzar.",
      tab1:"1 Personal",tab2:"2 Economia",tab3:"3 Prefer√®ncies",tab4:"4 Resultat",tab5:"5 Comparador",tab6:"6 Exemples reals",
      lblName:"Nom i cognoms",lblAge:"Edat (18‚Äì100)",btnContinue:"Continuar",
      hintP:"Omple les dades b√†siques per continuar.",
      lblInc:"Ingressos mensuals (‚Ç¨)",lblSav:"Estalvis disponibles (‚Ç¨)",lblYrs:"Anys d'hipoteca (5‚Äì40)",lblHor:"Viur√†s m√©s de 5 anys aqu√≠?",lblFst:"Primera vivenda o fam√≠lia amb menors?",lblMsv:"Estalvi mensual (‚Ç¨)",
      hintE:"Completa economia i passa a prefer√®ncies.",
      lblMuni:"Municipi (Baix Pened√®s)",lblMuniHelp:"Si uses el mapa pots triar diversos municipis per als 'Exemples reals'.",
      lblM2:"Metres quadrats (‚â•50)",lblBed:"Habitacions",lblBath:"Banys",lblType:"Tipus d'habitatge",optFlat:"Pis",optHouse:"Casa",
      exTer:"Terrassa",exPis:"Piscina",exAsc:"Ascensor",exGar:"Aparcament",
      btnAnalyze:"Analitzar",btnMap:"Mapa (zona real)",hintF:"Si canvies prefer√®ncies, torna a Analitzar per actualitzar el resultat.",
      zoneTitle:"Zona preferida (mapa real)",zoneHint:"Clica un pin per seleccionar municipis. Pots triar-ne diversos del Baix Pened√®s.",
      btnClear:"Netejar",btnUse:"Usar a Exemples reals",
      kPrice:"Preu estimat",kRent:"Lloguer estimat",kPay:"Quota hipoteca",kRec:"Recomanaci√≥",
      btnCopy:"Copiar resum",btnReset:"Reiniciar",
      lblProv:"Prov√≠ncia (comparador)",lblM2s:"m¬≤",lblType2:"Tipus",btnCompare:"Comparar",btnUseMine:"Usar les meves dades",
      hintX:"Si has triat diversos municipis, surten botons per municipi (Idealista no admet multi-municipi en 1 sola URL).",
      yes:"S√≠",no:"No",

      recBuy:"COMPRAR",
      recRent:"LLOGAR",
      recNotFeasible:"NO FACTIBLE",

      toastCheckNameAge:"Revisa nom/edat",
      toastFirstAnalyze:"Primer analitza.",
      toastPrefsChanged:"Prefer√®ncies canviades: torna a Analitzar.",
      toastNoLink:"No s'ha pogut generar l'enlla√ß",
      toastCopied:"Copiat",
      toastZoneCleared:"Zona netejada",
      toastNoZone:"No hi ha municipis seleccionats",
      toastZoneApplied:"Zona aplicada a Exemples reals",
      stateReady:"‚úÖ Disponible",
      stateNeedAnalyze:"‚õî Cal Analitzar / re-Analitzar",
      xInfo:"Municipi (Prefer√®ncies): {muni} ¬∑ Estat: {state}.",
      sumTitle:"Resum clar ¬∑ {rec}",
      chipMort:"Esfor√ß hipoteca: {pct}",
      chipRent:"Esfor√ß lloguer: {pct}",
      chipCash:"Entrada+despeses: {eur}",
      chipRate:"Tipus: {rate}",
      miniPrice:"Preu estimat",
      miniPay:"Quota hipoteca",
      miniRent:"Lloguer estimat",
      bodyPrefs:"Prefer√®ncies: {muni} ¬∑ {m2} m¬≤ ¬∑ {bed} hab ¬∑ {bath} banys ¬∑ {type}",
      reportHello:"Hola {name},",
      reportPrice:"Preu estimat: {eur}.",
      reportHome:"Habitatge: {muni} ¬∑ {m2} m¬≤ ¬∑ {bed} hab ¬∑ {bath} banys ¬∑ {type}.",
      reportDown:"Entrada: {dp}% ‚Üí {down} ‚Ç¨ ¬∑ Despeses: {cl} ‚Ç¨.",
      reportFin:"A finan√ßar: {cap} ‚Ç¨ ¬∑ Termini: {yrs} anys ¬∑ Tipus: {rate}.",
      reportPay:"Quota hipoteca: {pay} ‚Ç¨ ¬∑ Lloguer: {rent} ‚Ç¨.",
      reportRec:"Recomanaci√≥: {rec}",
      any:"Qualsevol",
      btnCopy2:"Copiar",
      savingsOk:"\u2705 Estalvis suficients per a l'entrada.",
      yearsToSave:"Estalviant {msv}/mes, arribar\u00e0s a l'objectiu en ~{yrs} anys ({mos} mesos).",
      itpNote:"A Catalunya, la compravenda tributa un 10% d'ITP + ~1% en despeses de notaria i registre. Incl\u00f2s a les despeses de tancament estimades.",
      avgZone:"Mitjana de {n} municipis",
      priceRange:"Rang: {lo} \u2013 {hi}",
      stepPersonal:"Personal",stepEco:"Economia",stepPref:"Prefer\u00e8ncies",stepRes:"Resultat",
      
      cmpCheaper:"m√©s barat",
      cmpExpensive:"m√©s car",
      cmpSame:"igual",
      cmpExplain:"Aix√≤ vol dir que {typeText} a {prov} √©s {diff} {direction} que a la teva zona (Baix Pened√®s). La difer√®ncia de preu √©s de {absDiff}, que representa un {pct} {direction2}.",
      cmpContext:"A {prov}, el preu mitj√† per m¬≤ √©s de {avgM2}. Si apliques les mateixes caracter√≠stiques que busques (mida, habitacions, extres), el cost total seria de {total}.",
      cmpRent:"El lloguer mensual estimat a {prov} seria de {rent}, comparat amb {yourRent} a la teva zona.",
      cmpAdvice:"üí° Aix√≤ et pot ajudar a decidir si val la pena buscar a altres prov√≠ncies segons el teu pressupost i necessitats de mobilitat."
    },
    EN:{
      hdrTitle:"Housing Advisor ¬∑ Baix Pened√®s",
      hdrHint:"Real examples: only after Analyze.",
      tab1:"1 Personal",tab2:"2 Finance",tab3:"3 Preferences",tab4:"4 Result",tab5:"5 Comparator",tab6:"6 Real examples",
      lblName:"Full name",lblAge:"Age (18‚Äì100)",btnContinue:"Continue",
      hintP:"Fill in the basics to continue.",
      lblInc:"Monthly income (‚Ç¨)",lblSav:"Available savings (‚Ç¨)",lblYrs:"Mortgage years (5‚Äì40)",lblHor:"Living here > 5 years?",lblFst:"First home or family with minors?",lblMsv:"Monthly savings (‚Ç¨)",
      hintE:"Complete finance and move to preferences.",
      lblMuni:"Town (Baix Pened√®s)",lblMuniHelp:"Using the map you can pick multiple towns for 'Real examples'.",
      lblM2:"Square meters (‚â•50)",lblBed:"Bedrooms",lblBath:"Bathrooms",lblType:"Property type",optFlat:"Flat",optHouse:"House",
      exTer:"Terrace",exPis:"Pool",exAsc:"Elevator",exGar:"Parking",
      btnAnalyze:"Analyze",btnMap:"Map (real area)",hintF:"If you change preferences, analyze again to refresh results.",
      zoneTitle:"Preferred area (real map)",zoneHint:"Click a pin to select towns. You can pick multiple towns in Baix Pened√®s.",
      btnClear:"Clear",btnUse:"Use in Real examples",
      kPrice:"Estimated price",kRent:"Estimated rent",kPay:"Mortgage payment",kRec:"Recommendation",
      btnCopy:"Copy summary",btnReset:"Reset",
      lblProv:"Province (comparator)",lblM2s:"m¬≤",lblType2:"Type",btnCompare:"Compare",btnUseMine:"Use my data",
      hintX:"If you chose multiple towns, you get buttons per town (Idealista doesn't support multi-town in one URL).",
      yes:"Yes",no:"No",

      recBuy:"BUY",
      recRent:"RENT",
      recNotFeasible:"NOT FEASIBLE",

      toastCheckNameAge:"Check name/age",
      toastFirstAnalyze:"Analyze first.",
      toastPrefsChanged:"Preferences changed: analyze again.",
      toastNoLink:"Could not generate the link",
      toastCopied:"Copied",
      toastZoneCleared:"Area cleared",
      toastNoZone:"No towns selected",
      toastZoneApplied:"Area applied to Real examples",
      stateReady:"‚úÖ Ready",
      stateNeedAnalyze:"‚õî Please Analyze / re-Analyze",
      xInfo:"Town (Preferences): {muni} ¬∑ Status: {state}.",
      sumTitle:"Clear summary ¬∑ {rec}",
      chipMort:"Mortgage effort: {pct}",
      chipRent:"Rent effort: {pct}",
      chipCash:"Cash needed: {eur}",
      chipRate:"Rate: {rate}",
      miniPrice:"Estimated price",
      miniPay:"Mortgage payment",
      miniRent:"Estimated rent",
      bodyPrefs:"Preferences: {muni} ¬∑ {m2} m¬≤ ¬∑ {bed} bd ¬∑ {bath} ba ¬∑ {type}",
      reportHello:"Hi {name},",
      reportPrice:"Estimated price: {eur}.",
      reportHome:"Home: {muni} ¬∑ {m2} m¬≤ ¬∑ {bed} bd ¬∑ {bath} ba ¬∑ {type}.",
      reportDown:"Down payment: {dp}% ‚Üí {down} ‚Ç¨ ¬∑ Costs: {cl} ‚Ç¨.",
      reportFin:"To finance: {cap} ‚Ç¨ ¬∑ Term: {yrs} years ¬∑ Rate: {rate}.",
      reportPay:"Mortgage: {pay} ‚Ç¨ ¬∑ Rent: {rent} ‚Ç¨.",
      reportRec:"Recommendation: {rec}",
      any:"Any",
      btnCopy2:"Copy",
      savingsOk:"\u2705 Savings are sufficient for the down payment.",
      yearsToSave:"Saving {msv}/mo, you'll reach the goal in ~{yrs} years ({mos} months).",
      itpNote:"In Catalunya, property purchase tax is ~10% ITP + ~1% notary/registry fees. Already included in the estimated closing costs.",
      avgZone:"Average of {n} towns",
      priceRange:"Range: {lo} \u2013 {hi}",
      stepPersonal:"Personal",stepEco:"Finance",stepPref:"Preferences",stepRes:"Result",
      
      cmpCheaper:"cheaper",
      cmpExpensive:"more expensive",
      cmpSame:"the same",
      cmpExplain:"This means that {typeText} in {prov} is {diff} {direction} than in your area (Baix Pened√®s). The price difference is {absDiff}, which represents {pct} {direction2}.",
      cmpContext:"In {prov}, the average price per m¬≤ is {avgM2}. If you apply the same features you're looking for (size, bedrooms, extras), the total cost would be {total}.",
      cmpRent:"The estimated monthly rent in {prov} would be {rent}, compared to {yourRent} in your area.",
      cmpAdvice:"üí° This can help you decide whether it's worth searching in other provinces based on your budget and mobility needs."
    }
  };

  let LANG=localStorage.getItem(LANG_KEY)||"ES";
  const t=(k)=> (I18N[LANG] && I18N[LANG][k]) || (I18N.ES[k]||k);
  const tpl=(s,vars)=>String(s||"").replace(/\{(\w+)\}/g,(_,k)=> (vars && vars[k]!=null)?vars[k]:"");

  const fmtMoney=(n)=>{
    if(!isFinite(n)) return "‚Äì";
    return (LANG==="EN"?fmtEN(n):fmtES(n))+" ‚Ç¨";
  };
  const fmtPct=(n)=> (LANG==="EN"?pctEN(n):pctES(n));

  const toast=(m)=>{let e=Q("#ts");e.textContent=m;e.classList.add("s");setTimeout(()=>e.classList.remove("s"),1800)};

  // aplicar traducciones a elementos con data-i
  const applyStaticI18n=()=>{
    QA("[data-i]").forEach(el=>{
      const k=el.getAttribute("data-i");
      const v=t(k);
      if(!v) return;
      el.textContent=v;
    });
  };

  const setLang=(l)=>{
    LANG=l;
    localStorage.setItem(LANG_KEY,l);
    Q("#L_CA").classList.toggle("a",l==="CA");
    Q("#L_ES").classList.toggle("a",l==="ES");
    Q("#L_EN").classList.toggle("a",l==="EN");
    applyStaticI18n();
    renderZoneUI();
    renderResult();
    refreshExamplesUI();
    updateSteps && updateSteps(document.querySelector("[data-p][style*='block']")?.getAttribute("data-p")||"p");
    liveValidate && liveValidate();
  };

  const loadForm=()=>{
    let s=localStorage.getItem(STORE_KEY); if(!s) return;
    try{
      let d=JSON.parse(s)||{};
      ["nm","ag","inc","sav","yrs","msv","m2","bed","bat","cm2","cbd","cba"].forEach(id=>{ if(d[id]!=null && Q("#"+id)) Q("#"+id).value=d[id]; });
      ["ar","ty","hor","fst","cm","cty"].forEach(id=>{ if(d[id]!=null && Q("#"+id)) Q("#"+id).value=d[id]; });
      ["et","ep","el","ek","ct","cp0","cl0","ck0"].forEach(id=>{ if(Q("#"+id) && d[id]!=null) Q("#"+id).checked=!!d[id]; });
    }catch(e){}
  };
  const saveForm=()=>{
    let d={};
    ["nm","ag","inc","sav","yrs","msv","m2","bed","bat","cm2","cbd","cba"].forEach(id=>{ if(Q("#"+id)) d[id]=Q("#"+id).value; });
    ["ar","ty","hor","fst","cm","cty"].forEach(id=>{ if(Q("#"+id)) d[id]=Q("#"+id).value; });
    ["et","ep","el","ek","ct","cp0","cl0","ck0"].forEach(id=>{ if(Q("#"+id)) d[id]=Q("#"+id).checked?1:0; });
    localStorage.setItem(STORE_KEY,JSON.stringify(d));
  };

  const updateSteps=(p)=>{
    const stepMap={p:1,e:2,f:3,r:4,m:4,x:4};
    const cur=stepMap[p]||1;
    [1,2,3,4].forEach(i=>{
      const s=Q("#stp"+i); if(!s) return;
      s.classList.remove("active","done");
      if(i<cur) s.classList.add("done");
      else if(i===cur) s.classList.add("active");
    });
    const lbls=[t("stepPersonal"),t("stepEco"),t("stepPref"),t("stepRes")];
    lbls.forEach((l,i)=>{const el=Q("#slbl"+(i+1));if(el)el.textContent=l;});
  };

  const show=p=>{
    QA("[data-p]").forEach(x=>x.style.display=x.getAttribute("data-p")==p?"block":"none");
    ["p","e","f","r","m","x"].forEach(k=>Q("#t_"+k).classList.toggle("a",p===k));
    updateSteps(p);
    if(p==="m") setTimeout(()=>upMap(),100);
    if(p==="x") refreshExamplesUI();
    window.scrollTo({top:0,behavior:"smooth"});
  };

  const mort=(c,r,y)=>{let m=r/12,n=y*12;return r===0?c/n:c*(m*Math.pow(1+m,n))/(Math.pow(1+m,n)-1)};
  const COEF={"Cunit":{c:1.157,r:.975},"El Vendrell":{c:.912,r:.842},"Calafell":{c:.856,r:.983},"Santa Oliva":{c:.783,r:.825},"Bellvei":{c:.783,r:.925},"L'Arbo√ß":{c:.735,r:.883},"Banyeres del Pened√®s":{c:.614,r:.783},"Albinyana":{c:.766,r:.825},"Bonastre":{c:.497,r:.683},"Maslloren√ß":{c:.549,r:.75},"La Bisbal del Pened√®s":{c:.623,r:.808},"Lloren√ß del Pened√®s":{c:.856,r:.65},"Sant Jaume dels Domenys":{c:.614,r:.65},"El Montmell":{c:.529,r:.675}};
  const BASE={m2:2000,rent:10,close:.1,rate:.0299};
  const M={"Barcelona":{v:2986,l:21.9},"Girona":{v:2608,l:14.99},"Lleida":{v:1486,l:9.5},"Tarragona":{v:2100,l:13.5}};
  const buy=(a,m2,b,ba,e)=>{let base=m2*BASE.m2*(COEF[a]?.c||1),adj=b*5e3+ba*3e3,x=0;if(e.t)x+=base*.05;if(e.p)x+=base*.08;if(e.l)x+=base*.04;if(e.k)x+=base*.03;return Math.round(base+adj+x)};
  const rent=(a,m2,b,ba,e)=>{let base=m2*BASE.rent*(COEF[a]?.r||1),adj=b*50+ba*30,x=0;if(e.t)x+=base*.15;if(e.p)x+=base*.30;if(e.l)x+=base*.08;if(e.k)x+=base*.07;return Math.round(base+adj+x)};
  const buyM=(m,m2,b,ba,e)=>{let p=M[m];if(!p)return NaN;let base=m2*p.v,adj=b*5e3+ba*3e3,x=0;if(e.t)x+=base*.05;if(e.p)x+=base*.08;if(e.l)x+=base*.04;if(e.k)x+=base*.03;return Math.round(base+adj+x)};
  const rentM=(m,m2,b,ba,e)=>{let p=M[m];if(!p)return NaN;let base=m2*p.l,adj=b*50+ba*30,x=0;if(e.t)x+=base*.15;if(e.p)x+=base*.30;if(e.l)x+=base*.08;if(e.k)x+=base*.07;return Math.round(base+adj+x)};

  let last=null,lastReq=null,lastReqSig="";
  const reqFromUI=()=>({
    muni:Q("#ar").value,type:Q("#ty").value,m2:+Q("#m2").value||null,
    bed:(Q("#bed").value===""?null:+Q("#bed").value),bath:+Q("#bat").value||null,
    ex:{t:Q("#et").checked?1:0,p:Q("#ep").checked?1:0,l:Q("#el").checked?1:0,k:Q("#ek").checked?1:0}
  });
  const sigOfReq=r=>[r.muni,r.type,r.m2,r.bed,r.bath,r.ex.t,r.ex.p,r.ex.l,r.ex.k].join("|");
  const prefsChangedSinceAnalyze=()=>{ if(!lastReq) return true; return sigOfReq(reqFromUI())!==lastReqSig; };
  const setTabsEnabled=()=>{
    const needA=!lastReq;
    ["#t_r","#t_m","#t_x"].forEach(id=>Q(id).classList.toggle("dis",needA));
  };

  const typeLabel=(type)=> type==="flat"?t("optFlat"):t("optHouse");
  const muniLabel=(muni)=>{
    if(muni==="*") return t("any");
    if(muni==="__multi__") return [...zoneSel].join(", ");
    return muni;
  };

  const analyze=()=>{
    let nm=(Q("#nm").value||"").trim(),ag=+Q("#ag").value||0,inc=+Q("#inc").value||0,sav=+Q("#sav").value||0,yrs=+Q("#yrs").value||25,hor=Q("#hor").value==="y",fst=Q("#fst").value==="y";
    let ar=Q("#ar").value,m2=+Q("#m2").value||0,bd=(Q("#bed").value===""?0:+Q("#bed").value||0),ba=+Q("#bat").value||0,type=Q("#ty").value;
    if(!nm||ag<18||ag>100||m2<50||ba<1){toast(t("toastCheckNameAge"));return;}
    let e={t:Q("#et").checked,p:Q("#ep").checked,l:Q("#el").checked,k:Q("#ek").checked};
    // Media de precios si hay multi-zona
    let pb,pr,pbRange=null,prRange=null,muniList=[];
    if((ar==="*"||ar==="__multi__")&&zoneSel.size>1){
      muniList=[...zoneSel];
      const buys=muniList.map(m=>buy(m,m2,Math.max(0,bd),ba,e));
      const rents=muniList.map(m=>rent(m,m2,Math.max(0,bd),ba,e));
      pb=Math.round(buys.reduce((a,b)=>a+b,0)/buys.length);
      pr=Math.round(rents.reduce((a,b)=>a+b,0)/rents.length);
      pbRange={lo:Math.min(...buys),hi:Math.max(...buys)};
      prRange={lo:Math.min(...rents),hi:Math.max(...rents)};
    } else {
      const baseM=(ar==="__multi__"&&zoneSel.size===1)?[...zoneSel][0]:(ar==="*"?"Cunit":ar);
      muniList=[baseM];
      pb=buy(baseM,m2,Math.max(0,bd),ba,e);
      pr=rent(baseM,m2,Math.max(0,bd),ba,e);
    }
    let dp=fst?.1:.2,down=pb*dp,cl=pb*BASE.close,cap=Math.max(0,pb-down);
    let rate=BASE.rate;if(sav<down)rate+=.005;
    let pay=mort(cap,rate,yrs),ratio=inc>0?(pay/inc)*100:1e9,rri=inc>0?(pr/inc)*100:1e9;

    let need=sav<(down+cl);
    let ratioOK=isFinite(ratio)&&ratio<=35;
    let rentOK=isFinite(rri)&&rri<=40;
    let recCode=(!need && ratioOK && hor) ? "BUY" : (rentOK ? "RENT" : "NOT_FEASIBLE");
    
    // Traducir la recomendaci√≥n seg√∫n el idioma
    let rec;
    if(recCode === "BUY") rec = t("recBuy");
    else if(recCode === "RENT") rec = t("recRent");
    else rec = t("recNotFeasible");

    last={nm,muni:ar,m2,bd:Math.max(0,bd),ba,type,pb,pr,pbRange,prRange,muniList,cap,rate,yrs,dp,sav,down,cl,pay,ratio,rri,rec,recCode,e,need,hor,inc,msv:+Q("#msv").value||0};
    lastReq=reqFromUI(); lastReqSig=sigOfReq(lastReq);

    Q("#k1").textContent=fmtMoney(pb);
    Q("#k2").textContent=(LANG==="EN"?fmtEN(pr):fmtES(pr))+" ‚Ç¨";
    Q("#k3").textContent=(LANG==="EN"?fmtEN(pay):fmtES(pay))+" ‚Ç¨";
    Q("#k4").textContent=rec;

    renderResult();
    setTabsEnabled();
    saveForm();
    show("r");
  };

  const renderResult=()=>{
    if(!last) return;

    const dti=isFinite(last.ratio)?last.ratio:999;
    const rti=isFinite(last.rri)?last.rri:999;
    const needCash=Math.round(last.down+last.cl);

    let clsDTI=dti<=30?"good":dti<=35?"warn":"bad";
    let clsRTI=rti<=35?"good":rti<=40?"warn":"bad";
    let clsCash=last.need?"bad":"good";
    let clsRate=(last.rate>BASE.rate)?"warn":"neu";

    Q("#rCard").style.display="block";

    Q("#rTitle").textContent=tpl(t("sumTitle"),{rec:last.rec});
    Q("#rChips").innerHTML=
      `<span class="chip ${clsDTI}">${tpl(t("chipMort"),{pct:fmtPct(dti)})}</span>`+
      `<span class="chip ${clsRTI}">${tpl(t("chipRent"),{pct:fmtPct(rti)})}</span>`+
      `<span class="chip ${clsCash}">${tpl(t("chipCash"),{eur:fmtMoney(needCash)})}</span>`+
      `<span class="chip ${clsRate}">${tpl(t("chipRate"),{rate:(last.rate*100).toFixed(2)+"%"})}</span>`;

    // Mini cards: rango multi-zona y precio/m¬≤
    const isMulti=last.muniList&&last.muniList.length>1;
    const multiLbl=isMulti?`<div style='font-size:.72rem;color:#7dd3fc;margin-top:3px'>${tpl(t("avgZone"),{n:last.muniList.length})}</div>`:"";
    const pbRngHtml=(isMulti&&last.pbRange)?`<div class='range-bar'><span class='range-tag lo'>‚Üì ${fmtMoney(last.pbRange.lo)}</span><span class='range-tag hi'>‚Üë ${fmtMoney(last.pbRange.hi)}</span></div>`:"";
    const prRngHtml=(isMulti&&last.prRange)?`<div class='range-bar'><span class='range-tag lo'>‚Üì ${fmtMoney(last.prRange.lo)}</span><span class='range-tag hi'>‚Üë ${fmtMoney(last.prRange.hi)}</span></div>`:"";
    const pricePerM2=last.m2>0?Math.round(last.pb/last.m2):0;
    Q("#rMini").innerHTML=
      `<div class="mini"><div class="h">${t("miniPrice")}</div><div class="v">${fmtMoney(last.pb)}</div>${multiLbl}${pbRngHtml}<div style='font-size:.75rem;color:#64748b;margin-top:4px'>${pricePerM2.toLocaleString("es-ES")} ‚Ç¨/m¬≤</div></div>`+
      `<div class="mini"><div class="h">${t("miniPay")}</div><div class="v">${fmtMoney(last.pay)}</div><div style='font-size:.75rem;color:#64748b;margin-top:4px'>${last.yrs} ${LANG==="EN"?"years":"a√±os"} ¬∑ ${(last.rate*100).toFixed(2)}%</div></div>`+
      `<div class="mini"><div class="h">${t("miniRent")}</div><div class="v">${fmtMoney(last.pr)}</div>${prRngHtml}</div>`;

    const muniTxt=muniLabel(last.muni);
    const typeTxt=typeLabel(last.type);

    // Crear explicaci√≥n detallada y clara
    let bodyHTML = "<div style='display:grid;gap:16px'>";
    
    // EXPLICACI√ìN DE LA RECOMENDACI√ìN
    bodyHTML += "<div style='background:linear-gradient(135deg,rgba(56,189,248,.08),rgba(14,165,233,.05));padding:16px;border-radius:14px;border-left:4px solid ";
    
    if(last.recCode === "BUY") {
      bodyHTML += "#22c55e'>";
      bodyHTML += "<div style='font-size:1.1rem;font-weight:900;color:#86efac;margin-bottom:12px'>‚úÖ " + 
        (LANG==="EN"?"Why BUY?":LANG==="CA"?"Per qu√® COMPRAR?":"¬øPor qu√© COMPRAR?") + "</div>";
      bodyHTML += "<div style='color:#cbd5e1;line-height:1.7;font-size:.92rem'>";
      
      const reasons = [];
      if(!last.need) reasons.push((LANG==="EN"?"You have sufficient savings":"Tienes ahorros suficientes") + " (" + fmtMoney(last.sav) + " ‚â• " + fmtMoney(needCash) + ")");
      if(dti<=35) reasons.push((LANG==="EN"?"Mortgage effort is sustainable":"Esfuerzo hipotecario sostenible") + " (" + fmtPct(dti) + " " + (LANG==="EN"?"of income":"de ingresos") + ")");
      if(last.hor) reasons.push((LANG==="EN"?"You plan to stay > 5 years":"Planeas quedarte > 5 a√±os") + " (" + (LANG==="EN"?"builds equity":"genera patrimonio") + ")");
      reasons.push((LANG==="EN"?"Your monthly payment":"Tu cuota mensual") + " (" + fmtMoney(last.pay) + ") " + (LANG==="EN"?"vs rent":"vs alquiler") + " (" + fmtMoney(last.pr) + ")");
      
      reasons.forEach((r,i)=>bodyHTML+="<div style='margin-bottom:8px'>‚Ä¢ " + r + "</div>");
      bodyHTML += "</div>";
      
    } else if(last.recCode === "RENT") {
      bodyHTML += "#f59e0b'>";
      bodyHTML += "<div style='font-size:1.1rem;font-weight:900;color:#fde68a;margin-bottom:12px'>‚ö†Ô∏è " + 
        (LANG==="EN"?"Why RENT?":LANG==="CA"?"Per qu√® LLOGAR?":"¬øPor qu√© ALQUILAR?") + "</div>";
      bodyHTML += "<div style='color:#cbd5e1;line-height:1.7;font-size:.92rem'>";
      
      const reasons = [];
      if(last.need) {
        const missing = Math.round(needCash - last.sav);
        reasons.push((LANG==="EN"?"Insufficient savings":"Ahorros insuficientes") + " (" + 
          (LANG==="EN"?"need":"necesitas") + " " + fmtMoney(needCash) + ", " + 
          (LANG==="EN"?"missing":"faltan") + " " + fmtMoney(missing) + ")");
      }
      if(dti>35) reasons.push((LANG==="EN"?"Mortgage effort too high":"Esfuerzo hipotecario demasiado alto") + " (" + fmtPct(dti) + " > 35% " + (LANG==="EN"?"of income":"de ingresos") + ")");
      if(!last.hor) reasons.push((LANG==="EN"?"Short term stay (< 5 years)":"Estancia corta plazo (< 5 a√±os)") + " - " + (LANG==="EN"?"buying costs not worth it":"gastos de compra no valen la pena"));
      if(rti<=40) reasons.push((LANG==="EN"?"Rent is affordable":"Alquiler es asequible") + " (" + fmtPct(rti) + " " + (LANG==="EN"?"of income":"de ingresos") + ")");
      else reasons.push((LANG==="EN"?"Rent effort":"Esfuerzo alquiler") + " " + fmtPct(rti) + " " + (LANG==="EN"?"is high but manageable":"es alto pero manejable"));
      
      reasons.forEach((r,i)=>bodyHTML+="<div style='margin-bottom:8px'>‚Ä¢ " + r + "</div>");
      bodyHTML += "</div>";
      
    } else {
      bodyHTML += "#ef4444'>";
      bodyHTML += "<div style='font-size:1.1rem;font-weight:900;color:#fca5a5;margin-bottom:12px'>‚ùå " + 
        (LANG==="EN"?"NOT FEASIBLE":LANG==="CA"?"NO FACTIBLE":"NO FACTIBLE") + "</div>";
      bodyHTML += "<div style='color:#cbd5e1;line-height:1.7;font-size:.92rem'>";
      
      const problems = [];
      if(last.need) problems.push((LANG==="EN"?"Insufficient savings for down payment":"Ahorros insuficientes para entrada"));
      if(dti>35) problems.push((LANG==="EN"?"Mortgage effort":"Esfuerzo hipoteca") + " " + fmtPct(dti) + " > 35% (" + (LANG==="EN"?"too high":"demasiado alto") + ")");
      if(rti>40) problems.push((LANG==="EN"?"Rent effort":"Esfuerzo alquiler") + " " + fmtPct(rti) + " > 40% (" + (LANG==="EN"?"too high":"demasiado alto") + ")");
      
      problems.forEach((p,i)=>bodyHTML+="<div style='margin-bottom:8px'>‚Ä¢ " + p + "</div>");
      bodyHTML += "<div style='margin-top:12px;padding:12px;background:rgba(239,68,68,.1);border-radius:8px'>";
      bodyHTML += "<b style='color:#fca5a5'>" + (LANG==="EN"?"üí° Suggestions:":"üí° Sugerencias:") + "</b><br>";
      if(last.need) bodyHTML += "‚Ä¢ " + (LANG==="EN"?"Save more (need "+fmtMoney(needCash)+")":"Ahorra m√°s (necesitas "+fmtMoney(needCash)+")") + "<br>";
      if(dti>35 || rti>40) bodyHTML += "‚Ä¢ " + (LANG==="EN"?"Increase income or reduce property price":"Aumenta ingresos o reduce precio de propiedad") + "<br>";
      bodyHTML += "‚Ä¢ " + (LANG==="EN"?"Consider a smaller property or different area":"Considera una propiedad m√°s peque√±a o zona diferente");
      bodyHTML += "</div>";
      bodyHTML += "</div>";
    }
    bodyHTML += "</div>";
    
    // Preferencias
    bodyHTML += "<div><div style='font-size:1rem;font-weight:800;color:#38bdf8;margin-bottom:8px'>üìç " + t("bodyPrefs").split(":")[0] + "</div>" +
      "<div style='margin-left:20px;color:#cbd5e1'>" + 
      tpl(t("bodyPrefs").replace(/^.*?:\s*/,""),{
        muni:muniTxt,m2:last.m2,bed:(last.bd||0),bath:last.ba,type:typeTxt
      }) + "</div></div>";
    
    // Financiaci√≥n
    const dpPct = Math.round(last.dp*100);
    bodyHTML += "<div><div style='font-size:1rem;font-weight:800;color:#38bdf8;margin-bottom:8px'>üí∞ " + 
      (LANG==="EN"?"Financing":"Financiaci√≥n") + "</div>" +
      "<div style='margin-left:20px;color:#cbd5e1'>" +
      "<div style='margin-bottom:6px'>" + (LANG==="EN"?"Down payment: ":"Entrada: ") + dpPct + "% ‚Üí <b>" + fmtMoney(last.down) + "</b></div>" +
      "<div style='margin-bottom:6px'>" + (LANG==="EN"?"Closing costs: ":"Gastos de cierre: ") + "<b>" + fmtMoney(last.cl) + "</b></div>" +
      "<div>" + (LANG==="EN"?"To finance: ":"A financiar: ") + "<b>" + fmtMoney(last.cap) + "</b> (" + last.yrs + (LANG==="EN"?" years":" a√±os") + " @ " + (last.rate*100).toFixed(2) + "%)</div>" +
      "</div></div>";
    
    // Esfuerzo econ√≥mico con barras de progreso visual
    const dtiCls=dti<=30?"good":dti<=35?"warn":"bad";
    const rtiCls=rti<=35?"good":rti<=40?"warn":"bad";
    bodyHTML += "<div><div style='font-size:1rem;font-weight:800;color:#38bdf8;margin-bottom:12px'>üìä " +
      (LANG==="EN"?"Financial effort":"Esfuerzo econ√≥mico") + "</div>" +
      "<div style='display:grid;gap:14px'>" +
      "<div><div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:5px'>" +
        "<span style='color:#94a3b8;font-size:.85rem;font-weight:700'>" + (LANG==="EN"?"Mortgage effort":"Esfuerzo hipoteca") + "</span>" +
        "<span style='font-weight:900;color:#f1f5f9'>" + fmtPct(dti) + " " + (dti<=30?"‚úÖ":dti<=35?"‚ö†Ô∏è":"‚ùå") + "</span></div>" +
      "<div class='pbar-wrap'><div class='pbar " + dtiCls + "' style='width:" + Math.min(100,dti).toFixed(1) + "%'></div></div>" +
      "<div style='font-size:.75rem;color:#64748b;margin-top:3px'>" + (LANG==="EN"?"Recommended limit: 35%":"L√≠mite recomendado: 35%") + "</div></div>" +
      "<div><div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:5px'>" +
        "<span style='color:#94a3b8;font-size:.85rem;font-weight:700'>" + (LANG==="EN"?"Rent effort":"Esfuerzo alquiler") + "</span>" +
        "<span style='font-weight:900;color:#f1f5f9'>" + fmtPct(rti) + " " + (rti<=35?"‚úÖ":rti<=40?"‚ö†Ô∏è":"‚ùå") + "</span></div>" +
      "<div class='pbar-wrap'><div class='pbar " + rtiCls + "' style='width:" + Math.min(100,rti).toFixed(1) + "%'></div></div>" +
      "<div style='font-size:.75rem;color:#64748b;margin-top:3px'>" + (LANG==="EN"?"Recommended limit: 40%":"L√≠mite recomendado: 40%") + "</div></div>" +
      "</div></div>";

    // Nota ITP/AJD
    bodyHTML += "<div style='padding:12px 14px;background:rgba(99,102,241,.08);border:1px solid rgba(99,102,241,.25);border-radius:12px;border-left:4px solid #818cf8;color:#c7d2fe;font-size:.85rem;line-height:1.6'>&#x2139;&#xFE0F; " + t("itpNote") + "</div>";

    // Countdown de ahorro
    const needCash2=Math.round(last.down+last.cl);
    if(last.need){
      const missing2=Math.max(0,needCash2-last.sav);
      if(last.msv>0&&missing2>0){
        const mos=Math.ceil(missing2/last.msv);
        const yrs2=(mos/12).toFixed(1);
        bodyHTML += "<div class='countdown'>&#x23F3; "+tpl(t("yearsToSave"),{msv:fmtMoney(last.msv),yrs:yrs2,mos:mos})+"</div>";
      }
    } else {
      bodyHTML += "<div class='countdown' style='background:rgba(34,197,94,.08);border-color:rgba(34,197,94,.25);border-left-color:#22c55e;color:#86efac'>"+t("savingsOk")+"</div>";
    }

    bodyHTML += "</div>";
    
    Q("#rBody").innerHTML = bodyHTML;

    // Texto largo (clipboard) 100% en idioma
    Q("#rt").textContent=[
      tpl(t("reportHello"),{name:last.nm}),
      tpl(t("reportPrice"),{eur:fmtMoney(last.pb)}),
      tpl(t("reportHome"),{muni:muniTxt,m2:last.m2,bed:(last.bd||0),bath:last.ba,type:typeTxt}),
      tpl(t("reportDown"),{dp:Math.round(last.dp*100),down:fmtMoney(last.down),cl:fmtMoney(last.cl)}),
      tpl(t("reportFin"),{cap:fmtMoney(last.cap),yrs:last.yrs,rate:(last.rate*100).toFixed(2)+"%"}),
      tpl(t("reportPay"),{pay:fmtMoney(last.pay),rent:fmtMoney(last.pr)}),
      tpl(t("reportRec"),{rec:last.rec})
    ].join("\n");
  };

  let cmap=null;
  const PROV_COORDS={
    "Barcelona":[41.3874,2.1686],
    "Girona":[41.9794,2.8214],
    "Lleida":[41.6176,0.6200],
    "Tarragona":[41.1189,1.2445]
  };
  const upMap=()=>{
    const m=Q("#cm").value||"Barcelona";
    const coords=PROV_COORDS[m]||[41.3874,2.1686];
    if(!cmap){
      cmap=L.map("cmap").setView(coords,12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(cmap);
      L.marker(coords).addTo(cmap).bindPopup(m);
      setTimeout(()=>{if(cmap)cmap.invalidateSize()},200);
    } else if(cmap){
      cmap.setView(coords,12);
      cmap.eachLayer(layer=>{if(layer instanceof L.Marker)cmap.removeLayer(layer)});
      L.marker(coords).addTo(cmap).bindPopup(m);
      setTimeout(()=>{if(cmap)cmap.invalidateSize()},100);
    }
  };

  const fillComparatorFromLast=()=>{
    if(!last){ toast(t("toastFirstAnalyze")); return; }
    Q("#cm2").value=last.m2||""; Q("#cbd").value=last.bd||""; Q("#cba").value=last.ba||"";
    Q("#cty").value=last.type||"flat";
    Q("#ct").checked=!!last.e?.t; Q("#cp0").checked=!!last.e?.p; Q("#cl0").checked=!!last.e?.l; Q("#ck0").checked=!!last.e?.k;
    saveForm();
  };

  const compare=()=>{
    if(!last){Q("#cmg").textContent=t("toastFirstAnalyze");return;}
    let m=Q("#cm").value,m2=+Q("#cm2").value||0,bd=+Q("#cbd").value||0,ba=+Q("#cba").value||0;
    let e={t:Q("#ct").checked,p:Q("#cp0").checked,l:Q("#cl0").checked,k:Q("#ck0").checked};
    if(!M[m]||!(m2>0&&ba>0)){Q("#cmg").textContent=(LANG==="EN"?"Complete province and data.":LANG==="CA"?"Completa prov√≠ncia i dades.":"Completa provincia y datos.");return;}
    let p2=buyM(m,m2,Math.max(0,bd),ba,e), r2=rentM(m,m2,Math.max(0,bd),ba,e);
    let d=p2-last.pb, pct=(last.pb>0)?(d/last.pb)*100:0;
    let cls=d>0?"bad":d<0?"good":"neu";
    let arrow=d>0?"‚Üë":d<0?"‚Üì":"‚Üí";
    let sign=d>0?"+":"";
    let pctTxt=(d===0)?"0%":(sign+pct.toFixed(1)+"%");
    
    // Mejorar explicaci√≥n del comparador
    const typeTxt = typeLabel(Q("#cty").value);
    const direction = d>0 ? t("cmpExpensive") : (d<0 ? t("cmpCheaper") : t("cmpSame"));
    const direction2 = d>0 ? t("cmpExpensive") : (d<0 ? t("cmpCheaper") : "");
    const absDiff = fmtMoney(Math.abs(d));
    const avgM2 = fmtMoney(M[m].v);
    
    let explanation = "";
    if(d !== 0) {
      const explainTxt = tpl(t("cmpExplain"), {typeText: typeTxt, prov: m, diff: absDiff, direction: direction, pct: pctTxt, direction2: direction2});
      const contextTxt = tpl(t("cmpContext"), {prov: m, avgM2: avgM2, total: fmtMoney(p2)});
      const rentTxt = tpl(t("cmpRent"), {prov: m, rent: fmtMoney(r2), yourRent: fmtMoney(last.pr)});
      const adviceTxt = t("cmpAdvice");
      explanation = "<div style='margin-top:12px;line-height:1.6'>" +
        "<p><b>" + explainTxt + "</b></p>" +
        "<p>" + contextTxt + "</p>" +
        "<p>" + rentTxt + "</p>" +
        "<p style='margin-top:10px;padding:10px;background:rgba(56,189,248,.1);border-radius:8px;border-left:3px solid #38bdf8'>" + adviceTxt + "</p>" +
        "</div>";
    }
    
    Q("#cmg").innerHTML=
      "<div class='cardx'>" +
        "<div class='top'>" +
          "<div class='title'>" + m + "</div>" +
          "<div class='chips'>" +
            "<span class='chip " + cls + "'>" + arrow + " " + sign + fmtMoney(d) + "</span>" +
            "<span class='chip " + cls + "'>" + pctTxt + "</span>" +
            "<span class='chip neu'>" + fmtMoney(p2) + "</span>" +
          "</div>" +
        "</div>" +
        "<div class='body'>" + fmtMoney(p2) + " ¬∑ " + fmtMoney(r2) + "/" + (LANG==="EN"?"month":LANG==="CA"?"mes":"mes") + "</div>" +
        explanation +
      "</div>";
    upMap(); saveForm();
  };

  // ===== Mapa real (Leaflet) =====
  const ZONE_POINTS=[
    {name:"Cunit",lat:41.1989,lng:1.6368},
    {name:"Calafell",lat:41.2010,lng:1.5687},
    {name:"El Vendrell",lat:41.2204,lng:1.5340},
    {name:"Santa Oliva",lat:41.2533,lng:1.5510},
    {name:"Bellvei",lat:41.2392,lng:1.5767},
    {name:"L'Arbo√ß",lat:41.2650,lng:1.6050},
    {name:"Banyeres del Pened√®s",lat:41.2810,lng:1.5780},
    {name:"Albinyana",lat:41.2440,lng:1.4870},
    {name:"Bonastre",lat:41.2270,lng:1.4390},
    {name:"Maslloren√ß",lat:41.2750,lng:1.4140},
    {name:"La Bisbal del Pened√®s",lat:41.2780,lng:1.4890},
    {name:"Lloren√ß del Pened√®s",lat:41.2820,lng:1.5490},
    {name:"Sant Jaume dels Domenys",lat:41.2990,lng:1.5590},
    {name:"El Montmell",lat:41.3070,lng:1.4540},
  ];

  let zmap=null, zReady=false, zoneSel=new Set(), markerByName=new Map();
  const loadZoneSel=()=>{
    try{
      const s=localStorage.getItem(ZONE_KEY);
      if(!s) return;
      const arr=JSON.parse(s)||[];
      zoneSel=new Set(arr.filter(Boolean));
    }catch(e){}
  };
  const saveZoneSel=()=>localStorage.setItem(ZONE_KEY, JSON.stringify([...zoneSel]));

  const pinIcon=(on)=>L.divIcon({
    className:"",
    html:`<div class="pinWrap"><div class="pin ${on?"on":"off"}"></div></div>`,
    iconSize:[26,26],
    iconAnchor:[13,26]
  });

  const renderZoneUI=()=>{
    const selTxt = zoneSel.size ? [...zoneSel].join(", ") : (LANG==="EN"?"none":LANG==="CA"?"cap":"ninguno");
    Q("#zoneNote").textContent = (LANG==="EN"?"Selected: ":LANG==="CA"?"Seleccionats: ":"Seleccionados: ")+selTxt;

    Q("#zoneApplied").textContent = zoneSel.size
      ? ((LANG==="EN"?"Active towns: ":LANG==="CA"?"Municipis actius: ":"Municipios activos: ")+[...zoneSel].join(", "))
      : (LANG==="EN"?"No area applied":LANG==="CA"?"Cap zona aplicada":"Ninguna zona aplicada");

    const zc=Q("#zoneChips");
    zc.innerHTML = zoneSel.size
      ? [...zoneSel].map(z=>`<span class="pchip on" data-z="${z}">${z}</span>`).join("")
      : `<span class="pchip off">${LANG==="EN"?"No selection":LANG==="CA"?"Sense selecci√≥":"Sin selecci√≥n"}</span>`;

    zc.querySelectorAll("[data-z]").forEach(ch=>{
      ch.addEventListener("click",()=>{
        const n=ch.getAttribute("data-z");
        toggleZone(n,true);
      });
    });
  };

  const applyMarkerState=(name)=>{
    const mk=markerByName.get(name);
    if(!mk) return;
    const on=zoneSel.has(name);
    mk.setIcon(pinIcon(on));
    mk.setZIndexOffset(on?1000:0);
  };

  const toggleZone=(name,fromChip)=>{
    if(zoneSel.has(name)) zoneSel.delete(name); else zoneSel.add(name);
    applyMarkerState(name);
    renderZoneUI();
    if(!fromChip) saveZoneSel();
  };

  const initMap=()=>{
    if(zReady) return;
    zReady=true;
    zmap=L.map("zmap",{scrollWheelZoom:false,tap:true}).setView([41.235,1.595],11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'Leaflet | ¬© OpenStreetMap'}).addTo(zmap);

    const bounds=[];
    ZONE_POINTS.forEach(p=>{
      bounds.push([p.lat,p.lng]);
      const mk=L.marker([p.lat,p.lng],{
        icon: pinIcon(zoneSel.has(p.name)),
        keyboard:true,riseOnHover:true,title:p.name
      }).addTo(zmap);
      mk.bindTooltip(p.name,{direction:"top",opacity:0.95});

      const hb=L.circle([p.lat,p.lng],{radius:380,opacity:0,fillOpacity:0}).addTo(zmap);
      const clickFn=()=>toggleZone(p.name,false);
      mk.on("click",clickFn);
      hb.on("click",clickFn);

      markerByName.set(p.name,mk);
      applyMarkerState(p.name);
    });

    try{ zmap.fitBounds(bounds,{padding:[30,30]}); }catch(e){}
    setTimeout(()=>zmap.invalidateSize(),140);
    renderZoneUI();
  };

  // ===== Idealista links =====
  const IDEALISTA_BASE="https://www.idealista.com";
  const MUNI_SLUG={
    "Cunit":"cunit-tarragona","El Vendrell":"el-vendrell-tarragona","Calafell":"calafell-tarragona","Santa Oliva":"santa-oliva-tarragona",
    "Bellvei":"bellvei-tarragona","L'Arbo√ß":"l-arboc-tarragona","Banyeres del Pened√®s":"banyeres-del-penedes-tarragona","Albinyana":"albinyana-tarragona",
    "Bonastre":"bonastre-tarragona","Maslloren√ß":"masllorenc-tarragona","La Bisbal del Pened√®s":"la-bisbal-del-penedes-tarragona","Lloren√ß del Pened√®s":"llorenc-del-penedes-tarragona",
    "Sant Jaume dels Domenys":"sant-jaume-dels-domenys-tarragona","El Montmell":"el-montmell-tarragona",
  };

  const bedSlug=n=>{
    n=+n||0;
    if(n<=0) return "estudios";
    if(n===1) return "de-un-dormitorio";
    if(n===2) return "de-dos-dormitorios";
    if(n===3) return "de-tres-dormitorios";
    return "de-cuatro-cinco-habitaciones-o-mas";
  };
  const bathSlug=n=>{
    n=+n||0;
    if(n<=1) return "un-bano";
    if(n===2) return "dos-banos";
    return "tres-banos-o-mas";
  };
  const m2RangeSlugs=m2=>{
    m2=+m2||0; if(!(m2>0)) return [];
    let min=Math.max(0, Math.floor((m2-10)/10)*10);
    let max=Math.ceil((m2+10)/10)*10;
    if(max<=min) max=min+10;
    return [`metros-cuadrados-mas-de_${min}`, `metros-cuadrados-menos-de_${max}`];
  };

  const buildIdealistaUrl=(mode,strict,muniOverride)=>{
    if(!lastReq) return null;
    const req=lastReq;

    const muni = muniOverride || req.muni;
    const area=(muni==="*"||muni==="__multi__") ? "tarragona/baix-penedes" : (MUNI_SLUG[muni]||null);
    if(!area) return null;

    const op=(mode==="buy")?"venta-viviendas":"alquiler-viviendas";

    const f=[];
    if(req.m2!=null) f.push(...m2RangeSlugs(req.m2));
    f.push(req.type==="flat"?"pisos":"chalets");
    if(req.bed!=null) f.push(bedSlug(req.bed));
    if(req.bath!=null) f.push(bathSlug(req.bath));

    if(strict){
      if(req.ex.t===1) f.push("terraza");
      if(req.ex.p===1) f.push("piscina");
      if(req.ex.l===1) f.push("ascensor");
      if(req.ex.k===1) f.push("garaje");
    }

    const joined=f.filter(Boolean).join("%2C");
    return `${IDEALISTA_BASE}/${op}/${area}/con-${joined}/`;
  };

  const openIdealista=(mode,strict,muniOverride)=>{
    if(!lastReq){toast(t("toastFirstAnalyze"));return;}
    if(prefsChangedSinceAnalyze()){toast(t("toastPrefsChanged"));return;}
    const url=buildIdealistaUrl(mode,strict,muniOverride);
    if(!url){toast(t("toastNoLink"));return;}
    window.open(url,"_blank","noopener");
  };

  const refreshExamplesUI=()=>{
    const muniTxt=muniLabel(Q("#ar").value);
    const ok=!!lastReq && !prefsChangedSinceAnalyze();
    const state= ok ? t("stateReady") : t("stateNeedAnalyze");
    Q("#xinfo").textContent = tpl(t("xInfo"),{muni:muniTxt,state:state});

    const wrap=Q("#xbtns");
    wrap.innerHTML="";

    const mkBtn=(label,fn)=>{
      const b=document.createElement("button");
      b.type="button";
      b.className="b ok";
      b.textContent=label;
      b.onclick=fn;
      if(!ok) b.classList.add("dis");
      wrap.appendChild(b);
    };

    const z=[...zoneSel].filter(x=>MUNI_SLUG[x]);
    const buyLabel = (LANG==="EN"?"BUY":LANG==="CA"?"COMPRA":"COMPRA");
    const rentLabel = (LANG==="EN"?"RENT":LANG==="CA"?"LLOGUER":"ALQUILER");
    const strictLabel = (LANG==="EN"?"strict":LANG==="CA"?"estricte":"estricto");
    const flexLabel = (LANG==="EN"?"flex":LANG==="CA"?"flex":"flex");

    if(z.length){
      z.forEach(m=>{
        mkBtn(`${buyLabel} (${strictLabel}) ¬∑ ${m}`,()=>openIdealista("buy",true,m));
        mkBtn(`${buyLabel} (${flexLabel}) ¬∑ ${m}`,()=>openIdealista("buy",false,m));
        mkBtn(`${rentLabel} (${strictLabel}) ¬∑ ${m}`,()=>openIdealista("rent",true,m));
        mkBtn(`${rentLabel} (${flexLabel}) ¬∑ ${m}`,()=>openIdealista("rent",false,m));
      });
    } else {
      mkBtn(`${buyLabel} (${strictLabel})`,()=>openIdealista("buy",true,null));
      mkBtn(`${buyLabel} (${flexLabel})`,()=>openIdealista("buy",false,null));
      mkBtn(`${rentLabel} (${strictLabel})`,()=>openIdealista("rent",true,null));
      mkBtn(`${rentLabel} (${flexLabel})`,()=>openIdealista("rent",false,null));
    }

    setTabsEnabled();
  };

  const copy=()=>navigator.clipboard.writeText(Q("#rt").textContent||"").then(()=>toast(t("toastCopied")));
  const shareWhatsApp=()=>{
    const txt=Q("#rt").textContent||"";
    if(!txt){toast(t("toastFirstAnalyze"));return;}
    window.open("https://wa.me/?text="+encodeURIComponent(txt),"_blank","noopener");
  };

  const reset=()=>{
    ["nm","ag","inc","sav","yrs","msv","m2","bed","bat","cm2","cbd","cba"].forEach(id=>{let e=document.getElementById(id);if(e)e.value=""});
    ["et","ep","el","ek","ct","cp0","cl0","ck0"].forEach(id=>{let e=document.getElementById(id);if(e)e.checked=false});
    Q("#ar").value="*"; Q("#cm").value="Barcelona"; Q("#hor").value="y"; Q("#fst").value="n";
    const pm2=Q("#ar").querySelector('[value="__multi__"]');if(pm2)pm2.remove();
    Q("#rt").textContent="";Q("#k1").textContent="0 ‚Ç¨";Q("#k2").textContent="0 ‚Ç¨";Q("#k3").textContent="0 ‚Ç¨";Q("#k4").textContent="‚Äì";
    Q("#cmg").textContent=""; Q("#rCard").style.display="none";
    last=null; lastReq=null; lastReqSig="";
    localStorage.removeItem(STORE_KEY);
    zoneSel.clear(); saveZoneSel(); renderZoneUI();
    setTabsEnabled(); refreshExamplesUI();
    show("p");
  };

  // clamp
  const clamp=(id,min,max,len)=>{
    let el=document.getElementById(id);if(!el)return;
    const san=v=>{v=String(v||"").replace(/[^\d.]/g,"");let p=v.split(".");if(p.length>2)v=p.slice(0,2).join(".");return len?v.slice(0,len):v};
    el.addEventListener("input",()=>{el.value=san(el.value); saveForm();});
    el.addEventListener("blur",()=>{if(el.value==="")return;let n=+el.value;if(!isFinite(n))return;el.value=Math.min(max,Math.max(min,n)); saveForm();});
  };
  [["ag",18,100,3],["m2",50,999,3],["bed",0,10,2],["bat",1,10,2],["inc",0,1000000,7],["sav",0,10000000,8],["msv",0,1000000,7],["yrs",5,40,2],["cm2",50,999,3],["cbd",0,10,2],["cba",1,10,2]].forEach(x=>clamp(...x));

  const liveValidate=()=>{
    const vi=+Q("#inc").value||0, vs=+Q("#sav").value||0, vm=+Q("#m2").value||0;
    const fi=Q("#inc"),fs=Q("#sav"),fm=Q("#m2");
    const hi=Q("#hint-inc"),hs=Q("#hint-sav"),hm=Q("#hint-m2");
    const set=(inp,hint,ok,msg)=>{
      inp.classList.toggle("field-ok",ok&&inp.value!=="");
      inp.classList.toggle("field-err",!ok&&inp.value!=="");
      if(hint){hint.textContent=(!ok&&inp.value!=="")?"‚ö† "+msg:"";hint.className="field-hint"+(ok&&inp.value!=""?" ok":!ok&&inp.value!=""?" err":"");}
    };
    set(fi,hi,vi>0,LANG==="EN"?"Enter valid income":"Introduce ingresos v\u00e1lidos");
    set(fs,hs,vs>0,LANG==="EN"?"Enter your savings":"Introduce tus ahorros");
    set(fm,hm,vm>=50,LANG==="EN"?"Minimum 50 m\u00b2":"M\u00ednimo 50 m\u00b2");
  };
  ["inc","sav","m2"].forEach(id=>{const el=Q("#"+id);if(el){el.addEventListener("input",liveValidate);el.addEventListener("change",liveValidate);}});

  // bind
  Q("#np").addEventListener("click",()=>{
    let nm=(Q("#nm").value||"").trim();let ag=+Q("#ag").value||0;
    if(!nm||ag<18||ag>100){toast(t("toastCheckNameAge"));return;}
    saveForm(); show("e");
  });
  Q("#ne").addEventListener("click",()=>{saveForm(); show("f");});
  Q("#go").addEventListener("click",analyze);
  Q("#cp").addEventListener("click",copy);
  Q("#rs").addEventListener("click",reset);
  Q("#bc").addEventListener("click",compare);
  Q("#autoFillCmp").addEventListener("click",fillComparatorFromLast);
  Q("#cm").addEventListener("change",()=>{upMap();saveForm();});

  Q("#t_p").addEventListener("click",()=>show("p"));
  Q("#t_e").addEventListener("click",()=>show("e"));
  Q("#t_f").addEventListener("click",()=>show("f"));
  Q("#t_r").addEventListener("click",()=>{ if(!lastReq){toast(t("toastFirstAnalyze"));return;} show("r"); });
  Q("#t_m").addEventListener("click",()=>{ if(!lastReq){toast(t("toastFirstAnalyze"));return;} show("m"); });
  Q("#t_x").addEventListener("click",()=>{ if(!lastReq){toast(t("toastFirstAnalyze"));return;} show("x"); });

  Q("#toggleMap").addEventListener("click",()=>{
    const box=Q("#zoneWrap");
    const open=box.style.display!=="none";
    box.style.display=open?"none":"block";
    if(!open){
      initMap();
      setTimeout(()=>{ if(zmap) zmap.invalidateSize(); },180);
    }
  });

  Q("#zoneClear").addEventListener("click",()=>{
    zoneSel.clear(); saveZoneSel();
    markerByName.forEach((_,name)=>applyMarkerState(name));
    const pm=Q("#ar").querySelector('[value="__multi__"]');if(pm){pm.remove();if(Q("#ar").value==="__multi__")Q("#ar").value="*";}
    renderZoneUI(); refreshExamplesUI(); toast(t("toastZoneCleared"));
  });

  Q("#zoneApply").addEventListener("click",()=>{
    if(zoneSel.size===0){toast(t("toastNoZone"));return;}
    const pm=Q("#ar").querySelector('[value="__multi__"]');if(pm)pm.remove();
    if(zoneSel.size===1){
      const only=[...zoneSel][0];
      if([...Q("#ar").options].some(o=>o.value===only||o.textContent===only)) Q("#ar").value=only;
      else Q("#ar").value="*";
    } else {
      const mo=document.createElement("option");mo.value="__multi__";mo.textContent=[...zoneSel].join(", ");
      Q("#ar").insertBefore(mo,Q("#ar").options[1]||null);Q("#ar").value="__multi__";
    }
    saveZoneSel(); renderZoneUI(); saveForm(); refreshExamplesUI();
    toast(t("toastZoneApplied"));
  });

  ["#nm","#ar","#ty","#hor","#fst","#cm","#cty","#et","#ep","#el","#ek","#ct","#cp0","#cl0","#ck0","#inc","#sav","#yrs","#msv","#m2","#bed","#bat","#cm2","#cbd","#cba"].forEach(sel=>{
    let el=Q(sel); if(!el) return;
    el.addEventListener("change",()=>{saveForm(); refreshExamplesUI();});
    el.addEventListener("input",()=>saveForm());
  });

  Q("#L_CA").addEventListener("click",()=>setLang("CA"));
  Q("#L_ES").addEventListener("click",()=>setLang("ES"));
  Q("#L_EN").addEventListener("click",()=>setLang("EN"));
  if(Q("#shareWa")) Q("#shareWa").addEventListener("click",shareWhatsApp);
  if(Q("#shareCl")) Q("#shareCl").addEventListener("click",copy);

  // init
  loadZoneSel();
  loadForm();
  applyStaticI18n();
  upMap();
  updateSteps("p");
  liveValidate();
  setTabsEnabled();
  refreshExamplesUI();
})()
}

waitForLeaflet();
</script>
</body>
</html>