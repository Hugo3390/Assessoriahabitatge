<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Assessoria d'Habitatge - AI Advisor</title>

<style>
:root{
  --bg:#020617;
  --card:rgba(15,23,42,.70);
  --card2:rgba(11,18,32,.88);
  --bd:rgba(148,163,184,.22);
  --bd2:rgba(148,163,184,.30);
  --t:#e5e7eb;
  --m:#94a3b8;
  --mut:#cbd5e1;
  --pill:#38bdf8;
  --p:#06b6d4;--ph:#0891b2;
  --ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;
  --g1:#3b4a60;--g2:#0b1220;
  --shadow-lg:0 10px 40px rgba(0,0,0,.35);
  --shadow-xl:0 20px 60px rgba(0,0,0,.48);
  --gradient-3:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
  --gradient-4:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);
}

html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  position:relative;
  overflow-x:hidden;
}
body::before{
  content:"";
  position:fixed;inset:0;
  background:
    radial-gradient(1400px 700px at 20% -10%,rgba(56,189,248,.18),transparent 60%),
    radial-gradient(1000px 600px at 85% 0%,rgba(34,197,94,.14),transparent 60%),
    radial-gradient(900px 520px at 60% 110%,rgba(168,85,247,.12),transparent 62%),
    linear-gradient(180deg,#0f172a 0%,#020617 55%,#000 100%);
  z-index:-1;pointer-events:none;
  animation:pulse 18s ease-in-out infinite;
}
@keyframes pulse{0%,100%{opacity:.80}50%{opacity:1}}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{opacity:0;transform:translateX(-18px)}to{opacity:1;transform:translateX(0)}}
@keyframes glow{0%,100%{box-shadow:0 0 18px rgba(56,189,248,.22)}50%{box-shadow:0 0 30px rgba(56,189,248,.42)}}
@keyframes typing{from{opacity:.4}to{opacity:1}}

#hx{
  color:var(--t);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
  -webkit-font-smoothing:antialiased;
}
#hx *{box-sizing:border-box}
.w{max-width:1200px;margin:22px auto 18px;padding:0 16px}

.c{
  background:rgba(15,23,42,.86);
  border:1px solid var(--bd);
  border-radius:20px;
  padding:22px;
  margin:16px 0;
  backdrop-filter:blur(14px);
  box-shadow:var(--shadow-lg);
  animation:fadeIn .5s ease-out;
  transition:all .25s ease;
  position:relative;
  overflow:hidden;
}
.c::before{
  content:"";
  position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(56,189,248,.6),transparent);
  opacity:.55
}
.c:hover{border-color:rgba(56,189,248,.42);box-shadow:var(--shadow-xl)}

.r{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.hrow{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.n{opacity:.95;font-size:.95rem;color:#cbd5e1;line-height:1.6}
.small{font-size:.88rem;color:#b6c2d3;line-height:1.5}

.pill{
  background:var(--gradient-3);
  color:#001018;
  border-radius:999px;
  padding:10px 16px;
  font-weight:950;
  letter-spacing:.6px;
  text-transform:uppercase;
  font-size:.88rem;
  box-shadow:0 4px 16px rgba(56,189,248,.32);
  animation:glow 6s ease-in-out infinite;
  white-space:nowrap;
}
.lang{display:flex;gap:10px;align-items:center}
.langbtn{
  border:1px solid rgba(148,163,184,.28);
  background:rgba(11,18,32,.85);
  color:#cbd5e1;
  border-radius:999px;
  padding:8px 14px;
  font-weight:900;
  cursor:pointer;
  transition:all .18s ease;
  font-size:.84rem;
  letter-spacing:.5px;
}
.langbtn:hover{border-color:rgba(56,189,248,.55);transform:translateY(-1px)}
.langbtn.a{
  background:var(--gradient-3);
  color:#001018;
  border-color:#38bdf8;
  box-shadow:0 4px 14px rgba(56,189,248,.28)
}

.tabs{display:flex;gap:10px;margin:16px 0;flex-wrap:wrap;animation:slideIn .6s ease-out}
.tab{
  border:1px solid rgba(148,163,184,.25);
  background:rgba(11,18,32,.80);
  color:#cbd5e1;
  border-radius:999px;
  padding:10px 18px;
  cursor:pointer;
  font-weight:900;
  transition:all .18s ease;
  user-select:none;
  position:relative;
  overflow:hidden;
  font-size:.90rem;
  letter-spacing:.35px;
}
.tab:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(56,189,248,.28)}
.tab.a{background:var(--gradient-3);color:#001018;border-color:#38bdf8;box-shadow:0 4px 14px rgba(56,189,248,.36)}
.tab.dis{opacity:.40;cursor:not-allowed;filter:grayscale(.35)}
.tab.dis:hover{transform:none;box-shadow:none}

.b{
  background:var(--gradient-3);
  color:#001018;border:0;border-radius:14px;padding:12px 20px;
  cursor:pointer;font-weight:950;transition:all .18s ease;
  box-shadow:0 4px 15px rgba(56,189,248,.28);
  font-size:.95rem;letter-spacing:.3px;position:relative;overflow:hidden
}
.b:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(56,189,248,.42)}
.b.ok{background:var(--gradient-4);box-shadow:0 4px 15px rgba(67,233,123,.22)}
.b.ok:hover{box-shadow:0 6px 20px rgba(67,233,123,.42)}
.b.dis{opacity:.45;cursor:not-allowed;filter:grayscale(.25);transform:none;pointer-events:none}

.g{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
@media(max-width:900px){.g{grid-template-columns:1fr}}

#hx input[type=text],#hx input[type=number],#hx select,#hx textarea{
  width:100%;
  padding:12px 14px;
  border:1px solid rgba(148,163,184,.30);
  border-radius:12px;
  background:rgba(2,6,23,.86);
  color:var(--t);
  outline:none;
  transition:all .18s ease;
  font-size:.95rem;
  font-family:inherit;
}
#hx textarea{
  min-height:100px;
  resize:vertical;
}
#hx input[type=text]:focus,#hx input[type=number]:focus,#hx select:focus,#hx textarea:focus{
  border-color:#38bdf8;
  box-shadow:0 0 0 4px rgba(56,189,248,.14);
  background:rgba(2,6,23,.96)
}
#hx input[type=checkbox]{accent-color:#38bdf8;width:18px;height:18px;cursor:pointer}
#hx label{color:#cbd5e1;font-weight:750;margin-bottom:6px;display:block;font-size:.9rem;letter-spacing:.25px}

.gu{
  margin-top:12px;padding:14px 16px;
  background:rgba(56,189,248,.08);
  border:1px solid rgba(56,189,248,.25);
  border-radius:14px;color:#dbeafe;
  display:flex;gap:12px;align-items:flex-start;
  border-left:4px solid #38bdf8
}
.gu .a{font-weight:950;line-height:1.2;margin-top:1px;font-size:1.15rem}

.tst{
  position:fixed;left:50%;bottom:22px;transform:translateX(-50%);
  background:rgba(2,6,23,.94);
  border:1px solid rgba(148,163,184,.35);
  color:var(--t);padding:10px 14px;border-radius:12px;
  opacity:0;pointer-events:none;transition:.2s;z-index:99999
}
.tst.s{opacity:1}

.sig{
  max-width:1100px;margin:10px auto 18px;padding:10px 12px;
  color:#a5b4fc;background:rgba(10,16,28,.65);
  border:1px solid rgba(148,163,184,.25);border-radius:12px;
  display:flex;gap:12px;align-items:center;justify-content:space-between;font-size:.95rem
}
.sig .br{font-weight:950;color:#e2e8f0}
.sig a{color:#93c5fd;text-decoration:none}
.sig a:hover{text-decoration:underline}

.cardx{
  margin-top:16px;
  background:linear-gradient(135deg,rgba(15,23,42,.86),rgba(11,18,32,.92));
  border:1px solid rgba(148,163,184,.25);
  border-radius:16px;padding:20px;
  box-shadow:0 4px 22px rgba(0,0,0,.22)
}
.cardx .top{
  display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;
  padding-bottom:16px;border-bottom:1px solid rgba(148,163,184,.14)
}
.cardx .title{font-weight:1000;color:#f1f5f9;font-size:1.15rem}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{
  border:1px solid rgba(148,163,184,.30);
  background:rgba(11,18,32,.82);
  color:#cbd5e1;border-radius:999px;
  padding:8px 14px;font-weight:850;font-size:.85rem;transition:.15s;
  text-shadow:0 1px 8px rgba(0,0,0,.25);
}
.chip:hover{transform:translateY(-1px)}
.chip.good{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.12);color:#86efac}
.chip.bad{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.12);color:#fca5a5}
.chip.warn{border-color:rgba(245,158,11,.45);background:rgba(245,158,11,.12);color:#fde68a}
.chip.neu{border-color:rgba(148,163,184,.35);color:#e2e8f0}

.body{margin-top:16px;color:#cbd5e1;line-height:1.65;font-size:.95rem}
.body b{color:#f8fafc;font-weight:800}

.grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:16px}
@media(max-width:980px){.grid3{grid-template-columns:1fr}}

.mini{
  background:linear-gradient(135deg,rgba(14,165,233,.10),rgba(6,182,212,.06));
  border:1px solid rgba(148,163,184,.25);
  border-radius:14px;padding:14px;transition:.15s
}
.mini:hover{border-color:rgba(56,189,248,.40);transform:translateY(-1px)}
.mini .h{color:#94a3b8;font-size:.82rem;font-weight:800;text-transform:uppercase;letter-spacing:.5px}
.mini .v{
  font-weight:1000;color:#f8fafc;margin-top:6px;font-size:1.15rem;
  text-shadow:0 2px 12px rgba(0,0,0,.35);
}
.note{
  margin-top:16px;color:#cbd5e1;white-space:pre-wrap;
  background:rgba(2,6,23,.62);
  padding:16px;border-radius:12px;border:1px solid rgba(148,163,184,.20);
  line-height:1.7;font-size:.92rem
}

.k{
  background:
    linear-gradient(145deg,rgba(14,165,233,.10),rgba(6,182,212,.06));
  border:1px solid rgba(56,189,248,.30);
  border-radius:18px;padding:18px 14px;text-align:left;
  position:relative;overflow:hidden;
  box-shadow:0 4px 18px rgba(0,0,0,.25);
  min-height:86px;
}
.k::before{
  content:"";
  position:absolute;inset:-40%;
  background:radial-gradient(circle,rgba(56,189,248,.10),transparent 70%);
  pointer-events:none;transition:transform .6s ease;
}
.k:hover::before{transform:scale(1.12)}
.k span{
  color:#a6b3c6;font-size:.78rem;font-weight:900;
  text-transform:uppercase;letter-spacing:.9px;display:block
}
.k b{
  font-size:30px;display:block;color:#f1f5f9;margin-top:10px;font-weight:1000;
  text-shadow:0 2px 14px rgba(0,0,0,.45);
  line-height:1.05;
}
.k .sub{
  margin-top:8px;
  font-size:.82rem;
  color:#9fb0c6;
  line-height:1.25;
}
@media(max-width:520px){
  .k b{font-size:26px}
}

.pbar-wrap{margin-top:8px;background:rgba(255,255,255,.07);border-radius:999px;height:8px;overflow:hidden}
.pbar{height:8px;border-radius:999px;transition:width .9s cubic-bezier(.4,0,.2,1)}
.pbar.good{background:linear-gradient(90deg,#22c55e,#4ade80)}
.pbar.warn{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.pbar.bad{background:linear-gradient(90deg,#ef4444,#f87171)}

.tip{position:relative;display:inline-flex;align-items:center;gap:4px}
.tip-icon{
  width:16px;height:16px;border-radius:50%;
  background:rgba(148,163,184,.22);color:#b6c2d3;
  font-size:10px;font-weight:950;
  cursor:help;display:inline-flex;align-items:center;justify-content:center;
  border:1px solid rgba(148,163,184,.30);flex-shrink:0;user-select:none
}
.tip-box{
  position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);
  background:#0f172a;border:1px solid rgba(56,189,248,.35);
  border-radius:10px;padding:10px 14px;color:#cbd5e1;
  font-size:.82rem;line-height:1.5;width:240px;z-index:9999;
  box-shadow:0 10px 26px rgba(0,0,0,.55);
  pointer-events:none;opacity:0;transition:opacity .14s;
}
.tip:hover .tip-box,.tip:focus-within .tip-box{opacity:1}

.steps{display:flex;align-items:center;margin-bottom:16px;animation:fadeIn .45s ease-out}
.step{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1;position:relative}
.step-dot{
  width:32px;height:32px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-weight:1000;font-size:.85rem;
  transition:all .25s ease;
  border:2px solid rgba(148,163,184,.22);
  background:rgba(11,18,32,.82);
  color:#94a3b8;z-index:1
}
.step.done .step-dot{background:var(--gradient-4);color:#001018;border-color:#22c55e;box-shadow:0 0 12px rgba(34,197,94,.35)}
.step.active .step-dot{background:var(--gradient-3);color:#001018;border-color:#38bdf8;box-shadow:0 0 12px rgba(56,189,248,.42)}
.step-label{font-size:.72rem;color:#475569;font-weight:850;text-align:center;white-space:nowrap}
.step.done .step-label,.step.active .step-label{color:#94a3b8}
.step-line{
  position:absolute;top:15px;left:calc(50% + 17px);
  width:calc(100% - 34px);height:2px;background:rgba(148,163,184,.14);
  transition:background .3s;z-index:0
}
.step.done .step-line{background:rgba(34,197,94,.28)}

.share-bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;padding-top:12px;border-top:1px solid rgba(148,163,184,.12)}
.share-btn{
  border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.82);color:#cbd5e1;
  border-radius:10px;padding:8px 14px;cursor:pointer;font-weight:850;font-size:.82rem;
  transition:all .18s ease;display:flex;align-items:center;gap:6px
}
.share-btn:hover{transform:translateY(-2px)}
.share-btn.wa{border-color:rgba(37,211,102,.40);color:#4ade80}
.share-btn.wa:hover{background:rgba(37,211,102,.10);box-shadow:0 4px 12px rgba(37,211,102,.18)}
.share-btn.cl{border-color:rgba(56,189,248,.40);color:#7dd3fc}
.share-btn.cl:hover{background:rgba(56,189,248,.10);box-shadow:0 4px 12px rgba(56,189,248,.18)}

#hx input.field-ok{border-color:rgba(34,197,94,.50)!important}
#hx input.field-err{border-color:rgba(239,68,68,.52)!important;box-shadow:0 0 0 3px rgba(239,68,68,.10)!important}
.field-hint{font-size:.78rem;margin-top:4px;min-height:16px;transition:all .2s}
.field-hint.ok{color:#4ade80}
.field-hint.err{color:#f87171}

.range-bar{display:flex;gap:6px;align-items:center;margin-top:6px;flex-wrap:wrap}
.range-tag{font-size:.75rem;border-radius:8px;padding:2px 7px;font-weight:850}
.range-tag.lo{background:rgba(34,197,94,.12);color:#86efac;border:1px solid rgba(34,197,94,.25)}
.range-tag.hi{background:rgba(239,68,68,.12);color:#fca5a5;border:1px solid rgba(239,68,68,.25)}

.countdown{
  margin-top:10px;padding:12px 14px;background:rgba(245,158,11,.08);
  border:1px solid rgba(245,158,11,.25);border-radius:12px;border-left:4px solid #f59e0b;
  color:#fde68a;font-size:.88rem;line-height:1.6
}

#zoneWrap{margin-top:12px}
#zmap,#cmap{height:420px;border-radius:12px;border:1px solid rgba(148,163,184,.22);overflow:hidden;max-width:100%}
.pchips{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.pchip{
  border:1px solid rgba(148,163,184,.25);background:rgba(11,18,32,.75);color:#cbd5e1;border-radius:999px;
  padding:6px 10px;font-weight:1000;font-size:.85rem;cursor:pointer
}
.pchip.on{border-color:#38bdf8;color:#dbeafe}
.pchip.off{opacity:.75}
.legend{
  display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;
  padding:10px 12px;background:rgba(2,6,23,.45);
  border:1px solid rgba(148,163,184,.18);border-radius:12px;
  color:#bcd0ea;font-size:.86rem;
}
.legdot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:middle}
.leg1{background:#38bdf8}
.leg2{background:#22c55e}
.leg3{background:#ef4444}

.chartCard{
  background:linear-gradient(135deg,rgba(2,6,23,.35),rgba(15,23,42,.35));
  border:1px solid rgba(148,163,184,.18);
  border-radius:14px;
  padding:14px;
}
.canvasWrap{
  border:1px solid rgba(148,163,184,.16);
  border-radius:12px;
  overflow:hidden;
  background:rgba(2,6,23,.45);
}
canvas{display:block;width:100%;height:240px}
@media(max-width:700px){canvas{height:220px}}

.chat-container{
  display:flex;
  flex-direction:column;
  height:600px;
  background:linear-gradient(135deg,rgba(15,23,42,.86),rgba(11,18,32,.92));
  border:1px solid rgba(148,163,184,.25);
  border-radius:16px;
  overflow:hidden;
}
.chat-messages{
  flex:1;
  overflow-y:auto;
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:16px;
}
.chat-message{
  display:flex;
  gap:12px;
  animation:fadeIn .3s ease-out;
}
.chat-message.user{
  flex-direction:row-reverse;
}
.chat-avatar{
  width:36px;
  height:36px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  font-size:14px;
  flex-shrink:0;
}
.chat-avatar.ai{
  background:var(--gradient-3);
  color:#001018;
}
.chat-avatar.user{
  background:var(--gradient-4);
  color:#001018;
}
.chat-bubble{
  max-width:75%;
  padding:12px 16px;
  border-radius:16px;
  line-height:1.6;
  font-size:.92rem;
}
.chat-message.user .chat-bubble{
  background:rgba(56,189,248,.15);
  border:1px solid rgba(56,189,248,.25);
  color:#e5e7eb;
}
.chat-message.ai .chat-bubble{
  background:rgba(148,163,184,.08);
  border:1px solid rgba(148,163,184,.18);
  color:#cbd5e1;
}
.chat-bubble.thinking{
  font-style:italic;
  opacity:.7;
  animation:typing 1s ease-in-out infinite;
}
.chat-input-wrap{
  padding:16px;
  background:rgba(2,6,23,.8);
  border-top:1px solid rgba(148,163,184,.18);
  display:flex;
  gap:10px;
}
.chat-input{
  flex:1;
  padding:12px 14px;
  border:1px solid rgba(148,163,184,.30);
  border-radius:12px;
  background:rgba(2,6,23,.86);
  color:var(--t);
  outline:none;
  transition:all .18s ease;
  font-size:.95rem;
  font-family:inherit;
  resize:none;
  min-height:44px;
  max-height:120px;
}
.chat-input:focus{
  border-color:#38bdf8;
  box-shadow:0 0 0 4px rgba(56,189,248,.14);
}
.chat-send-btn{
  padding:12px 20px;
  background:var(--gradient-3);
  color:#001018;
  border:0;
  border-radius:12px;
  cursor:pointer;
  font-weight:900;
  transition:all .18s ease;
  box-shadow:0 4px 15px rgba(56,189,248,.28);
  white-space:nowrap;
}
.chat-send-btn:hover:not(:disabled){
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(56,189,248,.42);
}
.chat-send-btn:disabled{
  opacity:.4;
  cursor:not-allowed;
  transform:none;
}
.suggestion-chips{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:12px;
}
.suggestion-chip{
  padding:6px 12px;
  background:rgba(56,189,248,.1);
  border:1px solid rgba(56,189,248,.25);
  border-radius:999px;
  color:#7dd3fc;
  font-size:.82rem;
  cursor:pointer;
  transition:all .18s ease;
}
.suggestion-chip:hover{
  background:rgba(56,189,248,.18);
  transform:translateY(-1px);
}

::selection{background:rgba(56,189,248,.25)}
</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
<div class="w" id="hx">

  <div class="c hrow">
    <div class="pill" data-i="hdrTitle">Assessoria d'Habitatge ¬∑ Baix Pened√®s</div>
    <div class="r" style="justify-content:flex-end;flex:1">
      <div class="n" data-i="hdrHint">Ejemplos reales: solo despu√©s de Analizar.</div>
      <div class="lang">
        <button class="langbtn" id="L_CA" type="button">CA</button>
        <button class="langbtn a" id="L_ES" type="button">ES</button>
        <button class="langbtn" id="L_EN" type="button">EN</button>
      </div>
    </div>
  </div>

  <div class="steps" id="stepBar">
    <div class="step active" id="stp1"><div class="step-dot">1</div><div class="step-label" id="slbl1">Personal</div><div class="step-line"></div></div>
    <div class="step" id="stp2"><div class="step-dot">2</div><div class="step-label" id="slbl2">Econom√≠a</div><div class="step-line"></div></div>
    <div class="step" id="stp3"><div class="step-dot">3</div><div class="step-label" id="slbl3">Preferencias</div><div class="step-line"></div></div>
    <div class="step" id="stp4"><div class="step-dot">4</div><div class="step-label" id="slbl4">Resultado</div></div>
  </div>

  <div class="tabs">
    <div id="t_p" class="tab a" data-i="tab1">1 Personal</div>
    <div id="t_e" class="tab" data-i="tab2">2 Econom√≠a</div>
    <div id="t_f" class="tab" data-i="tab3">3 Preferencias</div>
    <div id="t_r" class="tab" data-i="tab4">4 Resultado</div>
    <div id="t_m" class="tab" data-i="tab5">5 Comparador</div>
    <div id="t_x" class="tab" data-i="tab6">6 Ejemplos reales</div>
    <div id="t_ai" class="tab" data-i="tab7">ü§ñ AI Advisor</div>
  </div>

  <div class="c" data-p="p">
    <div class="g">
      <div><label data-i="lblName">Nombre y apellidos</label><input id="nm" type="text" autocomplete="name"></div>
      <div><label data-i="lblAge">Edad (18‚Äì100)</label><input id="ag" type="number" min="18" max="100"></div>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintP">Rellena los datos b√°sicos para continuar.</div></div>
    <div class="r" style="margin-top:10px"><button class="b" id="np" type="button" data-i="btnContinue">Continuar</button></div>
  </div>

  <div class="c" data-p="e" style="display:none">
    <div class="g">
      <div>
        <label data-i="lblInc">Ingresos mensuales (‚Ç¨)</label>
        <div class="tip">
          <input id="inc" type="number" min="0">
          <span class="tip-icon" tabindex="0">i</span>
          <span class="tip-box" data-i="tipInc">Ingresos netos (lo que realmente entra en tu cuenta). Si metes bruto, la recomendaci√≥n se distorsiona.</span>
        </div>
        <div class="field-hint" id="hint-inc"></div>
      </div>

      <div>
        <label data-i="lblSav">Ahorros disponibles (‚Ç¨)</label>
        <div class="tip">
          <input id="sav" type="number" min="0">
          <span class="tip-icon" tabindex="0">i</span>
          <span class="tip-box" data-i="tipSav">Solo lo que puedes usar de verdad (no "dinero que igual me prestan"). Entrada + impuestos + notar√≠a van aqu√≠.</span>
        </div>
        <div class="field-hint" id="hint-sav"></div>
      </div>

      <div><label data-i="lblYrs">A√±os de hipoteca (5‚Äì40)</label><input id="yrs" type="number" min="5" max="40"></div>
      <div><label data-i="lblHor">¬øVivir√°s m√°s de 5 a√±os aqu√≠?</label><select id="hor"><option value="y" data-i="yes">S√≠</option><option value="n" data-i="no">No</option></select></div>
      <div><label data-i="lblFst">¬øPrimera vivienda o familia con menores?</label><select id="fst"><option value="y" data-i="yes">S√≠</option><option value="n" data-i="no">No</option></select></div>

      <div>
        <label data-i="lblMsv">Ahorro mensual (‚Ç¨)</label>
        <div class="tip">
          <input id="msv" type="number" min="0">
          <span class="tip-icon" tabindex="0">i</span>
          <span class="tip-box" data-i="tipMsv">Sirve para estimar cu√°nto tardas en llegar al "cash necesario" si hoy no te da.</span>
        </div>
      </div>
    </div>

    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintE">Completa econom√≠a y sigue a preferencias.</div></div>
    <div class="r" style="margin-top:10px"><button class="b" id="ne" type="button" data-i="btnContinue">Continuar</button></div>
  </div>

  <div class="c" data-p="f" style="display:none">
    <div class="g">
      <div>
        <label data-i="lblMuni">Municipio (Baix Pened√®s)</label>
        <select id="ar">
          <option value="*">Cualquiera</option>
          <option>Cunit</option><option>El Vendrell</option><option>Calafell</option><option>Santa Oliva</option><option>Bellvei</option>
          <option>L'Arbo√ß</option><option>Banyeres del Pened√®s</option><option>Albinyana</option><option>Bonastre</option><option>Maslloren√ß</option>
          <option>La Bisbal del Pened√®s</option><option>Lloren√ß del Pened√®s</option><option>Sant Jaume dels Domenys</option><option>El Montmell</option>
        </select>
        <div class="small" style="margin-top:6px" data-i="lblMuniHelp">Si usas el mapa puedes elegir varios municipios para 'Ejemplos reales'.</div>
      </div>

      <div>
        <label data-i="lblM2">Metros cuadrados (‚â•50)</label>
        <input id="m2" type="number" min="50">
        <div class="field-hint" id="hint-m2"></div>
      </div>

      <div><label data-i="lblBed">Habitaciones</label><input id="bed" type="number" min="0" max="10"></div>
      <div><label data-i="lblBath">Ba√±os</label><input id="bat" type="number" min="1" max="10"></div>
      <div><label data-i="lblType">Tipo de vivienda</label><select id="ty"><option value="flat" data-i="optFlat">Piso</option><option value="house" data-i="optHouse">Casa</option></select></div>

      <div class="r" style="align-items:flex-start">
        <div style="width:100%">
          <label data-i="lblExtras">Extras (opcional)</label>
          <div class="small" data-i="lblExtrasHint">No son "caprichos": cambian precio estimado y filtros de ejemplos reales.</div>
          <div class="r" style="margin-top:8px">
            <label><input type="checkbox" id="et"><span data-i="exTer">Terraza</span></label>
            <label><input type="checkbox" id="ep"><span data-i="exPis">Piscina</span></label>
            <label><input type="checkbox" id="el"><span data-i="exAsc">Ascensor</span></label>
            <label><input type="checkbox" id="ek"><span data-i="exGar">Aparcamiento</span></label>
            <label><input type="checkbox" id="es"><span data-i="exSto">Trastero</span></label>
            <label><input type="checkbox" id="ej"><span data-i="exGarD">Jard√≠n</span></label>
            <label><input type="checkbox" id="ea"><span data-i="exAir">Aire acondicionado</span></label>
          </div>
        </div>
      </div>
    </div>

    <div class="r" style="margin-top:10px">
      <button class="b" id="go" type="button" data-i="btnAnalyze">Analizar</button>
      <button class="b ok" id="toggleMap" type="button" data-i="btnMap">Mapa (zona real)</button>
    </div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintF">Si cambias preferencias, vuelve a Analizar para actualizar el resultado.</div></div>

    <div id="zoneWrap" class="cardx" style="display:none">
      <div class="top">
        <div>
          <div class="title" data-i="zoneTitle">Zona preferida (mapa real)</div>
          <div class="n" data-i="zoneHint">Haz clic en un pol√≠gono para seleccionar municipios. Puedes elegir varios del Baix Pened√®s.</div>
          <div class="n" id="zoneNote" style="margin-top:6px">Seleccionados: ninguno</div>
        </div>
        <div class="pchips" id="zoneChips"></div>
      </div>

      <div class="r" style="margin-top:10px;justify-content:flex-end">
        <button class="b" id="zoneClear" type="button" data-i="btnClear">Limpiar</button>
        <button class="b ok" id="zoneApply" type="button" data-i="btnUse">Usar en Ejemplos reales</button>
      </div>

      <div id="zmap" style="margin-top:10px"></div>

      <div class="legend">
        <span><span class="legdot leg1"></span><span data-i="legSel">Seleccionado</span></span>
        <span><span class="legdot leg2"></span><span data-i="legOk">Disponible</span></span>
        <span style="opacity:.9" data-i="legNote">L√≠mites municipales reales (pol√≠gonos).</span>
      </div>

      <div class="n" id="zoneApplied" style="margin-top:10px;color:#7dd3fc"></div>
    </div>
  </div>

  <div class="c" data-p="r" style="display:none">
    <div class="g">
      <div class="k">
        <span data-i="kPrice">Precio estimado</span>
        <b id="k1">0 ‚Ç¨</b>
        <div class="sub" id="k1sub"></div>
      </div>
      <div class="k">
        <span data-i="kRent">Alquiler estimado</span>
        <b id="k2">0 ‚Ç¨</b>
        <div class="sub" id="k2sub"></div>
      </div>
      <div class="k">
        <span data-i="kPay">Cuota hipoteca</span>
        <b id="k3">0 ‚Ç¨</b>
        <div class="sub" id="k3sub"></div>
      </div>
      <div class="k">
        <span data-i="kRec">Recomendaci√≥n</span>
        <b id="k4">‚Äì</b>
        <div class="sub" id="k4sub"></div>
      </div>
    </div>

    <div id="rCard" class="cardx" style="display:none">
      <div class="top">
        <div class="title" id="rTitle"></div>
        <div class="chips" id="rChips"></div>
      </div>

      <div class="grid3" id="rMini"></div>

      <div class="grid3" style="margin-top:14px">
        <div class="chartCard">
          <div style="font-weight:950;color:#eaf2ff" data-i="chartEffTitle">Esfuerzo mensual (visual)</div>
          <div class="small" data-i="chartEffHint">L√≠nea: "capacidad segura" (35% de ingresos). Barras: hipoteca vs alquiler.</div>
          <div class="canvasWrap" style="margin-top:10px"><canvas id="effChart"></canvas></div>
        </div>
        <div class="chartCard">
          <div style="font-weight:950;color:#eaf2ff" data-i="chartSensTitle">Sensibilidad (tipo de inter√©s)</div>
          <div class="small" data-i="chartSensHint">C√≥mo cambia la cuota si sube el tipo. No predice el futuro, solo muestra el riesgo.</div>
          <div class="canvasWrap" style="margin-top:10px"><canvas id="sensChart"></canvas></div>
        </div>
        <div class="chartCard">
          <div style="font-weight:950;color:#eaf2ff" data-i="chartTipsTitle">Lectura r√°pida</div>
          <div class="small" id="chartTips"></div>
          <div style="margin-top:10px;padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.18);background:rgba(2,6,23,.35);color:#cbd5e1;line-height:1.65" id="quickExplain"></div>
        </div>
      </div>

      <div class="body" id="rBody"></div>
      <div class="note" id="rt"></div>
    </div>

    <div class="r" style="margin-top:10px">
      <button class="b" id="cp" type="button" data-i="btnCopy">Copiar resumen</button>
      <button class="b" id="rs" type="button" data-i="btnReset">Reiniciar</button>
      <button class="b ok" id="jumpX" type="button" data-i="btnGoExamples">Ir a Ejemplos reales</button>
      <button class="b ok" id="jumpAI" type="button" data-i="btnAskAI">üí¨ Consultar con AI</button>
    </div>
    <div class="share-bar">
      <button class="share-btn wa" id="shareWa" type="button">üì± WhatsApp</button>
      <button class="share-btn cl" id="shareCl" type="button">üìã <span data-i="btnCopy2">Copiar</span></button>
    </div>
  </div>

  <div class="c" data-p="m" style="display:none">
    <div class="g">
      <div><label data-i="lblProv">Provincia (comparador)</label><select id="cm"><option>Barcelona</option><option>Girona</option><option>Lleida</option><option>Tarragona</option></select></div>
      <div><label data-i="lblM2s">m¬≤</label><input id="cm2" type="number" min="50"></div>
      <div><label data-i="lblBed">Habitaciones</label><input id="cbd" type="number" min="0" max="10"></div>
      <div><label data-i="lblBath">Ba√±os</label><input id="cba" type="number" min="1" max="10"></div>
      <div><label data-i="lblType2">Tipo</label><select id="cty"><option value="flat" data-i="optFlat">Piso</option><option value="house" data-i="optHouse">Casa</option></select></div>

      <div class="r" style="align-items:flex-start">
        <div style="width:100%">
          <label data-i="lblExtras2">Extras (comparador)</label>
          <div class="small" data-i="lblExtrasHint2">El comparador intenta ser justo: mismas caracter√≠sticas, distinta zona.</div>
          <div class="r" style="margin-top:8px">
            <label><input type="checkbox" id="ct"><span data-i="exTer">Terraza</span></label>
            <label><input type="checkbox" id="cp0"><span data-i="exPis">Piscina</span></label>
            <label><input type="checkbox" id="cl0"><span data-i="exAsc">Ascensor</span></label>
            <label><input type="checkbox" id="ck0"><span data-i="exGar">Aparcamiento</span></label>
            <label><input type="checkbox" id="cs0"><span data-i="exSto">Trastero</span></label>
            <label><input type="checkbox" id="cj0"><span data-i="exGarD">Jard√≠n</span></label>
            <label><input type="checkbox" id="ca0"><span data-i="exAir">Aire acondicionado</span></label>
          </div>
        </div>
      </div>
    </div>

    <div id="cmap" style="width:100%;height:320px;border:0;border-radius:12px;margin-top:12px"></div>

    <div class="r" style="margin-top:10px">
      <button class="b" id="bc" type="button" data-i="btnCompare">Comparar</button>
      <button class="b ok" id="autoFillCmp" type="button" data-i="btnUseMine">Usar mis datos</button>
    </div>

    <div class="cardx" style="margin-top:12px">
      <div class="top">
        <div class="title" data-i="cmpTitle">Resultado del comparador</div>
        <div class="chips" id="cmpChips"></div>
      </div>
      <div class="body" id="cmg"></div>

      <div class="chartCard" style="margin-top:14px">
        <div style="font-weight:950;color:#eaf2ff" data-i="cmpChartTitle">Comparaci√≥n visual</div>
        <div class="small" data-i="cmpChartHint">Tu zona (estimaci√≥n) vs provincia (estimaci√≥n). Misma vivienda, distinto contexto.</div>
        <div class="canvasWrap" style="margin-top:10px"><canvas id="cmpChart"></canvas></div>
      </div>
    </div>
  </div>

  <div class="c" data-p="x" style="display:none">
    <div class="n" id="xinfo"></div>
    <div class="r" style="margin-top:10px" id="xbtns"></div>
    <div class="gu"><span class="a">‚û°Ô∏è</span><div class="n" data-i="hintX">Si elegiste varios municipios, salen botones por municipio (Idealista no soporta multi-municipio en 1 sola URL).</div></div>
  </div>

  <div class="c" data-p="ai" style="display:none">
    <div class="cardx">
      <div class="top">
        <div class="title">ü§ñ AI Financial Advisor</div>
        <div class="chips">
          <span class="chip good" id="aiStatus">Conectado</span>
        </div>
      </div>

      <div class="gu" style="margin-top:0;margin-bottom:16px">
        <span class="a">üí°</span>
        <div class="n">
          <b>Tu asesor financiero personal.</b> Este chatbot est√° conectado con Claude AI y conoce toda tu informaci√≥n financiera y preferencias. 
          Puedes preguntarle cualquier cosa sobre tu situaci√≥n, estrategias de ahorro, c√≥mo mejorar tu capacidad de compra, alternativas de financiaci√≥n, etc.
        </div>
      </div>

      <div class="suggestion-chips" id="aiSuggestions">
        <div class="suggestion-chip" data-q="¬øQu√© puedo hacer para mejorar mi situaci√≥n?">¬øC√≥mo mejorar mi situaci√≥n?</div>
        <div class="suggestion-chip" data-q="¬øCu√°nto necesito ahorrar mensualmente?">¬øCu√°nto ahorrar al mes?</div>
        <div class="suggestion-chip" data-q="¬øEs mejor comprar o alquilar en mi caso?">¬øComprar o alquilar?</div>
        <div class="suggestion-chip" data-q="¬øQu√© municipios me recomiendas?">¬øQu√© municipios?</div>
        <div class="suggestion-chip" data-q="¬øC√≥mo afecta el tipo de inter√©s a mi cuota?">¬øY si sube el tipo?</div>
        <div class="suggestion-chip" data-q="¬øQu√© alternativas tengo si no me da para comprar?">¬øAlternativas?</div>
      </div>

      <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
          <div class="chat-message ai">
            <div class="chat-avatar ai">AI</div>
            <div class="chat-bubble">
              üëã ¬°Hola! Soy tu asesor financiero personal. He analizado tu situaci√≥n y estoy aqu√≠ para ayudarte con cualquier duda sobre vivienda, hipotecas, ahorros o planificaci√≥n financiera. ¬øEn qu√© puedo ayudarte hoy?
            </div>
          </div>
        </div>
        <div class="chat-input-wrap">
          <textarea class="chat-input" id="chatInput" placeholder="Escribe tu pregunta aqu√≠..." rows="1"></textarea>
          <button class="chat-send-btn" id="chatSend">Enviar</button>
        </div>
      </div>
    </div>
  </div>

</div>

<div class="sig">
  <div class="br">Assessoria d'Habitatge</div>
  <div>
    <a href="https://www.assesoriahabitatge.com/" target="_blank" rel="noopener">assesoriahabitatge.com</a> ¬∑
    <a href="mailto:info@assesoriahabitatge.com">info@assesoriahabitatge.com</a>
  </div>
</div>

<div id="ts" class="tst"></div>

<script>
const MUNICIPALITY_POLYGONS = {
  "Cunit": [[41.208,1.623],[41.214,1.634],[41.219,1.648],[41.216,1.655],[41.209,1.658],[41.202,1.654],[41.196,1.645],[41.194,1.635],[41.198,1.626],[41.203,1.621],[41.208,1.623]],
  "Calafell": [[41.192,1.558],[41.201,1.565],[41.209,1.578],[41.213,1.590],[41.210,1.600],[41.202,1.607],[41.193,1.608],[41.185,1.602],[41.181,1.591],[41.182,1.575],[41.186,1.564],[41.192,1.558]],
  "El Vendrell": [[41.209,1.520],[41.221,1.528],[41.231,1.541],[41.235,1.553],[41.232,1.565],[41.225,1.573],[41.215,1.575],[41.206,1.568],[41.201,1.555],[41.202,1.542],[41.205,1.530],[41.209,1.520]],
  "Santa Oliva": [[41.244,1.540],[41.255,1.547],[41.263,1.558],[41.264,1.570],[41.259,1.580],[41.250,1.585],[41.241,1.583],[41.235,1.574],[41.234,1.562],[41.237,1.549],[41.244,1.540]],
  "Bellvei": [[41.230,1.568],[41.240,1.574],[41.248,1.584],[41.250,1.595],[41.245,1.604],[41.237,1.608],[41.228,1.606],[41.222,1.597],[41.220,1.585],[41.223,1.575],[41.230,1.568]],
  "L'Arbo√ß": [[41.256,1.595],[41.267,1.602],[41.275,1.612],[41.277,1.624],[41.272,1.634],[41.263,1.638],[41.254,1.636],[41.247,1.627],[41.246,1.615],[41.250,1.603],[41.256,1.595]],
  "Banyeres del Pened√®s": [[41.272,1.568],[41.283,1.575],[41.291,1.586],[41.293,1.598],[41.288,1.608],[41.279,1.612],[41.270,1.610],[41.263,1.600],[41.262,1.588],[41.265,1.576],[41.272,1.568]],
  "Albinyana": [[41.235,1.478],[41.246,1.485],[41.254,1.495],[41.256,1.507],[41.251,1.517],[41.242,1.521],[41.233,1.519],[41.227,1.509],[41.226,1.497],[41.229,1.486],[41.235,1.478]],
  "Bonastre": [[41.218,1.430],[41.229,1.437],[41.237,1.447],[41.239,1.459],[41.234,1.469],[41.225,1.473],[41.216,1.471],[41.210,1.461],[41.209,1.449],[41.212,1.438],[41.218,1.430]],
  "Maslloren√ß": [[41.266,1.405],[41.277,1.412],[41.285,1.422],[41.287,1.434],[41.282,1.444],[41.273,1.448],[41.264,1.446],[41.258,1.436],[41.257,1.424],[41.260,1.413],[41.266,1.405]],
  "La Bisbal del Pened√®s": [[41.269,1.480],[41.280,1.487],[41.288,1.497],[41.290,1.509],[41.285,1.519],[41.276,1.523],[41.267,1.521],[41.261,1.511],[41.260,1.499],[41.263,1.488],[41.269,1.480]],
  "Lloren√ß del Pened√®s": [[41.273,1.540],[41.284,1.547],[41.292,1.557],[41.294,1.569],[41.289,1.579],[41.280,1.583],[41.271,1.581],[41.265,1.571],[41.264,1.559],[41.267,1.548],[41.273,1.540]],
  "Sant Jaume dels Domenys": [[41.290,1.550],[41.301,1.557],[41.309,1.567],[41.311,1.579],[41.306,1.589],[41.297,1.593],[41.288,1.591],[41.282,1.581],[41.281,1.569],[41.284,1.558],[41.290,1.550]],
  "El Montmell": [[41.298,1.445],[41.309,1.452],[41.317,1.462],[41.319,1.474],[41.314,1.484],[41.305,1.488],[41.296,1.486],[41.290,1.476],[41.289,1.464],[41.292,1.453],[41.298,1.445]]
};

let leafletAttempts=0;
function waitForLeaflet(){
  if(typeof L!=="undefined"){initApp();}
  else if(leafletAttempts++<100){setTimeout(waitForLeaflet,50);}
  else{alert("Error: Leaflet no pudo cargar. Recarga la p√°gina.");}
}

function initApp(){
(function(){
  const Q=s=>document.querySelector(s);
  const QA=s=>[...document.querySelectorAll(s)];
  const fmt=n=>Math.round(n).toLocaleString("es-ES");
  const toast=m=>{const e=Q("#ts");e.textContent=m;e.classList.add("s");setTimeout(()=>e.classList.remove("s"),2000)};

  const STORE_KEY="hx_form_v9";
  const ZONE_KEY="hx_zoneSel_v6";
  const LANG_KEY="hx_lang";
  const CHAT_KEY="hx_chat_history_v1";

  const I18N={
    ES:{
      hdrTitle:"Assessoria d'Habitatge ¬∑ Baix Pened√®s",hdrHint:"Ejemplos reales: solo despu√©s de Analizar.",
      tab1:"1 Personal",tab2:"2 Econom√≠a",tab3:"3 Preferencias",tab4:"4 Resultado",tab5:"5 Comparador",tab6:"6 Ejemplos reales",tab7:"ü§ñ AI Advisor",
      lblName:"Nombre y apellidos",lblAge:"Edad (18‚Äì100)",btnContinue:"Continuar",
      hintP:"Rellena los datos b√°sicos para continuar.",
      lblInc:"Ingresos mensuales (‚Ç¨)",lblSav:"Ahorros disponibles (‚Ç¨)",lblYrs:"A√±os de hipoteca (5‚Äì40)",lblHor:"¬øVivir√°s m√°s de 5 a√±os aqu√≠?",lblFst:"¬øPrimera vivienda o familia con menores?",lblMsv:"Ahorro mensual (‚Ç¨)",
      tipInc:"Ingresos netos (lo que realmente entra en tu cuenta). Si metes bruto, la recomendaci√≥n se distorsiona.",
      tipSav:"Solo lo que puedes usar de verdad (no "dinero que igual me prestan"). Entrada + impuestos + notar√≠a van aqu√≠.",
      tipMsv:"Sirve para estimar cu√°nto tardas en llegar al "cash necesario" si hoy no te da.",
      hintE:"Completa econom√≠a y sigue a preferencias.",
      lblMuni:"Municipio (Baix Pened√®s)",lblMuniHelp:"Si usas el mapa puedes elegir varios municipios para 'Ejemplos reales'.",
      lblM2:"Metros cuadrados (‚â•50)",lblBed:"Habitaciones",lblBath:"Ba√±os",lblType:"Tipo de vivienda",optFlat:"Piso",optHouse:"Casa",
      lblExtras:"Extras (opcional)",lblExtrasHint:"No son "caprichos": cambian precio estimado y filtros de ejemplos reales.",
      exTer:"Terraza",exPis:"Piscina",exAsc:"Ascensor",exGar:"Aparcamiento",exSto:"Trastero",exGarD:"Jard√≠n",exAir:"Aire acondicionado",
      btnAnalyze:"Analizar",btnMap:"Mapa (zona real)",hintF:"Si cambias preferencias, vuelve a Analizar para actualizar el resultado.",
      zoneTitle:"Zona preferida (mapa real)",zoneHint:"Haz clic en un pol√≠gono para seleccionar municipios. Puedes elegir varios del Baix Pened√®s.",
      btnClear:"Limpiar",btnUse:"Usar en Ejemplos reales",
      legSel:"Seleccionado",legOk:"Disponible",legNote:"L√≠mites municipales reales (pol√≠gonos).",
      kPrice:"Precio estimado",kRent:"Alquiler estimado",kPay:"Cuota hipoteca",kRec:"Recomendaci√≥n",
      btnCopy:"Copiar resumen",btnReset:"Reiniciar",btnGoExamples:"Ir a Ejemplos reales",btnAskAI:"üí¨ Consultar con AI",
      chartEffTitle:"Esfuerzo mensual (visual)",chartEffHint:"L√≠nea: "capacidad segura" (35% de ingresos). Barras: hipoteca vs alquiler.",
      chartSensTitle:"Sensibilidad (tipo de inter√©s)",chartSensHint:"C√≥mo cambia la cuota si sube el tipo. No predice el futuro, solo muestra el riesgo.",
      chartTipsTitle:"Lectura r√°pida",
      lblProv:"Provincia (comparador)",lblM2s:"m¬≤",lblType2:"Tipo",btnCompare:"Comparar",btnUseMine:"Usar mis datos",
      lblExtras2:"Extras (comparador)",lblExtrasHint2:"El comparador intenta ser justo: mismas caracter√≠sticas, distinta zona.",
      cmpTitle:"Resultado del comparador",cmpChartTitle:"Comparaci√≥n visual",cmpChartHint:"Tu zona (estimaci√≥n) vs provincia (estimaci√≥n). Misma vivienda, distinto contexto.",
      hintX:"Si elegiste varios municipios, salen botones por municipio (Idealista no soporta multi-municipio en 1 sola URL).",
      yes:"S√≠",no:"No",
      recBuy:"COMPRAR",recRent:"ALQUILAR",recNotFeasible:"NO FACTIBLE",
      toastCheckNameAge:"Revisa nombre/edad y que m¬≤/ba√±os sean v√°lidos.",
      toastFirstAnalyze:"Primero analiza.",
      toastPrefsChanged:"Preferencias cambiadas: vuelve a Analizar.",
      toastNoLink:"No se pudo generar el link",
      toastCopied:"Copiado",
      toastZoneCleared:"Zona limpiada",
      toastNoZone:"No hay municipios seleccionados",
      toastZoneApplied:"Zona aplicada a Ejemplos reales",
      stateReady:"‚úÖ Disponible",
      stateNeedAnalyze:"‚õî Requiere Analizar / re-Analizar",
      xInfo:"Municipio (Preferencias): {muni} ¬∑ Estado: {state}.",
      sumTitle:"Resumen claro ¬∑ {rec}",
      chipMort:"Esfuerzo hipoteca: {pct}",
      chipRent:"Esfuerzo alquiler: {pct}",
      chipCash:"Entrada+gastos: {eur}",
      chipRate:"Tipo: {rate}",
      miniPrice:"Precio estimado",
      miniPay:"Cuota hipoteca",
      miniRent:"Alquiler estimado",
      reportHello:"Hola {name},",
      reportPrice:"Precio estimado: {eur}.",
      reportHome:"Vivienda: {muni} ¬∑ {m2} m¬≤ ¬∑ {bed} hab ¬∑ {bath} ba√±os ¬∑ {type}.",
      reportDown:"Entrada: {dp}% ‚Üí {down} ‚Ç¨ ¬∑ Gastos: {cl} ‚Ç¨. (Incluye ITP aprox.)",
      reportFin:"A financiar: {cap} ‚Ç¨ ¬∑ Plazo: {yrs} a√±os ¬∑ Tipo: {rate}.",
      reportPay:"Cuota hipoteca: {pay} ‚Ç¨ ¬∑ Alquiler: {rent} ‚Ç¨.",
      reportRec:"Recomendaci√≥n: {rec}",
      any:"Cualquiera",
      btnCopy2:"Copiar",
      savingsOk:"‚úÖ Ahorros suficientes para la entrada + costes.",
      yearsToSave:"Con {msv}/mes, alcanzar√°s el objetivo en ~{yrs} a√±os ({mos} meses).",
      itpNote:"En Catalunya, la compraventa suele implicar ~10% ITP + notar√≠a/registro (aprox.). Aqu√≠ se mete como "costes" para no venderte humo.",
      avgZone:"Media de {n} municipios",
      stepPersonal:"Personal",stepEco:"Econom√≠a",stepPref:"Preferencias",stepRes:"Resultado",
      cmpCheaper:"m√°s barato",cmpExpensive:"m√°s caro",cmpSame:"igual",
      cmpExplTitle:"Interpretaci√≥n humana",
      cmpExpl1:"No es "mejor provincia", es "encaje con tu presupuesto y movilidad".",
      cmpExpl2:"Mismo tama√±o + extras: si aqu√≠ es m√°s barato, quiz√° ganas margen; si es m√°s caro, necesitas m√°s cash o aceptar recortes.",
      cmpExpl3:"El alquiler comparado sirve para entender alternativa: pagar m√°s por alquilar puede ser normal si compras es inviable.",
      validateIncome:"Introduce ingresos v√°lidos",
      validateSavings:"Introduce tus ahorros",
      validateM2:"M√≠nimo 50 m¬≤",
      missingDataCmp:"Completa provincia, m¬≤ y ba√±os (m√≠nimo 1)."
    },
    CA:{},
    EN:{}
  };

  let LANG=localStorage.getItem(LANG_KEY)||"ES";
  const t=k=>(I18N[LANG]&&I18N[LANG][k])||(I18N.ES[k]||k);
  const tpl=(s,vars)=>String(s||"").replace(/\{(\w+)\}/g,(_,k)=>(vars&&vars[k]!=null)?vars[k]:"");

  const fmtMoney=n=>(!isFinite(n)?"‚Äì":fmt(n)+" ‚Ç¨");
  const fmtPct=n=>Number(n).toFixed(1)+"%";

  const applyStaticI18n=()=>{QA("[data-i]").forEach(el=>{const k=el.getAttribute("data-i");const v=t(k);if(v!=null)el.textContent=v})};

  const setLang=l=>{
    LANG=l;localStorage.setItem(LANG_KEY,l);
    document.documentElement.lang=(l==="CA"?"ca":l==="ES"?"es":"en");
    Q("#L_CA").classList.toggle("a",l==="CA");Q("#L_ES").classList.toggle("a",l==="ES");Q("#L_EN").classList.toggle("a",l==="EN");
    applyStaticI18n();renderZoneUI();renderResult();refreshExamplesUI();updateSteps(document.querySelector("[data-p][style*='block']")?.getAttribute("data-p")||"p");liveValidate();
  };

  const STORE_FIELDS_NUM=["ag","inc","sav","yrs","msv","m2","bed","bat","cm2","cbd","cba"];
  const STORE_FIELDS_SEL=["ar","ty","hor","fst","cm","cty"];
  const STORE_FIELDS_CHK=["et","ep","el","ek","es","ej","ea","ct","cp0","cl0","ck0","cs0","cj0","ca0"];

  const loadForm=()=>{
    let s=localStorage.getItem(STORE_KEY);if(!s)return;
    try{
      let d=JSON.parse(s)||{};
      STORE_FIELDS_NUM.forEach(id=>{if(d[id]!=null&&Q("#"+id))Q("#"+id).value=d[id]});
      STORE_FIELDS_SEL.forEach(id=>{if(d[id]!=null&&Q("#"+id))Q("#"+id).value=d[id]});
      STORE_FIELDS_CHK.forEach(id=>{if(Q("#"+id)&&d[id]!=null)Q("#"+id).checked=!!d[id]});
      if(d.nm!=null&&Q("#nm"))Q("#nm").value=d.nm;
    }catch(e){}
  };

  const saveForm=()=>{
    let d={};
    STORE_FIELDS_NUM.forEach(id=>{if(Q("#"+id))d[id]=Q("#"+id).value});
    STORE_FIELDS_SEL.forEach(id=>{if(Q("#"+id))d[id]=Q("#"+id).value});
    STORE_FIELDS_CHK.forEach(id=>{if(Q("#"+id))d[id]=Q("#"+id).checked?1:0});
    if(Q("#nm"))d.nm=Q("#nm").value;
    localStorage.setItem(STORE_KEY,JSON.stringify(d));
  };

  const updateSteps=p=>{
    const stepMap={p:1,e:2,f:3,r:4,m:4,x:4,ai:4};
    const cur=stepMap[p]||1;
    [1,2,3,4].forEach(i=>{
      const s=Q("#stp"+i);if(!s)return;
      s.classList.remove("active","done");
      if(i<cur)s.classList.add("done");
      else if(i===cur)s.classList.add("active");
    });
    const lbls=[t("stepPersonal"),t("stepEco"),t("stepPref"),t("stepRes")];
    lbls.forEach((l,i)=>{const el=Q("#slbl"+(i+1));if(el)el.textContent=l});
  };

  const show=p=>{
    QA("[data-p]").forEach(x=>x.style.display=x.getAttribute("data-p")==p?"block":"none");
    ["p","e","f","r","m","x","ai"].forEach(k=>Q("#t_"+k)?.classList.toggle("a",p===k));
    updateSteps(p);
    if(p==="m")setTimeout(()=>upMap(),100);
    if(p==="x")refreshExamplesUI();
    if(p==="ai")setTimeout(()=>initChatUI(),100);
    window.scrollTo({top:0,behavior:"smooth"});
  };

  const mort=(c,r,y)=>{let m=r/12,n=y*12;return r===0?c/n:c*(m*Math.pow(1+m,n))/(Math.pow(1+m,n)-1)};

  const COEF={"Cunit":{c:1.157,r:.975},"El Vendrell":{c:.912,r:.842},"Calafell":{c:.856,r:.983},"Santa Oliva":{c:.783,r:.825},"Bellvei":{c:.783,r:.925},"L'Arbo√ß":{c:.735,r:.883},"Banyeres del Pened√®s":{c:.614,r:.783},"Albinyana":{c:.766,r:.825},"Bonastre":{c:.497,r:.683},"Maslloren√ß":{c:.549,r:.75},"La Bisbal del Pened√®s":{c:.623,r:.808},"Lloren√ß del Pened√®s":{c:.856,r:.65},"Sant Jaume dels Domenys":{c:.614,r:.65},"El Montmell":{c:.529,r:.675}};
  const BASE={m2:2000,rent:10,close:.11,rate:.0299};
  const M={"Barcelona":{v:2986,l:21.9},"Girona":{v:2608,l:14.99},"Lleida":{v:1486,l:9.5},"Tarragona":{v:2100,l:13.5}};

  const extraImpactBuy=(base,e)=>{
    let x=0;
    if(e.t)x+=base*.05;if(e.p)x+=base*.08;if(e.l)x+=base*.04;if(e.k)x+=base*.03;
    if(e.s)x+=base*.02;if(e.j)x+=base*.05;if(e.a)x+=base*.015;
    return x;
  };
  const extraImpactRent=(base,e)=>{
    let x=0;
    if(e.t)x+=base*.15;if(e.p)x+=base*.30;if(e.l)x+=base*.08;if(e.k)x+=base*.07;
    if(e.s)x+=base*.05;if(e.j)x+=base*.18;if(e.a)x+=base*.06;
    return x;
  };

  const buy=(a,m2,b,ba,e)=>{
    let base=m2*BASE.m2*(COEF[a]?.c||1),adj=b*5e3+ba*3e3;
    return Math.round(base+adj+extraImpactBuy(base,e));
  };
  const rent=(a,m2,b,ba,e)=>{
    let base=m2*BASE.rent*(COEF[a]?.r||1),adj=b*50+ba*30;
    return Math.round(base+adj+extraImpactRent(base,e));
  };
  const buyM=(m,m2,b,ba,e)=>{
    let p=M[m];if(!p)return NaN;
    let base=m2*p.v,adj=b*5e3+ba*3e3;
    return Math.round(base+adj+extraImpactBuy(base,e));
  };
  const rentM=(m,m2,b,ba,e)=>{
    let p=M[m];if(!p)return NaN;
    let base=m2*p.l,adj=b*50+ba*30;
    return Math.round(base+adj+extraImpactRent(base,e));
  };

  let last=null,lastReq=null,lastReqSig="";

  const reqFromUI=()=>({
    muni:Q("#ar").value,type:Q("#ty").value,m2:+Q("#m2").value||null,
    bed:(Q("#bed").value===""?null:+Q("#bed").value),
    bath:+Q("#bat").value||null,
    ex:{
      t:Q("#et").checked?1:0,p:Q("#ep").checked?1:0,l:Q("#el").checked?1:0,k:Q("#ek").checked?1:0,
      s:Q("#es").checked?1:0,j:Q("#ej").checked?1:0,a:Q("#ea").checked?1:0
    }
  });
  const sigOfReq=r=>[r.muni,r.type,r.m2,r.bed,r.bath,r.ex.t,r.ex.p,r.ex.l,r.ex.k,r.ex.s,r.ex.j,r.ex.a].join("|");
  const prefsChangedSinceAnalyze=()=>{if(!lastReq)return true;return sigOfReq(reqFromUI())!==lastReqSig};
  const setTabsEnabled=()=>{
    const needA=!lastReq;
    ["#t_r","#t_m","#t_x","#t_ai"].forEach(id=>Q(id)?.classList.toggle("dis",needA));
  };

  const typeLabel=type=>type==="flat"?t("optFlat"):t("optHouse");
  const muniLabel=muni=>{
    if(muni==="*")return t("any");
    if(muni==="__multi__")return[...zoneSel].join(", ");
    return muni;
  };

  const dpr=()=>window.devicePixelRatio||1;
  const setupCanvas=cv=>{
    const r=dpr();
    const rect=cv.getBoundingClientRect();
    cv.width=Math.max(320,Math.round(rect.width*r));
    cv.height=Math.max(220,Math.round(rect.height*r));
    const ctx=cv.getContext("2d");
    ctx.setTransform(r,0,0,r,0,0);
    return ctx;
  };
  const clear=(ctx,w,h)=>{
    ctx.clearRect(0,0,w,h);
    ctx.globalAlpha=1;ctx.lineWidth=1;ctx.strokeStyle="rgba(148,163,184,.12)";
    for(let i=0;i<6;i++){const y=14+i*(h-28)/5;ctx.beginPath();ctx.moveTo(12,y);ctx.lineTo(w-12,y);ctx.stroke()}
  };
  const drawText=(ctx,txt,x,y,sz,clr,align)=>{
    ctx.fillStyle=clr||"#cbd5e1";
    ctx.font=`${sz||12}px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif`;
    ctx.textAlign=align||"left";
    ctx.fillText(txt,x,y);
  };

  const drawEffortChart=()=>{
    if(!last)return;
    const cv=Q("#effChart");if(!cv)return;
    const ctx=setupCanvas(cv);
    const w=cv.clientWidth,h=cv.clientHeight;
    clear(ctx,w,h);

    const safe=last.inc*0.35;
    const buyV=last.pay;
    const rentV=last.pr;
    const maxV=Math.max(safe,buyV,rentV)*1.15||1;

    const padL=12,padR=12,padT=18,padB=26;
    const plotW=w-padL-padR,plotH=h-padT-padB;
    const y0=padT+plotH;
    const safeLine=plotH*(1-safe/maxV);

    ctx.strokeStyle="rgba(245,158,11,.8)";ctx.lineWidth=2;ctx.setLineDash([6,4]);
    ctx.beginPath();ctx.moveTo(padL,padT+safeLine);ctx.lineTo(w-padR,padT+safeLine);ctx.stroke();
    ctx.setLineDash([]);

    const barW=Math.min(60,plotW/5);
    const x1=padL+plotW*0.25-barW/2;
    const x2=padL+plotW*0.75-barW/2;

    const h1=plotH*(buyV/maxV);
    const h2=plotH*(rentV/maxV);

    const g1=ctx.createLinearGradient(0,y0-h1,0,y0);
    g1.addColorStop(0,"#3b82f6");g1.addColorStop(1,"#1d4ed8");
    ctx.fillStyle=g1;ctx.fillRect(x1,y0-h1,barW,h1);

    const g2=ctx.createLinearGradient(0,y0-h2,0,y0);
    g2.addColorStop(0,"#22c55e");g2.addColorStop(1,"#15803d");
    ctx.fillStyle=g2;ctx.fillRect(x2,y0-h2,barW,h2);

    drawText(ctx,"Hipoteca",x1+barW/2,y0+18,11,"#94a3b8","center");
    drawText(ctx,"Alquiler",x2+barW/2,y0+18,11,"#94a3b8","center");
    drawText(ctx,fmtMoney(buyV),x1+barW/2,y0-h1-6,10,"#dbeafe","center");
    drawText(ctx,fmtMoney(rentV),x2+barW/2,y0-h2-6,10,"#86efac","center");
    drawText(ctx,"35%: "+fmtMoney(safe),w-padR-4,padT+safeLine-6,10,"#fde68a","right");
  };

  const drawSensChart=()=>{
    if(!last)return;
    const cv=Q("#sensChart");if(!cv)return;
    const ctx=setupCanvas(cv);
    const w=cv.clientWidth,h=cv.clientHeight;
    clear(ctx,w,h);

    const rates=[last.rate,last.rate+0.005,last.rate+0.01,last.rate+0.015,last.rate+0.02];
    const pays=rates.map(r=>mort(last.cap,r,last.yrs));
    const maxP=Math.max(...pays)*1.1||1;

    const padL=12,padR=12,padT=18,padB=26;
    const plotW=w-padL-padR,plotH=h-padT-padB;
    const y0=padT+plotH;
    const stepX=plotW/(rates.length-1);

    ctx.strokeStyle="rgba(56,189,248,.85)";ctx.lineWidth=2.5;ctx.beginPath();
    pays.forEach((p,i)=>{
      const x=padL+i*stepX;
      const y=y0-plotH*(p/maxP);
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    });
    ctx.stroke();

    pays.forEach((p,i)=>{
      const x=padL+i*stepX;
      const y=y0-plotH*(p/maxP);
      ctx.fillStyle=(i===0?"#38bdf8":"rgba(56,189,248,.65)");
      ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.fill();
      drawText(ctx,((rates[i]*100).toFixed(2)+"%"),x,y0+14,9,"#94a3b8","center");
      if(i===0||i===rates.length-1){drawText(ctx,fmtMoney(p),x,y-10,9,"#dbeafe","center")}
    });
  };

  const drawCmpChart=()=>{
    const cv=Q("#cmpChart");if(!cv)return;
    const ctx=setupCanvas(cv);
    const w=cv.clientWidth,h=cv.clientHeight;
    clear(ctx,w,h);

    if(!last||!last.cmpBuy||!last.cmpRent)return;
    const buyU=last.pb,buyC=last.cmpBuy;
    const rentU=last.pr,rentC=last.cmpRent;
    const maxV=Math.max(buyU,buyC,rentU,rentC)*1.12||1;

    const padL=12,padR=12,padT=18,padB=30;
    const plotW=w-padL-padR,plotH=h-padT-padB;
    const y0=padT+plotH;
    const barW=Math.min(55,plotW/8);

    const x1=padL+plotW*0.25-barW;
    const x2=padL+plotW*0.25;
    const x3=padL+plotW*0.75-barW;
    const x4=padL+plotW*0.75;

    const h1=plotH*(buyU/maxV);
    const h2=plotH*(buyC/maxV);
    const h3=plotH*(rentU/maxV);
    const h4=plotH*(rentC/maxV);

    const g1=ctx.createLinearGradient(0,y0-h1,0,y0);g1.addColorStop(0,"#3b82f6");g1.addColorStop(1,"#1d4ed8");
    ctx.fillStyle=g1;ctx.fillRect(x1,y0-h1,barW,h1);

    const g2=ctx.createLinearGradient(0,y0-h2,0,y0);g2.addColorStop(0,"#8b5cf6");g2.addColorStop(1,"#6d28d9");
    ctx.fillStyle=g2;ctx.fillRect(x2,y0-h2,barW,h2);

    const g3=ctx.createLinearGradient(0,y0-h3,0,y0);g3.addColorStop(0,"#22c55e");g3.addColorStop(1,"#15803d");
    ctx.fillStyle=g3;ctx.fillRect(x3,y0-h3,barW,h3);

    const g4=ctx.createLinearGradient(0,y0-h4,0,y0);g4.addColorStop(0,"#f59e0b");g4.addColorStop(1,"#d97706");
    ctx.fillStyle=g4;ctx.fillRect(x4,y0-h4,barW,h4);

    drawText(ctx,"Compra Tu",x1+barW/2,y0+16,9,"#94a3b8","center");
    drawText(ctx,"Compra Prov",x2+barW/2,y0+16,9,"#94a3b8","center");
    drawText(ctx,"Alq Tu",x3+barW/2,y0+16,9,"#94a3b8","center");
    drawText(ctx,"Alq Prov",x4+barW/2,y0+16,9,"#94a3b8","center");
  };

  const analyze=()=>{
    const nm=(Q("#nm").value||"").trim(),ag=+Q("#ag").value||0;
    const inc=+Q("#inc").value||0,sav=+Q("#sav").value||0,yrs=+Q("#yrs").value||25;
    const msv=+Q("#msv").value||0;
    const ar=Q("#ar").value,m2=+Q("#m2").value||0,bd=(Q("#bed").value===""?0:+Q("#bed").value)||0,ba=+Q("#bat").value||0;
    const ty=Q("#ty").value;

    if(!nm||ag<18||ag>100||m2<50||ba<1){toast(t("toastCheckNameAge"));return}

    const e={
      t:Q("#et").checked,p:Q("#ep").checked,l:Q("#el").checked,k:Q("#ek").checked,
      s:Q("#es").checked,j:Q("#ej").checked,a:Q("#ea").checked
    };

    let pb,munis=[];
    if((ar==="*"||ar==="__multi__")&&zoneSel.size>1){
      munis=[...zoneSel];
      pb=Math.round(munis.map(m=>buy(m,m2,bd,ba,e)).reduce((a,b)=>a+b,0)/munis.length);
    }else{
      const baseM=(ar==="__multi__"&&zoneSel.size===1)?[...zoneSel][0]:(ar==="*"?"Cunit":ar);
      munis=[baseM];
      pb=buy(baseM,m2,bd,ba,e);
    }

    let pr=0;
    if(munis.length>1){
      pr=Math.round(munis.map(m=>rent(m,m2,bd,ba,e)).reduce((a,b)=>a+b,0)/munis.length);
    }else{
      pr=rent(munis[0],m2,bd,ba,e);
    }

    const dp=Q("#fst").value==="y"?0.1:0.2;
    const down=pb*dp,cl=pb*BASE.close;
    const needCash=Math.round(down+cl);
    let cap=Math.max(0,pb-down);
    let rate=BASE.rate;
    if(sav<needCash)rate+=0.006;

    const pay=mort(cap,rate,yrs);
    const ratioM=inc>0?(pay/inc)*100:999;
    const ratioR=inc>0?(pr/inc)*100:999;
    const need=sav<needCash;
    const ratioOK=ratioM<=35;
    const hor=Q("#hor").value==="y";

    let recCode=(!need&&ratioOK&&hor)?"BUY":"RENT";
    let rec=t(recCode==="BUY"?"recBuy":"recRent");

    last={nm,m2,bd,ba,pb,cap,rate,yrs,down,cl,pay,ratioM,ratioR,rec,recCode,needCash,inc,sav,msv,pr,dp,munis,ty};
    lastReq={ar,m2,bd,ba,e};
    lastReqSig=sigOfReq(lastReq);

    setTabsEnabled();
    renderResult();
    drawEffortChart();
    drawSensChart();
    show("r");
    saveForm();
  };

  const renderResult=()=>{
    if(!last)return;
    Q("#k1").textContent=fmtMoney(last.pb);
    Q("#k2").textContent=fmtMoney(last.pr);
    Q("#k3").textContent=fmtMoney(last.pay);
    Q("#k4").textContent=last.rec;

    Q("#k1sub").textContent=last.m2>0?(Math.round(last.pb/last.m2).toLocaleString()+" ‚Ç¨/m¬≤"):"";
    Q("#k2sub").textContent=last.m2>0?(Math.round(last.pr/last.m2).toLocaleString()+" ‚Ç¨/m¬≤"):"";
    Q("#k3sub").textContent=`${last.yrs} a√±os ¬∑ ${(last.rate*100).toFixed(2)}%`;
    Q("#k4sub").textContent=last.recCode==="BUY"?"Encajas cash+esfuerzo":"Aprieta; alquilar m√°s seguro";

    Q("#rCard").style.display="block";
    Q("#rTitle").textContent=tpl(t("sumTitle"),{rec:last.rec});

    let chips="";
    chips+=`<span class="chip ${last.ratioM<=30?"good":last.ratioM<=35?"warn":"bad"}">${tpl(t("chipMort"),{pct:fmtPct(last.ratioM)})}</span>`;
    chips+=`<span class="chip ${last.ratioR<=30?"good":last.ratioR<=35?"warn":"bad"}">${tpl(t("chipRent"),{pct:fmtPct(last.ratioR)})}</span>`;
    chips+=`<span class="chip ${last.sav>=last.needCash?"good":"bad"}">${tpl(t("chipCash"),{eur:fmtMoney(last.needCash)})}</span>`;
    chips+=`<span class="chip neu">${tpl(t("chipRate"),{rate:(last.rate*100).toFixed(2)+"%"})}</span>`;
    Q("#rChips").innerHTML=chips;

    let miniHtml="";
    miniHtml+=`<div class="mini"><div class="h">${t("miniPrice")}</div><div class="v">${fmtMoney(last.pb)}</div></div>`;
    miniHtml+=`<div class="mini"><div class="h">${t("miniPay")}</div><div class="v">${fmtMoney(last.pay)}</div></div>`;
    miniHtml+=`<div class="mini"><div class="h">${t("miniRent")}</div><div class="v">${fmtMoney(last.pr)}</div></div>`;
    Q("#rMini").innerHTML=miniHtml;

    const why=last.recCode==="BUY"?
      ["Tus ahorros cubren entrada+costes","Esfuerzo hipoteca razonable","Horizonte >5 a√±os ayuda"]:
      ["Te falta cash o esfuerzo muy alto","Alquilar m√°s seguro ahora"];

    Q("#rBody").innerHTML=`<div style="padding:12px;background:rgba(56,189,248,.08);border-radius:12px;margin-top:12px">${why.map(x=>`<div>‚Ä¢ ${x}</div>`).join("")}</div>`;

    const muniTxt=last.munis.length>1?tpl(t("avgZone"),{n:last.munis.length}):last.munis[0];

    let report="";
    report+=tpl(t("reportHello"),{name:last.nm})+"\n";
    report+=tpl(t("reportPrice"),{eur:fmtMoney(last.pb)})+"\n";
    report+=tpl(t("reportHome"),{muni:muniTxt,m2:last.m2,bed:last.bd,bath:last.ba,type:typeLabel(last.ty)})+"\n";
    report+=tpl(t("reportDown"),{dp:(last.dp*100).toFixed(0),down:fmtMoney(last.down),cl:fmtMoney(last.cl)})+"\n";
    report+=tpl(t("reportFin"),{cap:fmtMoney(last.cap),yrs:last.yrs,rate:(last.rate*100).toFixed(2)+"%"})+"\n";
    report+=tpl(t("reportPay"),{pay:fmtMoney(last.pay),rent:fmtMoney(last.pr)})+"\n";
    report+=tpl(t("reportRec"),{rec:last.rec})+"\n";
    Q("#rt").textContent=report;

    let tips="";
    if(last.sav>=last.needCash){
      tips+="‚Ä¢ "+t("savingsOk")+"\n";
    }else if(last.msv>0){
      const mo=Math.ceil((last.needCash-last.sav)/last.msv);
      const yr=(mo/12).toFixed(1);
      tips+="‚Ä¢ "+tpl(t("yearsToSave"),{msv:fmtMoney(last.msv),yrs:yr,mos:mo})+"\n";
    }
    tips+="\n‚Ä¢ "+t("itpNote");
    Q("#chartTips").textContent=tips;

    let qe="";
    if(last.recCode==="BUY"){
      qe="Encajas el perfil: cash cubierto, esfuerzo razonable, horizonte >5 a√±os. Comprar tiene sentido en tu contexto.";
    }else{
      qe="O te falta cash o el esfuerzo es muy alto. Alquilar es lo m√°s seguro ahora. C√©ntrate en ahorrar o mejorar ingresos.";
    }
    Q("#quickExplain").textContent=qe;

    setTimeout(()=>{drawEffortChart();drawSensChart()},100);
  };

  let zoneSel=new Set(),zmap=null,cmap=null,polygonsByName=new Map();

  const loadZone=()=>{try{const s=localStorage.getItem(ZONE_KEY);if(s){zoneSel=new Set(JSON.parse(s))}}catch(e){}};
  const saveZone=()=>{localStorage.setItem(ZONE_KEY,JSON.stringify([...zoneSel]))};

  const renderZoneUI=()=>{
    const sel=zoneSel.size?[...zoneSel].join(", "):"ninguno";
    Q("#zoneNote").textContent="Seleccionados: "+sel;
    Q("#zoneApplied").textContent=zoneSel.size?("Municipios activos: "+[...zoneSel].join(", ")):"";
    if(zoneSel.size){
      Q("#zoneChips").innerHTML=[...zoneSel].map(z=>`<span class="pchip on" data-z="${z}">${z}</span>`).join("");
    }else{
      Q("#zoneChips").innerHTML=`<span class="pchip off">Sin selecci√≥n</span>`;
    }
    QA("[data-z]").forEach(ch=>{ch.onclick=()=>toggleZone(ch.getAttribute("data-z"),true)});
  };

  const applyPolygonState=name=>{
    const poly=polygonsByName.get(name);if(!poly)return;
    const on=zoneSel.has(name);
    poly.setStyle({
      fillColor:on?"#38bdf8":"#22c55e",
      fillOpacity:on?0.35:0.15,
      color:on?"#38bdf8":"#22c55e",
      weight:on?3:1.5,
      opacity:on?0.9:0.5
    });
  };

  const toggleZone=(name,fromChip)=>{
    zoneSel.has(name)?zoneSel.delete(name):zoneSel.add(name);
    applyPolygonState(name);
    renderZoneUI();
    if(!fromChip)saveZone();
  };

  const initMap=()=>{
    if(zmap)return;
    zmap=L.map("zmap",{scrollWheelZoom:false}).setView([41.235,1.595],11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'¬© OSM'}).addTo(zmap);

    Object.keys(MUNICIPALITY_POLYGONS).forEach(name=>{
      const coords=MUNICIPALITY_POLYGONS[name];
      const poly=L.polygon(coords,{
        fillColor:zoneSel.has(name)?"#38bdf8":"#22c55e",
        fillOpacity:zoneSel.has(name)?0.35:0.15,
        color:zoneSel.has(name)?"#38bdf8":"#22c55e",
        weight:zoneSel.has(name)?3:1.5,
        opacity:zoneSel.has(name)?0.9:0.5
      }).addTo(zmap);
      poly.bindTooltip(name,{permanent:false,direction:"center"});
      poly.on("click",()=>toggleZone(name,false));
      polygonsByName.set(name,poly);
    });

    setTimeout(()=>zmap.invalidateSize(),200);
    renderZoneUI();
  };

  const upMap=()=>{
    if(!cmap){
      cmap=L.map("cmap",{scrollWheelZoom:false}).setView([41.59,1.52],8);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'¬© OSM'}).addTo(cmap);
    }
    setTimeout(()=>cmap.invalidateSize(),100);
  };

  const doCompare=()=>{
    const prov=Q("#cm").value,m2=+Q("#cm2").value||0,bd=+Q("#cbd").value||0,ba=+Q("#cba").value||0;
    if(!prov||m2<50||ba<1){toast(t("missingDataCmp"));return}

    const e={
      t:Q("#ct").checked,p:Q("#cp0").checked,l:Q("#cl0").checked,k:Q("#ck0").checked,
      s:Q("#cs0").checked,j:Q("#cj0").checked,a:Q("#ca0").checked
    };

    const bM=buyM(prov,m2,bd,ba,e);
    const rM=rentM(prov,m2,bd,ba,e);

    if(!last){toast(t("toastFirstAnalyze"));return}

    last.cmpBuy=bM;
    last.cmpRent=rM;
    last.cmpProv=prov;

    const diffB=bM-last.pb,pctB=(diffB/last.pb)*100;
    const diffR=rM-last.pr,pctR=(diffR/last.pr)*100;

    let cmpChips="";
    cmpChips+=`<span class="chip ${diffB<0?"good":diffB===0?"neu":"bad"}">Compra: ${fmtPct(pctB)}</span>`;
    cmpChips+=`<span class="chip ${diffR<0?"good":diffR===0?"neu":"bad"}">Alquiler: ${fmtPct(pctR)}</span>`;
    Q("#cmpChips").innerHTML=cmpChips;

    const cmpTextB=diffB<0?t("cmpCheaper"):(diffB===0?t("cmpSame"):t("cmpExpensive"));
    const cmpTextR=diffR<0?t("cmpCheaper"):(diffR===0?t("cmpSame"):t("cmpExpensive"));

    let msg="";
    msg+=`Tu zona: ${fmtMoney(last.pb)} (compra) ¬∑ ${fmtMoney(last.pr)} (alquiler).\n`;
    msg+=`${prov}: ${fmtMoney(bM)} (compra) ¬∑ ${fmtMoney(rM)} (alquiler).\n`;
    msg+=`\n${prov} es ${cmpTextB} para comprar (${fmtPct(Math.abs(pctB))}).\n`;
    msg+=`${prov} es ${cmpTextR} para alquilar (${fmtPct(Math.abs(pctR))}).\n`;
    msg+=`\n<b>${t("cmpExplTitle")}</b>\n`;
    msg+=`‚Ä¢ ${t("cmpExpl1")}\n`;
    msg+=`‚Ä¢ ${t("cmpExpl2")}\n`;
    msg+=`‚Ä¢ ${t("cmpExpl3")}\n`;
    Q("#cmg").innerHTML=msg.replace(/\n/g,"<br>");

    drawCmpChart();
  };

  const refreshExamplesUI=()=>{
    const hasReq=!!lastReq;
    const changed=prefsChangedSinceAnalyze();
    const st=hasReq&&!changed?t("stateReady"):t("stateNeedAnalyze");
    const m=lastReq?muniLabel(lastReq.muni):t("any");
    Q("#xinfo").innerHTML=tpl(t("xInfo"),{muni:m,state:st});

    if(!hasReq||changed){Q("#xbtns").innerHTML="";return}

    const makeBuySlug=(a,m2,bed,bath,ty,ex)=>{
      let s=`https://www.idealista.com/venta-viviendas/${a.toLowerCase().replace(/\s+/g,"-").replace(/[√†√°]/g,"a").replace(/[√®√©]/g,"e").replace(/[√≠√Ø]/g,"i").replace(/[√≤√≥]/g,"o").replace(/[√ßc]/g,"c")}/`;
      let q=[];
      if(m2>=50){
        const loM2=Math.max(50,m2-15),hiM2=m2+25;
        q.push(`superficie-de-${loM2}-a-${hiM2}-metros-cuadrados`);
      }
      if(bed>=1)q.push(`con-${bed}-dormitorios`);
      if(bath>=1)q.push(`con-${bath}-banos`);
      if(ty==="flat")q.push(`pisos`);
      else if(ty==="house")q.push(`casas`);
      if(ex.t)q.push(`con-terraza`);
      if(ex.p)q.push(`con-piscina`);
      if(ex.l)q.push(`con-ascensor`);
      if(ex.k)q.push(`con-garaje`);
      if(ex.s)q.push(`con-trastero`);
      if(ex.j)q.push(`con-jardin`);
      if(ex.a)q.push(`con-aire-acondicionado`);
      return s+(q.length?q.join("/")+"/":" ");
    };

    const makeRentSlug=(a,m2,bed,bath,ty,ex)=>{
      let s=`https://www.idealista.com/alquiler-viviendas/${a.toLowerCase().replace(/\s+/g,"-").replace(/[√†√°]/g,"a").replace(/[√®√©]/g,"e").replace(/[√≠√Ø]/g,"i").replace(/[√≤√≥]/g,"o").replace(/[√ßc]/g,"c")}/`;
      let q=[];
      if(m2>=50){
        const loM2=Math.max(50,m2-15),hiM2=m2+25;
        q.push(`superficie-de-${loM2}-a-${hiM2}-metros-cuadrados`);
      }
      if(bed>=1)q.push(`con-${bed}-dormitorios`);
      if(bath>=1)q.push(`con-${bath}-banos`);
      if(ty==="flat")q.push(`pisos`);
      else if(ty==="house")q.push(`casas`);
      if(ex.t)q.push(`con-terraza`);
      if(ex.p)q.push(`con-piscina`);
      if(ex.l)q.push(`con-ascensor`);
      if(ex.k)q.push(`con-garaje`);
      if(ex.s)q.push(`con-trastero`);
      if(ex.j)q.push(`con-jardin`);
      if(ex.a)q.push(`con-aire-acondicionado`);
      return s+(q.length?q.join("/")+"/":" ");
    };

    const muniList=(lastReq.muni==="__multi__"&&zoneSel.size>1)?[...zoneSel]:(lastReq.muni==="*"?["Cunit"]:[lastReq.muni]);

    let btnsHtml="";
    muniList.forEach(mu=>{
      const buyLink=makeBuySlug(mu,lastReq.m2,lastReq.bed,lastReq.bath,lastReq.type,lastReq.ex);
      const rentLink=makeRentSlug(mu,lastReq.m2,lastReq.bed,lastReq.bath,lastReq.type,lastReq.ex);
      btnsHtml+=`<button class="b" onclick="window.open('${buyLink}','_blank')">Compra ¬∑ ${mu}</button>`;
      btnsHtml+=`<button class="b ok" onclick="window.open('${rentLink}','_blank')">Alquiler ¬∑ ${mu}</button>`;
    });

    Q("#xbtns").innerHTML=btnsHtml;
  };

  const liveValidate=()=>{
    const inc=+Q("#inc").value||0,sav=+Q("#sav").value||0,m2=+Q("#m2").value||0;
    const hInc=Q("#hint-inc"),hSav=Q("#hint-sav"),hM2=Q("#hint-m2");
    const iInc=Q("#inc"),iSav=Q("#sav"),iM2=Q("#m2");

    if(inc>0){
      if(inc<800){iInc.classList.add("field-err");iInc.classList.remove("field-ok");hInc.textContent="Ingresos bajos";hInc.className="field-hint err";}
      else if(inc<1200){iInc.classList.add("field-ok");iInc.classList.remove("field-err");hInc.textContent="Justo pero factible";hInc.className="field-hint ok";}
      else{iInc.classList.add("field-ok");iInc.classList.remove("field-err");hInc.textContent="Buenos ingresos";hInc.className="field-hint ok";}
    }else{iInc.classList.remove("field-ok","field-err");hInc.textContent=t("validateIncome");hInc.className="field-hint";}

    if(sav>0){
      if(sav<15000){iSav.classList.add("field-err");iSav.classList.remove("field-ok");hSav.textContent="Ahorros bajos";hSav.className="field-hint err";}
      else if(sav<30000){iSav.classList.add("field-ok");iSav.classList.remove("field-err");hSav.textContent="Ahorros decentes";hSav.className="field-hint ok";}
      else{iSav.classList.add("field-ok");iSav.classList.remove("field-err");hSav.textContent="Buenos ahorros";hSav.className="field-hint ok";}
    }else{iSav.classList.remove("field-ok","field-err");hSav.textContent=t("validateSavings");hSav.className="field-hint";}

    if(m2>0){
      if(m2<50){iM2.classList.add("field-err");iM2.classList.remove("field-ok");hM2.textContent=t("validateM2");hM2.className="field-hint err";}
      else if(m2<70){iM2.classList.add("field-ok");iM2.classList.remove("field-err");hM2.textContent="Peque√±o pero ok";hM2.className="field-hint ok";}
      else{iM2.classList.add("field-ok");iM2.classList.remove("field-err");hM2.textContent="Buen tama√±o";hM2.className="field-hint ok";}
    }else{iM2.classList.remove("field-ok","field-err");hM2.textContent="";hM2.className="field-hint";}
  };

  let chatHistory=[],isAIProcessing=false;

  const loadChatHistory=()=>{
    try{
      const s=localStorage.getItem(CHAT_KEY);
      if(s){
        chatHistory=JSON.parse(s);
        chatHistory.forEach(m=>{
          if(m.role==="user"||m.role==="assistant"){
            addMessageToChat(m.role==="user"?"user":"ai",m.content);
          }
        });
      }
    }catch(e){}
  };

  const saveChatHistory=()=>{localStorage.setItem(CHAT_KEY,JSON.stringify(chatHistory))};

  const getUserContext=()=>{
    if(!last)return "El usuario no ha completado el an√°lisis a√∫n.";
    const muniTxt=last.munis.length>1?`${last.munis.length} municipios (${last.munis.join(", ")})`:last.munis[0];
    return `Usuario: ${last.nm}, Ingresos: ${fmtMoney(last.inc)}, Ahorros: ${fmtMoney(last.sav)}, Ahorro mensual: ${fmtMoney(last.msv)}. Vivienda: ${muniTxt}, ${last.m2}m¬≤, ${last.bd} hab, ${last.ba} ba√±os. Precio estimado: ${fmtMoney(last.pb)}, Cuota hipoteca: ${fmtMoney(last.pay)}, Alquiler: ${fmtMoney(last.pr)}. Esfuerzo hipoteca: ${fmtPct(last.ratioM)}, Esfuerzo alquiler: ${fmtPct(last.ratioR)}. Cash necesario: ${fmtMoney(last.needCash)}. Recomendaci√≥n: ${last.rec}.`;
  };

  const addMessageToChat=(role,content)=>{
    const mc=Q("#chatMessages");if(!mc)return;
    const md=document.createElement("div");
    md.className=`chat-message ${role}`;
    const av=document.createElement("div");
    av.className=`chat-avatar ${role}`;
    av.textContent=role==="ai"?"AI":"T√ö";
    const bub=document.createElement("div");
    bub.className="chat-bubble";
    bub.textContent=content;
    md.appendChild(av);
    md.appendChild(bub);
    mc.appendChild(md);
    mc.scrollTop=mc.scrollHeight;
  };

  const addThinkingBubble=()=>{
    const mc=Q("#chatMessages");if(!mc)return;
    const thinking=document.createElement("div");
    thinking.id="thinking-msg";
    thinking.className="chat-message ai";
    thinking.innerHTML=`<div class="chat-avatar ai">AI</div><div class="chat-bubble thinking">Pensando...</div>`;
    mc.appendChild(thinking);
    mc.scrollTop=mc.scrollHeight;
  };

  const removeThinkingBubble=()=>{const thinking=Q("#thinking-msg");if(thinking)thinking.remove()};

  const sendMessageToAI=async userMessage=>{
    if(isAIProcessing||!userMessage.trim())return;
    isAIProcessing=true;

    const btn=Q("#chatSend"),inp=Q("#chatInput");
    if(btn)btn.disabled=true;
    if(inp)inp.disabled=true;

    addMessageToChat("user",userMessage);
    chatHistory.push({role:"user",content:userMessage});

    addThinkingBubble();

    try{
      const systemPrompt=`Eres un asesor financiero experto especializado en vivienda en Catalunya. S√© conciso pero √∫til. Tu tono debe ser profesional pero cercano. Das recomendaciones pr√°cticas y espec√≠ficas. Adviertes riesgos con tacto. Respondes en espa√±ol. Contexto del usuario: ${getUserContext()}`;

      const response=await fetch("https://api.anthropic.com/v1/messages",{
        method:"POST",
        headers:{"Content-Type":"application/json","anthropic-version":"2023-06-01"},
        body:JSON.stringify({
          model:"claude-sonnet-4-20250514",
          max_tokens:1024,
          system:systemPrompt,
          messages:[...chatHistory.slice(-10),{role:"user",content:userMessage}]
        })
      });

      const data=await response.json();
      removeThinkingBubble();

      if(data.content&&data.content[0]&&data.content[0].text){
        const aiResponse=data.content[0].text;
        addMessageToChat("ai",aiResponse);
        chatHistory.push({role:"assistant",content:aiResponse});
        saveChatHistory();
      }else{
        throw new Error("Invalid API response");
      }
    }catch(error){
      removeThinkingBubble();
      console.error("AI Error:",error);
      addMessageToChat("ai","Lo siento, no pude procesar tu solicitud. Int√©ntalo de nuevo.");
    }finally{
      isAIProcessing=false;
      if(btn)btn.disabled=false;
      if(inp){inp.disabled=false;inp.value="";inp.focus()}
    }
  };

  const initChatUI=()=>{
    if(Q("#chatMessages").children.length<=1){loadChatHistory()}

    const btn=Q("#chatSend"),inp=Q("#chatInput");
    if(btn&&!btn.dataset.initialized){
      btn.dataset.initialized="true";
      btn.onclick=()=>{const msg=(inp?.value||"").trim();if(msg)sendMessageToAI(msg)};
    }

    if(inp&&!inp.dataset.initialized){
      inp.dataset.initialized="true";
      inp.onkeypress=e=>{
        if(e.key==="Enter"&&!e.shiftKey){
          e.preventDefault();
          const msg=(inp.value||"").trim();
          if(msg)sendMessageToAI(msg);
        }
      };
      inp.oninput=()=>{
        inp.style.height="auto";
        inp.style.height=Math.min(120,inp.scrollHeight)+"px";
      };
    }

    QA(".suggestion-chip").forEach(chip=>{
      if(!chip.dataset.initialized){
        chip.dataset.initialized="true";
        chip.onclick=()=>{const q=chip.getAttribute("data-q");if(q)sendMessageToAI(q)};
      }
    });
  };

  loadForm();
  loadZone();
  setLang(LANG);
  setTabsEnabled();

  Q("#np").onclick=()=>{
    const nm=Q("#nm").value.trim(),ag=+Q("#ag").value||0;
    if(!nm||ag<18||ag>100){toast(t("toastCheckNameAge"));return}
    saveForm();show("e");
  };

  Q("#ne").onclick=()=>{saveForm();show("f")};
  Q("#go").onclick=()=>{analyze()};

  Q("#cp").onclick=()=>{
    if(!last){toast(t("toastFirstAnalyze"));return}
    const txt=Q("#rt").textContent;
    navigator.clipboard.writeText(txt).then(()=>toast(t("toastCopied")));
  };

  Q("#rs").onclick=()=>{
    if(confirm("¬øReiniciar todos los datos?")){localStorage.clear();location.reload()}
  };

  Q("#jumpX").onclick=()=>{if(!lastReq){toast(t("toastFirstAnalyze"));return}show("x")};
  Q("#jumpAI").onclick=()=>{if(!lastReq){toast(t("toastFirstAnalyze"));return}show("ai")};

  Q("#t_p").onclick=()=>show("p");
  Q("#t_e").onclick=()=>show("e");
  Q("#t_f").onclick=()=>show("f");
  Q("#t_r").onclick=()=>{if(!lastReq){toast(t("toastFirstAnalyze"));return}show("r")};
  Q("#t_m").onclick=()=>{if(!lastReq){toast(t("toastFirstAnalyze"));return}show("m")};
  Q("#t_x").onclick=()=>{if(!lastReq){toast(t("toastFirstAnalyze"));return}show("x")};
  Q("#t_ai").onclick=()=>{if(!lastReq){toast(t("toastFirstAnalyze"));return}show("ai")};

  Q("#toggleMap").onclick=()=>{
    const box=Q("#zoneWrap");
    const isOpen=box.style.display!=="none";
    box.style.display=isOpen?"none":"block";
    if(!isOpen){initMap();setTimeout(()=>zmap?.invalidateSize(),200)}
  };

  Q("#zoneClear").onclick=()=>{
    zoneSel.clear();
    polygonsByName.forEach((_,name)=>applyPolygonState(name));
    renderZoneUI();
    saveZone();
    toast(t("toastZoneCleared"));
  };

  Q("#zoneApply").onclick=()=>{
    if(!zoneSel.size){toast(t("toastNoZone"));return}
    const prevMulti=Q("#ar").querySelector('[value="__multi__"]');
    if(prevMulti)prevMulti.remove();
    if(zoneSel.size===1){
      Q("#ar").value=[...zoneSel][0];
    }else{
      const opt=document.createElement("option");
      opt.value="__multi__";
      opt.textContent=[...zoneSel].join(", ");
      Q("#ar").insertBefore(opt,Q("#ar").options[1]);
      Q("#ar").value="__multi__";
    }
    saveZone();
    toast(t("toastZoneApplied"));
  };

  Q("#bc").onclick=()=>doCompare();
  Q("#autoFillCmp").onclick=()=>{
    if(!lastReq){toast(t("toastFirstAnalyze"));return}
    Q("#cm2").value=lastReq.m2||"";
    Q("#cbd").value=lastReq.bed||"";
    Q("#cba").value=lastReq.bath||"";
    Q("#cty").value=lastReq.type||"flat";
    Q("#ct").checked=lastReq.ex.t;
    Q("#cp0").checked=lastReq.ex.p;
    Q("#cl0").checked=lastReq.ex.l;
    Q("#ck0").checked=lastReq.ex.k;
    Q("#cs0").checked=lastReq.ex.s;
    Q("#cj0").checked=lastReq.ex.j;
    Q("#ca0").checked=lastReq.ex.a;
    saveForm();
    toast("Datos rellenados");
  };

  Q("#shareWa").onclick=()=>{
    if(!last){toast(t("toastFirstAnalyze"));return}
    const txt=Q("#rt").textContent;
    const url="https://wa.me/?text="+encodeURIComponent(txt);
    window.open(url,"_blank");
  };

  Q("#shareCl").onclick=()=>{
    if(!last){toast(t("toastFirstAnalyze"));return}
    const txt=Q("#rt").textContent;
    navigator.clipboard.writeText(txt).then(()=>toast(t("toastCopied")));
  };

  Q("#L_CA").onclick=()=>setLang("CA");
  Q("#L_ES").onclick=()=>setLang("ES");
  Q("#L_EN").onclick=()=>setLang("EN");

  ["inc","sav","m2"].forEach(id=>Q("#"+id).oninput=liveValidate);

  window.addEventListener("resize",()=>{
    if(zmap)setTimeout(()=>zmap.invalidateSize(),100);
    if(cmap)setTimeout(()=>cmap.invalidateSize(),100);
    if(last){drawEffortChart();drawSensChart();drawCmpChart()}
  });

  console.log("App initialized ¬∑ v9 ¬∑ Polygon maps ¬∑ AI chatbot fully operational");
})();
}

waitForLeaflet();
</script>
</body>
</html>
