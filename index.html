<!-- =========================
PART 3 / 3
========================= -->
<script>
/* =========================
PART 3: math + logic + maps + examples + AI + events
========================= */

// Model (simple but stable)
const BASE = { m2Buy:2000, m2Rent:10, close:0.11, baseRate:0.0299 };
const COEF = {
  "Cunit":{c:1.157,r:0.975},"El Vendrell":{c:0.912,r:0.842},"Calafell":{c:0.856,r:0.983},
  "Santa Oliva":{c:0.783,r:0.825},"Bellvei":{c:0.783,r:0.925},"L'Arboç":{c:0.735,r:0.883},
  "Banyeres del Penedès":{c:0.614,r:0.783},"Albinyana":{c:0.766,r:0.825},"Bonastre":{c:0.497,r:0.683},
  "Masllorenç":{c:0.549,r:0.750},"La Bisbal del Penedès":{c:0.623,r:0.808},
  "Llorenç del Penedès":{c:0.856,r:0.650},"Sant Jaume dels Domenys":{c:0.614,r:0.650},"El Montmell":{c:0.529,r:0.675}
};
const PROV = {
  "Barcelona":{v:2986,l:21.9, center:[41.3874,2.1686]},
  "Girona":{v:2608,l:15.0, center:[41.9794,2.8214]},
  "Lleida":{v:1486,l:9.5, center:[41.6176,0.62]},
  "Tarragona":{v:2100,l:13.5, center:[41.1189,1.2445]}
};

const extraImpactBuy=(base,e)=>{
  let x=0;
  if(e.t) x+=base*0.05;
  if(e.p) x+=base*0.08;
  if(e.l) x+=base*0.04;
  if(e.k) x+=base*0.03;
  if(e.s) x+=base*0.02;
  if(e.j) x+=base*0.05;
  if(e.a) x+=base*0.015;
  return x;
};
const extraImpactRent=(base,e)=>{
  let x=0;
  if(e.t) x+=base*0.15;
  if(e.p) x+=base*0.30;
  if(e.l) x+=base*0.08;
  if(e.k) x+=base*0.07;
  if(e.s) x+=base*0.05;
  if(e.j) x+=base*0.18;
  if(e.a) x+=base*0.06;
  return x;
};

const buyPrice=(muni,m2,bed,bath,e)=>{
  const cf = COEF[muni] || {c:1,r:1};
  const base = (m2||0) * BASE.m2Buy * cf.c;
  const adj = (Math.max(0,bed||0)*5000) + (Math.max(0,bath||0)*3000);
  return Math.round(base + adj + extraImpactBuy(base,e));
};
const rentPrice=(muni,m2,bed,bath,e)=>{
  const cf = COEF[muni] || {c:1,r:1};
  const base = (m2||0) * BASE.m2Rent * cf.r;
  const adj = (Math.max(0,bed||0)*50) + (Math.max(0,bath||0)*30);
  return Math.round(base + adj + extraImpactRent(base,e));
};
const buyProv=(prov,m2,bed,bath,e)=>{
  const p=PROV[prov]; if(!p) return NaN;
  const base=(m2||0)*p.v;
  const adj=(Math.max(0,bed||0)*5000)+(Math.max(0,bath||0)*3000);
  return Math.round(base + adj + extraImpactBuy(base,e));
};
const rentProv=(prov,m2,bed,bath,e)=>{
  const p=PROV[prov]; if(!p) return NaN;
  const base=(m2||0)*p.l;
  const adj=(Math.max(0,bed||0)*50)+(Math.max(0,bath||0)*30);
  return Math.round(base + adj + extraImpactRent(base,e));
};

const mort=(cap,rate,yrs)=>{
  const m=rate/12;
  const n=yrs*12;
  if(cap<=0 || rate<=0 || yrs<=0) return NaN;
  return cap * (m*Math.pow(1+m,n)) / (Math.pow(1+m,n)-1);
};

const renderSideKpis=()=>{
  if(!last){
    Q("#sk1").textContent="0 €";
    Q("#sk2").textContent="0 €";
    Q("#sk3").textContent="0 €";
    Q("#sk4").textContent="—";
    Q("#sk1s").textContent=""; Q("#sk2s").textContent=""; Q("#sk3s").textContent=""; Q("#sk4s").textContent="";
    return;
  }
  Q("#sk1").textContent=fmtMoney(last.pb);
  Q("#sk2").textContent=fmtMoney(last.pr);
  Q("#sk3").textContent=fmtMoney(last.pay);
  Q("#sk4").textContent=last.rec;

  const pm2 = last.m2? Math.round(last.pb/last.m2):0;
  const loc=(LANG==="EN")?"en-US":"es-ES";
  Q("#sk1s").textContent = pm2 ? (pm2.toLocaleString(loc)+" €/m²") : "";
  Q("#sk2s").textContent = (LANG==="EN") ? "Monthly estimate" : (LANG==="CA"?"Estimació mensual":"Estimación mensual");
  Q("#sk3s").textContent = `${last.yrs} ${(LANG==="EN")?"years":"años"} · ${(last.rate*100).toFixed(2)}%`;
  Q("#sk4s").textContent = (last.recCode==="BUY")
    ? (LANG==="EN"?"Cash + effort OK":"Cash + esfuerzo OK")
    : (last.recCode==="RENT")
      ? (LANG==="EN"?"Buying tight, rent safer":"Comprar aprieta, alquilar más seguro")
      : (LANG==="EN"?"Not safe yet":"Aún no seguro");
};

const drawEffortChart=()=>{
  if(!last) return;
  const cv=Q("#effChart");
  const ctx=cv.getContext("2d");
  const w=cv.width = cv.clientWidth * (window.devicePixelRatio||1);
  const h=cv.height = 240 * (window.devicePixelRatio||1);
  ctx.setTransform((window.devicePixelRatio||1),0,0,(window.devicePixelRatio||1),0,0);

  const W=cv.clientWidth, H=240;
  ctx.clearRect(0,0,W,H);

  const pad={l:14,r:14,t:14,b:26};
  const plotW=W-pad.l-pad.r;
  const plotH=H-pad.t-pad.b;

  const safe = last.inc*0.35;
  const a = last.pay;
  const b = last.pr;
  const maxV = Math.max(safe,a,b)*1.15 || 1;

  // grid
  ctx.strokeStyle="rgba(148,163,184,.12)";
  for(let i=0;i<=5;i++){
    const y=pad.t + (plotH*(i/5));
    ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(W-pad.r,y); ctx.stroke();
  }

  // safe line
  const ySafe = pad.t + plotH*(1-(safe/maxV));
  ctx.strokeStyle="rgba(56,189,248,.92)";
  ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(pad.l,ySafe); ctx.lineTo(W-pad.r,ySafe); ctx.stroke();
  ctx.fillStyle="rgba(125,211,252,.95)";
  ctx.font="12px system-ui";
  ctx.fillText(t("safeCap")+": "+fmtMoney(safe), pad.l+6, Math.max(14,ySafe-6));

  // bars
  const barW=Math.min(140, plotW/3);
  const x1=pad.l + plotW*0.35 - barW/2;
  const x2=pad.l + plotW*0.65 - barW/2;

  const drawBar=(x,val,label,colorStroke,colorFill)=>{
    const bh=plotH*(val/maxV);
    const y=pad.t+plotH-bh;
    ctx.fillStyle=colorFill; ctx.globalAlpha=0.95;
    ctx.fillRect(x,y,barW,bh);
    ctx.globalAlpha=1;
    ctx.strokeStyle=colorStroke; ctx.lineWidth=1;
    ctx.strokeRect(x,y,barW,bh);

    ctx.fillStyle="#e5e7eb";
    ctx.font="12px system-ui";
    ctx.textAlign="center";
    ctx.fillText(label, x+barW/2, H-10);

    ctx.fillStyle="#cbd5e1";
    ctx.font="12px system-ui";
    ctx.fillText(fmtMoney(val), x+barW/2, Math.max(14,y-6));
    ctx.textAlign="left";
  };

  drawBar(x1,a,(LANG==="EN"?"MORTGAGE":(LANG==="CA"?"HIPOTECA":"HIPOTECA")),"rgba(34,197,94,.55)","rgba(34,197,94,.22)");
  drawBar(x2,b,(LANG==="EN"?"RENT":(LANG==="CA"?"LLOGUER":"ALQUILER")),"rgba(245,158,11,.55)","rgba(245,158,11,.22)");

  Q("#chartsHint").textContent=t("chart1");
};

const drawSensitivityChart=()=>{
  if(!last) return;
  const cv=Q("#sensChart");
  const ctx=cv.getContext("2d");
  const w=cv.width = cv.clientWidth * (window.devicePixelRatio||1);
  const h=cv.height = 210 * (window.devicePixelRatio||1);
  ctx.setTransform((window.devicePixelRatio||1),0,0,(window.devicePixelRatio||1),0,0);

  const W=cv.clientWidth, H=210;
  ctx.clearRect(0,0,W,H);

  const pad={l:14,r:14,t:14,b:26};
  const plotW=W-pad.l-pad.r;
  const plotH=H-pad.t-pad.b;

  const pts=[];
  for(let i=0;i<=4;i++){
    const r = last.rate + i*0.005;
    pts.push({r, p:mort(last.cap,r,last.yrs)});
  }
  const maxP=Math.max(...pts.map(x=>x.p))*1.10 || 1;
  const minP=Math.min(...pts.map(x=>x.p))*0.90 || 0;

  ctx.strokeStyle="rgba(148,163,184,.12)";
  for(let i=0;i<=4;i++){
    const y=pad.t + (plotH*(i/4));
    ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(W-pad.r,y); ctx.stroke();
  }

  ctx.strokeStyle="rgba(56,189,248,.92)";
  ctx.lineWidth=2;
  ctx.beginPath();
  pts.forEach((pt,i)=>{
    const x=pad.l + plotW*(i/(pts.length-1));
    const y=pad.t + plotH*(1-((pt.p-minP)/((maxP-minP)||1)));
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  pts.forEach((pt,i)=>{
    const x=pad.l + plotW*(i/(pts.length-1));
    const y=pad.t + plotH*(1-((pt.p-minP)/((maxP-minP)||1)));
    ctx.fillStyle="rgba(125,211,252,1)";
    ctx.beginPath(); ctx.arc(x,y,3.5,0,Math.PI*2); ctx.fill();
  });

  const delta = pts[pts.length-1].p - pts[0].p;
  ctx.fillStyle="#cbd5e1";
  ctx.font="12px system-ui";
  ctx.fillText(t("riskRate")+": "+(delta>=0?"+":"")+fmtMoney(delta)+" @ +2%", pad.l, H-10);

  Q("#sensHint").textContent=t("chart2");
};

const drawCmpChart=(your,prov)=>{
  const cv=Q("#cmpChart");
  const ctx=cv.getContext("2d");
  const w=cv.width = cv.clientWidth * (window.devicePixelRatio||1);
  const h=cv.height = 210 * (window.devicePixelRatio||1);
  ctx.setTransform((window.devicePixelRatio||1),0,0,(window.devicePixelRatio||1),0,0);

  const W=cv.clientWidth, H=210;
  ctx.clearRect(0,0,W,H);

  const pad={l:14,r:14,t:14,b:26};
  const plotW=W-pad.l-pad.r;
  const plotH=H-pad.t-pad.b;
  const maxV=Math.max(your,prov)*1.15 || 1;

  ctx.strokeStyle="rgba(148,163,184,.12)";
  for(let i=0;i<=4;i++){
    const y=pad.t + (plotH*(i/4));
    ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(W-pad.r,y); ctx.stroke();
  }

  const barW=Math.min(160, plotW/3);
  const x1=pad.l + plotW*0.33 - barW/2;
  const x2=pad.l + plotW*0.67 - barW/2;

  const bar=(x,val,label,stroke,fill)=>{
    const bh=plotH*(val/maxV);
    const y=pad.t+plotH-bh;
    ctx.fillStyle=fill; ctx.globalAlpha=.95;
    ctx.fillRect(x,y,barW,bh);
    ctx.globalAlpha=1;
    ctx.strokeStyle=stroke; ctx.strokeRect(x,y,barW,bh);
    ctx.fillStyle="#cbd5e1"; ctx.font="12px system-ui"; ctx.textAlign="center";
    ctx.fillText(label, x+barW/2, H-10);
    ctx.fillText(fmtMoney(val), x+barW/2, Math.max(14,y-6));
    ctx.textAlign="left";
  };

  bar(x1,your,(LANG==="EN"?"Your area":(LANG==="CA"?"La teva zona":"Tu zona")),"rgba(56,189,248,.55)","rgba(56,189,248,.18)");
  bar(x2,prov,(LANG==="EN"?"Province":(LANG==="CA"?"Província":"Provincia")),"rgba(168,85,247,.55)","rgba(168,85,247,.16)");
};

const validateCore=()=>{
  const nm=(Q("#nm").value||"").trim();
  const ag=+Q("#ag").value||0;
  if(!nm || ag<18 || ag>100) return {ok:false, msg:t("toastCheckNameAge")};

  const inc=(Q("#inc").value===""?0:+Q("#inc").value||0);
  const m2=(Q("#m2").value===""?0:+Q("#m2").value||0);
  const bat=(Q("#bat").value===""?0:+Q("#bat").value||0);

  if(!(inc>0) || !(m2>=50) || !(bat>=1)) return {ok:false, msg:t("toastMissing")};
  return {ok:true};
};

const analyze=()=>{
  const v=validateCore();
  if(!v.ok){ toast(v.msg); return; }

  const nm=(Q("#nm").value||"").trim();
  const ag=+Q("#ag").value||0;
  const inc=+Q("#inc").value||0;
  const sav=(Q("#sav").value===""?0:+Q("#sav").value||0);
  const msv=(Q("#msv").value===""?0:+Q("#msv").value||0);
  const yrs=(Q("#yrs").value===""?25:+Q("#yrs").value||25);
  const hor = Q("#hor").value==="y";
  const fst = Q("#fst").value==="y";

  const muni=Q("#ar").value;
  const m2=+Q("#m2").value||0;
  const bed=(Q("#bed").value===""?0:+Q("#bed").value||0);
  const bath=+Q("#bat").value||0;
  const type=Q("#ty").value;

  const e={t:Q("#et").checked,p:Q("#ep").checked,l:Q("#el").checked,k:Q("#ek").checked,s:Q("#es").checked,j:Q("#ej").checked,a:Q("#ea").checked};

  // If user selected an area on map, and muni is "*", compute average
  let muniList=[];
  if(zoneSel.size>=2 && muni==="*"){
    muniList=[...zoneSel].filter(x=>COEF[x]);
  }
  if(muniList.length){
    const buys=muniList.map(m=>buyPrice(m,m2,bed,bath,e));
    const rents=muniList.map(m=>rentPrice(m,m2,bed,bath,e));
    var pb=Math.round(buys.reduce((a,b)=>a+b,0)/buys.length);
    var pr=Math.round(rents.reduce((a,b)=>a+b,0)/rents.length);
    var pbRange={lo:Math.min(...buys),hi:Math.max(...buys)};
    var prRange={lo:Math.min(...rents),hi:Math.max(...rents)};
  }else{
    const baseM = muni==="*" ? "Cunit" : muni; // fallback baseline
    muniList=[baseM];
    var pb=buyPrice(baseM,m2,bed,bath,e);
    var pr=rentPrice(baseM,m2,bed,bath,e);
    var pbRange=null, prRange=null;
  }

  const dp = fst ? 0.10 : 0.20;
  const down = pb*dp;
  const cl = pb*BASE.close;
  const needCash = Math.round(down+cl);
  let rate = BASE.baseRate;
  if(sav < needCash) rate += 0.006;

  const cap = Math.max(0, pb - down);
  const pay = mort(cap,rate,yrs);

  const ratio = (inc>0 && isFinite(pay)) ? (pay/inc)*100 : 1e9;
  const rri = (inc>0) ? (pr/inc)*100 : 1e9;

  const need = sav < needCash;
  const ratioOK = ratio <= 35;
  const rentOK = rri <= 40;

  let recCode;
  if(!need && ratioOK && hor) recCode="BUY";
  else if(rentOK) recCode="RENT";
  else recCode="NOT";

  const rec = recCode==="BUY" ? t("recBuy") : recCode==="RENT" ? t("recRent") : t("recNot");

  last={
    nm,ag,inc,sav,msv,yrs,hor,fst,
    muni,m2,bed,bath,type,e,
    muniList,pb,pr,pbRange,prRange,
    dp,down,cl,needCash,need,
    rate,cap,pay,ratio,rri,
    recCode,rec
  };
  lastReq=reqFromUI();
  lastReqSig=sigOfReq(lastReq);

  renderResult();
  setTabsEnabled();
  saveForm();
  show("r");
  renderSideKpis();

  setTimeout(()=>{ drawEffortChart(); drawSensitivityChart(); },120);
};

const renderResult=()=>{
  if(!last) return;

  Q("#k1").textContent=fmtMoney(last.pb);
  Q("#k2").textContent=fmtMoney(last.pr);
  Q("#k3").textContent=fmtMoney(last.pay);
  Q("#k4").textContent=last.rec;

  const loc=(LANG==="EN")?"en-US":"es-ES";
  const pm2 = last.m2?Math.round(last.pb/last.m2):0;
  Q("#k1s").textContent = pm2 ? (pm2.toLocaleString(loc)+" €/m²") : "";
  Q("#k2s").textContent = (LANG==="EN")?"Monthly estimate":(LANG==="CA"?"Estimació mensual":"Estimación mensual");
  Q("#k3s").textContent = `${last.yrs} ${(LANG==="EN")?"years":"años"} · ${(last.rate*100).toFixed(2)}%`;
  Q("#k4s").textContent = last.recCode==="BUY"
    ? (LANG==="EN"?"Cash + effort thresholds fit.":"Encajas cash + esfuerzo.")
    : last.recCode==="RENT"
      ? (LANG==="EN"?"Buying is tight; rent is safer.":"Comprar aprieta; alquilar es más seguro.")
      : (LANG==="EN"?"Neither option fits safely yet.":"Ahora mismo no encaja con seguridad.");

  const safe = last.inc*0.35;
  const cashGap=Math.max(0,last.needCash-last.sav);

  const mortPct = isFinite(last.ratio) ? last.ratio : 999;
  const rentPct = isFinite(last.rri) ? last.rri : 999;

  const clsMort = mortPct<=30 ? "good" : mortPct<=35 ? "warn" : "bad";
  const clsRent = rentPct<=35 ? "good" : rentPct<=40 ? "warn" : "bad";
  const clsCash = last.need ? "bad" : "good";
  const clsRate = last.rate>BASE.baseRate ? "warn" : "neu";

  Q("#rChips").innerHTML =
    `<span class="chip ${clsMort}">${tpl(t("chipMort"),{pct:fmtPct(mortPct)})}</span>`+
    `<span class="chip ${clsRent}">${tpl(t("chipRent"),{pct:fmtPct(rentPct)})}</span>`+
    `<span class="chip ${clsCash}">${tpl(t("chipCash"),{eur:fmtMoney(last.needCash)})}</span>`+
    `<span class="chip ${clsRate}">${tpl(t("chipRate"),{rate:(last.rate*100).toFixed(2)+"%"})}</span>`;

  const why=[];
  if(last.recCode==="BUY"){
    why.push("• "+t("whyBuy1"));
    why.push("• "+t("whyBuy2"));
    if(last.muniList.length>=2) why.push("• "+tpl(t("avgZone"),{n:last.muniList.length}));
  }else if(last.recCode==="RENT"){
    if(last.need) why.push("• "+t("whyRent1")+" ("+fmtMoney(cashGap)+")");
    if(mortPct>35) why.push("• "+t("whyRent2")+" ("+fmtPct(mortPct)+")");
    why.push("• "+t("whyRent3")+" ("+fmtPct(rentPct)+")");
  }else{
    why.push("• "+t("whyNot1"));
    if(last.need) why.push("• "+t("whyRent1")+" ("+fmtMoney(cashGap)+")");
    if(mortPct>35) why.push("• "+t("whyRent2")+" ("+fmtPct(mortPct)+")");
    if(rentPct>40) why.push("• "+t("whyRent3")+" ("+fmtPct(rentPct)+")");
  }

  Q("#whyBox").innerHTML =
    `<div style="font-weight:950;color:#e5e7eb;margin-bottom:8px">${t("explTitle")}</div>`+
    `<div style="display:grid;gap:6px;color:#cbd5e1">${why.map(x=>`<div>${x}</div>`).join("")}</div>`+
    `<div class="hr"></div>`+
    `<div style="color:#94a3b8;font-size:.86rem;line-height:1.55">`+
    `${t("safeCap")}: <b style="color:#7dd3fc">${fmtMoney(safe)}</b> · `+
    `${(LANG==="EN"?"Mortgage":"Hipoteca")}: <b style="color:#86efac">${fmtMoney(last.pay)}</b> · `+
    `${(LANG==="EN"?"Rent":"Alquiler")}: <b style="color:#fde68a">${fmtMoney(last.pr)}</b>`+
    `</div>`+
    `<div style="margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(99,102,241,.22);background:rgba(99,102,241,.08);color:#c7d2fe;font-size:.85rem;line-height:1.55">ℹ️ ${t("itpNote")}</div>`;

  const muniTxt = municipalityLabel(last.muni);
  const typeTxt = typeLabel(last.type);
  const dpPct = Math.round(last.dp*100);

  Q("#rt").textContent = [
    tpl(t("reportHello"),{name:last.nm}),
    tpl(t("reportHome"),{muni:muniTxt,m2:last.m2,bed:last.bed||0,bath:last.bath,type:typeTxt}),
    tpl(t("reportPrice"),{eur:fmtMoney(last.pb)}),
    tpl(t("reportRent"),{eur:fmtMoney(last.pr)}),
    tpl(t("reportDown"),{dp:dpPct,down:fmtMoney(last.down),cl:fmtMoney(last.cl)}),
    tpl(t("reportFin"),{cap:fmtMoney(last.cap),yrs:last.yrs,rate:(last.rate*100).toFixed(2)+"%"}),
    tpl(t("reportPay"),{pay:fmtMoney(last.pay),rent:fmtMoney(last.pr)}),
    tpl(t("reportRec"),{rec:last.rec})
  ].join("\n");

  refreshExamplesUI();
  initChatUI();
};

const copyReport=()=>{
  const txt=Q("#rt").textContent||"";
  if(!txt){toast(t("toastFirstAnalyze"));return;}
  navigator.clipboard.writeText(txt).then(()=>toast(t("toastCopied")));
};

const resetAll=()=>{
  ["nm","ag","inc","sav","msv","yrs","m2","bed","bat","cm2","cbd","cba"].forEach(id=>Q("#"+id).value="");
  Q("#hor").value="y"; Q("#fst").value="n";
  Q("#ar").value="*"; Q("#ty").value="flat";
  ["et","ep","el","ek","es","ej","ea","ct","cp0","cl0","ck0","cs0","cj0","ca0"].forEach(id=>Q("#"+id).checked=false);
  Q("#cm").value="Barcelona"; Q("#cty").value="flat";

  localStorage.removeItem(STORE_KEY);
  last=null; lastReq=null; lastReqSig="";
  renderSideKpis();
  setTabsEnabled();
  refreshExamplesUI();
  renderZoneUI();
  clearChat(true);

  Q("#k1").textContent="—"; Q("#k2").textContent="—"; Q("#k3").textContent="—"; Q("#k4").textContent="—";
  Q("#k1s").textContent=""; Q("#k2s").textContent=""; Q("#k3s").textContent=""; Q("#k4s").textContent="";
  Q("#rChips").innerHTML=""; Q("#whyBox").innerHTML=""; Q("#rt").textContent="";
  show("p");
};

const clampNum=(id,min,max)=>{
  const el=Q("#"+id);
  el.addEventListener("input",()=>{
    el.value=String(el.value||"").replace(/[^\d.]/g,"");
    saveForm();
  });
  el.addEventListener("blur",()=>{
    if(el.value==="") return;
    let n=+el.value;
    if(!isFinite(n)) return;
    n=Math.min(max,Math.max(min,n));
    el.value=String(n);
    saveForm();
  });
};

// Comparator
const ensureCMap=()=>{
  const prov=Q("#cm").value;
  const p=PROV[prov]||PROV["Barcelona"];
  if(!cmap){
    cmap=L.map("cmap").setView(p.center,11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OpenStreetMap"}).addTo(cmap);
    L.marker(p.center).addTo(cmap);
    setTimeout(()=>cmap.invalidateSize(),180);
  }else{
    cmap.setView(p.center,11);
    // remove markers then add one
    cmap.eachLayer(layer=>{ if(layer instanceof L.Marker) cmap.removeLayer(layer); });
    L.marker(p.center).addTo(cmap);
    setTimeout(()=>cmap.invalidateSize(),120);
  }
};

const fillComparatorFromLast=()=>{
  if(!last){toast(t("toastFirstAnalyze"));return;}
  Q("#cm2").value=last.m2||""; Q("#cbd").value=last.bed||""; Q("#cba").value=last.bath||"";
  Q("#cty").value=last.type||"flat";
  Q("#ct").checked=!!last.e.t; Q("#cp0").checked=!!last.e.p; Q("#cl0").checked=!!last.e.l; Q("#ck0").checked=!!last.e.k;
  Q("#cs0").checked=!!last.e.s; Q("#cj0").checked=!!last.e.j; Q("#ca0").checked=!!last.e.a;
  saveForm();
};

const compare=()=>{
  if(!last){toast(t("toastFirstAnalyze"));return;}
  const prov=Q("#cm").value;
  const m2=+Q("#cm2").value||0;
  const bed=(Q("#cbd").value===""?0:+Q("#cbd").value||0);
  const bath=(Q("#cba").value===""?0:+Q("#cba").value||0);
  const type=Q("#cty").value;
  const e={t:Q("#ct").checked,p:Q("#cp0").checked,l:Q("#cl0").checked,k:Q("#ck0").checked,s:Q("#cs0").checked,j:Q("#cj0").checked,a:Q("#ca0").checked};

  if(!(m2>=50) || !(bath>=1)){ Q("#cmpHint").textContent=t("toastMissing"); return; }

  const p2=buyProv(prov,m2,bed,bath,e);
  const r2=rentProv(prov,m2,bed,bath,e);

  const d=p2-last.pb;
  const pct = (last.pb>0) ? (d/last.pb)*100 : 0;
  const cls = d>0?"bad":d<0?"good":"neu";
  const arrow = d>0?"↑":d<0?"↓":"→";
  const sign = d>0?"+":"";
  const pctTxt = (d===0) ? "0%" : (sign+pct.toFixed(1)+"%");

  Q("#cmpChips").innerHTML =
    `<span class="chip ${cls}">${arrow} ${sign}${fmtMoney(d)}</span>`+
    `<span class="chip ${cls}">${pctTxt}</span>`+
    `<span class="chip neu">${fmtMoney(p2)}</span>`+
    `<span class="chip neu">${fmtMoney(r2)} ${(LANG==="EN")?"/mo":"/mes"}</span>`;

  Q("#cmpHint").textContent =
    (LANG==="EN"?"Buying price comparison vs your area.":"Comparación de compra vs tu zona.")+
    " "+(LANG==="EN"?"Use the bar chart below.":"Usa la barra de abajo.");

  ensureCMap();
  drawCmpChart(last.pb,p2);
  saveForm();
};

// Examples (Idealista)
const IDEALISTA_BASE="https://www.idealista.com";
const MUNI_SLUG={
  "Cunit":"cunit-tarragona","El Vendrell":"el-vendrell-tarragona","Calafell":"calafell-tarragona","Santa Oliva":"santa-oliva-tarragona",
  "Bellvei":"bellvei-tarragona","L'Arboç":"l-arboc-tarragona","Banyeres del Penedès":"banyeres-del-penedes-tarragona",
  "Albinyana":"albinyana-tarragona","Bonastre":"bonastre-tarragona","Masllorenç":"masllorenc-tarragona",
  "La Bisbal del Penedès":"la-bisbal-del-penedes-tarragona","Llorenç del Penedès":"llorenc-del-penedes-tarragona",
  "Sant Jaume dels Domenys":"sant-jaume-dels-domenys-tarragona","El Montmell":"el-montmell-tarragona"
};
const EXTRA_SLUG={t:"terraza",p:"piscina",l:"ascensor",k:"garaje",s:"trastero",j:"jardin",a:"aire-acondicionado"};

const bedSlug=(n)=>{
  n=+n||0;
  if(n<=0) return "estudios";
  if(n===1) return "de-un-dormitorio";
  if(n===2) return "de-dos-dormitorios";
  if(n===3) return "de-tres-dormitorios";
  return "de-cuatro-cinco-habitaciones-o-mas";
};
const bathSlug=(n)=>{
  n=+n||0;
  if(n<=1) return "un-bano";
  if(n===2) return "dos-banos";
  return "tres-banos-o-mas";
};
const m2RangeSlugs=(m2)=>{
  m2=+m2||0; if(!(m2>0)) return [];
  const min=Math.max(0,Math.floor((m2-20)/10)*10);
  const max=Math.ceil((m2+20)/10)*10;
  return [`metros-cuadrados-mas-de_${min}`,`metros-cuadrados-menos-de_${max}`];
};

const buildIdealistaUrl=(mode,strict,muniOverride)=>{
  if(!lastReq) return null;
  const req=lastReq;
  const muni=muniOverride || req.muni;

  const area = (muni==="*") ? "tarragona/baix-penedes" : (MUNI_SLUG[muni]||null);
  if(!area) return null;

  const op = (mode==="buy") ? "venta-viviendas" : "alquiler-viviendas";
  const f=[];

  if(req.m2!=null) f.push(...m2RangeSlugs(req.m2));
  f.push(req.type==="house" ? "chalets" : "pisos");
  if(req.bed!=null) f.push(bedSlug(req.bed));
  if(req.bath!=null) f.push(bathSlug(req.bath));

  if(strict){
    Object.keys(EXTRA_SLUG).forEach(k=>{
      if(req.ex[k]===1) f.push(EXTRA_SLUG[k]);
    });
  }

  const joined = f.filter(Boolean).join("%2C");
  return `${IDEALISTA_BASE}/${op}/${area}/con-${joined}/`;
};

const openIdealista=(mode,strict,muniOverride)=>{
  if(!lastReq){toast(t("toastFirstAnalyze"));return;}
  if(prefsChangedSinceAnalyze()){toast(t("toastPrefsChanged"));return;}
  const url=buildIdealistaUrl(mode,strict,muniOverride);
  if(!url){toast(t("toastNoLink"));return;}
  window.open(url,"_blank","noopener");
};

const refreshExamplesUI=()=>{
  const muniTxt = municipalityLabel(Q("#ar").value);
  const ok = !!lastReq && !prefsChangedSinceAnalyze();
  const state = ok ? t("stateReady") : t("stateNeedAnalyze");
  Q("#xinfo").textContent = tpl(t("xInfo"),{muni:muniTxt,state:state});

  const wrap=Q("#xbtns");
  wrap.innerHTML="";

  const mk=(label,fn)=>{
    const b=document.createElement("button");
    b.className="b pri";
    b.type="button";
    b.textContent=label;
    b.onclick=fn;
    if(!ok) b.disabled=true;
    wrap.appendChild(b);
  };

  // If multi zone selected and muni is "*", offer per-town quick buttons
  const towns = [...zoneSel].filter(x=>MUNI_SLUG[x]);
  if(Q("#ar").value==="*" && towns.length){
    towns.slice(0,6).forEach(m=>{
      mk(`${t("buy")} · ${t("strict")} · ${m}`,()=>openIdealista("buy",true,m));
      mk(`${t("buy")} · ${t("flex")} · ${m}`,()=>openIdealista("buy",false,m));
      mk(`${t("rent")} · ${t("strict")} · ${m}`,()=>openIdealista("rent",true,m));
      mk(`${t("rent")} · ${t("flex")} · ${m}`,()=>openIdealista("rent",false,m));
    });
  } else {
    mk(`${t("buy")} · ${t("strict")}`,()=>openIdealista("buy",true,null));
    mk(`${t("buy")} · ${t("flex")}`,()=>openIdealista("buy",false,null));
    mk(`${t("rent")} · ${t("strict")}`,()=>openIdealista("rent",true,null));
    mk(`${t("rent")} · ${t("flex")}`,()=>openIdealista("rent",false,null));
  }
};

// Zone map (simple polygons placeholder: rectangles around towns)
// You can replace these with real GeoJSON later.
const MUNICIPALITY_POLYGONS = {
  "Cunit":[[41.20,1.62],[41.20,1.66],[41.23,1.66],[41.23,1.62]],
  "Calafell":[[41.18,1.56],[41.18,1.62],[41.22,1.62],[41.22,1.56]],
  "El Vendrell":[[41.20,1.51],[41.20,1.58],[41.25,1.58],[41.25,1.51]],
  "Bellvei":[[41.22,1.52],[41.22,1.57],[41.26,1.57],[41.26,1.52]],
  "Santa Oliva":[[41.24,1.53],[41.24,1.58],[41.28,1.58],[41.28,1.53]],
  "L'Arboç":[[41.26,1.54],[41.26,1.59],[41.30,1.59],[41.30,1.54]],
  "Banyeres del Penedès":[[41.28,1.52],[41.28,1.57],[41.32,1.57],[41.32,1.52]],
  "La Bisbal del Penedès":[[41.26,1.48],[41.26,1.53],[41.30,1.53],[41.30,1.48]],
  "Llorenç del Penedès":[[41.28,1.46],[41.28,1.51],[41.32,1.51],[41.32,1.46]],
  "Sant Jaume dels Domenys":[[41.30,1.45],[41.30,1.50],[41.34,1.50],[41.34,1.45]],
  "El Montmell":[[41.31,1.42],[41.31,1.47],[41.36,1.47],[41.36,1.42]],
  "Albinyana":[[41.26,1.44],[41.26,1.48],[41.30,1.48],[41.30,1.44]],
  "Bonastre":[[41.22,1.40],[41.22,1.45],[41.26,1.45],[41.26,1.40]],
  "Masllorenç":[[41.25,1.37],[41.25,1.41],[41.28,1.41],[41.28,1.37]]
};
const polyByName=new Map();

const applyPolyStyle=(name)=>{
  const poly=polyByName.get(name);
  const on=zoneSel.has(name);
  if(!poly) return;
  poly.setStyle({
    fillColor: on ? "#38bdf8" : "#22c55e",
    fillOpacity: on ? 0.35 : 0.15,
    color: on ? "#38bdf8" : "#22c55e",
    weight: on ? 3 : 1.5,
    opacity: on ? 0.9 : 0.5
  });
};
const toggleZone=(name)=>{
  if(zoneSel.has(name)) zoneSel.delete(name); else zoneSel.add(name);
  applyPolyStyle(name);
  saveZoneSel();
  renderZoneUI();
};
const renderZoneUI=()=>{
  const txt = zoneSel.size ? [...zoneSel].join(", ") : t("zoneNone");
  Q("#zoneNote").textContent = t("zoneSelected") + txt;
  Q("#zoneApplied").textContent = zoneSel.size ? (t("zoneApplied")+txt) : "";
};

const initZMap=()=>{
  if(zReady) return;
  zReady=true;
  zmap=L.map("zmap",{scrollWheelZoom:false}).setView([41.25,1.53],11);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OpenStreetMap"}).addTo(zmap);

  Object.keys(MUNICIPALITY_POLYGONS).forEach(name=>{
    const coords=MUNICIPALITY_POLYGONS[name];
    const poly=L.polygon(coords,{
      fillColor:"#22c55e",fillOpacity:0.15,color:"#22c55e",weight:1.5,opacity:.5
    }).addTo(zmap);
    poly.bindTooltip(name,{permanent:false,direction:"center",opacity:0.9});
    poly.on("click",()=>toggleZone(name));
    polyByName.set(name,poly);
    applyPolyStyle(name);
  });

  try{
    const all=Object.values(MUNICIPALITY_POLYGONS).flat();
    zmap.fitBounds(all,{padding:[24,24]});
  }catch(e){}
  setTimeout(()=>zmap.invalidateSize(),160);
};

// AI (local, “gran nivel” dentro de lo posible sin API)
const addMsg=(role,txt,cls)=>{
  const box=Q("#chatMessages");
  const row=document.createElement("div");
  row.className="msg";
  const av=document.createElement("div");
  av.className="av "+(role==="ai"?"ai":"user");
  av.textContent=role==="ai"?"AI":(LANG==="EN"?"YOU":(LANG==="CA"?"TU":"TÚ"));
  const bub=document.createElement("div");
  bub.className="bub "+(role==="ai"?"":"user")+" "+(cls||"");
  bub.textContent=txt;
  row.appendChild(av); row.appendChild(bub);
  box.appendChild(row);
  box.scrollTop=box.scrollHeight;
};

const clearChat=(silent)=>{
  chatHistory=[];
  Q("#chatMessages").innerHTML="";
  if(!silent){
    addMsg("ai",
      (LANG==="EN"?"Chat cleared. Ask a question.":(LANG==="CA"?"Xat netejat. Fes una pregunta.":"Chat limpiado. Haz una pregunta."))
    );
  }
};

const aiAnswer=(q)=>{
  const qq=(q||"").toLowerCase().trim();
  if(!last){
    return (LANG==="EN"
      ?"Run Analyze first so I can use your numbers."
      :(LANG==="CA"
        ?"Fes “Analitzar” primer per poder usar les teves dades."
        :"Primero pulsa “Analizar” para usar tus números."
      ));
  }

  const safe = last.inc*0.35;
  const cashGap = Math.max(0,last.needCash-last.sav);
  const mortPct = last.ratio;
  const rentPct = last.rri;

  const wantWhy = /(por qué|porque|why|per què)/.test(qq);
  const wantImprove = /(mejor|improve|millor|cambiar|change|canviar|hacer viable|viable|possible)/.test(qq);
  const wantSave = /(ahorr|save|estalvi|entrada|down payment|deposit)/.test(qq);
  const wantRate = /(tipo|rate|interest|inter[eé]s|interès)/.test(qq);
  const wantCompare = /(compar|province|provincia|prov[ií]ncia)/.test(qq);
  const wantStrict = /(estrict|strict|flex)/.test(qq);

  if(wantWhy){
    if(last.recCode==="BUY"){
      return [
        (LANG==="EN"?"Because buying fits cash + effort + horizon.":(LANG==="CA"?"Perquè comprar encaixa amb cash + esforç + horitzó.":"Porque comprar encaja con cash + esfuerzo + horizonte.")),
        "• "+t("whyBuy1"),
        "• "+t("whyBuy2"),
        `• ${t("safeCap")}: ${fmtMoney(safe)} · ${(LANG==="EN"?"Mortgage":"Hipoteca")}: ${fmtMoney(last.pay)} (${fmtPct(mortPct)})`
      ].join("\n");
    }
    if(last.recCode==="RENT"){
      return [
        (LANG==="EN"?"Because renting is safer with your current constraints.":(LANG==="CA"?"Perquè llogar és més segur amb les teves restriccions actuals.":"Porque alquilar es más seguro con tus restricciones actuales.")),
        last.need ? `• ${t("whyRent1")} (${fmtMoney(cashGap)})` : "",
        mortPct>35 ? `• ${t("whyRent2")} (${fmtPct(mortPct)})` : "",
        `• ${t("whyRent3")} (${fmtPct(rentPct)})`
      ].filter(Boolean).join("\n");
    }
    return [
      (LANG==="EN"?"Because neither option fits safely yet.":(LANG==="CA"?"Perquè encara no encaixa amb seguretat.":"Porque todavía no encaja con seguridad.")),
      last.need ? `• ${t("whyRent1")} (${fmtMoney(cashGap)})` : "",
      mortPct>35 ? `• ${t("whyRent2")} (${fmtPct(mortPct)})` : "",
      rentPct>40 ? `• ${t("whyRent3")} (${fmtPct(rentPct)})` : ""
    ].filter(Boolean).join("\n");
  }

  if(wantImprove){
    const tips=[];
    if(last.need) tips.push(`• ${(LANG==="EN"?"Cash gap":"Falta cash")}: ${fmtMoney(cashGap)}.`);
    tips.push(`• ${t("safeCap")}: ${fmtMoney(safe)}.`);
    if(mortPct>35) tips.push(`• ${(LANG==="EN"?"Mortgage effort is high":"Esfuerzo hipoteca alto")}: ${fmtPct(mortPct)}.`);
    if(rentPct>40) tips.push(`• ${(LANG==="EN"?"Rent effort is high":"Esfuerzo alquiler alto")}: ${fmtPct(rentPct)}.`);

    tips.push("• "+(LANG==="EN"
      ?"Best levers: lower m², remove extras, increase monthly saving, extend term (within 5–40), or rent while building cash."
      :(LANG==="CA"
        ?"Millors palanques: baixar m², treure extres, augmentar estalvi mensual, allargar termini (5–40), o llogar mentre acumules entrada."
        :"Mejores palancas: bajar m², quitar extras, subir ahorro mensual, alargar plazo (5–40), o alquilar mientras acumulas entrada."
      )
    ));
    return tips.join("\n");
  }

  if(wantSave){
    if(!last.need){
      return (LANG==="EN"
        ?"You already cover the cash needed for down payment + costs."
        :(LANG==="CA"
          ?"Ja cobreixes el cash necessari per entrada + despeses."
          :"Ya cubres el cash necesario para entrada + costes."
        ));
    }
    if(last.msv>0){
      const mos=Math.ceil(cashGap/last.msv);
      const yrs=(mos/12).toFixed(1);
      return (LANG==="EN"
        ?`You need ${fmtMoney(cashGap)}. Saving ${fmtMoney(last.msv)}/month takes ~${mos} months (~${yrs} years).`
        :(LANG==="CA"
          ?`Et falten ${fmtMoney(cashGap)}. Estalviant ${fmtMoney(last.msv)}/mes: ~${mos} mesos (~${yrs} anys).`
          :`Te faltan ${fmtMoney(cashGap)}. Ahorrando ${fmtMoney(last.msv)}/mes: ~${mos} meses (~${yrs} años).`
        ));
    }
    return (LANG==="EN"
      ?`You need ${fmtMoney(cashGap)} more cash. Set a monthly saving target to estimate the timeline.`
      :(LANG==="CA"
        ?`Et falten ${fmtMoney(cashGap)}. Defineix un estalvi mensual per estimar el temps.`
        :`Te faltan ${fmtMoney(cashGap)}. Define un ahorro mensual para estimar el tiempo.`
      ));
  }

  if(wantRate){
    const base=BASE.baseRate;
    const used=last.rate;
    const delta = (used-base)*100;
    return (LANG==="EN"
      ?`Rate used: ${(used*100).toFixed(2)}% (${delta>0?`+${delta.toFixed(2)}%`:"base"} vs baseline). Sensitivity chart shows payment impact.`
      :(LANG==="CA"
        ?`Tipus utilitzat: ${(used*100).toFixed(2)}% (${delta>0?`+${delta.toFixed(2)}%`:"base"} vs base). Mira la sensibilitat per veure l'impacte.`
        :`Tipo usado: ${(used*100).toFixed(2)}% (${delta>0?`+${delta.toFixed(2)}%`:"base"} vs base). Mira la sensibilidad para ver el impacto.`
      ));
  }

  if(wantCompare){
    return (LANG==="EN"
      ?"Go to Comparator to compare your area vs a province using the same m²/rooms/extras."
      :(LANG==="CA"
        ?"Ves a Comparador per comparar la teva zona amb una província amb els mateixos m²/habitacions/extres."
        :"Ve a Comparador para comparar tu zona con una provincia con los mismos m²/habitaciones/extras."
      ));
  }

  if(wantStrict){
    return (LANG==="EN"
      ?"In Examples: “strict” includes selected extras in the filters; “flex” ignores extras and usually shows more results."
      :(LANG==="CA"
        ?"A Exemples: “estricte” inclou extres als filtres; “flex” ignora extres i sol mostrar més resultats."
        :"En Ejemplos: “estricto” incluye extras en los filtros; “flex” ignora extras y suele mostrar más resultados."
      ));
  }

  return (LANG==="EN"
    ?"Ask: why buy/rent, how to make buying viable, how long to save, interest-rate risk, or province comparison."
    :(LANG==="CA"
      ?"Pregunta: per què comprar/llogar, com fer viable comprar, quant trigar a estalviar, risc de tipus, o comparació provincial."
      :"Pregunta: por qué comprar/alquilar, cómo hacer viable comprar, cuánto tardas en ahorrar, riesgo de tipos, o comparación provincial."
    ));
};

const initChatUI=()=>{
  const send=Q("#chatSend");
  const inp=Q("#chatInput");

  if(!Q("#chatMessages").children.length){
    addMsg("ai",(LANG==="EN"?"Hi. Ask me about your case.":(LANG==="CA"?"Hola. Pregunta'm pel teu cas.":"Hola. Pregúntame por tu caso.")));
  }

  if(!send.dataset.init){
    send.dataset.init="1";
    send.addEventListener("click",()=>{
      const msg=inp.value.trim();
      if(!msg || aiBusy) return;
      sendMsg(msg);
    });
  }
  if(!inp.dataset.init){
    inp.dataset.init="1";
    inp.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        const msg=inp.value.trim();
        if(!msg || aiBusy) return;
        sendMsg(msg);
      }
    });
    inp.addEventListener("input",()=>{
      inp.style.height="auto";
      inp.style.height=Math.min(inp.scrollHeight,120)+"px";
    });
  }

  QA(".sug").forEach(s=>{
    if(s.dataset.init) return;
    s.dataset.init="1";
    s.addEventListener("click",()=>{
      const q=s.getAttribute("data-q");
      if(q) sendMsg(q);
    });
  });
};

const sendMsg=async(msg)=>{
  const send=Q("#chatSend");
  const inp=Q("#chatInput");
  aiBusy=true;
  send.disabled=true; inp.disabled=true;

  addMsg("user",msg);
  addMsg("ai",(LANG==="EN"?"Thinking...":(LANG==="CA"?"Pensant...":"Pensando...")),"think");

  await new Promise(r=>setTimeout(r,220));
  // remove last thinking bubble
  const box=Q("#chatMessages");
  const lastNode=box.lastElementChild;
  if(lastNode) box.removeChild(lastNode);

  const ans=aiAnswer(msg);
  addMsg("ai",ans);

  aiBusy=false;
  send.disabled=false; inp.disabled=false; inp.value=""; inp.focus();
};

// Events
Q("#L_CA").addEventListener("click",()=>setLang("CA"));
Q("#L_ES").addEventListener("click",()=>setLang("ES"));
Q("#L_EN").addEventListener("click",()=>setLang("EN"));

Q("#np").addEventListener("click",()=>{
  const nm=(Q("#nm").value||"").trim();
  const ag=+Q("#ag").value||0;
  if(!nm || ag<18 || ag>100){toast(t("toastCheckNameAge"));return;}
  saveForm(); show("e");
});
Q("#bp").addEventListener("click",()=>{saveForm(); show("p");});
Q("#ne").addEventListener("click",()=>{saveForm(); show("f");});
Q("#be").addEventListener("click",()=>{saveForm(); show("e");});
Q("#go").addEventListener("click",analyze);

Q("#t_p").addEventListener("click",()=>show("p"));
Q("#t_e").addEventListener("click",()=>show("e"));
Q("#t_f").addEventListener("click",()=>show("f"));
Q("#t_r").addEventListener("click",()=>{ if(!lastReq){toast(t("toastFirstAnalyze"));return;} show("r"); });
Q("#t_m").addEventListener("click",()=>{ if(!lastReq){toast(t("toastFirstAnalyze"));return;} show("m"); ensureCMap(); });
Q("#t_x").addEventListener("click",()=>{ if(!lastReq){toast(t("toastFirstAnalyze"));return;} show("x"); });
Q("#t_ai").addEventListener("click",()=>{ if(!lastReq){toast(t("toastFirstAnalyze"));return;} show("ai"); });

Q("#jumpM").addEventListener("click",()=>{ if(!lastReq){toast(t("toastFirstAnalyze"));return;} show("m"); ensureCMap(); });
Q("#jumpX").addEventListener("click",()=>{ if(!lastReq){toast(t("toastFirstAnalyze"));return;} show("x"); });
Q("#jumpAI").addEventListener("click",()=>{ if(!lastReq){toast(t("toastFirstAnalyze"));return;} show("ai"); });

Q("#cp").addEventListener("click",copyReport);
Q("#rs").addEventListener("click",resetAll);

Q("#cm").addEventListener("change",()=>{ensureCMap(); saveForm();});
Q("#autoFillCmp").addEventListener("click",fillComparatorFromLast);
Q("#bc").addEventListener("click",compare);

Q("#toggleMap").addEventListener("click",()=>{
  const wrap=Q("#zoneWrap");
  const open=wrap.style.display!=="none";
  wrap.style.display=open?"none":"block";
  if(!open){
    initZMap();
    setTimeout(()=>{ try{ zmap.invalidateSize(); }catch(e){} },220);
  }
});
Q("#zoneClear").addEventListener("click",()=>{
  zoneSel.clear(); saveZoneSel();
  polyByName.forEach((_,name)=>applyPolyStyle(name));
  renderZoneUI(); refreshExamplesUI();
  toast(t("toastZoneCleared"));
});
Q("#zoneApply").addEventListener("click",()=>{
  if(zoneSel.size===0){toast(t("toastNoZone"));return;}
  // If user currently has "*", we keep it and use zoneSel as avg. If they chose a specific town, we keep it.
  refreshExamplesUI();
  toast(t("toastZoneApplied"));
});

Q("#aiClear").addEventListener("click",()=>clearChat(false));

["nm","ag","hor","fst","inc","sav","msv","yrs","ar","ty","m2","bed","bat",
 "et","ep","el","ek","es","ej","ea",
 "cm","cm2","cbd","cba","cty","ct","cp0","cl0","ck0","cs0","cj0","ca0"
].forEach(id=>{
  const el=Q("#"+id);
  if(!el) return;
  el.addEventListener("change",()=>{saveForm(); refreshExamplesUI();});
  el.addEventListener("input",()=>saveForm());
});

// Validation hints (lightweight)
const liveValidate=()=>{
  const inc=+Q("#inc").value||0;
  const m2=+Q("#m2").value||0;
  Q("#h_inc").textContent = (Q("#inc").value!=="" && inc<=0) ? ("⚠ "+t("validateIncome")) : "";
  Q("#h_inc").className="hint"+((Q("#inc").value!=="" && inc<=0)?" err":"");
  Q("#h_m2").textContent  = (Q("#m2").value!=="" && m2<50) ? ("⚠ "+t("validateM2")) : "";
  Q("#h_m2").className="hint"+((Q("#m2").value!=="" && m2<50)?" err":"");
};
["inc","m2"].forEach(id=>{
  Q("#"+id).addEventListener("input",liveValidate);
  Q("#"+id).addEventListener("change",liveValidate);
});

// Clamps
["ag","yrs"].forEach(id=>clampNum(id, (id==="ag"?18:5), (id==="ag"?100:40)));
["m2","cm2"].forEach(id=>clampNum(id,50,999));
["bat","cba"].forEach(id=>clampNum(id,1,6));
["bed","cbd"].forEach(id=>clampNum(id,0,10));
["inc","sav","msv"].forEach(id=>clampNum(id,0,99999999));

// Init
loadZoneSel();
loadForm();
setLang(LANG);
setTabsEnabled();
refreshExamplesUI();
renderZoneUI();
renderSideKpis();
liveValidate();

try{ ensureCMap(); }catch(e){}

window.addEventListener("resize",()=>{
  if(last){
    drawEffortChart();
    drawSensitivityChart();
  }
});

})(); // end IIFE
</script>
</body>
</html>
